<html>
<head><meta http-equiv=Content-Type content="text/html; charset=UTF-8">
<style type="text/css">
<!--
span.cls_002{font-family:Arial,serif;font-size:73.0px;color:rgb(255,254,255);font-weight:normal;font-style:normal;text-decoration: none}
div.cls_002{font-family:Arial,serif;font-size:73.0px;color:rgb(255,254,255);font-weight:normal;font-style:normal;text-decoration: none}
span.cls_003{font-family:Arial,serif;font-size:28.1px;color:rgb(255,254,255);font-weight:normal;font-style:normal;text-decoration: none}
div.cls_003{font-family:Arial,serif;font-size:28.1px;color:rgb(255,254,255);font-weight:normal;font-style:normal;text-decoration: none}
span.cls_004{font-family:Arial,serif;font-size:20.1px;color:rgb(0,0,0);font-weight:normal;font-style:normal;text-decoration: none}
div.cls_004{font-family:Arial,serif;font-size:20.1px;color:rgb(0,0,0);font-weight:normal;font-style:normal;text-decoration: none}
span.cls_005{font-family:Arial,serif;font-size:10.1px;color:rgb(0,0,0);font-weight:normal;font-style:normal;text-decoration: none}
div.cls_005{font-family:Arial,serif;font-size:10.1px;color:rgb(0,0,0);font-weight:normal;font-style:normal;text-decoration: none}
span.cls_006{font-family:Arial,serif;font-size:10.1px;color:rgb(0,0,0);font-weight:normal;font-style:italic;text-decoration: none}
div.cls_006{font-family:Arial,serif;font-size:10.1px;color:rgb(0,0,0);font-weight:normal;font-style:italic;text-decoration: none}
span.cls_007{font-family:Times,serif;font-size:10.1px;color:rgb(0,0,0);font-weight:normal;font-style:normal;text-decoration: none}
div.cls_007{font-family:Times,serif;font-size:10.1px;color:rgb(0,0,0);font-weight:normal;font-style:normal;text-decoration: none}
span.cls_008{font-family:Times,serif;font-size:10.1px;color:rgb(0,0,0);font-weight:normal;font-style:italic;text-decoration: none}
div.cls_008{font-family:Times,serif;font-size:10.1px;color:rgb(0,0,0);font-weight:normal;font-style:italic;text-decoration: none}
span.cls_009{font-family:Times,serif;font-size:7.5px;color:rgb(0,0,0);font-weight:normal;font-style:normal;text-decoration: none}
div.cls_009{font-family:Times,serif;font-size:7.5px;color:rgb(0,0,0);font-weight:normal;font-style:normal;text-decoration: none}
span.cls_010{font-family:Times,serif;font-size:7.5px;color:rgb(0,0,0);font-weight:normal;font-style:italic;text-decoration: none}
div.cls_010{font-family:Times,serif;font-size:7.5px;color:rgb(0,0,0);font-weight:normal;font-style:italic;text-decoration: none}
span.cls_011{font-family:Arial,serif;font-size:73.0px;color:rgb(0,0,0);font-weight:normal;font-style:normal;text-decoration: none}
div.cls_011{font-family:Arial,serif;font-size:73.0px;color:rgb(0,0,0);font-weight:normal;font-style:normal;text-decoration: none}
span.cls_012{font-family:Arial,serif;font-size:28.1px;color:rgb(0,0,0);font-weight:normal;font-style:normal;text-decoration: none}
div.cls_012{font-family:Arial,serif;font-size:28.1px;color:rgb(0,0,0);font-weight:normal;font-style:normal;text-decoration: none}
span.cls_013{font-family:Arial,serif;font-size:8.1px;color:rgb(0,0,0);font-weight:bold;font-style:normal;text-decoration: none}
div.cls_013{font-family:Arial,serif;font-size:8.1px;color:rgb(0,0,0);font-weight:bold;font-style:normal;text-decoration: none}
span.cls_014{font-family:Times,serif;font-size:8.1px;color:rgb(0,0,0);font-weight:normal;font-style:normal;text-decoration: none}
div.cls_014{font-family:Times,serif;font-size:8.1px;color:rgb(0,0,0);font-weight:normal;font-style:normal;text-decoration: none}
span.cls_015{font-family:Times,serif;font-size:7.0px;color:rgb(0,0,0);font-weight:normal;font-style:normal;text-decoration: none}
div.cls_015{font-family:Times,serif;font-size:7.0px;color:rgb(0,0,0);font-weight:normal;font-style:normal;text-decoration: none}
span.cls_016{font-family:Arial,serif;font-size:16.1px;color:rgb(0,0,0);font-weight:bold;font-style:normal;text-decoration: none}
div.cls_016{font-family:Arial,serif;font-size:16.1px;color:rgb(0,0,0);font-weight:bold;font-style:normal;text-decoration: none}
span.cls_017{font-family:"Book Antiqua",serif;font-size:9.1px;color:rgb(0,0,0);font-weight:normal;font-style:normal;text-decoration: none}
div.cls_017{font-family:"Book Antiqua",serif;font-size:9.1px;color:rgb(0,0,0);font-weight:normal;font-style:normal;text-decoration: none}
span.cls_018{font-family:Arial,serif;font-size:10.1px;color:rgb(0,0,0);font-weight:bold;font-style:normal;text-decoration: none}
div.cls_018{font-family:Arial,serif;font-size:10.1px;color:rgb(0,0,0);font-weight:bold;font-style:normal;text-decoration: none}
span.cls_019{font-family:Arial,serif;font-size:9.1px;color:rgb(0,0,0);font-weight:normal;font-style:normal;text-decoration: none}
div.cls_019{font-family:Arial,serif;font-size:9.1px;color:rgb(0,0,0);font-weight:normal;font-style:normal;text-decoration: none}
span.cls_020{font-family:Arial,serif;font-size:9.1px;color:rgb(0,0,0);font-weight:bold;font-style:normal;text-decoration: none}
div.cls_020{font-family:Arial,serif;font-size:9.1px;color:rgb(0,0,0);font-weight:bold;font-style:normal;text-decoration: none}
span.cls_021{font-family:Arial,serif;font-size:6.0px;color:rgb(0,0,0);font-weight:normal;font-style:normal;text-decoration: none}
div.cls_021{font-family:Arial,serif;font-size:6.0px;color:rgb(0,0,0);font-weight:normal;font-style:normal;text-decoration: none}
span.cls_022{font-family:Courier New,serif;font-size:8.6px;color:rgb(0,0,0);font-weight:normal;font-style:normal;text-decoration: none}
div.cls_022{font-family:Courier New,serif;font-size:8.6px;color:rgb(0,0,0);font-weight:normal;font-style:normal;text-decoration: none}
span.cls_023{font-family:Times,serif;font-size:14.1px;color:rgb(0,0,0);font-weight:normal;font-style:normal;text-decoration: none}
div.cls_023{font-family:Times,serif;font-size:14.1px;color:rgb(0,0,0);font-weight:normal;font-style:normal;text-decoration: none}
span.cls_024{font-family:Times,serif;font-size:14.1px;color:rgb(0,0,0);font-weight:normal;font-style:italic;text-decoration: none}
div.cls_024{font-family:Times,serif;font-size:14.1px;color:rgb(0,0,0);font-weight:normal;font-style:italic;text-decoration: none}
span.cls_025{font-family:Times,serif;font-size:9.3px;color:rgb(0,0,0);font-weight:normal;font-style:normal;text-decoration: none}
div.cls_025{font-family:Times,serif;font-size:9.3px;color:rgb(0,0,0);font-weight:normal;font-style:normal;text-decoration: none}
span.cls_026{font-family:Times,serif;font-size:8.1px;color:rgb(0,0,0);font-weight:normal;font-style:italic;text-decoration: none}
div.cls_026{font-family:Times,serif;font-size:8.1px;color:rgb(0,0,0);font-weight:normal;font-style:italic;text-decoration: none}
span.cls_027{font-family:Times,serif;font-size:6.6px;color:rgb(0,0,0);font-weight:normal;font-style:normal;text-decoration: none}
div.cls_027{font-family:Times,serif;font-size:6.6px;color:rgb(0,0,0);font-weight:normal;font-style:normal;text-decoration: none}
span.cls_028{font-family:Times,serif;font-size:11.1px;color:rgb(0,0,0);font-weight:normal;font-style:normal;text-decoration: none}
div.cls_028{font-family:Times,serif;font-size:11.1px;color:rgb(0,0,0);font-weight:normal;font-style:normal;text-decoration: none}
span.cls_029{font-family:Times,serif;font-size:10.6px;color:rgb(0,0,0);font-weight:normal;font-style:normal;text-decoration: none}
div.cls_029{font-family:Times,serif;font-size:10.6px;color:rgb(0,0,0);font-weight:normal;font-style:normal;text-decoration: none}
span.cls_031{font-family:Arial,serif;font-size:12.1px;color:rgb(0,0,0);font-weight:bold;font-style:normal;text-decoration: none}
div.cls_031{font-family:Arial,serif;font-size:12.1px;color:rgb(0,0,0);font-weight:bold;font-style:normal;text-decoration: none}
span.cls_032{font-family:Arial,serif;font-size:7.5px;color:rgb(255,254,255);font-weight:bold;font-style:normal;text-decoration: none}
div.cls_032{font-family:Arial,serif;font-size:7.5px;color:rgb(255,254,255);font-weight:bold;font-style:normal;text-decoration: none}
span.cls_033{font-family:Times,serif;font-size:9.1px;color:rgb(0,0,0);font-weight:normal;font-style:normal;text-decoration: none}
div.cls_033{font-family:Times,serif;font-size:9.1px;color:rgb(0,0,0);font-weight:normal;font-style:normal;text-decoration: none}
span.cls_034{font-family:Times,serif;font-size:10.1px;color:rgb(0,0,0);font-weight:bold;font-style:normal;text-decoration: none}
div.cls_034{font-family:Times,serif;font-size:10.1px;color:rgb(0,0,0);font-weight:bold;font-style:normal;text-decoration: none}
span.cls_030{font-family:Times,serif;font-size:8.6px;color:rgb(0,0,0);font-weight:normal;font-style:normal;text-decoration: none}
div.cls_030{font-family:Times,serif;font-size:8.6px;color:rgb(0,0,0);font-weight:normal;font-style:normal;text-decoration: none}
span.cls_035{font-family:Arial,serif;font-size:120.1px;color:rgb(0,0,0);font-weight:bold;font-style:normal;text-decoration: none}
div.cls_035{font-family:Arial,serif;font-size:120.1px;color:rgb(0,0,0);font-weight:bold;font-style:normal;text-decoration: none}
span.cls_036{font-family:"Book Antiqua",serif;font-size:7.1px;color:rgb(0,0,0);font-weight:normal;font-style:normal;text-decoration: none}
div.cls_036{font-family:"Book Antiqua",serif;font-size:7.1px;color:rgb(0,0,0);font-weight:normal;font-style:normal;text-decoration: none}
span.cls_037{font-family:Times,serif;font-size:8.2px;color:rgb(0,0,0);font-weight:bold;font-style:normal;text-decoration: none}
div.cls_037{font-family:Times,serif;font-size:8.2px;color:rgb(0,0,0);font-weight:bold;font-style:normal;text-decoration: none}
span.cls_038{font-family:"Book Antiqua",serif;font-size:8.6px;color:rgb(0,0,0);font-weight:normal;font-style:italic;text-decoration: none}
div.cls_038{font-family:"Book Antiqua",serif;font-size:8.6px;color:rgb(0,0,0);font-weight:normal;font-style:italic;text-decoration: none}
span.cls_039{font-family:"Book Antiqua",serif;font-size:8.6px;color:rgb(0,0,0);font-weight:normal;font-style:normal;text-decoration: none}
div.cls_039{font-family:"Book Antiqua",serif;font-size:8.6px;color:rgb(0,0,0);font-weight:normal;font-style:normal;text-decoration: none}
span.cls_040{font-family:Times,serif;font-size:8.6px;color:rgb(0,0,0);font-weight:bold;font-style:normal;text-decoration: none}
div.cls_040{font-family:Times,serif;font-size:8.6px;color:rgb(0,0,0);font-weight:bold;font-style:normal;text-decoration: none}
span.cls_041{font-family:Arial,serif;font-size:7.5px;color:rgb(0,0,0);font-weight:normal;font-style:normal;text-decoration: none}
div.cls_041{font-family:Arial,serif;font-size:7.5px;color:rgb(0,0,0);font-weight:normal;font-style:normal;text-decoration: none}
span.cls_042{font-family:Times,serif;font-size:9.1px;color:rgb(0,0,0);font-weight:bold;font-style:normal;text-decoration: none}
div.cls_042{font-family:Times,serif;font-size:9.1px;color:rgb(0,0,0);font-weight:bold;font-style:normal;text-decoration: none}
span.cls_043{font-family:"Book Antiqua",serif;font-size:7.5px;color:rgb(0,0,0);font-weight:normal;font-style:italic;text-decoration: none}
div.cls_043{font-family:"Book Antiqua",serif;font-size:7.5px;color:rgb(0,0,0);font-weight:normal;font-style:italic;text-decoration: none}
span.cls_044{font-family:"Book Antiqua",serif;font-size:8.1px;color:rgb(0,0,0);font-weight:normal;font-style:italic;text-decoration: none}
div.cls_044{font-family:"Book Antiqua",serif;font-size:8.1px;color:rgb(0,0,0);font-weight:normal;font-style:italic;text-decoration: none}
span.cls_045{font-family:Arial,serif;font-size:7.5px;color:rgb(0,0,0);font-weight:normal;font-style:normal;text-decoration: none}
div.cls_045{font-family:Arial,serif;font-size:7.5px;color:rgb(0,0,0);font-weight:normal;font-style:normal;text-decoration: none}
span.cls_046{font-family:Arial,serif;font-size:8.6px;color:rgb(0,0,0);font-weight:normal;font-style:normal;text-decoration: none}
div.cls_046{font-family:Arial,serif;font-size:8.6px;color:rgb(0,0,0);font-weight:normal;font-style:normal;text-decoration: none}
span.cls_047{font-family:Times,serif;font-size:8.4px;color:rgb(0,0,0);font-weight:bold;font-style:normal;text-decoration: none}
div.cls_047{font-family:Times,serif;font-size:8.4px;color:rgb(0,0,0);font-weight:bold;font-style:normal;text-decoration: none}
span.cls_049{font-family:Arial,serif;font-size:7.0px;color:rgb(0,0,0);font-weight:normal;font-style:normal;text-decoration: none}
div.cls_049{font-family:Arial,serif;font-size:7.0px;color:rgb(0,0,0);font-weight:normal;font-style:normal;text-decoration: none}
span.cls_048{font-family:"Book Antiqua",serif;font-size:7.0px;color:rgb(0,0,0);font-weight:normal;font-style:italic;text-decoration: none}
div.cls_048{font-family:"Book Antiqua",serif;font-size:7.0px;color:rgb(0,0,0);font-weight:normal;font-style:italic;text-decoration: none}
span.cls_050{font-family:Arial,serif;font-size:10.1px;color:rgb(0,0,0);font-weight:normal;font-style:normal;text-decoration: none}
div.cls_050{font-family:Arial,serif;font-size:10.1px;color:rgb(0,0,0);font-weight:normal;font-style:normal;text-decoration: none}
span.cls_051{font-family:"Book Antiqua",serif;font-size:7.0px;color:rgb(0,0,0);font-weight:normal;font-style:normal;text-decoration: none}
div.cls_051{font-family:"Book Antiqua",serif;font-size:7.0px;color:rgb(0,0,0);font-weight:normal;font-style:normal;text-decoration: none}
span.cls_053{font-family:Times,serif;font-size:8.1px;color:rgb(0,0,0);font-weight:bold;font-style:normal;text-decoration: none}
div.cls_053{font-family:Times,serif;font-size:8.1px;color:rgb(0,0,0);font-weight:bold;font-style:normal;text-decoration: none}
span.cls_052{font-family:"Book Antiqua",serif;font-size:7.0px;color:rgb(0,0,0);font-weight:normal;font-style:italic;text-decoration: none}
div.cls_052{font-family:"Book Antiqua",serif;font-size:7.0px;color:rgb(0,0,0);font-weight:normal;font-style:italic;text-decoration: none}
span.cls_054{font-family:"Book Antiqua",serif;font-size:8.1px;color:rgb(0,0,0);font-weight:normal;font-style:normal;text-decoration: none}
div.cls_054{font-family:"Book Antiqua",serif;font-size:8.1px;color:rgb(0,0,0);font-weight:normal;font-style:normal;text-decoration: none}
span.cls_055{font-family:Arial,serif;font-size:12.1px;color:rgb(0,0,0);font-weight:bold;font-style:italic;text-decoration: none}
div.cls_055{font-family:Arial,serif;font-size:12.1px;color:rgb(0,0,0);font-weight:bold;font-style:italic;text-decoration: none}
span.cls_056{font-family:"Book Antiqua",serif;font-size:12.1px;color:rgb(0,0,0);font-weight:normal;font-style:normal;text-decoration: none}
div.cls_056{font-family:"Book Antiqua",serif;font-size:12.1px;color:rgb(0,0,0);font-weight:normal;font-style:normal;text-decoration: none}
span.cls_057{font-family:Arial,serif;font-size:15.1px;color:rgb(0,0,0);font-weight:normal;font-style:normal;text-decoration: none}
div.cls_057{font-family:Arial,serif;font-size:15.1px;color:rgb(0,0,0);font-weight:normal;font-style:normal;text-decoration: none}
span.cls_058{font-family:"Book Antiqua",serif;font-size:10.6px;color:rgb(0,0,0);font-weight:normal;font-style:normal;text-decoration: none}
div.cls_058{font-family:"Book Antiqua",serif;font-size:10.6px;color:rgb(0,0,0);font-weight:normal;font-style:normal;text-decoration: none}
span.cls_059{font-family:Arial,serif;font-size:8.6px;color:rgb(0,0,0);font-weight:normal;font-style:normal;text-decoration: none}
div.cls_059{font-family:Arial,serif;font-size:8.6px;color:rgb(0,0,0);font-weight:normal;font-style:normal;text-decoration: none}
span.cls_060{font-family:"Book Antiqua",serif;font-size:7.7px;color:rgb(0,0,0);font-weight:normal;font-style:normal;text-decoration: none}
div.cls_060{font-family:"Book Antiqua",serif;font-size:7.7px;color:rgb(0,0,0);font-weight:normal;font-style:normal;text-decoration: none}
span.cls_061{font-family:Times,serif;font-size:9.2px;color:rgb(0,0,0);font-weight:normal;font-style:normal;text-decoration: none}
div.cls_061{font-family:Times,serif;font-size:9.2px;color:rgb(0,0,0);font-weight:normal;font-style:normal;text-decoration: none}
span.cls_062{font-family:Times,serif;font-size:7.2px;color:rgb(0,0,0);font-weight:normal;font-style:normal;text-decoration: none}
div.cls_062{font-family:Times,serif;font-size:7.2px;color:rgb(0,0,0);font-weight:normal;font-style:normal;text-decoration: none}
span.cls_063{font-family:Times,serif;font-size:9.6px;color:rgb(0,0,0);font-weight:normal;font-style:normal;text-decoration: none}
div.cls_063{font-family:Times,serif;font-size:9.6px;color:rgb(0,0,0);font-weight:normal;font-style:normal;text-decoration: none}
span.cls_064{font-family:Arial,serif;font-size:9.6px;color:rgb(0,0,0);font-weight:normal;font-style:normal;text-decoration: none}
div.cls_064{font-family:Arial,serif;font-size:9.6px;color:rgb(0,0,0);font-weight:normal;font-style:normal;text-decoration: none}
span.cls_065{font-family:"Book Antiqua",serif;font-size:7.5px;color:rgb(0,0,0);font-weight:normal;font-style:normal;text-decoration: none}
div.cls_065{font-family:"Book Antiqua",serif;font-size:7.5px;color:rgb(0,0,0);font-weight:normal;font-style:normal;text-decoration: none}
span.cls_066{font-family:Times,serif;font-size:8.6px;color:rgb(0,0,0);font-weight:normal;font-style:italic;text-decoration: none}
div.cls_066{font-family:Times,serif;font-size:8.6px;color:rgb(0,0,0);font-weight:normal;font-style:italic;text-decoration: none}
span.cls_067{font-family:Arial,serif;font-size:8.1px;color:rgb(0,0,0);font-weight:normal;font-style:normal;text-decoration: none}
div.cls_067{font-family:Arial,serif;font-size:8.1px;color:rgb(0,0,0);font-weight:normal;font-style:normal;text-decoration: none}
span.cls_068{font-family:Arial,serif;font-size:8.6px;color:rgb(0,0,0);font-weight:bold;font-style:normal;text-decoration: none}
div.cls_068{font-family:Arial,serif;font-size:8.6px;color:rgb(0,0,0);font-weight:bold;font-style:normal;text-decoration: none}
span.cls_069{font-family:Times,serif;font-size:7.5px;color:rgb(0,0,0);font-weight:bold;font-style:normal;text-decoration: none}
div.cls_069{font-family:Times,serif;font-size:7.5px;color:rgb(0,0,0);font-weight:bold;font-style:normal;text-decoration: none}
span.cls_071{font-family:Times,serif;font-size:9.6px;color:rgb(0,0,0);font-weight:normal;font-style:normal;text-decoration: none}
div.cls_071{font-family:Times,serif;font-size:9.6px;color:rgb(0,0,0);font-weight:normal;font-style:normal;text-decoration: none}
span.cls_072{font-family:Times,serif;font-size:9.5px;color:rgb(0,0,0);font-weight:normal;font-style:normal;text-decoration: none}
div.cls_072{font-family:Times,serif;font-size:9.5px;color:rgb(0,0,0);font-weight:normal;font-style:normal;text-decoration: none}
span.cls_074{font-family:Times,serif;font-size:7.5px;color:rgb(0,0,0);font-weight:bold;font-style:normal;text-decoration: none}
div.cls_074{font-family:Times,serif;font-size:7.5px;color:rgb(0,0,0);font-weight:bold;font-style:normal;text-decoration: none}
span.cls_075{font-family:Times,serif;font-size:7.5px;color:rgb(0,0,0);font-weight:normal;font-style:normal;text-decoration: none}
div.cls_075{font-family:Times,serif;font-size:7.5px;color:rgb(0,0,0);font-weight:normal;font-style:normal;text-decoration: none}
span.cls_076{font-family:"Book Antiqua",serif;font-size:7.2px;color:rgb(0,0,0);font-weight:normal;font-style:normal;text-decoration: none}
div.cls_076{font-family:"Book Antiqua",serif;font-size:7.2px;color:rgb(0,0,0);font-weight:normal;font-style:normal;text-decoration: none}
span.cls_077{font-family:Arial,serif;font-size:7.2px;color:rgb(0,0,0);font-weight:normal;font-style:normal;text-decoration: none}
div.cls_077{font-family:Arial,serif;font-size:7.2px;color:rgb(0,0,0);font-weight:normal;font-style:normal;text-decoration: none}
span.cls_078{font-family:"Book Antiqua",serif;font-size:7.2px;color:rgb(0,0,0);font-weight:normal;font-style:italic;text-decoration: none}
div.cls_078{font-family:"Book Antiqua",serif;font-size:7.2px;color:rgb(0,0,0);font-weight:normal;font-style:italic;text-decoration: none}
span.cls_079{font-family:"Book Antiqua",serif;font-size:8.9px;color:rgb(0,0,0);font-weight:normal;font-style:normal;text-decoration: none}
div.cls_079{font-family:"Book Antiqua",serif;font-size:8.9px;color:rgb(0,0,0);font-weight:normal;font-style:normal;text-decoration: none}
span.cls_080{font-family:"Book Antiqua",serif;font-size:5.7px;color:rgb(0,0,0);font-weight:normal;font-style:normal;text-decoration: none}
div.cls_080{font-family:"Book Antiqua",serif;font-size:5.7px;color:rgb(0,0,0);font-weight:normal;font-style:normal;text-decoration: none}
span.cls_081{font-family:"Book Antiqua",serif;font-size:5.8px;color:rgb(0,0,0);font-weight:normal;font-style:normal;text-decoration: none}
div.cls_081{font-family:"Book Antiqua",serif;font-size:5.8px;color:rgb(0,0,0);font-weight:normal;font-style:normal;text-decoration: none}
span.cls_082{font-family:"Book Antiqua",serif;font-size:6.8px;color:rgb(0,0,0);font-weight:normal;font-style:normal;text-decoration: none}
div.cls_082{font-family:"Book Antiqua",serif;font-size:6.8px;color:rgb(0,0,0);font-weight:normal;font-style:normal;text-decoration: none}
span.cls_083{font-family:Times,serif;font-size:8.1px;color:rgb(114,114,114);font-weight:normal;font-style:normal;text-decoration: none}
div.cls_083{font-family:Times,serif;font-size:8.1px;color:rgb(114,114,114);font-weight:normal;font-style:normal;text-decoration: none}
span.cls_084{font-family:Arial,serif;font-size:8.1px;color:rgb(114,114,114);font-weight:bold;font-style:normal;text-decoration: none}
div.cls_084{font-family:Arial,serif;font-size:8.1px;color:rgb(114,114,114);font-weight:bold;font-style:normal;text-decoration: none}
span.cls_085{font-family:Times,serif;font-size:8.1px;color:rgb(114,114,114);font-weight:bold;font-style:normal;text-decoration: none}
div.cls_085{font-family:Times,serif;font-size:8.1px;color:rgb(114,114,114);font-weight:bold;font-style:normal;text-decoration: none}
span.cls_086{font-family:Times,serif;font-size:8.1px;color:rgb(0,0,0);font-weight:normal;font-style:normal;text-decoration: none}
div.cls_086{font-family:Times,serif;font-size:8.1px;color:rgb(0,0,0);font-weight:normal;font-style:normal;text-decoration: none}
span.cls_087{font-family:"Book Antiqua",serif;font-size:8.1px;color:rgb(0,0,0);font-weight:normal;font-style:normal;text-decoration: none}
div.cls_087{font-family:"Book Antiqua",serif;font-size:8.1px;color:rgb(0,0,0);font-weight:normal;font-style:normal;text-decoration: none}
span.cls_088{font-family:Times,serif;font-size:8.0px;color:rgb(0,0,0);font-weight:normal;font-style:normal;text-decoration: none}
div.cls_088{font-family:Times,serif;font-size:8.0px;color:rgb(0,0,0);font-weight:normal;font-style:normal;text-decoration: none}
span.cls_089{font-family:"Book Antiqua",serif;font-size:8.0px;color:rgb(0,0,0);font-weight:normal;font-style:normal;text-decoration: none}
div.cls_089{font-family:"Book Antiqua",serif;font-size:8.0px;color:rgb(0,0,0);font-weight:normal;font-style:normal;text-decoration: none}
span.cls_090{font-family:Times,serif;font-size:9.5px;color:rgb(0,0,0);font-weight:normal;font-style:normal;text-decoration: none}
div.cls_090{font-family:Times,serif;font-size:9.5px;color:rgb(0,0,0);font-weight:normal;font-style:normal;text-decoration: none}
span.cls_091{font-family:Times,serif;font-size:8.0px;color:rgb(0,0,0);font-weight:normal;font-style:normal;text-decoration: none}
div.cls_091{font-family:Times,serif;font-size:8.0px;color:rgb(0,0,0);font-weight:normal;font-style:normal;text-decoration: none}
span.cls_092{font-family:Times,serif;font-size:9.6px;color:rgb(0,0,0);font-weight:normal;font-style:normal;text-decoration: none}
div.cls_092{font-family:Times,serif;font-size:9.6px;color:rgb(0,0,0);font-weight:normal;font-style:normal;text-decoration: none}
span.cls_093{font-family:Times,serif;font-size:8.1px;color:rgb(0,0,0);font-weight:normal;font-style:normal;text-decoration: none}
div.cls_093{font-family:Times,serif;font-size:8.1px;color:rgb(0,0,0);font-weight:normal;font-style:normal;text-decoration: none}
span.cls_094{font-family:Times,serif;font-size:7.9px;color:rgb(0,0,0);font-weight:normal;font-style:normal;text-decoration: none}
div.cls_094{font-family:Times,serif;font-size:7.9px;color:rgb(0,0,0);font-weight:normal;font-style:normal;text-decoration: none}
span.cls_095{font-family:Times,serif;font-size:7.9px;color:rgb(0,0,0);font-weight:bold;font-style:normal;text-decoration: none}
div.cls_095{font-family:Times,serif;font-size:7.9px;color:rgb(0,0,0);font-weight:bold;font-style:normal;text-decoration: none}
span.cls_096{font-family:"Book Antiqua",serif;font-size:7.9px;color:rgb(0,0,0);font-weight:normal;font-style:normal;text-decoration: none}
div.cls_096{font-family:"Book Antiqua",serif;font-size:7.9px;color:rgb(0,0,0);font-weight:normal;font-style:normal;text-decoration: none}
span.cls_097{font-family:Times,serif;font-size:7.3px;color:rgb(0,0,0);font-weight:normal;font-style:normal;text-decoration: none}
div.cls_097{font-family:Times,serif;font-size:7.3px;color:rgb(0,0,0);font-weight:normal;font-style:normal;text-decoration: none}
span.cls_099{font-family:Times,serif;font-size:7.6px;color:rgb(0,0,0);font-weight:normal;font-style:normal;text-decoration: none}
div.cls_099{font-family:Times,serif;font-size:7.6px;color:rgb(0,0,0);font-weight:normal;font-style:normal;text-decoration: none}
span.cls_100{font-family:Times,serif;font-size:8.6px;color:rgb(0,0,0);font-weight:normal;font-style:normal;text-decoration: none}
div.cls_100{font-family:Times,serif;font-size:8.6px;color:rgb(0,0,0);font-weight:normal;font-style:normal;text-decoration: none}
span.cls_102{font-family:"Book Antiqua",serif;font-size:8.2px;color:rgb(0,0,0);font-weight:normal;font-style:normal;text-decoration: none}
div.cls_102{font-family:"Book Antiqua",serif;font-size:8.2px;color:rgb(0,0,0);font-weight:normal;font-style:normal;text-decoration: none}
span.cls_104{font-family:Arial,serif;font-size:8.2px;color:rgb(0,0,0);font-weight:normal;font-style:normal;text-decoration: none}
div.cls_104{font-family:Arial,serif;font-size:8.2px;color:rgb(0,0,0);font-weight:normal;font-style:normal;text-decoration: none}
span.cls_103{font-family:Times,serif;font-size:8.2px;color:rgb(0,0,0);font-weight:normal;font-style:normal;text-decoration: none}
div.cls_103{font-family:Times,serif;font-size:8.2px;color:rgb(0,0,0);font-weight:normal;font-style:normal;text-decoration: none}
span.cls_106{font-family:Times,serif;font-size:8.5px;color:rgb(0,0,0);font-weight:bold;font-style:normal;text-decoration: none}
div.cls_106{font-family:Times,serif;font-size:8.5px;color:rgb(0,0,0);font-weight:bold;font-style:normal;text-decoration: none}
span.cls_105{font-family:Times,serif;font-size:7.6px;color:rgb(0,0,0);font-weight:normal;font-style:normal;text-decoration: none}
div.cls_105{font-family:Times,serif;font-size:7.6px;color:rgb(0,0,0);font-weight:normal;font-style:normal;text-decoration: none}
span.cls_107{font-family:"Book Antiqua",serif;font-size:5.7px;color:rgb(0,0,0);font-weight:normal;font-style:normal;text-decoration: none}
div.cls_107{font-family:"Book Antiqua",serif;font-size:5.7px;color:rgb(0,0,0);font-weight:normal;font-style:normal;text-decoration: none}
span.cls_108{font-family:"Book Antiqua",serif;font-size:6.7px;color:rgb(0,0,0);font-weight:normal;font-style:normal;text-decoration: none}
div.cls_108{font-family:"Book Antiqua",serif;font-size:6.7px;color:rgb(0,0,0);font-weight:normal;font-style:normal;text-decoration: none}
span.cls_109{font-family:Times,serif;font-size:9.0px;color:rgb(0,0,0);font-weight:bold;font-style:normal;text-decoration: none}
div.cls_109{font-family:Times,serif;font-size:9.0px;color:rgb(0,0,0);font-weight:bold;font-style:normal;text-decoration: none}
span.cls_110{font-family:"Book Antiqua",serif;font-size:9.0px;color:rgb(0,0,0);font-weight:normal;font-style:normal;text-decoration: none}
div.cls_110{font-family:"Book Antiqua",serif;font-size:9.0px;color:rgb(0,0,0);font-weight:normal;font-style:normal;text-decoration: none}
span.cls_111{font-family:Times,serif;font-size:8.0px;color:rgb(0,0,0);font-weight:normal;font-style:normal;text-decoration: none}
div.cls_111{font-family:Times,serif;font-size:8.0px;color:rgb(0,0,0);font-weight:normal;font-style:normal;text-decoration: none}
span.cls_112{font-family:Times,serif;font-size:9.0px;color:rgb(0,0,0);font-weight:bold;font-style:normal;text-decoration: none}
div.cls_112{font-family:Times,serif;font-size:9.0px;color:rgb(0,0,0);font-weight:bold;font-style:normal;text-decoration: none}
span.cls_113{font-family:"Book Antiqua",serif;font-size:9.0px;color:rgb(0,0,0);font-weight:normal;font-style:normal;text-decoration: none}
div.cls_113{font-family:"Book Antiqua",serif;font-size:9.0px;color:rgb(0,0,0);font-weight:normal;font-style:normal;text-decoration: none}
span.cls_114{font-family:Times,serif;font-size:8.0px;color:rgb(0,0,0);font-weight:normal;font-style:normal;text-decoration: none}
div.cls_114{font-family:Times,serif;font-size:8.0px;color:rgb(0,0,0);font-weight:normal;font-style:normal;text-decoration: none}
span.cls_117{font-family:Times,serif;font-size:9.0px;color:rgb(0,0,0);font-weight:bold;font-style:normal;text-decoration: none}
div.cls_117{font-family:Times,serif;font-size:9.0px;color:rgb(0,0,0);font-weight:bold;font-style:normal;text-decoration: none}
span.cls_118{font-family:Arial,serif;font-size:9.0px;color:rgb(0,0,0);font-weight:normal;font-style:normal;text-decoration: none}
div.cls_118{font-family:Arial,serif;font-size:9.0px;color:rgb(0,0,0);font-weight:normal;font-style:normal;text-decoration: none}
span.cls_119{font-family:Arial,serif;font-size:8.0px;color:rgb(0,0,0);font-weight:normal;font-style:normal;text-decoration: none}
div.cls_119{font-family:Arial,serif;font-size:8.0px;color:rgb(0,0,0);font-weight:normal;font-style:normal;text-decoration: none}
span.cls_120{font-family:"Book Antiqua",serif;font-size:9.0px;color:rgb(0,0,0);font-weight:normal;font-style:normal;text-decoration: none}
div.cls_120{font-family:"Book Antiqua",serif;font-size:9.0px;color:rgb(0,0,0);font-weight:normal;font-style:normal;text-decoration: none}
span.cls_122{font-family:Times,serif;font-size:9.0px;color:rgb(0,0,0);font-weight:normal;font-style:normal;text-decoration: none}
div.cls_122{font-family:Times,serif;font-size:9.0px;color:rgb(0,0,0);font-weight:normal;font-style:normal;text-decoration: none}
span.cls_123{font-family:Times,serif;font-size:8.8px;color:rgb(0,0,0);font-weight:bold;font-style:normal;text-decoration: none}
div.cls_123{font-family:Times,serif;font-size:8.8px;color:rgb(0,0,0);font-weight:bold;font-style:normal;text-decoration: none}
span.cls_124{font-family:Times,serif;font-size:8.8px;color:rgb(0,0,0);font-weight:normal;font-style:normal;text-decoration: none}
div.cls_124{font-family:Times,serif;font-size:8.8px;color:rgb(0,0,0);font-weight:normal;font-style:normal;text-decoration: none}
span.cls_125{font-family:Times,serif;font-size:7.8px;color:rgb(0,0,0);font-weight:normal;font-style:normal;text-decoration: none}
div.cls_125{font-family:Times,serif;font-size:7.8px;color:rgb(0,0,0);font-weight:normal;font-style:normal;text-decoration: none}
span.cls_126{font-family:"Book Antiqua",serif;font-size:8.8px;color:rgb(0,0,0);font-weight:normal;font-style:normal;text-decoration: none}
div.cls_126{font-family:"Book Antiqua",serif;font-size:8.8px;color:rgb(0,0,0);font-weight:normal;font-style:normal;text-decoration: none}
span.cls_127{font-family:Times,serif;font-size:8.0px;color:rgb(0,0,0);font-weight:normal;font-style:normal;text-decoration: none}
div.cls_127{font-family:Times,serif;font-size:8.0px;color:rgb(0,0,0);font-weight:normal;font-style:normal;text-decoration: none}
span.cls_128{font-family:"Book Antiqua",serif;font-size:8.0px;color:rgb(0,0,0);font-weight:normal;font-style:normal;text-decoration: none}
div.cls_128{font-family:"Book Antiqua",serif;font-size:8.0px;color:rgb(0,0,0);font-weight:normal;font-style:normal;text-decoration: none}
span.cls_129{font-family:Times,serif;font-size:8.0px;color:rgb(0,0,0);font-weight:bold;font-style:normal;text-decoration: none}
div.cls_129{font-family:Times,serif;font-size:8.0px;color:rgb(0,0,0);font-weight:bold;font-style:normal;text-decoration: none}
span.cls_131{font-family:Arial,serif;font-size:12.7px;color:rgb(0,0,0);font-weight:normal;font-style:normal;text-decoration: none}
div.cls_131{font-family:Arial,serif;font-size:12.7px;color:rgb(0,0,0);font-weight:normal;font-style:normal;text-decoration: none}
span.cls_133{font-family:Times,serif;font-size:7.6px;color:rgb(0,0,0);font-weight:normal;font-style:normal;text-decoration: none}
div.cls_133{font-family:Times,serif;font-size:7.6px;color:rgb(0,0,0);font-weight:normal;font-style:normal;text-decoration: none}
span.cls_134{font-family:"Book Antiqua",serif;font-size:5.8px;color:rgb(0,0,0);font-weight:normal;font-style:normal;text-decoration: none}
div.cls_134{font-family:"Book Antiqua",serif;font-size:5.8px;color:rgb(0,0,0);font-weight:normal;font-style:normal;text-decoration: none}
span.cls_135{font-family:"Book Antiqua",serif;font-size:6.8px;color:rgb(0,0,0);font-weight:normal;font-style:normal;text-decoration: none}
div.cls_135{font-family:"Book Antiqua",serif;font-size:6.8px;color:rgb(0,0,0);font-weight:normal;font-style:normal;text-decoration: none}
span.cls_136{font-family:Arial,serif;font-size:5.0px;color:rgb(0,0,0);font-weight:bold;font-style:normal;text-decoration: none}
div.cls_136{font-family:Arial,serif;font-size:5.0px;color:rgb(0,0,0);font-weight:bold;font-style:normal;text-decoration: none}
span.cls_137{font-family:"Book Antiqua",serif;font-size:5.5px;color:rgb(0,0,0);font-weight:normal;font-style:normal;text-decoration: none}
div.cls_137{font-family:"Book Antiqua",serif;font-size:5.5px;color:rgb(0,0,0);font-weight:normal;font-style:normal;text-decoration: none}
span.cls_138{font-family:"Book Antiqua",serif;font-size:6.5px;color:rgb(0,0,0);font-weight:normal;font-style:normal;text-decoration: none}
div.cls_138{font-family:"Book Antiqua",serif;font-size:6.5px;color:rgb(0,0,0);font-weight:normal;font-style:normal;text-decoration: none}
span.cls_139{font-family:"Book Antiqua",serif;font-size:5.7px;color:rgb(0,0,0);font-weight:normal;font-style:normal;text-decoration: none}
div.cls_139{font-family:"Book Antiqua",serif;font-size:5.7px;color:rgb(0,0,0);font-weight:normal;font-style:normal;text-decoration: none}
span.cls_140{font-family:"Book Antiqua",serif;font-size:6.6px;color:rgb(0,0,0);font-weight:normal;font-style:normal;text-decoration: none}
div.cls_140{font-family:"Book Antiqua",serif;font-size:6.6px;color:rgb(0,0,0);font-weight:normal;font-style:normal;text-decoration: none}
span.cls_141{font-family:Times,serif;font-size:9.1px;color:rgb(0,0,0);font-weight:bold;font-style:normal;text-decoration: none}
div.cls_141{font-family:Times,serif;font-size:9.1px;color:rgb(0,0,0);font-weight:bold;font-style:normal;text-decoration: none}
span.cls_142{font-family:Times,serif;font-size:8.1px;color:rgb(0,0,0);font-weight:normal;font-style:normal;text-decoration: none}
div.cls_142{font-family:Times,serif;font-size:8.1px;color:rgb(0,0,0);font-weight:normal;font-style:normal;text-decoration: none}
span.cls_143{font-family:Times,serif;font-size:6.0px;color:rgb(0,0,0);font-weight:normal;font-style:normal;text-decoration: none}
div.cls_143{font-family:Times,serif;font-size:6.0px;color:rgb(0,0,0);font-weight:normal;font-style:normal;text-decoration: none}
span.cls_144{font-family:"Book Antiqua",serif;font-size:7.7px;color:rgb(0,0,0);font-weight:normal;font-style:normal;text-decoration: none}
div.cls_144{font-family:"Book Antiqua",serif;font-size:7.7px;color:rgb(0,0,0);font-weight:normal;font-style:normal;text-decoration: none}
span.cls_145{font-family:Times,serif;font-size:7.7px;color:rgb(0,0,0);font-weight:normal;font-style:normal;text-decoration: none}
div.cls_145{font-family:Times,serif;font-size:7.7px;color:rgb(0,0,0);font-weight:normal;font-style:normal;text-decoration: none}
span.cls_146{font-family:Times,serif;font-size:8.9px;color:rgb(0,0,0);font-weight:bold;font-style:normal;text-decoration: none}
div.cls_146{font-family:Times,serif;font-size:8.9px;color:rgb(0,0,0);font-weight:bold;font-style:normal;text-decoration: none}
span.cls_147{font-family:Arial,serif;font-size:8.9px;color:rgb(0,0,0);font-weight:bold;font-style:normal;text-decoration: none}
div.cls_147{font-family:Arial,serif;font-size:8.9px;color:rgb(0,0,0);font-weight:bold;font-style:normal;text-decoration: none}
span.cls_148{font-family:"Book Antiqua",serif;font-size:7.6px;color:rgb(0,0,0);font-weight:normal;font-style:normal;text-decoration: none}
div.cls_148{font-family:"Book Antiqua",serif;font-size:7.6px;color:rgb(0,0,0);font-weight:normal;font-style:normal;text-decoration: none}
span.cls_149{font-family:Arial,serif;font-size:7.6px;color:rgb(0,0,0);font-weight:normal;font-style:normal;text-decoration: none}
div.cls_149{font-family:Arial,serif;font-size:7.6px;color:rgb(0,0,0);font-weight:normal;font-style:normal;text-decoration: none}
span.cls_150{font-family:Times,serif;font-size:8.6px;color:rgb(0,0,0);font-weight:bold;font-style:normal;text-decoration: none}
div.cls_150{font-family:Times,serif;font-size:8.6px;color:rgb(0,0,0);font-weight:bold;font-style:normal;text-decoration: none}
span.cls_151{font-family:Times,serif;font-size:7.6px;color:rgb(0,0,0);font-weight:normal;font-style:normal;text-decoration: none}
div.cls_151{font-family:Times,serif;font-size:7.6px;color:rgb(0,0,0);font-weight:normal;font-style:normal;text-decoration: none}
span.cls_154{font-family:Times,serif;font-size:9.0px;color:rgb(0,0,0);font-weight:bold;font-style:normal;text-decoration: none}
div.cls_154{font-family:Times,serif;font-size:9.0px;color:rgb(0,0,0);font-weight:bold;font-style:normal;text-decoration: none}
span.cls_155{font-family:"Book Antiqua",serif;font-size:8.0px;color:rgb(0,0,0);font-weight:normal;font-style:normal;text-decoration: none}
div.cls_155{font-family:"Book Antiqua",serif;font-size:8.0px;color:rgb(0,0,0);font-weight:normal;font-style:normal;text-decoration: none}
span.cls_156{font-family:Times,serif;font-size:9.5px;color:rgb(0,0,0);font-weight:normal;font-style:normal;text-decoration: none}
div.cls_156{font-family:Times,serif;font-size:9.5px;color:rgb(0,0,0);font-weight:normal;font-style:normal;text-decoration: none}
span.cls_158{font-family:Times,serif;font-size:8.0px;color:rgb(0,0,0);font-weight:normal;font-style:normal;text-decoration: none}
div.cls_158{font-family:Times,serif;font-size:8.0px;color:rgb(0,0,0);font-weight:normal;font-style:normal;text-decoration: none}
span.cls_159{font-family:"Book Antiqua",serif;font-size:7.6px;color:rgb(0,0,0);font-weight:normal;font-style:normal;text-decoration: none}
div.cls_159{font-family:"Book Antiqua",serif;font-size:7.6px;color:rgb(0,0,0);font-weight:normal;font-style:normal;text-decoration: none}
span.cls_160{font-family:Times,serif;font-size:9.6px;color:rgb(0,0,0);font-weight:bold;font-style:normal;text-decoration: none}
div.cls_160{font-family:Times,serif;font-size:9.6px;color:rgb(0,0,0);font-weight:bold;font-style:normal;text-decoration: none}
span.cls_164{font-family:Times,serif;font-size:7.4px;color:rgb(0,0,0);font-weight:normal;font-style:normal;text-decoration: none}
div.cls_164{font-family:Times,serif;font-size:7.4px;color:rgb(0,0,0);font-weight:normal;font-style:normal;text-decoration: none}
span.cls_165{font-family:"Book Antiqua",serif;font-size:8.9px;color:rgb(0,0,0);font-weight:normal;font-style:normal;text-decoration: none}
div.cls_165{font-family:"Book Antiqua",serif;font-size:8.9px;color:rgb(0,0,0);font-weight:normal;font-style:normal;text-decoration: none}
span.cls_166{font-family:Times,serif;font-size:8.9px;color:rgb(0,0,0);font-weight:bold;font-style:normal;text-decoration: none}
div.cls_166{font-family:Times,serif;font-size:8.9px;color:rgb(0,0,0);font-weight:bold;font-style:normal;text-decoration: none}
span.cls_168{font-family:Times,serif;font-size:9.4px;color:rgb(0,0,0);font-weight:normal;font-style:normal;text-decoration: none}
div.cls_168{font-family:Times,serif;font-size:9.4px;color:rgb(0,0,0);font-weight:normal;font-style:normal;text-decoration: none}
span.cls_167{font-family:Times,serif;font-size:7.9px;color:rgb(0,0,0);font-weight:normal;font-style:normal;text-decoration: none}
div.cls_167{font-family:Times,serif;font-size:7.9px;color:rgb(0,0,0);font-weight:normal;font-style:normal;text-decoration: none}
span.cls_169{font-family:Times,serif;font-size:8.9px;color:rgb(0,0,0);font-weight:normal;font-style:normal;text-decoration: none}
div.cls_169{font-family:Times,serif;font-size:8.9px;color:rgb(0,0,0);font-weight:normal;font-style:normal;text-decoration: none}
span.cls_170{font-family:Times,serif;font-size:9.5px;color:rgb(0,0,0);font-weight:normal;font-style:normal;text-decoration: none}
div.cls_170{font-family:Times,serif;font-size:9.5px;color:rgb(0,0,0);font-weight:normal;font-style:normal;text-decoration: none}
span.cls_172{font-family:Times,serif;font-size:9.0px;color:rgb(0,0,0);font-weight:bold;font-style:normal;text-decoration: none}
div.cls_172{font-family:Times,serif;font-size:9.0px;color:rgb(0,0,0);font-weight:bold;font-style:normal;text-decoration: none}
span.cls_171{font-family:Times,serif;font-size:8.0px;color:rgb(0,0,0);font-weight:normal;font-style:normal;text-decoration: none}
div.cls_171{font-family:Times,serif;font-size:8.0px;color:rgb(0,0,0);font-weight:normal;font-style:normal;text-decoration: none}
span.cls_173{font-family:Times,serif;font-size:8.9px;color:rgb(0,0,0);font-weight:normal;font-style:normal;text-decoration: none}
div.cls_173{font-family:Times,serif;font-size:8.9px;color:rgb(0,0,0);font-weight:normal;font-style:normal;text-decoration: none}
span.cls_174{font-family:"Book Antiqua",serif;font-size:8.9px;color:rgb(0,0,0);font-weight:normal;font-style:normal;text-decoration: none}
div.cls_174{font-family:"Book Antiqua",serif;font-size:8.9px;color:rgb(0,0,0);font-weight:normal;font-style:normal;text-decoration: none}
span.cls_175{font-family:Times,serif;font-size:9.4px;color:rgb(0,0,0);font-weight:normal;font-style:normal;text-decoration: none}
div.cls_175{font-family:Times,serif;font-size:9.4px;color:rgb(0,0,0);font-weight:normal;font-style:normal;text-decoration: none}
span.cls_176{font-family:Arial,serif;font-size:9.4px;color:rgb(0,0,0);font-weight:bold;font-style:normal;text-decoration: none}
div.cls_176{font-family:Arial,serif;font-size:9.4px;color:rgb(0,0,0);font-weight:bold;font-style:normal;text-decoration: none}
span.cls_177{font-family:Arial,serif;font-size:8.9px;color:rgb(0,0,0);font-weight:normal;font-style:normal;text-decoration: none}
div.cls_177{font-family:Arial,serif;font-size:8.9px;color:rgb(0,0,0);font-weight:normal;font-style:normal;text-decoration: none}
span.cls_180{font-family:Times,serif;font-size:8.7px;color:rgb(0,0,0);font-weight:normal;font-style:normal;text-decoration: none}
div.cls_180{font-family:Times,serif;font-size:8.7px;color:rgb(0,0,0);font-weight:normal;font-style:normal;text-decoration: none}
span.cls_181{font-family:Times,serif;font-size:8.7px;color:rgb(0,0,0);font-weight:bold;font-style:normal;text-decoration: none}
div.cls_181{font-family:Times,serif;font-size:8.7px;color:rgb(0,0,0);font-weight:bold;font-style:normal;text-decoration: none}
span.cls_182{font-family:"Book Antiqua",serif;font-size:7.4px;color:rgb(0,0,0);font-weight:normal;font-style:normal;text-decoration: none}
div.cls_182{font-family:"Book Antiqua",serif;font-size:7.4px;color:rgb(0,0,0);font-weight:normal;font-style:normal;text-decoration: none}
span.cls_184{font-family:Times,serif;font-size:7.4px;color:rgb(0,0,0);font-weight:normal;font-style:normal;text-decoration: none}
div.cls_184{font-family:Times,serif;font-size:7.4px;color:rgb(0,0,0);font-weight:normal;font-style:normal;text-decoration: none}
span.cls_185{font-family:Times,serif;font-size:8.3px;color:rgb(0,0,0);font-weight:bold;font-style:normal;text-decoration: none}
div.cls_185{font-family:Times,serif;font-size:8.3px;color:rgb(0,0,0);font-weight:bold;font-style:normal;text-decoration: none}
span.cls_186{font-family:Times,serif;font-size:8.3px;color:rgb(0,0,0);font-weight:normal;font-style:normal;text-decoration: none}
div.cls_186{font-family:Times,serif;font-size:8.3px;color:rgb(0,0,0);font-weight:normal;font-style:normal;text-decoration: none}
span.cls_187{font-family:"Book Antiqua",serif;font-size:6.0px;color:rgb(0,0,0);font-weight:normal;font-style:italic;text-decoration: none}
div.cls_187{font-family:"Book Antiqua",serif;font-size:6.0px;color:rgb(0,0,0);font-weight:normal;font-style:italic;text-decoration: none}
span.cls_188{font-family:"Book Antiqua",serif;font-size:8.2px;color:rgb(0,0,0);font-weight:normal;font-style:normal;text-decoration: none}
div.cls_188{font-family:"Book Antiqua",serif;font-size:8.2px;color:rgb(0,0,0);font-weight:normal;font-style:normal;text-decoration: none}
span.cls_189{font-family:Times,serif;font-size:8.6px;color:rgb(0,0,0);font-weight:normal;font-style:normal;text-decoration: none}
div.cls_189{font-family:Times,serif;font-size:8.6px;color:rgb(0,0,0);font-weight:normal;font-style:normal;text-decoration: none}
span.cls_190{font-family:Times,serif;font-size:7.2px;color:rgb(0,0,0);font-weight:normal;font-style:normal;text-decoration: none}
div.cls_190{font-family:Times,serif;font-size:7.2px;color:rgb(0,0,0);font-weight:normal;font-style:normal;text-decoration: none}
span.cls_191{font-family:Times,serif;font-size:8.2px;color:rgb(0,0,0);font-weight:bold;font-style:normal;text-decoration: none}
div.cls_191{font-family:Times,serif;font-size:8.2px;color:rgb(0,0,0);font-weight:bold;font-style:normal;text-decoration: none}
span.cls_193{font-family:Arial,serif;font-size:8.2px;color:rgb(0,0,0);font-weight:normal;font-style:normal;text-decoration: none}
div.cls_193{font-family:Arial,serif;font-size:8.2px;color:rgb(0,0,0);font-weight:normal;font-style:normal;text-decoration: none}
span.cls_192{font-family:Arial,serif;font-size:10.9px;color:rgb(0,0,0);font-weight:normal;font-style:normal;text-decoration: none}
div.cls_192{font-family:Arial,serif;font-size:10.9px;color:rgb(0,0,0);font-weight:normal;font-style:normal;text-decoration: none}
span.cls_194{font-family:Times,serif;font-size:8.2px;color:rgb(0,0,0);font-weight:normal;font-style:normal;text-decoration: none}
div.cls_194{font-family:Times,serif;font-size:8.2px;color:rgb(0,0,0);font-weight:normal;font-style:normal;text-decoration: none}
span.cls_195{font-family:"Book Antiqua",serif;font-size:7.2px;color:rgb(0,0,0);font-weight:normal;font-style:normal;text-decoration: none}
div.cls_195{font-family:"Book Antiqua",serif;font-size:7.2px;color:rgb(0,0,0);font-weight:normal;font-style:normal;text-decoration: none}
span.cls_196{font-family:Times,serif;font-size:5.5px;color:rgb(0,0,0);font-weight:normal;font-style:normal;text-decoration: none}
div.cls_196{font-family:Times,serif;font-size:5.5px;color:rgb(0,0,0);font-weight:normal;font-style:normal;text-decoration: none}
span.cls_197{font-family:Arial,serif;font-size:9.6px;color:rgb(0,0,0);font-weight:bold;font-style:normal;text-decoration: none}
div.cls_197{font-family:Arial,serif;font-size:9.6px;color:rgb(0,0,0);font-weight:bold;font-style:normal;text-decoration: none}
span.cls_198{font-family:"Book Antiqua",serif;font-size:9.1px;color:rgb(34,30,31);font-weight:normal;font-style:normal;text-decoration: none}
div.cls_198{font-family:"Book Antiqua",serif;font-size:9.1px;color:rgb(34,30,31);font-weight:normal;font-style:normal;text-decoration: none}
span.cls_199{font-family:"Book Antiqua",serif;font-size:10.1px;color:rgb(0,0,0);font-weight:normal;font-style:normal;text-decoration: none}
div.cls_199{font-family:"Book Antiqua",serif;font-size:10.1px;color:rgb(0,0,0);font-weight:normal;font-style:normal;text-decoration: none}
span.cls_200{font-family:"Book Antiqua",serif;font-size:9.1px;color:rgb(0,0,0);font-weight:normal;font-style:italic;text-decoration: none}
div.cls_200{font-family:"Book Antiqua",serif;font-size:9.1px;color:rgb(0,0,0);font-weight:normal;font-style:italic;text-decoration: none}
span.cls_202{font-family:"Book Antiqua",serif;font-size:5.9px;color:rgb(0,0,0);font-weight:normal;font-style:normal;text-decoration: none}
div.cls_202{font-family:"Book Antiqua",serif;font-size:5.9px;color:rgb(0,0,0);font-weight:normal;font-style:normal;text-decoration: none}
span.cls_203{font-family:"Book Antiqua",serif;font-size:4.9px;color:rgb(0,0,0);font-weight:normal;font-style:normal;text-decoration: none}
div.cls_203{font-family:"Book Antiqua",serif;font-size:4.9px;color:rgb(0,0,0);font-weight:normal;font-style:normal;text-decoration: none}
span.cls_204{font-family:Arial,serif;font-size:9.7px;color:rgb(0,0,0);font-weight:normal;font-style:normal;text-decoration: none}
div.cls_204{font-family:Arial,serif;font-size:9.7px;color:rgb(0,0,0);font-weight:normal;font-style:normal;text-decoration: none}
span.cls_205{font-family:Arial,serif;font-size:9.0px;color:rgb(0,0,0);font-weight:normal;font-style:normal;text-decoration: none}
div.cls_205{font-family:Arial,serif;font-size:9.0px;color:rgb(0,0,0);font-weight:normal;font-style:normal;text-decoration: none}
span.cls_206{font-family:"Book Antiqua",serif;font-size:4.7px;color:rgb(0,0,0);font-weight:normal;font-style:normal;text-decoration: none}
div.cls_206{font-family:"Book Antiqua",serif;font-size:4.7px;color:rgb(0,0,0);font-weight:normal;font-style:normal;text-decoration: none}
span.cls_207{font-family:"Book Antiqua",serif;font-size:7.6px;color:rgb(0,0,0);font-weight:normal;font-style:normal;text-decoration: none}
div.cls_207{font-family:"Book Antiqua",serif;font-size:7.6px;color:rgb(0,0,0);font-weight:normal;font-style:normal;text-decoration: none}
span.cls_208{font-family:"Book Antiqua",serif;font-size:9.6px;color:rgb(0,0,0);font-weight:normal;font-style:normal;text-decoration: none}
div.cls_208{font-family:"Book Antiqua",serif;font-size:9.6px;color:rgb(0,0,0);font-weight:normal;font-style:normal;text-decoration: none}
span.cls_209{font-family:"Book Antiqua",serif;font-size:8.9px;color:rgb(0,0,0);font-weight:normal;font-style:normal;text-decoration: none}
div.cls_209{font-family:"Book Antiqua",serif;font-size:8.9px;color:rgb(0,0,0);font-weight:normal;font-style:normal;text-decoration: none}
span.cls_210{font-family:Times,serif;font-size:9.4px;color:rgb(0,0,0);font-weight:normal;font-style:normal;text-decoration: none}
div.cls_210{font-family:Times,serif;font-size:9.4px;color:rgb(0,0,0);font-weight:normal;font-style:normal;text-decoration: none}
span.cls_211{font-family:"Book Antiqua",serif;font-size:8.9px;color:rgb(0,0,0);font-weight:normal;font-style:italic;text-decoration: none}
div.cls_211{font-family:"Book Antiqua",serif;font-size:8.9px;color:rgb(0,0,0);font-weight:normal;font-style:italic;text-decoration: none}
span.cls_212{font-family:Arial,serif;font-size:8.8px;color:rgb(0,0,0);font-weight:bold;font-style:normal;text-decoration: none}
div.cls_212{font-family:Arial,serif;font-size:8.8px;color:rgb(0,0,0);font-weight:bold;font-style:normal;text-decoration: none}
span.cls_213{font-family:Arial,serif;font-size:12.1px;color:rgb(0,0,0);font-weight:normal;font-style:normal;text-decoration: none}
div.cls_213{font-family:Arial,serif;font-size:12.1px;color:rgb(0,0,0);font-weight:normal;font-style:normal;text-decoration: none}
span.cls_214{font-family:"Book Antiqua",serif;font-size:5.0px;color:rgb(0,0,0);font-weight:normal;font-style:normal;text-decoration: none}
div.cls_214{font-family:"Book Antiqua",serif;font-size:5.0px;color:rgb(0,0,0);font-weight:normal;font-style:normal;text-decoration: none}
span.cls_215{font-family:"Book Antiqua",serif;font-size:7.0px;color:rgb(0,0,0);font-weight:normal;font-style:normal;text-decoration: none}
div.cls_215{font-family:"Book Antiqua",serif;font-size:7.0px;color:rgb(0,0,0);font-weight:normal;font-style:normal;text-decoration: none}
span.cls_216{font-family:"Book Antiqua",serif;font-size:8.0px;color:rgb(0,0,0);font-weight:normal;font-style:normal;text-decoration: none}
div.cls_216{font-family:"Book Antiqua",serif;font-size:8.0px;color:rgb(0,0,0);font-weight:normal;font-style:normal;text-decoration: none}
span.cls_217{font-family:"Book Antiqua",serif;font-size:7.9px;color:rgb(0,0,0);font-weight:normal;font-style:normal;text-decoration: none}
div.cls_217{font-family:"Book Antiqua",serif;font-size:7.9px;color:rgb(0,0,0);font-weight:normal;font-style:normal;text-decoration: none}
span.cls_218{font-family:Arial,serif;font-size:11.1px;color:rgb(0,0,0);font-weight:bold;font-style:normal;text-decoration: none}
div.cls_218{font-family:Arial,serif;font-size:11.1px;color:rgb(0,0,0);font-weight:bold;font-style:normal;text-decoration: none}
span.cls_221{font-family:Times,serif;font-size:12.1px;color:rgb(0,0,0);font-weight:normal;font-style:normal;text-decoration: none}
div.cls_221{font-family:Times,serif;font-size:12.1px;color:rgb(0,0,0);font-weight:normal;font-style:normal;text-decoration: none}
span.cls_219{font-family:Times,serif;font-size:12.1px;color:rgb(0,0,0);font-weight:normal;font-style:italic;text-decoration: none}
div.cls_219{font-family:Times,serif;font-size:12.1px;color:rgb(0,0,0);font-weight:normal;font-style:italic;text-decoration: none}
span.cls_220{font-family:Arial,serif;font-size:10.1px;color:rgb(0,0,0);font-weight:bold;font-style:normal;text-decoration: none}
div.cls_220{font-family:Arial,serif;font-size:10.1px;color:rgb(0,0,0);font-weight:bold;font-style:normal;text-decoration: none}
span.cls_222{font-family:Times,serif;font-size:6.0px;color:rgb(0,0,0);font-weight:normal;font-style:normal;text-decoration: none}
div.cls_222{font-family:Times,serif;font-size:6.0px;color:rgb(0,0,0);font-weight:normal;font-style:normal;text-decoration: none}
-->
</style>
<script type="text/javascript" src="e698b76e-46bd-11eb-8b25-0cc47a792c0a_id_e698b76e-46bd-11eb-8b25-0cc47a792c0a_files/wz_jsgraphics.js"></script>
</head>
<body>
<div style="position:absolute;left:50%;margin-left:-251px;top:0px;width:503px;height:666px;border-style:outset;overflow:hidden">
<div style="position:absolute;left:0px;top:0px">
<img src="e698b76e-46bd-11eb-8b25-0cc47a792c0a_id_e698b76e-46bd-11eb-8b25-0cc47a792c0a_files/background001.jpg" width=503 height=666></div>
<div style="position:absolute;left:27.54px;top:32.98px" class="cls_002"><span class="cls_002">Ruby Under a</span></div>
<div style="position:absolute;left:27.54px;top:107.95px" class="cls_002"><span class="cls_002">Microscope</span></div>
<div style="position:absolute;left:27.54px;top:219.02px" class="cls_003"><span class="cls_003">An Illustrated Guide</span></div>
<div style="position:absolute;left:27.54px;top:253.01px" class="cls_003"><span class="cls_003">to Ruby Internals</span></div>
<div style="position:absolute;left:27.54px;top:313.32px" class="cls_004"><span class="cls_004">Pat Shaughnessy</span></div>
</div>
<div style="position:absolute;left:50%;margin-left:-252px;top:676px;width:504px;height:666px;border-style:outset;overflow:hidden">
<div style="position:absolute;left:0px;top:0px">
<img src="e698b76e-46bd-11eb-8b25-0cc47a792c0a_id_e698b76e-46bd-11eb-8b25-0cc47a792c0a_files/background002.jpg" width=504 height=666></div>
<div style="position:absolute;left:197.62px;top:123.97px" class="cls_005"><span class="cls_005">Praise for </span><span class="cls_006">Ruby Under a Microscope</span></div>
<div style="position:absolute;left:123.00px;top:153.97px" class="cls_007"><span class="cls_007">“Many people have dug into the Ruby source code, but few make it back</span></div>
<div style="position:absolute;left:123.00px;top:165.97px" class="cls_007"><span class="cls_007">out and tell the tale as elegantly as Pat does in </span><span class="cls_008">Ruby Under a Microscope</span><span class="cls_007"> !</span></div>
<div style="position:absolute;left:123.00px;top:177.97px" class="cls_007"><span class="cls_007">I particularly love the diagrams—and there are lots of them—as they</span></div>
<div style="position:absolute;left:123.00px;top:189.97px" class="cls_007"><span class="cls_007">make many opaque implementation topics a lot easier to understand,</span></div>
<div style="position:absolute;left:123.00px;top:201.97px" class="cls_007"><span class="cls_007">especially when coupled with Pat’s gentle narrative. This book is a delight</span></div>
<div style="position:absolute;left:123.00px;top:213.97px" class="cls_007"><span class="cls_007">for language implementation geeks and Rubyists with a penchant for dig-</span></div>
<div style="position:absolute;left:123.00px;top:225.97px" class="cls_007"><span class="cls_007">ging into the guts of their tools.”</span></div>
<div style="position:absolute;left:123.00px;top:237.97px" class="cls_007"><span class="cls_007">—P</span><span class="cls_009">eter</span><span class="cls_007"> C</span><span class="cls_009">ooper</span><span class="cls_007"> (@</span><span class="cls_009">peterc</span><span class="cls_007">), E</span><span class="cls_009">ditor</span><span class="cls_007"> </span><span class="cls_009">of</span><span class="cls_007"> </span><span class="cls_008">R</span><span class="cls_010">uby</span><span class="cls_008"> I</span><span class="cls_010">nside</span><span class="cls_007"> </span><span class="cls_009">and</span><span class="cls_007"> </span><span class="cls_008">R</span><span class="cls_010">uby</span><span class="cls_008"> W</span><span class="cls_010">eekly</span></div>
<div style="position:absolute;left:123.00px;top:261.97px" class="cls_007"><span class="cls_007">“Man, this book was missing in the Ruby landscape—awesome content.”</span></div>
<div style="position:absolute;left:123.00px;top:273.97px" class="cls_007"><span class="cls_007">—X</span><span class="cls_009">avier</span><span class="cls_007"> N</span><span class="cls_009">oria</span><span class="cls_007"> (@</span><span class="cls_009">fxn</span><span class="cls_007">), R</span><span class="cls_009">uby</span><span class="cls_007"> H</span><span class="cls_009">ero</span><span class="cls_007">, R</span><span class="cls_009">uby</span><span class="cls_007"> </span><span class="cls_009">on</span><span class="cls_007"> R</span><span class="cls_009">ails</span><span class="cls_007"> C</span><span class="cls_009">ore</span><span class="cls_007"> T</span><span class="cls_009">eam</span><span class="cls_007"> M</span><span class="cls_009">ember</span></div>
<div style="position:absolute;left:123.00px;top:297.97px" class="cls_007"><span class="cls_007">“Pat Shaughnessy did a tremendous job writing THE book about Ruby</span></div>
<div style="position:absolute;left:123.00px;top:309.97px" class="cls_007"><span class="cls_007">internals. Definitely a must read—you won’t find information like this</span></div>
<div style="position:absolute;left:123.00px;top:321.97px" class="cls_007"><span class="cls_007">anywhere else.”</span></div>
<div style="position:absolute;left:123.00px;top:333.97px" class="cls_007"><span class="cls_007">—S</span><span class="cls_009">antiago</span><span class="cls_007"> P</span><span class="cls_009">astorino</span><span class="cls_007"> (@</span><span class="cls_009">spastorino</span><span class="cls_007">), W</span><span class="cls_009">ye</span><span class="cls_007">W</span><span class="cls_009">orks</span><span class="cls_007"> C</span><span class="cls_009">o</span><span class="cls_007">-F</span><span class="cls_009">ounder</span><span class="cls_007">,</span></div>
<div style="position:absolute;left:123.00px;top:345.97px" class="cls_007"><span class="cls_007">R</span><span class="cls_009">uby</span><span class="cls_007"> </span><span class="cls_009">on</span><span class="cls_007"> R</span><span class="cls_009">ails</span><span class="cls_007"> C</span><span class="cls_009">ore</span><span class="cls_007"> T</span><span class="cls_009">eam</span><span class="cls_007"> M</span><span class="cls_009">ember</span></div>
<div style="position:absolute;left:123.00px;top:369.97px" class="cls_007"><span class="cls_007">“I really enjoyed the book and now have a far better understanding of both</span></div>
<div style="position:absolute;left:123.00px;top:381.97px" class="cls_007"><span class="cls_007">Ruby and CS. The writing made very complex topics (at least for me) very</span></div>
<div style="position:absolute;left:123.00px;top:393.97px" class="cls_007"><span class="cls_007">accessible, and I found the book hard to put down. Diagrams were awesome</span></div>
<div style="position:absolute;left:123.00px;top:405.97px" class="cls_007"><span class="cls_007">and are already popping in my head as I code. This is by far one of my top 3</span></div>
<div style="position:absolute;left:123.00px;top:417.97px" class="cls_007"><span class="cls_007">favourite Ruby books.”</span></div>
<div style="position:absolute;left:123.00px;top:429.97px" class="cls_007"><span class="cls_007">—V</span><span class="cls_009">lad</span><span class="cls_007"> I</span><span class="cls_009">vanovic</span><span class="cls_007"> (@</span><span class="cls_009">vladiim</span><span class="cls_007">), D</span><span class="cls_009">igital</span><span class="cls_007"> S</span><span class="cls_009">trategist</span><span class="cls_007"> </span><span class="cls_009">at</span><span class="cls_007"> H</span><span class="cls_009">oller</span><span class="cls_007"> S</span><span class="cls_009">ydney</span></div>
<div style="position:absolute;left:123.00px;top:453.97px" class="cls_007"><span class="cls_007">“While I’m not usually digging into Ruby Internals, this book was an</span></div>
<div style="position:absolute;left:123.00px;top:465.97px" class="cls_007"><span class="cls_007">absolutely awesome read.”</span></div>
<div style="position:absolute;left:123.00px;top:477.97px" class="cls_007"><span class="cls_007">—D</span><span class="cls_009">avid</span><span class="cls_007"> D</span><span class="cls_009">eryl</span><span class="cls_007"> D</span><span class="cls_009">owney</span><span class="cls_007"> (@</span><span class="cls_009">daviddwdowney</span><span class="cls_007">), F</span><span class="cls_009">ounder</span><span class="cls_007"> </span><span class="cls_009">of</span><span class="cls_007"> C</span><span class="cls_009">yber</span><span class="cls_007">S</span><span class="cls_009">pace</span></div>
<div style="position:absolute;left:123.00px;top:489.97px" class="cls_007"><span class="cls_007">T</span><span class="cls_009">echnologies</span><span class="cls_007"> G</span><span class="cls_009">roup</span></div>
<div style="position:absolute;left:123.00px;top:513.97px" class="cls_007"><span class="cls_007">“Nearly every Ruby expert will benefit from knowing so much about how</span></div>
<div style="position:absolute;left:123.00px;top:525.97px" class="cls_007"><span class="cls_007">the language and runtime operate.”</span></div>
<div style="position:absolute;left:123.00px;top:537.97px" class="cls_007"><span class="cls_007">—D</span><span class="cls_009">r</span><span class="cls_007">. D</span><span class="cls_009">obb</span><span class="cls_007">’</span><span class="cls_009">s</span></div>
<div style="position:absolute;left:123.00px;top:561.97px" class="cls_007"><span class="cls_007">“Ruby isn’t just a black box anymore, but rather a tool that I understand</span></div>
<div style="position:absolute;left:123.00px;top:573.97px" class="cls_007"><span class="cls_007">and feel good using.”</span></div>
<div style="position:absolute;left:123.00px;top:585.97px" class="cls_007"><span class="cls_007">—R</span><span class="cls_009">obert</span><span class="cls_007"> M</span><span class="cls_009">osolgo</span><span class="cls_007">, R</span><span class="cls_009">ails</span><span class="cls_007"> D</span><span class="cls_009">eveloper</span><span class="cls_007">, P</span><span class="cls_009">lanning</span><span class="cls_007"> C</span><span class="cls_009">enter</span><span class="cls_007"> O</span><span class="cls_009">nline</span></div>
</div>
<div style="position:absolute;left:50%;margin-left:-252px;top:1352px;width:504px;height:666px;border-style:outset;overflow:hidden">
<div style="position:absolute;left:0px;top:0px">
<img src="e698b76e-46bd-11eb-8b25-0cc47a792c0a_id_e698b76e-46bd-11eb-8b25-0cc47a792c0a_files/background003.jpg" width=504 height=666></div>
</div>
<div style="position:absolute;left:50%;margin-left:-252px;top:1352px;width:504px;height:666px;border-style:outset;overflow:hidden">
<div style="position:absolute;left:0px;top:0px">
<img src="e698b76e-46bd-11eb-8b25-0cc47a792c0a_id_e698b76e-46bd-11eb-8b25-0cc47a792c0a_files/background004.jpg" width=504 height=666></div>
<div style="position:absolute;left:54.00px;top:32.98px" class="cls_011"><span class="cls_011">Ruby Under a</span></div>
<div style="position:absolute;left:54.00px;top:107.95px" class="cls_011"><span class="cls_011">Microscope</span></div>
<div style="position:absolute;left:54.00px;top:219.02px" class="cls_012"><span class="cls_012">An Illustrated Guide</span></div>
<div style="position:absolute;left:54.00px;top:253.01px" class="cls_012"><span class="cls_012">to Ruby Internals</span></div>
<div style="position:absolute;left:54.00px;top:313.32px" class="cls_004"><span class="cls_004">Pat Shaughnessy</span></div>
</div>
<div style="position:absolute;left:50%;margin-left:-252px;top:2028px;width:504px;height:666px;border-style:outset;overflow:hidden">
<div style="position:absolute;left:0px;top:0px">
<img src="e698b76e-46bd-11eb-8b25-0cc47a792c0a_id_e698b76e-46bd-11eb-8b25-0cc47a792c0a_files/background005.jpg" width=504 height=666></div>
<div style="position:absolute;left:54.00px;top:34.42px" class="cls_013"><span class="cls_013">Ruby Under a Microscope.</span><span class="cls_014"> Copyright © 2014 by Patrick Shaughnessy.</span></div>
<div style="position:absolute;left:54.00px;top:56.42px" class="cls_014"><span class="cls_014">All rights reserved. No part of this work may be reproduced or transmitted in any form or by any means, elec-</span></div>
<div style="position:absolute;left:54.00px;top:66.42px" class="cls_014"><span class="cls_014">tronic or mechanical, including photocopying, recording, or by any information storage or retrieval system,</span></div>
<div style="position:absolute;left:54.00px;top:76.42px" class="cls_014"><span class="cls_014">without the prior written permission of the copyright owner and the publisher.</span></div>
<div style="position:absolute;left:54.00px;top:98.42px" class="cls_014"><span class="cls_014">Printed on demand in USA</span></div>
<div style="position:absolute;left:54.00px;top:114.42px" class="cls_014"><span class="cls_014">ISBN-10: 1-59327-527-7</span></div>
<div style="position:absolute;left:54.00px;top:124.42px" class="cls_014"><span class="cls_014">ISBN-13: 978-1-59327-527-3</span></div>
<div style="position:absolute;left:54.00px;top:146.42px" class="cls_014"><span class="cls_014">Publisher: William Pollock</span></div>
<div style="position:absolute;left:54.00px;top:156.42px" class="cls_014"><span class="cls_014">Production Editor: Riley Hoffman</span></div>
<div style="position:absolute;left:54.00px;top:166.42px" class="cls_014"><span class="cls_014">Cover Illustration: Charlie Wylie</span></div>
<div style="position:absolute;left:54.00px;top:176.42px" class="cls_014"><span class="cls_014">Interior Design: Octopod Studios</span></div>
<div style="position:absolute;left:54.00px;top:186.42px" class="cls_014"><span class="cls_014">Developmental Editor: William Pollock</span></div>
<div style="position:absolute;left:54.00px;top:196.42px" class="cls_014"><span class="cls_014">Technical Reviewer: Aaron Patterson</span></div>
<div style="position:absolute;left:54.00px;top:206.42px" class="cls_014"><span class="cls_014">Copyeditor: Julianne Jigour</span></div>
<div style="position:absolute;left:54.00px;top:216.42px" class="cls_014"><span class="cls_014">Compositors: Susan Glinert Stevens and Riley Hoffman</span></div>
<div style="position:absolute;left:54.00px;top:226.42px" class="cls_014"><span class="cls_014">Proofreader: Elaine Merrill</span></div>
<div style="position:absolute;left:54.00px;top:248.42px" class="cls_014"><span class="cls_014">For information on distribution, translations, or bulk sales, please contact No Starch Press, Inc. directly:</span></div>
<div style="position:absolute;left:54.00px;top:264.42px" class="cls_014"><span class="cls_014">No Starch Press, Inc.</span></div>
<div style="position:absolute;left:54.00px;top:274.42px" class="cls_014"><span class="cls_014">245 8th Street, San Francisco, CA 94103</span></div>
<div style="position:absolute;left:54.00px;top:284.42px" class="cls_014"><span class="cls_014">phone: 415.863.9900; info@nostarch.com</span></div>
<div style="position:absolute;left:54.00px;top:294.42px" class="cls_014"><span class="cls_014"> </span><A HREF="http://www.nostarch.com/">www.nostarch.com</A> </div>
<div style="position:absolute;left:54.00px;top:316.42px" class="cls_014"><span class="cls_014">Library of Congress Cataloging-in-Publication Data</span></div>
<div style="position:absolute;left:54.00px;top:331.82px" class="cls_015"><span class="cls_015">Shaughnessy, Pat.</span></div>
<div style="position:absolute;left:61.00px;top:340.22px" class="cls_015"><span class="cls_015">Ruby under a microscope : an illustrated guide to Ruby internals / by Pat Shaughnessy.</span></div>
<div style="position:absolute;left:78.50px;top:348.62px" class="cls_015"><span class="cls_015">pages cm</span></div>
<div style="position:absolute;left:61.00px;top:357.02px" class="cls_015"><span class="cls_015">Summary: "An under-the-hood look at how the Ruby programming language runs code. Extensively illustrated with</span></div>
<div style="position:absolute;left:54.00px;top:365.42px" class="cls_015"><span class="cls_015">complete explanations and hands-on experiments. Covers Ruby 2.x"-- Provided by publisher.</span></div>
<div style="position:absolute;left:68.00px;top:373.82px" class="cls_015"><span class="cls_015">ISBN 978-1-59327-527-3 (paperback) -- ISBN 1-59327-527-7 (paperback)</span></div>
<div style="position:absolute;left:57.50px;top:382.22px" class="cls_015"><span class="cls_015">1.  Ruby (Computer program language)  I. Title.</span></div>
<div style="position:absolute;left:61.00px;top:390.62px" class="cls_015"><span class="cls_015">QA76.73.R83S53 2013</span></div>
<div style="position:absolute;left:61.00px;top:399.02px" class="cls_015"><span class="cls_015">005.1'17--dc23</span></div>
<div style="position:absolute;left:264.00px;top:407.42px" class="cls_015"><span class="cls_015">2013030614</span></div>
<div style="position:absolute;left:54.00px;top:428.42px" class="cls_014"><span class="cls_014">No Starch Press and the No Starch Press logo are registered trademarks of No Starch Press, Inc. Other product</span></div>
<div style="position:absolute;left:54.00px;top:438.42px" class="cls_014"><span class="cls_014">and company names mentioned herein may be the trademarks of their respective owners. Rather than use a</span></div>
<div style="position:absolute;left:54.00px;top:448.42px" class="cls_014"><span class="cls_014">trademark symbol with every occurrence of a trademarked name, we are using the names only in an editorial</span></div>
<div style="position:absolute;left:54.00px;top:458.42px" class="cls_014"><span class="cls_014">fashion and to the benefit of the trademark owner, with no intention of infringement of the trademark.</span></div>
<div style="position:absolute;left:54.00px;top:474.42px" class="cls_014"><span class="cls_014">The information in this book is distributed on an “As Is” basis, without warranty. While every precaution has been</span></div>
<div style="position:absolute;left:54.00px;top:484.42px" class="cls_014"><span class="cls_014">taken in the preparation of this work, neither the author nor No Starch Press, Inc. shall have any liability to any</span></div>
<div style="position:absolute;left:54.00px;top:494.42px" class="cls_014"><span class="cls_014">person or entity with respect to any loss or damage caused or alleged to be caused directly or indirectly by the</span></div>
<div style="position:absolute;left:54.00px;top:504.42px" class="cls_014"><span class="cls_014">information contained in it.</span></div>
</div>
<div style="position:absolute;left:50%;margin-left:-252px;top:2704px;width:504px;height:666px;border-style:outset;overflow:hidden">
<div style="position:absolute;left:0px;top:0px">
<img src="e698b76e-46bd-11eb-8b25-0cc47a792c0a_id_e698b76e-46bd-11eb-8b25-0cc47a792c0a_files/background006.jpg" width=504 height=666></div>
<div style="position:absolute;left:121.34px;top:123.28px" class="cls_007"><span class="cls_007">To my wife, Cristina; my daughter, Ana; and my son, Liam—</span></div>
<div style="position:absolute;left:176.03px;top:135.28px" class="cls_007"><span class="cls_007">thanks for supporting me all along.</span></div>
</div>
<div style="position:absolute;left:50%;margin-left:-252px;top:3380px;width:504px;height:666px;border-style:outset;overflow:hidden">
<div style="position:absolute;left:0px;top:0px">
<img src="e698b76e-46bd-11eb-8b25-0cc47a792c0a_id_e698b76e-46bd-11eb-8b25-0cc47a792c0a_files/background007.jpg" width=504 height=666></div>
<div style="position:absolute;left:191.08px;top:123.38px" class="cls_016"><span class="cls_016">About the Author</span></div>
<div style="position:absolute;left:120.00px;top:237.38px" class="cls_007"><span class="cls_007">Pat Shaughnessy is a Ruby developer working at McKinsey & Co., a</span></div>
<div style="position:absolute;left:120.00px;top:249.38px" class="cls_007"><span class="cls_007">management consulting firm. Pat was originally trained as a physicist</span></div>
<div style="position:absolute;left:120.00px;top:261.38px" class="cls_007"><span class="cls_007">at MIT, but later spent more than 20 years working as a software developer</span></div>
<div style="position:absolute;left:120.00px;top:273.38px" class="cls_007"><span class="cls_007">using C, Java, PHP, and Ruby, among other languages. Writing </span><span class="cls_008">Ruby Under</span></div>
<div style="position:absolute;left:120.00px;top:285.38px" class="cls_008"><span class="cls_008">a Microscope</span><span class="cls_007"> has given him an excuse to reuse bits of his scientific training</span></div>
<div style="position:absolute;left:120.00px;top:297.38px" class="cls_007"><span class="cls_007">while studying Ruby. A fluent Spanish speaker, Pat frequently visits his wife’s</span></div>
<div style="position:absolute;left:120.00px;top:309.38px" class="cls_007"><span class="cls_007">family in northern Spain. He lives outside of Boston with his wife and two</span></div>
<div style="position:absolute;left:120.00px;top:321.38px" class="cls_007"><span class="cls_007">children.</span></div>
</div>
<div style="position:absolute;left:50%;margin-left:-252px;top:4056px;width:504px;height:666px;border-style:outset;overflow:hidden">
<div style="position:absolute;left:0px;top:0px">
<img src="e698b76e-46bd-11eb-8b25-0cc47a792c0a_id_e698b76e-46bd-11eb-8b25-0cc47a792c0a_files/background008.jpg" width=504 height=666></div>
<div style="position:absolute;left:169.24px;top:125.00px" class="cls_016"><span class="cls_016">Brief Contents</span></div>
<div style="position:absolute;left:49.54px;top:239.00px" class="cls_017"><span class="cls_017">Foreword by Aaron Patterson</span></div>
<div style="position:absolute;left:415.29px;top:239.00px" class="cls_017"><span class="cls_017">xv</span></div>
<div style="position:absolute;left:49.54px;top:259.00px" class="cls_017"><span class="cls_017">Foreword to the Japanese Edition by Yukihiro Matsumoto</span></div>
<div style="position:absolute;left:412.93px;top:259.00px" class="cls_017"><span class="cls_017">xvi</span></div>
<div style="position:absolute;left:49.54px;top:279.00px" class="cls_017"><span class="cls_017">Acknowledgments</span></div>
<div style="position:absolute;left:412.61px;top:279.00px" class="cls_017"><span class="cls_017">xix</span></div>
<div style="position:absolute;left:49.54px;top:298.99px" class="cls_017"><span class="cls_017">Introduction</span></div>
<div style="position:absolute;left:412.61px;top:298.99px" class="cls_017"><span class="cls_017">xxi</span></div>
<div style="position:absolute;left:49.54px;top:318.99px" class="cls_017"><span class="cls_017">Chapter 1: Tokenization and Parsing</span></div>
<div style="position:absolute;left:418.39px;top:318.99px" class="cls_017"><span class="cls_017">3</span></div>
<div style="position:absolute;left:49.54px;top:338.99px" class="cls_017"><span class="cls_017">Chapter 2: Compilation</span></div>
<div style="position:absolute;left:412.85px;top:338.99px" class="cls_017"><span class="cls_017">31</span></div>
<div style="position:absolute;left:49.54px;top:358.99px" class="cls_017"><span class="cls_017">Chapter 3: How Ruby Executes Your Code</span></div>
<div style="position:absolute;left:412.85px;top:358.99px" class="cls_017"><span class="cls_017">55</span></div>
<div style="position:absolute;left:49.54px;top:378.99px" class="cls_017"><span class="cls_017">Chapter 4: Control Structures and Method Dispatch</span></div>
<div style="position:absolute;left:412.85px;top:378.99px" class="cls_017"><span class="cls_017">83</span></div>
<div style="position:absolute;left:49.54px;top:398.98px" class="cls_017"><span class="cls_017">Chapter 5: Objects and Classes</span></div>
<div style="position:absolute;left:407.30px;top:398.98px" class="cls_017"><span class="cls_017">105</span></div>
<div style="position:absolute;left:49.54px;top:418.98px" class="cls_017"><span class="cls_017">Chapter 6: Method Lookup and Constant Lookup</span></div>
<div style="position:absolute;left:407.30px;top:418.98px" class="cls_017"><span class="cls_017">133</span></div>
<div style="position:absolute;left:49.54px;top:438.98px" class="cls_017"><span class="cls_017">Chapter 7: The Hash Table: The Workhorse of Ruby Internals</span></div>
<div style="position:absolute;left:407.30px;top:438.98px" class="cls_017"><span class="cls_017">167</span></div>
<div style="position:absolute;left:49.54px;top:458.98px" class="cls_017"><span class="cls_017">Chapter 8: How Ruby Borrowed a Decades-Old Idea from Lisp</span></div>
<div style="position:absolute;left:407.30px;top:458.98px" class="cls_017"><span class="cls_017">191</span></div>
<div style="position:absolute;left:49.54px;top:478.98px" class="cls_017"><span class="cls_017">Chapter 9: Metaprogramming</span></div>
<div style="position:absolute;left:407.30px;top:478.98px" class="cls_017"><span class="cls_017">219</span></div>
<div style="position:absolute;left:49.54px;top:498.97px" class="cls_017"><span class="cls_017">Chapter 10: JRuby: Ruby on the JVM</span></div>
<div style="position:absolute;left:407.30px;top:498.97px" class="cls_017"><span class="cls_017">251</span></div>
<div style="position:absolute;left:49.54px;top:518.97px" class="cls_017"><span class="cls_017">Chapter 11: Rubinius: Ruby Implemented with Ruby</span></div>
<div style="position:absolute;left:407.30px;top:518.97px" class="cls_017"><span class="cls_017">273</span></div>
<div style="position:absolute;left:49.54px;top:538.97px" class="cls_017"><span class="cls_017">Chapter 12: Garbage Collection in MRI, JRuby, and Rubinius</span></div>
<div style="position:absolute;left:407.30px;top:538.97px" class="cls_017"><span class="cls_017">295</span></div>
<div style="position:absolute;left:49.54px;top:558.97px" class="cls_017"><span class="cls_017">Appendix: Yet More Ruby Virtual Machines by Koichi Sasada</span></div>
<div style="position:absolute;left:407.30px;top:558.97px" class="cls_017"><span class="cls_017">327</span></div>
<div style="position:absolute;left:49.54px;top:578.97px" class="cls_017"><span class="cls_017">Index</span></div>
<div style="position:absolute;left:407.30px;top:578.97px" class="cls_017"><span class="cls_017">331</span></div>
</div>
<div style="position:absolute;left:50%;margin-left:-252px;top:4732px;width:504px;height:666px;border-style:outset;overflow:hidden">
<div style="position:absolute;left:0px;top:0px">
<img src="e698b76e-46bd-11eb-8b25-0cc47a792c0a_id_e698b76e-46bd-11eb-8b25-0cc47a792c0a_files/background009.jpg" width=504 height=666></div>
<div style="position:absolute;left:151.21px;top:41.00px" class="cls_016"><span class="cls_016">Contents in Detail</span></div>
<div style="position:absolute;left:49.54px;top:92.00px" class="cls_018"><span class="cls_018">Foreword by Aaron Patterson</span></div>
<div style="position:absolute;left:396.09px;top:92.00px" class="cls_018"><span class="cls_018">xv</span></div>
<div style="position:absolute;left:49.54px;top:122.00px" class="cls_018"><span class="cls_018">Foreword to the Japanese Edition by Yukihiro Matsumoto</span></div>
<div style="position:absolute;left:392.97px;top:122.00px" class="cls_018"><span class="cls_018">xvi</span></div>
<div style="position:absolute;left:49.54px;top:152.00px" class="cls_018"><span class="cls_018">Acknowledgments</span></div>
<div style="position:absolute;left:392.08px;top:152.00px" class="cls_018"><span class="cls_018">xix</span></div>
<div style="position:absolute;left:49.54px;top:182.00px" class="cls_018"><span class="cls_018">Introduction</span></div>
<div style="position:absolute;left:392.08px;top:182.00px" class="cls_018"><span class="cls_018">xxi</span></div>
<div style="position:absolute;left:49.54px;top:197.00px" class="cls_017"><span class="cls_017">Who This Book Is For</span></div>
<div style="position:absolute;left:395.86px;top:197.00px" class="cls_017"><span class="cls_017">xxii</span></div>
<div style="position:absolute;left:49.54px;top:208.00px" class="cls_017"><span class="cls_017">Using Ruby to Test Itself</span></div>
<div style="position:absolute;left:395.86px;top:208.00px" class="cls_017"><span class="cls_017">xxii</span></div>
<div style="position:absolute;left:49.54px;top:219.00px" class="cls_017"><span class="cls_017">Which Implementation of Ruby?</span></div>
<div style="position:absolute;left:393.50px;top:219.00px" class="cls_017"><span class="cls_017">xxiii</span></div>
<div style="position:absolute;left:49.54px;top:229.99px" class="cls_017"><span class="cls_017">Overview</span></div>
<div style="position:absolute;left:393.50px;top:229.99px" class="cls_017"><span class="cls_017">xxiii</span></div>
<div style="position:absolute;left:49.54px;top:256.00px" class="cls_018"><span class="cls_018">1</span></div>
<div style="position:absolute;left:49.54px;top:268.00px" class="cls_018"><span class="cls_018">Tokenization and Parsing</span></div>
<div style="position:absolute;left:402.68px;top:268.00px" class="cls_018"><span class="cls_018">3</span></div>
<div style="position:absolute;left:49.54px;top:283.00px" class="cls_017"><span class="cls_017">Tokens: The Words That Make Up the Ruby Language</span></div>
<div style="position:absolute;left:403.99px;top:283.00px" class="cls_017"><span class="cls_017">4</span></div>
<div style="position:absolute;left:85.54px;top:294.00px" class="cls_017"><span class="cls_017">The parser_yylex Function</span></div>
<div style="position:absolute;left:403.99px;top:294.00px" class="cls_017"><span class="cls_017">8</span></div>
<div style="position:absolute;left:49.54px;top:305.00px" class="cls_019"><span class="cls_019">Experiment 1-1: Using Ripper to Tokenize Different Ruby Scripts</span></div>
<div style="position:absolute;left:404.33px;top:305.00px" class="cls_019"><span class="cls_019">9</span></div>
<div style="position:absolute;left:49.54px;top:315.99px" class="cls_017"><span class="cls_017">Parsing: How Ruby Understands Your Code</span></div>
<div style="position:absolute;left:398.45px;top:315.99px" class="cls_017"><span class="cls_017">12</span></div>
<div style="position:absolute;left:85.54px;top:326.99px" class="cls_017"><span class="cls_017">Understanding the LALR Parse Algorithm</span></div>
<div style="position:absolute;left:398.45px;top:326.99px" class="cls_017"><span class="cls_017">13</span></div>
<div style="position:absolute;left:85.54px;top:337.99px" class="cls_017"><span class="cls_017">Some Actual Ruby Grammar Rules</span></div>
<div style="position:absolute;left:398.45px;top:337.99px" class="cls_017"><span class="cls_017">20</span></div>
<div style="position:absolute;left:85.54px;top:348.99px" class="cls_017"><span class="cls_017">Reading a Bison Grammar Rule</span></div>
<div style="position:absolute;left:398.45px;top:348.99px" class="cls_017"><span class="cls_017">22</span></div>
<div style="position:absolute;left:49.54px;top:359.99px" class="cls_019"><span class="cls_019">Experiment 1-2: Using Ripper to Parse Different Ruby Scripts</span></div>
<div style="position:absolute;left:399.13px;top:359.99px" class="cls_019"><span class="cls_019">23</span></div>
<div style="position:absolute;left:49.54px;top:370.98px" class="cls_017"><span class="cls_017">Summary</span></div>
<div style="position:absolute;left:398.45px;top:370.98px" class="cls_017"><span class="cls_017">29</span></div>
<div style="position:absolute;left:49.54px;top:397.00px" class="cls_018"><span class="cls_018">2</span></div>
<div style="position:absolute;left:49.54px;top:409.00px" class="cls_018"><span class="cls_018">Compilation</span></div>
<div style="position:absolute;left:395.72px;top:409.00px" class="cls_018"><span class="cls_018">31</span></div>
<div style="position:absolute;left:49.54px;top:424.00px" class="cls_017"><span class="cls_017">No Compiler for Ruby 1.8</span></div>
<div style="position:absolute;left:398.45px;top:424.00px" class="cls_017"><span class="cls_017">32</span></div>
<div style="position:absolute;left:49.54px;top:435.00px" class="cls_017"><span class="cls_017">Ruby 1.9 and 2.0 Introduce a Compiler</span></div>
<div style="position:absolute;left:398.45px;top:435.00px" class="cls_017"><span class="cls_017">33</span></div>
<div style="position:absolute;left:49.54px;top:446.00px" class="cls_017"><span class="cls_017">How Ruby Compiles a Simple Script</span></div>
<div style="position:absolute;left:398.45px;top:446.00px" class="cls_017"><span class="cls_017">34</span></div>
<div style="position:absolute;left:49.54px;top:456.99px" class="cls_017"><span class="cls_017">Compiling a Call to a Block</span></div>
<div style="position:absolute;left:398.45px;top:456.99px" class="cls_017"><span class="cls_017">38</span></div>
<div style="position:absolute;left:85.54px;top:467.99px" class="cls_017"><span class="cls_017">How Ruby Iterates Through the AST</span></div>
<div style="position:absolute;left:398.45px;top:467.99px" class="cls_017"><span class="cls_017">42</span></div>
<div style="position:absolute;left:49.54px;top:478.99px" class="cls_019"><span class="cls_019">Experiment 2-1: Displaying YARV Instructions</span></div>
<div style="position:absolute;left:399.13px;top:478.99px" class="cls_019"><span class="cls_019">44</span></div>
<div style="position:absolute;left:49.54px;top:489.99px" class="cls_017"><span class="cls_017">The Local Table</span></div>
<div style="position:absolute;left:398.45px;top:489.99px" class="cls_017"><span class="cls_017">46</span></div>
<div style="position:absolute;left:85.54px;top:500.99px" class="cls_017"><span class="cls_017">Compiling Optional Arguments</span></div>
<div style="position:absolute;left:398.45px;top:500.99px" class="cls_017"><span class="cls_017">48</span></div>
<div style="position:absolute;left:85.54px;top:511.98px" class="cls_017"><span class="cls_017">Compiling Keyword Arguments</span></div>
<div style="position:absolute;left:398.45px;top:511.98px" class="cls_017"><span class="cls_017">49</span></div>
<div style="position:absolute;left:49.54px;top:522.98px" class="cls_019"><span class="cls_019">Experiment 2-2: Displaying the Local Table</span></div>
<div style="position:absolute;left:399.13px;top:522.98px" class="cls_019"><span class="cls_019">51</span></div>
<div style="position:absolute;left:49.54px;top:533.98px" class="cls_017"><span class="cls_017">Summary</span></div>
<div style="position:absolute;left:398.45px;top:533.98px" class="cls_017"><span class="cls_017">53</span></div>
</div>
<div style="position:absolute;left:50%;margin-left:-252px;top:5408px;width:504px;height:666px;border-style:outset;overflow:hidden">
<div style="position:absolute;left:0px;top:0px">
<img src="e698b76e-46bd-11eb-8b25-0cc47a792c0a_id_e698b76e-46bd-11eb-8b25-0cc47a792c0a_files/background010.jpg" width=504 height=666></div>
<div style="position:absolute;left:49.50px;top:43.22px" class="cls_018"><span class="cls_018">3</span></div>
<div style="position:absolute;left:49.50px;top:55.22px" class="cls_018"><span class="cls_018">How Ruby Executes Your Code</span></div>
<div style="position:absolute;left:395.62px;top:55.22px" class="cls_018"><span class="cls_018">55</span></div>
<div style="position:absolute;left:49.50px;top:70.22px" class="cls_017"><span class="cls_017">YARV’s Internal Stack and Your Ruby Stack</span></div>
<div style="position:absolute;left:398.41px;top:70.22px" class="cls_017"><span class="cls_017">56</span></div>
<div style="position:absolute;left:85.50px;top:81.22px" class="cls_017"><span class="cls_017">Stepping Through How Ruby Executes a Simple Script</span></div>
<div style="position:absolute;left:398.41px;top:81.22px" class="cls_017"><span class="cls_017">58</span></div>
<div style="position:absolute;left:85.50px;top:92.22px" class="cls_017"><span class="cls_017">Executing a Call to a Block</span></div>
<div style="position:absolute;left:398.41px;top:92.22px" class="cls_017"><span class="cls_017">61</span></div>
<div style="position:absolute;left:85.50px;top:103.21px" class="cls_017"><span class="cls_017">Taking a Close Look at a YARV Instruction</span></div>
<div style="position:absolute;left:398.41px;top:103.21px" class="cls_017"><span class="cls_017">63</span></div>
<div style="position:absolute;left:49.50px;top:114.21px" class="cls_019"><span class="cls_019">Experiment 3-1: Benchmarking Ruby 2.0 and Ruby 1.9 vs. Ruby 1.8</span></div>
<div style="position:absolute;left:399.10px;top:114.21px" class="cls_019"><span class="cls_019">65</span></div>
<div style="position:absolute;left:49.50px;top:125.21px" class="cls_017"><span class="cls_017">Local and Dynamic Access of Ruby Variables</span></div>
<div style="position:absolute;left:398.41px;top:125.21px" class="cls_017"><span class="cls_017">67</span></div>
<div style="position:absolute;left:85.50px;top:136.21px" class="cls_017"><span class="cls_017">Local Variable Access</span></div>
<div style="position:absolute;left:398.41px;top:136.21px" class="cls_017"><span class="cls_017">67</span></div>
<div style="position:absolute;left:85.50px;top:147.21px" class="cls_017"><span class="cls_017">Method Arguments Are Treated Like Local Variables</span></div>
<div style="position:absolute;left:398.41px;top:147.21px" class="cls_017"><span class="cls_017">70</span></div>
<div style="position:absolute;left:85.50px;top:158.20px" class="cls_017"><span class="cls_017">Dynamic Variable Access</span></div>
<div style="position:absolute;left:398.41px;top:158.20px" class="cls_017"><span class="cls_017">71</span></div>
<div style="position:absolute;left:85.50px;top:169.20px" class="cls_017"><span class="cls_017">Climbing the Environment Pointer Ladder in C</span></div>
<div style="position:absolute;left:398.41px;top:169.20px" class="cls_017"><span class="cls_017">74</span></div>
<div style="position:absolute;left:49.50px;top:180.20px" class="cls_019"><span class="cls_019">Experiment 3-2: Exploring Special Variables</span></div>
<div style="position:absolute;left:399.10px;top:180.20px" class="cls_019"><span class="cls_019">75</span></div>
<div style="position:absolute;left:85.50px;top:191.20px" class="cls_017"><span class="cls_017">A Definitive List of Special Variables</span></div>
<div style="position:absolute;left:398.41px;top:191.20px" class="cls_017"><span class="cls_017">79</span></div>
<div style="position:absolute;left:49.50px;top:202.20px" class="cls_017"><span class="cls_017">Summary</span></div>
<div style="position:absolute;left:398.41px;top:202.20px" class="cls_017"><span class="cls_017">81</span></div>
<div style="position:absolute;left:49.50px;top:228.22px" class="cls_018"><span class="cls_018">4</span></div>
<div style="position:absolute;left:49.50px;top:240.22px" class="cls_018"><span class="cls_018">Control Structures and Method Dispatch</span></div>
<div style="position:absolute;left:395.68px;top:240.22px" class="cls_018"><span class="cls_018">83</span></div>
<div style="position:absolute;left:49.50px;top:255.22px" class="cls_017"><span class="cls_017">How Ruby Executes an if Statement</span></div>
<div style="position:absolute;left:398.41px;top:255.22px" class="cls_017"><span class="cls_017">84</span></div>
<div style="position:absolute;left:49.50px;top:266.22px" class="cls_017"><span class="cls_017">Jumping from One Scope to Another</span></div>
<div style="position:absolute;left:398.41px;top:266.22px" class="cls_017"><span class="cls_017">86</span></div>
<div style="position:absolute;left:85.50px;top:277.22px" class="cls_017"><span class="cls_017">Catch Tables</span></div>
<div style="position:absolute;left:398.41px;top:277.22px" class="cls_017"><span class="cls_017">88</span></div>
<div style="position:absolute;left:85.50px;top:288.21px" class="cls_017"><span class="cls_017">Other Uses for Catch Tables</span></div>
<div style="position:absolute;left:398.41px;top:288.21px" class="cls_017"><span class="cls_017">90</span></div>
<div style="position:absolute;left:49.50px;top:299.21px" class="cls_019"><span class="cls_019">Experiment 4-1: Testing How Ruby Implements for Loops Internally</span></div>
<div style="position:absolute;left:399.10px;top:299.21px" class="cls_019"><span class="cls_019">90</span></div>
<div style="position:absolute;left:49.50px;top:310.21px" class="cls_017"><span class="cls_017">The send Instruction: Ruby’s Most Complex Control Structure</span></div>
<div style="position:absolute;left:398.41px;top:310.21px" class="cls_017"><span class="cls_017">92</span></div>
<div style="position:absolute;left:85.50px;top:321.21px" class="cls_017"><span class="cls_017">Method Lookup and Method Dispatch</span></div>
<div style="position:absolute;left:398.41px;top:321.21px" class="cls_017"><span class="cls_017">92</span></div>
<div style="position:absolute;left:85.50px;top:332.21px" class="cls_017"><span class="cls_017">Eleven Types of Ruby Methods</span></div>
<div style="position:absolute;left:398.41px;top:332.21px" class="cls_017"><span class="cls_017">93</span></div>
<div style="position:absolute;left:49.50px;top:343.20px" class="cls_017"><span class="cls_017">Calling Normal Ruby Methods</span></div>
<div style="position:absolute;left:398.41px;top:343.20px" class="cls_017"><span class="cls_017">95</span></div>
<div style="position:absolute;left:85.50px;top:354.20px" class="cls_017"><span class="cls_017">Preparing Arguments for Normal Ruby Methods</span></div>
<div style="position:absolute;left:398.41px;top:354.20px" class="cls_017"><span class="cls_017">95</span></div>
<div style="position:absolute;left:49.50px;top:365.20px" class="cls_017"><span class="cls_017">Calling Built-In Ruby Methods</span></div>
<div style="position:absolute;left:398.41px;top:365.20px" class="cls_017"><span class="cls_017">97</span></div>
<div style="position:absolute;left:85.50px;top:376.20px" class="cls_017"><span class="cls_017">Calling attr_reader and attr_writer</span></div>
<div style="position:absolute;left:398.41px;top:376.20px" class="cls_017"><span class="cls_017">97</span></div>
<div style="position:absolute;left:85.50px;top:387.20px" class="cls_017"><span class="cls_017">Method Dispatch Optimizes attr_reader and attr_writer</span></div>
<div style="position:absolute;left:398.41px;top:387.20px" class="cls_017"><span class="cls_017">98</span></div>
<div style="position:absolute;left:49.50px;top:398.19px" class="cls_019"><span class="cls_019">Experiment 4-2: Exploring How Ruby Implements Keyword Arguments</span></div>
<div style="position:absolute;left:399.10px;top:398.19px" class="cls_019"><span class="cls_019">99</span></div>
<div style="position:absolute;left:49.50px;top:409.19px" class="cls_017"><span class="cls_017">Summary</span></div>
<div style="position:absolute;left:392.87px;top:409.19px" class="cls_017"><span class="cls_017">103</span></div>
<div style="position:absolute;left:49.50px;top:435.22px" class="cls_018"><span class="cls_018">5</span></div>
<div style="position:absolute;left:49.50px;top:447.22px" class="cls_018"><span class="cls_018">Objects and Classes</span></div>
<div style="position:absolute;left:388.69px;top:447.22px" class="cls_018"><span class="cls_018">105</span></div>
<div style="position:absolute;left:49.50px;top:462.22px" class="cls_017"><span class="cls_017">Inside a Ruby Object</span></div>
<div style="position:absolute;left:392.87px;top:462.22px" class="cls_017"><span class="cls_017">106</span></div>
<div style="position:absolute;left:85.50px;top:473.22px" class="cls_017"><span class="cls_017">Inspecting klass and ivptr</span></div>
<div style="position:absolute;left:392.87px;top:473.22px" class="cls_017"><span class="cls_017">107</span></div>
<div style="position:absolute;left:85.50px;top:484.22px" class="cls_017"><span class="cls_017">Visualizing Two Instances of One Class</span></div>
<div style="position:absolute;left:392.87px;top:484.22px" class="cls_017"><span class="cls_017">108</span></div>
<div style="position:absolute;left:85.50px;top:495.21px" class="cls_017"><span class="cls_017">Generic Objects</span></div>
<div style="position:absolute;left:392.87px;top:495.21px" class="cls_017"><span class="cls_017">109</span></div>
<div style="position:absolute;left:85.50px;top:506.21px" class="cls_017"><span class="cls_017">Simple Ruby Values Don’t Require a Structure at All</span></div>
<div style="position:absolute;left:392.87px;top:506.21px" class="cls_017"><span class="cls_017">110</span></div>
<div style="position:absolute;left:85.50px;top:517.21px" class="cls_017"><span class="cls_017">Do Generic Objects Have Instance Variables?</span></div>
<div style="position:absolute;left:392.87px;top:517.21px" class="cls_017"><span class="cls_017">111</span></div>
<div style="position:absolute;left:85.50px;top:528.21px" class="cls_017"><span class="cls_017">Reading the RBasic and RObject C Structure Definitions</span></div>
<div style="position:absolute;left:392.87px;top:528.21px" class="cls_017"><span class="cls_017">112</span></div>
<div style="position:absolute;left:85.50px;top:539.21px" class="cls_017"><span class="cls_017">Where Does Ruby Save Instance Variables for Generic Objects?</span></div>
<div style="position:absolute;left:392.87px;top:539.21px" class="cls_017"><span class="cls_017">113</span></div>
<div style="position:absolute;left:49.50px;top:550.20px" class="cls_019"><span class="cls_019">Experiment 5-1: How Long Does It Take to Save a New Instance Variable?</span></div>
<div style="position:absolute;left:393.89px;top:550.20px" class="cls_019"><span class="cls_019">113</span></div>
<div style="position:absolute;left:49.50px;top:561.20px" class="cls_017"><span class="cls_017">What’s Inside the RClass Structure?</span></div>
<div style="position:absolute;left:392.87px;top:561.20px" class="cls_017"><span class="cls_017">115</span></div>
<div style="position:absolute;left:85.50px;top:572.20px" class="cls_017"><span class="cls_017">Inheritance</span></div>
<div style="position:absolute;left:392.87px;top:572.20px" class="cls_017"><span class="cls_017">118</span></div>
<div style="position:absolute;left:85.50px;top:583.20px" class="cls_017"><span class="cls_017">Class Instance Variables vs. Class Variables</span></div>
<div style="position:absolute;left:392.87px;top:583.20px" class="cls_017"><span class="cls_017">120</span></div>
<div style="position:absolute;left:85.50px;top:594.20px" class="cls_017"><span class="cls_017">Getting and Setting Class Variables</span></div>
<div style="position:absolute;left:392.87px;top:594.20px" class="cls_017"><span class="cls_017">122</span></div>
<div style="position:absolute;left:49.50px;top:633.00px" class="cls_020"><span class="cls_020">x</span><span class="cls_021">   Contents in Detail</span></div>
</div>
<div style="position:absolute;left:50%;margin-left:-252px;top:6084px;width:504px;height:666px;border-style:outset;overflow:hidden">
<div style="position:absolute;left:0px;top:0px">
<img src="e698b76e-46bd-11eb-8b25-0cc47a792c0a_id_e698b76e-46bd-11eb-8b25-0cc47a792c0a_files/background011.jpg" width=504 height=666></div>
<div style="position:absolute;left:85.50px;top:42.99px" class="cls_017"><span class="cls_017">Constants</span></div>
<div style="position:absolute;left:392.87px;top:42.99px" class="cls_017"><span class="cls_017">124</span></div>
<div style="position:absolute;left:85.50px;top:53.99px" class="cls_017"><span class="cls_017">The Actual RClass Structure</span></div>
<div style="position:absolute;left:392.87px;top:53.99px" class="cls_017"><span class="cls_017">125</span></div>
<div style="position:absolute;left:85.50px;top:64.98px" class="cls_017"><span class="cls_017">Reading the RClass C Structure Definition</span></div>
<div style="position:absolute;left:392.87px;top:64.98px" class="cls_017"><span class="cls_017">127</span></div>
<div style="position:absolute;left:49.50px;top:75.98px" class="cls_019"><span class="cls_019">Experiment 5-2: Where Does Ruby Save Class Methods?</span></div>
<div style="position:absolute;left:393.89px;top:75.98px" class="cls_019"><span class="cls_019">127</span></div>
<div style="position:absolute;left:49.50px;top:86.98px" class="cls_017"><span class="cls_017">Summary</span></div>
<div style="position:absolute;left:392.87px;top:86.98px" class="cls_017"><span class="cls_017">131</span></div>
<div style="position:absolute;left:49.50px;top:112.99px" class="cls_018"><span class="cls_018">6</span></div>
<div style="position:absolute;left:49.50px;top:124.99px" class="cls_018"><span class="cls_018">Method Lookup and Constant Lookup</span></div>
<div style="position:absolute;left:388.72px;top:124.99px" class="cls_018"><span class="cls_018">133</span></div>
<div style="position:absolute;left:49.50px;top:139.99px" class="cls_017"><span class="cls_017">How Ruby Implements Modules</span></div>
<div style="position:absolute;left:392.87px;top:139.99px" class="cls_017"><span class="cls_017">135</span></div>
<div style="position:absolute;left:85.50px;top:150.98px" class="cls_017"><span class="cls_017">Modules Are Classes</span></div>
<div style="position:absolute;left:392.87px;top:150.98px" class="cls_017"><span class="cls_017">135</span></div>
<div style="position:absolute;left:85.50px;top:161.98px" class="cls_017"><span class="cls_017">Including a Module into a Class</span></div>
<div style="position:absolute;left:392.87px;top:161.98px" class="cls_017"><span class="cls_017">136</span></div>
<div style="position:absolute;left:49.50px;top:172.98px" class="cls_017"><span class="cls_017">Ruby’s Method Lookup Algorithm</span></div>
<div style="position:absolute;left:392.87px;top:172.98px" class="cls_017"><span class="cls_017">138</span></div>
<div style="position:absolute;left:85.50px;top:183.98px" class="cls_017"><span class="cls_017">A Method Lookup Example</span></div>
<div style="position:absolute;left:392.87px;top:183.98px" class="cls_017"><span class="cls_017">139</span></div>
<div style="position:absolute;left:85.50px;top:194.98px" class="cls_017"><span class="cls_017">The Method Lookup Algorithm in Action</span></div>
<div style="position:absolute;left:392.87px;top:194.98px" class="cls_017"><span class="cls_017">140</span></div>
<div style="position:absolute;left:85.50px;top:205.97px" class="cls_017"><span class="cls_017">Multiple Inheritance in Ruby</span></div>
<div style="position:absolute;left:392.87px;top:205.97px" class="cls_017"><span class="cls_017">141</span></div>
<div style="position:absolute;left:85.50px;top:216.97px" class="cls_017"><span class="cls_017">The Global Method Cache</span></div>
<div style="position:absolute;left:392.87px;top:216.97px" class="cls_017"><span class="cls_017">142</span></div>
<div style="position:absolute;left:85.50px;top:227.97px" class="cls_017"><span class="cls_017">The Inline Method Cache</span></div>
<div style="position:absolute;left:392.87px;top:227.97px" class="cls_017"><span class="cls_017">143</span></div>
<div style="position:absolute;left:85.50px;top:238.97px" class="cls_017"><span class="cls_017">Clearing Ruby’s Method Caches</span></div>
<div style="position:absolute;left:392.87px;top:238.97px" class="cls_017"><span class="cls_017">143</span></div>
<div style="position:absolute;left:85.50px;top:249.97px" class="cls_017"><span class="cls_017">Including Two Modules into One Class</span></div>
<div style="position:absolute;left:392.87px;top:249.97px" class="cls_017"><span class="cls_017">144</span></div>
<div style="position:absolute;left:85.50px;top:260.96px" class="cls_017"><span class="cls_017">Including One Module into Another</span></div>
<div style="position:absolute;left:392.87px;top:260.96px" class="cls_017"><span class="cls_017">145</span></div>
<div style="position:absolute;left:85.50px;top:271.96px" class="cls_017"><span class="cls_017">A Module#prepend Example</span></div>
<div style="position:absolute;left:392.87px;top:271.96px" class="cls_017"><span class="cls_017">146</span></div>
<div style="position:absolute;left:85.50px;top:282.96px" class="cls_017"><span class="cls_017">How Ruby Implements Module#prepend</span></div>
<div style="position:absolute;left:392.87px;top:282.96px" class="cls_017"><span class="cls_017">150</span></div>
<div style="position:absolute;left:49.50px;top:293.96px" class="cls_019"><span class="cls_019">Experiment 6-1: Modifying a Module After Including It</span></div>
<div style="position:absolute;left:393.89px;top:293.96px" class="cls_019"><span class="cls_019">151</span></div>
<div style="position:absolute;left:85.50px;top:304.96px" class="cls_017"><span class="cls_017">Classes See Methods Added to a Module Later</span></div>
<div style="position:absolute;left:392.87px;top:304.96px" class="cls_017"><span class="cls_017">152</span></div>
<div style="position:absolute;left:85.50px;top:315.95px" class="cls_017"><span class="cls_017">Classes Don’t See Submodules Included Later</span></div>
<div style="position:absolute;left:392.87px;top:315.95px" class="cls_017"><span class="cls_017">152</span></div>
<div style="position:absolute;left:85.50px;top:326.95px" class="cls_017"><span class="cls_017">Included Classes Share the Method Table with the Original Module</span></div>
<div style="position:absolute;left:392.87px;top:326.95px" class="cls_017"><span class="cls_017">153</span></div>
<div style="position:absolute;left:85.50px;top:337.95px" class="cls_017"><span class="cls_017">A Close Look at How Ruby Copies Modules</span></div>
<div style="position:absolute;left:392.87px;top:337.95px" class="cls_017"><span class="cls_017">154</span></div>
<div style="position:absolute;left:49.50px;top:348.95px" class="cls_017"><span class="cls_017">Constant Lookup</span></div>
<div style="position:absolute;left:392.87px;top:348.95px" class="cls_017"><span class="cls_017">155</span></div>
<div style="position:absolute;left:85.50px;top:359.95px" class="cls_017"><span class="cls_017">Finding a Constant in a Superclass</span></div>
<div style="position:absolute;left:392.87px;top:359.95px" class="cls_017"><span class="cls_017">156</span></div>
<div style="position:absolute;left:85.50px;top:370.94px" class="cls_017"><span class="cls_017">How Does Ruby Find a Constant in the Parent Namespace?</span></div>
<div style="position:absolute;left:392.87px;top:370.94px" class="cls_017"><span class="cls_017">157</span></div>
<div style="position:absolute;left:49.50px;top:381.94px" class="cls_017"><span class="cls_017">Lexical Scope in Ruby</span></div>
<div style="position:absolute;left:392.87px;top:381.94px" class="cls_017"><span class="cls_017">158</span></div>
<div style="position:absolute;left:85.50px;top:392.94px" class="cls_017"><span class="cls_017">Creating a Constant for a New Class or Module</span></div>
<div style="position:absolute;left:392.87px;top:392.94px" class="cls_017"><span class="cls_017">159</span></div>
<div style="position:absolute;left:85.50px;top:403.94px" class="cls_017"><span class="cls_017">Finding a Constant in the Parent Namespace Using Lexical Scope</span></div>
<div style="position:absolute;left:392.87px;top:403.94px" class="cls_017"><span class="cls_017">160</span></div>
<div style="position:absolute;left:85.50px;top:414.94px" class="cls_017"><span class="cls_017">Ruby’s Constant Lookup Algorithm</span></div>
<div style="position:absolute;left:392.87px;top:414.94px" class="cls_017"><span class="cls_017">162</span></div>
<div style="position:absolute;left:49.50px;top:425.93px" class="cls_019"><span class="cls_019">Experiment 6-2: Which Constant Will Ruby Find First?</span></div>
<div style="position:absolute;left:393.89px;top:425.93px" class="cls_019"><span class="cls_019">162</span></div>
<div style="position:absolute;left:85.50px;top:436.93px" class="cls_017"><span class="cls_017">Ruby’s Actual Constant Lookup Algorithm</span></div>
<div style="position:absolute;left:392.87px;top:436.93px" class="cls_017"><span class="cls_017">163</span></div>
<div style="position:absolute;left:49.50px;top:447.93px" class="cls_017"><span class="cls_017">Summary</span></div>
<div style="position:absolute;left:392.87px;top:447.93px" class="cls_017"><span class="cls_017">165</span></div>
<div style="position:absolute;left:49.50px;top:473.99px" class="cls_018"><span class="cls_018">7</span></div>
<div style="position:absolute;left:49.50px;top:485.99px" class="cls_018"><span class="cls_018">The Hash Table: The Workhorse of Ruby Internals</span></div>
<div style="position:absolute;left:388.72px;top:485.99px" class="cls_018"><span class="cls_018">167</span></div>
<div style="position:absolute;left:49.50px;top:500.99px" class="cls_017"><span class="cls_017">Hash Tables in Ruby</span></div>
<div style="position:absolute;left:392.87px;top:500.99px" class="cls_017"><span class="cls_017">169</span></div>
<div style="position:absolute;left:85.50px;top:511.98px" class="cls_017"><span class="cls_017">Saving a Value in a Hash Table</span></div>
<div style="position:absolute;left:392.87px;top:511.98px" class="cls_017"><span class="cls_017">169</span></div>
<div style="position:absolute;left:85.50px;top:522.98px" class="cls_017"><span class="cls_017">Retrieving a Value from a Hash Table</span></div>
<div style="position:absolute;left:392.87px;top:522.98px" class="cls_017"><span class="cls_017">171</span></div>
<div style="position:absolute;left:49.50px;top:533.98px" class="cls_019"><span class="cls_019">Experiment 7-1: Retrieving a Value from Hashes of Varying Sizes</span></div>
<div style="position:absolute;left:393.89px;top:533.98px" class="cls_019"><span class="cls_019">172</span></div>
<div style="position:absolute;left:49.50px;top:544.98px" class="cls_017"><span class="cls_017">How Hash Tables Expand to Accommodate More Values</span></div>
<div style="position:absolute;left:392.87px;top:544.98px" class="cls_017"><span class="cls_017">174</span></div>
<div style="position:absolute;left:85.50px;top:555.98px" class="cls_017"><span class="cls_017">Hash Collisions</span></div>
<div style="position:absolute;left:392.87px;top:555.98px" class="cls_017"><span class="cls_017">174</span></div>
<div style="position:absolute;left:85.50px;top:566.97px" class="cls_017"><span class="cls_017">Rehashing Entries</span></div>
<div style="position:absolute;left:392.87px;top:566.97px" class="cls_017"><span class="cls_017">175</span></div>
<div style="position:absolute;left:85.50px;top:577.97px" class="cls_017"><span class="cls_017">How Does Ruby Rehash Entries in a Hash Table?</span></div>
<div style="position:absolute;left:392.87px;top:577.97px" class="cls_017"><span class="cls_017">176</span></div>
<div style="position:absolute;left:49.50px;top:588.97px" class="cls_019"><span class="cls_019">Experiment 7-2: Inserting One New Element into Hashes of Varying Sizes</span></div>
<div style="position:absolute;left:393.89px;top:588.97px" class="cls_019"><span class="cls_019">177</span></div>
<div style="position:absolute;left:85.50px;top:599.97px" class="cls_017"><span class="cls_017">Where Do the Magic Numbers 57 and 67 Come From?</span></div>
<div style="position:absolute;left:392.87px;top:599.97px" class="cls_017"><span class="cls_017">180</span></div>
<div style="position:absolute;left:394.58px;top:636.00px" class="cls_021"><span class="cls_021">Contents in Detail</span></div>
<div style="position:absolute;left:447.91px;top:633.00px" class="cls_020"><span class="cls_020">xi</span></div>
</div>
<div style="position:absolute;left:50%;margin-left:-252px;top:6760px;width:504px;height:666px;border-style:outset;overflow:hidden">
<div style="position:absolute;left:0px;top:0px">
<img src="e698b76e-46bd-11eb-8b25-0cc47a792c0a_id_e698b76e-46bd-11eb-8b25-0cc47a792c0a_files/background012.jpg" width=504 height=666></div>
<div style="position:absolute;left:49.50px;top:43.25px" class="cls_017"><span class="cls_017">How Ruby Implements Hash Functions</span></div>
<div style="position:absolute;left:392.87px;top:43.25px" class="cls_017"><span class="cls_017">181</span></div>
<div style="position:absolute;left:49.50px;top:54.24px" class="cls_019"><span class="cls_019">Experiment 7-3: Using Objects as Keys in a Hash</span></div>
<div style="position:absolute;left:393.89px;top:54.24px" class="cls_019"><span class="cls_019">183</span></div>
<div style="position:absolute;left:85.50px;top:65.24px" class="cls_017"><span class="cls_017">Hash Optimization in Ruby 2.x</span></div>
<div style="position:absolute;left:392.87px;top:65.24px" class="cls_017"><span class="cls_017">187</span></div>
<div style="position:absolute;left:49.50px;top:76.24px" class="cls_017"><span class="cls_017">Summary</span></div>
<div style="position:absolute;left:392.87px;top:76.24px" class="cls_017"><span class="cls_017">189</span></div>
<div style="position:absolute;left:49.50px;top:102.25px" class="cls_018"><span class="cls_018">8</span></div>
<div style="position:absolute;left:49.50px;top:114.25px" class="cls_018"><span class="cls_018">How Ruby Borrowed a Decades-Old Idea from Lisp</span></div>
<div style="position:absolute;left:388.72px;top:114.25px" class="cls_018"><span class="cls_018">191</span></div>
<div style="position:absolute;left:49.50px;top:129.25px" class="cls_017"><span class="cls_017">Blocks: Closures in Ruby</span></div>
<div style="position:absolute;left:392.87px;top:129.25px" class="cls_017"><span class="cls_017">192</span></div>
<div style="position:absolute;left:85.50px;top:140.24px" class="cls_017"><span class="cls_017">Stepping Through How Ruby Calls a Block</span></div>
<div style="position:absolute;left:392.87px;top:140.24px" class="cls_017"><span class="cls_017">194</span></div>
<div style="position:absolute;left:85.50px;top:151.24px" class="cls_017"><span class="cls_017">Borrowing an Idea from 1975</span></div>
<div style="position:absolute;left:392.87px;top:151.24px" class="cls_017"><span class="cls_017">196</span></div>
<div style="position:absolute;left:85.50px;top:162.24px" class="cls_017"><span class="cls_017">The rb_block_t and rb_control_frame_t Structures</span></div>
<div style="position:absolute;left:392.87px;top:162.24px" class="cls_017"><span class="cls_017">198</span></div>
<div style="position:absolute;left:49.50px;top:173.24px" class="cls_019"><span class="cls_019">Experiment 8-1: Which Is Faster: A while Loop or Passing a Block to each?</span></div>
<div style="position:absolute;left:393.89px;top:173.24px" class="cls_019"><span class="cls_019">200</span></div>
<div style="position:absolute;left:49.50px;top:184.24px" class="cls_017"><span class="cls_017">Lambdas and Procs: Treating a Function as a First-Class Citizen</span></div>
<div style="position:absolute;left:392.87px;top:184.24px" class="cls_017"><span class="cls_017">203</span></div>
<div style="position:absolute;left:85.50px;top:195.23px" class="cls_017"><span class="cls_017">Stack vs. Heap Memory</span></div>
<div style="position:absolute;left:392.87px;top:195.23px" class="cls_017"><span class="cls_017">204</span></div>
<div style="position:absolute;left:85.50px;top:206.23px" class="cls_017"><span class="cls_017">A Closer Look at How Ruby Saves a String Value</span></div>
<div style="position:absolute;left:392.87px;top:206.23px" class="cls_017"><span class="cls_017">204</span></div>
<div style="position:absolute;left:85.50px;top:217.23px" class="cls_017"><span class="cls_017">How Ruby Creates a Lambda</span></div>
<div style="position:absolute;left:392.87px;top:217.23px" class="cls_017"><span class="cls_017">207</span></div>
<div style="position:absolute;left:85.50px;top:228.23px" class="cls_017"><span class="cls_017">How Ruby Calls a Lambda</span></div>
<div style="position:absolute;left:392.87px;top:228.23px" class="cls_017"><span class="cls_017">209</span></div>
<div style="position:absolute;left:85.50px;top:239.23px" class="cls_017"><span class="cls_017">The Proc Object</span></div>
<div style="position:absolute;left:392.87px;top:239.23px" class="cls_017"><span class="cls_017">211</span></div>
<div style="position:absolute;left:49.50px;top:250.22px" class="cls_019"><span class="cls_019">Experiment 8-2: Changing Local Variables After Calling lambda</span></div>
<div style="position:absolute;left:393.89px;top:250.22px" class="cls_019"><span class="cls_019">214</span></div>
<div style="position:absolute;left:85.50px;top:261.22px" class="cls_017"><span class="cls_017">Calling lambda More Than Once in the Same Scope</span></div>
<div style="position:absolute;left:392.87px;top:261.22px" class="cls_017"><span class="cls_017">216</span></div>
<div style="position:absolute;left:49.50px;top:272.22px" class="cls_017"><span class="cls_017">Summary</span></div>
<div style="position:absolute;left:392.87px;top:272.22px" class="cls_017"><span class="cls_017">217</span></div>
<div style="position:absolute;left:49.50px;top:298.25px" class="cls_018"><span class="cls_018">9</span></div>
<div style="position:absolute;left:49.50px;top:310.25px" class="cls_018"><span class="cls_018">Metaprogramming</span></div>
<div style="position:absolute;left:388.72px;top:310.25px" class="cls_018"><span class="cls_018">219</span></div>
<div style="position:absolute;left:49.50px;top:325.25px" class="cls_017"><span class="cls_017">Alternative Ways to Define Methods</span></div>
<div style="position:absolute;left:392.87px;top:325.25px" class="cls_017"><span class="cls_017">221</span></div>
<div style="position:absolute;left:85.50px;top:336.24px" class="cls_017"><span class="cls_017">Ruby’s Normal Method Definition Process</span></div>
<div style="position:absolute;left:392.87px;top:336.24px" class="cls_017"><span class="cls_017">221</span></div>
<div style="position:absolute;left:85.50px;top:347.24px" class="cls_017"><span class="cls_017">Defining Class Methods Using an Object Prefix</span></div>
<div style="position:absolute;left:392.87px;top:347.24px" class="cls_017"><span class="cls_017">223</span></div>
<div style="position:absolute;left:85.50px;top:358.24px" class="cls_017"><span class="cls_017">Defining Class Methods Using a New Lexical Scope</span></div>
<div style="position:absolute;left:392.87px;top:358.24px" class="cls_017"><span class="cls_017">224</span></div>
<div style="position:absolute;left:85.50px;top:369.24px" class="cls_017"><span class="cls_017">Defining Methods Using Singleton Classes</span></div>
<div style="position:absolute;left:392.87px;top:369.24px" class="cls_017"><span class="cls_017">226</span></div>
<div style="position:absolute;left:85.50px;top:380.24px" class="cls_017"><span class="cls_017">Defining Methods Using Singleton Classes in a Lexical Scope</span></div>
<div style="position:absolute;left:392.87px;top:380.24px" class="cls_017"><span class="cls_017">227</span></div>
<div style="position:absolute;left:85.50px;top:391.23px" class="cls_017"><span class="cls_017">Creating Refinements</span></div>
<div style="position:absolute;left:392.87px;top:391.23px" class="cls_017"><span class="cls_017">228</span></div>
<div style="position:absolute;left:85.50px;top:402.23px" class="cls_017"><span class="cls_017">Using Refinements</span></div>
<div style="position:absolute;left:392.87px;top:402.23px" class="cls_017"><span class="cls_017">229</span></div>
<div style="position:absolute;left:49.50px;top:413.23px" class="cls_019"><span class="cls_019">Experiment 9-1: Who Am I? How self Changes with Lexical Scope</span></div>
<div style="position:absolute;left:393.89px;top:413.23px" class="cls_019"><span class="cls_019">231</span></div>
<div style="position:absolute;left:85.50px;top:424.23px" class="cls_017"><span class="cls_017">self in the Top Scope</span></div>
<div style="position:absolute;left:392.87px;top:424.23px" class="cls_017"><span class="cls_017">231</span></div>
<div style="position:absolute;left:85.50px;top:435.23px" class="cls_017"><span class="cls_017">self in a Class Scope</span></div>
<div style="position:absolute;left:392.87px;top:435.23px" class="cls_017"><span class="cls_017">232</span></div>
<div style="position:absolute;left:85.50px;top:446.22px" class="cls_017"><span class="cls_017">self in a Metaclass Scope</span></div>
<div style="position:absolute;left:392.87px;top:446.22px" class="cls_017"><span class="cls_017">233</span></div>
<div style="position:absolute;left:85.50px;top:457.22px" class="cls_017"><span class="cls_017">self Inside a Class Method</span></div>
<div style="position:absolute;left:392.87px;top:457.22px" class="cls_017"><span class="cls_017">234</span></div>
<div style="position:absolute;left:49.50px;top:468.22px" class="cls_017"><span class="cls_017">Metaprogramming and Closures: eval, instance_eval, and binding</span></div>
<div style="position:absolute;left:392.87px;top:468.22px" class="cls_017"><span class="cls_017">236</span></div>
<div style="position:absolute;left:85.50px;top:479.22px" class="cls_017"><span class="cls_017">Code That Writes Code</span></div>
<div style="position:absolute;left:392.87px;top:479.22px" class="cls_017"><span class="cls_017">236</span></div>
<div style="position:absolute;left:85.50px;top:490.22px" class="cls_017"><span class="cls_017">Calling eval with binding</span></div>
<div style="position:absolute;left:392.87px;top:490.22px" class="cls_017"><span class="cls_017">238</span></div>
<div style="position:absolute;left:85.50px;top:501.21px" class="cls_017"><span class="cls_017">An instance_eval Example</span></div>
<div style="position:absolute;left:392.87px;top:501.21px" class="cls_017"><span class="cls_017">240</span></div>
<div style="position:absolute;left:85.50px;top:512.21px" class="cls_017"><span class="cls_017">Another Important Part of Ruby Closures</span></div>
<div style="position:absolute;left:392.87px;top:512.21px" class="cls_017"><span class="cls_017">241</span></div>
<div style="position:absolute;left:85.50px;top:523.21px" class="cls_017"><span class="cls_017">instance_eval Changes self to the Receiver</span></div>
<div style="position:absolute;left:392.87px;top:523.21px" class="cls_017"><span class="cls_017">242</span></div>
<div style="position:absolute;left:85.50px;top:534.21px" class="cls_017"><span class="cls_017">instance_eval Creates a Singleton Class for a New Lexical Scope</span></div>
<div style="position:absolute;left:392.87px;top:534.21px" class="cls_017"><span class="cls_017">243</span></div>
<div style="position:absolute;left:85.50px;top:545.21px" class="cls_017"><span class="cls_017">How Ruby Keeps Track of Lexical Scope for Blocks</span></div>
<div style="position:absolute;left:392.87px;top:545.21px" class="cls_017"><span class="cls_017">244</span></div>
<div style="position:absolute;left:49.50px;top:556.20px" class="cls_019"><span class="cls_019">Experiment 9-2: Using a Closure to Define a Method</span></div>
<div style="position:absolute;left:393.89px;top:556.20px" class="cls_019"><span class="cls_019">246</span></div>
<div style="position:absolute;left:85.50px;top:567.20px" class="cls_017"><span class="cls_017">Using define_method</span></div>
<div style="position:absolute;left:392.87px;top:567.20px" class="cls_017"><span class="cls_017">246</span></div>
<div style="position:absolute;left:85.50px;top:578.20px" class="cls_017"><span class="cls_017">Methods Acting as Closures</span></div>
<div style="position:absolute;left:392.87px;top:578.20px" class="cls_017"><span class="cls_017">247</span></div>
<div style="position:absolute;left:49.50px;top:589.20px" class="cls_017"><span class="cls_017">Summary</span></div>
<div style="position:absolute;left:392.87px;top:589.20px" class="cls_017"><span class="cls_017">248</span></div>
<div style="position:absolute;left:49.50px;top:633.00px" class="cls_020"><span class="cls_020">xii</span><span class="cls_021">   Contents in Detail</span></div>
</div>
<div style="position:absolute;left:50%;margin-left:-252px;top:7436px;width:504px;height:666px;border-style:outset;overflow:hidden">
<div style="position:absolute;left:0px;top:0px">
<img src="e698b76e-46bd-11eb-8b25-0cc47a792c0a_id_e698b76e-46bd-11eb-8b25-0cc47a792c0a_files/background013.jpg" width=504 height=666></div>
<div style="position:absolute;left:49.50px;top:42.74px" class="cls_018"><span class="cls_018">10</span></div>
<div style="position:absolute;left:49.50px;top:54.74px" class="cls_018"><span class="cls_018">JRuby: Ruby on the JVM</span></div>
<div style="position:absolute;left:388.69px;top:54.74px" class="cls_018"><span class="cls_018">251</span></div>
<div style="position:absolute;left:49.50px;top:69.74px" class="cls_017"><span class="cls_017">Running Programs with MRI and JRuby</span></div>
<div style="position:absolute;left:392.87px;top:69.74px" class="cls_017"><span class="cls_017">252</span></div>
<div style="position:absolute;left:85.50px;top:80.74px" class="cls_017"><span class="cls_017">How JRuby Parses and Compiles Your Code</span></div>
<div style="position:absolute;left:392.87px;top:80.74px" class="cls_017"><span class="cls_017">254</span></div>
<div style="position:absolute;left:85.50px;top:91.74px" class="cls_017"><span class="cls_017">How JRuby Executes Your Code</span></div>
<div style="position:absolute;left:392.87px;top:91.74px" class="cls_017"><span class="cls_017">255</span></div>
<div style="position:absolute;left:85.50px;top:102.73px" class="cls_017"><span class="cls_017">Implementing Ruby Classes with Java Classes</span></div>
<div style="position:absolute;left:392.87px;top:102.73px" class="cls_017"><span class="cls_017">257</span></div>
<div style="position:absolute;left:49.50px;top:113.73px" class="cls_019"><span class="cls_019">Experiment 10-1: Monitoring JRuby’s Just-in-Time Compiler</span></div>
<div style="position:absolute;left:393.89px;top:113.73px" class="cls_019"><span class="cls_019">260</span></div>
<div style="position:absolute;left:85.50px;top:124.73px" class="cls_017"><span class="cls_017">Experiment Code</span></div>
<div style="position:absolute;left:392.87px;top:124.73px" class="cls_017"><span class="cls_017">260</span></div>
<div style="position:absolute;left:85.50px;top:135.73px" class="cls_017"><span class="cls_017">Using the -J-XX:+PrintCompilation Option</span></div>
<div style="position:absolute;left:392.87px;top:135.73px" class="cls_017"><span class="cls_017">261</span></div>
<div style="position:absolute;left:85.50px;top:146.73px" class="cls_017"><span class="cls_017">Does JIT Speed Up Your JRuby Program?</span></div>
<div style="position:absolute;left:392.87px;top:146.73px" class="cls_017"><span class="cls_017">262</span></div>
<div style="position:absolute;left:49.50px;top:157.72px" class="cls_017"><span class="cls_017">Strings in JRuby and MRI</span></div>
<div style="position:absolute;left:392.87px;top:157.72px" class="cls_017"><span class="cls_017">263</span></div>
<div style="position:absolute;left:85.50px;top:168.72px" class="cls_017"><span class="cls_017">How JRuby and MRI Save String Data</span></div>
<div style="position:absolute;left:392.87px;top:168.72px" class="cls_017"><span class="cls_017">264</span></div>
<div style="position:absolute;left:85.50px;top:179.72px" class="cls_017"><span class="cls_017">Copy-on-Write</span></div>
<div style="position:absolute;left:392.87px;top:179.72px" class="cls_017"><span class="cls_017">265</span></div>
<div style="position:absolute;left:49.50px;top:190.72px" class="cls_019"><span class="cls_019">Experiment 10-2: Measuring Copy-on-Write Performance</span></div>
<div style="position:absolute;left:393.89px;top:190.72px" class="cls_019"><span class="cls_019">267</span></div>
<div style="position:absolute;left:85.50px;top:201.72px" class="cls_017"><span class="cls_017">Creating a Unique, Nonshared String</span></div>
<div style="position:absolute;left:392.87px;top:201.72px" class="cls_017"><span class="cls_017">267</span></div>
<div style="position:absolute;left:85.50px;top:212.71px" class="cls_017"><span class="cls_017">Experiment Code</span></div>
<div style="position:absolute;left:392.87px;top:212.71px" class="cls_017"><span class="cls_017">268</span></div>
<div style="position:absolute;left:85.50px;top:223.71px" class="cls_017"><span class="cls_017">Visualizing Copy-on-Write</span></div>
<div style="position:absolute;left:392.87px;top:223.71px" class="cls_017"><span class="cls_017">269</span></div>
<div style="position:absolute;left:85.50px;top:234.71px" class="cls_017"><span class="cls_017">Modifying a Shared String Is Slower</span></div>
<div style="position:absolute;left:392.87px;top:234.71px" class="cls_017"><span class="cls_017">270</span></div>
<div style="position:absolute;left:49.50px;top:245.71px" class="cls_017"><span class="cls_017">Summary</span></div>
<div style="position:absolute;left:392.87px;top:245.71px" class="cls_017"><span class="cls_017">271</span></div>
<div style="position:absolute;left:49.50px;top:271.74px" class="cls_018"><span class="cls_018">11</span></div>
<div style="position:absolute;left:49.50px;top:283.74px" class="cls_018"><span class="cls_018">Rubinius: Ruby Implemented with Ruby</span></div>
<div style="position:absolute;left:388.72px;top:283.74px" class="cls_018"><span class="cls_018">273</span></div>
<div style="position:absolute;left:49.50px;top:298.74px" class="cls_017"><span class="cls_017">The Rubinius Kernel and Virtual Machine</span></div>
<div style="position:absolute;left:392.87px;top:298.74px" class="cls_017"><span class="cls_017">274</span></div>
<div style="position:absolute;left:85.50px;top:309.74px" class="cls_017"><span class="cls_017">Tokenization and Parsing</span></div>
<div style="position:absolute;left:392.87px;top:309.74px" class="cls_017"><span class="cls_017">276</span></div>
<div style="position:absolute;left:85.50px;top:320.74px" class="cls_017"><span class="cls_017">Using Ruby to Compile Ruby</span></div>
<div style="position:absolute;left:392.87px;top:320.74px" class="cls_017"><span class="cls_017">277</span></div>
<div style="position:absolute;left:85.50px;top:331.73px" class="cls_017"><span class="cls_017">Rubinius Bytecode Instructions</span></div>
<div style="position:absolute;left:392.87px;top:331.73px" class="cls_017"><span class="cls_017">278</span></div>
<div style="position:absolute;left:85.50px;top:342.73px" class="cls_017"><span class="cls_017">Ruby and C++ Working Together</span></div>
<div style="position:absolute;left:392.87px;top:342.73px" class="cls_017"><span class="cls_017">279</span></div>
<div style="position:absolute;left:85.50px;top:353.73px" class="cls_017"><span class="cls_017">Implementing Ruby Objects with C++ Objects</span></div>
<div style="position:absolute;left:392.87px;top:353.73px" class="cls_017"><span class="cls_017">280</span></div>
<div style="position:absolute;left:49.50px;top:364.73px" class="cls_019"><span class="cls_019">Experiment 11-1: Comparing Backtraces in MRI and Rubinius</span></div>
<div style="position:absolute;left:393.89px;top:364.73px" class="cls_019"><span class="cls_019">281</span></div>
<div style="position:absolute;left:85.50px;top:375.73px" class="cls_017"><span class="cls_017">Backtraces in Rubinius</span></div>
<div style="position:absolute;left:392.87px;top:375.73px" class="cls_017"><span class="cls_017">282</span></div>
<div style="position:absolute;left:49.50px;top:386.72px" class="cls_017"><span class="cls_017">Arrays in Rubinius and MRI</span></div>
<div style="position:absolute;left:392.87px;top:386.72px" class="cls_017"><span class="cls_017">284</span></div>
<div style="position:absolute;left:85.50px;top:397.72px" class="cls_017"><span class="cls_017">Arrays Inside of MRI</span></div>
<div style="position:absolute;left:392.87px;top:397.72px" class="cls_017"><span class="cls_017">285</span></div>
<div style="position:absolute;left:85.50px;top:408.72px" class="cls_017"><span class="cls_017">The RArray C Structure Definition</span></div>
<div style="position:absolute;left:392.87px;top:408.72px" class="cls_017"><span class="cls_017">286</span></div>
<div style="position:absolute;left:85.50px;top:419.72px" class="cls_017"><span class="cls_017">Arrays Inside of Rubinius</span></div>
<div style="position:absolute;left:392.87px;top:419.72px" class="cls_017"><span class="cls_017">286</span></div>
<div style="position:absolute;left:49.50px;top:430.72px" class="cls_019"><span class="cls_019">Experiment 11-2: Exploring the Rubinius Implementation of Array#shift</span></div>
<div style="position:absolute;left:393.89px;top:430.72px" class="cls_019"><span class="cls_019">288</span></div>
<div style="position:absolute;left:85.50px;top:441.71px" class="cls_017"><span class="cls_017">Reading Array#shift</span></div>
<div style="position:absolute;left:392.87px;top:441.71px" class="cls_017"><span class="cls_017">288</span></div>
<div style="position:absolute;left:85.50px;top:452.71px" class="cls_017"><span class="cls_017">Modifying Array#shift</span></div>
<div style="position:absolute;left:392.87px;top:452.71px" class="cls_017"><span class="cls_017">289</span></div>
<div style="position:absolute;left:49.50px;top:463.71px" class="cls_017"><span class="cls_017">Summary</span></div>
<div style="position:absolute;left:392.87px;top:463.71px" class="cls_017"><span class="cls_017">292</span></div>
<div style="position:absolute;left:49.50px;top:489.74px" class="cls_018"><span class="cls_018">12</span></div>
<div style="position:absolute;left:49.50px;top:501.74px" class="cls_018"><span class="cls_018">Garbage Collection in MRI, JRuby, and Rubinius</span></div>
<div style="position:absolute;left:388.69px;top:501.74px" class="cls_018"><span class="cls_018">295</span></div>
<div style="position:absolute;left:49.50px;top:516.74px" class="cls_017"><span class="cls_017">Garbage Collectors Solve Three Problems</span></div>
<div style="position:absolute;left:392.87px;top:516.74px" class="cls_017"><span class="cls_017">297</span></div>
<div style="position:absolute;left:49.50px;top:527.74px" class="cls_017"><span class="cls_017">Garbage Collection in MRI: Mark and Sweep</span></div>
<div style="position:absolute;left:392.87px;top:527.74px" class="cls_017"><span class="cls_017">297</span></div>
<div style="position:absolute;left:85.50px;top:538.74px" class="cls_017"><span class="cls_017">The Free List</span></div>
<div style="position:absolute;left:392.87px;top:538.74px" class="cls_017"><span class="cls_017">297</span></div>
<div style="position:absolute;left:85.50px;top:549.73px" class="cls_017"><span class="cls_017">MRI’s Use of Multiple Free Lists</span></div>
<div style="position:absolute;left:392.87px;top:549.73px" class="cls_017"><span class="cls_017">298</span></div>
<div style="position:absolute;left:85.50px;top:560.73px" class="cls_017"><span class="cls_017">Marking</span></div>
<div style="position:absolute;left:392.87px;top:560.73px" class="cls_017"><span class="cls_017">299</span></div>
<div style="position:absolute;left:85.50px;top:571.73px" class="cls_017"><span class="cls_017">How Does MRI Mark Live Objects?</span></div>
<div style="position:absolute;left:392.87px;top:571.73px" class="cls_017"><span class="cls_017">299</span></div>
<div style="position:absolute;left:85.50px;top:582.73px" class="cls_017"><span class="cls_017">Sweeping</span></div>
<div style="position:absolute;left:392.87px;top:582.73px" class="cls_017"><span class="cls_017">300</span></div>
<div style="position:absolute;left:85.50px;top:593.73px" class="cls_017"><span class="cls_017">Lazy Sweeping</span></div>
<div style="position:absolute;left:392.87px;top:593.73px" class="cls_017"><span class="cls_017">300</span></div>
<div style="position:absolute;left:389.99px;top:636.00px" class="cls_021"><span class="cls_021">Contents in Detail</span></div>
<div style="position:absolute;left:443.32px;top:633.00px" class="cls_020"><span class="cls_020">xiii</span></div>
</div>
<div style="position:absolute;left:50%;margin-left:-252px;top:8112px;width:504px;height:666px;border-style:outset;overflow:hidden">
<div style="position:absolute;left:0px;top:0px">
<img src="e698b76e-46bd-11eb-8b25-0cc47a792c0a_id_e698b76e-46bd-11eb-8b25-0cc47a792c0a_files/background014.jpg" width=504 height=666></div>
<div style="position:absolute;left:85.50px;top:43.25px" class="cls_017"><span class="cls_017">The RVALUE Structure</span></div>
<div style="position:absolute;left:392.87px;top:43.25px" class="cls_017"><span class="cls_017">301</span></div>
<div style="position:absolute;left:85.50px;top:54.24px" class="cls_017"><span class="cls_017">Disadvantages of Mark and Sweep</span></div>
<div style="position:absolute;left:392.87px;top:54.24px" class="cls_017"><span class="cls_017">302</span></div>
<div style="position:absolute;left:49.50px;top:65.24px" class="cls_019"><span class="cls_019">Experiment 12-1: Seeing MRI Garbage Collection in Action</span></div>
<div style="position:absolute;left:393.89px;top:65.24px" class="cls_019"><span class="cls_019">302</span></div>
<div style="position:absolute;left:85.50px;top:76.24px" class="cls_017"><span class="cls_017">Seeing MRI Perform a Lazy Sweep</span></div>
<div style="position:absolute;left:392.87px;top:76.24px" class="cls_017"><span class="cls_017">303</span></div>
<div style="position:absolute;left:85.50px;top:87.24px" class="cls_017"><span class="cls_017">Seeing MRI Perform a Full Collection</span></div>
<div style="position:absolute;left:392.87px;top:87.24px" class="cls_017"><span class="cls_017">304</span></div>
<div style="position:absolute;left:85.50px;top:98.24px" class="cls_017"><span class="cls_017">Interpreting a GC Profile Report</span></div>
<div style="position:absolute;left:392.87px;top:98.24px" class="cls_017"><span class="cls_017">305</span></div>
<div style="position:absolute;left:49.50px;top:109.23px" class="cls_017"><span class="cls_017">Garbage Collection in JRuby and Rubinius</span></div>
<div style="position:absolute;left:392.87px;top:109.23px" class="cls_017"><span class="cls_017">309</span></div>
<div style="position:absolute;left:49.50px;top:120.23px" class="cls_017"><span class="cls_017">Copying Garbage Collection</span></div>
<div style="position:absolute;left:392.87px;top:120.23px" class="cls_017"><span class="cls_017">309</span></div>
<div style="position:absolute;left:85.50px;top:131.23px" class="cls_017"><span class="cls_017">Bump Allocation</span></div>
<div style="position:absolute;left:392.87px;top:131.23px" class="cls_017"><span class="cls_017">310</span></div>
<div style="position:absolute;left:85.50px;top:142.23px" class="cls_017"><span class="cls_017">The Semi-Space Algorithm</span></div>
<div style="position:absolute;left:392.87px;top:142.23px" class="cls_017"><span class="cls_017">311</span></div>
<div style="position:absolute;left:85.50px;top:153.23px" class="cls_017"><span class="cls_017">The Eden Heap</span></div>
<div style="position:absolute;left:392.87px;top:153.23px" class="cls_017"><span class="cls_017">312</span></div>
<div style="position:absolute;left:49.50px;top:164.22px" class="cls_017"><span class="cls_017">Generational Garbage Collection</span></div>
<div style="position:absolute;left:392.87px;top:164.22px" class="cls_017"><span class="cls_017">313</span></div>
<div style="position:absolute;left:85.50px;top:175.22px" class="cls_017"><span class="cls_017">The Weak Generational Hypothesis</span></div>
<div style="position:absolute;left:392.87px;top:175.22px" class="cls_017"><span class="cls_017">313</span></div>
<div style="position:absolute;left:85.50px;top:186.22px" class="cls_017"><span class="cls_017">Using the Semi-Space Algorithm for Young Objects</span></div>
<div style="position:absolute;left:392.87px;top:186.22px" class="cls_017"><span class="cls_017">314</span></div>
<div style="position:absolute;left:85.50px;top:197.22px" class="cls_017"><span class="cls_017">Promoting Objects</span></div>
<div style="position:absolute;left:392.87px;top:197.22px" class="cls_017"><span class="cls_017">314</span></div>
<div style="position:absolute;left:85.50px;top:208.22px" class="cls_017"><span class="cls_017">Garbage Collection for Mature Objects</span></div>
<div style="position:absolute;left:392.87px;top:208.22px" class="cls_017"><span class="cls_017">315</span></div>
<div style="position:absolute;left:85.50px;top:219.21px" class="cls_017"><span class="cls_017">References Between Generations</span></div>
<div style="position:absolute;left:392.87px;top:219.21px" class="cls_017"><span class="cls_017">316</span></div>
<div style="position:absolute;left:49.50px;top:230.21px" class="cls_017"><span class="cls_017">Concurrent Garbage Collection</span></div>
<div style="position:absolute;left:392.87px;top:230.21px" class="cls_017"><span class="cls_017">317</span></div>
<div style="position:absolute;left:85.50px;top:241.21px" class="cls_017"><span class="cls_017">Marking While the Object Graph Changes</span></div>
<div style="position:absolute;left:392.87px;top:241.21px" class="cls_017"><span class="cls_017">317</span></div>
<div style="position:absolute;left:85.50px;top:252.21px" class="cls_017"><span class="cls_017">Tricolor Marking</span></div>
<div style="position:absolute;left:392.87px;top:252.21px" class="cls_017"><span class="cls_017">319</span></div>
<div style="position:absolute;left:85.50px;top:263.21px" class="cls_017"><span class="cls_017">Three Garbage Collectors in the JVM</span></div>
<div style="position:absolute;left:392.87px;top:263.21px" class="cls_017"><span class="cls_017">320</span></div>
<div style="position:absolute;left:49.50px;top:274.20px" class="cls_019"><span class="cls_019">Experiment 12-2: Using Verbose GC Mode in JRuby</span></div>
<div style="position:absolute;left:393.90px;top:274.20px" class="cls_019"><span class="cls_019">321</span></div>
<div style="position:absolute;left:85.51px;top:285.20px" class="cls_017"><span class="cls_017">Triggering Major Collections</span></div>
<div style="position:absolute;left:392.88px;top:285.20px" class="cls_017"><span class="cls_017">323</span></div>
<div style="position:absolute;left:49.51px;top:296.20px" class="cls_017"><span class="cls_017">Further Reading</span></div>
<div style="position:absolute;left:392.88px;top:296.20px" class="cls_017"><span class="cls_017">324</span></div>
<div style="position:absolute;left:49.51px;top:307.20px" class="cls_017"><span class="cls_017">Summary</span></div>
<div style="position:absolute;left:392.88px;top:307.20px" class="cls_017"><span class="cls_017">325</span></div>
<div style="position:absolute;left:49.50px;top:333.25px" class="cls_018"><span class="cls_018">Appendix</span></div>
<div style="position:absolute;left:49.50px;top:345.25px" class="cls_018"><span class="cls_018">Yet More Ruby Virtual Machines by Koichi Sasada</span></div>
<div style="position:absolute;left:388.72px;top:345.25px" class="cls_018"><span class="cls_018">327</span></div>
<div style="position:absolute;left:49.50px;top:360.25px" class="cls_017"><span class="cls_017">YARV: Yet Another Ruby VM</span></div>
<div style="position:absolute;left:392.87px;top:360.25px" class="cls_017"><span class="cls_017">328</span></div>
<div style="position:absolute;left:49.50px;top:371.24px" class="cls_017"><span class="cls_017">Design Principles of YARV</span></div>
<div style="position:absolute;left:392.87px;top:371.24px" class="cls_017"><span class="cls_017">328</span></div>
<div style="position:absolute;left:49.50px;top:382.24px" class="cls_017"><span class="cls_017">YARV Development Prehistory</span></div>
<div style="position:absolute;left:392.87px;top:382.24px" class="cls_017"><span class="cls_017">329</span></div>
<div style="position:absolute;left:49.50px;top:393.24px" class="cls_017"><span class="cls_017">Yet More Ruby Virtual Machines</span></div>
<div style="position:absolute;left:392.87px;top:393.24px" class="cls_017"><span class="cls_017">330</span></div>
<div style="position:absolute;left:49.50px;top:430.25px" class="cls_018"><span class="cls_018">Index</span></div>
<div style="position:absolute;left:388.72px;top:430.25px" class="cls_018"><span class="cls_018">331</span></div>
<div style="position:absolute;left:49.50px;top:633.00px" class="cls_020"><span class="cls_020">xiv</span><span class="cls_021">   Contents in Detail</span></div>
</div>
<div style="position:absolute;left:50%;margin-left:-252px;top:8788px;width:504px;height:666px;border-style:outset;overflow:hidden">
<div style="position:absolute;left:0px;top:0px">
<img src="e698b76e-46bd-11eb-8b25-0cc47a792c0a_id_e698b76e-46bd-11eb-8b25-0cc47a792c0a_files/background015.jpg" width=504 height=666></div>
<div style="position:absolute;left:234.02px;top:183.00px" class="cls_016"><span class="cls_016">Foreword</span></div>
<div style="position:absolute;left:123.00px;top:273.00px" class="cls_007"><span class="cls_007">Oh, hi! I didn’t see you come in. I don’t want to be too forward, but let me</span></div>
<div style="position:absolute;left:123.00px;top:285.00px" class="cls_007"><span class="cls_007">preface this by saying you should buy this book!</span></div>
<div style="position:absolute;left:141.00px;top:297.00px" class="cls_007"><span class="cls_007">My name is Aaron Patterson, but my Internet friends call me “tenderlove.”</span></div>
<div style="position:absolute;left:123.00px;top:309.00px" class="cls_007"><span class="cls_007">I am on both the Ruby core team and the Ruby on Rails core team, and I</span></div>
<div style="position:absolute;left:123.00px;top:321.00px" class="cls_007"><span class="cls_007">did the technical review of this book. Does that mean you should listen</span></div>
<div style="position:absolute;left:123.00px;top:333.00px" class="cls_007"><span class="cls_007">to me? No. Well, maybe.</span></div>
<div style="position:absolute;left:141.00px;top:345.00px" class="cls_007"><span class="cls_007">Actually, when Pat approached me to do the technical review of this</span></div>
<div style="position:absolute;left:123.00px;top:357.00px" class="cls_007"><span class="cls_007">book, I was so excited that my top hat fell off and I dropped my monocle in</span></div>
<div style="position:absolute;left:123.00px;top:369.00px" class="cls_007"><span class="cls_007">my coffee! I knew about Pat’s previous work on </span><span class="cls_008">Ruby Under a Microscope</span><span class="cls_007">, and</span></div>
<div style="position:absolute;left:123.00px;top:381.00px" class="cls_007"><span class="cls_007">the idea of making an updated and print version available made me really</span></div>
<div style="position:absolute;left:123.00px;top:393.00px" class="cls_007"><span class="cls_007">happy. I think many developers are intimidated by Ruby’s internals and are</span></div>
<div style="position:absolute;left:123.00px;top:405.00px" class="cls_007"><span class="cls_007">afraid to dive in. Quite often people ask me how they can learn about how</span></div>
<div style="position:absolute;left:123.00px;top:417.00px" class="cls_007"><span class="cls_007">Ruby works under the hood or where to get started hacking on Ruby inter-</span></div>
<div style="position:absolute;left:123.00px;top:429.00px" class="cls_007"><span class="cls_007">nals. Unfortunately I didn’t have a good answer for people—until now.</span></div>
<div style="position:absolute;left:141.00px;top:441.00px" class="cls_007"><span class="cls_007">Pat’s style of writing, in combination with experimentation, makes Ruby</span></div>
<div style="position:absolute;left:123.00px;top:453.00px" class="cls_007"><span class="cls_007">internals very approachable. The experiments are combined with explana-</span></div>
<div style="position:absolute;left:123.00px;top:465.00px" class="cls_007"><span class="cls_007">tions of Ruby’s internals such that you can easily understand why Ruby acts</span></div>
<div style="position:absolute;left:123.00px;top:477.00px" class="cls_007"><span class="cls_007">the way it does with regard to behavior </span><span class="cls_008">and</span><span class="cls_007"> performance. Next time you</span></div>
<div style="position:absolute;left:123.00px;top:489.00px" class="cls_007"><span class="cls_007">encounter some behavior in your Ruby code, whether it be with perfor-</span></div>
<div style="position:absolute;left:123.00px;top:501.00px" class="cls_007"><span class="cls_007">mance, local variables and your environment, or even garbage collection,</span></div>
<div style="position:absolute;left:123.00px;top:513.00px" class="cls_007"><span class="cls_007">this book won’t just tell you </span><span class="cls_008">why</span><span class="cls_007"> your code behaves the way it does, but will</span></div>
<div style="position:absolute;left:123.00px;top:525.00px" class="cls_007"><span class="cls_007">even tell you </span><span class="cls_008">how</span><span class="cls_007">.</span></div>
<div style="position:absolute;left:141.00px;top:537.00px" class="cls_007"><span class="cls_007">If you’re someone who wants to start hacking on Ruby’s internals, or if</span></div>
<div style="position:absolute;left:123.00px;top:549.00px" class="cls_007"><span class="cls_007">you just want to understand why Ruby acts the way it does without any hand-</span></div>
<div style="position:absolute;left:123.00px;top:561.00px" class="cls_007"><span class="cls_007">waving, this is the book for you. I enjoyed this book, and I hope you will too.</span></div>
<div style="position:absolute;left:384.27px;top:585.00px" class="cls_007"><span class="cls_007">Aaron Patterson</span></div>
<div style="position:absolute;left:412.61px;top:598.50px" class="cls_022"><span class="cls_022">&lt;3 &lt;3 &lt;3 &lt;3</span></div>
</div>
<div style="position:absolute;left:50%;margin-left:-252px;top:9464px;width:504px;height:666px;border-style:outset;overflow:hidden">
<div style="position:absolute;left:0px;top:0px">
<img src="e698b76e-46bd-11eb-8b25-0cc47a792c0a_id_e698b76e-46bd-11eb-8b25-0cc47a792c0a_files/background016.jpg" width=504 height=666></div>
<div style="position:absolute;left:215.60px;top:186.00px" class="cls_016"><span class="cls_016">Foreword to</span></div>
<div style="position:absolute;left:174.83px;top:204.00px" class="cls_016"><span class="cls_016">the Japanese Edition</span></div>
<div style="position:absolute;left:120.00px;top:320.00px" class="cls_023"><span class="cls_023">The science fiction novel </span><span class="cls_024">A Connecticut Yankee in King</span></div>
<div style="position:absolute;left:120.00px;top:335.76px" class="cls_024"><span class="cls_024">Arthur’s Court</span><span class="cls_023"> by Mark Twain</span><span class="cls_025"><sup>1</sup></span><span class="cls_023"> is one of the books I still</span></div>
<div style="position:absolute;left:119.99px;top:356.01px" class="cls_023"><span class="cls_023">remember reading from my elementary school days.</span></div>
<div style="position:absolute;left:120.00px;top:375.00px" class="cls_007"><span class="cls_007">It is the story of an American living in the 1880s who accidentally travels</span></div>
<div style="position:absolute;left:120.00px;top:387.00px" class="cls_007"><span class="cls_007">through time to King Arthur-era Britain and nonetheless survives, taking</span></div>
<div style="position:absolute;left:120.00px;top:399.00px" class="cls_007"><span class="cls_007">advantage of his knowledge from the modern (1880) era. Surely you would</span></div>
<div style="position:absolute;left:120.00px;top:411.00px" class="cls_007"><span class="cls_007">be very powerful in the 5th century if you had knowledge of telephones,</span></div>
<div style="position:absolute;left:120.00px;top:423.00px" class="cls_007"><span class="cls_007">bicycles, and guns. But if we travelled from the 21st century to the 5th cen-</span></div>
<div style="position:absolute;left:120.00px;top:435.00px" class="cls_007"><span class="cls_007">tury, how much of our knowledge could we utilize? Bicycles are okay, but</span></div>
<div style="position:absolute;left:120.00px;top:447.00px" class="cls_007"><span class="cls_007">how about computers? It seems almost impossible to build computers and</span></div>
<div style="position:absolute;left:120.00px;top:459.00px" class="cls_007"><span class="cls_007">networks from scratch by ourselves. Modern technology products are too</span></div>
<div style="position:absolute;left:120.00px;top:471.00px" class="cls_007"><span class="cls_007">advanced for individuals to reproduce. We don’t know how technologies</span></div>
<div style="position:absolute;left:120.00px;top:483.00px" class="cls_007"><span class="cls_007">work even when we use them in our everyday lives.</span></div>
<div style="position:absolute;left:138.00px;top:495.00px" class="cls_007"><span class="cls_007">Ruby is one such technology. Even though we use it every day, few of</span></div>
<div style="position:absolute;left:120.00px;top:507.00px" class="cls_007"><span class="cls_007">us know what it looks like on the inside, how it runs internally, or how one</span></div>
<div style="position:absolute;left:120.00px;top:519.00px" class="cls_007"><span class="cls_007">could re-create such a programming language. </span><span class="cls_008">Ruby Under a Microscope</span></div>
<div style="position:absolute;left:120.00px;top:531.00px" class="cls_007"><span class="cls_007">sheds light on this and reveals the mystery of Ruby internals.</span></div>
<div style="position:absolute;left:120.00px;top:603.00px" class="cls_014"><span class="cls_014">1. Mark Twain, </span><span class="cls_026">A Connecticut Yankee in King Arthur’s Court</span><span class="cls_014"> (Kameyama Nagarjuna translation,</span></div>
<div style="position:absolute;left:120.00px;top:613.00px" class="cls_014"><span class="cls_014">Iwasaki Bookstore, 1971).</span></div>
</div>
<div style="position:absolute;left:50%;margin-left:-252px;top:10140px;width:504px;height:666px;border-style:outset;overflow:hidden">
<div style="position:absolute;left:0px;top:0px">
<img src="e698b76e-46bd-11eb-8b25-0cc47a792c0a_id_e698b76e-46bd-11eb-8b25-0cc47a792c0a_files/background017.jpg" width=504 height=666></div>
<div style="position:absolute;left:141.00px;top:42.28px" class="cls_007"><span class="cls_007">This book explains the software architecture of Ruby, the structure of</span></div>
<div style="position:absolute;left:123.00px;top:54.28px" class="cls_007"><span class="cls_007">its object system, and tips for performance improvement. In addition to that,</span></div>
<div style="position:absolute;left:123.00px;top:66.28px" class="cls_007"><span class="cls_007">it covers not only CRuby but also JRuby and Rubinius. I know of few books</span></div>
<div style="position:absolute;left:123.00px;top:78.28px" class="cls_007"><span class="cls_007">where you can find this type of knowledge. Though we have Minero Aoki’s</span></div>
<div style="position:absolute;left:123.00px;top:88.68px" class="cls_008"><span class="cls_008">Ruby Hacking Guide</span><span class="cls_027"><sup>2</sup></span><span class="cls_007"> in Japan, it’s been difficult to obtain a copy for a long</span></div>
<div style="position:absolute;left:123.00px;top:102.28px" class="cls_007"><span class="cls_007">time. It explains a version of Ruby as old as 1.7 and naturally does not cover</span></div>
<div style="position:absolute;left:123.00px;top:114.28px" class="cls_007"><span class="cls_007">newer technologies like YARV. I believe </span><span class="cls_008">Ruby Under a Microscope</span><span class="cls_007"> will contrib-</span></div>
<div style="position:absolute;left:123.00px;top:126.28px" class="cls_007"><span class="cls_007">ute to a wider understanding of Ruby internals.</span></div>
<div style="position:absolute;left:141.00px;top:138.28px" class="cls_007"><span class="cls_007">In the future someone inspired by this book may join the development</span></div>
<div style="position:absolute;left:123.00px;top:150.28px" class="cls_007"><span class="cls_007">of Ruby. It may be you. We will definitely welcome that. Or, someone may</span></div>
<div style="position:absolute;left:123.00px;top:162.28px" class="cls_007"><span class="cls_007">begin creating a next-generation programming language. I hope to see that</span></div>
<div style="position:absolute;left:123.00px;top:174.28px" class="cls_007"><span class="cls_007">happen.</span></div>
<div style="position:absolute;left:123.00px;top:198.28px" class="cls_007"><span class="cls_007">Yukihiro Matsumoto</span></div>
<div style="position:absolute;left:123.00px;top:210.28px" class="cls_007"><span class="cls_007">Matsue, Japan</span></div>
<div style="position:absolute;left:123.00px;top:222.28px" class="cls_007"><span class="cls_007">October 2014</span></div>
<div style="position:absolute;left:123.00px;top:603.00px" class="cls_014"><span class="cls_014">2. Minero Aoki, </span><span class="cls_026">Ruby Source Code Kanzen Kaisetsu</span><span class="cls_014">, known as the </span><span class="cls_026">Ruby Hacking Guide</span><span class="cls_014"> (Impress,</span></div>
<div style="position:absolute;left:123.00px;top:613.00px" class="cls_014"><span class="cls_014">2002); </span><A HREF="http://i.loveruby.net/ja/rhg/book/">http://i.loveruby.net/ja/rhg/book/</A> </span><span class="cls_014">; </span><span class="cls_026">http://ruby-hacking-guide.github.io/</span><span class="cls_014">.</span></div>
</div>
<div style="position:absolute;left:50%;margin-left:-252px;top:10816px;width:504px;height:666px;border-style:outset;overflow:hidden">
<div style="position:absolute;left:0px;top:0px">
<img src="e698b76e-46bd-11eb-8b25-0cc47a792c0a_id_e698b76e-46bd-11eb-8b25-0cc47a792c0a_files/background018.jpg" width=504 height=666></div>
</div>
<div style="position:absolute;left:50%;margin-left:-252px;top:10816px;width:504px;height:666px;border-style:outset;overflow:hidden">
<div style="position:absolute;left:0px;top:0px">
<img src="e698b76e-46bd-11eb-8b25-0cc47a792c0a_id_e698b76e-46bd-11eb-8b25-0cc47a792c0a_files/background019.jpg" width=504 height=666></div>
<div style="position:absolute;left:188.38px;top:186.00px" class="cls_016"><span class="cls_016">Acknowledgments</span></div>
<div style="position:absolute;left:123.00px;top:278.00px" class="cls_023"><span class="cls_023">I could never have finished a project like this without</span></div>
<div style="position:absolute;left:123.00px;top:296.01px" class="cls_023"><span class="cls_023">the support of many different people!</span></div>
<div style="position:absolute;left:141.00px;top:315.00px" class="cls_007"><span class="cls_007">First of all, thanks to Satty Bhens and everyone else at McKinsey for</span></div>
<div style="position:absolute;left:123.00px;top:327.00px" class="cls_007"><span class="cls_007">giving me the flexibility to write a book and keep my day job at a great</span></div>
<div style="position:absolute;left:123.00px;top:339.00px" class="cls_007"><span class="cls_007">company. Alex Rothenberg and Daniel Higginbotham gave me invalu-</span></div>
<div style="position:absolute;left:123.00px;top:351.00px" class="cls_007"><span class="cls_007">able advice, suffered through reading many early drafts, and helped me</span></div>
<div style="position:absolute;left:123.00px;top:363.00px" class="cls_007"><span class="cls_007">throughout the process. Special thanks to Xavier Noria, who took an</span></div>
<div style="position:absolute;left:123.00px;top:375.00px" class="cls_007"><span class="cls_007">interest in the project early on, gave me fantastic feedback on the entire</span></div>
<div style="position:absolute;left:123.00px;top:387.00px" class="cls_007"><span class="cls_007">rough draft, and was also the inspiration behind Experiment 6-1. Santiago</span></div>
<div style="position:absolute;left:123.00px;top:399.00px" class="cls_007"><span class="cls_007">Pastorino reviewed the rough draft as well. Jill Caporrimo, Prajakta Thakur,</span></div>
<div style="position:absolute;left:123.00px;top:411.00px" class="cls_007"><span class="cls_007">Yvannova Montalvo, Divya Ganesh, and Yanwing Wong were my “proofread-</span></div>
<div style="position:absolute;left:123.00px;top:423.00px" class="cls_007"><span class="cls_007">ing SWAT team.” Self-publishing would have been much harder without</span></div>
<div style="position:absolute;left:123.00px;top:435.00px" class="cls_007"><span class="cls_007">your help. Finally, without the constant encouragement and support Peter</span></div>
<div style="position:absolute;left:123.00px;top:447.00px" class="cls_007"><span class="cls_007">Cooper has given me this year, I probably never would have attempted to</span></div>
<div style="position:absolute;left:123.00px;top:459.00px" class="cls_007"><span class="cls_007">write this book. Thank you, Peter.</span></div>
<div style="position:absolute;left:141.00px;top:471.00px" class="cls_007"><span class="cls_007">Thanks to everyone at No Starch Press for helping me bring an</span></div>
<div style="position:absolute;left:123.00px;top:483.00px" class="cls_007"><span class="cls_007">expanded, updated version of </span><span class="cls_008">Ruby Under a Microscope</span><span class="cls_007"> to print. The result is</span></div>
<div style="position:absolute;left:123.00px;top:495.00px" class="cls_007"><span class="cls_007">a book I’m proud of and one the Ruby internals topic deserves. Thanks to</span></div>
<div style="position:absolute;left:123.00px;top:507.00px" class="cls_007"><span class="cls_007">Julianne Jigour, my copyeditor. My writing has never been so clear and easy</span></div>
<div style="position:absolute;left:123.00px;top:519.00px" class="cls_007"><span class="cls_007">to follow. Thank you, Riley Hoffman and Alison Law, for your editing advice</span></div>
<div style="position:absolute;left:123.00px;top:531.00px" class="cls_007"><span class="cls_007">and for beautifully reproducing hundreds of diagrams for print. You’ve been</span></div>
<div style="position:absolute;left:123.00px;top:543.00px" class="cls_007"><span class="cls_007">a pleasure to work with. Thanks to Charles Nutter for the technical help and</span></div>
<div style="position:absolute;left:123.00px;top:555.00px" class="cls_007"><span class="cls_007">advice on JVM garbage collection. Special thanks to Aaron Patterson: This</span></div>
<div style="position:absolute;left:123.00px;top:567.00px" class="cls_007"><span class="cls_007">is a more interesting and accurate book because of your great suggestions</span></div>
<div style="position:absolute;left:123.00px;top:579.00px" class="cls_007"><span class="cls_007">and technical review. Finally, thanks to Bill Pollock for reading and edit-</span></div>
<div style="position:absolute;left:123.00px;top:591.00px" class="cls_007"><span class="cls_007">ing every single line of text in the book. Your guidance and expertise have</span></div>
<div style="position:absolute;left:123.00px;top:603.00px" class="cls_007"><span class="cls_007">allowed me to write a book I could never have dreamed of writing on my own.</span></div>
</div>
<div style="position:absolute;left:50%;margin-left:-252px;top:11492px;width:504px;height:666px;border-style:outset;overflow:hidden">
<div style="position:absolute;left:0px;top:0px">
<img src="e698b76e-46bd-11eb-8b25-0cc47a792c0a_id_e698b76e-46bd-11eb-8b25-0cc47a792c0a_files/background020.jpg" width=504 height=666></div>
<div style="position:absolute;left:227.28px;top:293.71px" class="cls_024"><span class="cls_024">What seems complex from</span></div>
<div style="position:absolute;left:232.52px;top:311.72px" class="cls_024"><span class="cls_024">a distance is often quite</span></div>
<div style="position:absolute;left:239.32px;top:329.72px" class="cls_024"><span class="cls_024">simple when you look</span></div>
<div style="position:absolute;left:256.50px;top:347.73px" class="cls_024"><span class="cls_024">closely enough.</span></div>
</div>
<div style="position:absolute;left:50%;margin-left:-252px;top:12168px;width:504px;height:666px;border-style:outset;overflow:hidden">
<div style="position:absolute;left:0px;top:0px">
<img src="e698b76e-46bd-11eb-8b25-0cc47a792c0a_id_e698b76e-46bd-11eb-8b25-0cc47a792c0a_files/background021.jpg" width=504 height=666></div>
<div style="position:absolute;left:215.62px;top:253.45px" class="cls_016"><span class="cls_016">Introduction</span></div>
<div style="position:absolute;left:123.00px;top:369.45px" class="cls_023"><span class="cls_023">At first glance, learning how to use Ruby can seem</span></div>
<div style="position:absolute;left:123.00px;top:387.46px" class="cls_023"><span class="cls_023">fairly simple. Developers around the world find Ruby’s</span></div>
<div style="position:absolute;left:123.00px;top:405.46px" class="cls_023"><span class="cls_023">syntax to be graceful and straightforward. You can</span></div>
<div style="position:absolute;left:123.00px;top:423.46px" class="cls_023"><span class="cls_023">express algorithms in a very natural way, and then it’s</span></div>
<div style="position:absolute;left:123.00px;top:441.45px" class="cls_023"><span class="cls_023">just a matter of typing </span><span class="cls_028">ruby</span><span class="cls_023"> at the command line and</span></div>
<div style="position:absolute;left:123.01px;top:459.45px" class="cls_023"><span class="cls_023">pressing </span><span class="cls_029">enter</span><span class="cls_023">, and your Ruby script is running.</span></div>
<div style="position:absolute;left:141.00px;top:478.45px" class="cls_007"><span class="cls_007">However, Ruby’s syntax is </span><span class="cls_008">deceptively</span><span class="cls_007"> simple; in fact, Ruby employs</span></div>
<div style="position:absolute;left:123.00px;top:490.45px" class="cls_007"><span class="cls_007">sophisticated ideas from complex languages like Lisp and Smalltalk.</span></div>
<div style="position:absolute;left:123.00px;top:502.45px" class="cls_007"><span class="cls_007">On top of this, Ruby is dynamic; using metaprogramming, Ruby programs</span></div>
<div style="position:absolute;left:123.00px;top:514.45px" class="cls_007"><span class="cls_007">can inspect and change themselves. Beneath this thin veneer of simplicity,</span></div>
<div style="position:absolute;left:123.00px;top:526.45px" class="cls_007"><span class="cls_007">Ruby is a very complex tool.</span></div>
<div style="position:absolute;left:141.00px;top:538.45px" class="cls_007"><span class="cls_007">By looking very closely at Ruby—by learning how Ruby itself works</span></div>
<div style="position:absolute;left:123.00px;top:550.45px" class="cls_007"><span class="cls_007">internally—you’ll discover that a few important computer science concepts</span></div>
<div style="position:absolute;left:123.00px;top:562.45px" class="cls_007"><span class="cls_007">underpin Ruby’s many features. By studying these, you’ll gain a deeper</span></div>
<div style="position:absolute;left:123.00px;top:574.45px" class="cls_007"><span class="cls_007">understanding of what is happening under the hood as you use the lan-</span></div>
<div style="position:absolute;left:123.00px;top:586.45px" class="cls_007"><span class="cls_007">guage. In the process, you’ll learn how the team that built Ruby </span><span class="cls_008">intends</span><span class="cls_007"> for</span></div>
<div style="position:absolute;left:123.00px;top:598.45px" class="cls_007"><span class="cls_007">you to use the language.</span></div>
</div>
<div style="position:absolute;left:50%;margin-left:-252px;top:12844px;width:504px;height:666px;border-style:outset;overflow:hidden">
<div style="position:absolute;left:0px;top:0px">
<img src="e698b76e-46bd-11eb-8b25-0cc47a792c0a_id_e698b76e-46bd-11eb-8b25-0cc47a792c0a_files/background022.jpg" width=504 height=666></div>
<div style="position:absolute;left:138.00px;top:41.60px" class="cls_008"><span class="cls_008">Ruby Under a Microscope</span><span class="cls_007"> will show you what happens inside Ruby when</span></div>
<div style="position:absolute;left:120.00px;top:53.60px" class="cls_007"><span class="cls_007">you run a simple program. You’ll learn how Ruby understands and executes</span></div>
<div style="position:absolute;left:120.00px;top:65.60px" class="cls_007"><span class="cls_007">your code, and with the help of extensive diagrams, you’ll build a mental</span></div>
<div style="position:absolute;left:120.00px;top:77.60px" class="cls_007"><span class="cls_007">model of what Ruby does when you create an object or call a block.</span></div>
<div style="position:absolute;left:66.00px;top:111.60px" class="cls_031"><span class="cls_031">Who This Book Is For</span></div>
<div style="position:absolute;left:120.00px;top:131.60px" class="cls_008"><span class="cls_008">Ruby Under a Microscope</span><span class="cls_007"> is not a beginner’s guide to learning Ruby. I assume</span></div>
<div style="position:absolute;left:120.00px;top:143.60px" class="cls_007"><span class="cls_007">you already know how to program in Ruby and that you use it daily. There</span></div>
<div style="position:absolute;left:120.00px;top:155.60px" class="cls_007"><span class="cls_007">are already many great books that teach Ruby basics; the world doesn’t</span></div>
<div style="position:absolute;left:120.00px;top:167.60px" class="cls_007"><span class="cls_007">need another one.</span></div>
<div style="position:absolute;left:138.00px;top:179.60px" class="cls_007"><span class="cls_007">Although Ruby itself is written in C, a confusing, low-level language,</span></div>
<div style="position:absolute;left:120.00px;top:191.60px" class="cls_007"><span class="cls_007">no C programming knowledge is required to read this book. </span><span class="cls_008">Ruby Under a</span></div>
<div style="position:absolute;left:120.00px;top:203.60px" class="cls_008"><span class="cls_008">Microscope</span><span class="cls_007"> will give you a high-level, conceptual understanding of how Ruby</span></div>
<div style="position:absolute;left:120.00px;top:215.60px" class="cls_007"><span class="cls_007">works without your having to understand how to program in C. Inside this</span></div>
<div style="position:absolute;left:120.00px;top:227.60px" class="cls_007"><span class="cls_007">book, you’ll find hundreds of diagrams that make the low-level details of</span></div>
<div style="position:absolute;left:120.00px;top:239.60px" class="cls_007"><span class="cls_007">Ruby’s internal implementation easy to understand.</span></div>
<div style="position:absolute;left:78.00px;top:266.10px" class="cls_032"><span class="cls_032">Note</span></div>
<div style="position:absolute;left:120.00px;top:263.60px" class="cls_008"><span class="cls_008">Readers familiar with C will find a few snippets of C code that give a more concrete</span></div>
<div style="position:absolute;left:120.00px;top:275.60px" class="cls_008"><span class="cls_008">sense of what’s going on inside Ruby. I’ll also tell you where the code derives from,</span></div>
<div style="position:absolute;left:120.00px;top:287.60px" class="cls_008"><span class="cls_008">making it easier for you to start studying the C code yourself. If you’re not interested</span></div>
<div style="position:absolute;left:120.00px;top:299.60px" class="cls_008"><span class="cls_008">in the C code details, just skip over these sections.</span></div>
<div style="position:absolute;left:66.00px;top:333.60px" class="cls_031"><span class="cls_031">Using Ruby to Test Itself</span></div>
<div style="position:absolute;left:156.00px;top:360.60px" class="cls_033"><span class="cls_033">It doesn’t matter how beautiful your theory is, it doesn’t matter</span></div>
<div style="position:absolute;left:156.00px;top:372.60px" class="cls_033"><span class="cls_033">how smart you are. If it doesn’t agree with experiment, it’s wrong.</span></div>
<div style="position:absolute;left:156.00px;top:384.59px" class="cls_033"><span class="cls_033">—Richard Feynman</span></div>
<div style="position:absolute;left:120.00px;top:401.60px" class="cls_007"><span class="cls_007">Imagine that the entire world functioned like a large computer program.</span></div>
<div style="position:absolute;left:120.00px;top:413.60px" class="cls_007"><span class="cls_007">To explain natural phenomena or experimental results, physicists like</span></div>
<div style="position:absolute;left:120.00px;top:425.60px" class="cls_007"><span class="cls_007">Richard Feynman would simply consult this program. (A scientist’s dream</span></div>
<div style="position:absolute;left:120.00px;top:437.60px" class="cls_007"><span class="cls_007">come true!) But of course, the universe is not so simple.</span></div>
<div style="position:absolute;left:138.00px;top:449.60px" class="cls_007"><span class="cls_007">Fortunately, to discover how Ruby works, all we need to do is read its</span></div>
<div style="position:absolute;left:120.00px;top:461.60px" class="cls_007"><span class="cls_007">internal C source code: a kind of theoretical physics that describes Ruby’s</span></div>
<div style="position:absolute;left:120.00px;top:473.60px" class="cls_007"><span class="cls_007">behavior. Just as Maxwell’s equations explain electricity and magnetism,</span></div>
<div style="position:absolute;left:120.00px;top:485.60px" class="cls_007"><span class="cls_007">Ruby’s internal C source code explains what happens when you pass an</span></div>
<div style="position:absolute;left:120.00px;top:497.60px" class="cls_007"><span class="cls_007">argument to a method or include a module in a class.</span></div>
<div style="position:absolute;left:138.00px;top:509.60px" class="cls_007"><span class="cls_007">Like scientists, however, we need to perform experiments to be sure our</span></div>
<div style="position:absolute;left:120.00px;top:521.60px" class="cls_007"><span class="cls_007">hypotheses are correct. After learning about each part of Ruby’s internal</span></div>
<div style="position:absolute;left:120.00px;top:533.60px" class="cls_007"><span class="cls_007">implementation, we’ll perform an experiment and use Ruby to test itself!</span></div>
<div style="position:absolute;left:120.00px;top:545.60px" class="cls_007"><span class="cls_007">We’ll run small Ruby test scripts to see whether they produce the expected</span></div>
<div style="position:absolute;left:120.00px;top:557.60px" class="cls_007"><span class="cls_007">output or run as quickly or as slowly as we expect. We’ll find out if Ruby</span></div>
<div style="position:absolute;left:120.00px;top:569.60px" class="cls_007"><span class="cls_007">actually behaves the way theory says it should. And since these experiments</span></div>
<div style="position:absolute;left:120.00px;top:581.60px" class="cls_007"><span class="cls_007">are written in Ruby, you can try them yourself.</span></div>
<div style="position:absolute;left:48.00px;top:633.00px" class="cls_020"><span class="cls_020">xxii</span></div>
<div style="position:absolute;left:74.62px;top:636.00px" class="cls_021"><span class="cls_021">Introduction</span></div>
</div>
<div style="position:absolute;left:50%;margin-left:-252px;top:13520px;width:504px;height:666px;border-style:outset;overflow:hidden">
<div style="position:absolute;left:0px;top:0px">
<img src="e698b76e-46bd-11eb-8b25-0cc47a792c0a_id_e698b76e-46bd-11eb-8b25-0cc47a792c0a_files/background023.jpg" width=504 height=666></div>
<div style="position:absolute;left:69.00px;top:42.63px" class="cls_031"><span class="cls_031">Which Implementation of Ruby?</span></div>
<div style="position:absolute;left:123.00px;top:62.63px" class="cls_007"><span class="cls_007">Ruby was invented by Yukihiro “Matz” Matsumoto in 1993, and the original,</span></div>
<div style="position:absolute;left:123.00px;top:74.63px" class="cls_007"><span class="cls_007">standard version of Ruby is often known as </span><span class="cls_008">Matz’s Ruby Interpreter (MRI)</span><span class="cls_007">.</span></div>
<div style="position:absolute;left:123.00px;top:86.63px" class="cls_007"><span class="cls_007">Most of this book will discuss how MRI works; essentially, we’ll learn how</span></div>
<div style="position:absolute;left:123.00px;top:98.63px" class="cls_007"><span class="cls_007">Matz implemented his own language.</span></div>
<div style="position:absolute;left:141.00px;top:110.63px" class="cls_007"><span class="cls_007">Over the years many alternative implementations of Ruby have been</span></div>
<div style="position:absolute;left:123.00px;top:122.63px" class="cls_007"><span class="cls_007">written. Some, like RubyMotion, MacRuby, and IronRuby, were designed to</span></div>
<div style="position:absolute;left:123.00px;top:134.63px" class="cls_007"><span class="cls_007">run on specific platforms. Others, like Topaz and JRuby, were built using</span></div>
<div style="position:absolute;left:123.00px;top:146.63px" class="cls_007"><span class="cls_007">programming languages other than C. One version, Rubinius, was built</span></div>
<div style="position:absolute;left:123.00px;top:158.63px" class="cls_007"><span class="cls_007">using Ruby itself. And Matz himself is now working on a smaller version</span></div>
<div style="position:absolute;left:123.00px;top:170.63px" class="cls_007"><span class="cls_007">of Ruby called </span><span class="cls_008">mruby</span><span class="cls_007">, designed to run inside another application.</span></div>
<div style="position:absolute;left:141.00px;top:182.63px" class="cls_007"><span class="cls_007">I explore the Ruby implementations JRuby and Rubinius in detail in</span></div>
<div style="position:absolute;left:123.00px;top:194.63px" class="cls_007"><span class="cls_007">Chapters 10, 11, and 12. You’ll learn how they use different technologies</span></div>
<div style="position:absolute;left:123.00px;top:206.63px" class="cls_007"><span class="cls_007">and philosophies to implement the same language. As you study these alter-</span></div>
<div style="position:absolute;left:123.00px;top:218.63px" class="cls_007"><span class="cls_007">native Rubies, you’ll gain additional perspective on MRI’s implementation.</span></div>
<div style="position:absolute;left:69.00px;top:252.63px" class="cls_031"><span class="cls_031">Overview</span></div>
<div style="position:absolute;left:123.00px;top:272.63px" class="cls_007"><span class="cls_007">In </span><span class="cls_034">Chapter 1: Tokenization and Parsing</span><span class="cls_007">, you’ll learn how Ruby parses</span></div>
<div style="position:absolute;left:123.00px;top:284.63px" class="cls_007"><span class="cls_007">your Ruby program. This is one of the most fascinating areas of computer</span></div>
<div style="position:absolute;left:123.00px;top:296.63px" class="cls_007"><span class="cls_007">science: How can a computer language be smart enough to understand the</span></div>
<div style="position:absolute;left:123.00px;top:308.63px" class="cls_007"><span class="cls_007">code you give it? What does this intelligence really consist of?</span></div>
<div style="position:absolute;left:141.00px;top:320.63px" class="cls_034"><span class="cls_034">Chapter 2: Compilation</span><span class="cls_007"> explains how Ruby uses a compiler to convert</span></div>
<div style="position:absolute;left:123.00px;top:332.63px" class="cls_007"><span class="cls_007">your program into a different language before running it.</span></div>
<div style="position:absolute;left:141.00px;top:344.63px" class="cls_034"><span class="cls_034">Chapter 3: How Ruby Executes Your Code</span><span class="cls_007"> looks at the virtual machine</span></div>
<div style="position:absolute;left:123.00px;top:356.63px" class="cls_007"><span class="cls_007">Ruby uses to run your program. What’s inside this machine? How does it</span></div>
<div style="position:absolute;left:123.00px;top:368.63px" class="cls_007"><span class="cls_007">work? We’ll look deep inside this virtual machine to find out.</span></div>
<div style="position:absolute;left:141.00px;top:380.63px" class="cls_034"><span class="cls_034">Chapter 4: Control Structures and Method Dispatch</span><span class="cls_007"> continues the</span></div>
<div style="position:absolute;left:123.00px;top:392.63px" class="cls_007"><span class="cls_007">description of Ruby’s virtual machine, looking at how Ruby implements</span></div>
<div style="position:absolute;left:123.00px;top:404.63px" class="cls_007"><span class="cls_007">control structures such as </span><span class="cls_030">if...else</span><span class="cls_007"> statements and </span><span class="cls_030">while...end</span><span class="cls_007"> loops. It also</span></div>
<div style="position:absolute;left:123.00px;top:416.63px" class="cls_007"><span class="cls_007">explores how Ruby implements method calls.</span></div>
<div style="position:absolute;left:141.00px;top:428.63px" class="cls_034"><span class="cls_034">Chapter 5: Objects and Classes</span><span class="cls_007"> discusses Ruby’s implementation of</span></div>
<div style="position:absolute;left:123.00px;top:440.63px" class="cls_007"><span class="cls_007">objects and classes. How are objects and classes related? What would we</span></div>
<div style="position:absolute;left:123.00px;top:452.63px" class="cls_007"><span class="cls_007">find inside a Ruby object?</span></div>
<div style="position:absolute;left:141.00px;top:464.63px" class="cls_034"><span class="cls_034">Chapter 6: Method Lookup and Constant Lookup</span><span class="cls_007"> examines Ruby</span></div>
<div style="position:absolute;left:123.00px;top:476.63px" class="cls_007"><span class="cls_007">modules and their relationship to classes. You’ll learn how Ruby finds</span></div>
<div style="position:absolute;left:123.00px;top:488.63px" class="cls_007"><span class="cls_007">methods and constants in your Ruby code.</span></div>
<div style="position:absolute;left:141.00px;top:500.63px" class="cls_034"><span class="cls_034">Chapter 7: The Hash Table: The Workhorse of Ruby Internals</span></div>
<div style="position:absolute;left:123.00px;top:512.63px" class="cls_007"><span class="cls_007">explores Ruby’s implementation of hash tables. As it turns out, MRI uses</span></div>
<div style="position:absolute;left:123.00px;top:524.63px" class="cls_007"><span class="cls_007">hash tables for much of its internal data, not only for data you save in</span></div>
<div style="position:absolute;left:123.00px;top:536.63px" class="cls_007"><span class="cls_007">Ruby hash objects.</span></div>
<div style="position:absolute;left:141.00px;top:548.63px" class="cls_034"><span class="cls_034">Chapter 8: How Ruby Borrowed a Decades-Old Idea from Lisp</span><span class="cls_007"> reveals</span></div>
<div style="position:absolute;left:123.00px;top:560.63px" class="cls_007"><span class="cls_007">that one of Ruby’s most elegant and useful features, blocks, is based on an</span></div>
<div style="position:absolute;left:123.00px;top:572.63px" class="cls_007"><span class="cls_007">idea originally developed for Lisp.</span></div>
<div style="position:absolute;left:141.00px;top:584.63px" class="cls_007"><span class="cls_007">In </span><span class="cls_034">Chapter 9: Metaprogramming</span><span class="cls_007"> tackles one of the most difficult</span></div>
<div style="position:absolute;left:123.00px;top:596.63px" class="cls_007"><span class="cls_007">topics for Ruby developers. By studying how Ruby implements metapro-</span></div>
<div style="position:absolute;left:123.00px;top:608.63px" class="cls_007"><span class="cls_007">gramming internally, you’ll learn how to use metaprogramming effectively.</span></div>
<div style="position:absolute;left:396.37px;top:636.00px" class="cls_021"><span class="cls_021">Introduction</span></div>
<div style="position:absolute;left:440.06px;top:633.00px" class="cls_020"><span class="cls_020">xxiii</span></div>
</div>
<div style="position:absolute;left:50%;margin-left:-252px;top:14196px;width:504px;height:666px;border-style:outset;overflow:hidden">
<div style="position:absolute;left:0px;top:0px">
<img src="e698b76e-46bd-11eb-8b25-0cc47a792c0a_id_e698b76e-46bd-11eb-8b25-0cc47a792c0a_files/background024.jpg" width=504 height=666></div>
<div style="position:absolute;left:138.00px;top:41.60px" class="cls_034"><span class="cls_034">Chapter 10: JRuby: Ruby on the JVM </span><span class="cls_007">introduces JRuby, an alternative</span></div>
<div style="position:absolute;left:120.00px;top:53.60px" class="cls_007"><span class="cls_007">version of Ruby implemented with Java. You’ll learn how JRuby uses the Java</span></div>
<div style="position:absolute;left:120.00px;top:65.60px" class="cls_007"><span class="cls_007">Virtual Machine (JVM) to run your Ruby programs faster.</span></div>
<div style="position:absolute;left:138.00px;top:77.60px" class="cls_034"><span class="cls_034">Chapter 11: Rubinius: Ruby Implemented with Ruby</span><span class="cls_007"> looks at one of</span></div>
<div style="position:absolute;left:120.00px;top:89.60px" class="cls_007"><span class="cls_007">the most interesting and innovative implementations of Ruby: Rubinius.</span></div>
<div style="position:absolute;left:120.00px;top:101.60px" class="cls_007"><span class="cls_007">You’ll learn how to locate—and modify—the Ruby code in Rubinius to see</span></div>
<div style="position:absolute;left:120.00px;top:113.60px" class="cls_007"><span class="cls_007">how a particular Ruby method works.</span></div>
<div style="position:absolute;left:138.00px;top:125.60px" class="cls_034"><span class="cls_034">Chapter 12: Garbage Collection in MRI, JRuby, and Rubinius</span><span class="cls_007"> con-</span></div>
<div style="position:absolute;left:120.00px;top:137.60px" class="cls_007"><span class="cls_007">cludes with a look at garbage collection (GC), one of the most mysterious</span></div>
<div style="position:absolute;left:120.00px;top:149.60px" class="cls_007"><span class="cls_007">and confusing topics in computer science. You’ll see how Rubinius and</span></div>
<div style="position:absolute;left:120.00px;top:161.60px" class="cls_007"><span class="cls_007">JRuby use very different GC algorithms from those used by MRI.</span></div>
<div style="position:absolute;left:138.00px;top:185.60px" class="cls_007"><span class="cls_007">By studying all of these aspects of Ruby’s internal implementation,</span></div>
<div style="position:absolute;left:120.00px;top:197.60px" class="cls_007"><span class="cls_007">you’ll acquire a deeper understanding of what happens when you use</span></div>
<div style="position:absolute;left:120.00px;top:209.60px" class="cls_007"><span class="cls_007">Ruby’s complex feature set. Just as Antonie van Leeuwenhoek first saw</span></div>
<div style="position:absolute;left:120.00px;top:221.60px" class="cls_007"><span class="cls_007">microbes and cells looking through early microscopes in the 1600s, by</span></div>
<div style="position:absolute;left:120.00px;top:233.60px" class="cls_007"><span class="cls_007">looking inside of Ruby you’ll discover a wide array of interesting struc-</span></div>
<div style="position:absolute;left:120.00px;top:245.60px" class="cls_007"><span class="cls_007">tures and algorithms. Join me on a fascinating behind-the-scenes look at</span></div>
<div style="position:absolute;left:120.00px;top:257.60px" class="cls_007"><span class="cls_007">what brings Ruby to life!</span></div>
<div style="position:absolute;left:48.00px;top:633.00px" class="cls_020"><span class="cls_020">xxiv</span></div>
<div style="position:absolute;left:76.72px;top:636.00px" class="cls_021"><span class="cls_021">Introduction</span></div>
</div>
<div style="position:absolute;left:50%;margin-left:-252px;top:14872px;width:504px;height:666px;border-style:outset;overflow:hidden">
<div style="position:absolute;left:0px;top:0px">
<img src="e698b76e-46bd-11eb-8b25-0cc47a792c0a_id_e698b76e-46bd-11eb-8b25-0cc47a792c0a_files/background025.jpg" width=504 height=666></div>
</div>
<div style="position:absolute;left:50%;margin-left:-252px;top:14872px;width:504px;height:666px;border-style:outset;overflow:hidden">
<div style="position:absolute;left:0px;top:0px">
<img src="e698b76e-46bd-11eb-8b25-0cc47a792c0a_id_e698b76e-46bd-11eb-8b25-0cc47a792c0a_files/background026.jpg" width=504 height=666></div>
<div style="position:absolute;left:231.08px;top:297.71px" class="cls_024"><span class="cls_024">Your code has a long</span></div>
<div style="position:absolute;left:238.94px;top:315.72px" class="cls_024"><span class="cls_024">road to take before</span></div>
<div style="position:absolute;left:238.57px;top:333.72px" class="cls_024"><span class="cls_024">Ruby ever runs it.</span></div>
</div>
<div style="position:absolute;left:50%;margin-left:-252px;top:15548px;width:504px;height:666px;border-style:outset;overflow:hidden">
<div style="position:absolute;left:0px;top:0px">
<img src="e698b76e-46bd-11eb-8b25-0cc47a792c0a_id_e698b76e-46bd-11eb-8b25-0cc47a792c0a_files/background027.jpg" width=504 height=666></div>
<div style="position:absolute;left:260.10px;top:101.45px" class="cls_035"><span class="cls_035">1</span></div>
<div style="position:absolute;left:148.50px;top:253.45px" class="cls_016"><span class="cls_016">Tokenization and Parsing</span></div>
<div style="position:absolute;left:123.00px;top:369.45px" class="cls_023"><span class="cls_023">How many times do you think Ruby reads and trans-</span></div>
<div style="position:absolute;left:123.00px;top:387.46px" class="cls_023"><span class="cls_023">forms your code before running it? Once? Twice?</span></div>
<div style="position:absolute;left:141.00px;top:406.45px" class="cls_007"><span class="cls_007">The correct answer is three times. Whenever you run a Ruby script—</span></div>
<div style="position:absolute;left:123.00px;top:418.45px" class="cls_007"><span class="cls_007">whether it’s a large Rails application, a simple Sinatra website, or a back-</span></div>
<div style="position:absolute;left:123.00px;top:430.45px" class="cls_007"><span class="cls_007">ground worker job—Ruby rips your code apart into small pieces and then</span></div>
<div style="position:absolute;left:123.00px;top:442.45px" class="cls_007"><span class="cls_007">puts them back together in a different format </span><span class="cls_008">three times</span><span class="cls_007">! Between the time</span></div>
<div style="position:absolute;left:123.00px;top:454.45px" class="cls_007"><span class="cls_007">you type </span><span class="cls_008">ruby</span><span class="cls_007"> and the time you start to see actual output on the console,</span></div>
<div style="position:absolute;left:123.00px;top:466.45px" class="cls_007"><span class="cls_007">your Ruby code has a long road to take—a journey involving a variety of</span></div>
<div style="position:absolute;left:123.00px;top:478.45px" class="cls_007"><span class="cls_007">different technologies, techniques, and open source tools.</span></div>
<div style="position:absolute;left:141.00px;top:490.45px" class="cls_007"><span class="cls_007">Figure 1-1 shows what this journey looks like at a high level.</span></div>
<div style="position:absolute;left:140.15px;top:520.43px" class="cls_036"><span class="cls_036">Your</span></div>
<div style="position:absolute;left:421.93px;top:520.43px" class="cls_036"><span class="cls_036">YARV</span></div>
<div style="position:absolute;left:131.27px;top:528.95px" class="cls_036"><span class="cls_036">Ruby Code</span></div>
<div style="position:absolute;left:201.38px;top:527.22px" class="cls_037"><span class="cls_037">Tokenize</span></div>
<div style="position:absolute;left:279.55px;top:527.22px" class="cls_037"><span class="cls_037">Parse</span></div>
<div style="position:absolute;left:347.57px;top:527.22px" class="cls_037"><span class="cls_037">Compile</span></div>
<div style="position:absolute;left:413.91px;top:528.95px" class="cls_036"><span class="cls_036">Instructions</span></div>
<div style="position:absolute;left:243.35px;top:546.28px" class="cls_036"><span class="cls_036">tokens</span></div>
<div style="position:absolute;left:318.66px;top:546.28px" class="cls_036"><span class="cls_036">AST</span></div>
<div style="position:absolute;left:315.62px;top:554.80px" class="cls_036"><span class="cls_036">nodes</span></div>
<div style="position:absolute;left:123.00px;top:571.97px" class="cls_038"><span class="cls_038">Figure 1-1: Your code’s journey through Ruby</span></div>
<div style="position:absolute;left:141.00px;top:594.47px" class="cls_007"><span class="cls_007">First, Ruby </span><span class="cls_008">tokenizes</span><span class="cls_007"> your code, which means it reads the text characters</span></div>
<div style="position:absolute;left:123.00px;top:606.47px" class="cls_007"><span class="cls_007">in your code file and converts them into </span><span class="cls_008">tokens</span><span class="cls_007">, the words used in the Ruby</span></div>
</div>
<div style="position:absolute;left:50%;margin-left:-252px;top:16224px;width:504px;height:666px;border-style:outset;overflow:hidden">
<div style="position:absolute;left:0px;top:0px">
<img src="e698b76e-46bd-11eb-8b25-0cc47a792c0a_id_e698b76e-46bd-11eb-8b25-0cc47a792c0a_files/background028.jpg" width=504 height=666></div>
<div style="position:absolute;left:120.00px;top:41.60px" class="cls_007"><span class="cls_007">language. Next, Ruby </span><span class="cls_008">parses</span><span class="cls_007"> these tokens; that is, it groups the tokens into</span></div>
<div style="position:absolute;left:120.00px;top:53.60px" class="cls_007"><span class="cls_007">meaningful Ruby statements just as one might group words into sentences.</span></div>
<div style="position:absolute;left:120.00px;top:65.60px" class="cls_007"><span class="cls_007">Finally, Ruby compiles these statements into low-level instructions that it</span></div>
<div style="position:absolute;left:120.00px;top:77.60px" class="cls_007"><span class="cls_007">can execute later using a virtual machine.</span></div>
<div style="position:absolute;left:138.00px;top:89.60px" class="cls_007"><span class="cls_007">I’ll cover Ruby’s virtual machine, called “Yet Another Ruby Virtual</span></div>
<div style="position:absolute;left:120.00px;top:101.60px" class="cls_007"><span class="cls_007">Machine” (YARV), in Chapter 3. But first, in this chapter, I’ll describe the</span></div>
<div style="position:absolute;left:120.00px;top:113.60px" class="cls_007"><span class="cls_007">tokenizing and parsing processes that Ruby uses to understand your code.</span></div>
<div style="position:absolute;left:120.00px;top:125.60px" class="cls_007"><span class="cls_007">After that, in Chapter 2, I’ll show you how Ruby compiles your code by</span></div>
<div style="position:absolute;left:120.00px;top:137.60px" class="cls_007"><span class="cls_007">translating it into a completely different language.</span></div>
<div style="position:absolute;left:78.00px;top:164.10px" class="cls_032"><span class="cls_032">note</span></div>
<div style="position:absolute;left:120.00px;top:161.60px" class="cls_008"><span class="cls_008">Throughout most of this book we’ll learn about the original, standard implementa-</span></div>
<div style="position:absolute;left:120.00px;top:173.60px" class="cls_008"><span class="cls_008">tion of Ruby, known as </span><span class="cls_007">Matz’s Ruby Interpreter (MRI)</span><span class="cls_008"> after Yukihiro Matsumoto,</span></div>
<div style="position:absolute;left:120.00px;top:185.60px" class="cls_008"><span class="cls_008">who invented Ruby in 1993. There are many other implementations of Ruby avail-</span></div>
<div style="position:absolute;left:120.00px;top:197.60px" class="cls_008"><span class="cls_008">able in addition to MRI, including Ruby Enterprise Edition, MagLev, MacRuby,</span></div>
<div style="position:absolute;left:120.00px;top:209.60px" class="cls_008"><span class="cls_008">RubyMotion, mruby, and many, many others. Later, in Chapters 10, 11, and 12,</span></div>
<div style="position:absolute;left:120.00px;top:221.60px" class="cls_008"><span class="cls_008">we’ll look at two of these alternative Ruby implementations: JRuby and Rubinius.</span></div>
<div style="position:absolute;left:261.47px;top:268.31px" class="cls_020"><span class="cls_020">Roadmap</span></div>
<div style="position:absolute;left:131.99px;top:285.31px" class="cls_017"><span class="cls_017">Tokens: The Words That Make Up the Ruby Language</span></div>
<div style="position:absolute;left:426.44px;top:285.31px" class="cls_017"><span class="cls_017">4</span></div>
<div style="position:absolute;left:149.99px;top:302.31px" class="cls_017"><span class="cls_017">The </span><span class="cls_030">parser_yylex</span><span class="cls_017"> Function</span></div>
<div style="position:absolute;left:426.46px;top:302.31px" class="cls_017"><span class="cls_017">8</span></div>
<div style="position:absolute;left:132.01px;top:319.31px" class="cls_019"><span class="cls_019">Experiment 1-1: Using Ripper to Tokenize Different Ruby Scripts</span></div>
<div style="position:absolute;left:426.80px;top:319.31px" class="cls_019"><span class="cls_019">9</span></div>
<div style="position:absolute;left:132.01px;top:336.32px" class="cls_017"><span class="cls_017">Parsing: How Ruby Understands Your Code</span></div>
<div style="position:absolute;left:420.91px;top:336.32px" class="cls_017"><span class="cls_017">12</span></div>
<div style="position:absolute;left:150.01px;top:353.32px" class="cls_017"><span class="cls_017">Understanding the LALR Parse Algorithm</span></div>
<div style="position:absolute;left:420.91px;top:353.32px" class="cls_017"><span class="cls_017">13</span></div>
<div style="position:absolute;left:150.01px;top:370.32px" class="cls_017"><span class="cls_017">Some Actual Ruby Grammar Rules</span></div>
<div style="position:absolute;left:420.91px;top:370.32px" class="cls_017"><span class="cls_017">20</span></div>
<div style="position:absolute;left:150.01px;top:387.32px" class="cls_017"><span class="cls_017">Reading a Bison Grammar Rule</span></div>
<div style="position:absolute;left:420.91px;top:387.32px" class="cls_017"><span class="cls_017">22</span></div>
<div style="position:absolute;left:132.01px;top:404.32px" class="cls_019"><span class="cls_019">Experiment 1-2: Using Ripper to Parse Different Ruby Scripts</span></div>
<div style="position:absolute;left:421.61px;top:404.32px" class="cls_019"><span class="cls_019">23</span></div>
<div style="position:absolute;left:132.01px;top:421.32px" class="cls_017"><span class="cls_017">Summary</span></div>
<div style="position:absolute;left:420.92px;top:421.32px" class="cls_017"><span class="cls_017">29</span></div>
<div style="position:absolute;left:66.00px;top:477.60px" class="cls_031"><span class="cls_031">Tokens: The Words That Make Up the Ruby Language</span></div>
<div style="position:absolute;left:120.00px;top:497.60px" class="cls_007"><span class="cls_007">Suppose you write a simple Ruby program and save it in a file called</span></div>
<div style="position:absolute;left:120.00px;top:509.60px" class="cls_008"><span class="cls_008">simple.rb</span><span class="cls_007">, shown in Listing 1-1.</span></div>
<div style="position:absolute;left:120.00px;top:533.60px" class="cls_030"><span class="cls_030">10.times do |n|</span></div>
<div style="position:absolute;left:128.50px;top:544.10px" class="cls_030"><span class="cls_030">puts n</span></div>
<div style="position:absolute;left:120.00px;top:554.59px" class="cls_030"><span class="cls_030">end</span></div>
<div style="position:absolute;left:120.00px;top:577.09px" class="cls_038"><span class="cls_038">Listing 1-1: A very simple Ruby program </span><span class="cls_039">(simple.rb)</span></div>
<div style="position:absolute;left:48.00px;top:633.00px" class="cls_020"><span class="cls_020">4</span></div>
<div style="position:absolute;left:65.38px;top:636.00px" class="cls_021"><span class="cls_021">Chapter 1</span></div>
</div>
<div style="position:absolute;left:50%;margin-left:-252px;top:16900px;width:504px;height:666px;border-style:outset;overflow:hidden">
<div style="position:absolute;left:0px;top:0px">
<img src="e698b76e-46bd-11eb-8b25-0cc47a792c0a_id_e698b76e-46bd-11eb-8b25-0cc47a792c0a_files/background029.jpg" width=504 height=666></div>
<div style="position:absolute;left:141.00px;top:42.28px" class="cls_007"><span class="cls_007">Listing 1-2 shows the output you would see after executing the program</span></div>
<div style="position:absolute;left:123.00px;top:54.28px" class="cls_007"><span class="cls_007">from the command line.</span></div>
<div style="position:absolute;left:123.00px;top:78.28px" class="cls_030"><span class="cls_030">$ </span><span class="cls_040">ruby simple.rb</span></div>
<div style="position:absolute;left:123.00px;top:88.78px" class="cls_030"><span class="cls_030">0</span></div>
<div style="position:absolute;left:123.00px;top:99.28px" class="cls_030"><span class="cls_030">1</span></div>
<div style="position:absolute;left:123.00px;top:109.77px" class="cls_030"><span class="cls_030">2</span></div>
<div style="position:absolute;left:123.00px;top:120.27px" class="cls_030"><span class="cls_030">3</span></div>
<div style="position:absolute;left:123.00px;top:130.77px" class="cls_030"><span class="cls_030">--snip--</span></div>
<div style="position:absolute;left:123.00px;top:153.27px" class="cls_038"><span class="cls_038">Listing 1-2: Executing Listing 1-1</span></div>
<div style="position:absolute;left:141.00px;top:175.78px" class="cls_007"><span class="cls_007">What happens after you type </span><span class="cls_030">ruby simple.rb</span><span class="cls_007"> and press </span><span class="cls_009">enter</span><span class="cls_007">? Aside</span></div>
<div style="position:absolute;left:123.00px;top:187.78px" class="cls_007"><span class="cls_007">from general initialization, processing your command line parameters,</span></div>
<div style="position:absolute;left:123.00px;top:199.78px" class="cls_007"><span class="cls_007">and so on, the first thing Ruby does is open </span><span class="cls_008">simple.rb </span><span class="cls_007">and read in all the</span></div>
<div style="position:absolute;left:123.00px;top:211.78px" class="cls_007"><span class="cls_007">text from the code file. Next, it needs to make sense of this text: your Ruby</span></div>
<div style="position:absolute;left:123.00px;top:223.78px" class="cls_007"><span class="cls_007">code. How does it do this?</span></div>
<div style="position:absolute;left:141.00px;top:235.78px" class="cls_007"><span class="cls_007">After reading in </span><span class="cls_008">simple.rb</span><span class="cls_007">, Ruby encounters the series of text characters</span></div>
<div style="position:absolute;left:123.00px;top:247.78px" class="cls_007"><span class="cls_007">shown in Figure 1-2. (To keep things simple, I’m showing only the first line</span></div>
<div style="position:absolute;left:123.00px;top:259.78px" class="cls_007"><span class="cls_007">of text here.)</span></div>
<div style="position:absolute;left:131.57px;top:286.98px" class="cls_041"><span class="cls_041">1</span></div>
<div style="position:absolute;left:151.72px;top:286.98px" class="cls_041"><span class="cls_041">0</span></div>
<div style="position:absolute;left:192.01px;top:286.98px" class="cls_041"><span class="cls_041">t</span></div>
<div style="position:absolute;left:212.15px;top:286.98px" class="cls_041"><span class="cls_041">i</span></div>
<div style="position:absolute;left:232.30px;top:286.98px" class="cls_041"><span class="cls_041">m</span></div>
<div style="position:absolute;left:252.44px;top:286.98px" class="cls_041"><span class="cls_041">e</span></div>
<div style="position:absolute;left:272.60px;top:286.98px" class="cls_041"><span class="cls_041">s</span></div>
<div style="position:absolute;left:312.89px;top:286.98px" class="cls_041"><span class="cls_041">d</span></div>
<div style="position:absolute;left:333.03px;top:286.98px" class="cls_041"><span class="cls_041">o</span></div>
<div style="position:absolute;left:373.32px;top:286.98px" class="cls_041"><span class="cls_041">|</span></div>
<div style="position:absolute;left:393.47px;top:286.98px" class="cls_041"><span class="cls_041">n</span></div>
<div style="position:absolute;left:413.62px;top:286.98px" class="cls_041"><span class="cls_041">|</span></div>
<div style="position:absolute;left:123.00px;top:310.43px" class="cls_038"><span class="cls_038">Figure 1-2: The first line of text in </span><span class="cls_039">simple.rb</span></div>
<div style="position:absolute;left:141.00px;top:332.93px" class="cls_007"><span class="cls_007">When Ruby sees these characters, it tokenizes them. That is, it con-</span></div>
<div style="position:absolute;left:123.00px;top:344.93px" class="cls_007"><span class="cls_007">verts them into a series of tokens or words that it understands by stepping</span></div>
<div style="position:absolute;left:123.00px;top:356.93px" class="cls_007"><span class="cls_007">through the characters one at a time. In Figure 1-3, Ruby starts scanning at</span></div>
<div style="position:absolute;left:123.00px;top:368.93px" class="cls_007"><span class="cls_007">the first character’s position.</span></div>
<div style="position:absolute;left:131.57px;top:422.38px" class="cls_041"><span class="cls_041">1</span></div>
<div style="position:absolute;left:151.72px;top:422.38px" class="cls_041"><span class="cls_041">0</span></div>
<div style="position:absolute;left:192.01px;top:422.38px" class="cls_041"><span class="cls_041">t</span></div>
<div style="position:absolute;left:212.15px;top:422.38px" class="cls_041"><span class="cls_041">i</span></div>
<div style="position:absolute;left:232.30px;top:422.38px" class="cls_041"><span class="cls_041">m</span></div>
<div style="position:absolute;left:252.44px;top:422.38px" class="cls_041"><span class="cls_041">e</span></div>
<div style="position:absolute;left:272.60px;top:422.38px" class="cls_041"><span class="cls_041">s</span></div>
<div style="position:absolute;left:312.89px;top:422.38px" class="cls_041"><span class="cls_041">d</span></div>
<div style="position:absolute;left:333.03px;top:422.38px" class="cls_041"><span class="cls_041">o</span></div>
<div style="position:absolute;left:373.32px;top:422.38px" class="cls_041"><span class="cls_041">|</span></div>
<div style="position:absolute;left:393.47px;top:422.38px" class="cls_041"><span class="cls_041">n</span></div>
<div style="position:absolute;left:413.62px;top:422.38px" class="cls_041"><span class="cls_041">|</span></div>
<div style="position:absolute;left:123.00px;top:445.83px" class="cls_038"><span class="cls_038">Figure 1-3: Ruby starts to tokenize your code.</span></div>
<div style="position:absolute;left:141.00px;top:468.33px" class="cls_007"><span class="cls_007">The Ruby C source code contains a loop that reads in one character at</span></div>
<div style="position:absolute;left:123.00px;top:480.33px" class="cls_007"><span class="cls_007">a time and processes it based on what that character is.</span></div>
<div style="position:absolute;left:141.00px;top:492.33px" class="cls_007"><span class="cls_007">To keep things simple, I’m describing tokenization as an independent</span></div>
<div style="position:absolute;left:123.00px;top:504.33px" class="cls_007"><span class="cls_007">process. In fact, the parsing engine I describe next calls this C tokenize code</span></div>
<div style="position:absolute;left:123.00px;top:516.33px" class="cls_007"><span class="cls_007">whenever it needs a new token. Tokenization and parsing are separate pro-</span></div>
<div style="position:absolute;left:123.00px;top:528.33px" class="cls_007"><span class="cls_007">cesses that actually occur at the same time. For now, let’s just continue to</span></div>
<div style="position:absolute;left:123.00px;top:540.33px" class="cls_007"><span class="cls_007">see how Ruby tokenizes the characters in your Ruby file.</span></div>
<div style="position:absolute;left:141.00px;top:552.33px" class="cls_007"><span class="cls_007">Ruby realizes that the character 1 is the start of a number and contin-</span></div>
<div style="position:absolute;left:123.00px;top:564.33px" class="cls_007"><span class="cls_007">ues to iterate over the characters that follow until it finds a nonnumeric</span></div>
<div style="position:absolute;left:123.00px;top:576.33px" class="cls_007"><span class="cls_007">character. First, in Figure 1-4, it finds a 0.</span></div>
<div style="position:absolute;left:370.48px;top:636.00px" class="cls_021"><span class="cls_021">Tokenization and Parsing</span></div>
<div style="position:absolute;left:451.59px;top:633.00px" class="cls_020"><span class="cls_020">5</span></div>
</div>
<div style="position:absolute;left:50%;margin-left:-252px;top:17576px;width:504px;height:666px;border-style:outset;overflow:hidden">
<div style="position:absolute;left:0px;top:0px">
<img src="e698b76e-46bd-11eb-8b25-0cc47a792c0a_id_e698b76e-46bd-11eb-8b25-0cc47a792c0a_files/background030.jpg" width=504 height=666></div>
<div style="position:absolute;left:128.57px;top:76.05px" class="cls_041"><span class="cls_041">1</span></div>
<div style="position:absolute;left:148.72px;top:76.05px" class="cls_041"><span class="cls_041">0</span></div>
<div style="position:absolute;left:189.01px;top:76.05px" class="cls_041"><span class="cls_041">t</span></div>
<div style="position:absolute;left:209.15px;top:76.05px" class="cls_041"><span class="cls_041">i</span></div>
<div style="position:absolute;left:229.30px;top:76.05px" class="cls_041"><span class="cls_041">m</span></div>
<div style="position:absolute;left:249.44px;top:76.05px" class="cls_041"><span class="cls_041">e</span></div>
<div style="position:absolute;left:269.60px;top:76.05px" class="cls_041"><span class="cls_041">s</span></div>
<div style="position:absolute;left:309.89px;top:76.05px" class="cls_041"><span class="cls_041">d</span></div>
<div style="position:absolute;left:330.03px;top:76.05px" class="cls_041"><span class="cls_041">o</span></div>
<div style="position:absolute;left:370.32px;top:76.05px" class="cls_041"><span class="cls_041">|</span></div>
<div style="position:absolute;left:390.47px;top:76.05px" class="cls_041"><span class="cls_041">n</span></div>
<div style="position:absolute;left:410.62px;top:76.05px" class="cls_041"><span class="cls_041">|</span></div>
<div style="position:absolute;left:120.00px;top:99.50px" class="cls_038"><span class="cls_038">Figure 1-4: Ruby steps to the second text character.</span></div>
<div style="position:absolute;left:138.00px;top:122.00px" class="cls_007"><span class="cls_007">And stepping forward again, in Figure 1-5, Ruby finds a period</span></div>
<div style="position:absolute;left:120.00px;top:134.00px" class="cls_007"><span class="cls_007">character.</span></div>
<div style="position:absolute;left:128.57px;top:187.44px" class="cls_041"><span class="cls_041">1</span></div>
<div style="position:absolute;left:148.72px;top:187.44px" class="cls_041"><span class="cls_041">0</span></div>
<div style="position:absolute;left:189.01px;top:187.44px" class="cls_041"><span class="cls_041">t</span></div>
<div style="position:absolute;left:209.15px;top:187.44px" class="cls_041"><span class="cls_041">i</span></div>
<div style="position:absolute;left:229.30px;top:187.44px" class="cls_041"><span class="cls_041">m</span></div>
<div style="position:absolute;left:249.44px;top:187.44px" class="cls_041"><span class="cls_041">e</span></div>
<div style="position:absolute;left:269.60px;top:187.44px" class="cls_041"><span class="cls_041">s</span></div>
<div style="position:absolute;left:309.89px;top:187.44px" class="cls_041"><span class="cls_041">d</span></div>
<div style="position:absolute;left:330.03px;top:187.44px" class="cls_041"><span class="cls_041">o</span></div>
<div style="position:absolute;left:370.32px;top:187.44px" class="cls_041"><span class="cls_041">|</span></div>
<div style="position:absolute;left:390.47px;top:187.44px" class="cls_041"><span class="cls_041">n</span></div>
<div style="position:absolute;left:410.62px;top:187.44px" class="cls_041"><span class="cls_041">|</span></div>
<div style="position:absolute;left:120.00px;top:210.89px" class="cls_038"><span class="cls_038">Figure 1-5: Ruby finds a period character.</span></div>
<div style="position:absolute;left:138.00px;top:233.39px" class="cls_007"><span class="cls_007">Ruby actually considers the period character to be numeric because it</span></div>
<div style="position:absolute;left:120.00px;top:245.39px" class="cls_007"><span class="cls_007">might be part of a floating-point value. In Figure 1-6, Ruby steps to the next</span></div>
<div style="position:absolute;left:120.00px;top:257.39px" class="cls_007"><span class="cls_007">character, t.</span></div>
<div style="position:absolute;left:128.57px;top:310.84px" class="cls_041"><span class="cls_041">1</span></div>
<div style="position:absolute;left:148.72px;top:310.84px" class="cls_041"><span class="cls_041">0</span></div>
<div style="position:absolute;left:189.01px;top:310.84px" class="cls_041"><span class="cls_041">t</span></div>
<div style="position:absolute;left:209.15px;top:310.84px" class="cls_041"><span class="cls_041">i</span></div>
<div style="position:absolute;left:229.30px;top:310.84px" class="cls_041"><span class="cls_041">m</span></div>
<div style="position:absolute;left:249.44px;top:310.84px" class="cls_041"><span class="cls_041">e</span></div>
<div style="position:absolute;left:269.60px;top:310.84px" class="cls_041"><span class="cls_041">s</span></div>
<div style="position:absolute;left:309.89px;top:310.84px" class="cls_041"><span class="cls_041">d</span></div>
<div style="position:absolute;left:330.03px;top:310.84px" class="cls_041"><span class="cls_041">o</span></div>
<div style="position:absolute;left:370.32px;top:310.84px" class="cls_041"><span class="cls_041">|</span></div>
<div style="position:absolute;left:390.47px;top:310.84px" class="cls_041"><span class="cls_041">n</span></div>
<div style="position:absolute;left:410.62px;top:310.84px" class="cls_041"><span class="cls_041">|</span></div>
<div style="position:absolute;left:120.00px;top:334.29px" class="cls_038"><span class="cls_038">Figure 1-6: Ruby finds the first nonnumeric character.</span></div>
<div style="position:absolute;left:138.00px;top:356.79px" class="cls_007"><span class="cls_007">Now Ruby stops iterating because it has found a nonnumeric charac-</span></div>
<div style="position:absolute;left:120.00px;top:368.79px" class="cls_007"><span class="cls_007">ter. Because there are no more numeric characters after the period, Ruby</span></div>
<div style="position:absolute;left:120.00px;top:380.79px" class="cls_007"><span class="cls_007">considers the period to be part of a separate token, and it steps back one, as</span></div>
<div style="position:absolute;left:120.00px;top:392.79px" class="cls_007"><span class="cls_007">shown in Figure 1-7.</span></div>
<div style="position:absolute;left:128.57px;top:446.24px" class="cls_041"><span class="cls_041">1</span></div>
<div style="position:absolute;left:148.72px;top:446.24px" class="cls_041"><span class="cls_041">0</span></div>
<div style="position:absolute;left:189.01px;top:446.24px" class="cls_041"><span class="cls_041">t</span></div>
<div style="position:absolute;left:209.15px;top:446.24px" class="cls_041"><span class="cls_041">i</span></div>
<div style="position:absolute;left:229.30px;top:446.24px" class="cls_041"><span class="cls_041">m</span></div>
<div style="position:absolute;left:249.44px;top:446.24px" class="cls_041"><span class="cls_041">e</span></div>
<div style="position:absolute;left:269.60px;top:446.24px" class="cls_041"><span class="cls_041">s</span></div>
<div style="position:absolute;left:309.89px;top:446.24px" class="cls_041"><span class="cls_041">d</span></div>
<div style="position:absolute;left:330.03px;top:446.24px" class="cls_041"><span class="cls_041">o</span></div>
<div style="position:absolute;left:370.32px;top:446.24px" class="cls_041"><span class="cls_041">|</span></div>
<div style="position:absolute;left:390.47px;top:446.24px" class="cls_041"><span class="cls_041">n</span></div>
<div style="position:absolute;left:410.62px;top:446.24px" class="cls_041"><span class="cls_041">|</span></div>
<div style="position:absolute;left:120.00px;top:469.69px" class="cls_038"><span class="cls_038">Figure 1-7: Ruby steps back one character.</span></div>
<div style="position:absolute;left:138.00px;top:492.19px" class="cls_007"><span class="cls_007">Finally, in Figure 1-8, Ruby converts the numeric characters that it</span></div>
<div style="position:absolute;left:120.00px;top:504.19px" class="cls_007"><span class="cls_007">found into the first token from your program, called </span><span class="cls_030">tINTEGER</span><span class="cls_007">.</span></div>
<div style="position:absolute;left:128.60px;top:553.01px" class="cls_042"><span class="cls_042">tINTEGER</span></div>
<div style="position:absolute;left:206.30px;top:557.63px" class="cls_041"><span class="cls_041">t</span></div>
<div style="position:absolute;left:226.44px;top:557.63px" class="cls_041"><span class="cls_041">i</span></div>
<div style="position:absolute;left:246.59px;top:557.63px" class="cls_041"><span class="cls_041">m</span></div>
<div style="position:absolute;left:266.73px;top:557.63px" class="cls_041"><span class="cls_041">e</span></div>
<div style="position:absolute;left:286.88px;top:557.63px" class="cls_041"><span class="cls_041">s</span></div>
<div style="position:absolute;left:327.18px;top:557.63px" class="cls_041"><span class="cls_041">d</span></div>
<div style="position:absolute;left:347.32px;top:557.63px" class="cls_041"><span class="cls_041">o</span></div>
<div style="position:absolute;left:387.61px;top:557.63px" class="cls_041"><span class="cls_041">|</span></div>
<div style="position:absolute;left:407.76px;top:557.63px" class="cls_041"><span class="cls_041">n</span></div>
<div style="position:absolute;left:427.90px;top:557.63px" class="cls_041"><span class="cls_041">|</span></div>
<div style="position:absolute;left:142.01px;top:564.26px" class="cls_043"><span class="cls_043">10</span></div>
<div style="position:absolute;left:120.00px;top:589.66px" class="cls_038"><span class="cls_038">Figure 1-8: Ruby converts the first two text characters into a </span><span class="cls_014">tINTEGER</span><span class="cls_038"> token.</span></div>
<div style="position:absolute;left:48.00px;top:633.00px" class="cls_020"><span class="cls_020">6</span></div>
<div style="position:absolute;left:65.38px;top:636.00px" class="cls_021"><span class="cls_021">Chapter 1</span></div>
</div>
<div style="position:absolute;left:50%;margin-left:-252px;top:18252px;width:504px;height:666px;border-style:outset;overflow:hidden">
<div style="position:absolute;left:0px;top:0px">
<img src="e698b76e-46bd-11eb-8b25-0cc47a792c0a_id_e698b76e-46bd-11eb-8b25-0cc47a792c0a_files/background031.jpg" width=504 height=666></div>
<div style="position:absolute;left:141.00px;top:42.28px" class="cls_007"><span class="cls_007">Ruby continues to step through the characters in your code file, con-</span></div>
<div style="position:absolute;left:123.00px;top:54.28px" class="cls_007"><span class="cls_007">verting them into tokens and grouping characters as necessary. The second</span></div>
<div style="position:absolute;left:123.00px;top:66.28px" class="cls_007"><span class="cls_007">token, shown in Figure 1-9, is a single character: a period.</span></div>
<div style="position:absolute;left:131.60px;top:115.10px" class="cls_042"><span class="cls_042">tINTEGER</span></div>
<div style="position:absolute;left:217.55px;top:119.73px" class="cls_041"><span class="cls_041">t</span></div>
<div style="position:absolute;left:237.70px;top:119.73px" class="cls_041"><span class="cls_041">i</span></div>
<div style="position:absolute;left:257.84px;top:119.73px" class="cls_041"><span class="cls_041">m</span></div>
<div style="position:absolute;left:277.99px;top:119.73px" class="cls_041"><span class="cls_041">e</span></div>
<div style="position:absolute;left:298.13px;top:119.73px" class="cls_041"><span class="cls_041">s</span></div>
<div style="position:absolute;left:338.43px;top:119.73px" class="cls_041"><span class="cls_041">d</span></div>
<div style="position:absolute;left:358.57px;top:119.73px" class="cls_041"><span class="cls_041">o</span></div>
<div style="position:absolute;left:398.86px;top:119.73px" class="cls_041"><span class="cls_041">|</span></div>
<div style="position:absolute;left:419.01px;top:119.73px" class="cls_041"><span class="cls_041">n</span></div>
<div style="position:absolute;left:439.15px;top:119.73px" class="cls_041"><span class="cls_041">|</span></div>
<div style="position:absolute;left:145.01px;top:126.35px" class="cls_043"><span class="cls_043">10</span></div>
<div style="position:absolute;left:123.00px;top:151.76px" class="cls_038"><span class="cls_038">Figure 1-9: Ruby converts the period character into a token.</span></div>
<div style="position:absolute;left:141.00px;top:174.26px" class="cls_007"><span class="cls_007">Next, in Figure 1-10, Ruby encounters the word </span><span class="cls_008">times</span><span class="cls_007"> and creates an</span></div>
<div style="position:absolute;left:123.00px;top:186.26px" class="cls_007"><span class="cls_007">identifier token.</span></div>
<div style="position:absolute;left:131.60px;top:235.08px" class="cls_042"><span class="cls_042">tINTEGER</span></div>
<div style="position:absolute;left:218.71px;top:235.08px" class="cls_042"><span class="cls_042">tIDENTIFIER</span></div>
<div style="position:absolute;left:291.18px;top:239.70px" class="cls_041"><span class="cls_041">d</span></div>
<div style="position:absolute;left:311.32px;top:239.70px" class="cls_041"><span class="cls_041">o</span></div>
<div style="position:absolute;left:351.61px;top:239.70px" class="cls_041"><span class="cls_041">|</span></div>
<div style="position:absolute;left:371.76px;top:239.70px" class="cls_041"><span class="cls_041">n</span></div>
<div style="position:absolute;left:391.90px;top:239.70px" class="cls_041"><span class="cls_041">|</span></div>
<div style="position:absolute;left:145.01px;top:246.33px" class="cls_043"><span class="cls_043">10</span></div>
<div style="position:absolute;left:235.26px;top:246.33px" class="cls_043"><span class="cls_043">times</span></div>
<div style="position:absolute;left:123.00px;top:271.73px" class="cls_038"><span class="cls_038">Figure 1-10: Ruby tokenizes the word </span><span class="cls_039">times</span><span class="cls_038">.</span></div>
<div style="position:absolute;left:141.00px;top:294.23px" class="cls_008"><span class="cls_008">Identifiers</span><span class="cls_007"> are words in your Ruby code that are not reserved words.</span></div>
<div style="position:absolute;left:123.00px;top:306.23px" class="cls_007"><span class="cls_007">Identifiers usually refer to variable, method, or class names.</span></div>
<div style="position:absolute;left:141.00px;top:318.23px" class="cls_007"><span class="cls_007">Next, Ruby sees </span><span class="cls_008">do</span><span class="cls_007"> and creates a reserved word token, as indicated by</span></div>
<div style="position:absolute;left:123.00px;top:330.23px" class="cls_030"><span class="cls_030">keyword_do</span><span class="cls_007"> in Figure 1-11.</span></div>
<div style="position:absolute;left:131.60px;top:379.06px" class="cls_042"><span class="cls_042">tINTEGER</span></div>
<div style="position:absolute;left:218.71px;top:379.06px" class="cls_042"><span class="cls_042">tIDENTIFIER</span></div>
<div style="position:absolute;left:293.52px;top:381.82px" class="cls_042"><span class="cls_042">keyword_do</span></div>
<div style="position:absolute;left:363.61px;top:383.68px" class="cls_041"><span class="cls_041">|</span></div>
<div style="position:absolute;left:383.76px;top:383.68px" class="cls_041"><span class="cls_041">n</span></div>
<div style="position:absolute;left:403.90px;top:383.68px" class="cls_041"><span class="cls_041">|</span></div>
<div style="position:absolute;left:145.01px;top:390.31px" class="cls_043"><span class="cls_043">10</span></div>
<div style="position:absolute;left:235.26px;top:390.31px" class="cls_043"><span class="cls_043">times</span></div>
<div style="position:absolute;left:123.00px;top:415.71px" class="cls_038"><span class="cls_038">Figure 1-11: Ruby creates a reserved word token: </span><span class="cls_014">keyword_do</span><span class="cls_038">.</span></div>
<div style="position:absolute;left:141.00px;top:438.21px" class="cls_008"><span class="cls_008">Reserved words</span><span class="cls_007"> are keywords that carry significant meaning in Ruby</span></div>
<div style="position:absolute;left:123.00px;top:450.21px" class="cls_007"><span class="cls_007">because they provide the structure, or framework, of the language. They</span></div>
<div style="position:absolute;left:123.00px;top:462.21px" class="cls_007"><span class="cls_007">are called </span><span class="cls_008">reserved words</span><span class="cls_007"> because you can’t use them as normal identifiers,</span></div>
<div style="position:absolute;left:123.00px;top:474.21px" class="cls_007"><span class="cls_007">although you can use them as method names, global variable names (such</span></div>
<div style="position:absolute;left:123.00px;top:486.21px" class="cls_007"><span class="cls_007">as </span><span class="cls_030">$do</span><span class="cls_007">), or instance variable names (for example, </span><span class="cls_030">@do</span><span class="cls_007"> or </span><span class="cls_030">@@do</span><span class="cls_007">).</span></div>
<div style="position:absolute;left:141.00px;top:498.21px" class="cls_007"><span class="cls_007">Internally, the Ruby C code maintains a constant table of reserved</span></div>
<div style="position:absolute;left:123.00px;top:510.21px" class="cls_007"><span class="cls_007">words. Listing 1-3 shows the first few, in alphabetical order.</span></div>
<div style="position:absolute;left:123.00px;top:534.21px" class="cls_030"><span class="cls_030">alias</span></div>
<div style="position:absolute;left:123.00px;top:544.71px" class="cls_030"><span class="cls_030">and</span></div>
<div style="position:absolute;left:123.00px;top:555.20px" class="cls_030"><span class="cls_030">begin</span></div>
<div style="position:absolute;left:123.00px;top:565.70px" class="cls_030"><span class="cls_030">break</span></div>
<div style="position:absolute;left:123.00px;top:576.20px" class="cls_030"><span class="cls_030">case</span></div>
<div style="position:absolute;left:123.00px;top:586.70px" class="cls_030"><span class="cls_030">class</span></div>
<div style="position:absolute;left:123.00px;top:609.19px" class="cls_038"><span class="cls_038">Listing 1-3: The first few reserved words, listed alphabetically</span></div>
<div style="position:absolute;left:370.48px;top:636.00px" class="cls_021"><span class="cls_021">Tokenization and Parsing</span></div>
<div style="position:absolute;left:451.59px;top:633.00px" class="cls_020"><span class="cls_020">7</span></div>
</div>
<div style="position:absolute;left:50%;margin-left:-252px;top:18928px;width:504px;height:666px;border-style:outset;overflow:hidden">
<div style="position:absolute;left:0px;top:0px">
<img src="e698b76e-46bd-11eb-8b25-0cc47a792c0a_id_e698b76e-46bd-11eb-8b25-0cc47a792c0a_files/background032.jpg" width=504 height=666></div>
<div style="position:absolute;left:200.65px;top:61.22px" class="cls_020"><span class="cls_020">The parser_yylex Function</span></div>
<div style="position:absolute;left:120.50px;top:79.72px" class="cls_039"><span class="cls_039">If you’re familiar with C and are interested in learning more about the detailed way</span></div>
<div style="position:absolute;left:120.50px;top:91.72px" class="cls_039"><span class="cls_039">in which Ruby tokenizes your code file, see the </span><span class="cls_044">parse.y</span><span class="cls_039"> file in your version of Ruby.</span></div>
<div style="position:absolute;left:120.50px;top:103.72px" class="cls_039"><span class="cls_039">The </span><span class="cls_044">.y</span><span class="cls_039"> extension indicates that </span><span class="cls_044">parse.y</span><span class="cls_039"> is a </span><span class="cls_044">grammar rule file</span><span class="cls_039">—one that contains a</span></div>
<div style="position:absolute;left:120.50px;top:115.72px" class="cls_039"><span class="cls_039">series of rules for the Ruby parser engine. (I’ll discuss these in the next section.)</span></div>
<div style="position:absolute;left:120.50px;top:127.72px" class="cls_044"><span class="cls_044">parse.y</span><span class="cls_039"> is an extremely large and complex file with over 10,000 lines of code!</span></div>
<div style="position:absolute;left:138.50px;top:139.72px" class="cls_039"><span class="cls_039">For now, ignore the grammar rules, and search for a C function called </span><span class="cls_009">parser_</span></div>
<div style="position:absolute;left:120.50px;top:151.72px" class="cls_009"><span class="cls_009">yylex</span><span class="cls_039">, about two-thirds of the way down the file, around line 6500. This complex C</span></div>
<div style="position:absolute;left:120.50px;top:163.72px" class="cls_039"><span class="cls_039">function contains the code that actually tokenizes your code. Look closely and you</span></div>
<div style="position:absolute;left:120.50px;top:175.72px" class="cls_039"><span class="cls_039">should see a very large </span><span class="cls_009">switch</span><span class="cls_039"> statement that starts with the code shown in Listing 1-4.</span></div>
<div style="position:absolute;left:110.00px;top:198.22px" class="cls_045"><span class="cls_045">u</span><span class="cls_009"> retry:</span></div>
<div style="position:absolute;left:110.00px;top:207.72px" class="cls_045"><span class="cls_045">v</span><span class="cls_009"> last_state = lex_state;</span></div>
<div style="position:absolute;left:110.00px;top:217.22px" class="cls_045"><span class="cls_045">w</span><span class="cls_009"> switch (c = nextc()) {</span></div>
<div style="position:absolute;left:120.50px;top:239.72px" class="cls_043"><span class="cls_043">Listing 1-4: The C code inside Ruby that reads in each character from your code file</span></div>
<div style="position:absolute;left:138.50px;top:262.72px" class="cls_039"><span class="cls_039">The </span><span class="cls_009">nextc()</span><span class="cls_039"> function </span><span class="cls_046">w</span><span class="cls_039"> returns the next character in the code file text stream.</span></div>
<div style="position:absolute;left:120.50px;top:274.72px" class="cls_039"><span class="cls_039">Think of this function as the arrow in the previous diagrams. The </span><span class="cls_009">lex_state</span><span class="cls_039"> variable</span></div>
<div style="position:absolute;left:120.50px;top:286.72px" class="cls_046"><span class="cls_046">v</span><span class="cls_039"> keeps information about what state or type of code Ruby is processing at the</span></div>
<div style="position:absolute;left:120.50px;top:298.72px" class="cls_039"><span class="cls_039">moment.</span></div>
<div style="position:absolute;left:138.50px;top:310.72px" class="cls_039"><span class="cls_039">The large </span><span class="cls_009">switch</span><span class="cls_039"> statement inspects each character of your code file and takes</span></div>
<div style="position:absolute;left:120.50px;top:322.72px" class="cls_039"><span class="cls_039">a different action based on what it is. For example, the code shown in Listing 1-5</span></div>
<div style="position:absolute;left:120.50px;top:334.72px" class="cls_039"><span class="cls_039">looks for whitespace characters and ignores them by jumping back up to the </span><span class="cls_009">retry</span></div>
<div style="position:absolute;left:120.50px;top:346.72px" class="cls_039"><span class="cls_039">label </span><span class="cls_046">u</span><span class="cls_039"> just above the </span><span class="cls_009">switch</span><span class="cls_039"> statement in Listing 1-4.</span></div>
<div style="position:absolute;left:128.00px;top:369.22px" class="cls_009"><span class="cls_009">/* white spaces */</span></div>
<div style="position:absolute;left:120.50px;top:378.72px" class="cls_009"><span class="cls_009">case ' ': case '\t': case '\f': case '\r':</span></div>
<div style="position:absolute;left:120.50px;top:388.22px" class="cls_009"><span class="cls_009">case '\13': /* '\v' */</span></div>
<div style="position:absolute;left:128.00px;top:397.73px" class="cls_009"><span class="cls_009">space_seen = 1;</span></div>
<div style="position:absolute;left:120.50px;top:407.23px" class="cls_009"><span class="cls_009">--snip--</span></div>
<div style="position:absolute;left:128.00px;top:416.73px" class="cls_009"><span class="cls_009">goto retry;</span></div>
<div style="position:absolute;left:120.50px;top:439.23px" class="cls_043"><span class="cls_043">Listing 1-5: This C code checks for whitespace characters in your code and ignores them.</span></div>
<div style="position:absolute;left:138.50px;top:462.22px" class="cls_039"><span class="cls_039">Ruby’s reserved words are defined in the file called </span><span class="cls_044">defs/keywords</span><span class="cls_039">. If you open</span></div>
<div style="position:absolute;left:120.50px;top:474.22px" class="cls_039"><span class="cls_039">this file, you’ll see a complete list of all of Ruby’s reserved words (see a partial list</span></div>
<div style="position:absolute;left:120.50px;top:486.22px" class="cls_039"><span class="cls_039">in Listing 1-3). The </span><span class="cls_044">keywords</span><span class="cls_039"> file is used by an open source package called </span><span class="cls_044">gperf</span><span class="cls_039"> to</span></div>
<div style="position:absolute;left:120.50px;top:498.22px" class="cls_039"><span class="cls_039">produce C code that can quickly and efficiently look up strings in a table—in this</span></div>
<div style="position:absolute;left:120.50px;top:510.22px" class="cls_039"><span class="cls_039">case, a table of reserved words. You can find the generated C code that looks up</span></div>
<div style="position:absolute;left:120.50px;top:522.22px" class="cls_039"><span class="cls_039">reserved words in </span><span class="cls_044">lex.c</span><span class="cls_039">, which defines a function named </span><span class="cls_009">rb_reserved_word</span><span class="cls_039">, called</span></div>
<div style="position:absolute;left:120.50px;top:534.22px" class="cls_039"><span class="cls_039">from </span><span class="cls_044">parse.y</span><span class="cls_039">.</span></div>
<div style="position:absolute;left:138.50px;top:546.22px" class="cls_039"><span class="cls_039">One final detail about tokenization: Ruby doesn’t use the Lex tokenization tool</span></div>
<div style="position:absolute;left:120.50px;top:558.22px" class="cls_039"><span class="cls_039">that C programmers commonly use in conjunction with a parser generator like Yacc</span></div>
<div style="position:absolute;left:120.50px;top:570.23px" class="cls_039"><span class="cls_039">or Bison. Instead, the Ruby core team wrote the Ruby tokenization code by hand for</span></div>
<div style="position:absolute;left:120.50px;top:582.23px" class="cls_039"><span class="cls_039">performance reasons.</span></div>
<div style="position:absolute;left:48.00px;top:633.00px" class="cls_020"><span class="cls_020">8</span></div>
<div style="position:absolute;left:65.38px;top:636.00px" class="cls_021"><span class="cls_021">Chapter 1</span></div>
</div>
<div style="position:absolute;left:50%;margin-left:-252px;top:19604px;width:504px;height:666px;border-style:outset;overflow:hidden">
<div style="position:absolute;left:0px;top:0px">
<img src="e698b76e-46bd-11eb-8b25-0cc47a792c0a_id_e698b76e-46bd-11eb-8b25-0cc47a792c0a_files/background033.jpg" width=504 height=666></div>
<div style="position:absolute;left:141.00px;top:42.28px" class="cls_007"><span class="cls_007">Finally, as shown in Figure 1-12, Ruby converts the remaining charac-</span></div>
<div style="position:absolute;left:123.00px;top:54.28px" class="cls_007"><span class="cls_007">ters to tokens.</span></div>
<div style="position:absolute;left:130.96px;top:82.77px" class="cls_047"><span class="cls_047">tINTEGER</span></div>
<div style="position:absolute;left:211.34px;top:82.77px" class="cls_047"><span class="cls_047">tIDENTIFIER</span></div>
<div style="position:absolute;left:372.67px;top:82.77px" class="cls_047"><span class="cls_047">tIDENTIFIER</span></div>
<div style="position:absolute;left:280.41px;top:87.07px" class="cls_047"><span class="cls_047">keyword_do</span></div>
<div style="position:absolute;left:346.77px;top:88.04px" class="cls_049"><span class="cls_049">|</span></div>
<div style="position:absolute;left:441.63px;top:88.04px" class="cls_049"><span class="cls_049">|</span></div>
<div style="position:absolute;left:143.22px;top:93.16px" class="cls_048"><span class="cls_048">10</span></div>
<div style="position:absolute;left:226.61px;top:93.16px" class="cls_048"><span class="cls_048">times</span></div>
<div style="position:absolute;left:393.69px;top:93.16px" class="cls_048"><span class="cls_048">n</span></div>
<div style="position:absolute;left:123.00px;top:117.22px" class="cls_038"><span class="cls_038">Figure 1-12: Ruby finishes tokenizing the first line of text.</span></div>
<div style="position:absolute;left:141.00px;top:139.72px" class="cls_007"><span class="cls_007">Ruby continues to step through your code until it has tokenized the</span></div>
<div style="position:absolute;left:123.00px;top:151.72px" class="cls_007"><span class="cls_007">entire Ruby script. At this point, it has processed your code for the first</span></div>
<div style="position:absolute;left:123.00px;top:163.72px" class="cls_007"><span class="cls_007">time, ripping it apart and putting it back together again in a completely</span></div>
<div style="position:absolute;left:123.00px;top:175.72px" class="cls_007"><span class="cls_007">different way. Your code began as a stream of text characters, and Ruby</span></div>
<div style="position:absolute;left:123.00px;top:187.72px" class="cls_007"><span class="cls_007">converted it to a stream of tokens, words that it will later combine into</span></div>
<div style="position:absolute;left:123.00px;top:199.72px" class="cls_007"><span class="cls_007">sentences.</span></div>
<div style="position:absolute;left:123.00px;top:233.72px" class="cls_031"><span class="cls_031">Experiment 1-1: Using Ripper to Tokenize Different</span></div>
<div style="position:absolute;left:123.00px;top:248.72px" class="cls_031"><span class="cls_031">Ruby Scripts</span></div>
<div style="position:absolute;left:123.00px;top:268.72px" class="cls_007"><span class="cls_007">Now that we’ve learned the basic idea behind tokenization, let’s look at how</span></div>
<div style="position:absolute;left:123.00px;top:280.72px" class="cls_007"><span class="cls_007">Ruby actually tokenizes different Ruby scripts. After all, how else will you</span></div>
<div style="position:absolute;left:123.00px;top:292.72px" class="cls_007"><span class="cls_007">know that the previous explanation is actually correct?</span></div>
<div style="position:absolute;left:141.00px;top:304.72px" class="cls_007"><span class="cls_007">As it turns out, a tool called </span><span class="cls_008">Ripper</span><span class="cls_007"> makes it very easy to see what tokens</span></div>
<div style="position:absolute;left:123.00px;top:316.72px" class="cls_007"><span class="cls_007">Ruby creates for different code files. Shipped with Ruby 1.9 and Ruby 2.x,</span></div>
<div style="position:absolute;left:123.00px;top:328.72px" class="cls_007"><span class="cls_007">the </span><span class="cls_030">Ripper</span><span class="cls_007"> class allows you to call the same tokenization and parsing code</span></div>
<div style="position:absolute;left:123.00px;top:340.72px" class="cls_007"><span class="cls_007">that Ruby uses to process text from code files. (Ripper is not available in</span></div>
<div style="position:absolute;left:123.00px;top:352.72px" class="cls_007"><span class="cls_007">Ruby 1.8.)</span></div>
<div style="position:absolute;left:141.00px;top:364.72px" class="cls_007"><span class="cls_007">Listing 1-6 shows how simple using Ripper is.</span></div>
<div style="position:absolute;left:123.00px;top:388.72px" class="cls_030"><span class="cls_030">require 'ripper'</span></div>
<div style="position:absolute;left:123.00px;top:399.22px" class="cls_030"><span class="cls_030">require 'pp'</span></div>
<div style="position:absolute;left:123.00px;top:409.72px" class="cls_030"><span class="cls_030">code = &lt;&lt;STR</span></div>
<div style="position:absolute;left:123.00px;top:420.22px" class="cls_030"><span class="cls_030">10.times do |n|</span></div>
<div style="position:absolute;left:131.50px;top:430.71px" class="cls_030"><span class="cls_030">puts n</span></div>
<div style="position:absolute;left:123.00px;top:441.21px" class="cls_030"><span class="cls_030">end</span></div>
<div style="position:absolute;left:123.00px;top:451.71px" class="cls_030"><span class="cls_030">STR</span></div>
<div style="position:absolute;left:123.00px;top:462.21px" class="cls_030"><span class="cls_030">puts code</span></div>
<div style="position:absolute;left:111.15px;top:472.70px" class="cls_046"><span class="cls_046">u</span><span class="cls_030"> pp Ripper.lex(code)</span></div>
<div style="position:absolute;left:123.00px;top:495.20px" class="cls_038"><span class="cls_038">Listing 1-6: An example of how to call </span><span class="cls_014">Ripper.lex</span><span class="cls_038"> </span><span class="cls_039">(lex1.rb)</span></div>
<div style="position:absolute;left:141.00px;top:517.72px" class="cls_007"><span class="cls_007">After requiring the Ripper code from the standard library, you call it by</span></div>
<div style="position:absolute;left:123.00px;top:529.72px" class="cls_007"><span class="cls_007">passing some code as a string to the </span><span class="cls_030">Ripper.lex</span><span class="cls_007"> method </span><span class="cls_050">u</span><span class="cls_007">. Listing 1-7 shows</span></div>
<div style="position:absolute;left:123.00px;top:541.72px" class="cls_007"><span class="cls_007">the output from Ripper.</span></div>
<div style="position:absolute;left:123.00px;top:565.72px" class="cls_030"><span class="cls_030">$ </span><span class="cls_040">ruby lex1.rb</span></div>
<div style="position:absolute;left:123.00px;top:576.22px" class="cls_030"><span class="cls_030">10.times do |n|</span></div>
<div style="position:absolute;left:131.50px;top:586.72px" class="cls_030"><span class="cls_030">puts n</span></div>
<div style="position:absolute;left:123.00px;top:597.22px" class="cls_030"><span class="cls_030">end</span></div>
<div style="position:absolute;left:111.15px;top:607.71px" class="cls_046"><span class="cls_046">u</span><span class="cls_030"> [[[1, 0], :on_int, "10"],</span></div>
<div style="position:absolute;left:370.48px;top:636.00px" class="cls_021"><span class="cls_021">Tokenization and Parsing</span></div>
<div style="position:absolute;left:451.59px;top:633.00px" class="cls_020"><span class="cls_020">9</span></div>
</div>
<div style="position:absolute;left:50%;margin-left:-252px;top:20280px;width:504px;height:666px;border-style:outset;overflow:hidden">
<div style="position:absolute;left:0px;top:0px">
<img src="e698b76e-46bd-11eb-8b25-0cc47a792c0a_id_e698b76e-46bd-11eb-8b25-0cc47a792c0a_files/background034.jpg" width=504 height=666></div>
<div style="position:absolute;left:124.25px;top:42.64px" class="cls_030"><span class="cls_030">[[1, 2], :on_period, "."],</span></div>
<div style="position:absolute;left:108.15px;top:53.14px" class="cls_046"><span class="cls_046">v</span><span class="cls_030">  [[1, 3], :on_ident, "times"],</span></div>
<div style="position:absolute;left:124.25px;top:63.64px" class="cls_030"><span class="cls_030">[[1, 8], :on_sp, " "],</span></div>
<div style="position:absolute;left:124.25px;top:74.14px" class="cls_030"><span class="cls_030">[[1, 9], :on_kw, "do"],</span></div>
<div style="position:absolute;left:124.25px;top:84.63px" class="cls_030"><span class="cls_030">[[1, 11], :on_sp, " "],</span></div>
<div style="position:absolute;left:124.25px;top:95.13px" class="cls_030"><span class="cls_030">[[1, 12], :on_op, "|"],</span></div>
<div style="position:absolute;left:124.25px;top:105.63px" class="cls_030"><span class="cls_030">[[1, 13], :on_ident, "n"],</span></div>
<div style="position:absolute;left:124.25px;top:116.13px" class="cls_030"><span class="cls_030">[[1, 14], :on_op, "|"],</span></div>
<div style="position:absolute;left:124.25px;top:126.62px" class="cls_030"><span class="cls_030">[[1, 15], :on_ignored_nl, "\n"],</span></div>
<div style="position:absolute;left:124.25px;top:137.12px" class="cls_030"><span class="cls_030">[[2, 0], :on_sp, "  "],</span></div>
<div style="position:absolute;left:124.25px;top:147.62px" class="cls_030"><span class="cls_030">[[2, 2], :on_ident, "puts"],</span></div>
<div style="position:absolute;left:124.25px;top:158.12px" class="cls_030"><span class="cls_030">[[2, 6], :on_sp, " "],</span></div>
<div style="position:absolute;left:124.25px;top:168.61px" class="cls_030"><span class="cls_030">[[2, 7], :on_ident, "n"],</span></div>
<div style="position:absolute;left:124.25px;top:179.11px" class="cls_030"><span class="cls_030">[[2, 8], :on_nl, "\n"],</span></div>
<div style="position:absolute;left:124.25px;top:189.61px" class="cls_030"><span class="cls_030">[[3, 0], :on_kw, "end"],</span></div>
<div style="position:absolute;left:124.25px;top:200.11px" class="cls_030"><span class="cls_030">[[3, 3], :on_nl, "\n"]]</span></div>
<div style="position:absolute;left:120.00px;top:222.60px" class="cls_038"><span class="cls_038">Listing 1-7: The output generated by </span><span class="cls_014">Ripper.lex</span></div>
<div style="position:absolute;left:138.00px;top:245.14px" class="cls_007"><span class="cls_007">Each line corresponds to a single token that Ruby found in your code</span></div>
<div style="position:absolute;left:120.00px;top:257.14px" class="cls_007"><span class="cls_007">string. On the left, we have the line number (</span><span class="cls_030">1</span><span class="cls_007">, </span><span class="cls_030">2</span><span class="cls_007">, or </span><span class="cls_030">3</span><span class="cls_007"> in this short example)</span></div>
<div style="position:absolute;left:120.00px;top:269.14px" class="cls_007"><span class="cls_007">and the text column number. Next, we see the token itself displayed as a</span></div>
<div style="position:absolute;left:120.00px;top:281.14px" class="cls_007"><span class="cls_007">symbol, such as </span><span class="cls_030">:on_int</span><span class="cls_007"> </span><span class="cls_050">u</span><span class="cls_007"> or </span><span class="cls_030">:on_ident</span><span class="cls_007"> </span><span class="cls_050">v</span><span class="cls_007">. Finally, Ripper displays the text</span></div>
<div style="position:absolute;left:120.01px;top:293.14px" class="cls_007"><span class="cls_007">characters that correspond to each token.</span></div>
<div style="position:absolute;left:138.01px;top:305.14px" class="cls_007"><span class="cls_007">The token symbols that Ripper displays are somewhat different from</span></div>
<div style="position:absolute;left:120.01px;top:317.14px" class="cls_007"><span class="cls_007">the token identifiers I used in Figures 1-2 through 1-12 that showed Ruby</span></div>
<div style="position:absolute;left:120.01px;top:329.14px" class="cls_007"><span class="cls_007">tokenizing the </span><span class="cls_030">10.times do</span><span class="cls_007"> code. I used the same names you would find in</span></div>
<div style="position:absolute;left:120.00px;top:341.14px" class="cls_007"><span class="cls_007">Ruby’s internal parse code, such as </span><span class="cls_030">tIDENTIFIER</span><span class="cls_007">, while Ripper used </span><span class="cls_030">:on_ident</span></div>
<div style="position:absolute;left:120.00px;top:353.14px" class="cls_007"><span class="cls_007">instead.</span></div>
<div style="position:absolute;left:138.00px;top:365.14px" class="cls_007"><span class="cls_007">Regardless, Ripper will still give you a sense of what tokens Ruby finds</span></div>
<div style="position:absolute;left:120.00px;top:377.14px" class="cls_007"><span class="cls_007">in your code and how tokenization works.</span></div>
<div style="position:absolute;left:138.00px;top:389.14px" class="cls_007"><span class="cls_007">Listing 1-8 shows another example of using Ripper.</span></div>
<div style="position:absolute;left:120.00px;top:413.14px" class="cls_030"><span class="cls_030">$ </span><span class="cls_040">ruby lex2.rb</span></div>
<div style="position:absolute;left:120.00px;top:423.64px" class="cls_030"><span class="cls_030">10.times do |n|</span></div>
<div style="position:absolute;left:128.50px;top:434.14px" class="cls_030"><span class="cls_030">puts n/4+6</span></div>
<div style="position:absolute;left:120.00px;top:444.64px" class="cls_030"><span class="cls_030">end</span></div>
<div style="position:absolute;left:120.00px;top:455.13px" class="cls_030"><span class="cls_030">--snip--</span></div>
<div style="position:absolute;left:124.25px;top:465.63px" class="cls_030"><span class="cls_030">[[2, 2], :on_ident, "puts"],</span></div>
<div style="position:absolute;left:124.25px;top:476.13px" class="cls_030"><span class="cls_030">[[2, 6], :on_sp, " "],</span></div>
<div style="position:absolute;left:124.25px;top:486.63px" class="cls_030"><span class="cls_030">[[2, 7], :on_ident, "n"],</span></div>
<div style="position:absolute;left:124.25px;top:497.12px" class="cls_030"><span class="cls_030">[[2, 8], :on_op, "/"],</span></div>
<div style="position:absolute;left:124.25px;top:507.62px" class="cls_030"><span class="cls_030">[[2, 9], :on_int, "4"],</span></div>
<div style="position:absolute;left:124.25px;top:518.12px" class="cls_030"><span class="cls_030">[[2, 10], :on_op, "+"],</span></div>
<div style="position:absolute;left:124.25px;top:528.62px" class="cls_030"><span class="cls_030">[[2, 11], :on_int, "6"],</span></div>
<div style="position:absolute;left:124.25px;top:539.11px" class="cls_030"><span class="cls_030">[[2, 12], :on_nl, "\n"],</span></div>
<div style="position:absolute;left:120.00px;top:549.61px" class="cls_030"><span class="cls_030">--snip--</span></div>
<div style="position:absolute;left:120.00px;top:572.11px" class="cls_038"><span class="cls_038">Listing 1-8: Another example of using </span><span class="cls_014">Ripper.lex</span></div>
<div style="position:absolute;left:48.00px;top:633.00px" class="cls_020"><span class="cls_020">10</span></div>
<div style="position:absolute;left:69.62px;top:636.00px" class="cls_021"><span class="cls_021">Chapter 1</span></div>
</div>
<div style="position:absolute;left:50%;margin-left:-252px;top:20956px;width:504px;height:666px;border-style:outset;overflow:hidden">
<div style="position:absolute;left:0px;top:0px">
<img src="e698b76e-46bd-11eb-8b25-0cc47a792c0a_id_e698b76e-46bd-11eb-8b25-0cc47a792c0a_files/background035.jpg" width=504 height=666></div>
<div style="position:absolute;left:141.00px;top:42.28px" class="cls_007"><span class="cls_007">This time Ruby converts the expression </span><span class="cls_030">n/4+6</span><span class="cls_007"> into a series of tokens in a</span></div>
<div style="position:absolute;left:123.00px;top:54.28px" class="cls_007"><span class="cls_007">very straightforward way. The tokens appear in exactly the same order they</span></div>
<div style="position:absolute;left:123.00px;top:66.28px" class="cls_007"><span class="cls_007">did inside the code file.</span></div>
<div style="position:absolute;left:141.00px;top:78.28px" class="cls_007"><span class="cls_007">Listing 1-9 shows a third, slightly more complex example.</span></div>
<div style="position:absolute;left:123.00px;top:102.28px" class="cls_030"><span class="cls_030">$ </span><span class="cls_040">ruby lex3.rb</span></div>
<div style="position:absolute;left:123.00px;top:112.78px" class="cls_030"><span class="cls_030">array = []</span></div>
<div style="position:absolute;left:123.00px;top:123.27px" class="cls_030"><span class="cls_030">10.times do |n|</span></div>
<div style="position:absolute;left:131.50px;top:133.77px" class="cls_030"><span class="cls_030">array &lt;&lt; n if n &lt; 5</span></div>
<div style="position:absolute;left:123.00px;top:144.27px" class="cls_030"><span class="cls_030">end</span></div>
<div style="position:absolute;left:123.00px;top:154.77px" class="cls_030"><span class="cls_030">p array</span></div>
<div style="position:absolute;left:123.00px;top:165.26px" class="cls_030"><span class="cls_030">--snip--</span></div>
<div style="position:absolute;left:127.25px;top:175.76px" class="cls_030"><span class="cls_030">[[3, 2], :on_ident, "array"],</span></div>
<div style="position:absolute;left:127.25px;top:186.26px" class="cls_030"><span class="cls_030">[[3, 7], :on_sp, " "],</span></div>
<div style="position:absolute;left:111.15px;top:196.76px" class="cls_046"><span class="cls_046">u</span><span class="cls_030">  [[3, 8], :on_op, "&lt;&lt;"],</span></div>
<div style="position:absolute;left:127.25px;top:207.26px" class="cls_030"><span class="cls_030">[[3, 10], :on_sp, " "],</span></div>
<div style="position:absolute;left:127.25px;top:217.75px" class="cls_030"><span class="cls_030">[[3, 11], :on_ident, "n"],</span></div>
<div style="position:absolute;left:127.25px;top:228.25px" class="cls_030"><span class="cls_030">[[3, 12], :on_sp, " "],</span></div>
<div style="position:absolute;left:127.25px;top:238.75px" class="cls_030"><span class="cls_030">[[3, 13], :on_kw, "if"],</span></div>
<div style="position:absolute;left:127.25px;top:249.24px" class="cls_030"><span class="cls_030">[[3, 15], :on_sp, " "],</span></div>
<div style="position:absolute;left:127.25px;top:259.74px" class="cls_030"><span class="cls_030">[[3, 16], :on_ident, "n"],</span></div>
<div style="position:absolute;left:127.25px;top:270.24px" class="cls_030"><span class="cls_030">[[3, 17], :on_sp, " "],</span></div>
<div style="position:absolute;left:111.15px;top:280.74px" class="cls_046"><span class="cls_046">v</span><span class="cls_030">  [[3, 18], :on_op, "&lt;"],</span></div>
<div style="position:absolute;left:127.25px;top:291.23px" class="cls_030"><span class="cls_030">[[3, 19], :on_sp, " "],</span></div>
<div style="position:absolute;left:127.25px;top:301.73px" class="cls_030"><span class="cls_030">[[3, 20], :on_int, "5"],</span></div>
<div style="position:absolute;left:123.00px;top:312.23px" class="cls_030"><span class="cls_030">--snip--</span></div>
<div style="position:absolute;left:123.00px;top:334.73px" class="cls_038"><span class="cls_038">Listing 1-9: A third example of running </span><span class="cls_014">Ripper.lex</span></div>
<div style="position:absolute;left:141.00px;top:357.28px" class="cls_007"><span class="cls_007">As you can see, Ruby is smart enough to distinguish between </span><span class="cls_030">&lt;&lt;</span><span class="cls_007"> and </span><span class="cls_030">&lt;</span></div>
<div style="position:absolute;left:123.00px;top:369.28px" class="cls_007"><span class="cls_007">in the following line: </span><span class="cls_030">array &lt;&lt; n if n &lt; 5</span><span class="cls_007">. The characters </span><span class="cls_030">&lt;&lt;</span><span class="cls_007"> are converted to</span></div>
<div style="position:absolute;left:123.00px;top:381.28px" class="cls_007"><span class="cls_007">a single operator token </span><span class="cls_050">u</span><span class="cls_007">, while the single </span><span class="cls_030">&lt;</span><span class="cls_007"> character that appears later is</span></div>
<div style="position:absolute;left:123.00px;top:393.28px" class="cls_007"><span class="cls_007">converted into a simple less-than operator </span><span class="cls_050">v</span><span class="cls_007">. Ruby’s tokenize code is smart</span></div>
<div style="position:absolute;left:123.00px;top:405.28px" class="cls_007"><span class="cls_007">enough to look ahead for a second </span><span class="cls_030">&lt;</span><span class="cls_007"> character when it finds one </span><span class="cls_030">&lt;</span><span class="cls_007">.</span></div>
<div style="position:absolute;left:141.00px;top:417.28px" class="cls_007"><span class="cls_007">Finally, notice that Ripper has no idea whether the code you give it is</span></div>
<div style="position:absolute;left:123.00px;top:429.28px" class="cls_007"><span class="cls_007">valid Ruby or not. If you pass in code that contains a syntax error, Ripper.lex</span></div>
<div style="position:absolute;left:123.00px;top:441.28px" class="cls_007"><span class="cls_007">will just tokenize it as usual and not complain. It’s the parser’s job to check</span></div>
<div style="position:absolute;left:123.00px;top:453.28px" class="cls_007"><span class="cls_007">syntax.</span></div>
<div style="position:absolute;left:141.00px;top:465.28px" class="cls_007"><span class="cls_007">Suppose you forget the </span><span class="cls_030">|</span><span class="cls_007"> symbol after the block parameter </span><span class="cls_030">n</span><span class="cls_007"> </span><span class="cls_050">u</span><span class="cls_007">, as</span></div>
<div style="position:absolute;left:123.00px;top:477.28px" class="cls_007"><span class="cls_007">shown in Listing 1-10.</span></div>
<div style="position:absolute;left:123.00px;top:501.28px" class="cls_030"><span class="cls_030">require 'ripper'</span></div>
<div style="position:absolute;left:123.00px;top:511.78px" class="cls_030"><span class="cls_030">require 'pp'</span></div>
<div style="position:absolute;left:123.00px;top:522.28px" class="cls_030"><span class="cls_030">code = &lt;&lt;STR</span></div>
<div style="position:absolute;left:111.15px;top:532.77px" class="cls_046"><span class="cls_046">u</span><span class="cls_030"> 10.times do |n</span></div>
<div style="position:absolute;left:131.50px;top:543.27px" class="cls_030"><span class="cls_030">puts n</span></div>
<div style="position:absolute;left:123.00px;top:553.77px" class="cls_030"><span class="cls_030">end</span></div>
<div style="position:absolute;left:123.00px;top:564.27px" class="cls_030"><span class="cls_030">STR</span></div>
<div style="position:absolute;left:123.00px;top:574.76px" class="cls_030"><span class="cls_030">puts code</span></div>
<div style="position:absolute;left:123.00px;top:585.26px" class="cls_030"><span class="cls_030">pp Ripper.lex(code)</span></div>
<div style="position:absolute;left:123.00px;top:607.76px" class="cls_038"><span class="cls_038">Listing 1-10: This code contains a syntax error.</span></div>
<div style="position:absolute;left:366.69px;top:636.00px" class="cls_021"><span class="cls_021">Tokenization and Parsing</span></div>
<div style="position:absolute;left:447.80px;top:633.00px" class="cls_020"><span class="cls_020">11</span></div>
</div>
<div style="position:absolute;left:50%;margin-left:-252px;top:21632px;width:504px;height:666px;border-style:outset;overflow:hidden">
<div style="position:absolute;left:0px;top:0px">
<img src="e698b76e-46bd-11eb-8b25-0cc47a792c0a_id_e698b76e-46bd-11eb-8b25-0cc47a792c0a_files/background036.jpg" width=504 height=666></div>
<div style="position:absolute;left:138.00px;top:41.60px" class="cls_007"><span class="cls_007">Running this, you get the output shown in Listing 1-11.</span></div>
<div style="position:absolute;left:120.00px;top:65.60px" class="cls_030"><span class="cls_030">$ </span><span class="cls_040">ruby lex4.rb</span></div>
<div style="position:absolute;left:120.00px;top:76.10px" class="cls_030"><span class="cls_030">10.times do |n</span></div>
<div style="position:absolute;left:128.50px;top:86.60px" class="cls_030"><span class="cls_030">puts n</span></div>
<div style="position:absolute;left:120.00px;top:97.09px" class="cls_030"><span class="cls_030">end</span></div>
<div style="position:absolute;left:120.00px;top:107.59px" class="cls_030"><span class="cls_030">--snip--</span></div>
<div style="position:absolute;left:120.00px;top:118.09px" class="cls_030"><span class="cls_030">[[[1, 0], :on_int, "10"],</span></div>
<div style="position:absolute;left:124.25px;top:128.59px" class="cls_030"><span class="cls_030">[[1, 2], :on_period, "."],</span></div>
<div style="position:absolute;left:124.25px;top:139.08px" class="cls_030"><span class="cls_030">[[1, 3], :on_ident, "times"],</span></div>
<div style="position:absolute;left:124.25px;top:149.58px" class="cls_030"><span class="cls_030">[[1, 8], :on_sp, " "],</span></div>
<div style="position:absolute;left:124.25px;top:160.08px" class="cls_030"><span class="cls_030">[[1, 9], :on_kw, "do"],</span></div>
<div style="position:absolute;left:124.25px;top:170.57px" class="cls_030"><span class="cls_030">[[1, 11], :on_sp, " "],</span></div>
<div style="position:absolute;left:124.25px;top:181.07px" class="cls_030"><span class="cls_030">[[1, 12], :on_op, "|"],</span></div>
<div style="position:absolute;left:124.25px;top:191.57px" class="cls_030"><span class="cls_030">[[1, 13], :on_ident, "n"],</span></div>
<div style="position:absolute;left:124.25px;top:202.07px" class="cls_030"><span class="cls_030">[[1, 14], :on_nl, "\n"],</span></div>
<div style="position:absolute;left:120.00px;top:212.57px" class="cls_030"><span class="cls_030">--snip--</span></div>
<div style="position:absolute;left:120.00px;top:235.06px" class="cls_038"><span class="cls_038">Listing 1-11: Ripper does not detect syntax errors.</span></div>
<div style="position:absolute;left:66.00px;top:267.60px" class="cls_031"><span class="cls_031">Parsing: How Ruby Understands Your Code</span></div>
<div style="position:absolute;left:120.00px;top:287.60px" class="cls_007"><span class="cls_007">Once Ruby converts your code into a series of tokens, what does it do next?</span></div>
<div style="position:absolute;left:120.00px;top:299.60px" class="cls_007"><span class="cls_007">How does it actually understand and run your program? Does Ruby simply</span></div>
<div style="position:absolute;left:120.00px;top:311.60px" class="cls_007"><span class="cls_007">step through the tokens and execute each one in order?</span></div>
<div style="position:absolute;left:138.00px;top:323.60px" class="cls_007"><span class="cls_007">No. Your code still has a long way to go before Ruby can run it. The</span></div>
<div style="position:absolute;left:120.00px;top:335.60px" class="cls_007"><span class="cls_007">next step on its journey through Ruby is called </span><span class="cls_008">parsing</span><span class="cls_007">, where words or</span></div>
<div style="position:absolute;left:120.00px;top:347.60px" class="cls_007"><span class="cls_007">tokens are grouped into sentences or phrases that make sense to Ruby.</span></div>
<div style="position:absolute;left:120.00px;top:359.60px" class="cls_007"><span class="cls_007">When parsing, Ruby takes into account the order of operations, methods,</span></div>
<div style="position:absolute;left:120.00px;top:371.60px" class="cls_007"><span class="cls_007">blocks, and other larger code structures.</span></div>
<div style="position:absolute;left:138.00px;top:383.60px" class="cls_007"><span class="cls_007">But how can Ruby actually understand what you’re telling it with your</span></div>
<div style="position:absolute;left:120.00px;top:395.60px" class="cls_007"><span class="cls_007">code? Like many programming languages, Ruby uses a </span><span class="cls_008">parser generator</span><span class="cls_007">. Ruby</span></div>
<div style="position:absolute;left:120.00px;top:407.60px" class="cls_007"><span class="cls_007">uses a parser to process tokens, but the parser itself</span></div>
<div style="position:absolute;left:120.00px;top:419.60px" class="cls_007"><span class="cls_007">is generated with a parser generator. Parser gen-</span></div>
<div style="position:absolute;left:120.00px;top:431.60px" class="cls_007"><span class="cls_007">erators take a series of grammar rules as input that</span></div>
<div style="position:absolute;left:120.00px;top:443.60px" class="cls_007"><span class="cls_007">describe the expected order and patterns in which</span></div>
<div style="position:absolute;left:120.00px;top:455.60px" class="cls_007"><span class="cls_007">the tokens will appear.</span></div>
<div style="position:absolute;left:138.00px;top:467.60px" class="cls_007"><span class="cls_007">The most widely used and well-known parser</span></div>
<div style="position:absolute;left:120.00px;top:479.60px" class="cls_007"><span class="cls_007">generator is Yacc (Yet Another Compiler Compiler),</span></div>
<div style="position:absolute;left:120.00px;top:491.60px" class="cls_007"><span class="cls_007">but Ruby uses a newer version of Yacc called </span><span class="cls_008">Bison</span><span class="cls_007">.</span></div>
<div style="position:absolute;left:120.00px;top:503.60px" class="cls_007"><span class="cls_007">The grammar rule file for Bison and Yacc has a</span></div>
<div style="position:absolute;left:120.00px;top:515.60px" class="cls_008"><span class="cls_008">.y</span><span class="cls_007"> extension. In the Ruby source code, the gram-</span></div>
<div style="position:absolute;left:120.00px;top:527.60px" class="cls_007"><span class="cls_007">mar rule file is </span><span class="cls_008">parse.y</span><span class="cls_007"> (introduced earlier). The</span></div>
<div style="position:absolute;left:120.00px;top:539.60px" class="cls_008"><span class="cls_008">parse.y</span><span class="cls_007"> file defines the actual syntax and grammar</span></div>
<div style="position:absolute;left:120.00px;top:551.60px" class="cls_007"><span class="cls_007">that you have to use while writing your Ruby code;</span></div>
<div style="position:absolute;left:120.00px;top:563.60px" class="cls_007"><span class="cls_007">it’s really the heart and soul of Ruby and where the</span></div>
<div style="position:absolute;left:362.45px;top:566.42px" class="cls_038"><span class="cls_038">Ruby uses an LALR parser</span></div>
<div style="position:absolute;left:120.00px;top:575.60px" class="cls_007"><span class="cls_007">language itself is actually defined!</span></div>
<div style="position:absolute;left:362.45px;top:576.91px" class="cls_038"><span class="cls_038">generator called </span><span class="cls_039">Bison</span><span class="cls_038">.</span></div>
<div style="position:absolute;left:48.00px;top:633.00px" class="cls_020"><span class="cls_020">12</span></div>
<div style="position:absolute;left:69.47px;top:636.00px" class="cls_021"><span class="cls_021">Chapter 1</span></div>
</div>
<div style="position:absolute;left:50%;margin-left:-252px;top:22308px;width:504px;height:666px;border-style:outset;overflow:hidden">
<div style="position:absolute;left:0px;top:0px">
<img src="e698b76e-46bd-11eb-8b25-0cc47a792c0a_id_e698b76e-46bd-11eb-8b25-0cc47a792c0a_files/background037.jpg" width=504 height=666></div>
<div style="position:absolute;left:141.00px;top:42.28px" class="cls_007"><span class="cls_007">Ruby uses Bison when building Ruby itself, and not to directly process</span></div>
<div style="position:absolute;left:123.00px;top:54.28px" class="cls_007"><span class="cls_007">tokens. In effect, there are two separate steps to the parsing process, shown</span></div>
<div style="position:absolute;left:123.00px;top:66.28px" class="cls_007"><span class="cls_007">in Figure 1-13.</span></div>
<div style="position:absolute;left:141.00px;top:78.28px" class="cls_007"><span class="cls_007">Before you run your Ruby program, the Ruby build process uses Bison</span></div>
<div style="position:absolute;left:123.00px;top:90.28px" class="cls_007"><span class="cls_007">to generate the parser code (</span><span class="cls_008">parse.c</span><span class="cls_007">) from the grammar rule file (</span><span class="cls_008">parse.y</span><span class="cls_007">).</span></div>
<div style="position:absolute;left:123.00px;top:102.28px" class="cls_007"><span class="cls_007">Later, at run time, this generated parser code parses the tokens returned by</span></div>
<div style="position:absolute;left:123.00px;top:114.28px" class="cls_007"><span class="cls_007">Ruby’s tokenizer code.</span></div>
<div style="position:absolute;left:256.12px;top:135.57px" class="cls_017"><span class="cls_017">Ruby Build Time</span></div>
<div style="position:absolute;left:133.37px;top:169.66px" class="cls_051"><span class="cls_051">Grammar</span></div>
<div style="position:absolute;left:198.13px;top:168.65px" class="cls_053"><span class="cls_053">Generate</span></div>
<div style="position:absolute;left:262.44px;top:169.66px" class="cls_051"><span class="cls_051">Parser Code</span></div>
<div style="position:absolute;left:139.22px;top:178.06px" class="cls_051"><span class="cls_051">Rules</span></div>
<div style="position:absolute;left:202.13px;top:178.25px" class="cls_053"><span class="cls_053">Parser</span></div>
<div style="position:absolute;left:267.99px;top:178.06px" class="cls_051"><span class="cls_051">(</span><span class="cls_052">parse.c</span><span class="cls_051">)</span></div>
<div style="position:absolute;left:134.49px;top:186.46px" class="cls_051"><span class="cls_051">(</span><span class="cls_052">parse.y</span><span class="cls_051">)</span></div>
<div style="position:absolute;left:202.56px;top:187.85px" class="cls_054"><span class="cls_054">(Bison)</span></div>
<div style="position:absolute;left:131.16px;top:260.82px" class="cls_051"><span class="cls_051">Ruby Code</span></div>
<div style="position:absolute;left:417.82px;top:260.82px" class="cls_051"><span class="cls_051">YARV</span></div>
<div style="position:absolute;left:134.76px;top:269.22px" class="cls_051"><span class="cls_051">(</span><span class="cls_052">.rb</span><span class="cls_051"> files)</span></div>
<div style="position:absolute;left:200.30px;top:267.52px" class="cls_053"><span class="cls_053">Tokenize</span></div>
<div style="position:absolute;left:277.40px;top:267.52px" class="cls_053"><span class="cls_053">Parse</span></div>
<div style="position:absolute;left:344.49px;top:267.52px" class="cls_053"><span class="cls_053">Compile</span></div>
<div style="position:absolute;left:409.91px;top:269.22px" class="cls_051"><span class="cls_051">Instructions</span></div>
<div style="position:absolute;left:241.70px;top:286.31px" class="cls_051"><span class="cls_051">tokens</span></div>
<div style="position:absolute;left:315.97px;top:286.31px" class="cls_051"><span class="cls_051">AST</span></div>
<div style="position:absolute;left:312.96px;top:294.71px" class="cls_051"><span class="cls_051">nodes</span></div>
<div style="position:absolute;left:269.62px;top:315.86px" class="cls_017"><span class="cls_017">Run Time</span></div>
<div style="position:absolute;left:123.00px;top:335.49px" class="cls_038"><span class="cls_038">Figure 1-13: The Ruby build process runs Bison ahead of time.</span></div>
<div style="position:absolute;left:141.00px;top:357.99px" class="cls_007"><span class="cls_007">Because the </span><span class="cls_008">parse.y</span><span class="cls_007"> file and the generated </span><span class="cls_008">parse.c</span><span class="cls_007"> file also contain</span></div>
<div style="position:absolute;left:123.00px;top:369.99px" class="cls_007"><span class="cls_007">the tokenization code, Figure 1-13 has a diagonal arrow from </span><span class="cls_008">parse.c</span><span class="cls_007"> to the</span></div>
<div style="position:absolute;left:123.00px;top:381.99px" class="cls_007"><span class="cls_007">tokenize process on the lower left. (In fact, the parse engine I’m about</span></div>
<div style="position:absolute;left:123.00px;top:393.99px" class="cls_007"><span class="cls_007">to describe calls the tokenization code whenever it needs a new token.)</span></div>
<div style="position:absolute;left:123.00px;top:405.99px" class="cls_007"><span class="cls_007">The tokenization and parsing processes actually occur simultaneously.</span></div>
<div style="position:absolute;left:123.00px;top:430.99px" class="cls_055"><span class="cls_055">Understanding the LALR Parse Algorithm</span></div>
<div style="position:absolute;left:123.00px;top:448.99px" class="cls_007"><span class="cls_007">How does the parser code analyze and process the incoming tokens?</span></div>
<div style="position:absolute;left:123.00px;top:460.99px" class="cls_007"><span class="cls_007">With an algorithm known as </span><span class="cls_008">LALR</span><span class="cls_007">, or </span><span class="cls_008">Look-Ahead Left Reversed Rightmost</span></div>
<div style="position:absolute;left:123.00px;top:472.99px" class="cls_008"><span class="cls_008">Derivation</span><span class="cls_007">. Using the LALR algorithm, the parser code processes the token</span></div>
<div style="position:absolute;left:123.00px;top:484.99px" class="cls_007"><span class="cls_007">stream from left to right, trying to match their order and the pattern in</span></div>
<div style="position:absolute;left:123.00px;top:496.99px" class="cls_007"><span class="cls_007">which they appear against one or more of the grammar rules from </span><span class="cls_008">parse.y</span><span class="cls_007">.</span></div>
<div style="position:absolute;left:123.00px;top:508.99px" class="cls_007"><span class="cls_007">The parser code also “looks ahead” when necessary to decide which gram-</span></div>
<div style="position:absolute;left:123.00px;top:520.99px" class="cls_007"><span class="cls_007">mar rule to match.</span></div>
<div style="position:absolute;left:141.00px;top:532.99px" class="cls_007"><span class="cls_007">The best way to become familiar with the way Ruby grammar rules</span></div>
<div style="position:absolute;left:123.00px;top:544.99px" class="cls_007"><span class="cls_007">work is with an example. To keep things simple for now, we’ll look at an</span></div>
<div style="position:absolute;left:123.00px;top:556.99px" class="cls_007"><span class="cls_007">abstract example. Later on, I’ll show that Ruby actually works in precisely</span></div>
<div style="position:absolute;left:123.00px;top:568.99px" class="cls_007"><span class="cls_007">the same way when it parses your code.</span></div>
<div style="position:absolute;left:366.36px;top:636.00px" class="cls_021"><span class="cls_021">Tokenization and Parsing</span></div>
<div style="position:absolute;left:447.48px;top:633.00px" class="cls_020"><span class="cls_020">13</span></div>
</div>
<div style="position:absolute;left:50%;margin-left:-252px;top:22984px;width:504px;height:666px;border-style:outset;overflow:hidden">
<div style="position:absolute;left:0px;top:0px">
<img src="e698b76e-46bd-11eb-8b25-0cc47a792c0a_id_e698b76e-46bd-11eb-8b25-0cc47a792c0a_files/background038.jpg" width=504 height=666></div>
<div style="position:absolute;left:138.00px;top:41.60px" class="cls_007"><span class="cls_007">Suppose you want to translate from the Spanish:</span></div>
<div style="position:absolute;left:156.00px;top:60.60px" class="cls_033"><span class="cls_033">Me gusta el Ruby.</span></div>
<div style="position:absolute;left:300.00px;top:60.60px" class="cls_033"><span class="cls_033">[Phrase 1]</span></div>
<div style="position:absolute;left:120.00px;top:77.60px" class="cls_007"><span class="cls_007">to the English:</span></div>
<div style="position:absolute;left:156.00px;top:96.60px" class="cls_033"><span class="cls_033">I like Ruby.</span></div>
<div style="position:absolute;left:138.00px;top:113.60px" class="cls_007"><span class="cls_007">And suppose that to translate Phrase 1, you use Bison to generate a C</span></div>
<div style="position:absolute;left:120.00px;top:125.60px" class="cls_007"><span class="cls_007">language parser from a grammar file. Using the Bison/Yacc grammar rule</span></div>
<div style="position:absolute;left:120.00px;top:137.60px" class="cls_007"><span class="cls_007">syntax, you can write the simple grammar shown in Listing 1-12, with the</span></div>
<div style="position:absolute;left:120.00px;top:149.60px" class="cls_007"><span class="cls_007">rule name on the left and the matching tokens on the right.</span></div>
<div style="position:absolute;left:120.00px;top:173.60px" class="cls_030"><span class="cls_030">SpanishPhrase : me gusta el ruby {</span></div>
<div style="position:absolute;left:128.50px;top:184.10px" class="cls_030"><span class="cls_030">printf("I like Ruby\n");</span></div>
<div style="position:absolute;left:120.00px;top:194.60px" class="cls_030"><span class="cls_030">}</span></div>
<div style="position:absolute;left:120.00px;top:217.09px" class="cls_038"><span class="cls_038">Listing 1-12: A simple grammar rule matching the Spanish Phrase 1</span></div>
<div style="position:absolute;left:138.00px;top:239.60px" class="cls_007"><span class="cls_007">This grammar rule says the following: If the token stream is equal to </span><span class="cls_030">me</span><span class="cls_007">,</span></div>
<div style="position:absolute;left:120.00px;top:251.60px" class="cls_030"><span class="cls_030">gusta</span><span class="cls_007">, </span><span class="cls_030">el</span><span class="cls_007">, and </span><span class="cls_030">ruby</span><span class="cls_007">—in that order—we have a match. If there’s a match, the</span></div>
<div style="position:absolute;left:120.00px;top:263.60px" class="cls_007"><span class="cls_007">Bison generated parser will run the given C code, and the </span><span class="cls_030">printf</span><span class="cls_007"> statement</span></div>
<div style="position:absolute;left:120.00px;top:275.60px" class="cls_007"><span class="cls_007">(similar to </span><span class="cls_030">puts</span><span class="cls_007"> in Ruby) will print the translated English phrase.</span></div>
<div style="position:absolute;left:138.00px;top:287.60px" class="cls_007"><span class="cls_007">Figure 1-14 shows the parsing process in action.</span></div>
<div style="position:absolute;left:124.00px;top:313.35px" class="cls_054"><span class="cls_054">Tokens</span></div>
<div style="position:absolute;left:234.74px;top:338.60px" class="cls_030"><span class="cls_030">me</span></div>
<div style="position:absolute;left:282.04px;top:338.60px" class="cls_030"><span class="cls_030">gusta</span></div>
<div style="position:absolute;left:342.08px;top:338.60px" class="cls_030"><span class="cls_030">el</span></div>
<div style="position:absolute;left:391.51px;top:338.60px" class="cls_030"><span class="cls_030">ruby</span></div>
<div style="position:absolute;left:124.00px;top:387.35px" class="cls_054"><span class="cls_054">Grammar Rule</span></div>
<div style="position:absolute;left:130.00px;top:407.10px" class="cls_056"><span class="cls_056">SpanishPhrase:</span></div>
<div style="position:absolute;left:251.20px;top:407.10px" class="cls_056"><span class="cls_056">me    gusta   el</span></div>
<div style="position:absolute;left:369.77px;top:407.10px" class="cls_056"><span class="cls_056">ruby</span></div>
<div style="position:absolute;left:120.00px;top:449.94px" class="cls_038"><span class="cls_038">Figure 1-14: Matching tokens with a grammar rule</span></div>
<div style="position:absolute;left:138.00px;top:472.43px" class="cls_007"><span class="cls_007">There are four input tokens at the top, and the grammar rule is under-</span></div>
<div style="position:absolute;left:120.00px;top:484.43px" class="cls_007"><span class="cls_007">neath. It should be clear that there’s a match because each input token cor-</span></div>
<div style="position:absolute;left:120.00px;top:496.43px" class="cls_007"><span class="cls_007">responds directly to one of the terms on the right side of the grammar rule.</span></div>
<div style="position:absolute;left:120.00px;top:508.43px" class="cls_007"><span class="cls_007">We have a match on the </span><span class="cls_030">SpanishPhrase</span><span class="cls_007"> rule.</span></div>
<div style="position:absolute;left:138.00px;top:520.43px" class="cls_007"><span class="cls_007">Now let’s improve on this example. Suppose you need to enhance your</span></div>
<div style="position:absolute;left:120.00px;top:532.43px" class="cls_007"><span class="cls_007">parser to match Phrase 1 and Phrase 2:</span></div>
<div style="position:absolute;left:156.00px;top:551.43px" class="cls_033"><span class="cls_033">Me gusta el Ruby.</span></div>
<div style="position:absolute;left:300.00px;top:551.43px" class="cls_033"><span class="cls_033">[Phrase 1]</span></div>
<div style="position:absolute;left:138.00px;top:568.43px" class="cls_007"><span class="cls_007">and:</span></div>
<div style="position:absolute;left:156.00px;top:587.43px" class="cls_033"><span class="cls_033">Le gusta el Ruby.</span></div>
<div style="position:absolute;left:300.00px;top:587.43px" class="cls_033"><span class="cls_033">[Phrase 2]</span></div>
<div style="position:absolute;left:138.00px;top:604.43px" class="cls_007"><span class="cls_007">In English, Phrase 2 means “She/He/It likes Ruby.”</span></div>
<div style="position:absolute;left:48.00px;top:633.00px" class="cls_020"><span class="cls_020">14</span></div>
<div style="position:absolute;left:69.52px;top:636.00px" class="cls_021"><span class="cls_021">Chapter 1</span></div>
</div>
<div style="position:absolute;left:50%;margin-left:-252px;top:23660px;width:504px;height:666px;border-style:outset;overflow:hidden">
<div style="position:absolute;left:0px;top:0px">
<img src="e698b76e-46bd-11eb-8b25-0cc47a792c0a_id_e698b76e-46bd-11eb-8b25-0cc47a792c0a_files/background039.jpg" width=504 height=666></div>
<div style="position:absolute;left:141.00px;top:42.28px" class="cls_007"><span class="cls_007">The modified grammar file in Listing 1-13 can parse both Spanish</span></div>
<div style="position:absolute;left:123.00px;top:54.28px" class="cls_007"><span class="cls_007">phrases.</span></div>
<div style="position:absolute;left:123.00px;top:78.28px" class="cls_030"><span class="cls_030">SpanishPhrase: VerbAndObject el ruby {</span></div>
<div style="position:absolute;left:131.50px;top:88.78px" class="cls_030"><span class="cls_030">printf("%s Ruby\n", $1);</span></div>
<div style="position:absolute;left:123.00px;top:99.28px" class="cls_030"><span class="cls_030">};</span></div>
<div style="position:absolute;left:123.00px;top:109.77px" class="cls_030"><span class="cls_030">VerbAndObject: SheLikes | ILike {</span></div>
<div style="position:absolute;left:131.50px;top:120.27px" class="cls_030"><span class="cls_030">$$ = $1;</span></div>
<div style="position:absolute;left:123.00px;top:130.77px" class="cls_030"><span class="cls_030">};</span></div>
<div style="position:absolute;left:123.00px;top:141.26px" class="cls_030"><span class="cls_030">SheLikes: le gusta {</span></div>
<div style="position:absolute;left:131.50px;top:151.76px" class="cls_030"><span class="cls_030">$$ = "She likes";</span></div>
<div style="position:absolute;left:123.00px;top:162.26px" class="cls_030"><span class="cls_030">}</span></div>
<div style="position:absolute;left:123.00px;top:172.76px" class="cls_030"><span class="cls_030">ILike: me gusta {</span></div>
<div style="position:absolute;left:131.50px;top:183.26px" class="cls_030"><span class="cls_030">$$ = "I like";</span></div>
<div style="position:absolute;left:123.00px;top:193.75px" class="cls_030"><span class="cls_030">}</span></div>
<div style="position:absolute;left:123.00px;top:216.25px" class="cls_038"><span class="cls_038">Listing 1-13: These grammar rules match both Phrase 1 and Phrase 2.</span></div>
<div style="position:absolute;left:141.00px;top:238.78px" class="cls_007"><span class="cls_007">As you can see, there are four grammar rules here instead of just</span></div>
<div style="position:absolute;left:123.00px;top:250.78px" class="cls_007"><span class="cls_007">one. Also, you’re using the Bison directive </span><span class="cls_030">$$</span><span class="cls_007"> to return a value from a</span></div>
<div style="position:absolute;left:123.00px;top:262.78px" class="cls_007"><span class="cls_007">child grammar rule to a parent and </span><span class="cls_030">$1</span><span class="cls_007"> to refer to a child’s value from</span></div>
<div style="position:absolute;left:123.00px;top:274.78px" class="cls_007"><span class="cls_007">a parent.</span></div>
<div style="position:absolute;left:141.00px;top:286.78px" class="cls_007"><span class="cls_007">Unlike with Phrase 1, the parser can’t immediately match Phrase 2 with</span></div>
<div style="position:absolute;left:123.00px;top:298.78px" class="cls_007"><span class="cls_007">any of the grammar rules.</span></div>
<div style="position:absolute;left:141.00px;top:310.78px" class="cls_007"><span class="cls_007">In Figure 1-15, we can see the </span><span class="cls_030">el</span><span class="cls_007"> and </span><span class="cls_030">ruby</span><span class="cls_007"> tokens match the </span><span class="cls_030">SpanishPhrase</span></div>
<div style="position:absolute;left:123.00px;top:322.78px" class="cls_007"><span class="cls_007">rule, but </span><span class="cls_030">le</span><span class="cls_007"> and </span><span class="cls_030">gusta</span><span class="cls_007"> do not. (Ultimately, we’ll see that the child rule</span></div>
<div style="position:absolute;left:123.00px;top:334.78px" class="cls_030"><span class="cls_030">VerbAndObject</span><span class="cls_007"> does match </span><span class="cls_030">le gusta</span><span class="cls_007">, but never mind that for now.) With four</span></div>
<div style="position:absolute;left:123.00px;top:346.78px" class="cls_007"><span class="cls_007">grammar rules, how does the parser know which other rules to try to match</span></div>
<div style="position:absolute;left:123.00px;top:358.78px" class="cls_007"><span class="cls_007">against? And against which tokens?</span></div>
<div style="position:absolute;left:127.00px;top:390.20px" class="cls_054"><span class="cls_054">Tokens</span></div>
<div style="position:absolute;left:237.74px;top:415.78px" class="cls_030"><span class="cls_030">le</span></div>
<div style="position:absolute;left:285.04px;top:415.78px" class="cls_030"><span class="cls_030">gusta</span></div>
<div style="position:absolute;left:345.08px;top:415.78px" class="cls_030"><span class="cls_030">el</span></div>
<div style="position:absolute;left:394.51px;top:415.78px" class="cls_030"><span class="cls_030">ruby</span></div>
<div style="position:absolute;left:265.58px;top:443.43px" class="cls_057"><span class="cls_057">?</span></div>
<div style="position:absolute;left:127.00px;top:464.20px" class="cls_054"><span class="cls_054">Grammar Rule</span></div>
<div style="position:absolute;left:133.00px;top:483.95px" class="cls_056"><span class="cls_056">SpanishPhrase:</span></div>
<div style="position:absolute;left:228.03px;top:483.95px" class="cls_056"><span class="cls_056">VerbAndObject</span></div>
<div style="position:absolute;left:335.73px;top:483.95px" class="cls_056"><span class="cls_056">el</span></div>
<div style="position:absolute;left:372.77px;top:483.95px" class="cls_056"><span class="cls_056">ruby</span></div>
<div style="position:absolute;left:123.00px;top:526.78px" class="cls_038"><span class="cls_038">Figure 1-15: The first two tokens don’t match.</span></div>
<div style="position:absolute;left:141.00px;top:555.28px" class="cls_007"><span class="cls_007">This is where the intelligence of the LALR parser comes in. As I men-</span></div>
<div style="position:absolute;left:123.00px;top:567.28px" class="cls_007"><span class="cls_007">tioned earlier, the acronym LALR stands for </span><span class="cls_008">Look-Ahead LR</span><span class="cls_007"> parser, and it</span></div>
<div style="position:absolute;left:366.41px;top:636.00px" class="cls_021"><span class="cls_021">Tokenization and Parsing</span></div>
<div style="position:absolute;left:447.53px;top:633.00px" class="cls_020"><span class="cls_020">15</span></div>
</div>
<div style="position:absolute;left:50%;margin-left:-252px;top:24336px;width:504px;height:666px;border-style:outset;overflow:hidden">
<div style="position:absolute;left:0px;top:0px">
<img src="e698b76e-46bd-11eb-8b25-0cc47a792c0a_id_e698b76e-46bd-11eb-8b25-0cc47a792c0a_files/background040.jpg" width=504 height=666></div>
<div style="position:absolute;left:120.00px;top:41.60px" class="cls_007"><span class="cls_007">describes the algorithm the parser uses to find matching grammar rules.</span></div>
<div style="position:absolute;left:120.00px;top:53.60px" class="cls_007"><span class="cls_007">We’ll get to the </span><span class="cls_008">look ahead</span><span class="cls_007"> part in a minute. For now, let’s start with LR:</span></div>
<div style="position:absolute;left:120.00px;top:74.60px" class="cls_050"><span class="cls_050">•</span><span class="cls_034">   L</span><span class="cls_007"> (left) means the parser moves from left to right while processing the</span></div>
<div style="position:absolute;left:138.00px;top:86.60px" class="cls_007"><span class="cls_007">token stream. In this example, that would be </span><span class="cls_030">le</span><span class="cls_007">, </span><span class="cls_030">gusta</span><span class="cls_007">, </span><span class="cls_030">el</span><span class="cls_007">, and </span><span class="cls_030">ruby</span><span class="cls_007">, in</span></div>
<div style="position:absolute;left:138.00px;top:98.60px" class="cls_007"><span class="cls_007">that order.</span></div>
<div style="position:absolute;left:120.00px;top:113.60px" class="cls_050"><span class="cls_050">•</span><span class="cls_034">   R</span><span class="cls_007"> (reversed rightmost derivation) means the parser takes a bottom-up</span></div>
<div style="position:absolute;left:138.00px;top:125.60px" class="cls_007"><span class="cls_007">strategy, using a shift/reduce technique, to find matching grammar</span></div>
<div style="position:absolute;left:138.00px;top:137.60px" class="cls_007"><span class="cls_007">rules.</span></div>
<div style="position:absolute;left:138.00px;top:158.60px" class="cls_007"><span class="cls_007">Here’s how the algorithm works for Phrase 2. First, the parser takes the</span></div>
<div style="position:absolute;left:120.00px;top:170.60px" class="cls_007"><span class="cls_007">input token stream, shown again in Figure 1-16.</span></div>
<div style="position:absolute;left:124.00px;top:196.02px" class="cls_054"><span class="cls_054">Tokens</span></div>
<div style="position:absolute;left:243.86px;top:221.60px" class="cls_030"><span class="cls_030">le</span></div>
<div style="position:absolute;left:291.16px;top:221.60px" class="cls_030"><span class="cls_030">gusta</span></div>
<div style="position:absolute;left:351.20px;top:221.60px" class="cls_030"><span class="cls_030">el</span></div>
<div style="position:absolute;left:400.63px;top:221.60px" class="cls_030"><span class="cls_030">ruby</span></div>
<div style="position:absolute;left:120.00px;top:258.60px" class="cls_038"><span class="cls_038">Figure 1-16: The input stream of tokens</span></div>
<div style="position:absolute;left:138.00px;top:281.10px" class="cls_007"><span class="cls_007">Next, it shifts the tokens to the left, creating what I’ll call the </span><span class="cls_008">grammar</span></div>
<div style="position:absolute;left:120.00px;top:293.10px" class="cls_008"><span class="cls_008">rule stack</span><span class="cls_007">, as shown Figure 1-17.</span></div>
<div style="position:absolute;left:124.00px;top:318.52px" class="cls_054"><span class="cls_054">Grammar Rule Stack</span></div>
<div style="position:absolute;left:223.12px;top:318.52px" class="cls_054"><span class="cls_054">Tokens</span></div>
<div style="position:absolute;left:419.21px;top:329.65px" class="cls_058"><span class="cls_058">shift</span></div>
<div style="position:absolute;left:200.17px;top:341.65px" class="cls_056"><span class="cls_056">le</span></div>
<div style="position:absolute;left:237.49px;top:344.10px" class="cls_030"><span class="cls_030">gusta</span></div>
<div style="position:absolute;left:297.53px;top:344.10px" class="cls_030"><span class="cls_030">el</span></div>
<div style="position:absolute;left:346.95px;top:344.10px" class="cls_030"><span class="cls_030">ruby</span></div>
<div style="position:absolute;left:120.00px;top:381.10px" class="cls_038"><span class="cls_038">Figure 1-17: The parser moves the first token onto the grammar rule stack.</span></div>
<div style="position:absolute;left:138.00px;top:403.60px" class="cls_007"><span class="cls_007">Because the parser has processed only the token </span><span class="cls_030">le</span><span class="cls_007">, it places this token</span></div>
<div style="position:absolute;left:120.00px;top:415.60px" class="cls_007"><span class="cls_007">in the stack alone for the moment. The term g</span><span class="cls_008">rammar rule stack</span><span class="cls_007"> is a bit of an</span></div>
<div style="position:absolute;left:120.00px;top:427.60px" class="cls_007"><span class="cls_007">oversimplification; while the parser uses a stack, instead of grammar rules,</span></div>
<div style="position:absolute;left:120.00px;top:439.60px" class="cls_007"><span class="cls_007">it pushes numbers onto its stack to indicate which grammar rule it has just</span></div>
<div style="position:absolute;left:120.00px;top:451.60px" class="cls_007"><span class="cls_007">parsed. These numbers, or </span><span class="cls_008">states</span><span class="cls_007">, help the parser keep track of which gram-</span></div>
<div style="position:absolute;left:120.00px;top:463.60px" class="cls_007"><span class="cls_007">mar rules it has matched as it processes tokens.</span></div>
<div style="position:absolute;left:138.00px;top:475.60px" class="cls_007"><span class="cls_007">Next, as shown in Figure 1-18, the parser shifts another token to</span></div>
<div style="position:absolute;left:120.00px;top:487.60px" class="cls_007"><span class="cls_007">the left.</span></div>
<div style="position:absolute;left:124.00px;top:513.02px" class="cls_054"><span class="cls_054">Grammar Rule Stack</span></div>
<div style="position:absolute;left:223.12px;top:513.02px" class="cls_054"><span class="cls_054">Tokens</span></div>
<div style="position:absolute;left:365.62px;top:524.16px" class="cls_058"><span class="cls_058">shift</span></div>
<div style="position:absolute;left:160.85px;top:536.15px" class="cls_056"><span class="cls_056">le  gusta</span></div>
<div style="position:absolute;left:243.86px;top:538.60px" class="cls_030"><span class="cls_030">el</span></div>
<div style="position:absolute;left:293.28px;top:538.60px" class="cls_030"><span class="cls_030">ruby</span></div>
<div style="position:absolute;left:120.00px;top:575.60px" class="cls_038"><span class="cls_038">Figure 1-18: The parser moves another token onto the stack.</span></div>
<div style="position:absolute;left:48.00px;top:633.00px" class="cls_020"><span class="cls_020">16</span></div>
<div style="position:absolute;left:69.55px;top:636.00px" class="cls_021"><span class="cls_021">Chapter 1</span></div>
</div>
<div style="position:absolute;left:50%;margin-left:-252px;top:25012px;width:504px;height:666px;border-style:outset;overflow:hidden">
<div style="position:absolute;left:0px;top:0px">
<img src="e698b76e-46bd-11eb-8b25-0cc47a792c0a_id_e698b76e-46bd-11eb-8b25-0cc47a792c0a_files/background041.jpg" width=504 height=666></div>
<div style="position:absolute;left:141.00px;top:42.28px" class="cls_007"><span class="cls_007">Now there are two tokens in the stack on the left. At this point, the</span></div>
<div style="position:absolute;left:123.00px;top:54.28px" class="cls_007"><span class="cls_007">parser stops to search the different grammar rules for a match. Figure 1-19</span></div>
<div style="position:absolute;left:123.00px;top:66.28px" class="cls_007"><span class="cls_007">shows the parser matching the </span><span class="cls_030">SheLikes</span><span class="cls_007"> rule.</span></div>
<div style="position:absolute;left:127.00px;top:91.70px" class="cls_054"><span class="cls_054">Grammar Rule Stack</span></div>
<div style="position:absolute;left:226.12px;top:91.70px" class="cls_054"><span class="cls_054">Tokens</span></div>
<div style="position:absolute;left:168.55px;top:114.83px" class="cls_056"><span class="cls_056">SheLikes</span></div>
<div style="position:absolute;left:246.86px;top:117.28px" class="cls_030"><span class="cls_030">el</span></div>
<div style="position:absolute;left:296.28px;top:117.28px" class="cls_030"><span class="cls_030">ruby</span></div>
<div style="position:absolute;left:348.50px;top:115.90px" class="cls_058"><span class="cls_058">reduce</span></div>
<div style="position:absolute;left:123.00px;top:154.28px" class="cls_038"><span class="cls_038">Figure 1-19: The parser matches the </span><span class="cls_014">SheLikes</span><span class="cls_038"> rule and reduces.</span></div>
<div style="position:absolute;left:141.00px;top:176.78px" class="cls_007"><span class="cls_007">This operation is called </span><span class="cls_008">reduce</span><span class="cls_007"> because the parser is replacing the pair</span></div>
<div style="position:absolute;left:123.00px;top:188.78px" class="cls_007"><span class="cls_007">of tokens with a single matching rule. The parser looks through the avail-</span></div>
<div style="position:absolute;left:123.00px;top:200.78px" class="cls_007"><span class="cls_007">able rules and reduces, or applies the single matching rule.</span></div>
<div style="position:absolute;left:141.00px;top:212.78px" class="cls_007"><span class="cls_007">Now the parser can reduce again because there’s another matching</span></div>
<div style="position:absolute;left:123.00px;top:224.78px" class="cls_007"><span class="cls_007">rule: </span><span class="cls_030">VerbAndObject</span><span class="cls_007">! The </span><span class="cls_030">VerbAndObject</span><span class="cls_007"> rule matches because its use of the</span></div>
<div style="position:absolute;left:123.00px;top:236.78px" class="cls_030"><span class="cls_030">OR</span><span class="cls_007"> (</span><span class="cls_030">|</span><span class="cls_007">) operator matches </span><span class="cls_008">either</span><span class="cls_007"> the </span><span class="cls_030">SheLikes</span><span class="cls_007"> </span><span class="cls_008">or</span><span class="cls_007"> </span><span class="cls_030">ILike</span><span class="cls_007"> child rules.</span></div>
<div style="position:absolute;left:141.01px;top:248.78px" class="cls_007"><span class="cls_007">You can see in Figure 1-20 that the parser replaces </span><span class="cls_030">SheLikes</span><span class="cls_007"> with</span></div>
<div style="position:absolute;left:123.00px;top:260.78px" class="cls_030"><span class="cls_030">VerbAndObject</span><span class="cls_007">.</span></div>
<div style="position:absolute;left:127.00px;top:286.20px" class="cls_054"><span class="cls_054">Grammar Rule Stack</span></div>
<div style="position:absolute;left:226.00px;top:286.20px" class="cls_054"><span class="cls_054">Tokens</span></div>
<div style="position:absolute;left:130.54px;top:309.33px" class="cls_056"><span class="cls_056">VerbAndObject</span></div>
<div style="position:absolute;left:246.74px;top:311.78px" class="cls_030"><span class="cls_030">el</span></div>
<div style="position:absolute;left:296.16px;top:311.78px" class="cls_030"><span class="cls_030">ruby</span></div>
<div style="position:absolute;left:348.50px;top:310.40px" class="cls_058"><span class="cls_058">reduce</span></div>
<div style="position:absolute;left:123.00px;top:348.78px" class="cls_038"><span class="cls_038">Figure 1-20: The parser reduces again, matching the </span><span class="cls_014">VerbAndObject</span><span class="cls_038"> rule.</span></div>
<div style="position:absolute;left:141.00px;top:371.28px" class="cls_007"><span class="cls_007">But think about this: How did the parser know to reduce and not</span></div>
<div style="position:absolute;left:123.00px;top:383.28px" class="cls_007"><span class="cls_007">continue to shift tokens? Also, if in the real world there are actually many</span></div>
<div style="position:absolute;left:123.00px;top:395.28px" class="cls_007"><span class="cls_007">matching rules, how does the parser know which one to use? How does</span></div>
<div style="position:absolute;left:123.00px;top:407.28px" class="cls_007"><span class="cls_007">it decide whether to shift or reduce? And if it reduces, how does it decide</span></div>
<div style="position:absolute;left:123.00px;top:419.28px" class="cls_007"><span class="cls_007">which grammar rule to reduce with?</span></div>
<div style="position:absolute;left:141.00px;top:431.28px" class="cls_007"><span class="cls_007">In other words, suppose at this point in the process multiple matching</span></div>
<div style="position:absolute;left:123.00px;top:443.28px" class="cls_007"><span class="cls_007">rules included </span><span class="cls_030">le gusta</span><span class="cls_007">. How would the parser know which rule to apply</span></div>
<div style="position:absolute;left:123.00px;top:455.28px" class="cls_007"><span class="cls_007">or whether to shift in the </span><span class="cls_030">el</span><span class="cls_007"> token first before looking for a match? (See</span></div>
<div style="position:absolute;left:123.00px;top:467.28px" class="cls_007"><span class="cls_007">Figure 1-21.)</span></div>
<div style="position:absolute;left:127.00px;top:492.70px" class="cls_054"><span class="cls_054">Grammar Rule Stack</span></div>
<div style="position:absolute;left:226.12px;top:492.70px" class="cls_054"><span class="cls_054">Tokens</span></div>
<div style="position:absolute;left:163.85px;top:515.83px" class="cls_056"><span class="cls_056">le  gusta</span></div>
<div style="position:absolute;left:246.86px;top:518.28px" class="cls_030"><span class="cls_030">el</span></div>
<div style="position:absolute;left:296.28px;top:518.28px" class="cls_030"><span class="cls_030">ruby</span></div>
<div style="position:absolute;left:123.00px;top:555.28px" class="cls_038"><span class="cls_038">Figure 1-21: How does the parser know to shift or reduce?</span></div>
<div style="position:absolute;left:366.39px;top:636.00px" class="cls_021"><span class="cls_021">Tokenization and Parsing</span></div>
<div style="position:absolute;left:447.51px;top:633.00px" class="cls_020"><span class="cls_020">17</span></div>
</div>
<div style="position:absolute;left:50%;margin-left:-252px;top:25688px;width:504px;height:666px;border-style:outset;overflow:hidden">
<div style="position:absolute;left:0px;top:0px">
<img src="e698b76e-46bd-11eb-8b25-0cc47a792c0a_id_e698b76e-46bd-11eb-8b25-0cc47a792c0a_files/background042.jpg" width=504 height=666></div>
<div style="position:absolute;left:138.00px;top:41.60px" class="cls_007"><span class="cls_007">Here’s where the </span><span class="cls_008">look ahead</span><span class="cls_007"> portion of LALR comes in. In order to find</span></div>
<div style="position:absolute;left:120.00px;top:53.60px" class="cls_007"><span class="cls_007">the correct matching rule, the parser looks ahead at the next token. The</span></div>
<div style="position:absolute;left:120.00px;top:65.60px" class="cls_007"><span class="cls_007">arrow in Figure 1-22 shows the parser looking ahead at the </span><span class="cls_030">el</span><span class="cls_007"> token.</span></div>
<div style="position:absolute;left:124.00px;top:91.02px" class="cls_054"><span class="cls_054">Grammar Rule Stack</span></div>
<div style="position:absolute;left:223.12px;top:91.02px" class="cls_054"><span class="cls_054">Tokens</span></div>
<div style="position:absolute;left:160.85px;top:114.15px" class="cls_056"><span class="cls_056">le  gusta</span></div>
<div style="position:absolute;left:243.86px;top:116.60px" class="cls_030"><span class="cls_030">el</span></div>
<div style="position:absolute;left:293.28px;top:116.60px" class="cls_030"><span class="cls_030">ruby</span></div>
<div style="position:absolute;left:214.83px;top:125.47px" class="cls_057"><span class="cls_057">?</span></div>
<div style="position:absolute;left:120.00px;top:153.60px" class="cls_038"><span class="cls_038">Figure 1-22: Looking ahead at the next token in the input stream</span></div>
<div style="position:absolute;left:138.00px;top:176.10px" class="cls_007"><span class="cls_007">Additionally, the parser maintains a state table of possible outcomes</span></div>
<div style="position:absolute;left:120.00px;top:188.10px" class="cls_007"><span class="cls_007">depending on what the next token is and which grammar rule was just</span></div>
<div style="position:absolute;left:120.00px;top:200.10px" class="cls_007"><span class="cls_007">parsed. In this case, the table would contain a series of states, describing</span></div>
<div style="position:absolute;left:120.00px;top:212.10px" class="cls_007"><span class="cls_007">which grammar rules have been parsed so far and which states to move</span></div>
<div style="position:absolute;left:120.00px;top:224.10px" class="cls_007"><span class="cls_007">to next depending on the next token. (LALR parsers are complex state</span></div>
<div style="position:absolute;left:120.00px;top:236.10px" class="cls_007"><span class="cls_007">machines that match patterns in the token stream. When you use Bison to</span></div>
<div style="position:absolute;left:120.00px;top:248.10px" class="cls_007"><span class="cls_007">generate the LALR parser, Bison calculates what this state table should con-</span></div>
<div style="position:absolute;left:120.00px;top:260.10px" class="cls_007"><span class="cls_007">tain based on the grammar rules you provided.)</span></div>
<div style="position:absolute;left:138.00px;top:272.10px" class="cls_007"><span class="cls_007">In this example, the state table would contain an entry indicating that</span></div>
<div style="position:absolute;left:120.00px;top:284.10px" class="cls_007"><span class="cls_007">if the next token was </span><span class="cls_030">el</span><span class="cls_007">, the parser should first reduce using the </span><span class="cls_030">SheLikes</span></div>
<div style="position:absolute;left:120.00px;top:296.10px" class="cls_007"><span class="cls_007">rule before shifting a new token.</span></div>
<div style="position:absolute;left:138.00px;top:308.10px" class="cls_007"><span class="cls_007">Rather than waste your time with the details of what a state table looks</span></div>
<div style="position:absolute;left:120.00px;top:320.10px" class="cls_007"><span class="cls_007">like (you’ll find the actual LALR state table for Ruby in the generated</span></div>
<div style="position:absolute;left:120.00px;top:332.10px" class="cls_008"><span class="cls_008">parse.c </span><span class="cls_007">file), let’s continue the shift/reduce operations for Phrase 2, “Le</span></div>
<div style="position:absolute;left:120.00px;top:344.10px" class="cls_007"><span class="cls_007">gusta el Ruby.” After matching the </span><span class="cls_030">VerbAndObject</span><span class="cls_007"> rule, the parser would shift</span></div>
<div style="position:absolute;left:120.00px;top:356.10px" class="cls_007"><span class="cls_007">another token to the left, as shown in Figure 1-23.</span></div>
<div style="position:absolute;left:124.00px;top:381.94px" class="cls_054"><span class="cls_054">Grammar Rule Stack</span></div>
<div style="position:absolute;left:250.00px;top:381.94px" class="cls_054"><span class="cls_054">Tokens</span></div>
<div style="position:absolute;left:346.10px;top:392.65px" class="cls_058"><span class="cls_058">shift</span></div>
<div style="position:absolute;left:127.53px;top:404.65px" class="cls_056"><span class="cls_056">VerbAndObject  el</span></div>
<div style="position:absolute;left:268.65px;top:406.44px" class="cls_059"><span class="cls_059">ruby</span></div>
<div style="position:absolute;left:120.00px;top:444.10px" class="cls_038"><span class="cls_038">Figure 1-23: The parser shifts another token onto the stack.</span></div>
<div style="position:absolute;left:138.00px;top:466.60px" class="cls_007"><span class="cls_007">At this point, no rules would match, and the state machine would shift</span></div>
<div style="position:absolute;left:120.00px;top:478.60px" class="cls_007"><span class="cls_007">another token to the left (see Figure 1-24).</span></div>
<div style="position:absolute;left:124.00px;top:503.73px" class="cls_054"><span class="cls_054">Grammar Rule Stack</span></div>
<div style="position:absolute;left:310.77px;top:515.15px" class="cls_058"><span class="cls_058">shift</span></div>
<div style="position:absolute;left:130.37px;top:527.15px" class="cls_056"><span class="cls_056">VerbAndObject  el  ruby</span></div>
<div style="position:absolute;left:120.00px;top:566.60px" class="cls_038"><span class="cls_038">Figure 1-24: The parser shifts another token onto the stack.</span></div>
<div style="position:absolute;left:48.00px;top:633.00px" class="cls_020"><span class="cls_020">18</span></div>
<div style="position:absolute;left:69.58px;top:636.00px" class="cls_021"><span class="cls_021">Chapter 1</span></div>
</div>
<div style="position:absolute;left:50%;margin-left:-252px;top:26364px;width:504px;height:666px;border-style:outset;overflow:hidden">
<div style="position:absolute;left:0px;top:0px">
<img src="e698b76e-46bd-11eb-8b25-0cc47a792c0a_id_e698b76e-46bd-11eb-8b25-0cc47a792c0a_files/background043.jpg" width=504 height=666></div>
<div style="position:absolute;left:141.00px;top:42.28px" class="cls_007"><span class="cls_007">Figure 1-25 shows how the parent grammar rule </span><span class="cls_030">SpanishPhrase</span><span class="cls_007"> would</span></div>
<div style="position:absolute;left:123.00px;top:54.28px" class="cls_007"><span class="cls_007">match after a final reduce operation.</span></div>
<div style="position:absolute;left:127.00px;top:80.11px" class="cls_054"><span class="cls_054">Grammar Rule Stack</span></div>
<div style="position:absolute;left:166.25px;top:102.83px" class="cls_056"><span class="cls_056">SpanishPhrase</span></div>
<div style="position:absolute;left:293.64px;top:104.77px" class="cls_058"><span class="cls_058">reduce and match!</span></div>
<div style="position:absolute;left:123.00px;top:142.28px" class="cls_038"><span class="cls_038">Figure 1-25: The parser matches the </span><span class="cls_014">SpanishPhrase</span><span class="cls_038"> rule—and the</span></div>
<div style="position:absolute;left:123.00px;top:152.78px" class="cls_038"><span class="cls_038">entire input stream!</span></div>
<div style="position:absolute;left:141.00px;top:175.28px" class="cls_007"><span class="cls_007">I’ve shown you this Spanish-to-English example because Ruby parses</span></div>
<div style="position:absolute;left:123.00px;top:187.28px" class="cls_007"><span class="cls_007">your program in exactly the same way! Inside the Ruby </span><span class="cls_008">parse.y</span><span class="cls_007"> source code</span></div>
<div style="position:absolute;left:123.00px;top:199.28px" class="cls_007"><span class="cls_007">file, you’ll see hundreds of rules that define the structure and syntax of</span></div>
<div style="position:absolute;left:123.00px;top:211.28px" class="cls_007"><span class="cls_007">the Ruby language. There are parent and child rules, and the child rules</span></div>
<div style="position:absolute;left:123.00px;top:223.28px" class="cls_007"><span class="cls_007">return values the parent rules can refer to in exactly the same way our</span></div>
<div style="position:absolute;left:123.00px;top:235.28px" class="cls_030"><span class="cls_030">SpanishPhrase</span><span class="cls_007"> grammar rules do, using the symbols </span><span class="cls_030">$$</span><span class="cls_007">, </span><span class="cls_030">$1</span><span class="cls_007">, </span><span class="cls_030">$2</span><span class="cls_007">, and so on. The</span></div>
<div style="position:absolute;left:123.00px;top:247.28px" class="cls_007"><span class="cls_007">only real difference is scale: Our </span><span class="cls_030">SpanishPhrase</span><span class="cls_007"> grammar example is trivial,</span></div>
<div style="position:absolute;left:123.00px;top:259.28px" class="cls_007"><span class="cls_007">really. In contrast, Ruby’s grammar is very complex; it’s an intricate series</span></div>
<div style="position:absolute;left:123.00px;top:271.28px" class="cls_007"><span class="cls_007">of interrelated parent and child grammar rules, which sometimes refer to</span></div>
<div style="position:absolute;left:123.00px;top:283.28px" class="cls_007"><span class="cls_007">each other in circular, recursive patterns. But this complexity just means</span></div>
<div style="position:absolute;left:123.00px;top:295.28px" class="cls_007"><span class="cls_007">that the generated state table in </span><span class="cls_008">parse.c</span><span class="cls_007"> is quite large. The basic LALR algo-</span></div>
<div style="position:absolute;left:123.00px;top:307.28px" class="cls_007"><span class="cls_007">rithm, which describes how the parser processes tokens and uses the state</span></div>
<div style="position:absolute;left:123.00px;top:319.28px" class="cls_007"><span class="cls_007">table, is the same in our Spanish example as it is in Ruby.</span></div>
<div style="position:absolute;left:141.00px;top:331.28px" class="cls_007"><span class="cls_007">To get a sense of just how complex the state table is for Ruby, you can</span></div>
<div style="position:absolute;left:123.00px;top:343.28px" class="cls_007"><span class="cls_007">try using Ruby’s </span><span class="cls_030">-y</span><span class="cls_007"> option, which displays internal debug information every</span></div>
<div style="position:absolute;left:123.00px;top:355.28px" class="cls_007"><span class="cls_007">time the parser jumps from one state to another. Listing 1-14 shows a small</span></div>
<div style="position:absolute;left:123.00px;top:367.28px" class="cls_007"><span class="cls_007">portion of the output generated when you run the </span><span class="cls_030">10.times do</span><span class="cls_007"> example from</span></div>
<div style="position:absolute;left:123.00px;top:379.28px" class="cls_007"><span class="cls_007">Listing 1-1.</span></div>
<div style="position:absolute;left:123.00px;top:403.28px" class="cls_030"><span class="cls_030">$ </span><span class="cls_040">ruby -y simple.rb</span></div>
<div style="position:absolute;left:123.00px;top:413.78px" class="cls_030"><span class="cls_030">Starting parse</span></div>
<div style="position:absolute;left:123.00px;top:424.27px" class="cls_030"><span class="cls_030">Entering state 0</span></div>
<div style="position:absolute;left:123.00px;top:434.77px" class="cls_030"><span class="cls_030">Reducing stack by rule 1 (line 850):</span></div>
<div style="position:absolute;left:123.00px;top:445.27px" class="cls_030"><span class="cls_030">-> $$ = nterm @1 ()</span></div>
<div style="position:absolute;left:123.00px;top:455.77px" class="cls_030"><span class="cls_030">Stack now 0</span></div>
<div style="position:absolute;left:123.00px;top:466.26px" class="cls_030"><span class="cls_030">Entering state 2</span></div>
<div style="position:absolute;left:123.00px;top:476.76px" class="cls_030"><span class="cls_030">Reading a token: Next token is token tINTEGER ()</span></div>
<div style="position:absolute;left:123.00px;top:487.26px" class="cls_030"><span class="cls_030">Shifting token tINTEGER ()</span></div>
<div style="position:absolute;left:123.00px;top:497.76px" class="cls_030"><span class="cls_030">Entering state 41</span></div>
<div style="position:absolute;left:123.00px;top:508.25px" class="cls_030"><span class="cls_030">Reducing stack by rule 498 (line 4293):</span></div>
<div style="position:absolute;left:135.75px;top:518.75px" class="cls_030"><span class="cls_030">$1 = token tINTEGER ()</span></div>
<div style="position:absolute;left:123.00px;top:529.25px" class="cls_030"><span class="cls_030">-> $$ = nterm numeric ()</span></div>
<div style="position:absolute;left:123.00px;top:539.75px" class="cls_030"><span class="cls_030">Stack now 0 2</span></div>
<div style="position:absolute;left:123.00px;top:550.24px" class="cls_030"><span class="cls_030">Entering state 109</span></div>
<div style="position:absolute;left:123.00px;top:560.74px" class="cls_030"><span class="cls_030">--snip--</span></div>
<div style="position:absolute;left:123.00px;top:583.24px" class="cls_038"><span class="cls_038">Listing 1-14: Ruby optionally displays debug information, showing how the parser jumps</span></div>
<div style="position:absolute;left:123.00px;top:593.74px" class="cls_038"><span class="cls_038">from one state to another.</span></div>
<div style="position:absolute;left:366.38px;top:636.00px" class="cls_021"><span class="cls_021">Tokenization and Parsing</span></div>
<div style="position:absolute;left:447.49px;top:633.00px" class="cls_020"><span class="cls_020">19</span></div>
</div>
<div style="position:absolute;left:50%;margin-left:-252px;top:27040px;width:504px;height:666px;border-style:outset;overflow:hidden">
<div style="position:absolute;left:0px;top:0px">
<img src="e698b76e-46bd-11eb-8b25-0cc47a792c0a_id_e698b76e-46bd-11eb-8b25-0cc47a792c0a_files/background044.jpg" width=504 height=666></div>
<div style="position:absolute;left:120.00px;top:42.05px" class="cls_055"><span class="cls_055">Some Actual Ruby Grammar Rules</span></div>
<div style="position:absolute;left:120.00px;top:60.05px" class="cls_007"><span class="cls_007">Let’s look at some actual Ruby grammar rules from </span><span class="cls_008">parse.y</span><span class="cls_007">. Listing 1-15 con-</span></div>
<div style="position:absolute;left:120.00px;top:72.05px" class="cls_007"><span class="cls_007">tains the simple example Ruby script from Listing 1-1 on page 4.</span></div>
<div style="position:absolute;left:120.00px;top:96.05px" class="cls_030"><span class="cls_030">10.times do |n|</span></div>
<div style="position:absolute;left:128.50px;top:106.55px" class="cls_030"><span class="cls_030">puts n</span></div>
<div style="position:absolute;left:120.00px;top:117.04px" class="cls_030"><span class="cls_030">end</span></div>
<div style="position:absolute;left:120.00px;top:139.54px" class="cls_038"><span class="cls_038">Listing 1-15: The simple Ruby program from Listing 1-1.</span></div>
<div style="position:absolute;left:138.00px;top:162.05px" class="cls_007"><span class="cls_007">Figure 1-26 shows how Ruby’s parsing process works with this script.</span></div>
<div style="position:absolute;left:122.91px;top:186.49px" class="cls_060"><span class="cls_060">Ruby Code</span></div>
<div style="position:absolute;left:207.58px;top:186.49px" class="cls_060"><span class="cls_060">Grammar Rules</span></div>
<div style="position:absolute;left:129.71px;top:198.55px" class="cls_061"><span class="cls_061">10.times do |n|</span><span class="cls_062">    program: top_compstmt</span></div>
<div style="position:absolute;left:138.82px;top:210.20px" class="cls_061"><span class="cls_061">puts n</span></div>
<div style="position:absolute;left:212.11px;top:211.56px" class="cls_062"><span class="cls_062">top_compstmt: top_stmts opt_terms</span></div>
<div style="position:absolute;left:129.71px;top:221.85px" class="cls_061"><span class="cls_061">end</span></div>
<div style="position:absolute;left:212.11px;top:223.21px" class="cls_062"><span class="cls_062">top_stmts: ... | top_stmt | ...</span></div>
<div style="position:absolute;left:212.11px;top:234.86px" class="cls_062"><span class="cls_062">top_stmt: stmt | ...</span></div>
<div style="position:absolute;left:212.11px;top:246.52px" class="cls_062"><span class="cls_062">stmt: ... | expr</span></div>
<div style="position:absolute;left:212.11px;top:258.17px" class="cls_062"><span class="cls_062">expr: ... | arg</span></div>
<div style="position:absolute;left:212.11px;top:269.82px" class="cls_062"><span class="cls_062">arg: ... | primary</span></div>
<div style="position:absolute;left:212.11px;top:281.47px" class="cls_062"><span class="cls_062">primary: ... | method_call brace_block | ...</span></div>
<div style="position:absolute;left:120.00px;top:309.45px" class="cls_038"><span class="cls_038">Figure 1-26: The grammar rules on the right match the Ruby code on the left.</span></div>
<div style="position:absolute;left:138.00px;top:331.95px" class="cls_007"><span class="cls_007">On the left is the code that Ruby is trying to parse. On the right are the</span></div>
<div style="position:absolute;left:120.00px;top:343.95px" class="cls_007"><span class="cls_007">actual matching grammar rules from the Ruby </span><span class="cls_008">parse.y</span><span class="cls_007"> file, shown simplified.</span></div>
<div style="position:absolute;left:120.00px;top:355.95px" class="cls_007"><span class="cls_007">The first rule, </span><span class="cls_030">program: top_compstmt</span><span class="cls_007">, is the root grammar rule that matches</span></div>
<div style="position:absolute;left:120.00px;top:367.95px" class="cls_007"><span class="cls_007">every Ruby program in its entirety.</span></div>
<div style="position:absolute;left:138.00px;top:379.95px" class="cls_007"><span class="cls_007">As you go down the list, you see a complex series of child rules that</span></div>
<div style="position:absolute;left:120.00px;top:391.95px" class="cls_007"><span class="cls_007">also match the entire Ruby script: top statements, a single statement, an</span></div>
<div style="position:absolute;left:120.00px;top:403.95px" class="cls_007"><span class="cls_007">expression, an argument, and, finally, a primary value. Once Ruby’s parse</span></div>
<div style="position:absolute;left:120.00px;top:415.95px" class="cls_007"><span class="cls_007">reaches the primary grammar rule, it encounters a rule with two matching</span></div>
<div style="position:absolute;left:120.00px;top:427.95px" class="cls_007"><span class="cls_007">child rules: </span><span class="cls_030">method_call</span><span class="cls_007"> and </span><span class="cls_030">brace_block</span><span class="cls_007">. Let’s look at </span><span class="cls_030">method_call</span><span class="cls_007"> first (see</span></div>
<div style="position:absolute;left:120.00px;top:439.95px" class="cls_007"><span class="cls_007">Figure 1-27).</span></div>
<div style="position:absolute;left:123.04px;top:464.47px" class="cls_054"><span class="cls_054">Ruby Code</span></div>
<div style="position:absolute;left:182.33px;top:464.47px" class="cls_054"><span class="cls_054">Grammar Rules</span></div>
<div style="position:absolute;left:130.12px;top:479.08px" class="cls_063"><span class="cls_063">10.times</span></div>
<div style="position:absolute;left:187.05px;top:480.50px" class="cls_009"><span class="cls_009">method_call: ... | primary_value '.' operation2 | ...</span></div>
<div style="position:absolute;left:120.00px;top:506.35px" class="cls_038"><span class="cls_038">Figure 1-27: </span><span class="cls_014">10.times</span><span class="cls_038"> matches the </span><span class="cls_014">method_call</span><span class="cls_038"> grammar rule.</span></div>
<div style="position:absolute;left:138.00px;top:528.85px" class="cls_007"><span class="cls_007">The </span><span class="cls_030">method_call</span><span class="cls_007"> rule matches the </span><span class="cls_030">10.times</span><span class="cls_007"> portion of the Ruby code—</span></div>
<div style="position:absolute;left:120.00px;top:540.85px" class="cls_007"><span class="cls_007">that is, where we call the </span><span class="cls_030">times</span><span class="cls_007"> method on the </span><span class="cls_030">10</span><span class="cls_007"> </span><span class="cls_030">Fixnum</span><span class="cls_007"> object. You can</span></div>
<div style="position:absolute;left:48.00px;top:633.00px" class="cls_020"><span class="cls_020">20</span></div>
<div style="position:absolute;left:69.97px;top:636.00px" class="cls_021"><span class="cls_021">Chapter 1</span></div>
</div>
<div style="position:absolute;left:50%;margin-left:-252px;top:27716px;width:504px;height:666px;border-style:outset;overflow:hidden">
<div style="position:absolute;left:0px;top:0px">
<img src="e698b76e-46bd-11eb-8b25-0cc47a792c0a_id_e698b76e-46bd-11eb-8b25-0cc47a792c0a_files/background045.jpg" width=504 height=666></div>
<div style="position:absolute;left:123.00px;top:42.28px" class="cls_007"><span class="cls_007">see that the </span><span class="cls_030">method_call</span><span class="cls_007"> rule matches another primary value, followed by a</span></div>
<div style="position:absolute;left:123.00px;top:54.28px" class="cls_007"><span class="cls_007">period character, followed by an </span><span class="cls_030">operation2</span><span class="cls_007"> rule.</span></div>
<div style="position:absolute;left:141.00px;top:66.28px" class="cls_007"><span class="cls_007">Figure 1-28 shows that the </span><span class="cls_030">primary_value</span><span class="cls_007"> rule first matches the value </span><span class="cls_030">10.</span></div>
<div style="position:absolute;left:126.04px;top:92.80px" class="cls_054"><span class="cls_054">Ruby Code</span></div>
<div style="position:absolute;left:185.33px;top:92.80px" class="cls_054"><span class="cls_054">Grammar Rules</span></div>
<div style="position:absolute;left:133.12px;top:107.41px" class="cls_063"><span class="cls_063">10</span></div>
<div style="position:absolute;left:190.05px;top:108.83px" class="cls_009"><span class="cls_009">primary_value: primary</span></div>
<div style="position:absolute;left:190.05px;top:120.98px" class="cls_009"><span class="cls_009">primary: literal | ...</span></div>
<div style="position:absolute;left:123.00px;top:145.68px" class="cls_038"><span class="cls_038">Figure 1-28: The value </span><span class="cls_014">10</span><span class="cls_038"> matches the</span></div>
<div style="position:absolute;left:123.00px;top:156.18px" class="cls_014"><span class="cls_014">primary_value</span><span class="cls_038"> grammar rule.</span></div>
<div style="position:absolute;left:141.00px;top:180.68px" class="cls_007"><span class="cls_007">Then, in Figure 1-29, the </span><span class="cls_030">operation2</span><span class="cls_007"> rule matches the method</span></div>
<div style="position:absolute;left:123.00px;top:192.68px" class="cls_007"><span class="cls_007">name </span><span class="cls_030">times</span><span class="cls_007">.</span></div>
<div style="position:absolute;left:126.04px;top:219.20px" class="cls_054"><span class="cls_054">Ruby Code</span></div>
<div style="position:absolute;left:185.33px;top:219.20px" class="cls_054"><span class="cls_054">Grammar Rules</span></div>
<div style="position:absolute;left:133.12px;top:233.81px" class="cls_064"><span class="cls_064">times</span></div>
<div style="position:absolute;left:190.05px;top:235.23px" class="cls_041"><span class="cls_041">operation2: identifier | ...</span></div>
<div style="position:absolute;left:123.00px;top:263.08px" class="cls_038"><span class="cls_038">Figure 1-29: The </span><span class="cls_014">times</span><span class="cls_038"> method name matches the</span></div>
<div style="position:absolute;left:123.00px;top:273.58px" class="cls_014"><span class="cls_014">operation2</span><span class="cls_038"> grammar rule.</span></div>
<div style="position:absolute;left:141.00px;top:298.08px" class="cls_007"><span class="cls_007">How does Ruby parse the contents of the </span><span class="cls_030">do ... puts ... end</span><span class="cls_007"> block</span></div>
<div style="position:absolute;left:123.00px;top:310.08px" class="cls_007"><span class="cls_007">that’s passed to the </span><span class="cls_030">times</span><span class="cls_007"> method? It uses the </span><span class="cls_030">brace_block</span><span class="cls_007"> rule we saw in</span></div>
<div style="position:absolute;left:123.00px;top:322.08px" class="cls_007"><span class="cls_007">Figure 1-26. Figure 1-30 shows the definition of the </span><span class="cls_030">brace_block</span><span class="cls_007"> rule.</span></div>
<div style="position:absolute;left:126.04px;top:348.61px" class="cls_054"><span class="cls_054">Ruby Code</span></div>
<div style="position:absolute;left:185.33px;top:348.61px" class="cls_054"><span class="cls_054">Grammar Rules</span></div>
<div style="position:absolute;left:133.12px;top:363.21px" class="cls_063"><span class="cls_063">do |n|</span></div>
<div style="position:absolute;left:190.05px;top:364.63px" class="cls_009"><span class="cls_009">brace_block: ... | keyword_do opt_block_param compstmt keyword_end | ...</span></div>
<div style="position:absolute;left:142.62px;top:375.08px" class="cls_063"><span class="cls_063">puts n</span></div>
<div style="position:absolute;left:133.12px;top:387.53px" class="cls_063"><span class="cls_063">end</span></div>
<div style="position:absolute;left:123.00px;top:410.48px" class="cls_038"><span class="cls_038">Figure 1-30: The entire block matches the </span><span class="cls_014">brace_block</span><span class="cls_038"> rule.</span></div>
<div style="position:absolute;left:141.00px;top:434.98px" class="cls_007"><span class="cls_007">I don’t have space here to go through all the remaining child gram-</span></div>
<div style="position:absolute;left:123.00px;top:446.98px" class="cls_007"><span class="cls_007">mar rules, but you can see how this rule, in turn, contains a series of other</span></div>
<div style="position:absolute;left:123.00px;top:458.98px" class="cls_007"><span class="cls_007">matching child rules:</span></div>
<div style="position:absolute;left:123.00px;top:481.98px" class="cls_050"><span class="cls_050">•</span><span class="cls_030">   keyword_do</span><span class="cls_007"> matches the </span><span class="cls_030">do</span><span class="cls_007"> reserved keyword.</span></div>
<div style="position:absolute;left:123.00px;top:497.98px" class="cls_050"><span class="cls_050">•</span><span class="cls_030">   opt_block_param</span><span class="cls_007"> matches the block parameter </span><span class="cls_030">|n|</span><span class="cls_007">.</span></div>
<div style="position:absolute;left:123.00px;top:513.98px" class="cls_050"><span class="cls_050">•</span><span class="cls_030">   compstmt</span><span class="cls_007"> matches the contents of the block itself, </span><span class="cls_030">puts n</span><span class="cls_007">.</span></div>
<div style="position:absolute;left:123.00px;top:529.98px" class="cls_050"><span class="cls_050">•</span><span class="cls_030">   keyword_end</span><span class="cls_007"> matches the </span><span class="cls_030">end</span><span class="cls_007"> reserved keyword.</span></div>
<div style="position:absolute;left:366.17px;top:636.00px" class="cls_021"><span class="cls_021">Tokenization and Parsing</span></div>
<div style="position:absolute;left:447.28px;top:633.00px" class="cls_020"><span class="cls_020">21</span></div>
</div>
<div style="position:absolute;left:50%;margin-left:-252px;top:28392px;width:504px;height:666px;border-style:outset;overflow:hidden">
<div style="position:absolute;left:0px;top:0px">
<img src="e698b76e-46bd-11eb-8b25-0cc47a792c0a_id_e698b76e-46bd-11eb-8b25-0cc47a792c0a_files/background046.jpg" width=504 height=666></div>
<div style="position:absolute;left:191.71px;top:61.31px" class="cls_020"><span class="cls_020">Reading a Bison Grammar Rule</span></div>
<div style="position:absolute;left:120.50px;top:79.81px" class="cls_039"><span class="cls_039">To give you a taste of the actual Ruby </span><span class="cls_044">parse.y</span><span class="cls_039"> source code, take a look at</span></div>
<div style="position:absolute;left:120.50px;top:91.81px" class="cls_039"><span class="cls_039">Listing 1-16, which shows part of the </span><span class="cls_009">method_call</span><span class="cls_039"> </span><span class="cls_046">u</span><span class="cls_039"> grammar rule definition.</span></div>
<div style="position:absolute;left:110.00px;top:114.31px" class="cls_045"><span class="cls_045">u</span><span class="cls_009"> method_call</span></div>
<div style="position:absolute;left:191.69px;top:114.31px" class="cls_009"><span class="cls_009">:</span></div>
<div style="position:absolute;left:120.50px;top:123.82px" class="cls_009"><span class="cls_009">--snip--</span></div>
<div style="position:absolute;left:143.00px;top:133.32px" class="cls_009"><span class="cls_009">primary_value '.' operation2</span></div>
<div style="position:absolute;left:143.00px;top:142.82px" class="cls_009"><span class="cls_009">{</span></div>
<div style="position:absolute;left:143.00px;top:152.32px" class="cls_009"><span class="cls_009">/*%%%*/</span></div>
<div style="position:absolute;left:158.00px;top:161.83px" class="cls_009"><span class="cls_009">$&lt;num>$ = ruby_sourceline;</span></div>
<div style="position:absolute;left:143.00px;top:171.33px" class="cls_009"><span class="cls_009">/*% %*/</span></div>
<div style="position:absolute;left:143.00px;top:180.83px" class="cls_009"><span class="cls_009">}</span></div>
<div style="position:absolute;left:135.50px;top:190.33px" class="cls_009"><span class="cls_009">opt_paren_args</span></div>
<div style="position:absolute;left:143.00px;top:199.84px" class="cls_009"><span class="cls_009">{</span></div>
<div style="position:absolute;left:143.00px;top:209.34px" class="cls_009"><span class="cls_009">/*%%%*/</span></div>
<div style="position:absolute;left:158.00px;top:218.84px" class="cls_009"><span class="cls_009">$$ = NEW_CALL($1, $3, $5);</span></div>
<div style="position:absolute;left:158.00px;top:228.34px" class="cls_009"><span class="cls_009">nd_set_line($$, $&lt;num>4);</span></div>
<div style="position:absolute;left:143.00px;top:237.85px" class="cls_009"><span class="cls_009">/*%</span></div>
<div style="position:absolute;left:158.00px;top:247.35px" class="cls_009"><span class="cls_009">$$ = dispatch3(call, $1, ripper_id2sym('.'), $3);</span></div>
<div style="position:absolute;left:158.00px;top:256.85px" class="cls_009"><span class="cls_009">$$ = method_optarg($$, $5);</span></div>
<div style="position:absolute;left:143.00px;top:266.35px" class="cls_009"><span class="cls_009">%*/</span></div>
<div style="position:absolute;left:143.00px;top:275.86px" class="cls_009"><span class="cls_009">}</span></div>
<div style="position:absolute;left:120.50px;top:298.31px" class="cls_043"><span class="cls_043">Listing 1-16: Ruby’s actual </span><span class="cls_015">method_call</span><span class="cls_043"> grammar rule from </span><span class="cls_065">parse.y</span></div>
<div style="position:absolute;left:138.50px;top:321.31px" class="cls_039"><span class="cls_039">As with the preceding Spanish-to-English example grammar file, you can see</span></div>
<div style="position:absolute;left:120.50px;top:333.32px" class="cls_039"><span class="cls_039">that there are snippets of complex C code after each of the terms in the grammar</span></div>
<div style="position:absolute;left:120.50px;top:345.32px" class="cls_039"><span class="cls_039">rule. Listing 1-17 shows one example of this.</span></div>
<div style="position:absolute;left:143.00px;top:367.81px" class="cls_009"><span class="cls_009">$$ = NEW_CALL($1, $3, $5);</span></div>
<div style="position:absolute;left:143.00px;top:377.32px" class="cls_009"><span class="cls_009">nd_set_line($$, $&lt;num>4);</span></div>
<div style="position:absolute;left:120.50px;top:399.81px" class="cls_043"><span class="cls_043">Listing 1-17: Ruby calls this C code when the </span><span class="cls_015">opt_paren_args</span><span class="cls_043"> grammar rule matches.</span></div>
<div style="position:absolute;left:138.50px;top:422.81px" class="cls_039"><span class="cls_039">The Bison-generated parser will execute one of these snippets when there’s</span></div>
<div style="position:absolute;left:120.50px;top:434.82px" class="cls_039"><span class="cls_039">a match for a rule on the tokens found in the target Ruby script. However, these C</span></div>
<div style="position:absolute;left:120.50px;top:446.81px" class="cls_039"><span class="cls_039">code snippets also contain Bison directives, such as </span><span class="cls_009">$$</span><span class="cls_039"> and </span><span class="cls_009">$1</span><span class="cls_039">, that allow the code to</span></div>
<div style="position:absolute;left:120.50px;top:458.82px" class="cls_039"><span class="cls_039">create return values and to refer to values returned by other grammar rules. We end</span></div>
<div style="position:absolute;left:120.50px;top:470.82px" class="cls_039"><span class="cls_039">up with a confusing mix of C and Bison directives.</span></div>
<div style="position:absolute;left:138.50px;top:482.82px" class="cls_039"><span class="cls_039">To make things worse, Ruby uses a trick during its build process to divide these</span></div>
<div style="position:absolute;left:120.50px;top:494.82px" class="cls_039"><span class="cls_039">C/Bison code snippets into separate pieces. Some of these pieces are used by</span></div>
<div style="position:absolute;left:120.50px;top:506.82px" class="cls_039"><span class="cls_039">Ruby, while others are used only by the Ripper tool from Experiment 1-1. Here’s how</span></div>
<div style="position:absolute;left:120.50px;top:518.83px" class="cls_039"><span class="cls_039">that trick works:</span></div>
<div style="position:absolute;left:120.50px;top:536.81px" class="cls_039"><span class="cls_039">•   The C code that appears between the </span><span class="cls_009">/*%%%*/</span><span class="cls_039"> line and the </span><span class="cls_009">/*%</span><span class="cls_039"> line in</span></div>
<div style="position:absolute;left:138.50px;top:548.82px" class="cls_039"><span class="cls_039">Listing 1-16 is actually compiled into Ruby during the Ruby build process.</span></div>
<div style="position:absolute;left:120.50px;top:563.81px" class="cls_039"><span class="cls_039">•   The C code between </span><span class="cls_009">/*%</span><span class="cls_039"> and </span><span class="cls_009">%*/</span><span class="cls_039"> in Listing 1-16 is dropped when Ruby is built.</span></div>
<div style="position:absolute;left:138.50px;top:575.82px" class="cls_039"><span class="cls_039">This code is used only by the Ripper tool, which is built separately during the</span></div>
<div style="position:absolute;left:138.50px;top:587.82px" class="cls_039"><span class="cls_039">Ruby build process.</span></div>
<div style="position:absolute;left:48.00px;top:633.00px" class="cls_020"><span class="cls_020">22</span></div>
<div style="position:absolute;left:69.96px;top:636.00px" class="cls_021"><span class="cls_021">Chapter 1</span></div>
</div>
<div style="position:absolute;left:50%;margin-left:-252px;top:29068px;width:504px;height:666px;border-style:outset;overflow:hidden">
<div style="position:absolute;left:0px;top:0px">
<img src="e698b76e-46bd-11eb-8b25-0cc47a792c0a_id_e698b76e-46bd-11eb-8b25-0cc47a792c0a_files/background047.jpg" width=504 height=666></div>
<div style="position:absolute;left:141.50px;top:61.15px" class="cls_039"><span class="cls_039">Ruby uses this very confusing syntax to allow the Ripper tool and Ruby itself to</span></div>
<div style="position:absolute;left:123.50px;top:73.15px" class="cls_039"><span class="cls_039">share the same grammar rules inside </span><span class="cls_044">parse.y</span><span class="cls_039">.</span></div>
<div style="position:absolute;left:141.50px;top:85.16px" class="cls_039"><span class="cls_039">What are these snippets actually doing? As you might guess, Ruby uses the</span></div>
<div style="position:absolute;left:123.50px;top:97.16px" class="cls_039"><span class="cls_039">Ripper code snippets to allow the Ripper tool to display information about what Ruby</span></div>
<div style="position:absolute;left:123.50px;top:109.16px" class="cls_039"><span class="cls_039">is parsing. (We’ll try that next, in Experiment 1-2.) There’s also some bookkeeping</span></div>
<div style="position:absolute;left:123.50px;top:121.15px" class="cls_039"><span class="cls_039">code: Ruby uses the </span><span class="cls_009">ruby_sourceline</span><span class="cls_039"> variable to keep track of which source code line</span></div>
<div style="position:absolute;left:123.50px;top:133.16px" class="cls_039"><span class="cls_039">corresponds to each portion of the grammar.</span></div>
<div style="position:absolute;left:141.50px;top:145.16px" class="cls_039"><span class="cls_039">But more importantly, the snippets Ruby actually uses at run time when pars-</span></div>
<div style="position:absolute;left:123.50px;top:157.15px" class="cls_039"><span class="cls_039">ing your code create a series of </span><span class="cls_044">nodes</span><span class="cls_039">, or temporary data structures, that form an</span></div>
<div style="position:absolute;left:123.50px;top:169.16px" class="cls_039"><span class="cls_039">internal representation of your Ruby code. These nodes are saved in a tree structure</span></div>
<div style="position:absolute;left:123.50px;top:181.15px" class="cls_039"><span class="cls_039">called an </span><span class="cls_044">abstract syntax tree (AST)</span><span class="cls_066"> </span><span class="cls_039">(more about this in Experiment 1-2). You can see</span></div>
<div style="position:absolute;left:123.50px;top:193.15px" class="cls_039"><span class="cls_039">one example of creating an AST node in Listing 1-17, where Ruby calls the </span><span class="cls_009">NEW_CALL</span></div>
<div style="position:absolute;left:123.50px;top:205.15px" class="cls_039"><span class="cls_039">C macro/function. This call creates a new </span><span class="cls_009">NODE_CALL</span><span class="cls_039"> node, which represents a method</span></div>
<div style="position:absolute;left:123.50px;top:217.16px" class="cls_039"><span class="cls_039">call. (In Chapter 2 we’ll see how Ruby eventually compiles this into bytecode that</span></div>
<div style="position:absolute;left:123.50px;top:229.16px" class="cls_039"><span class="cls_039">can be executed by a virtual machine.)</span></div>
<div style="position:absolute;left:123.00px;top:275.63px" class="cls_031"><span class="cls_031">Experiment 1-2: Using Ripper to Parse Different</span></div>
<div style="position:absolute;left:123.00px;top:290.63px" class="cls_031"><span class="cls_031">Ruby Scripts</span></div>
<div style="position:absolute;left:123.00px;top:310.63px" class="cls_007"><span class="cls_007">In Experiment 1-1, you learned how to use Ripper to display the tokens that</span></div>
<div style="position:absolute;left:123.00px;top:322.63px" class="cls_007"><span class="cls_007">Ruby converts your code into, and we’ve just seen how the Ruby grammar</span></div>
<div style="position:absolute;left:123.00px;top:334.63px" class="cls_007"><span class="cls_007">rules in </span><span class="cls_008">parse.y</span><span class="cls_007"> are also included in the Ripper tool. Now let’s learn how</span></div>
<div style="position:absolute;left:123.00px;top:346.63px" class="cls_007"><span class="cls_007">to use Ripper to display information about how Ruby parses your code.</span></div>
<div style="position:absolute;left:123.00px;top:358.63px" class="cls_007"><span class="cls_007">Listing 1-18 shows how to do it.</span></div>
<div style="position:absolute;left:123.00px;top:382.63px" class="cls_030"><span class="cls_030">require 'ripper'</span></div>
<div style="position:absolute;left:123.00px;top:393.12px" class="cls_030"><span class="cls_030">require 'pp'</span></div>
<div style="position:absolute;left:123.00px;top:403.62px" class="cls_030"><span class="cls_030">code = &lt;&lt;STR</span></div>
<div style="position:absolute;left:123.00px;top:414.12px" class="cls_030"><span class="cls_030">10.times do |n|</span></div>
<div style="position:absolute;left:131.50px;top:424.62px" class="cls_030"><span class="cls_030">puts n</span></div>
<div style="position:absolute;left:123.00px;top:435.11px" class="cls_030"><span class="cls_030">end</span></div>
<div style="position:absolute;left:123.00px;top:445.61px" class="cls_030"><span class="cls_030">STR</span></div>
<div style="position:absolute;left:123.00px;top:456.11px" class="cls_030"><span class="cls_030">puts code</span></div>
<div style="position:absolute;left:111.15px;top:466.61px" class="cls_046"><span class="cls_046">u</span><span class="cls_030"> pp Ripper.sexp(code)</span></div>
<div style="position:absolute;left:123.00px;top:489.10px" class="cls_038"><span class="cls_038">Listing 1-18: An example of how to call </span><span class="cls_014">Ripper.sexp</span></div>
<div style="position:absolute;left:141.00px;top:511.63px" class="cls_007"><span class="cls_007">This is exactly the same code from Experiment 1-1, except that we call</span></div>
<div style="position:absolute;left:123.00px;top:523.63px" class="cls_030"><span class="cls_030">Ripper.sexp</span><span class="cls_007"> </span><span class="cls_050">u</span><span class="cls_007"> instead of </span><span class="cls_030">Ripper.lex</span><span class="cls_007">. Running this gives the output shown in</span></div>
<div style="position:absolute;left:123.00px;top:535.63px" class="cls_007"><span class="cls_007">Listing 1-19.</span></div>
<div style="position:absolute;left:123.00px;top:559.63px" class="cls_030"><span class="cls_030">[:program,</span></div>
<div style="position:absolute;left:131.50px;top:570.12px" class="cls_030"><span class="cls_030">[[:method_add_block,</span></div>
<div style="position:absolute;left:144.25px;top:580.62px" class="cls_030"><span class="cls_030">[:call,</span></div>
<div style="position:absolute;left:152.75px;top:591.12px" class="cls_030"><span class="cls_030">[:@int, "10", [1, 0]], :".",</span></div>
<div style="position:absolute;left:152.75px;top:601.62px" class="cls_030"><span class="cls_030">[:@ident, "times", [1, 3]]],</span></div>
<div style="position:absolute;left:365.90px;top:636.00px" class="cls_021"><span class="cls_021">Tokenization and Parsing</span></div>
<div style="position:absolute;left:447.01px;top:633.00px" class="cls_020"><span class="cls_020">23</span></div>
</div>
<div style="position:absolute;left:50%;margin-left:-252px;top:29744px;width:504px;height:666px;border-style:outset;overflow:hidden">
<div style="position:absolute;left:0px;top:0px">
<img src="e698b76e-46bd-11eb-8b25-0cc47a792c0a_id_e698b76e-46bd-11eb-8b25-0cc47a792c0a_files/background048.jpg" width=504 height=666></div>
<div style="position:absolute;left:141.25px;top:42.24px" class="cls_030"><span class="cls_030">[:do_block,</span></div>
<div style="position:absolute;left:149.75px;top:52.74px" class="cls_030"><span class="cls_030">[:block_var,</span></div>
<div style="position:absolute;left:158.25px;top:63.23px" class="cls_030"><span class="cls_030">[:params, [[:@ident, "n", [1, 13]]],</span></div>
<div style="position:absolute;left:200.75px;top:73.73px" class="cls_030"><span class="cls_030">nil, nil, nil, nil, nil, nil],</span></div>
<div style="position:absolute;left:158.25px;top:84.23px" class="cls_030"><span class="cls_030">false],</span></div>
<div style="position:absolute;left:149.75px;top:94.72px" class="cls_030"><span class="cls_030">[[:command,</span></div>
<div style="position:absolute;left:162.50px;top:105.22px" class="cls_030"><span class="cls_030">[:@ident, "puts", [2, 2]],</span></div>
<div style="position:absolute;left:162.50px;top:115.72px" class="cls_030"><span class="cls_030">[:args_add_block, [[:var_ref, [:@ident, "n", [2, 7]]]],</span></div>
<div style="position:absolute;left:239.00px;top:126.22px" class="cls_030"><span class="cls_030">false]]]]]]]</span></div>
<div style="position:absolute;left:120.00px;top:148.72px" class="cls_038"><span class="cls_038">Listing 1-19: The output generated by </span><span class="cls_014">Ripper.sexp</span></div>
<div style="position:absolute;left:138.00px;top:171.24px" class="cls_007"><span class="cls_007">You can see some bits and pieces from the Ruby script in this cryptic</span></div>
<div style="position:absolute;left:120.00px;top:183.24px" class="cls_007"><span class="cls_007">text, but what do all of the other symbols and arrays mean?</span></div>
<div style="position:absolute;left:138.00px;top:195.24px" class="cls_007"><span class="cls_007">It turns out that the output from Ripper is a textual representation of</span></div>
<div style="position:absolute;left:120.00px;top:207.24px" class="cls_007"><span class="cls_007">your Ruby code. As Ruby parses your code, matching one grammar rule</span></div>
<div style="position:absolute;left:120.00px;top:219.24px" class="cls_007"><span class="cls_007">after another, it converts the tokens in your code file into a complex inter-</span></div>
<div style="position:absolute;left:120.00px;top:231.24px" class="cls_007"><span class="cls_007">nal data structure called an </span><span class="cls_008">abstract syntax tree (AST)</span><span class="cls_007">. (You can see some</span></div>
<div style="position:absolute;left:120.00px;top:243.24px" class="cls_007"><span class="cls_007">of the C code that produces this structure in “Reading a Bison Grammar</span></div>
<div style="position:absolute;left:120.00px;top:255.24px" class="cls_007"><span class="cls_007">Rule” on page 22.) The AST is used to record the structure and syntacti-</span></div>
<div style="position:absolute;left:120.00px;top:267.24px" class="cls_007"><span class="cls_007">cal meaning of your Ruby code.</span></div>
<div style="position:absolute;left:138.00px;top:279.24px" class="cls_007"><span class="cls_007">To see what I mean, look at Figure 1-31, which shows a graphical view of</span></div>
<div style="position:absolute;left:120.00px;top:291.24px" class="cls_007"><span class="cls_007">part of the output that Ripper generated for us: the </span><span class="cls_030">puts n</span><span class="cls_007"> statement inside</span></div>
<div style="position:absolute;left:120.00px;top:303.24px" class="cls_007"><span class="cls_007">the block.</span></div>
<div style="position:absolute;left:123.75px;top:328.14px" class="cls_064"><span class="cls_064">puts n</span></div>
<div style="position:absolute;left:217.10px;top:361.39px" class="cls_040"><span class="cls_040">command</span></div>
<div style="position:absolute;left:133.81px;top:407.14px" class="cls_040"><span class="cls_040">identifier</span></div>
<div style="position:absolute;left:291.81px;top:407.14px" class="cls_040"><span class="cls_040">args add</span></div>
<div style="position:absolute;left:147.72px;top:417.63px" class="cls_038"><span class="cls_038">puts</span></div>
<div style="position:absolute;left:298.19px;top:417.63px" class="cls_040"><span class="cls_040">block</span></div>
<div style="position:absolute;left:293.94px;top:466.39px" class="cls_040"><span class="cls_040">var ref</span></div>
<div style="position:absolute;left:287.56px;top:515.14px" class="cls_040"><span class="cls_040">identifier</span></div>
<div style="position:absolute;left:306.57px;top:525.63px" class="cls_038"><span class="cls_038">n</span></div>
<div style="position:absolute;left:120.00px;top:567.64px" class="cls_038"><span class="cls_038">Figure 1-31: The portion of the AST corresponding to </span><span class="cls_014">puts n</span></div>
<div style="position:absolute;left:48.00px;top:633.00px" class="cls_020"><span class="cls_020">24</span></div>
<div style="position:absolute;left:69.84px;top:636.00px" class="cls_021"><span class="cls_021">Chapter 1</span></div>
</div>
<div style="position:absolute;left:50%;margin-left:-252px;top:30420px;width:504px;height:666px;border-style:outset;overflow:hidden">
<div style="position:absolute;left:0px;top:0px">
<img src="e698b76e-46bd-11eb-8b25-0cc47a792c0a_id_e698b76e-46bd-11eb-8b25-0cc47a792c0a_files/background049.jpg" width=504 height=666></div>
<div style="position:absolute;left:141.00px;top:42.28px" class="cls_007"><span class="cls_007">This diagram corresponds to the last three lines of the Ripper output,</span></div>
<div style="position:absolute;left:123.00px;top:54.28px" class="cls_007"><span class="cls_007">repeated here in Listing 1-20.</span></div>
<div style="position:absolute;left:123.00px;top:78.28px" class="cls_030"><span class="cls_030">[[:command,</span></div>
<div style="position:absolute;left:111.15px;top:88.78px" class="cls_046"><span class="cls_046">u</span></div>
<div style="position:absolute;left:135.73px;top:88.78px" class="cls_030"><span class="cls_030">[:@ident, "puts", [2, 2]],</span></div>
<div style="position:absolute;left:135.75px;top:99.28px" class="cls_030"><span class="cls_030">[:args_add_block, [[:var_ref, [:@ident, "n", [2, 7]]]],</span></div>
<div style="position:absolute;left:212.25px;top:109.77px" class="cls_030"><span class="cls_030">false]]]</span></div>
<div style="position:absolute;left:123.00px;top:132.27px" class="cls_038"><span class="cls_038">Listing 1-20: The last three lines of the </span><span class="cls_014">Ripper.sexp</span><span class="cls_038"> output</span></div>
<div style="position:absolute;left:141.00px;top:154.78px" class="cls_007"><span class="cls_007">As in Experiment 1-1, when we displayed token information from Ripper,</span></div>
<div style="position:absolute;left:123.00px;top:166.78px" class="cls_007"><span class="cls_007">you can see that the source code file line and column information are dis-</span></div>
<div style="position:absolute;left:123.00px;top:178.78px" class="cls_007"><span class="cls_007">played as integers. For example, </span><span class="cls_030">[2, 2]</span><span class="cls_007"> </span><span class="cls_050">u</span><span class="cls_007"> indicates that Ripper found the</span></div>
<div style="position:absolute;left:123.00px;top:190.78px" class="cls_030"><span class="cls_030">puts</span><span class="cls_007"> call on line 2 at column 2 of the code file. You can also see that Ripper</span></div>
<div style="position:absolute;left:123.00px;top:202.78px" class="cls_007"><span class="cls_007">outputs an array for each of the nodes in the AST—with </span><span class="cls_030">[:@ident, "puts",</span></div>
<div style="position:absolute;left:123.00px;top:214.78px" class="cls_030"><span class="cls_030">[2, 2]]</span><span class="cls_007"> </span><span class="cls_050">u</span><span class="cls_007">, for example.</span></div>
<div style="position:absolute;left:141.00px;top:226.78px" class="cls_007"><span class="cls_007">Now your Ruby program is beginning to “make sense” to Ruby. Instead</span></div>
<div style="position:absolute;left:123.00px;top:238.78px" class="cls_007"><span class="cls_007">of a simple stream of tokens, which could mean anything, Ruby now has a</span></div>
<div style="position:absolute;left:123.00px;top:250.78px" class="cls_007"><span class="cls_007">detailed description of what you meant when you wrote </span><span class="cls_030">puts n</span><span class="cls_007">. You see a</span></div>
<div style="position:absolute;left:123.00px;top:262.78px" class="cls_007"><span class="cls_007">function call (a command), followed by an identifier node that indicates</span></div>
<div style="position:absolute;left:123.00px;top:274.78px" class="cls_007"><span class="cls_007">which function to call.</span></div>
<div style="position:absolute;left:141.00px;top:286.78px" class="cls_007"><span class="cls_007">Ruby uses the </span><span class="cls_030">args_add_block</span><span class="cls_007"> node because you could pass a block to a</span></div>
<div style="position:absolute;left:123.00px;top:298.78px" class="cls_007"><span class="cls_007">command/function call like this. Even though you’re not passing a block</span></div>
<div style="position:absolute;left:123.00px;top:310.78px" class="cls_007"><span class="cls_007">in this case, the </span><span class="cls_030">args_add_block</span><span class="cls_007"> node is still saved into the AST. (Notice, too,</span></div>
<div style="position:absolute;left:123.00px;top:322.78px" class="cls_007"><span class="cls_007">how the </span><span class="cls_030">n</span><span class="cls_007"> identifier is recorded as a </span><span class="cls_030">:var_ref</span><span class="cls_007">, or variable reference node, not</span></div>
<div style="position:absolute;left:123.00px;top:334.78px" class="cls_007"><span class="cls_007">as a simple identifier.)</span></div>
<div style="position:absolute;left:141.00px;top:346.78px" class="cls_007"><span class="cls_007">Figure 1-32 represents more of the Ripper output.</span></div>
<div style="position:absolute;left:126.75px;top:371.68px" class="cls_064"><span class="cls_064">... do |n|</span></div>
<div style="position:absolute;left:136.25px;top:384.18px" class="cls_064"><span class="cls_064">puts n</span></div>
<div style="position:absolute;left:126.75px;top:396.68px" class="cls_064"><span class="cls_064">end</span></div>
<div style="position:absolute;left:217.97px;top:395.93px" class="cls_040"><span class="cls_040">do block</span></div>
<div style="position:absolute;left:215.85px;top:449.93px" class="cls_040"><span class="cls_040">block var</span></div>
<div style="position:absolute;left:352.89px;top:469.07px" class="cls_059"><span class="cls_059">puts n</span></div>
<div style="position:absolute;left:222.22px;top:503.93px" class="cls_040"><span class="cls_040">params</span></div>
<div style="position:absolute;left:213.72px;top:552.68px" class="cls_040"><span class="cls_040">identifier</span></div>
<div style="position:absolute;left:232.73px;top:563.18px" class="cls_038"><span class="cls_038">n</span></div>
<div style="position:absolute;left:123.00px;top:602.18px" class="cls_038"><span class="cls_038">Figure 1-32: The portion of the AST corresponding to the entire block</span></div>
<div style="position:absolute;left:365.95px;top:636.00px" class="cls_021"><span class="cls_021">Tokenization and Parsing</span></div>
<div style="position:absolute;left:447.07px;top:633.00px" class="cls_020"><span class="cls_020">25</span></div>
</div>
<div style="position:absolute;left:50%;margin-left:-252px;top:31096px;width:504px;height:666px;border-style:outset;overflow:hidden">
<div style="position:absolute;left:0px;top:0px">
<img src="e698b76e-46bd-11eb-8b25-0cc47a792c0a_id_e698b76e-46bd-11eb-8b25-0cc47a792c0a_files/background050.jpg" width=504 height=666></div>
<div style="position:absolute;left:138.00px;top:42.28px" class="cls_007"><span class="cls_007">You can see that Ruby now understands that </span><span class="cls_030">do |n| ... end</span><span class="cls_007"> is a block,</span></div>
<div style="position:absolute;left:120.00px;top:54.28px" class="cls_007"><span class="cls_007">with a single block parameter called </span><span class="cls_030">n</span><span class="cls_007">. The </span><span class="cls_030">puts n</span><span class="cls_007"> box on the right repre-</span></div>
<div style="position:absolute;left:120.01px;top:66.28px" class="cls_007"><span class="cls_007">sents the other part of the AST shown earlier—the parsed version of the</span></div>
<div style="position:absolute;left:120.00px;top:78.28px" class="cls_030"><span class="cls_030">puts</span><span class="cls_007"> call.</span></div>
<div style="position:absolute;left:138.00px;top:90.28px" class="cls_007"><span class="cls_007">Finally, Figure 1-33 shows the entire AST for the sample Ruby code.</span></div>
<div style="position:absolute;left:123.75px;top:115.18px" class="cls_064"><span class="cls_064">10.times do |n|</span></div>
<div style="position:absolute;left:133.25px;top:128.68px" class="cls_064"><span class="cls_064">puts n</span></div>
<div style="position:absolute;left:217.10px;top:140.93px" class="cls_040"><span class="cls_040">program</span></div>
<div style="position:absolute;left:123.75px;top:143.18px" class="cls_064"><span class="cls_064">end</span></div>
<div style="position:absolute;left:219.22px;top:189.68px" class="cls_040"><span class="cls_040">method</span></div>
<div style="position:absolute;left:212.85px;top:200.18px" class="cls_040"><span class="cls_040">add block</span></div>
<div style="position:absolute;left:223.47px;top:248.93px" class="cls_040"><span class="cls_040">call</span></div>
<div style="position:absolute;left:390.59px;top:253.41px" class="cls_064"><span class="cls_064">... do |n|</span></div>
<div style="position:absolute;left:399.09px;top:264.91px" class="cls_064"><span class="cls_064">puts n</span></div>
<div style="position:absolute;left:390.59px;top:277.41px" class="cls_064"><span class="cls_064">end</span></div>
<div style="position:absolute;left:140.19px;top:297.68px" class="cls_040"><span class="cls_040">integer</span></div>
<div style="position:absolute;left:287.56px;top:297.68px" class="cls_040"><span class="cls_040">identifier</span></div>
<div style="position:absolute;left:219.22px;top:302.93px" class="cls_040"><span class="cls_040">period</span></div>
<div style="position:absolute;left:149.83px;top:308.18px" class="cls_038"><span class="cls_038">10</span></div>
<div style="position:absolute;left:299.51px;top:308.18px" class="cls_038"><span class="cls_038">times</span></div>
<div style="position:absolute;left:120.00px;top:345.68px" class="cls_038"><span class="cls_038">Figure 1-33: The AST for the entire Ruby program</span></div>
<div style="position:absolute;left:138.00px;top:368.18px" class="cls_007"><span class="cls_007">Here, </span><span class="cls_030">method add block</span><span class="cls_007"> means that you’re calling a method, but with a</span></div>
<div style="position:absolute;left:120.00px;top:380.18px" class="cls_007"><span class="cls_007">block parameter: </span><span class="cls_030">10.times do</span><span class="cls_007">. The </span><span class="cls_030">call</span><span class="cls_007"> tree node obviously represents the</span></div>
<div style="position:absolute;left:120.00px;top:392.18px" class="cls_007"><span class="cls_007">actual method call </span><span class="cls_030">10.times</span><span class="cls_007">. This is the </span><span class="cls_030">NODE_CALL</span><span class="cls_007"> node that we saw earlier in</span></div>
<div style="position:absolute;left:120.00px;top:404.18px" class="cls_007"><span class="cls_007">the C code snippet. Ruby’s understanding of what you meant with your code</span></div>
<div style="position:absolute;left:120.00px;top:416.18px" class="cls_007"><span class="cls_007">is saved in the way the nodes are arranged in the AST.</span></div>
<div style="position:absolute;left:138.00px;top:428.18px" class="cls_007"><span class="cls_007">To clarify things, suppose you pass the Ruby expression </span><span class="cls_030">2 + 2</span><span class="cls_007"> to Ripper,</span></div>
<div style="position:absolute;left:120.00px;top:440.18px" class="cls_007"><span class="cls_007">as shown in Listing 1-21.</span></div>
<div style="position:absolute;left:120.00px;top:464.18px" class="cls_030"><span class="cls_030">require 'ripper'</span></div>
<div style="position:absolute;left:120.00px;top:474.68px" class="cls_030"><span class="cls_030">require 'pp'</span></div>
<div style="position:absolute;left:120.00px;top:485.17px" class="cls_030"><span class="cls_030">code = &lt;&lt;STR</span></div>
<div style="position:absolute;left:120.00px;top:495.67px" class="cls_030"><span class="cls_030">2 + 2</span></div>
<div style="position:absolute;left:120.00px;top:506.17px" class="cls_030"><span class="cls_030">STR</span></div>
<div style="position:absolute;left:120.00px;top:516.67px" class="cls_030"><span class="cls_030">puts code</span></div>
<div style="position:absolute;left:120.00px;top:527.16px" class="cls_030"><span class="cls_030">pp Ripper.sexp(code)</span></div>
<div style="position:absolute;left:120.00px;top:549.66px" class="cls_038"><span class="cls_038">Listing 1-21: This code will display the AST for </span><span class="cls_014">2 + 2</span><span class="cls_038">.</span></div>
<div style="position:absolute;left:48.00px;top:633.00px" class="cls_020"><span class="cls_020">26</span></div>
<div style="position:absolute;left:69.90px;top:636.00px" class="cls_021"><span class="cls_021">Chapter 1</span></div>
</div>
<div style="position:absolute;left:50%;margin-left:-252px;top:31772px;width:504px;height:666px;border-style:outset;overflow:hidden">
<div style="position:absolute;left:0px;top:0px">
<img src="e698b76e-46bd-11eb-8b25-0cc47a792c0a_id_e698b76e-46bd-11eb-8b25-0cc47a792c0a_files/background051.jpg" width=504 height=666></div>
<div style="position:absolute;left:141.00px;top:41.60px" class="cls_007"><span class="cls_007">Running this code gives the output in Listing 1-22.</span></div>
<div style="position:absolute;left:123.00px;top:65.60px" class="cls_030"><span class="cls_030">[:program,</span></div>
<div style="position:absolute;left:131.50px;top:76.10px" class="cls_030"><span class="cls_030">[[:binary,</span></div>
<div style="position:absolute;left:144.25px;top:86.60px" class="cls_030"><span class="cls_030">[:@int, "2", [1, 0]],</span></div>
<div style="position:absolute;left:144.25px;top:97.09px" class="cls_030"><span class="cls_030">:+,</span></div>
<div style="position:absolute;left:144.25px;top:107.59px" class="cls_030"><span class="cls_030">[:@int, "2", [1, 4]]]]]</span></div>
<div style="position:absolute;left:123.00px;top:130.09px" class="cls_038"><span class="cls_038">Listing 1-22: The output of </span><span class="cls_014">Ripper.sexp</span><span class="cls_038"> for </span><span class="cls_014">2 + 2</span></div>
<div style="position:absolute;left:141.00px;top:152.60px" class="cls_007"><span class="cls_007">As you can see in Figure 1-34 below, the </span><span class="cls_030">+</span><span class="cls_007"> is represented with an AST</span></div>
<div style="position:absolute;left:123.00px;top:164.60px" class="cls_007"><span class="cls_007">node called </span><span class="cls_030">binary</span><span class="cls_007">.</span></div>
<div style="position:absolute;left:126.75px;top:189.50px" class="cls_064"><span class="cls_064">2 + 2</span></div>
<div style="position:absolute;left:219.88px;top:221.25px" class="cls_040"><span class="cls_040">program</span></div>
<div style="position:absolute;left:222.00px;top:275.25px" class="cls_040"><span class="cls_040">binary</span></div>
<div style="position:absolute;left:143.00px;top:324.00px" class="cls_040"><span class="cls_040">integer</span></div>
<div style="position:absolute;left:296.75px;top:324.00px" class="cls_040"><span class="cls_040">integer</span></div>
<div style="position:absolute;left:226.25px;top:329.25px" class="cls_040"><span class="cls_040">plus</span></div>
<div style="position:absolute;left:155.38px;top:334.50px" class="cls_038"><span class="cls_038">2</span></div>
<div style="position:absolute;left:309.01px;top:334.50px" class="cls_038"><span class="cls_038">2</span></div>
<div style="position:absolute;left:123.00px;top:375.00px" class="cls_038"><span class="cls_038">Figure 1-34: The AST for </span><span class="cls_014">2 + 2</span></div>
<div style="position:absolute;left:141.00px;top:397.50px" class="cls_007"><span class="cls_007">But see what happens when I pass the expression </span><span class="cls_030">2 + 2 * 3</span><span class="cls_007"> into Ripper,</span></div>
<div style="position:absolute;left:123.00px;top:409.50px" class="cls_007"><span class="cls_007">as in Listing 1-23.</span></div>
<div style="position:absolute;left:123.00px;top:433.50px" class="cls_030"><span class="cls_030">require 'ripper'</span></div>
<div style="position:absolute;left:123.00px;top:444.00px" class="cls_030"><span class="cls_030">require 'pp'</span></div>
<div style="position:absolute;left:123.00px;top:454.49px" class="cls_030"><span class="cls_030">code = &lt;&lt;STR</span></div>
<div style="position:absolute;left:123.00px;top:464.99px" class="cls_030"><span class="cls_030">2 + 2 * 3</span></div>
<div style="position:absolute;left:123.00px;top:475.49px" class="cls_030"><span class="cls_030">STR</span></div>
<div style="position:absolute;left:123.00px;top:485.99px" class="cls_030"><span class="cls_030">puts code</span></div>
<div style="position:absolute;left:123.00px;top:496.48px" class="cls_030"><span class="cls_030">pp Ripper.sexp(code)</span></div>
<div style="position:absolute;left:123.00px;top:518.98px" class="cls_038"><span class="cls_038">Listing 1-23: Code to display the AST for </span><span class="cls_014">2 + 2 * 3</span></div>
<div style="position:absolute;left:141.00px;top:541.50px" class="cls_007"><span class="cls_007">Listing 1-24 shows that you get a second binary node for the </span><span class="cls_030">*</span><span class="cls_007"> operator</span></div>
<div style="position:absolute;left:123.00px;top:553.50px" class="cls_007"><span class="cls_007">at </span><span class="cls_050">u</span><span class="cls_007">.</span></div>
<div style="position:absolute;left:365.92px;top:636.00px" class="cls_021"><span class="cls_021">Tokenization and Parsing</span></div>
<div style="position:absolute;left:447.04px;top:633.00px" class="cls_020"><span class="cls_020">27</span></div>
</div>
<div style="position:absolute;left:50%;margin-left:-252px;top:32448px;width:504px;height:666px;border-style:outset;overflow:hidden">
<div style="position:absolute;left:0px;top:0px">
<img src="e698b76e-46bd-11eb-8b25-0cc47a792c0a_id_e698b76e-46bd-11eb-8b25-0cc47a792c0a_files/background052.jpg" width=504 height=666></div>
<div style="position:absolute;left:120.00px;top:49.00px" class="cls_030"><span class="cls_030">[:program,</span></div>
<div style="position:absolute;left:124.25px;top:59.50px" class="cls_030"><span class="cls_030">[[:binary,</span></div>
<div style="position:absolute;left:132.75px;top:70.00px" class="cls_030"><span class="cls_030">[:@int, "2", [1, 0]],</span></div>
<div style="position:absolute;left:132.75px;top:80.49px" class="cls_030"><span class="cls_030">:+,</span></div>
<div style="position:absolute;left:108.15px;top:90.99px" class="cls_046"><span class="cls_046">u</span></div>
<div style="position:absolute;left:132.73px;top:90.99px" class="cls_030"><span class="cls_030">[:binary,</span></div>
<div style="position:absolute;left:141.25px;top:101.49px" class="cls_030"><span class="cls_030">[:@int, "2", [1, 4]],</span></div>
<div style="position:absolute;left:141.25px;top:111.99px" class="cls_030"><span class="cls_030">:*,</span></div>
<div style="position:absolute;left:141.25px;top:122.48px" class="cls_030"><span class="cls_030">[:@int, "3", [1, 8]]]]]]</span></div>
<div style="position:absolute;left:120.00px;top:144.98px" class="cls_038"><span class="cls_038">Listing 1-24: The output of </span><span class="cls_014">Ripper.sexp</span><span class="cls_038"> for </span><span class="cls_014">2 + 2 * 3</span></div>
<div style="position:absolute;left:138.00px;top:167.50px" class="cls_007"><span class="cls_007">Figure 1-35 shows what that looks like.</span></div>
<div style="position:absolute;left:123.75px;top:192.40px" class="cls_064"><span class="cls_064">2 + 2 * 3</span></div>
<div style="position:absolute;left:216.88px;top:224.15px" class="cls_040"><span class="cls_040">program</span></div>
<div style="position:absolute;left:219.00px;top:278.15px" class="cls_040"><span class="cls_040">binary</span></div>
<div style="position:absolute;left:140.00px;top:326.90px" class="cls_040"><span class="cls_040">integer</span></div>
<div style="position:absolute;left:223.25px;top:332.15px" class="cls_040"><span class="cls_040">plus</span></div>
<div style="position:absolute;left:295.88px;top:332.15px" class="cls_040"><span class="cls_040">binary</span></div>
<div style="position:absolute;left:152.26px;top:337.40px" class="cls_038"><span class="cls_038">2</span></div>
<div style="position:absolute;left:216.88px;top:380.90px" class="cls_040"><span class="cls_040">integer</span></div>
<div style="position:absolute;left:370.62px;top:380.90px" class="cls_040"><span class="cls_040">integer</span></div>
<div style="position:absolute;left:291.63px;top:386.15px" class="cls_040"><span class="cls_040">multiply</span></div>
<div style="position:absolute;left:229.13px;top:391.40px" class="cls_038"><span class="cls_038">2</span></div>
<div style="position:absolute;left:382.88px;top:391.40px" class="cls_038"><span class="cls_038">3</span></div>
<div style="position:absolute;left:120.00px;top:431.90px" class="cls_038"><span class="cls_038">Figure 1-35: The AST for </span><span class="cls_014">2 + 2 * 3</span></div>
<div style="position:absolute;left:138.00px;top:454.40px" class="cls_007"><span class="cls_007">Ruby was smart enough to realize that multiplication has a higher pre-</span></div>
<div style="position:absolute;left:120.00px;top:466.40px" class="cls_007"><span class="cls_007">cedence than addition, but what’s really interesting is how the AST tree</span></div>
<div style="position:absolute;left:120.00px;top:478.40px" class="cls_007"><span class="cls_007">structure captures the information about the order of operations. The</span></div>
<div style="position:absolute;left:120.00px;top:490.40px" class="cls_007"><span class="cls_007">token stream </span><span class="cls_030">2 + 2 * 3</span><span class="cls_007"> simply indicates what you wrote in your code file.</span></div>
<div style="position:absolute;left:120.00px;top:502.40px" class="cls_007"><span class="cls_007">But the parsed version that’s saved to the AST structure now contains the</span></div>
<div style="position:absolute;left:120.00px;top:514.40px" class="cls_008"><span class="cls_008">meaning</span><span class="cls_007"> of your code—that is, all of the information Ruby will need later</span></div>
<div style="position:absolute;left:120.00px;top:526.40px" class="cls_007"><span class="cls_007">to execute it.</span></div>
<div style="position:absolute;left:48.00px;top:633.00px" class="cls_020"><span class="cls_020">28</span></div>
<div style="position:absolute;left:69.96px;top:636.00px" class="cls_021"><span class="cls_021">Chapter 1</span></div>
</div>
<div style="position:absolute;left:50%;margin-left:-252px;top:33124px;width:504px;height:666px;border-style:outset;overflow:hidden">
<div style="position:absolute;left:0px;top:0px">
<img src="e698b76e-46bd-11eb-8b25-0cc47a792c0a_id_e698b76e-46bd-11eb-8b25-0cc47a792c0a_files/background053.jpg" width=504 height=666></div>
<div style="position:absolute;left:141.00px;top:41.60px" class="cls_007"><span class="cls_007">One final note: Ruby actually contains some debug code that can dis-</span></div>
<div style="position:absolute;left:123.00px;top:53.60px" class="cls_007"><span class="cls_007">play information about the AST node structure. To use it, run your Ruby</span></div>
<div style="position:absolute;left:123.00px;top:65.60px" class="cls_007"><span class="cls_007">script with the </span><span class="cls_030">parsetree</span><span class="cls_007"> option (see Listing 1-25).</span></div>
<div style="position:absolute;left:123.00px;top:89.60px" class="cls_030"><span class="cls_030">$ </span><span class="cls_040">ruby --dump parsetree your_script.rb</span></div>
<div style="position:absolute;left:123.00px;top:112.10px" class="cls_038"><span class="cls_038">Listing 1-25: Display debug information about your code’s AST using the </span><span class="cls_014">parsetree</span><span class="cls_038"> option.</span></div>
<div style="position:absolute;left:141.00px;top:134.60px" class="cls_007"><span class="cls_007">This will display the same information we’ve just seen, but instead of</span></div>
<div style="position:absolute;left:123.00px;top:146.60px" class="cls_007"><span class="cls_007">showing symbols, the </span><span class="cls_030">parsetree</span><span class="cls_007"> option should show the actual node names</span></div>
<div style="position:absolute;left:123.00px;top:158.60px" class="cls_007"><span class="cls_007">from the C source code. (In Chapter 2, I’ll also use the actual node names.)</span></div>
<div style="position:absolute;left:69.00px;top:192.60px" class="cls_031"><span class="cls_031">Summary</span></div>
<div style="position:absolute;left:123.00px;top:212.60px" class="cls_007"><span class="cls_007">In Chapter 1, we looked at one of the most fascinating areas of computer</span></div>
<div style="position:absolute;left:123.00px;top:224.60px" class="cls_007"><span class="cls_007">science: how Ruby can </span><span class="cls_008">understand</span><span class="cls_007"> the text that you give it—your Ruby pro-</span></div>
<div style="position:absolute;left:123.00px;top:236.60px" class="cls_007"><span class="cls_007">gram. In order to do this, Ruby converts your code into two different for-</span></div>
<div style="position:absolute;left:123.00px;top:248.60px" class="cls_007"><span class="cls_007">mats. First, it converts the text in your Ruby program into a series of </span><span class="cls_008">tokens</span><span class="cls_007">.</span></div>
<div style="position:absolute;left:123.00px;top:260.60px" class="cls_007"><span class="cls_007">Next, it uses an LALR parser to convert the input stream of tokens into a</span></div>
<div style="position:absolute;left:123.00px;top:272.60px" class="cls_007"><span class="cls_007">data structure called an </span><span class="cls_008">abstract syntax tree</span><span class="cls_007">.</span></div>
<div style="position:absolute;left:141.00px;top:284.60px" class="cls_007"><span class="cls_007">In Chapter 2, we’ll see that Ruby converts your code into a third format:</span></div>
<div style="position:absolute;left:123.00px;top:296.60px" class="cls_007"><span class="cls_007">a series of </span><span class="cls_008">bytecode instructions</span><span class="cls_007"> that are later used when your program is actu-</span></div>
<div style="position:absolute;left:123.00px;top:308.60px" class="cls_007"><span class="cls_007">ally executed.</span></div>
<div style="position:absolute;left:365.86px;top:636.00px" class="cls_021"><span class="cls_021">Tokenization and Parsing</span></div>
<div style="position:absolute;left:446.98px;top:633.00px" class="cls_020"><span class="cls_020">29</span></div>
</div>
<div style="position:absolute;left:50%;margin-left:-252px;top:33800px;width:504px;height:666px;border-style:outset;overflow:hidden">
<div style="position:absolute;left:0px;top:0px">
<img src="e698b76e-46bd-11eb-8b25-0cc47a792c0a_id_e698b76e-46bd-11eb-8b25-0cc47a792c0a_files/background054.jpg" width=504 height=666></div>
<div style="position:absolute;left:234.07px;top:297.91px" class="cls_024"><span class="cls_024">The code Ruby actually</span></div>
<div style="position:absolute;left:235.19px;top:315.92px" class="cls_024"><span class="cls_024">runs looks nothing like</span></div>
<div style="position:absolute;left:246.36px;top:333.92px" class="cls_024"><span class="cls_024">your original code.</span></div>
</div>
<div style="position:absolute;left:50%;margin-left:-252px;top:34476px;width:504px;height:666px;border-style:outset;overflow:hidden">
<div style="position:absolute;left:0px;top:0px">
<img src="e698b76e-46bd-11eb-8b25-0cc47a792c0a_id_e698b76e-46bd-11eb-8b25-0cc47a792c0a_files/background055.jpg" width=504 height=666></div>
<div style="position:absolute;left:260.10px;top:101.45px" class="cls_035"><span class="cls_035">2</span></div>
<div style="position:absolute;left:222.37px;top:253.45px" class="cls_016"><span class="cls_016">Compilation</span></div>
<div style="position:absolute;left:123.00px;top:369.45px" class="cls_023"><span class="cls_023">Now that Ruby has tokenized and parsed your code,</span></div>
<div style="position:absolute;left:123.00px;top:387.46px" class="cls_023"><span class="cls_023">is it ready to run it? Will it finally get to work and iter-</span></div>
<div style="position:absolute;left:123.00px;top:405.45px" class="cls_023"><span class="cls_023">ate through the block 10 times in my simple </span><span class="cls_028">10.times do</span></div>
<div style="position:absolute;left:123.00px;top:423.46px" class="cls_023"><span class="cls_023">example? If not, what else could Ruby possibly have to</span></div>
<div style="position:absolute;left:123.00px;top:441.46px" class="cls_023"><span class="cls_023">do first?</span></div>
<div style="position:absolute;left:141.00px;top:460.45px" class="cls_007"><span class="cls_007">Starting with version 1.9, Ruby compiles your code before executing</span></div>
<div style="position:absolute;left:123.00px;top:472.45px" class="cls_007"><span class="cls_007">it. The word </span><span class="cls_008">compile</span><span class="cls_007"> means to translate your code from one program-</span></div>
<div style="position:absolute;left:123.00px;top:484.45px" class="cls_007"><span class="cls_007">ming language to another. Your programming language is easy for you</span></div>
<div style="position:absolute;left:123.00px;top:496.45px" class="cls_007"><span class="cls_007">to understand, while usually the target language is easy for the computer to</span></div>
<div style="position:absolute;left:123.00px;top:508.45px" class="cls_007"><span class="cls_007">understand.</span></div>
<div style="position:absolute;left:141.00px;top:520.45px" class="cls_007"><span class="cls_007">For example, when you compile a C program, the compiler translates</span></div>
<div style="position:absolute;left:123.00px;top:532.45px" class="cls_007"><span class="cls_007">C code to machine language, a language your computer’s microprocessor</span></div>
<div style="position:absolute;left:123.00px;top:544.45px" class="cls_007"><span class="cls_007">hardware understands. When you compile a Java program, the compiler</span></div>
<div style="position:absolute;left:123.00px;top:556.45px" class="cls_007"><span class="cls_007">translates Java code to Java bytecode, a language the Java Virtual Machine</span></div>
<div style="position:absolute;left:123.00px;top:568.45px" class="cls_007"><span class="cls_007">understands.</span></div>
<div style="position:absolute;left:141.00px;top:580.45px" class="cls_007"><span class="cls_007">Ruby’s compiler is no different. It translates your Ruby code into</span></div>
<div style="position:absolute;left:123.00px;top:592.45px" class="cls_007"><span class="cls_007">another language that Ruby’s virtual machine understands. The only dif-</span></div>
<div style="position:absolute;left:123.00px;top:604.45px" class="cls_007"><span class="cls_007">ference is that you don’t use Ruby’s compiler directly; unlike in C or Java,</span></div>
</div>
<div style="position:absolute;left:50%;margin-left:-252px;top:35152px;width:504px;height:666px;border-style:outset;overflow:hidden">
<div style="position:absolute;left:0px;top:0px">
<img src="e698b76e-46bd-11eb-8b25-0cc47a792c0a_id_e698b76e-46bd-11eb-8b25-0cc47a792c0a_files/background056.jpg" width=504 height=666></div>
<div style="position:absolute;left:120.00px;top:41.60px" class="cls_007"><span class="cls_007">Ruby’s compiler runs automatically without you ever knowing. Here in</span></div>
<div style="position:absolute;left:120.00px;top:53.60px" class="cls_007"><span class="cls_007">Chapter 2, I’ll explain how Ruby does this and what language it translates</span></div>
<div style="position:absolute;left:120.00px;top:65.60px" class="cls_007"><span class="cls_007">your code into.</span></div>
<div style="position:absolute;left:261.47px;top:106.31px" class="cls_020"><span class="cls_020">Roadmap</span></div>
<div style="position:absolute;left:132.00px;top:123.31px" class="cls_017"><span class="cls_017">No Compiler for Ruby 1.8</span></div>
<div style="position:absolute;left:420.91px;top:123.31px" class="cls_017"><span class="cls_017">32</span></div>
<div style="position:absolute;left:132.00px;top:140.32px" class="cls_017"><span class="cls_017">Ruby 1.9 and 2.0 Introduce a Compiler</span></div>
<div style="position:absolute;left:420.91px;top:140.32px" class="cls_017"><span class="cls_017">33</span></div>
<div style="position:absolute;left:132.00px;top:157.32px" class="cls_017"><span class="cls_017">How Ruby Compiles a Simple Script</span></div>
<div style="position:absolute;left:420.91px;top:157.32px" class="cls_017"><span class="cls_017">34</span></div>
<div style="position:absolute;left:132.00px;top:174.32px" class="cls_017"><span class="cls_017">Compiling a Call to a Block</span></div>
<div style="position:absolute;left:420.91px;top:174.32px" class="cls_017"><span class="cls_017">38</span></div>
<div style="position:absolute;left:150.00px;top:191.32px" class="cls_017"><span class="cls_017">How Ruby Iterates Through the AST</span></div>
<div style="position:absolute;left:420.91px;top:191.32px" class="cls_017"><span class="cls_017">42</span></div>
<div style="position:absolute;left:132.00px;top:208.32px" class="cls_019"><span class="cls_019">Experiment 2-1: Displaying YARV Instructions</span></div>
<div style="position:absolute;left:421.59px;top:208.32px" class="cls_019"><span class="cls_019">44</span></div>
<div style="position:absolute;left:132.00px;top:225.32px" class="cls_017"><span class="cls_017">The Local Table</span></div>
<div style="position:absolute;left:420.91px;top:225.32px" class="cls_017"><span class="cls_017">46</span></div>
<div style="position:absolute;left:150.00px;top:242.32px" class="cls_017"><span class="cls_017">Compiling Optional Arguments</span></div>
<div style="position:absolute;left:420.91px;top:242.32px" class="cls_017"><span class="cls_017">48</span></div>
<div style="position:absolute;left:150.00px;top:259.32px" class="cls_017"><span class="cls_017">Compiling Keyword Arguments</span></div>
<div style="position:absolute;left:420.91px;top:259.32px" class="cls_017"><span class="cls_017">49</span></div>
<div style="position:absolute;left:132.00px;top:276.32px" class="cls_019"><span class="cls_019">Experiment 2-2: Displaying the Local Table</span></div>
<div style="position:absolute;left:421.59px;top:276.32px" class="cls_019"><span class="cls_019">51</span></div>
<div style="position:absolute;left:132.00px;top:293.32px" class="cls_017"><span class="cls_017">Summary</span></div>
<div style="position:absolute;left:420.91px;top:293.32px" class="cls_017"><span class="cls_017">53</span></div>
<div style="position:absolute;left:66.00px;top:339.60px" class="cls_031"><span class="cls_031">No Compiler for Ruby 1.8</span></div>
<div style="position:absolute;left:406.60px;top:355.09px" class="cls_067"><span class="cls_067">Ruby</span></div>
<div style="position:absolute;left:120.00px;top:359.60px" class="cls_007"><span class="cls_007">The Ruby core team introduced a</span></div>
<div style="position:absolute;left:120.00px;top:371.60px" class="cls_007"><span class="cls_007">compiler with version 1.9. Ruby 1.8</span></div>
<div style="position:absolute;left:120.00px;top:383.60px" class="cls_007"><span class="cls_007">and earlier versions of Ruby don’t</span></div>
<div style="position:absolute;left:296.94px;top:387.63px" class="cls_017"><span class="cls_017">Code You Write</span></div>
<div style="position:absolute;left:403.48px;top:388.43px" class="cls_067"><span class="cls_067">Tokens</span></div>
<div style="position:absolute;left:120.00px;top:395.60px" class="cls_007"><span class="cls_007">contain a compiler. Instead, Ruby 1.8</span></div>
<div style="position:absolute;left:120.00px;top:407.60px" class="cls_007"><span class="cls_007">immediately executes your code</span></div>
<div style="position:absolute;left:120.00px;top:419.60px" class="cls_007"><span class="cls_007">after the tokenizing and parsing</span></div>
<div style="position:absolute;left:396.52px;top:420.97px" class="cls_067"><span class="cls_067">AST Nodes</span></div>
<div style="position:absolute;left:120.00px;top:431.60px" class="cls_007"><span class="cls_007">processes are finished. It does this</span></div>
<div style="position:absolute;left:120.00px;top:443.60px" class="cls_007"><span class="cls_007">by walking through the nodes in</span></div>
<div style="position:absolute;left:120.00px;top:455.60px" class="cls_007"><span class="cls_007">the AST tree and executing each</span></div>
<div style="position:absolute;left:421.24px;top:456.69px" class="cls_054"><span class="cls_054">Interpret</span></div>
<div style="position:absolute;left:120.00px;top:467.60px" class="cls_007"><span class="cls_007">one. Figure 2-1 shows another way</span></div>
<div style="position:absolute;left:120.00px;top:479.60px" class="cls_007"><span class="cls_007">of looking at the Ruby 1.8 tokeniz-</span></div>
<div style="position:absolute;left:120.00px;top:491.60px" class="cls_007"><span class="cls_007">ing and parsing processes.</span></div>
<div style="position:absolute;left:412.98px;top:491.62px" class="cls_067"><span class="cls_067">C</span></div>
<div style="position:absolute;left:311.04px;top:497.72px" class="cls_017"><span class="cls_017">Code the</span></div>
<div style="position:absolute;left:138.00px;top:503.60px" class="cls_007"><span class="cls_007">The top of Figure 2-1 shows</span></div>
<div style="position:absolute;left:296.46px;top:508.52px" class="cls_017"><span class="cls_017">Ruby Core Team</span></div>
<div style="position:absolute;left:120.00px;top:515.60px" class="cls_007"><span class="cls_007">your Ruby code. Below this are the</span></div>
<div style="position:absolute;left:316.10px;top:519.32px" class="cls_017"><span class="cls_017">Writes</span></div>
<div style="position:absolute;left:400.76px;top:520.39px" class="cls_067"><span class="cls_067">Machine</span></div>
<div style="position:absolute;left:120.00px;top:527.60px" class="cls_007"><span class="cls_007">different internal formats Ruby con-</span></div>
<div style="position:absolute;left:398.46px;top:529.99px" class="cls_067"><span class="cls_067">Language</span></div>
<div style="position:absolute;left:120.00px;top:539.60px" class="cls_007"><span class="cls_007">verts your Ruby code into. These</span></div>
<div style="position:absolute;left:120.00px;top:551.60px" class="cls_007"><span class="cls_007">are the tokens and AST nodes we</span></div>
<div style="position:absolute;left:296.46px;top:559.50px" class="cls_038"><span class="cls_038">Figure 2-1: In Ruby 1.8, your code is</span></div>
<div style="position:absolute;left:120.00px;top:563.60px" class="cls_007"><span class="cls_007">saw in Chapter 1—the different</span></div>
<div style="position:absolute;left:296.46px;top:570.00px" class="cls_038"><span class="cls_038">converted into AST nodes and then</span></div>
<div style="position:absolute;left:296.46px;top:580.49px" class="cls_038"><span class="cls_038">interpreted.</span></div>
<div style="position:absolute;left:48.00px;top:633.00px" class="cls_020"><span class="cls_020">32</span></div>
<div style="position:absolute;left:69.88px;top:636.00px" class="cls_021"><span class="cls_021">Chapter 2</span></div>
</div>
<div style="position:absolute;left:50%;margin-left:-252px;top:35828px;width:504px;height:666px;border-style:outset;overflow:hidden">
<div style="position:absolute;left:0px;top:0px">
<img src="e698b76e-46bd-11eb-8b25-0cc47a792c0a_id_e698b76e-46bd-11eb-8b25-0cc47a792c0a_files/background057.jpg" width=504 height=666></div>
<div style="position:absolute;left:123.00px;top:42.28px" class="cls_007"><span class="cls_007">forms your code takes when you run it using Ruby. The lower section of the</span></div>
<div style="position:absolute;left:123.00px;top:54.28px" class="cls_007"><span class="cls_007">diagram shows the code the Ruby core team wrote: the C source code for</span></div>
<div style="position:absolute;left:123.00px;top:66.28px" class="cls_007"><span class="cls_007">the Ruby language and the machine language it is converted into by the C</span></div>
<div style="position:absolute;left:123.00px;top:78.28px" class="cls_007"><span class="cls_007">compiler.</span></div>
<div style="position:absolute;left:141.00px;top:90.28px" class="cls_007"><span class="cls_007">The dotted line between the two code sections indicates that Ruby</span></div>
<div style="position:absolute;left:123.00px;top:102.28px" class="cls_007"><span class="cls_007">interprets your code. The Ruby C code, the lower section, reads and exe-</span></div>
<div style="position:absolute;left:123.00px;top:114.28px" class="cls_007"><span class="cls_007">cutes your code, the top section. Ruby 1.8 doesn’t compile or translate your</span></div>
<div style="position:absolute;left:123.00px;top:126.28px" class="cls_007"><span class="cls_007">code into any form beyond AST nodes. After converting it into AST nodes,</span></div>
<div style="position:absolute;left:123.00px;top:138.28px" class="cls_007"><span class="cls_007">it proceeds to iterate over the nodes in the AST, taking whatever action</span></div>
<div style="position:absolute;left:123.00px;top:150.28px" class="cls_007"><span class="cls_007">each node represents as it executes each node.</span></div>
<div style="position:absolute;left:141.00px;top:162.28px" class="cls_007"><span class="cls_007">The gap in the middle of the diagram shows that your code is never</span></div>
<div style="position:absolute;left:123.00px;top:174.28px" class="cls_007"><span class="cls_007">completely compiled into machine language. If you were to disassemble</span></div>
<div style="position:absolute;left:123.00px;top:186.28px" class="cls_007"><span class="cls_007">and inspect the machine language that your CPU actually runs, you would</span></div>
<div style="position:absolute;left:123.00px;top:198.28px" class="cls_007"><span class="cls_007">not see instructions that directly map to your original Ruby code. Instead,</span></div>
<div style="position:absolute;left:123.00px;top:210.28px" class="cls_007"><span class="cls_007">you would find instructions that tokenize, parse, and execute your code,</span></div>
<div style="position:absolute;left:123.00px;top:222.28px" class="cls_007"><span class="cls_007">or, in other words, that implement the Ruby interpreter.</span></div>
<div style="position:absolute;left:69.00px;top:256.28px" class="cls_031"><span class="cls_031">Ruby 1.9 and 2.0 Introduce a Compiler</span></div>
<div style="position:absolute;left:123.00px;top:276.28px" class="cls_007"><span class="cls_007">If you’ve upgraded to Ruby 1.9 or 2.0, Ruby is still not quite ready to run</span></div>
<div style="position:absolute;left:123.00px;top:288.28px" class="cls_007"><span class="cls_007">your code. It needs to compile it first.</span></div>
<div style="position:absolute;left:141.00px;top:300.28px" class="cls_007"><span class="cls_007">With Ruby 1.9, Koichi Sasada and the Ruby core team introduced Yet</span></div>
<div style="position:absolute;left:123.00px;top:312.28px" class="cls_007"><span class="cls_007">Another Ruby Virtual Machine (YARV), which actually executes your Ruby</span></div>
<div style="position:absolute;left:123.00px;top:324.28px" class="cls_007"><span class="cls_007">code. At a high level, this is the same idea behind the Java Virtual Machine</span></div>
<div style="position:absolute;left:123.00px;top:336.28px" class="cls_007"><span class="cls_007">( JVM) used by Java and many other languages. (I’ll cover YARV in more</span></div>
<div style="position:absolute;left:123.00px;top:348.28px" class="cls_007"><span class="cls_007">detail in Chapters 3 and 4.)</span></div>
<div style="position:absolute;left:141.00px;top:360.28px" class="cls_007"><span class="cls_007">When using YARV (as with the JVM), you first compile your code into</span></div>
<div style="position:absolute;left:123.00px;top:372.28px" class="cls_008"><span class="cls_008">bytecode</span><span class="cls_007">, a series of low-level instructions that the virtual machine under-</span></div>
<div style="position:absolute;left:123.00px;top:384.28px" class="cls_007"><span class="cls_007">stands. The only differences between YARV and the JVM are the following:</span></div>
<div style="position:absolute;left:123.00px;top:405.28px" class="cls_050"><span class="cls_050">•</span><span class="cls_007">   Ruby doesn’t expose the compiler to you as a separate tool. Instead,</span></div>
<div style="position:absolute;left:141.00px;top:417.28px" class="cls_007"><span class="cls_007">it automatically compiles your Ruby code into bytecode instructions</span></div>
<div style="position:absolute;left:141.00px;top:429.28px" class="cls_007"><span class="cls_007">internally.</span></div>
<div style="position:absolute;left:123.00px;top:444.28px" class="cls_050"><span class="cls_050">•</span><span class="cls_007">   Ruby never compiles your Ruby code all the way to machine language.</span></div>
<div style="position:absolute;left:141.00px;top:456.28px" class="cls_007"><span class="cls_007">As you can see in Figure 2-2, Ruby interprets the bytecode instruc-</span></div>
<div style="position:absolute;left:141.00px;top:468.28px" class="cls_007"><span class="cls_007">tions. The JVM, on the other hand, can compile some of the bytecode</span></div>
<div style="position:absolute;left:141.00px;top:480.28px" class="cls_007"><span class="cls_007">instructions all the way into machine language using its “hotspot” or</span></div>
<div style="position:absolute;left:141.00px;top:492.28px" class="cls_007"><span class="cls_007">just-in-time ( JIT) compiler.</span></div>
<div style="position:absolute;left:141.00px;top:513.28px" class="cls_007"><span class="cls_007">Figure 2-2 shows how Ruby 1.9 and 2.0 handle your code.</span></div>
<div style="position:absolute;left:401.64px;top:636.00px" class="cls_021"><span class="cls_021">Compilation</span></div>
<div style="position:absolute;left:446.92px;top:633.00px" class="cls_020"><span class="cls_020">33</span></div>
</div>
<div style="position:absolute;left:50%;margin-left:-252px;top:36504px;width:504px;height:666px;border-style:outset;overflow:hidden">
<div style="position:absolute;left:0px;top:0px">
<img src="e698b76e-46bd-11eb-8b25-0cc47a792c0a_id_e698b76e-46bd-11eb-8b25-0cc47a792c0a_files/background058.jpg" width=504 height=666></div>
<div style="position:absolute;left:138.00px;top:41.60px" class="cls_007"><span class="cls_007">Notice that this time, unlike</span></div>
<div style="position:absolute;left:120.00px;top:53.60px" class="cls_007"><span class="cls_007">in the process shown in Figure 2-1,</span></div>
<div style="position:absolute;left:406.60px;top:58.03px" class="cls_067"><span class="cls_067">Ruby</span></div>
<div style="position:absolute;left:120.00px;top:65.60px" class="cls_007"><span class="cls_007">your code is translated into a third</span></div>
<div style="position:absolute;left:120.00px;top:77.60px" class="cls_007"><span class="cls_007">format. After parsing the tokens and</span></div>
<div style="position:absolute;left:120.00px;top:89.60px" class="cls_007"><span class="cls_007">producing the AST, Ruby 1.9 and</span></div>
<div style="position:absolute;left:403.48px;top:91.37px" class="cls_067"><span class="cls_067">Tokens</span></div>
<div style="position:absolute;left:120.00px;top:101.60px" class="cls_007"><span class="cls_007">2.0 continue to compile your code</span></div>
<div style="position:absolute;left:296.94px;top:106.80px" class="cls_017"><span class="cls_017">Code You Write</span></div>
<div style="position:absolute;left:120.00px;top:113.60px" class="cls_007"><span class="cls_007">into a series of low-level instructions</span></div>
<div style="position:absolute;left:396.51px;top:123.91px" class="cls_067"><span class="cls_067">AST Nodes</span></div>
<div style="position:absolute;left:120.00px;top:125.60px" class="cls_007"><span class="cls_007">called </span><span class="cls_008">YARV instructions</span><span class="cls_007">.</span></div>
<div style="position:absolute;left:138.00px;top:137.60px" class="cls_007"><span class="cls_007">The primary reason for using</span></div>
<div style="position:absolute;left:120.00px;top:149.60px" class="cls_007"><span class="cls_007">YARV is speed: Ruby 1.9 and 2.0</span></div>
<div style="position:absolute;left:405.53px;top:151.82px" class="cls_067"><span class="cls_067">YARV</span></div>
<div style="position:absolute;left:120.00px;top:161.60px" class="cls_007"><span class="cls_007">run much faster than Ruby 1.8</span></div>
<div style="position:absolute;left:396.06px;top:161.42px" class="cls_067"><span class="cls_067">Instructions</span></div>
<div style="position:absolute;left:120.00px;top:173.60px" class="cls_007"><span class="cls_007">due to the use of YARV instruc-</span></div>
<div style="position:absolute;left:120.00px;top:185.60px" class="cls_007"><span class="cls_007">tions. Like Ruby 1.8, YARV is an</span></div>
<div style="position:absolute;left:421.23px;top:191.19px" class="cls_054"><span class="cls_054">Interpret</span></div>
<div style="position:absolute;left:120.00px;top:197.60px" class="cls_007"><span class="cls_007">interpreter—just a faster one. Your</span></div>
<div style="position:absolute;left:120.00px;top:209.60px" class="cls_007"><span class="cls_007">Ruby code ultimately is still not</span></div>
<div style="position:absolute;left:120.00px;top:221.60px" class="cls_007"><span class="cls_007">converted directly into machine</span></div>
<div style="position:absolute;left:412.98px;top:226.30px" class="cls_067"><span class="cls_067">C</span></div>
<div style="position:absolute;left:311.05px;top:230.94px" class="cls_017"><span class="cls_017">Code the</span></div>
<div style="position:absolute;left:120.00px;top:233.60px" class="cls_007"><span class="cls_007">language by Ruby 1.9 or 2.0. There</span></div>
<div style="position:absolute;left:296.46px;top:241.74px" class="cls_017"><span class="cls_017">Ruby Core Team</span></div>
<div style="position:absolute;left:120.00px;top:245.60px" class="cls_007"><span class="cls_007">is still a gap in Figure 2-2 between</span></div>
<div style="position:absolute;left:316.11px;top:252.54px" class="cls_017"><span class="cls_017">Writes</span></div>
<div style="position:absolute;left:400.76px;top:254.43px" class="cls_067"><span class="cls_067">Machine</span></div>
<div style="position:absolute;left:120.00px;top:257.60px" class="cls_007"><span class="cls_007">the YARV instructions and Ruby’s</span></div>
<div style="position:absolute;left:398.46px;top:264.03px" class="cls_067"><span class="cls_067">Language</span></div>
<div style="position:absolute;left:120.00px;top:269.60px" class="cls_007"><span class="cls_007">C code.</span></div>
<div style="position:absolute;left:296.45px;top:292.15px" class="cls_038"><span class="cls_038">Figure 2-2: Ruby 1.9 and 2.0 compile the</span></div>
<div style="position:absolute;left:296.45px;top:302.65px" class="cls_038"><span class="cls_038">AST nodes into YARV instructions before</span></div>
<div style="position:absolute;left:296.45px;top:313.15px" class="cls_038"><span class="cls_038">interpreting them.</span></div>
<div style="position:absolute;left:66.00px;top:345.60px" class="cls_031"><span class="cls_031">How Ruby Compiles a Simple Script</span></div>
<div style="position:absolute;left:120.00px;top:365.60px" class="cls_007"><span class="cls_007">In this section, we’ll look at the last step along your code’s journey through</span></div>
<div style="position:absolute;left:120.00px;top:377.60px" class="cls_007"><span class="cls_007">Ruby: how Ruby compiles your code into the instructions that YARV expects.</span></div>
<div style="position:absolute;left:120.00px;top:389.60px" class="cls_007"><span class="cls_007">Let’s explore how Ruby’s compiler works by stepping through an example</span></div>
<div style="position:absolute;left:120.00px;top:401.60px" class="cls_007"><span class="cls_007">compilation. Listing 2-1 shows a simple Ruby script that calculates 2 + 2 = 4.</span></div>
<div style="position:absolute;left:120.00px;top:425.60px" class="cls_030"><span class="cls_030">puts 2+2</span></div>
<div style="position:absolute;left:120.00px;top:448.10px" class="cls_038"><span class="cls_038">Listing 2-1: A one-line Ruby program we will compile as an example</span></div>
<div style="position:absolute;left:138.00px;top:470.60px" class="cls_007"><span class="cls_007">Figure 2-3 shows the AST structure that Ruby will create after tokeniz-</span></div>
<div style="position:absolute;left:120.00px;top:482.60px" class="cls_007"><span class="cls_007">ing and parsing this simple program. (This is a more detailed view of the</span></div>
<div style="position:absolute;left:120.00px;top:494.60px" class="cls_007"><span class="cls_007">AST than you would get from the Ripper tool that we saw in Experiment 1-2</span></div>
<div style="position:absolute;left:120.00px;top:506.60px" class="cls_007"><span class="cls_007">on page 23.)</span></div>
<div style="position:absolute;left:78.00px;top:533.10px" class="cls_032"><span class="cls_032">Note</span></div>
<div style="position:absolute;left:120.00px;top:530.60px" class="cls_008"><span class="cls_008">The technical names shown in Figure 2-3 (</span><span class="cls_030">NODE_SCOPE</span><span class="cls_008">, </span><span class="cls_030">NODE_FCALL</span><span class="cls_008">, and so on) are</span></div>
<div style="position:absolute;left:120.00px;top:542.60px" class="cls_008"><span class="cls_008">taken from the actual Ruby C source code. To keep things simple, I’m omitting some</span></div>
<div style="position:absolute;left:120.00px;top:554.60px" class="cls_008"><span class="cls_008">AST nodes—specifically, ones that represent arrays of the arguments to each method</span></div>
<div style="position:absolute;left:120.00px;top:566.60px" class="cls_008"><span class="cls_008">call, which in this simple example would be arrays of only one element.</span></div>
<div style="position:absolute;left:48.00px;top:633.00px" class="cls_020"><span class="cls_020">34</span></div>
<div style="position:absolute;left:70.07px;top:636.00px" class="cls_021"><span class="cls_021">Chapter 2</span></div>
</div>
<div style="position:absolute;left:50%;margin-left:-252px;top:37180px;width:504px;height:666px;border-style:outset;overflow:hidden">
<div style="position:absolute;left:0px;top:0px">
<img src="e698b76e-46bd-11eb-8b25-0cc47a792c0a_id_e698b76e-46bd-11eb-8b25-0cc47a792c0a_files/background059.jpg" width=504 height=666></div>
<div style="position:absolute;left:127.54px;top:48.95px" class="cls_063"><span class="cls_063">puts 2+2</span></div>
<div style="position:absolute;left:226.22px;top:63.95px" class="cls_040"><span class="cls_040">NODE_SCOPE</span></div>
<div style="position:absolute;left:215.59px;top:76.70px" class="cls_030"><span class="cls_030">table: [ none ]</span></div>
<div style="position:absolute;left:219.84px;top:86.98px" class="cls_030"><span class="cls_030">args: [ none ]</span></div>
<div style="position:absolute;left:226.22px;top:134.47px" class="cls_040"><span class="cls_040">NODE_FCALL</span></div>
<div style="position:absolute;left:226.22px;top:147.22px" class="cls_030"><span class="cls_030">method id:</span></div>
<div style="position:absolute;left:240.12px;top:157.50px" class="cls_038"><span class="cls_038">puts</span></div>
<div style="position:absolute;left:228.34px;top:206.19px" class="cls_040"><span class="cls_040">NODE_CALL</span></div>
<div style="position:absolute;left:226.22px;top:220.15px" class="cls_030"><span class="cls_030">method id:</span></div>
<div style="position:absolute;left:244.85px;top:230.44px" class="cls_038"><span class="cls_038">+</span></div>
<div style="position:absolute;left:170.40px;top:251.13px" class="cls_054"><span class="cls_054">receiver</span></div>
<div style="position:absolute;left:295.84px;top:251.13px" class="cls_054"><span class="cls_054">args</span></div>
<div style="position:absolute;left:166.71px;top:284.66px" class="cls_040"><span class="cls_040">NODE_LIT</span></div>
<div style="position:absolute;left:297.93px;top:284.66px" class="cls_040"><span class="cls_040">NODE_LIT</span></div>
<div style="position:absolute;left:181.09px;top:298.62px" class="cls_038"><span class="cls_038">2</span></div>
<div style="position:absolute;left:312.31px;top:298.62px" class="cls_038"><span class="cls_038">2</span></div>
<div style="position:absolute;left:123.00px;top:350.00px" class="cls_038"><span class="cls_038">Figure 2-3: The AST Ruby produces after parsing the code in Listing 2-1</span></div>
<div style="position:absolute;left:141.00px;top:372.50px" class="cls_007"><span class="cls_007">Before we cover the details of how Ruby compiles the </span><span class="cls_030">puts 2+2</span><span class="cls_007"> script,</span></div>
<div style="position:absolute;left:123.00px;top:384.50px" class="cls_007"><span class="cls_007">let’s look at one very important attribute of YARV: It’s a </span><span class="cls_008">stack-oriented virtual</span></div>
<div style="position:absolute;left:123.00px;top:396.50px" class="cls_008"><span class="cls_008">machine</span><span class="cls_007">. That means when YARV executes your code, it maintains a stack</span></div>
<div style="position:absolute;left:123.00px;top:408.50px" class="cls_007"><span class="cls_007">of values—mainly arguments and return values for the YARV instructions.</span></div>
<div style="position:absolute;left:123.00px;top:420.50px" class="cls_007"><span class="cls_007">(I’ll explain this in more detail in Chapter 3.) Most of YARV’s instructions</span></div>
<div style="position:absolute;left:123.00px;top:432.50px" class="cls_007"><span class="cls_007">either push values onto the stack or operate on the values that they find on</span></div>
<div style="position:absolute;left:123.00px;top:444.50px" class="cls_007"><span class="cls_007">the stack, leaving a result value on the stack as well.</span></div>
<div style="position:absolute;left:141.00px;top:456.50px" class="cls_007"><span class="cls_007">In order to compile the </span><span class="cls_030">puts 2+2</span><span class="cls_007"> AST structure into YARV instructions,</span></div>
<div style="position:absolute;left:123.00px;top:468.50px" class="cls_007"><span class="cls_007">Ruby will iterate over the tree recursively from the top down, converting</span></div>
<div style="position:absolute;left:123.00px;top:480.50px" class="cls_007"><span class="cls_007">each AST node into instructions. Figure 2-4 shows how this works, begin-</span></div>
<div style="position:absolute;left:123.00px;top:492.50px" class="cls_007"><span class="cls_007">ning with </span><span class="cls_030">NODE_SCOPE</span><span class="cls_007">.</span></div>
<div style="position:absolute;left:271.63px;top:519.40px" class="cls_067"><span class="cls_067">YARV instructions</span></div>
<div style="position:absolute;left:193.43px;top:523.16px" class="cls_068"><span class="cls_068">NODE_SCOPE</span></div>
<div style="position:absolute;left:182.80px;top:535.29px" class="cls_030"><span class="cls_030">table: [ none ]</span></div>
<div style="position:absolute;left:187.05px;top:544.80px" class="cls_030"><span class="cls_030">args: [ none ]</span></div>
<div style="position:absolute;left:123.00px;top:573.12px" class="cls_038"><span class="cls_038">Figure 2-4: Ruby starts the compile process at the root of the AST.</span></div>
<div style="position:absolute;left:141.00px;top:595.62px" class="cls_030"><span class="cls_030">NODE_SCOPE</span><span class="cls_007"> tells the Ruby compiler that it is starting to compile a new</span></div>
<div style="position:absolute;left:123.00px;top:607.62px" class="cls_008"><span class="cls_008">scope</span><span class="cls_007">, or section of Ruby code, which, in this case, is a whole new program.</span></div>
<div style="position:absolute;left:401.83px;top:636.00px" class="cls_021"><span class="cls_021">Compilation</span></div>
<div style="position:absolute;left:447.11px;top:633.00px" class="cls_020"><span class="cls_020">35</span></div>
</div>
<div style="position:absolute;left:50%;margin-left:-252px;top:37856px;width:504px;height:666px;border-style:outset;overflow:hidden">
<div style="position:absolute;left:0px;top:0px">
<img src="e698b76e-46bd-11eb-8b25-0cc47a792c0a_id_e698b76e-46bd-11eb-8b25-0cc47a792c0a_files/background060.jpg" width=504 height=666></div>
<div style="position:absolute;left:120.00px;top:42.28px" class="cls_007"><span class="cls_007">This scope is indicated on the right with an empty box. (The </span><span class="cls_030">table</span><span class="cls_007"> and </span><span class="cls_030">args</span></div>
<div style="position:absolute;left:120.00px;top:54.28px" class="cls_007"><span class="cls_007">values are both empty, so we’ll ignore them for now.)</span></div>
<div style="position:absolute;left:138.00px;top:66.28px" class="cls_007"><span class="cls_007">Next, the Ruby compiler steps down the AST tree and encounters</span></div>
<div style="position:absolute;left:120.00px;top:78.28px" class="cls_030"><span class="cls_030">NODE_FCALL</span><span class="cls_007">, as shown in Figure 2-5.</span></div>
<div style="position:absolute;left:268.63px;top:105.14px" class="cls_067"><span class="cls_067">YARV instructions</span></div>
<div style="position:absolute;left:190.43px;top:108.93px" class="cls_068"><span class="cls_068">NODE_SCOPE</span></div>
<div style="position:absolute;left:179.80px;top:121.09px" class="cls_030"><span class="cls_030">table: [ none ]</span></div>
<div style="position:absolute;left:269.02px;top:124.09px" class="cls_009"><span class="cls_009">putself</span></div>
<div style="position:absolute;left:184.05px;top:130.60px" class="cls_030"><span class="cls_030">args: [ none ]</span></div>
<div style="position:absolute;left:190.43px;top:170.73px" class="cls_068"><span class="cls_068">NODE_FCALL</span></div>
<div style="position:absolute;left:190.43px;top:183.65px" class="cls_030"><span class="cls_030">method id:</span></div>
<div style="position:absolute;left:204.33px;top:193.16px" class="cls_038"><span class="cls_038">puts</span></div>
<div style="position:absolute;left:120.00px;top:221.09px" class="cls_038"><span class="cls_038">Figure 2-5: To compile a function call, Ruby first creates an instruction to push the</span></div>
<div style="position:absolute;left:120.00px;top:231.59px" class="cls_038"><span class="cls_038">receiver.</span></div>
<div style="position:absolute;left:138.01px;top:254.08px" class="cls_030"><span class="cls_030">NODE_FCALL</span><span class="cls_007"> represents a </span><span class="cls_008">function call</span><span class="cls_007">—in this case, the call to </span><span class="cls_030">puts</span><span class="cls_007">.</span></div>
<div style="position:absolute;left:120.00px;top:266.08px" class="cls_007"><span class="cls_007">(Function and method calls are very important and very common in Ruby</span></div>
<div style="position:absolute;left:120.00px;top:278.08px" class="cls_007"><span class="cls_007">programs.) Ruby compiles function calls for YARV according to the follow-</span></div>
<div style="position:absolute;left:120.00px;top:290.08px" class="cls_007"><span class="cls_007">ing pattern:</span></div>
<div style="position:absolute;left:120.00px;top:311.08px" class="cls_050"><span class="cls_050">•</span><span class="cls_007">   Push receiver.</span></div>
<div style="position:absolute;left:120.00px;top:326.08px" class="cls_050"><span class="cls_050">•</span><span class="cls_007">   Push arguments.</span></div>
<div style="position:absolute;left:120.00px;top:341.08px" class="cls_050"><span class="cls_050">•</span><span class="cls_007">   Call the method/function.</span></div>
<div style="position:absolute;left:138.00px;top:362.08px" class="cls_007"><span class="cls_007">In Figure 2-5, the Ruby compiler first creates a YARV instruction called</span></div>
<div style="position:absolute;left:120.00px;top:374.08px" class="cls_030"><span class="cls_030">putself</span><span class="cls_007"> to indicate that the function call uses the current value of the </span><span class="cls_030">self</span></div>
<div style="position:absolute;left:120.00px;top:386.08px" class="cls_007"><span class="cls_007">pointer as the receiver. Because I call </span><span class="cls_030">puts</span><span class="cls_007"> from the top-level scope—that</span></div>
<div style="position:absolute;left:120.00px;top:398.08px" class="cls_007"><span class="cls_007">is, the top section—of this simple script, </span><span class="cls_030">self</span><span class="cls_007"> is set to point to the </span><span class="cls_030">top self</span></div>
<div style="position:absolute;left:120.00px;top:410.08px" class="cls_007"><span class="cls_007">object. (The </span><span class="cls_030">top self</span><span class="cls_007"> object is an instance of the </span><span class="cls_030">Object</span><span class="cls_007"> class that is auto-</span></div>
<div style="position:absolute;left:120.00px;top:422.08px" class="cls_007"><span class="cls_007">matically created when Ruby starts up. One purpose of </span><span class="cls_030">top self</span><span class="cls_007"> is to serve</span></div>
<div style="position:absolute;left:120.00px;top:434.08px" class="cls_007"><span class="cls_007">as the receiver for function calls like this one in the top-level scope.)</span></div>
<div style="position:absolute;left:78.00px;top:460.58px" class="cls_032"><span class="cls_032">note</span></div>
<div style="position:absolute;left:120.00px;top:458.08px" class="cls_008"><span class="cls_008">In Ruby all functions are actually methods. That is, functions are always associated</span></div>
<div style="position:absolute;left:120.00px;top:470.08px" class="cls_008"><span class="cls_008">with a Ruby class; there is always a receiver. Inside of Ruby, however, Ruby’s parser</span></div>
<div style="position:absolute;left:120.00px;top:482.08px" class="cls_008"><span class="cls_008">and compiler distinguish between functions and methods: Method calls have an</span></div>
<div style="position:absolute;left:120.00px;top:494.08px" class="cls_008"><span class="cls_008">explicit receiver, while function calls assume the receiver is the current value of </span><span class="cls_030">self</span><span class="cls_008">.</span></div>
<div style="position:absolute;left:138.00px;top:518.08px" class="cls_007"><span class="cls_007">Next, Ruby needs to create instructions to push the arguments of the</span></div>
<div style="position:absolute;left:120.00px;top:530.08px" class="cls_030"><span class="cls_030">puts</span><span class="cls_007"> function call. But how? The argument to </span><span class="cls_030">puts</span><span class="cls_007"> is </span><span class="cls_030">2+2</span><span class="cls_007">, which is the result</span></div>
<div style="position:absolute;left:120.00px;top:542.08px" class="cls_007"><span class="cls_007">of another method call. Although </span><span class="cls_030">2+2</span><span class="cls_007"> is a simple expression, </span><span class="cls_030">puts</span><span class="cls_007"> could</span></div>
<div style="position:absolute;left:120.00px;top:554.08px" class="cls_007"><span class="cls_007">instead be operating on some extremely complex Ruby expression involv-</span></div>
<div style="position:absolute;left:120.00px;top:566.08px" class="cls_007"><span class="cls_007">ing many operators, method calls, and so on. How can Ruby know which</span></div>
<div style="position:absolute;left:120.00px;top:578.08px" class="cls_007"><span class="cls_007">instructions to create here?</span></div>
<div style="position:absolute;left:48.00px;top:633.00px" class="cls_020"><span class="cls_020">36</span></div>
<div style="position:absolute;left:70.03px;top:636.00px" class="cls_021"><span class="cls_021">Chapter 2</span></div>
</div>
<div style="position:absolute;left:50%;margin-left:-252px;top:38532px;width:504px;height:666px;border-style:outset;overflow:hidden">
<div style="position:absolute;left:0px;top:0px">
<img src="e698b76e-46bd-11eb-8b25-0cc47a792c0a_id_e698b76e-46bd-11eb-8b25-0cc47a792c0a_files/background061.jpg" width=504 height=666></div>
<div style="position:absolute;left:141.00px;top:42.28px" class="cls_007"><span class="cls_007">The answer lies in the structure of the AST. By simply following the tree</span></div>
<div style="position:absolute;left:123.00px;top:54.28px" class="cls_007"><span class="cls_007">nodes down recursively, Ruby can take advantage of all the parser’s earlier</span></div>
<div style="position:absolute;left:123.00px;top:66.28px" class="cls_007"><span class="cls_007">work. In this case, it can now just step down to the </span><span class="cls_030">NODE_CALL</span><span class="cls_007"> node, as shown</span></div>
<div style="position:absolute;left:123.00px;top:78.28px" class="cls_007"><span class="cls_007">in Figure 2-6.</span></div>
<div style="position:absolute;left:271.63px;top:118.72px" class="cls_067"><span class="cls_067">YARV instructions</span></div>
<div style="position:absolute;left:193.43px;top:122.44px" class="cls_068"><span class="cls_068">NODE_FCALL</span></div>
<div style="position:absolute;left:193.43px;top:134.74px" class="cls_030"><span class="cls_030">method id:</span></div>
<div style="position:absolute;left:272.02px;top:137.65px" class="cls_009"><span class="cls_009">putself</span></div>
<div style="position:absolute;left:207.33px;top:144.24px" class="cls_038"><span class="cls_038">puts</span></div>
<div style="position:absolute;left:272.02px;top:146.22px" class="cls_009"><span class="cls_009">putobject</span></div>
<div style="position:absolute;left:335.73px;top:146.22px" class="cls_009"><span class="cls_009">2</span></div>
<div style="position:absolute;left:272.02px;top:154.79px" class="cls_009"><span class="cls_009">putobject</span></div>
<div style="position:absolute;left:335.73px;top:154.79px" class="cls_009"><span class="cls_009">2</span></div>
<div style="position:absolute;left:272.02px;top:163.37px" class="cls_009"><span class="cls_009">send</span></div>
<div style="position:absolute;left:335.73px;top:163.37px" class="cls_009"><span class="cls_009">&lt;callinfo!mid:+, argc:1, ...</span></div>
<div style="position:absolute;left:195.55px;top:188.79px" class="cls_068"><span class="cls_068">NODE_CALL</span></div>
<div style="position:absolute;left:193.43px;top:201.71px" class="cls_030"><span class="cls_030">method id:</span></div>
<div style="position:absolute;left:212.06px;top:211.91px" class="cls_038"><span class="cls_038">+</span></div>
<div style="position:absolute;left:123.00px;top:238.21px" class="cls_038"><span class="cls_038">Figure 2-6: Next, Ruby writes instructions for calculating </span><span class="cls_014">2+2</span><span class="cls_038">, the argument to </span><span class="cls_014">puts</span><span class="cls_038">.</span></div>
<div style="position:absolute;left:141.00px;top:258.71px" class="cls_007"><span class="cls_007">Here Ruby will compile the </span><span class="cls_030">+</span><span class="cls_007"> method call, which theoretically is the</span></div>
<div style="position:absolute;left:123.00px;top:270.71px" class="cls_007"><span class="cls_007">process of sending the </span><span class="cls_030">+</span><span class="cls_007"> message to the </span><span class="cls_030">2</span><span class="cls_007"> integer object. Again, following</span></div>
<div style="position:absolute;left:123.00px;top:282.71px" class="cls_007"><span class="cls_007">the same receiver, arguments, method call pattern, Ruby performs these</span></div>
<div style="position:absolute;left:123.00px;top:294.71px" class="cls_007"><span class="cls_007">actions in order:</span></div>
<div style="position:absolute;left:123.00px;top:311.71px" class="cls_007"><span class="cls_007">1.   Creates a YARV instruction to push the receiver onto the stack (the</span></div>
<div style="position:absolute;left:141.00px;top:323.71px" class="cls_007"><span class="cls_007">object </span><span class="cls_030">2</span><span class="cls_007"> in this case).</span></div>
<div style="position:absolute;left:123.00px;top:338.71px" class="cls_007"><span class="cls_007">2.  Creates a YARV instruction to push the argument or arguments onto</span></div>
<div style="position:absolute;left:141.00px;top:350.71px" class="cls_007"><span class="cls_007">the stack (again, </span><span class="cls_030">2</span><span class="cls_007"> in this example).</span></div>
<div style="position:absolute;left:123.00px;top:365.71px" class="cls_007"><span class="cls_007">3.  Creates a method call YARV instruction </span><span class="cls_030">send &lt;callinfo!mid:+, argc:1,</span></div>
<div style="position:absolute;left:141.00px;top:377.71px" class="cls_030"><span class="cls_030">ARGS_SKIP></span><span class="cls_007"> that means “send the + message” to the receiver, which is the</span></div>
<div style="position:absolute;left:141.00px;top:389.71px" class="cls_007"><span class="cls_007">object previously pushed onto the YARV stack (in this case, the first</span></div>
<div style="position:absolute;left:141.00px;top:401.71px" class="cls_030"><span class="cls_030">Fixnum 2</span><span class="cls_007"> object). </span><span class="cls_030">mid:+ </span><span class="cls_007">means “method id = +” and is the name of the</span></div>
<div style="position:absolute;left:141.00px;top:413.71px" class="cls_007"><span class="cls_007">method we want to call. The </span><span class="cls_030">argc:1</span><span class="cls_007"> parameter tells YARV there is one</span></div>
<div style="position:absolute;left:141.00px;top:425.71px" class="cls_007"><span class="cls_007">argument to this method call (the second </span><span class="cls_030">Fixnum 2</span><span class="cls_007"> object). </span><span class="cls_030">ARGS_SKIP</span></div>
<div style="position:absolute;left:141.00px;top:437.71px" class="cls_007"><span class="cls_007">indicates the arguments are simple values (not blocks or arrays of</span></div>
<div style="position:absolute;left:141.00px;top:449.71px" class="cls_007"><span class="cls_007">unnamed arguments), allowing YARV to skip some work it would have</span></div>
<div style="position:absolute;left:141.00px;top:461.71px" class="cls_007"><span class="cls_007">to do otherwise.</span></div>
<div style="position:absolute;left:141.00px;top:478.71px" class="cls_007"><span class="cls_007">When Ruby executes the </span><span class="cls_030">send &lt;callinfo!mid:+...</span><span class="cls_007"> instruction it adds </span><span class="cls_030">2+2</span><span class="cls_007">,</span></div>
<div style="position:absolute;left:123.00px;top:490.71px" class="cls_007"><span class="cls_007">fetching those arguments from the stack, and leaves the result, </span><span class="cls_030">4</span><span class="cls_007">, as a new</span></div>
<div style="position:absolute;left:123.00px;top:502.71px" class="cls_007"><span class="cls_007">value on top of the stack. What’s fascinating about this is that YARV’s stack-</span></div>
<div style="position:absolute;left:123.00px;top:514.71px" class="cls_007"><span class="cls_007">oriented nature also helps Ruby compile the AST nodes more easily, as you</span></div>
<div style="position:absolute;left:123.00px;top:526.71px" class="cls_007"><span class="cls_007">can see when it finishes compiling the </span><span class="cls_030">NODE_FCALL</span><span class="cls_007">, as shown in Figure 2-7.</span></div>
<div style="position:absolute;left:141.00px;top:538.71px" class="cls_007"><span class="cls_007">Now Ruby can assume that the return value of the </span><span class="cls_030">2+2</span><span class="cls_007"> operation—</span></div>
<div style="position:absolute;left:123.00px;top:550.71px" class="cls_007"><span class="cls_007">that is, </span><span class="cls_030">4</span><span class="cls_007">—will be left at the top of the stack, just where it needs to be as the</span></div>
<div style="position:absolute;left:123.00px;top:562.71px" class="cls_007"><span class="cls_007">argument to the </span><span class="cls_030">puts</span><span class="cls_007"> function call. Ruby’s stack-oriented virtual machine</span></div>
<div style="position:absolute;left:123.00px;top:574.71px" class="cls_007"><span class="cls_007">goes hand in hand with the way that it recursively compiles the AST</span></div>
<div style="position:absolute;left:123.00px;top:586.71px" class="cls_007"><span class="cls_007">nodes! As you can see at the right of Figure 2-7, Ruby has added the </span><span class="cls_030">send</span></div>
<div style="position:absolute;left:123.00px;top:598.71px" class="cls_030"><span class="cls_030">&lt;callinfo!mid:puts, argc:1</span><span class="cls_007"> instruction, which calls </span><span class="cls_030">puts</span><span class="cls_007"> and indicates that</span></div>
<div style="position:absolute;left:123.00px;top:610.71px" class="cls_007"><span class="cls_007">there is one argument to </span><span class="cls_030">puts</span><span class="cls_007">.</span></div>
<div style="position:absolute;left:401.90px;top:636.00px" class="cls_021"><span class="cls_021">Compilation</span></div>
<div style="position:absolute;left:447.18px;top:633.00px" class="cls_020"><span class="cls_020">37</span></div>
</div>
<div style="position:absolute;left:50%;margin-left:-252px;top:39208px;width:504px;height:666px;border-style:outset;overflow:hidden">
<div style="position:absolute;left:0px;top:0px">
<img src="e698b76e-46bd-11eb-8b25-0cc47a792c0a_id_e698b76e-46bd-11eb-8b25-0cc47a792c0a_files/background062.jpg" width=504 height=666></div>
<div style="position:absolute;left:268.63px;top:49.44px" class="cls_067"><span class="cls_067">YARV instructions</span></div>
<div style="position:absolute;left:190.43px;top:53.24px" class="cls_068"><span class="cls_068">NODE_SCOPE</span></div>
<div style="position:absolute;left:179.80px;top:65.41px" class="cls_030"><span class="cls_030">table: [ none ]</span></div>
<div style="position:absolute;left:269.02px;top:68.36px" class="cls_009"><span class="cls_009">putself</span></div>
<div style="position:absolute;left:184.05px;top:74.92px" class="cls_030"><span class="cls_030">args: [ none ]</span></div>
<div style="position:absolute;left:269.02px;top:76.92px" class="cls_009"><span class="cls_009">putobject</span></div>
<div style="position:absolute;left:332.73px;top:77.12px" class="cls_009"><span class="cls_009">2</span></div>
<div style="position:absolute;left:269.02px;top:85.49px" class="cls_009"><span class="cls_009">putobject</span></div>
<div style="position:absolute;left:332.73px;top:85.69px" class="cls_009"><span class="cls_009">2</span></div>
<div style="position:absolute;left:269.02px;top:94.05px" class="cls_009"><span class="cls_009">send</span></div>
<div style="position:absolute;left:332.73px;top:94.25px" class="cls_009"><span class="cls_009">&lt;callinfo!mid:+, argc:1, ...</span></div>
<div style="position:absolute;left:269.02px;top:102.62px" class="cls_009"><span class="cls_009">send</span></div>
<div style="position:absolute;left:332.73px;top:102.82px" class="cls_009"><span class="cls_009">&lt;callinfo!mid:puts, argc:1, ...</span></div>
<div style="position:absolute;left:190.43px;top:115.63px" class="cls_068"><span class="cls_068">NODE_FCALL</span></div>
<div style="position:absolute;left:190.43px;top:127.18px" class="cls_030"><span class="cls_030">method id:</span></div>
<div style="position:absolute;left:204.33px;top:136.69px" class="cls_038"><span class="cls_038">puts</span></div>
<div style="position:absolute;left:120.00px;top:165.38px" class="cls_038"><span class="cls_038">Figure 2-7: Finally, Ruby can write an instruction for the call to </span><span class="cls_014">puts</span><span class="cls_038">.</span></div>
<div style="position:absolute;left:138.00px;top:187.88px" class="cls_007"><span class="cls_007">As it turns out, Ruby further modifies these YARV instructions before</span></div>
<div style="position:absolute;left:120.00px;top:199.88px" class="cls_007"><span class="cls_007">executing them as part of an optimize step. One of its optimizations is to</span></div>
<div style="position:absolute;left:120.00px;top:211.88px" class="cls_007"><span class="cls_007">replace some YARV instructions with </span><span class="cls_008">specialized instructions</span><span class="cls_007">, which are YARV</span></div>
<div style="position:absolute;left:120.00px;top:223.88px" class="cls_007"><span class="cls_007">instructions that represent commonly used, primitive operations, such as</span></div>
<div style="position:absolute;left:120.00px;top:235.88px" class="cls_030"><span class="cls_030">size</span><span class="cls_007">, </span><span class="cls_030">not</span><span class="cls_007">, </span><span class="cls_030">less than</span><span class="cls_007">, </span><span class="cls_030">greater than</span><span class="cls_007">, and so on. One such instruction, </span><span class="cls_030">opt_plus</span><span class="cls_007">, is</span></div>
<div style="position:absolute;left:120.00px;top:247.88px" class="cls_007"><span class="cls_007">used for adding two numbers together. During optimization, Ruby replaces</span></div>
<div style="position:absolute;left:120.00px;top:259.88px" class="cls_030"><span class="cls_030">send &lt;callinfo!mid:+...</span><span class="cls_007"> with </span><span class="cls_030">opt_plus</span><span class="cls_007">, as shown in Figure 2-8.</span></div>
<div style="position:absolute;left:268.63px;top:286.72px" class="cls_067"><span class="cls_067">YARV instructions</span></div>
<div style="position:absolute;left:190.43px;top:290.75px" class="cls_040"><span class="cls_040">NODE_SCOPE</span></div>
<div style="position:absolute;left:179.80px;top:302.46px" class="cls_030"><span class="cls_030">table: [ none ]</span></div>
<div style="position:absolute;left:269.02px;top:305.64px" class="cls_009"><span class="cls_009">putself</span></div>
<div style="position:absolute;left:184.05px;top:311.97px" class="cls_030"><span class="cls_030">args: [ none ]</span></div>
<div style="position:absolute;left:269.02px;top:314.27px" class="cls_009"><span class="cls_009">putobject</span></div>
<div style="position:absolute;left:332.73px;top:314.48px" class="cls_009"><span class="cls_009">2</span></div>
<div style="position:absolute;left:269.02px;top:322.90px" class="cls_009"><span class="cls_009">putobject</span></div>
<div style="position:absolute;left:332.73px;top:323.05px" class="cls_009"><span class="cls_009">2</span></div>
<div style="position:absolute;left:269.02px;top:331.54px" class="cls_069"><span class="cls_069">opt_plus</span></div>
<div style="position:absolute;left:269.02px;top:340.17px" class="cls_069"><span class="cls_069">opt_send_simple</span></div>
<div style="position:absolute;left:332.73px;top:340.17px" class="cls_009"><span class="cls_009">&lt;callinfo!mid:puts,</span></div>
<div style="position:absolute;left:332.73px;top:348.74px" class="cls_009"><span class="cls_009">argc:1...</span></div>
<div style="position:absolute;left:190.43px;top:352.39px" class="cls_040"><span class="cls_040">NODE_FCALL</span></div>
<div style="position:absolute;left:190.43px;top:364.98px" class="cls_030"><span class="cls_030">method id:</span></div>
<div style="position:absolute;left:204.33px;top:374.48px" class="cls_038"><span class="cls_038">puts</span></div>
<div style="position:absolute;left:120.00px;top:402.59px" class="cls_038"><span class="cls_038">Figure 2-8: Ruby replaces some instructions with specialized instructions.</span></div>
<div style="position:absolute;left:138.00px;top:425.08px" class="cls_007"><span class="cls_007">As you can see in Figure 2-8, Ruby also replaces the second </span><span class="cls_030">send</span><span class="cls_007"> with</span></div>
<div style="position:absolute;left:120.00px;top:437.08px" class="cls_030"><span class="cls_030">opt_send_simple</span><span class="cls_007">, which runs a bit faster when none of the arguments needs</span></div>
<div style="position:absolute;left:120.00px;top:449.08px" class="cls_007"><span class="cls_007">special treatment, such as expansion.</span></div>
<div style="position:absolute;left:66.00px;top:483.08px" class="cls_031"><span class="cls_031">Compiling a Call to a Block</span></div>
<div style="position:absolute;left:120.00px;top:503.08px" class="cls_007"><span class="cls_007">Next, let’s compile my </span><span class="cls_030">10.times do</span><span class="cls_007"> example from Listing 1-1 in Chapter 1</span></div>
<div style="position:absolute;left:120.00px;top:515.08px" class="cls_007"><span class="cls_007">(see Listing 2-2).</span></div>
<div style="position:absolute;left:120.00px;top:539.08px" class="cls_030"><span class="cls_030">10.times do |n|</span></div>
<div style="position:absolute;left:128.50px;top:549.58px" class="cls_030"><span class="cls_030">puts n</span></div>
<div style="position:absolute;left:120.00px;top:560.07px" class="cls_030"><span class="cls_030">end</span></div>
<div style="position:absolute;left:120.00px;top:582.57px" class="cls_038"><span class="cls_038">Listing 2-2: A simple script that calls a block</span></div>
<div style="position:absolute;left:48.00px;top:633.00px" class="cls_020"><span class="cls_020">38</span></div>
<div style="position:absolute;left:70.07px;top:636.00px" class="cls_021"><span class="cls_021">Chapter 2</span></div>
</div>
<div style="position:absolute;left:50%;margin-left:-252px;top:39884px;width:504px;height:666px;border-style:outset;overflow:hidden">
<div style="position:absolute;left:0px;top:0px">
<img src="e698b76e-46bd-11eb-8b25-0cc47a792c0a_id_e698b76e-46bd-11eb-8b25-0cc47a792c0a_files/background063.jpg" width=504 height=666></div>
<div style="position:absolute;left:141.00px;top:42.28px" class="cls_007"><span class="cls_007">Notice that this example contains a block parameter to the </span><span class="cls_030">times</span></div>
<div style="position:absolute;left:123.00px;top:54.28px" class="cls_007"><span class="cls_007">method. This is interesting because it will give us a chance to see how the</span></div>
<div style="position:absolute;left:123.00px;top:66.28px" class="cls_007"><span class="cls_007">Ruby compiler handles blocks. Figure 2-9 shows the AST for the </span><span class="cls_030">10.times do</span></div>
<div style="position:absolute;left:123.00px;top:78.28px" class="cls_007"><span class="cls_007">example again, using the actual node names rather than the simplified out-</span></div>
<div style="position:absolute;left:123.00px;top:90.28px" class="cls_007"><span class="cls_007">put from Ripper.</span></div>
<div style="position:absolute;left:127.54px;top:116.63px" class="cls_063"><span class="cls_063">10.times do |n|</span></div>
<div style="position:absolute;left:137.04px;top:128.14px" class="cls_063"><span class="cls_063">puts n</span></div>
<div style="position:absolute;left:226.62px;top:131.63px" class="cls_040"><span class="cls_040">NODE_SCOPE</span></div>
<div style="position:absolute;left:127.54px;top:139.64px" class="cls_063"><span class="cls_063">end</span></div>
<div style="position:absolute;left:215.99px;top:143.89px" class="cls_030"><span class="cls_030">table: [ none ]</span></div>
<div style="position:absolute;left:220.24px;top:154.17px" class="cls_030"><span class="cls_030">args: [ none ]</span></div>
<div style="position:absolute;left:337.08px;top:181.69px" class="cls_063"><span class="cls_063">... do |n|</span></div>
<div style="position:absolute;left:346.58px;top:193.20px" class="cls_063"><span class="cls_063">puts n</span></div>
<div style="position:absolute;left:228.74px;top:202.15px" class="cls_040"><span class="cls_040">NODE_ITER</span></div>
<div style="position:absolute;left:337.08px;top:204.70px" class="cls_063"><span class="cls_063">end</span></div>
<div style="position:absolute;left:372.61px;top:230.29px" class="cls_040"><span class="cls_040">NODE_SCOPE</span></div>
<div style="position:absolute;left:372.61px;top:242.88px" class="cls_030"><span class="cls_030">table: </span><span class="cls_038">n</span></div>
<div style="position:absolute;left:376.86px;top:252.38px" class="cls_030"><span class="cls_030">args: </span><span class="cls_038">1</span></div>
<div style="position:absolute;left:228.74px;top:272.66px" class="cls_040"><span class="cls_040">NODE_CALL</span></div>
<div style="position:absolute;left:226.62px;top:284.85px" class="cls_030"><span class="cls_030">method id:</span></div>
<div style="position:absolute;left:238.57px;top:295.14px" class="cls_038"><span class="cls_038">times</span></div>
<div style="position:absolute;left:388.69px;top:296.08px" class="cls_054"><span class="cls_054">etc.</span></div>
<div style="position:absolute;left:256.44px;top:319.11px" class="cls_054"><span class="cls_054">receiver</span></div>
<div style="position:absolute;left:230.87px;top:346.28px" class="cls_040"><span class="cls_040">NODE_LIT</span></div>
<div style="position:absolute;left:242.51px;top:361.45px" class="cls_038"><span class="cls_038">10</span></div>
<div style="position:absolute;left:123.00px;top:408.68px" class="cls_038"><span class="cls_038">Figure 2-9: The AST for the call to </span><span class="cls_014">10.times</span><span class="cls_038">, passing a block</span></div>
<div style="position:absolute;left:141.00px;top:431.18px" class="cls_007"><span class="cls_007">This looks very different than </span><span class="cls_030">puts 2+2</span><span class="cls_007">, mostly because of the inner</span></div>
<div style="position:absolute;left:123.00px;top:443.18px" class="cls_007"><span class="cls_007">block shown at the right. (Ruby handles the inner block differently, as</span></div>
<div style="position:absolute;left:123.00px;top:455.18px" class="cls_007"><span class="cls_007">we’ll see shortly.)</span></div>
<div style="position:absolute;left:141.00px;top:467.18px" class="cls_007"><span class="cls_007">Let’s break down how Ruby compiles the main portion of the script</span></div>
<div style="position:absolute;left:123.00px;top:479.18px" class="cls_007"><span class="cls_007">shown on the left of Figure 2-9. As before, Ruby starts with the first</span></div>
<div style="position:absolute;left:123.00px;top:491.18px" class="cls_030"><span class="cls_030">NODE_SCOPE</span><span class="cls_007"> and creates a new snippet of YARV instructions, as shown in</span></div>
<div style="position:absolute;left:123.00px;top:503.18px" class="cls_007"><span class="cls_007">Figure 2-10.</span></div>
<div style="position:absolute;left:271.63px;top:529.46px" class="cls_067"><span class="cls_067">YARV instructions</span></div>
<div style="position:absolute;left:193.43px;top:534.19px" class="cls_068"><span class="cls_068">NODE_SCOPE</span></div>
<div style="position:absolute;left:182.80px;top:545.62px" class="cls_030"><span class="cls_030">table: [ none ]</span></div>
<div style="position:absolute;left:187.05px;top:555.13px" class="cls_030"><span class="cls_030">args: [ none ]</span></div>
<div style="position:absolute;left:123.00px;top:583.80px" class="cls_038"><span class="cls_038">Figure 2-10: Each </span><span class="cls_014">NODE_SCOPE</span><span class="cls_038"> is compiled into a new snippet of YARV instructions.</span></div>
<div style="position:absolute;left:401.77px;top:636.00px" class="cls_021"><span class="cls_021">Compilation</span></div>
<div style="position:absolute;left:447.05px;top:633.00px" class="cls_020"><span class="cls_020">39</span></div>
</div>
<div style="position:absolute;left:50%;margin-left:-252px;top:40560px;width:504px;height:666px;border-style:outset;overflow:hidden">
<div style="position:absolute;left:0px;top:0px">
<img src="e698b76e-46bd-11eb-8b25-0cc47a792c0a_id_e698b76e-46bd-11eb-8b25-0cc47a792c0a_files/background064.jpg" width=504 height=666></div>
<div style="position:absolute;left:138.00px;top:41.60px" class="cls_007"><span class="cls_007">Next, Ruby steps down the AST nodes to </span><span class="cls_030">NODE_ITER</span><span class="cls_007">, as shown in</span></div>
<div style="position:absolute;left:120.00px;top:53.60px" class="cls_007"><span class="cls_007">Figure 2-11.</span></div>
<div style="position:absolute;left:268.63px;top:78.45px" class="cls_067"><span class="cls_067">YARV instructions</span></div>
<div style="position:absolute;left:190.43px;top:84.48px" class="cls_040"><span class="cls_040">NODE_SCOPE</span></div>
<div style="position:absolute;left:179.80px;top:96.29px" class="cls_030"><span class="cls_030">table: [ none ]</span></div>
<div style="position:absolute;left:184.05px;top:105.80px" class="cls_030"><span class="cls_030">args: [ none ]</span></div>
<div style="position:absolute;left:192.55px;top:144.25px" class="cls_040"><span class="cls_040">NODE_ITER</span></div>
<div style="position:absolute;left:120.00px;top:194.05px" class="cls_038"><span class="cls_038">Figure 2-11: Ruby stepping through an AST</span></div>
<div style="position:absolute;left:138.00px;top:216.55px" class="cls_007"><span class="cls_007">At this point, there is still no code generated, but notice in Figure 2-9</span></div>
<div style="position:absolute;left:120.00px;top:228.55px" class="cls_007"><span class="cls_007">that two arrows lead from </span><span class="cls_030">NODE_ITER</span><span class="cls_007">: one to </span><span class="cls_030">NODE_CALL</span><span class="cls_007">, which represents the</span></div>
<div style="position:absolute;left:120.00px;top:240.55px" class="cls_030"><span class="cls_030">10.times</span><span class="cls_007"> call, and another to the inner block. Ruby will first continue down</span></div>
<div style="position:absolute;left:120.00px;top:252.55px" class="cls_007"><span class="cls_007">the AST and compile the nodes corresponding to the </span><span class="cls_030">10.times</span><span class="cls_007"> code. The</span></div>
<div style="position:absolute;left:120.00px;top:264.55px" class="cls_007"><span class="cls_007">resulting YARV code, following the same receiver-arguments-message pat-</span></div>
<div style="position:absolute;left:120.00px;top:276.55px" class="cls_007"><span class="cls_007">tern we saw in Figure 2-6, is shown in Figure 2-12.</span></div>
<div style="position:absolute;left:268.63px;top:302.34px" class="cls_067"><span class="cls_067">YARV instructions</span></div>
<div style="position:absolute;left:192.55px;top:307.37px" class="cls_040"><span class="cls_040">NODE_ITER</span></div>
<div style="position:absolute;left:269.02px;top:320.85px" class="cls_009"><span class="cls_009">putobject</span></div>
<div style="position:absolute;left:332.73px;top:320.85px" class="cls_009"><span class="cls_009">10</span></div>
<div style="position:absolute;left:269.02px;top:329.09px" class="cls_009"><span class="cls_009">send</span></div>
<div style="position:absolute;left:332.73px;top:329.09px" class="cls_009"><span class="cls_009">&lt;callinfo!mid:times, argc:0,</span></div>
<div style="position:absolute;left:332.73px;top:337.33px" class="cls_009"><span class="cls_009">block:block in &lt;compiled>></span></div>
<div style="position:absolute;left:192.55px;top:367.22px" class="cls_040"><span class="cls_040">NODE_CALL</span></div>
<div style="position:absolute;left:190.43px;top:378.88px" class="cls_030"><span class="cls_030">method id:</span></div>
<div style="position:absolute;left:202.38px;top:388.38px" class="cls_038"><span class="cls_038">times</span></div>
<div style="position:absolute;left:120.00px;top:416.94px" class="cls_038"><span class="cls_038">Figure 2-12: Ruby compiles the </span><span class="cls_014">10.times</span><span class="cls_038"> method call.</span></div>
<div style="position:absolute;left:138.00px;top:439.44px" class="cls_007"><span class="cls_007">Notice that the new YARV instructions shown in Figure 2-12 push the</span></div>
<div style="position:absolute;left:120.00px;top:451.44px" class="cls_007"><span class="cls_007">receiver (the integer object </span><span class="cls_030">10</span><span class="cls_007">) onto the stack first, after which Ruby gener-</span></div>
<div style="position:absolute;left:120.01px;top:463.44px" class="cls_007"><span class="cls_007">ates an instruction to execute the </span><span class="cls_030">times</span><span class="cls_007"> method call. But notice, too, the</span></div>
<div style="position:absolute;left:120.00px;top:475.44px" class="cls_030"><span class="cls_030">block:block in &lt;compiled></span><span class="cls_007"> argument in the </span><span class="cls_030">send</span><span class="cls_007"> instruction. This indicates</span></div>
<div style="position:absolute;left:120.00px;top:487.44px" class="cls_007"><span class="cls_007">that the method call also contains a block argument: my </span><span class="cls_030">do |n| puts n end</span></div>
<div style="position:absolute;left:120.00px;top:499.44px" class="cls_007"><span class="cls_007">block. In this example, </span><span class="cls_030">NODE_ITER</span><span class="cls_007"> has caused the Ruby compiler to include</span></div>
<div style="position:absolute;left:120.00px;top:511.44px" class="cls_007"><span class="cls_007">this block argument because the AST above shows an arrow from </span><span class="cls_030">NODE_ITER</span></div>
<div style="position:absolute;left:120.00px;top:523.44px" class="cls_007"><span class="cls_007">to the second </span><span class="cls_030">NODE_SCOPE</span><span class="cls_007">.</span></div>
<div style="position:absolute;left:48.00px;top:633.00px" class="cls_020"><span class="cls_020">40</span></div>
<div style="position:absolute;left:70.03px;top:636.00px" class="cls_021"><span class="cls_021">Chapter 2</span></div>
</div>
<div style="position:absolute;left:50%;margin-left:-252px;top:41236px;width:504px;height:666px;border-style:outset;overflow:hidden">
<div style="position:absolute;left:0px;top:0px">
<img src="e698b76e-46bd-11eb-8b25-0cc47a792c0a_id_e698b76e-46bd-11eb-8b25-0cc47a792c0a_files/background065.jpg" width=504 height=666></div>
<div style="position:absolute;left:141.00px;top:42.28px" class="cls_007"><span class="cls_007">Ruby continues by compiling the inner block, beginning with the sec-</span></div>
<div style="position:absolute;left:123.00px;top:54.28px" class="cls_007"><span class="cls_007">ond </span><span class="cls_030">NODE_SCOPE</span><span class="cls_007"> shown at right in Figure 2-9. Figure 2-13 shows what the AST</span></div>
<div style="position:absolute;left:123.00px;top:66.28px" class="cls_007"><span class="cls_007">for that inner block looks like.</span></div>
<div style="position:absolute;left:141.00px;top:78.28px" class="cls_007"><span class="cls_007">This looks simple enough—just a single function call and a single</span></div>
<div style="position:absolute;left:123.00px;top:90.28px" class="cls_007"><span class="cls_007">argument </span><span class="cls_030">n</span><span class="cls_007">. But notice the value for </span><span class="cls_030">table</span><span class="cls_007"> and </span><span class="cls_030">args</span><span class="cls_007"> in </span><span class="cls_030">NODE_SCOPE</span><span class="cls_007">. These</span></div>
<div style="position:absolute;left:123.00px;top:102.28px" class="cls_007"><span class="cls_007">values were empty in the parent </span><span class="cls_030">NODE_SCOPE</span><span class="cls_007">, but they’re set here in the inner</span></div>
<div style="position:absolute;left:123.00px;top:114.28px" class="cls_030"><span class="cls_030">NODE_SCOPE</span><span class="cls_007">. As you might guess, these values indicate the presence of the</span></div>
<div style="position:absolute;left:123.00px;top:126.28px" class="cls_007"><span class="cls_007">block parameter </span><span class="cls_030">n</span><span class="cls_007">.</span></div>
<div style="position:absolute;left:127.50px;top:150.80px" class="cls_063"><span class="cls_063">10.times do |n|</span></div>
<div style="position:absolute;left:137.00px;top:162.30px" class="cls_063"><span class="cls_063">puts n</span></div>
<div style="position:absolute;left:127.50px;top:173.81px" class="cls_063"><span class="cls_063">end</span></div>
<div style="position:absolute;left:165.16px;top:197.78px" class="cls_040"><span class="cls_040">NODE_ITER</span></div>
<div style="position:absolute;left:252.96px;top:246.03px" class="cls_063"><span class="cls_063">... do |n|</span></div>
<div style="position:absolute;left:262.46px;top:257.54px" class="cls_063"><span class="cls_063">puts n</span></div>
<div style="position:absolute;left:351.64px;top:257.20px" class="cls_040"><span class="cls_040">NODE_SCOPE</span></div>
<div style="position:absolute;left:179.11px;top:265.19px" class="cls_054"><span class="cls_054">etc.</span></div>
<div style="position:absolute;left:252.96px;top:269.04px" class="cls_063"><span class="cls_063">end</span></div>
<div style="position:absolute;left:351.64px;top:269.78px" class="cls_030"><span class="cls_030">table: </span><span class="cls_038">n</span></div>
<div style="position:absolute;left:355.89px;top:279.29px" class="cls_030"><span class="cls_030">args: </span><span class="cls_038">1</span></div>
<div style="position:absolute;left:351.64px;top:328.10px" class="cls_040"><span class="cls_040">NODE_FCALL</span></div>
<div style="position:absolute;left:351.64px;top:340.29px" class="cls_030"><span class="cls_030">method id:</span></div>
<div style="position:absolute;left:365.55px;top:350.58px" class="cls_038"><span class="cls_038">puts</span></div>
<div style="position:absolute;left:353.77px;top:399.68px" class="cls_040"><span class="cls_040">NODE_DVAR</span></div>
<div style="position:absolute;left:347.39px;top:410.90px" class="cls_030"><span class="cls_030">variable id:</span></div>
<div style="position:absolute;left:370.65px;top:421.10px" class="cls_038"><span class="cls_038">n</span></div>
<div style="position:absolute;left:123.00px;top:462.08px" class="cls_038"><span class="cls_038">Figure 2-13: The branch of the AST for the contents of the block</span></div>
<div style="position:absolute;left:141.00px;top:484.58px" class="cls_007"><span class="cls_007">Also notice that the Ruby parser created </span><span class="cls_030">NODE_DVAR</span><span class="cls_007"> instead of </span><span class="cls_030">NODE_LIT</span><span class="cls_007">,</span></div>
<div style="position:absolute;left:123.00px;top:496.58px" class="cls_007"><span class="cls_007">which we saw earlier in Figure 2-9. This is the case because </span><span class="cls_030">n</span><span class="cls_007"> is not just a</span></div>
<div style="position:absolute;left:123.00px;top:508.58px" class="cls_007"><span class="cls_007">literal string; it’s a block parameter passed in from the parent scope.</span></div>
<div style="position:absolute;left:141.00px;top:520.58px" class="cls_007"><span class="cls_007">From a relatively high level, Figure 2-14 shows how Ruby compiles the</span></div>
<div style="position:absolute;left:123.00px;top:532.58px" class="cls_007"><span class="cls_007">inner block.</span></div>
<div style="position:absolute;left:402.23px;top:636.00px" class="cls_021"><span class="cls_021">Compilation</span></div>
<div style="position:absolute;left:447.51px;top:633.00px" class="cls_020"><span class="cls_020">41</span></div>
</div>
<div style="position:absolute;left:50%;margin-left:-252px;top:41912px;width:504px;height:666px;border-style:outset;overflow:hidden">
<div style="position:absolute;left:0px;top:0px">
<img src="e698b76e-46bd-11eb-8b25-0cc47a792c0a_id_e698b76e-46bd-11eb-8b25-0cc47a792c0a_files/background066.jpg" width=504 height=666></div>
<div style="position:absolute;left:178.31px;top:61.31px" class="cls_020"><span class="cls_020">How Ruby Iterates Through the AST</span></div>
<div style="position:absolute;left:120.50px;top:79.81px" class="cls_039"><span class="cls_039">Let’s look more closely at how Ruby actually iterates through the AST structure, con-</span></div>
<div style="position:absolute;left:120.50px;top:91.82px" class="cls_039"><span class="cls_039">verting each node into YARV instructions. The MRI C source code file that imple-</span></div>
<div style="position:absolute;left:120.50px;top:103.81px" class="cls_039"><span class="cls_039">ments the Ruby compiler is called </span><span class="cls_044">compile.c</span><span class="cls_039">. To learn how the code in </span><span class="cls_044">compile.c</span><span class="cls_039"> works,</span></div>
<div style="position:absolute;left:120.50px;top:115.81px" class="cls_039"><span class="cls_039">we first look for the function </span><span class="cls_009">iseq_compile_each</span><span class="cls_039">. Listing 2-3 shows the beginning of</span></div>
<div style="position:absolute;left:120.50px;top:127.82px" class="cls_039"><span class="cls_039">that function.</span></div>
<div style="position:absolute;left:120.50px;top:150.31px" class="cls_009"><span class="cls_009">/**</span></div>
<div style="position:absolute;left:128.00px;top:159.82px" class="cls_009"><span class="cls_009">compile each node</span></div>
<div style="position:absolute;left:128.00px;top:178.81px" class="cls_009"><span class="cls_009">self:  InstructionSequence</span></div>
<div style="position:absolute;left:128.00px;top:188.32px" class="cls_009"><span class="cls_009">node:  Ruby compiled node</span></div>
<div style="position:absolute;left:128.00px;top:197.82px" class="cls_009"><span class="cls_009">poped: This node will be poped</span></div>
<div style="position:absolute;left:124.25px;top:207.32px" class="cls_009"><span class="cls_009">*/</span></div>
<div style="position:absolute;left:120.50px;top:216.82px" class="cls_009"><span class="cls_009">static int</span></div>
<div style="position:absolute;left:120.50px;top:226.33px" class="cls_009"><span class="cls_009">iseq_compile_each(rb_iseq_t *iseq, LINK_ANCHOR *ret, NODE * node,</span></div>
<div style="position:absolute;left:188.00px;top:235.83px" class="cls_009"><span class="cls_009">int poped)</span></div>
<div style="position:absolute;left:120.50px;top:245.33px" class="cls_009"><span class="cls_009">{</span></div>
<div style="position:absolute;left:120.50px;top:267.83px" class="cls_043"><span class="cls_043">Listing 2-3: This C function compiles each node in the AST.</span></div>
<div style="position:absolute;left:138.50px;top:284.81px" class="cls_039"><span class="cls_039">This function is very long, with a very, very long </span><span class="cls_009">switch</span><span class="cls_039"> statement that runs to</span></div>
<div style="position:absolute;left:120.50px;top:296.81px" class="cls_039"><span class="cls_039">thousands of lines! The </span><span class="cls_009">switch</span><span class="cls_039"> statement branches based on the type of the current</span></div>
<div style="position:absolute;left:120.50px;top:308.82px" class="cls_039"><span class="cls_039">AST node and generates the corresponding YARV code. Listing 2-4 shows the start</span></div>
<div style="position:absolute;left:120.50px;top:320.81px" class="cls_039"><span class="cls_039">of the </span><span class="cls_009">switch</span><span class="cls_039"> statement </span><span class="cls_046">v</span><span class="cls_039">.</span></div>
<div style="position:absolute;left:110.00px;top:343.31px" class="cls_045"><span class="cls_045">u</span><span class="cls_009"> type = nd_type(node);</span></div>
<div style="position:absolute;left:120.50px;top:352.82px" class="cls_009"><span class="cls_009">--snip--</span></div>
<div style="position:absolute;left:110.00px;top:362.32px" class="cls_045"><span class="cls_045">v</span><span class="cls_009"> switch (type) {</span></div>
<div style="position:absolute;left:120.50px;top:384.81px" class="cls_043"><span class="cls_043">Listing 2-4: This C </span><span class="cls_015">switch</span><span class="cls_043"> statement looks at the type of each AST node.</span></div>
<div style="position:absolute;left:138.50px;top:401.81px" class="cls_039"><span class="cls_039">In this statement, </span><span class="cls_009">node</span><span class="cls_039"> </span><span class="cls_046">u</span><span class="cls_039"> is a parameter passed into </span><span class="cls_009">iseq_compile_each</span><span class="cls_039">, and</span></div>
<div style="position:absolute;left:120.50px;top:413.81px" class="cls_009"><span class="cls_009">nd_type</span><span class="cls_039"> is a C macro that returns the type from the given node structure.</span></div>
<div style="position:absolute;left:138.50px;top:425.82px" class="cls_039"><span class="cls_039">Now we’ll look at how Ruby compiles function or method call nodes into YARV</span></div>
<div style="position:absolute;left:120.49px;top:437.81px" class="cls_039"><span class="cls_039">instructions using the receiver-arguments-function call pattern. First, search </span><span class="cls_044">compile.c</span></div>
<div style="position:absolute;left:120.50px;top:449.81px" class="cls_039"><span class="cls_039">for the C </span><span class="cls_009">case</span><span class="cls_039"> statement shown in Listing 2-5.</span></div>
<div style="position:absolute;left:120.50px;top:472.31px" class="cls_009"><span class="cls_009">case NODE_CALL:</span></div>
<div style="position:absolute;left:120.50px;top:481.82px" class="cls_009"><span class="cls_009">case NODE_FCALL:</span></div>
<div style="position:absolute;left:120.50px;top:491.32px" class="cls_009"><span class="cls_009">case NODE_VCALL:{</span></div>
<div style="position:absolute;left:244.25px;top:491.32px" class="cls_009"><span class="cls_009">/* VCALL: variable or call */</span></div>
<div style="position:absolute;left:128.00px;top:500.82px" class="cls_009"><span class="cls_009">/*</span></div>
<div style="position:absolute;left:135.50px;top:510.32px" class="cls_009"><span class="cls_009">call:  obj.method(...)</span></div>
<div style="position:absolute;left:135.50px;top:519.83px" class="cls_009"><span class="cls_009">fcall: func(...)</span></div>
<div style="position:absolute;left:135.50px;top:529.33px" class="cls_009"><span class="cls_009">vcall: func</span></div>
<div style="position:absolute;left:128.00px;top:538.83px" class="cls_009"><span class="cls_009">*/</span></div>
<div style="position:absolute;left:120.50px;top:561.33px" class="cls_043"><span class="cls_043">Listing 2-5: This case of the switch compiles method calls in your Ruby code.</span></div>
<div style="position:absolute;left:138.50px;top:578.31px" class="cls_009"><span class="cls_009">NODE_CALL</span><span class="cls_039"> represents a real method call (like </span><span class="cls_009">10.times</span><span class="cls_039">), </span><span class="cls_009">NODE_FCALL</span><span class="cls_039"> is a function call</span></div>
<div style="position:absolute;left:120.50px;top:590.31px" class="cls_039"><span class="cls_039">(like </span><span class="cls_009">puts</span><span class="cls_039">), and </span><span class="cls_009">NODE_VCALL</span><span class="cls_039"> is a variable or function call. Skipping over some of the C</span></div>
<div style="position:absolute;left:48.00px;top:633.00px" class="cls_020"><span class="cls_020">42</span></div>
<div style="position:absolute;left:69.76px;top:636.00px" class="cls_021"><span class="cls_021">Chapter 2</span></div>
</div>
<div style="position:absolute;left:50%;margin-left:-252px;top:42588px;width:504px;height:666px;border-style:outset;overflow:hidden">
<div style="position:absolute;left:0px;top:0px">
<img src="e698b76e-46bd-11eb-8b25-0cc47a792c0a_id_e698b76e-46bd-11eb-8b25-0cc47a792c0a_files/background067.jpg" width=504 height=666></div>
<div style="position:absolute;left:124.00px;top:61.15px" class="cls_039"><span class="cls_039">code details (including the optional </span><span class="cls_009">SUPPORT_JOKE</span><span class="cls_039"> code used for implementing the </span><span class="cls_009">goto</span></div>
<div style="position:absolute;left:124.00px;top:73.16px" class="cls_039"><span class="cls_039">statement), Listing 2-6 shows what Ruby does next to compile these AST nodes.</span></div>
<div style="position:absolute;left:124.00px;top:95.65px" class="cls_009"><span class="cls_009">/* receiver */</span></div>
<div style="position:absolute;left:124.00px;top:105.16px" class="cls_009"><span class="cls_009">if (type == NODE_CALL) {</span></div>
<div style="position:absolute;left:113.65px;top:114.66px" class="cls_045"><span class="cls_045">u</span><span class="cls_009">     COMPILE(recv, "recv", node->nd_recv);</span></div>
<div style="position:absolute;left:124.00px;top:124.16px" class="cls_009"><span class="cls_009">}</span></div>
<div style="position:absolute;left:124.00px;top:133.66px" class="cls_009"><span class="cls_009">else if (type == NODE_FCALL || type == NODE_VCALL) {</span></div>
<div style="position:absolute;left:113.65px;top:143.17px" class="cls_045"><span class="cls_045">v</span><span class="cls_009">     ADD_CALL_RECEIVER(recv, nd_line(node));</span></div>
<div style="position:absolute;left:124.00px;top:152.67px" class="cls_009"><span class="cls_009">}</span></div>
<div style="position:absolute;left:124.00px;top:175.17px" class="cls_043"><span class="cls_043">Listing 2-6: This C code compiles the receiver value for a method call.</span></div>
<div style="position:absolute;left:142.00px;top:198.15px" class="cls_039"><span class="cls_039">Here, Ruby calls either </span><span class="cls_009">COMPILE</span><span class="cls_039"> or </span><span class="cls_009">ADD_CALL_RECEIVER</span><span class="cls_039"> as follows:</span></div>
<div style="position:absolute;left:124.00px;top:216.15px" class="cls_039"><span class="cls_039">•   In the case of real method calls (like </span><span class="cls_009">NODE_CALL</span><span class="cls_039">), Ruby calls </span><span class="cls_009">COMPILE</span><span class="cls_039"> </span><span class="cls_046">u</span><span class="cls_039"> to recur-</span></div>
<div style="position:absolute;left:142.00px;top:228.15px" class="cls_039"><span class="cls_039">sively call into </span><span class="cls_009">iseq_compile_each</span><span class="cls_039"> again, processing the next AST node down the</span></div>
<div style="position:absolute;left:142.00px;top:240.16px" class="cls_039"><span class="cls_039">tree that corresponds to the receiver of the method call or message. This will</span></div>
<div style="position:absolute;left:142.00px;top:252.16px" class="cls_039"><span class="cls_039">create YARV instructions to evaluate whatever expression was used to specify</span></div>
<div style="position:absolute;left:142.00px;top:264.16px" class="cls_039"><span class="cls_039">the target object.</span></div>
<div style="position:absolute;left:124.00px;top:279.15px" class="cls_039"><span class="cls_039">•   If there is no receiver (</span><span class="cls_009">NODE_FCALL</span><span class="cls_039"> or </span><span class="cls_009">NODE_VCALL</span><span class="cls_039">), Ruby calls </span><span class="cls_009">ADD_CALL_RECEIVER</span><span class="cls_039"> </span><span class="cls_046">v</span><span class="cls_039">,</span></div>
<div style="position:absolute;left:142.00px;top:291.15px" class="cls_039"><span class="cls_039">which creates a </span><span class="cls_009">putself</span><span class="cls_039"> YARV instruction.</span></div>
<div style="position:absolute;left:142.00px;top:309.16px" class="cls_039"><span class="cls_039">Next, as shown in Listing 2-7, Ruby creates YARV instructions to push each argu-</span></div>
<div style="position:absolute;left:124.00px;top:321.16px" class="cls_039"><span class="cls_039">ment of the method/function call onto the stack.</span></div>
<div style="position:absolute;left:124.00px;top:343.65px" class="cls_009"><span class="cls_009">/* args */</span></div>
<div style="position:absolute;left:124.00px;top:353.16px" class="cls_009"><span class="cls_009">if (nd_type(node) != NODE_VCALL) {</span></div>
<div style="position:absolute;left:113.65px;top:362.66px" class="cls_045"><span class="cls_045">u</span><span class="cls_009">     argc = setup_args(iseq, args, node->nd_args, &flag);</span></div>
<div style="position:absolute;left:124.00px;top:372.16px" class="cls_009"><span class="cls_009">}</span></div>
<div style="position:absolute;left:124.00px;top:381.66px" class="cls_009"><span class="cls_009">else {</span></div>
<div style="position:absolute;left:113.65px;top:391.17px" class="cls_045"><span class="cls_045">v</span><span class="cls_009">     argc = INT2FIX(0);</span></div>
<div style="position:absolute;left:124.00px;top:400.67px" class="cls_009"><span class="cls_009">}</span></div>
<div style="position:absolute;left:124.00px;top:423.17px" class="cls_043"><span class="cls_043">Listing 2-7: This snippet of C code compiles the arguments to every Ruby method call.</span></div>
<div style="position:absolute;left:142.00px;top:446.15px" class="cls_039"><span class="cls_039">For </span><span class="cls_009">NODE_CALL</span><span class="cls_039"> and </span><span class="cls_009">NODE_FCALL</span><span class="cls_039">, Ruby calls into the </span><span class="cls_009">setup_args</span><span class="cls_039"> function </span><span class="cls_046">u</span><span class="cls_039">, which</span></div>
<div style="position:absolute;left:124.00px;top:458.15px" class="cls_039"><span class="cls_039">will recursively call into </span><span class="cls_009">iseq_compile_each</span><span class="cls_039"> again as needed in order to compile each</span></div>
<div style="position:absolute;left:124.00px;top:470.15px" class="cls_039"><span class="cls_039">argument to the method/function call. For </span><span class="cls_009">NODE_VCALL</span><span class="cls_039">, there are no arguments, so</span></div>
<div style="position:absolute;left:124.00px;top:482.15px" class="cls_039"><span class="cls_039">Ruby simply sets </span><span class="cls_009">argc</span><span class="cls_039"> to 0 </span><span class="cls_046">v</span><span class="cls_039">.</span></div>
<div style="position:absolute;left:142.00px;top:494.16px" class="cls_039"><span class="cls_039">Finally, Ruby creates YARV instructions to execute the actual method or function</span></div>
<div style="position:absolute;left:123.99px;top:506.16px" class="cls_039"><span class="cls_039">call, as shown here:</span></div>
<div style="position:absolute;left:124.00px;top:528.65px" class="cls_009"><span class="cls_009">ADD_SEND_R(ret, nd_line(node), ID2SYM(mid),</span></div>
<div style="position:absolute;left:165.25px;top:538.16px" class="cls_009"><span class="cls_009">argc, parent_block, LONG2FIX(flag));</span></div>
<div style="position:absolute;left:142.00px;top:561.15px" class="cls_039"><span class="cls_039">This C macro will create the new </span><span class="cls_009">send</span><span class="cls_039"> YARV instruction, which will cause the</span></div>
<div style="position:absolute;left:124.00px;top:573.16px" class="cls_039"><span class="cls_039">actual method call to occur when YARV executes it.</span></div>
<div style="position:absolute;left:401.65px;top:636.00px" class="cls_021"><span class="cls_021">Compilation</span></div>
<div style="position:absolute;left:446.93px;top:633.00px" class="cls_020"><span class="cls_020">43</span></div>
</div>
<div style="position:absolute;left:50%;margin-left:-252px;top:43264px;width:504px;height:666px;border-style:outset;overflow:hidden">
<div style="position:absolute;left:0px;top:0px">
<img src="e698b76e-46bd-11eb-8b25-0cc47a792c0a_id_e698b76e-46bd-11eb-8b25-0cc47a792c0a_files/background068.jpg" width=504 height=666></div>
<div style="position:absolute;left:218.95px;top:48.60px" class="cls_067"><span class="cls_067">YARV instructions</span></div>
<div style="position:absolute;left:140.75px;top:53.31px" class="cls_068"><span class="cls_068">NODE_SCOPE</span></div>
<div style="position:absolute;left:130.13px;top:65.35px" class="cls_030"><span class="cls_030">table: [ none ]</span></div>
<div style="position:absolute;left:219.35px;top:67.48px" class="cls_009"><span class="cls_009">putobject</span></div>
<div style="position:absolute;left:283.05px;top:67.48px" class="cls_009"><span class="cls_009">10</span></div>
<div style="position:absolute;left:134.38px;top:74.86px" class="cls_030"><span class="cls_030">args: [ none ]</span></div>
<div style="position:absolute;left:219.35px;top:76.03px" class="cls_009"><span class="cls_009">send</span></div>
<div style="position:absolute;left:283.05px;top:76.03px" class="cls_009"><span class="cls_009">&lt;callinfo!mid:times,</span></div>
<div style="position:absolute;left:283.05px;top:84.47px" class="cls_009"><span class="cls_009">argc:0,</span></div>
<div style="position:absolute;left:283.05px;top:93.02px" class="cls_009"><span class="cls_009">block:block in &lt;compiled>></span></div>
<div style="position:absolute;left:218.95px;top:116.06px" class="cls_067"><span class="cls_067">YARV instructions</span></div>
<div style="position:absolute;left:140.75px;top:131.29px" class="cls_068"><span class="cls_068">NODE_SCOPE</span></div>
<div style="position:absolute;left:219.35px;top:134.95px" class="cls_009"><span class="cls_009">putself</span></div>
<div style="position:absolute;left:219.35px;top:143.49px" class="cls_009"><span class="cls_009">getlocal</span></div>
<div style="position:absolute;left:283.05px;top:143.49px" class="cls_009"><span class="cls_009">2</span></div>
<div style="position:absolute;left:140.75px;top:144.60px" class="cls_030"><span class="cls_030">table: </span><span class="cls_038">n</span></div>
<div style="position:absolute;left:219.35px;top:152.04px" class="cls_009"><span class="cls_009">opt_send_simple</span></div>
<div style="position:absolute;left:283.05px;top:152.04px" class="cls_009"><span class="cls_009">&lt;callinfo!mid:puts,</span></div>
<div style="position:absolute;left:145.00px;top:154.10px" class="cls_030"><span class="cls_030">args: </span><span class="cls_038">1</span></div>
<div style="position:absolute;left:283.05px;top:160.58px" class="cls_009"><span class="cls_009">argc:1, ...</span></div>
<div style="position:absolute;left:120.00px;top:182.19px" class="cls_038"><span class="cls_038">Figure 2-14: How Ruby compiles a call to a block</span></div>
<div style="position:absolute;left:138.00px;top:204.69px" class="cls_007"><span class="cls_007">You can see the parent </span><span class="cls_030">NODE_SCOPE</span><span class="cls_007"> at the top, along with the YARV code</span></div>
<div style="position:absolute;left:120.00px;top:216.69px" class="cls_007"><span class="cls_007">from Figure 2-12. Below that I’ve listed the YARV code compiled from the</span></div>
<div style="position:absolute;left:120.00px;top:228.69px" class="cls_007"><span class="cls_007">inner block’s AST.</span></div>
<div style="position:absolute;left:138.00px;top:240.69px" class="cls_007"><span class="cls_007">The key point here is that Ruby compiles each distinct scope in your</span></div>
<div style="position:absolute;left:120.00px;top:252.69px" class="cls_007"><span class="cls_007">Ruby program—methods, blocks, classes, or modules, for example—into</span></div>
<div style="position:absolute;left:120.00px;top:264.69px" class="cls_007"><span class="cls_007">a separate snippet of YARV instructions.</span></div>
<div style="position:absolute;left:120.00px;top:298.69px" class="cls_031"><span class="cls_031">Experiment 2-1: Displaying YARV Instructions</span></div>
<div style="position:absolute;left:120.00px;top:318.69px" class="cls_007"><span class="cls_007">One easy way to see how Ruby compiles your code is with </span><span class="cls_030">RubyVM::</span></div>
<div style="position:absolute;left:120.00px;top:330.69px" class="cls_030"><span class="cls_030">InstructionSequence</span><span class="cls_007">, which gives you access to Ruby’s YARV engine from</span></div>
<div style="position:absolute;left:120.01px;top:342.69px" class="cls_007"><span class="cls_007">your Ruby program! Like the Ripper tool, its use is very straightforward,</span></div>
<div style="position:absolute;left:120.00px;top:354.69px" class="cls_007"><span class="cls_007">as you can see in Listing 2-8.</span></div>
<div style="position:absolute;left:120.00px;top:378.69px" class="cls_030"><span class="cls_030">code = &lt;&lt;END</span></div>
<div style="position:absolute;left:120.00px;top:389.19px" class="cls_030"><span class="cls_030">puts 2+2</span></div>
<div style="position:absolute;left:120.00px;top:399.69px" class="cls_030"><span class="cls_030">END</span></div>
<div style="position:absolute;left:120.00px;top:410.18px" class="cls_030"><span class="cls_030">puts RubyVM::InstructionSequence.compile(code).disasm</span></div>
<div style="position:absolute;left:120.00px;top:432.68px" class="cls_038"><span class="cls_038">Listing 2-8: How to view the YARV instructions for </span><span class="cls_014">puts 2+2</span></div>
<div style="position:absolute;left:138.00px;top:455.19px" class="cls_007"><span class="cls_007">The challenge lies in understanding what the output actually means.</span></div>
<div style="position:absolute;left:120.00px;top:467.19px" class="cls_007"><span class="cls_007">For example, Listing 2-9 shows the output for </span><span class="cls_030">puts 2+2</span><span class="cls_007">.</span></div>
<div style="position:absolute;left:120.00px;top:491.19px" class="cls_030"><span class="cls_030">==</span></div>
<div style="position:absolute;left:132.75px;top:491.19px" class="cls_030"><span class="cls_030">disasm: &lt;RubyVM::InstructionSequence:&lt;compiled>@&lt;compiled>>==========</span></div>
<div style="position:absolute;left:108.15px;top:501.69px" class="cls_046"><span class="cls_046">u</span><span class="cls_030"> 0000 trace</span></div>
<div style="position:absolute;left:213.48px;top:501.69px" class="cls_030"><span class="cls_030">1</span></div>
<div style="position:absolute;left:417.48px;top:501.69px" class="cls_030"><span class="cls_030">(</span></div>
<div style="position:absolute;left:434.48px;top:501.69px" class="cls_030"><span class="cls_030">1)</span></div>
<div style="position:absolute;left:120.00px;top:512.19px" class="cls_030"><span class="cls_030">0002 putself</span></div>
<div style="position:absolute;left:120.00px;top:522.68px" class="cls_030"><span class="cls_030">0003 putobject</span></div>
<div style="position:absolute;left:213.50px;top:522.68px" class="cls_030"><span class="cls_030">2</span></div>
<div style="position:absolute;left:120.00px;top:533.18px" class="cls_030"><span class="cls_030">0005 putobject</span></div>
<div style="position:absolute;left:213.50px;top:533.18px" class="cls_030"><span class="cls_030">2</span></div>
<div style="position:absolute;left:120.00px;top:543.68px" class="cls_030"><span class="cls_030">0007 opt_plus</span></div>
<div style="position:absolute;left:213.50px;top:543.68px" class="cls_030"><span class="cls_030">&lt;callinfo!mid:+, argc:1, ARGS_SKIP></span></div>
<div style="position:absolute;left:120.00px;top:554.18px" class="cls_030"><span class="cls_030">0009 opt_send_simple</span></div>
<div style="position:absolute;left:213.50px;top:554.18px" class="cls_030"><span class="cls_030">&lt;callinfo!mid:puts, argc:1, FCALL|ARGS_SKIP></span></div>
<div style="position:absolute;left:108.15px;top:564.67px" class="cls_046"><span class="cls_046">v</span><span class="cls_030"> 0011 leave</span></div>
<div style="position:absolute;left:120.00px;top:587.17px" class="cls_038"><span class="cls_038">Listing 2-9: The YARV instructions for </span><span class="cls_014">puts 2+2</span></div>
<div style="position:absolute;left:48.00px;top:633.00px" class="cls_020"><span class="cls_020">44</span></div>
<div style="position:absolute;left:70.06px;top:636.00px" class="cls_021"><span class="cls_021">Chapter 2</span></div>
</div>
<div style="position:absolute;left:50%;margin-left:-252px;top:43940px;width:504px;height:666px;border-style:outset;overflow:hidden">
<div style="position:absolute;left:0px;top:0px">
<img src="e698b76e-46bd-11eb-8b25-0cc47a792c0a_id_e698b76e-46bd-11eb-8b25-0cc47a792c0a_files/background069.jpg" width=504 height=666></div>
<div style="position:absolute;left:141.00px;top:42.28px" class="cls_007"><span class="cls_007">As you can see in Listing 2-9, the output contains all of the same</span></div>
<div style="position:absolute;left:123.00px;top:54.28px" class="cls_007"><span class="cls_007">instructions from Figures 2-5 to 2-8 and two new ones: </span><span class="cls_030">trace</span><span class="cls_007"> </span><span class="cls_050">u</span><span class="cls_007"> and </span><span class="cls_030">leave</span><span class="cls_007"> </span><span class="cls_050">v</span><span class="cls_007">.</span></div>
<div style="position:absolute;left:123.00px;top:64.68px" class="cls_007"><span class="cls_007">The </span><span class="cls_030">trace</span><span class="cls_007"> instruction is used to implement the </span><span class="cls_030">set_trace_func</span><span class="cls_007"> feature,</span><span class="cls_027"><sup>1</sup></span><span class="cls_007"> which</span></div>
<div style="position:absolute;left:123.00px;top:78.28px" class="cls_007"><span class="cls_007">will call a given function for each Ruby statement executed in your pro-</span></div>
<div style="position:absolute;left:123.00px;top:90.28px" class="cls_007"><span class="cls_007">gram. The </span><span class="cls_030">leave</span><span class="cls_007"> function is like a return statement. The line numbers on</span></div>
<div style="position:absolute;left:123.00px;top:102.28px" class="cls_007"><span class="cls_007">the left show the position of each instruction in the bytecode array that the</span></div>
<div style="position:absolute;left:123.00px;top:114.28px" class="cls_007"><span class="cls_007">compiler actually produces.</span></div>
<div style="position:absolute;left:141.00px;top:126.28px" class="cls_030"><span class="cls_030">RubyVM::InstructionSequence</span><span class="cls_007"> makes it easy to explore how Ruby compiles</span></div>
<div style="position:absolute;left:123.00px;top:138.28px" class="cls_007"><span class="cls_007">different Ruby scripts. For example, Listing 2-10 shows how to compile my</span></div>
<div style="position:absolute;left:123.00px;top:150.28px" class="cls_030"><span class="cls_030">10.times do</span><span class="cls_007"> example.</span></div>
<div style="position:absolute;left:123.00px;top:174.28px" class="cls_030"><span class="cls_030">code = &lt;&lt;END</span></div>
<div style="position:absolute;left:123.00px;top:184.78px" class="cls_030"><span class="cls_030">10.times do |n|</span></div>
<div style="position:absolute;left:131.50px;top:195.27px" class="cls_030"><span class="cls_030">puts n</span></div>
<div style="position:absolute;left:123.00px;top:205.77px" class="cls_030"><span class="cls_030">end</span></div>
<div style="position:absolute;left:123.00px;top:216.27px" class="cls_030"><span class="cls_030">END</span></div>
<div style="position:absolute;left:123.00px;top:226.77px" class="cls_030"><span class="cls_030">puts RubyVM::InstructionSequence.compile(code).disasm</span></div>
<div style="position:absolute;left:123.00px;top:249.27px" class="cls_038"><span class="cls_038">Listing 2-10: Displaying the YARV instructions for a call to a block</span></div>
<div style="position:absolute;left:141.00px;top:271.78px" class="cls_007"><span class="cls_007">The output that I get now is shown below in Listing 2-11. Notice that the</span></div>
<div style="position:absolute;left:123.00px;top:283.78px" class="cls_030"><span class="cls_030">send &lt;callinfo!mid:times</span><span class="cls_007"> YARV instruction shows </span><span class="cls_030">block:block in &lt;compiled></span><span class="cls_007"> </span><span class="cls_050">v</span><span class="cls_007">,</span></div>
<div style="position:absolute;left:123.00px;top:295.78px" class="cls_007"><span class="cls_007">which indicates that I’m passing a block to the </span><span class="cls_030">10.times</span><span class="cls_007"> method call.</span></div>
<div style="position:absolute;left:111.15px;top:319.78px" class="cls_046"><span class="cls_046">u</span><span class="cls_030"> == disasm: &lt;RubyVM::InstructionSequence:&lt;compiled>@&lt;compiled>>==========</span></div>
<div style="position:absolute;left:123.00px;top:330.28px" class="cls_030"><span class="cls_030">==</span></div>
<div style="position:absolute;left:135.75px;top:330.28px" class="cls_030"><span class="cls_030">catch table</span></div>
<div style="position:absolute;left:123.00px;top:340.77px" class="cls_030"><span class="cls_030">| catch type: break  st: 0002 ed: 0006 sp: 0000 cont: 0006</span></div>
<div style="position:absolute;left:123.00px;top:351.27px" class="cls_030"><span class="cls_030">|------------------------------------------------------------------------</span></div>
<div style="position:absolute;left:123.00px;top:361.77px" class="cls_030"><span class="cls_030">0000 trace</span></div>
<div style="position:absolute;left:216.50px;top:361.77px" class="cls_030"><span class="cls_030">1</span></div>
<div style="position:absolute;left:420.50px;top:361.77px" class="cls_030"><span class="cls_030">(</span></div>
<div style="position:absolute;left:437.50px;top:361.77px" class="cls_030"><span class="cls_030">1)</span></div>
<div style="position:absolute;left:123.00px;top:372.27px" class="cls_030"><span class="cls_030">0002 putobject</span></div>
<div style="position:absolute;left:216.50px;top:372.27px" class="cls_030"><span class="cls_030">10</span></div>
<div style="position:absolute;left:111.15px;top:382.77px" class="cls_046"><span class="cls_046">v</span><span class="cls_030"> 0004 send</span></div>
<div style="position:absolute;left:216.48px;top:382.77px" class="cls_030"><span class="cls_030">&lt;callinfo!mid:times, argc:0, block:block in &lt;compiled>></span></div>
<div style="position:absolute;left:123.00px;top:393.26px" class="cls_030"><span class="cls_030">0006 leave</span></div>
<div style="position:absolute;left:111.15px;top:403.76px" class="cls_046"><span class="cls_046">w</span><span class="cls_030"> == disasm: &lt;RubyVM::InstructionSequence:block in &lt;compiled>@&lt;compiled>>=</span></div>
<div style="position:absolute;left:123.00px;top:414.26px" class="cls_030"><span class="cls_030">==</span></div>
<div style="position:absolute;left:135.75px;top:414.26px" class="cls_030"><span class="cls_030">catch table</span></div>
<div style="position:absolute;left:123.00px;top:424.76px" class="cls_030"><span class="cls_030">| catch type: redo   st: 0000 ed: 0011 sp: 0000 cont: 0000</span></div>
<div style="position:absolute;left:123.00px;top:435.25px" class="cls_030"><span class="cls_030">| catch type: next   st: 0000 ed: 0011 sp: 0000 cont: 0011</span></div>
<div style="position:absolute;left:123.00px;top:445.75px" class="cls_030"><span class="cls_030">|------------------------------------------------------------------------</span></div>
<div style="position:absolute;left:123.00px;top:456.25px" class="cls_030"><span class="cls_030">local table (size: 2, argc: 1 [opts: 0, rest: -1, post: 0, block: -1] s3)</span></div>
<div style="position:absolute;left:123.00px;top:466.74px" class="cls_030"><span class="cls_030">[ 2] n&lt;Arg></span></div>
<div style="position:absolute;left:123.00px;top:477.24px" class="cls_030"><span class="cls_030">0000 trace</span></div>
<div style="position:absolute;left:216.50px;top:477.24px" class="cls_030"><span class="cls_030">256</span></div>
<div style="position:absolute;left:420.50px;top:477.24px" class="cls_030"><span class="cls_030">(</span></div>
<div style="position:absolute;left:437.50px;top:477.24px" class="cls_030"><span class="cls_030">1)</span></div>
<div style="position:absolute;left:123.00px;top:487.74px" class="cls_030"><span class="cls_030">0002 trace</span></div>
<div style="position:absolute;left:216.50px;top:487.74px" class="cls_030"><span class="cls_030">1</span></div>
<div style="position:absolute;left:420.50px;top:487.74px" class="cls_030"><span class="cls_030">(</span></div>
<div style="position:absolute;left:437.50px;top:487.74px" class="cls_030"><span class="cls_030">2)</span></div>
<div style="position:absolute;left:123.00px;top:498.24px" class="cls_030"><span class="cls_030">0004 putself</span></div>
<div style="position:absolute;left:123.00px;top:508.73px" class="cls_030"><span class="cls_030">0005 getlocal_OP__WC__0 2</span></div>
<div style="position:absolute;left:123.00px;top:519.23px" class="cls_030"><span class="cls_030">0007 opt_send_simple</span></div>
<div style="position:absolute;left:216.50px;top:519.23px" class="cls_030"><span class="cls_030">&lt;callinfo!mid:puts, argc:1, FCALL|ARGS_SKIP></span></div>
<div style="position:absolute;left:123.00px;top:529.73px" class="cls_030"><span class="cls_030">0009 trace</span></div>
<div style="position:absolute;left:216.50px;top:529.73px" class="cls_030"><span class="cls_030">512</span></div>
<div style="position:absolute;left:420.50px;top:529.73px" class="cls_030"><span class="cls_030">(</span></div>
<div style="position:absolute;left:437.50px;top:529.73px" class="cls_030"><span class="cls_030">3)</span></div>
<div style="position:absolute;left:123.00px;top:540.23px" class="cls_030"><span class="cls_030">0011 leave</span></div>
<div style="position:absolute;left:420.50px;top:540.23px" class="cls_030"><span class="cls_030">(</span></div>
<div style="position:absolute;left:437.50px;top:540.23px" class="cls_030"><span class="cls_030">2)</span></div>
<div style="position:absolute;left:123.00px;top:562.73px" class="cls_038"><span class="cls_038">Listing 2-11: The YARV instructions for a call to a block and for the block itself</span></div>
<div style="position:absolute;left:123.00px;top:613.00px" class="cls_014"><span class="cls_014">1. For Ruby 2.x, the Ruby core team recommends using </span><span class="cls_015">TracePoint</span><span class="cls_014"> instead of </span><span class="cls_015">set_trace_func</span><span class="cls_014">.</span></div>
<div style="position:absolute;left:401.90px;top:636.00px" class="cls_021"><span class="cls_021">Compilation</span></div>
<div style="position:absolute;left:447.18px;top:633.00px" class="cls_020"><span class="cls_020">45</span></div>
</div>
<div style="position:absolute;left:50%;margin-left:-252px;top:44616px;width:504px;height:666px;border-style:outset;overflow:hidden">
<div style="position:absolute;left:0px;top:0px">
<img src="e698b76e-46bd-11eb-8b25-0cc47a792c0a_id_e698b76e-46bd-11eb-8b25-0cc47a792c0a_files/background070.jpg" width=504 height=666></div>
<div style="position:absolute;left:138.00px;top:41.60px" class="cls_007"><span class="cls_007">As you can see, Ruby displays the two YARV instruction snippets sepa-</span></div>
<div style="position:absolute;left:120.00px;top:53.60px" class="cls_007"><span class="cls_007">rately. The first corresponds to the global scope </span><span class="cls_050">u</span><span class="cls_007"> and the second to the</span></div>
<div style="position:absolute;left:120.00px;top:65.60px" class="cls_007"><span class="cls_007">inner block scope </span><span class="cls_050">w</span><span class="cls_007">.</span></div>
<div style="position:absolute;left:66.00px;top:99.60px" class="cls_031"><span class="cls_031">The Local Table</span></div>
<div style="position:absolute;left:120.00px;top:119.60px" class="cls_007"><span class="cls_007">In Figures 2-3 through 2-14, you may have noticed that each </span><span class="cls_030">NODE_SCOPE</span><span class="cls_007"> ele-</span></div>
<div style="position:absolute;left:120.00px;top:131.60px" class="cls_007"><span class="cls_007">ment in the AST contained information I labeled </span><span class="cls_030">table</span><span class="cls_007"> and </span><span class="cls_030">args</span><span class="cls_007">. These</span></div>
<div style="position:absolute;left:120.00px;top:143.60px" class="cls_007"><span class="cls_007">values in the inner </span><span class="cls_030">NODE_SCOPE</span><span class="cls_007"> structure contain information about the</span></div>
<div style="position:absolute;left:120.00px;top:155.60px" class="cls_007"><span class="cls_007">block’s parameter </span><span class="cls_030">n</span><span class="cls_007"> (see Figure 2-9 on page 39).</span></div>
<div style="position:absolute;left:138.00px;top:167.60px" class="cls_007"><span class="cls_007">Ruby generated the information about this block parameter during the</span></div>
<div style="position:absolute;left:120.00px;top:179.60px" class="cls_007"><span class="cls_007">parsing process. As I discussed in Chapter 1, Ruby parses the block param-</span></div>
<div style="position:absolute;left:120.00px;top:191.60px" class="cls_007"><span class="cls_007">eter along with the rest of my Ruby code using grammar rules. In fact, I</span></div>
<div style="position:absolute;left:120.00px;top:203.60px" class="cls_007"><span class="cls_007">showed the specific rule for parsing block parameters back in Figure 1-30</span></div>
<div style="position:absolute;left:120.00px;top:215.60px" class="cls_007"><span class="cls_007">(page 21): </span><span class="cls_030">opt_block_param</span><span class="cls_007">.</span></div>
<div style="position:absolute;left:138.00px;top:227.60px" class="cls_007"><span class="cls_007">Once Ruby’s compiler runs, however, the information about the block</span></div>
<div style="position:absolute;left:120.00px;top:239.60px" class="cls_007"><span class="cls_007">parameter is copied out of the AST and into another data structure called</span></div>
<div style="position:absolute;left:120.00px;top:251.60px" class="cls_007"><span class="cls_007">the </span><span class="cls_008">local table</span><span class="cls_007">, saved nearby the newly generated YARV instructions. Each</span></div>
<div style="position:absolute;left:119.99px;top:263.60px" class="cls_007"><span class="cls_007">snippet of YARV instructions, each scope in your Ruby program, has its own</span></div>
<div style="position:absolute;left:119.99px;top:275.60px" class="cls_007"><span class="cls_007">local table.</span></div>
<div style="position:absolute;left:137.99px;top:287.60px" class="cls_007"><span class="cls_007">Figure 2-15 shows the local table attached to the YARV instructions that</span></div>
<div style="position:absolute;left:119.99px;top:299.60px" class="cls_007"><span class="cls_007">Ruby generated for the sample block code from Listing 2-2.</span></div>
<div style="position:absolute;left:123.67px;top:326.81px" class="cls_063"><span class="cls_063">... do |n|</span></div>
<div style="position:absolute;left:133.17px;top:338.31px" class="cls_063"><span class="cls_063">puts n</span></div>
<div style="position:absolute;left:123.67px;top:349.82px" class="cls_063"><span class="cls_063">end</span></div>
<div style="position:absolute;left:123.80px;top:391.98px" class="cls_067"><span class="cls_067">YARV instructions</span></div>
<div style="position:absolute;left:348.36px;top:390.58px" class="cls_067"><span class="cls_067">Local Table</span></div>
<div style="position:absolute;left:123.67px;top:416.51px" class="cls_009"><span class="cls_009">putself</span></div>
<div style="position:absolute;left:331.19px;top:416.25px" class="cls_009"><span class="cls_009">[ 2] n&lt;Arg></span></div>
<div style="position:absolute;left:123.67px;top:427.64px" class="cls_009"><span class="cls_009">getlocal</span></div>
<div style="position:absolute;left:199.76px;top:427.38px" class="cls_009"><span class="cls_009">2</span></div>
<div style="position:absolute;left:123.67px;top:438.77px" class="cls_009"><span class="cls_009">opt_send_simple</span></div>
<div style="position:absolute;left:199.76px;top:438.51px" class="cls_009"><span class="cls_009">&lt;callinfo!mid:puts...</span></div>
<div style="position:absolute;left:120.00px;top:475.36px" class="cls_038"><span class="cls_038">Figure 2-15: A snippet of YARV instructions with a local table</span></div>
<div style="position:absolute;left:138.00px;top:497.86px" class="cls_007"><span class="cls_007">Notice on the right side of Figure 2-15 that Ruby has associated the</span></div>
<div style="position:absolute;left:120.00px;top:509.86px" class="cls_007"><span class="cls_007">number 2 with the block parameter </span><span class="cls_030">n</span><span class="cls_007">. As we’ll see in Chapter 3, the YARV</span></div>
<div style="position:absolute;left:120.00px;top:521.86px" class="cls_007"><span class="cls_007">instructions that refer to </span><span class="cls_030">n</span><span class="cls_007"> will use this index 2. The </span><span class="cls_030">getlocal </span><span class="cls_007">instruction is</span></div>
<div style="position:absolute;left:120.00px;top:533.86px" class="cls_007"><span class="cls_007">an example of this. The </span><span class="cls_030">&lt;Arg></span><span class="cls_007"> notation indicates that this value is an argu-</span></div>
<div style="position:absolute;left:120.00px;top:545.86px" class="cls_007"><span class="cls_007">ment to the block.</span></div>
<div style="position:absolute;left:138.00px;top:557.86px" class="cls_007"><span class="cls_007">As it turns out, Ruby also saves information about local variables in this</span></div>
<div style="position:absolute;left:120.00px;top:569.86px" class="cls_007"><span class="cls_007">table, hence the name </span><span class="cls_008">local table</span><span class="cls_007">. Figure 2-16 shows the YARV instructions</span></div>
<div style="position:absolute;left:120.00px;top:581.86px" class="cls_007"><span class="cls_007">and local table Ruby will generate when compiling a method that uses one</span></div>
<div style="position:absolute;left:120.00px;top:593.86px" class="cls_007"><span class="cls_007">local variable and takes two arguments.</span></div>
<div style="position:absolute;left:48.00px;top:633.00px" class="cls_020"><span class="cls_020">46</span></div>
<div style="position:absolute;left:70.03px;top:636.00px" class="cls_021"><span class="cls_021">Chapter 2</span></div>
</div>
<div style="position:absolute;left:50%;margin-left:-252px;top:45292px;width:504px;height:666px;border-style:outset;overflow:hidden">
<div style="position:absolute;left:0px;top:0px">
<img src="e698b76e-46bd-11eb-8b25-0cc47a792c0a_id_e698b76e-46bd-11eb-8b25-0cc47a792c0a_files/background071.jpg" width=504 height=666></div>
<div style="position:absolute;left:126.67px;top:50.05px" class="cls_063"><span class="cls_063">def add_two(a, b)</span></div>
<div style="position:absolute;left:136.17px;top:61.56px" class="cls_063"><span class="cls_063">sum = a+b</span></div>
<div style="position:absolute;left:126.67px;top:73.06px" class="cls_063"><span class="cls_063">end</span></div>
<div style="position:absolute;left:126.80px;top:115.69px" class="cls_067"><span class="cls_067">YARV instructions</span></div>
<div style="position:absolute;left:351.36px;top:114.26px" class="cls_067"><span class="cls_067">Local Table</span></div>
<div style="position:absolute;left:126.67px;top:140.63px" class="cls_009"><span class="cls_009">getlocal</span></div>
<div style="position:absolute;left:202.76px;top:140.35px" class="cls_009"><span class="cls_009">4</span></div>
<div style="position:absolute;left:334.19px;top:140.63px" class="cls_009"><span class="cls_009">[ 2] sum</span></div>
<div style="position:absolute;left:126.67px;top:151.94px" class="cls_009"><span class="cls_009">getlocal</span></div>
<div style="position:absolute;left:202.76px;top:151.67px" class="cls_009"><span class="cls_009">3</span></div>
<div style="position:absolute;left:334.19px;top:151.94px" class="cls_009"><span class="cls_009">[ 3] b&lt;Arg></span></div>
<div style="position:absolute;left:126.67px;top:163.26px" class="cls_009"><span class="cls_009">opt_plus</span></div>
<div style="position:absolute;left:202.76px;top:162.98px" class="cls_009"><span class="cls_009">&lt;callinfo!mid:+...</span></div>
<div style="position:absolute;left:334.19px;top:163.26px" class="cls_009"><span class="cls_009">[ 4] a&lt;Arg></span></div>
<div style="position:absolute;left:126.67px;top:174.58px" class="cls_009"><span class="cls_009">dup</span></div>
<div style="position:absolute;left:126.67px;top:185.90px" class="cls_009"><span class="cls_009">setlocal</span></div>
<div style="position:absolute;left:202.76px;top:185.62px" class="cls_009"><span class="cls_009">2</span></div>
<div style="position:absolute;left:123.00px;top:216.82px" class="cls_038"><span class="cls_038">Figure 2-16: This local table contains one local variable and two arguments.</span></div>
<div style="position:absolute;left:141.00px;top:239.32px" class="cls_007"><span class="cls_007">Here, you can see that Ruby lists all three values in the local table.</span></div>
<div style="position:absolute;left:123.00px;top:251.32px" class="cls_007"><span class="cls_007">As we’ll see in Chapter 3, Ruby treats local variables and method argu-</span></div>
<div style="position:absolute;left:123.00px;top:263.32px" class="cls_007"><span class="cls_007">ments in the same way. (Notice that the local variable </span><span class="cls_030">sum</span><span class="cls_007"> does not have</span></div>
<div style="position:absolute;left:123.00px;top:275.32px" class="cls_007"><span class="cls_007">the </span><span class="cls_030">&lt;Arg></span><span class="cls_007"> label.)</span></div>
<div style="position:absolute;left:141.00px;top:287.32px" class="cls_007"><span class="cls_007">Think of the local table as a key to help you understand what the</span></div>
<div style="position:absolute;left:123.00px;top:299.32px" class="cls_007"><span class="cls_007">YARV instructions do, similar to the legend on a map. As you can see in</span></div>
<div style="position:absolute;left:123.00px;top:311.32px" class="cls_007"><span class="cls_007">Figure 2-16, local variables have no label, but Ruby uses the following</span></div>
<div style="position:absolute;left:123.00px;top:323.32px" class="cls_007"><span class="cls_007">labels to describe different types of method and block arguments:</span></div>
<div style="position:absolute;left:141.00px;top:344.32px" class="cls_040"><span class="cls_040">&lt;Arg></span><span class="cls_007">    A standard method or block argument</span></div>
<div style="position:absolute;left:141.00px;top:362.32px" class="cls_040"><span class="cls_040">&lt;Rest></span><span class="cls_007">   An array of unnamed arguments that are passed together using</span></div>
<div style="position:absolute;left:177.00px;top:374.32px" class="cls_007"><span class="cls_007">a </span><span class="cls_030">*</span><span class="cls_007"> (splat) operator</span></div>
<div style="position:absolute;left:141.00px;top:392.32px" class="cls_040"><span class="cls_040">&lt;Post></span><span class="cls_007">   A standard argument that appears after the splat array</span></div>
<div style="position:absolute;left:141.00px;top:410.32px" class="cls_040"><span class="cls_040">&lt;Block></span><span class="cls_007">  A Ruby proc object that is passed using the </span><span class="cls_030">&</span><span class="cls_007"> operator</span></div>
<div style="position:absolute;left:141.00px;top:428.32px" class="cls_040"><span class="cls_040">&lt;Opt=i></span><span class="cls_007">  A parameter defined with a default value. Internally, this</span></div>
<div style="position:absolute;left:177.00px;top:440.32px" class="cls_007"><span class="cls_007">value is a pointer to YARV instructions that set the default</span></div>
<div style="position:absolute;left:177.00px;top:452.32px" class="cls_007"><span class="cls_007">value. The local table does not contain the actual default</span></div>
<div style="position:absolute;left:177.00px;top:464.32px" class="cls_007"><span class="cls_007">values.</span></div>
<div style="position:absolute;left:141.00px;top:485.32px" class="cls_007"><span class="cls_007">Understanding the information displayed by the local table can help</span></div>
<div style="position:absolute;left:123.00px;top:497.32px" class="cls_007"><span class="cls_007">you understand how Ruby’s complex argument syntax works and how to</span></div>
<div style="position:absolute;left:123.00px;top:509.32px" class="cls_007"><span class="cls_007">take full advantage of the language.</span></div>
<div style="position:absolute;left:141.00px;top:521.32px" class="cls_007"><span class="cls_007">To help you understand what I mean, let’s look at how Ruby com-</span></div>
<div style="position:absolute;left:123.00px;top:533.32px" class="cls_007"><span class="cls_007">piles a method call that uses an array of unnamed arguments, as shown</span></div>
<div style="position:absolute;left:123.00px;top:545.32px" class="cls_007"><span class="cls_007">Listing 2-12.</span></div>
<div style="position:absolute;left:401.95px;top:636.00px" class="cls_021"><span class="cls_021">Compilation</span></div>
<div style="position:absolute;left:447.23px;top:633.00px" class="cls_020"><span class="cls_020">47</span></div>
</div>
<div style="position:absolute;left:50%;margin-left:-252px;top:45968px;width:504px;height:666px;border-style:outset;overflow:hidden">
<div style="position:absolute;left:0px;top:0px">
<img src="e698b76e-46bd-11eb-8b25-0cc47a792c0a_id_e698b76e-46bd-11eb-8b25-0cc47a792c0a_files/background072.jpg" width=504 height=666></div>
<div style="position:absolute;left:120.00px;top:49.00px" class="cls_030"><span class="cls_030">def complex_formula(a, b, *args, c)</span></div>
<div style="position:absolute;left:128.50px;top:59.50px" class="cls_030"><span class="cls_030">a + b + args.size + c</span></div>
<div style="position:absolute;left:120.00px;top:70.00px" class="cls_030"><span class="cls_030">end</span></div>
<div style="position:absolute;left:120.00px;top:92.49px" class="cls_038"><span class="cls_038">Listing 2-12: A method that takes standard arguments and an array of unnamed</span></div>
<div style="position:absolute;left:120.00px;top:102.99px" class="cls_038"><span class="cls_038">arguments</span></div>
<div style="position:absolute;left:138.00px;top:125.50px" class="cls_007"><span class="cls_007">Here </span><span class="cls_030">a</span><span class="cls_007">, </span><span class="cls_030">b</span><span class="cls_007">, and </span><span class="cls_030">c</span><span class="cls_007"> are standard arguments, and </span><span class="cls_030">args</span><span class="cls_007"> is an array of other</span></div>
<div style="position:absolute;left:120.00px;top:137.50px" class="cls_007"><span class="cls_007">arguments that appear between </span><span class="cls_030">b</span><span class="cls_007"> and </span><span class="cls_030">c</span><span class="cls_007">. Figure 2-17 shows how the local</span></div>
<div style="position:absolute;left:120.00px;top:149.50px" class="cls_007"><span class="cls_007">table saves all of this information.</span></div>
<div style="position:absolute;left:138.00px;top:161.50px" class="cls_007"><span class="cls_007">As in Figure 2-16, </span><span class="cls_030">&lt;Arg></span><span class="cls_007"> refers to a standard argument. But now Ruby</span></div>
<div style="position:absolute;left:120.00px;top:173.50px" class="cls_007"><span class="cls_007">uses </span><span class="cls_030">&lt;Rest></span><span class="cls_007"> to indicate that value 3 contains the “rest” of the arguments and</span></div>
<div style="position:absolute;left:120.00px;top:185.50px" class="cls_030"><span class="cls_030">&lt;Post></span><span class="cls_007"> to indicate that value 2 contains the argument that appears after the</span></div>
<div style="position:absolute;left:120.00px;top:197.50px" class="cls_007"><span class="cls_007">unnamed array, the last one.</span></div>
<div style="position:absolute;left:122.80px;top:224.92px" class="cls_071"><span class="cls_071">def complex_formula (a, b, *args, c)</span></div>
<div style="position:absolute;left:132.30px;top:236.45px" class="cls_063"><span class="cls_063">a + b + args.size + c</span></div>
<div style="position:absolute;left:122.80px;top:247.96px" class="cls_063"><span class="cls_063">end</span></div>
<div style="position:absolute;left:123.80px;top:290.59px" class="cls_067"><span class="cls_067">YARV instructions</span></div>
<div style="position:absolute;left:348.36px;top:289.16px" class="cls_067"><span class="cls_067">Local Table</span></div>
<div style="position:absolute;left:123.67px;top:315.53px" class="cls_009"><span class="cls_009">getlocal</span></div>
<div style="position:absolute;left:199.76px;top:315.78px" class="cls_009"><span class="cls_009">5</span></div>
<div style="position:absolute;left:331.19px;top:315.53px" class="cls_009"><span class="cls_009">[ 2] c&lt;Post></span></div>
<div style="position:absolute;left:123.67px;top:326.84px" class="cls_009"><span class="cls_009">getlocal</span></div>
<div style="position:absolute;left:199.76px;top:327.10px" class="cls_009"><span class="cls_009">4</span></div>
<div style="position:absolute;left:331.19px;top:326.84px" class="cls_009"><span class="cls_009">[ 3] args&lt;Rest></span></div>
<div style="position:absolute;left:123.67px;top:338.16px" class="cls_009"><span class="cls_009">opt_plus</span></div>
<div style="position:absolute;left:199.76px;top:338.42px" class="cls_009"><span class="cls_009">&lt;callinfo!mid:+...</span></div>
<div style="position:absolute;left:331.19px;top:338.16px" class="cls_009"><span class="cls_009">[ 4] b&lt;Arg></span></div>
<div style="position:absolute;left:123.67px;top:349.48px" class="cls_009"><span class="cls_009">getlocal</span></div>
<div style="position:absolute;left:199.76px;top:349.73px" class="cls_009"><span class="cls_009">3</span></div>
<div style="position:absolute;left:331.19px;top:349.48px" class="cls_009"><span class="cls_009">[ 5] a&lt;Arg></span></div>
<div style="position:absolute;left:123.67px;top:360.80px" class="cls_009"><span class="cls_009">opt_size</span></div>
<div style="position:absolute;left:199.76px;top:361.05px" class="cls_009"><span class="cls_009">&lt;callinfo!mid:size...</span></div>
<div style="position:absolute;left:123.67px;top:372.11px" class="cls_009"><span class="cls_009">opt_plus</span></div>
<div style="position:absolute;left:199.76px;top:372.37px" class="cls_009"><span class="cls_009">&lt;callinfo!mid:+...</span></div>
<div style="position:absolute;left:123.67px;top:383.43px" class="cls_009"><span class="cls_009">getlocal</span></div>
<div style="position:absolute;left:199.76px;top:383.69px" class="cls_009"><span class="cls_009">2</span></div>
<div style="position:absolute;left:123.67px;top:394.75px" class="cls_009"><span class="cls_009">opt_plus</span></div>
<div style="position:absolute;left:199.76px;top:395.00px" class="cls_009"><span class="cls_009">&lt;callinfo!mid:+...</span></div>
<div style="position:absolute;left:120.00px;top:427.72px" class="cls_038"><span class="cls_038">Figure 2-17: Ruby saves information about special arguments in the local table.</span></div>
<div style="position:absolute;left:120.00px;top:463.22px" class="cls_055"><span class="cls_055">Compiling Optional Arguments</span></div>
<div style="position:absolute;left:120.00px;top:481.22px" class="cls_007"><span class="cls_007">As you probably know, you can make an argument optional by specifying</span></div>
<div style="position:absolute;left:120.00px;top:493.22px" class="cls_007"><span class="cls_007">a default value for it in the argument list. Later, Ruby will use the default</span></div>
<div style="position:absolute;left:120.00px;top:505.22px" class="cls_007"><span class="cls_007">value if you don’t provide a value for that argument when you call the</span></div>
<div style="position:absolute;left:120.00px;top:517.22px" class="cls_007"><span class="cls_007">method or block. Listing 2-13 shows a simple example.</span></div>
<div style="position:absolute;left:120.00px;top:541.22px" class="cls_030"><span class="cls_030">def add_two_optional(a, b = 5)</span></div>
<div style="position:absolute;left:128.50px;top:551.72px" class="cls_030"><span class="cls_030">sum = a+b</span></div>
<div style="position:absolute;left:120.00px;top:562.21px" class="cls_030"><span class="cls_030">end</span></div>
<div style="position:absolute;left:120.00px;top:584.71px" class="cls_038"><span class="cls_038">Listing 2-13: A method that takes an optional argument</span></div>
<div style="position:absolute;left:48.00px;top:633.00px" class="cls_020"><span class="cls_020">48</span></div>
<div style="position:absolute;left:70.06px;top:636.00px" class="cls_021"><span class="cls_021">Chapter 2</span></div>
</div>
<div style="position:absolute;left:50%;margin-left:-252px;top:46644px;width:504px;height:666px;border-style:outset;overflow:hidden">
<div style="position:absolute;left:0px;top:0px">
<img src="e698b76e-46bd-11eb-8b25-0cc47a792c0a_id_e698b76e-46bd-11eb-8b25-0cc47a792c0a_files/background073.jpg" width=504 height=666></div>
<div style="position:absolute;left:141.00px;top:42.28px" class="cls_007"><span class="cls_007">If you provide a value for </span><span class="cls_030">b</span><span class="cls_007">, the method will use that value as follows:</span></div>
<div style="position:absolute;left:123.00px;top:66.28px" class="cls_030"><span class="cls_030">puts add_two_optional(2, 2)</span></div>
<div style="position:absolute;left:127.25px;top:76.78px" class="cls_030"><span class="cls_030">=> 4</span></div>
<div style="position:absolute;left:141.00px;top:99.28px" class="cls_007"><span class="cls_007">But if you don’t, Ruby will assign the default value of 5 to </span><span class="cls_030">b</span><span class="cls_007">:</span></div>
<div style="position:absolute;left:123.00px;top:123.28px" class="cls_030"><span class="cls_030">puts add_two_optional(2)</span></div>
<div style="position:absolute;left:127.25px;top:133.78px" class="cls_030"><span class="cls_030">=> 7</span></div>
<div style="position:absolute;left:141.00px;top:156.28px" class="cls_007"><span class="cls_007">Ruby has a bit more work to do in this situation. Where does the default</span></div>
<div style="position:absolute;left:123.00px;top:168.28px" class="cls_007"><span class="cls_007">value go? Where does the Ruby compiler put it? Figure 2-18 shows how Ruby</span></div>
<div style="position:absolute;left:123.00px;top:180.28px" class="cls_007"><span class="cls_007">generates a few extra YARV instructions during the compile process that set</span></div>
<div style="position:absolute;left:123.00px;top:192.28px" class="cls_007"><span class="cls_007">the default value.</span></div>
<div style="position:absolute;left:126.67px;top:219.73px" class="cls_063"><span class="cls_063">def add_two_optional (a, b = 5)</span></div>
<div style="position:absolute;left:136.17px;top:231.24px" class="cls_063"><span class="cls_063">sum = a+b</span></div>
<div style="position:absolute;left:126.67px;top:242.74px" class="cls_063"><span class="cls_063">end</span></div>
<div style="position:absolute;left:126.80px;top:285.37px" class="cls_067"><span class="cls_067">YARV instructions</span></div>
<div style="position:absolute;left:351.36px;top:283.94px" class="cls_067"><span class="cls_067">Local Table</span></div>
<div style="position:absolute;left:126.67px;top:310.31px" class="cls_069"><span class="cls_069">putobject</span></div>
<div style="position:absolute;left:202.76px;top:310.57px" class="cls_069"><span class="cls_069">5</span></div>
<div style="position:absolute;left:334.19px;top:310.31px" class="cls_009"><span class="cls_009">[ 2] sum</span></div>
<div style="position:absolute;left:126.67px;top:321.62px" class="cls_069"><span class="cls_069">setlocal</span></div>
<div style="position:absolute;left:202.76px;top:321.89px" class="cls_069"><span class="cls_069">3</span></div>
<div style="position:absolute;left:334.19px;top:321.62px" class="cls_009"><span class="cls_009">[ 3] b&lt;Opt=0></span></div>
<div style="position:absolute;left:126.67px;top:332.94px" class="cls_009"><span class="cls_009">getlocal</span></div>
<div style="position:absolute;left:202.76px;top:333.20px" class="cls_009"><span class="cls_009">4</span></div>
<div style="position:absolute;left:334.19px;top:332.94px" class="cls_009"><span class="cls_009">[ 4] a&lt;Arg></span></div>
<div style="position:absolute;left:126.67px;top:344.26px" class="cls_009"><span class="cls_009">getlocal</span></div>
<div style="position:absolute;left:202.76px;top:344.52px" class="cls_009"><span class="cls_009">3</span></div>
<div style="position:absolute;left:126.67px;top:355.58px" class="cls_009"><span class="cls_009">opt_plus</span></div>
<div style="position:absolute;left:202.76px;top:355.84px" class="cls_009"><span class="cls_009">&lt;callinfo!mid:+...</span></div>
<div style="position:absolute;left:126.67px;top:366.89px" class="cls_009"><span class="cls_009">dup</span></div>
<div style="position:absolute;left:126.67px;top:378.48px" class="cls_009"><span class="cls_009">setlocal</span></div>
<div style="position:absolute;left:202.76px;top:378.47px" class="cls_009"><span class="cls_009">2</span></div>
<div style="position:absolute;left:123.00px;top:413.50px" class="cls_038"><span class="cls_038">Figure 2-18: Ruby’s compiler generates extra code to handle optional arguments.</span></div>
<div style="position:absolute;left:141.00px;top:436.00px" class="cls_007"><span class="cls_007">Ruby’s compiler generates the bolded YARV instructions, </span><span class="cls_030">putobject</span><span class="cls_007"> and</span></div>
<div style="position:absolute;left:123.00px;top:448.00px" class="cls_030"><span class="cls_030">setlocal</span><span class="cls_007">, to set the value of </span><span class="cls_030">b</span><span class="cls_007"> to 5 when you call the method. (As we’ll see</span></div>
<div style="position:absolute;left:123.00px;top:460.00px" class="cls_007"><span class="cls_007">in Chapter 3, YARV will call these instructions if you don’t provide a value</span></div>
<div style="position:absolute;left:123.00px;top:472.00px" class="cls_007"><span class="cls_007">for </span><span class="cls_030">b</span><span class="cls_007"> but skip them if you do.) You can also see that Ruby lists the optional</span></div>
<div style="position:absolute;left:123.00px;top:484.00px" class="cls_007"><span class="cls_007">argument </span><span class="cls_030">b</span><span class="cls_007"> in the local table as </span><span class="cls_030">b&lt;Opt=0></span><span class="cls_007">. The </span><span class="cls_030">0</span><span class="cls_007"> here refers to YARV instruc-</span></div>
<div style="position:absolute;left:123.00px;top:496.00px" class="cls_007"><span class="cls_007">tions that set the default value.</span></div>
<div style="position:absolute;left:123.00px;top:521.00px" class="cls_055"><span class="cls_055">Compiling Keyword Arguments</span></div>
<div style="position:absolute;left:123.00px;top:539.00px" class="cls_007"><span class="cls_007">In Ruby 2.x, we can specify a name along with a default value for each</span></div>
<div style="position:absolute;left:123.00px;top:551.00px" class="cls_007"><span class="cls_007">method or block argument. Arguments written this way are known as</span></div>
<div style="position:absolute;left:123.00px;top:563.00px" class="cls_008"><span class="cls_008">keyword arguments</span><span class="cls_007">. For example, Listing 2-14 shows the same argument </span><span class="cls_030">b</span></div>
<div style="position:absolute;left:123.00px;top:575.00px" class="cls_007"><span class="cls_007">declared using Ruby 2.0’s new keyword argument syntax.</span></div>
<div style="position:absolute;left:401.89px;top:636.00px" class="cls_021"><span class="cls_021">Compilation</span></div>
<div style="position:absolute;left:447.17px;top:633.00px" class="cls_020"><span class="cls_020">49</span></div>
</div>
<div style="position:absolute;left:50%;margin-left:-252px;top:47320px;width:504px;height:666px;border-style:outset;overflow:hidden">
<div style="position:absolute;left:0px;top:0px">
<img src="e698b76e-46bd-11eb-8b25-0cc47a792c0a_id_e698b76e-46bd-11eb-8b25-0cc47a792c0a_files/background074.jpg" width=504 height=666></div>
<div style="position:absolute;left:120.00px;top:49.00px" class="cls_030"><span class="cls_030">def add_two_keyword(a, b: 5)</span></div>
<div style="position:absolute;left:128.50px;top:59.50px" class="cls_030"><span class="cls_030">sum = a+b</span></div>
<div style="position:absolute;left:120.00px;top:70.00px" class="cls_030"><span class="cls_030">end</span></div>
<div style="position:absolute;left:120.00px;top:92.49px" class="cls_038"><span class="cls_038">Listing 2-14: A method that takes a keyword argument</span></div>
<div style="position:absolute;left:138.00px;top:115.00px" class="cls_007"><span class="cls_007">Now to provide a value for </span><span class="cls_030">b</span><span class="cls_007">, I need to use its name:</span></div>
<div style="position:absolute;left:120.00px;top:139.00px" class="cls_030"><span class="cls_030">puts add_two_keyword(2, b: 2)</span></div>
<div style="position:absolute;left:124.25px;top:149.50px" class="cls_030"><span class="cls_030">=> 4</span></div>
<div style="position:absolute;left:138.00px;top:172.00px" class="cls_007"><span class="cls_007">Or, if I don’t specify </span><span class="cls_030">b</span><span class="cls_007"> at all, Ruby will use the default value:</span></div>
<div style="position:absolute;left:120.00px;top:196.00px" class="cls_030"><span class="cls_030">puts add_two_keyword(2)</span></div>
<div style="position:absolute;left:124.25px;top:206.50px" class="cls_030"><span class="cls_030">=> 7</span></div>
<div style="position:absolute;left:138.00px;top:229.00px" class="cls_007"><span class="cls_007">How does Ruby compile keyword arguments? Figure 2-19 shows Ruby</span></div>
<div style="position:absolute;left:120.00px;top:241.00px" class="cls_007"><span class="cls_007">needs to add quite a bit of additional code to the method’s YARV snippet.</span></div>
<div style="position:absolute;left:123.67px;top:269.11px" class="cls_072"><span class="cls_072">def add_two_keyword (a, b: 5)</span></div>
<div style="position:absolute;left:133.17px;top:280.61px" class="cls_072"><span class="cls_072">sum = a+b</span></div>
<div style="position:absolute;left:123.67px;top:292.12px" class="cls_072"><span class="cls_072">end</span></div>
<div style="position:absolute;left:123.80px;top:332.65px" class="cls_067"><span class="cls_067">YARV instructions</span></div>
<div style="position:absolute;left:348.36px;top:331.37px" class="cls_067"><span class="cls_067">Local Table</span></div>
<div style="position:absolute;left:123.67px;top:355.35px" class="cls_074"><span class="cls_074">getlocal</span></div>
<div style="position:absolute;left:199.76px;top:355.83px" class="cls_074"><span class="cls_074">3</span></div>
<div style="position:absolute;left:331.19px;top:355.35px" class="cls_075"><span class="cls_075">[ 2] sum</span></div>
<div style="position:absolute;left:123.67px;top:365.62px" class="cls_074"><span class="cls_074">dup</span></div>
<div style="position:absolute;left:331.19px;top:365.62px" class="cls_075"><span class="cls_075">[ 3] ?</span></div>
<div style="position:absolute;left:123.67px;top:375.88px" class="cls_074"><span class="cls_074">putobject</span></div>
<div style="position:absolute;left:199.76px;top:376.37px" class="cls_074"><span class="cls_074">:b</span></div>
<div style="position:absolute;left:331.19px;top:375.88px" class="cls_075"><span class="cls_075">[ 4] b</span></div>
<div style="position:absolute;left:123.67px;top:386.15px" class="cls_074"><span class="cls_074">opt_send_simple</span></div>
<div style="position:absolute;left:199.76px;top:386.64px" class="cls_074"><span class="cls_074">&lt;callinfo!mid:key?...</span></div>
<div style="position:absolute;left:331.19px;top:386.15px" class="cls_075"><span class="cls_075">[ 5] a&lt;Arg></span></div>
<div style="position:absolute;left:123.67px;top:396.42px" class="cls_074"><span class="cls_074">branchunless</span></div>
<div style="position:absolute;left:199.76px;top:396.91px" class="cls_074"><span class="cls_074">18</span></div>
<div style="position:absolute;left:123.67px;top:406.69px" class="cls_074"><span class="cls_074">dup</span></div>
<div style="position:absolute;left:123.67px;top:416.96px" class="cls_074"><span class="cls_074">putobject</span></div>
<div style="position:absolute;left:199.76px;top:417.46px" class="cls_074"><span class="cls_074">:b</span></div>
<div style="position:absolute;left:123.67px;top:427.24px" class="cls_074"><span class="cls_074">opt_send_simple</span></div>
<div style="position:absolute;left:199.76px;top:427.72px" class="cls_074"><span class="cls_074">&lt;callinfo!mid:delete...</span></div>
<div style="position:absolute;left:123.67px;top:437.50px" class="cls_074"><span class="cls_074">setlocal</span></div>
<div style="position:absolute;left:199.76px;top:437.99px" class="cls_074"><span class="cls_074">4</span></div>
<div style="position:absolute;left:123.67px;top:447.78px" class="cls_074"><span class="cls_074">jump</span></div>
<div style="position:absolute;left:199.76px;top:448.26px" class="cls_074"><span class="cls_074">22</span></div>
<div style="position:absolute;left:123.67px;top:458.05px" class="cls_074"><span class="cls_074">putobject</span></div>
<div style="position:absolute;left:199.76px;top:458.53px" class="cls_074"><span class="cls_074">5</span></div>
<div style="position:absolute;left:123.67px;top:468.31px" class="cls_074"><span class="cls_074">setlocal</span></div>
<div style="position:absolute;left:199.76px;top:468.80px" class="cls_074"><span class="cls_074">4</span></div>
<div style="position:absolute;left:123.67px;top:478.59px" class="cls_074"><span class="cls_074">pop</span></div>
<div style="position:absolute;left:123.67px;top:488.86px" class="cls_075"><span class="cls_075">getlocal</span></div>
<div style="position:absolute;left:199.76px;top:489.34px" class="cls_075"><span class="cls_075">5</span></div>
<div style="position:absolute;left:123.67px;top:499.13px" class="cls_075"><span class="cls_075">getlocal</span></div>
<div style="position:absolute;left:199.76px;top:499.62px" class="cls_075"><span class="cls_075">4</span></div>
<div style="position:absolute;left:123.67px;top:509.40px" class="cls_075"><span class="cls_075">opt_plus</span></div>
<div style="position:absolute;left:199.76px;top:509.89px" class="cls_075"><span class="cls_075">&lt;callinfo!mid:+...</span></div>
<div style="position:absolute;left:123.67px;top:519.67px" class="cls_075"><span class="cls_075">dup</span></div>
<div style="position:absolute;left:123.67px;top:529.94px" class="cls_075"><span class="cls_075">setlocal</span></div>
<div style="position:absolute;left:199.76px;top:530.43px" class="cls_075"><span class="cls_075">2</span></div>
<div style="position:absolute;left:120.00px;top:553.46px" class="cls_038"><span class="cls_038">Figure 2-19: The Ruby compiler generates many more instructions to handle</span></div>
<div style="position:absolute;left:120.00px;top:563.96px" class="cls_038"><span class="cls_038">keyword arguments.</span></div>
<div style="position:absolute;left:48.00px;top:633.00px" class="cls_020"><span class="cls_020">50</span></div>
<div style="position:absolute;left:69.98px;top:636.00px" class="cls_021"><span class="cls_021">Chapter 2</span></div>
</div>
<div style="position:absolute;left:50%;margin-left:-252px;top:47996px;width:504px;height:666px;border-style:outset;overflow:hidden">
<div style="position:absolute;left:0px;top:0px">
<img src="e698b76e-46bd-11eb-8b25-0cc47a792c0a_id_e698b76e-46bd-11eb-8b25-0cc47a792c0a_files/background075.jpg" width=504 height=666></div>
<div style="position:absolute;left:141.00px;top:42.28px" class="cls_007"><span class="cls_007">The Ruby compiler generates all of the YARV instructions in bold—</span></div>
<div style="position:absolute;left:123.00px;top:54.28px" class="cls_007"><span class="cls_007">13 new instructions—to implement the keyword argument </span><span class="cls_030">b</span><span class="cls_007">. In Chapters 3</span></div>
<div style="position:absolute;left:123.00px;top:66.28px" class="cls_007"><span class="cls_007">and 4, I’ll cover how YARV works in detail and what these instructions actu-</span></div>
<div style="position:absolute;left:123.00px;top:78.28px" class="cls_007"><span class="cls_007">ally mean, but for now, we can guess what’s going on here:</span></div>
<div style="position:absolute;left:123.00px;top:99.28px" class="cls_050"><span class="cls_050">•</span><span class="cls_007">   In the local table, we can see a new mystery value shown as </span><span class="cls_030">[ 3]?</span><span class="cls_007">.</span></div>
<div style="position:absolute;left:123.00px;top:114.28px" class="cls_050"><span class="cls_050">•</span><span class="cls_007">   To the left of Figure 2-19, new YARV instructions call the </span><span class="cls_030">key?</span><span class="cls_007"> and</span></div>
<div style="position:absolute;left:141.00px;top:126.28px" class="cls_030"><span class="cls_030">delete</span><span class="cls_007"> methods.</span></div>
<div style="position:absolute;left:141.00px;top:147.28px" class="cls_007"><span class="cls_007">Which Ruby class contains the </span><span class="cls_030">key?</span><span class="cls_007"> and </span><span class="cls_030">delete</span><span class="cls_007"> methods? The </span><span class="cls_030">Hash</span><span class="cls_007">.</span></div>
<div style="position:absolute;left:123.00px;top:159.28px" class="cls_007"><span class="cls_007">Figure 2-19 shows evidence that Ruby must implement keyword arguments</span></div>
<div style="position:absolute;left:123.00px;top:171.28px" class="cls_007"><span class="cls_007">using an internal, hidden hash object. All of these additional YARV instruc-</span></div>
<div style="position:absolute;left:123.00px;top:183.28px" class="cls_007"><span class="cls_007">tions automatically add some logic to my method that checks this hash for</span></div>
<div style="position:absolute;left:123.00px;top:195.28px" class="cls_007"><span class="cls_007">the argument </span><span class="cls_030">b</span><span class="cls_007">. If Ruby finds the value of </span><span class="cls_030">b</span><span class="cls_007"> in the hash, it uses it. If not, it</span></div>
<div style="position:absolute;left:123.00px;top:207.28px" class="cls_007"><span class="cls_007">uses the default value of 5. The mystery element </span><span class="cls_030">[3]?</span><span class="cls_007"> in the local table must</span></div>
<div style="position:absolute;left:123.00px;top:219.28px" class="cls_007"><span class="cls_007">be this hidden hash object.</span></div>
<div style="position:absolute;left:123.00px;top:253.28px" class="cls_031"><span class="cls_031">Experiment 2-2: Displaying the Local Table</span></div>
<div style="position:absolute;left:123.00px;top:273.28px" class="cls_007"><span class="cls_007">Along with YARV instructions, </span><span class="cls_030">RubyVM::InstructionSequence</span><span class="cls_007"> will also dis-</span></div>
<div style="position:absolute;left:123.01px;top:285.28px" class="cls_007"><span class="cls_007">play the local table associated with each YARV snippet or scope. Finding</span></div>
<div style="position:absolute;left:123.01px;top:297.28px" class="cls_007"><span class="cls_007">and understanding the local table for your code will help you to under-</span></div>
<div style="position:absolute;left:123.01px;top:309.28px" class="cls_007"><span class="cls_007">stand what the corresponding YARV instructions do. In this experiment,</span></div>
<div style="position:absolute;left:123.01px;top:321.28px" class="cls_007"><span class="cls_007">we’ll look at where the local table appears in the output generated by the</span></div>
<div style="position:absolute;left:123.00px;top:333.28px" class="cls_030"><span class="cls_030">RubyVM::InstructionSequence</span><span class="cls_007"> object.</span></div>
<div style="position:absolute;left:141.00px;top:345.28px" class="cls_007"><span class="cls_007">Listing 2-15 repeats Listing 2-10 from Experiment 2-1.</span></div>
<div style="position:absolute;left:123.00px;top:369.28px" class="cls_030"><span class="cls_030">code = &lt;&lt;END</span></div>
<div style="position:absolute;left:123.00px;top:379.78px" class="cls_030"><span class="cls_030">10.times do |n|</span></div>
<div style="position:absolute;left:131.50px;top:390.27px" class="cls_030"><span class="cls_030">puts n</span></div>
<div style="position:absolute;left:123.00px;top:400.77px" class="cls_030"><span class="cls_030">end</span></div>
<div style="position:absolute;left:123.00px;top:411.27px" class="cls_030"><span class="cls_030">END</span></div>
<div style="position:absolute;left:123.00px;top:432.27px" class="cls_030"><span class="cls_030">puts RubyVM::InstructionSequence.compile(code).disasm</span></div>
<div style="position:absolute;left:123.00px;top:454.77px" class="cls_038"><span class="cls_038">Listing 2-15: Displaying the YARV instructions for a call to a block</span></div>
<div style="position:absolute;left:141.00px;top:477.28px" class="cls_007"><span class="cls_007">And Listing 2-16 repeats the output we saw earlier in Experiment 2-1.</span></div>
<div style="position:absolute;left:123.00px;top:501.28px" class="cls_030"><span class="cls_030">==</span></div>
<div style="position:absolute;left:135.75px;top:501.28px" class="cls_030"><span class="cls_030">disasm: &lt;RubyVM::InstructionSequence:&lt;compiled>@&lt;compiled>>==========</span></div>
<div style="position:absolute;left:123.00px;top:511.78px" class="cls_030"><span class="cls_030">==</span></div>
<div style="position:absolute;left:135.75px;top:511.78px" class="cls_030"><span class="cls_030">catch table</span></div>
<div style="position:absolute;left:123.00px;top:522.28px" class="cls_030"><span class="cls_030">| catch type: break  st: 0002 ed: 0006 sp: 0000 cont: 0006</span></div>
<div style="position:absolute;left:123.00px;top:532.77px" class="cls_030"><span class="cls_030">|------------------------------------------------------------------------</span></div>
<div style="position:absolute;left:123.00px;top:543.27px" class="cls_030"><span class="cls_030">0000 trace</span></div>
<div style="position:absolute;left:216.50px;top:543.27px" class="cls_030"><span class="cls_030">1</span></div>
<div style="position:absolute;left:420.50px;top:543.27px" class="cls_030"><span class="cls_030">(</span></div>
<div style="position:absolute;left:437.50px;top:543.27px" class="cls_030"><span class="cls_030">1)</span></div>
<div style="position:absolute;left:123.00px;top:553.77px" class="cls_030"><span class="cls_030">0002 putobject</span></div>
<div style="position:absolute;left:216.50px;top:553.77px" class="cls_030"><span class="cls_030">10</span></div>
<div style="position:absolute;left:123.00px;top:564.27px" class="cls_030"><span class="cls_030">0004 send</span></div>
<div style="position:absolute;left:216.50px;top:564.27px" class="cls_030"><span class="cls_030">&lt;callinfo!mid:times, argc:0, block:block in &lt;compiled>></span></div>
<div style="position:absolute;left:123.00px;top:574.76px" class="cls_030"><span class="cls_030">0006 leave</span></div>
<div style="position:absolute;left:123.00px;top:585.26px" class="cls_030"><span class="cls_030">==</span></div>
<div style="position:absolute;left:135.75px;top:585.26px" class="cls_030"><span class="cls_030">disasm: &lt;RubyVM::InstructionSequence:block in &lt;compiled>@&lt;compiled>>=</span></div>
<div style="position:absolute;left:402.12px;top:636.00px" class="cls_021"><span class="cls_021">Compilation</span></div>
<div style="position:absolute;left:447.40px;top:633.00px" class="cls_020"><span class="cls_020">51</span></div>
</div>
<div style="position:absolute;left:50%;margin-left:-252px;top:48672px;width:504px;height:666px;border-style:outset;overflow:hidden">
<div style="position:absolute;left:0px;top:0px">
<img src="e698b76e-46bd-11eb-8b25-0cc47a792c0a_id_e698b76e-46bd-11eb-8b25-0cc47a792c0a_files/background076.jpg" width=504 height=666></div>
<div style="position:absolute;left:120.00px;top:42.24px" class="cls_030"><span class="cls_030">==</span></div>
<div style="position:absolute;left:132.75px;top:42.24px" class="cls_030"><span class="cls_030">catch table</span></div>
<div style="position:absolute;left:120.00px;top:52.74px" class="cls_030"><span class="cls_030">| catch type: redo   st: 0000 ed: 0011 sp: 0000 cont: 0000</span></div>
<div style="position:absolute;left:120.00px;top:63.23px" class="cls_030"><span class="cls_030">| catch type: next   st: 0000 ed: 0011 sp: 0000 cont: 0011</span></div>
<div style="position:absolute;left:120.00px;top:73.73px" class="cls_030"><span class="cls_030">|------------------------------------------------------------------------</span></div>
<div style="position:absolute;left:108.15px;top:84.23px" class="cls_046"><span class="cls_046">u</span><span class="cls_030"> local table (size: 2, argc: 1 [opts: 0, rest: -1, post: 0, block: -1] s3)</span></div>
<div style="position:absolute;left:108.15px;top:94.72px" class="cls_046"><span class="cls_046">v</span><span class="cls_030"> [ 2] n&lt;Arg></span></div>
<div style="position:absolute;left:120.00px;top:105.22px" class="cls_030"><span class="cls_030">0000 trace</span></div>
<div style="position:absolute;left:213.50px;top:105.22px" class="cls_030"><span class="cls_030">256</span></div>
<div style="position:absolute;left:417.50px;top:105.22px" class="cls_030"><span class="cls_030">(</span></div>
<div style="position:absolute;left:434.50px;top:105.22px" class="cls_030"><span class="cls_030">1)</span></div>
<div style="position:absolute;left:120.00px;top:115.72px" class="cls_030"><span class="cls_030">0002 trace</span></div>
<div style="position:absolute;left:213.50px;top:115.72px" class="cls_030"><span class="cls_030">1</span></div>
<div style="position:absolute;left:417.50px;top:115.72px" class="cls_030"><span class="cls_030">(</span></div>
<div style="position:absolute;left:434.50px;top:115.72px" class="cls_030"><span class="cls_030">2)</span></div>
<div style="position:absolute;left:120.00px;top:126.22px" class="cls_030"><span class="cls_030">0004 putself</span></div>
<div style="position:absolute;left:120.00px;top:136.71px" class="cls_030"><span class="cls_030">0005 getlocal_OP__WC__0 2</span></div>
<div style="position:absolute;left:120.00px;top:147.21px" class="cls_030"><span class="cls_030">0007 opt_send_simple</span></div>
<div style="position:absolute;left:213.50px;top:147.21px" class="cls_030"><span class="cls_030">&lt;callinfo!mid:puts, argc:1, FCALL|ARGS_SKIP></span></div>
<div style="position:absolute;left:120.00px;top:157.71px" class="cls_030"><span class="cls_030">0009 trace</span></div>
<div style="position:absolute;left:213.50px;top:157.71px" class="cls_030"><span class="cls_030">512</span></div>
<div style="position:absolute;left:417.50px;top:157.71px" class="cls_030"><span class="cls_030">(</span></div>
<div style="position:absolute;left:434.50px;top:157.71px" class="cls_030"><span class="cls_030">3)</span></div>
<div style="position:absolute;left:120.00px;top:168.21px" class="cls_030"><span class="cls_030">0011 leave</span></div>
<div style="position:absolute;left:417.50px;top:168.21px" class="cls_030"><span class="cls_030">(</span></div>
<div style="position:absolute;left:434.50px;top:168.21px" class="cls_030"><span class="cls_030">2)</span></div>
<div style="position:absolute;left:120.00px;top:190.71px" class="cls_038"><span class="cls_038">Listing 2-16: Along with the YARV instructions, </span><span class="cls_014">RubyVM::InstructionSequence</span><span class="cls_038"> displays the</span></div>
<div style="position:absolute;left:120.00px;top:201.24px" class="cls_038"><span class="cls_038">local table.</span></div>
<div style="position:absolute;left:138.00px;top:223.74px" class="cls_007"><span class="cls_007">Just above the YARV snippet for the inner scope—the block—we see</span></div>
<div style="position:absolute;left:120.00px;top:235.74px" class="cls_007"><span class="cls_007">information about its local table at </span><span class="cls_050">u</span><span class="cls_007">. This displays the total size of the</span></div>
<div style="position:absolute;left:120.00px;top:247.74px" class="cls_007"><span class="cls_007">table (</span><span class="cls_030">size: 2</span><span class="cls_007">), the argument count (</span><span class="cls_030">argc: 1</span><span class="cls_007">), and other information about</span></div>
<div style="position:absolute;left:120.00px;top:259.74px" class="cls_007"><span class="cls_007">the types of parameters (</span><span class="cls_030">opts: 0, rest: -1, post: 0</span><span class="cls_007">).</span></div>
<div style="position:absolute;left:138.00px;top:271.74px" class="cls_007"><span class="cls_007">The second line </span><span class="cls_050">v</span><span class="cls_007"> shows the actual contents of the local table. In this</span></div>
<div style="position:absolute;left:120.00px;top:283.74px" class="cls_007"><span class="cls_007">example, we have just one argument, </span><span class="cls_030">n</span><span class="cls_007">.</span></div>
<div style="position:absolute;left:138.00px;top:295.74px" class="cls_007"><span class="cls_007">Listing 2-17 shows how to use </span><span class="cls_030">RubyVM::InstructionSequence</span><span class="cls_007"> in the same</span></div>
<div style="position:absolute;left:120.00px;top:307.74px" class="cls_007"><span class="cls_007">way to compile my unnamed arguments example from Listing 2-12.</span></div>
<div style="position:absolute;left:120.00px;top:331.74px" class="cls_030"><span class="cls_030">code = &lt;&lt;END</span></div>
<div style="position:absolute;left:120.00px;top:342.23px" class="cls_030"><span class="cls_030">def complex_formula(a, b, *args, c)</span></div>
<div style="position:absolute;left:128.50px;top:352.73px" class="cls_030"><span class="cls_030">a + b + args.size + c</span></div>
<div style="position:absolute;left:120.00px;top:363.23px" class="cls_030"><span class="cls_030">end</span></div>
<div style="position:absolute;left:120.00px;top:373.73px" class="cls_030"><span class="cls_030">END</span></div>
<div style="position:absolute;left:120.00px;top:394.73px" class="cls_030"><span class="cls_030">puts RubyVM::InstructionSequence.compile(code).disasm</span></div>
<div style="position:absolute;left:120.00px;top:417.23px" class="cls_038"><span class="cls_038">Listing 2-17: This method uses unnamed arguments with a splat operator.</span></div>
<div style="position:absolute;left:138.00px;top:439.74px" class="cls_007"><span class="cls_007">And Listing 2-18 shows the output.</span></div>
<div style="position:absolute;left:108.15px;top:463.74px" class="cls_046"><span class="cls_046">u</span><span class="cls_030"> == disasm: &lt;RubyVM::InstructionSequence:&lt;compiled>@&lt;compiled>>==========</span></div>
<div style="position:absolute;left:120.00px;top:474.23px" class="cls_030"><span class="cls_030">0000 trace</span></div>
<div style="position:absolute;left:213.50px;top:474.23px" class="cls_030"><span class="cls_030">1</span></div>
<div style="position:absolute;left:417.50px;top:474.23px" class="cls_030"><span class="cls_030">(</span></div>
<div style="position:absolute;left:434.50px;top:474.23px" class="cls_030"><span class="cls_030">1)</span></div>
<div style="position:absolute;left:120.00px;top:484.73px" class="cls_030"><span class="cls_030">0002 putspecialobject 1</span></div>
<div style="position:absolute;left:120.00px;top:495.23px" class="cls_030"><span class="cls_030">0004 putspecialobject 2</span></div>
<div style="position:absolute;left:120.00px;top:505.73px" class="cls_030"><span class="cls_030">0006 putobject</span></div>
<div style="position:absolute;left:213.50px;top:505.73px" class="cls_030"><span class="cls_030">:complex_formula</span></div>
<div style="position:absolute;left:120.00px;top:516.22px" class="cls_030"><span class="cls_030">0008 putiseq</span></div>
<div style="position:absolute;left:213.50px;top:516.22px" class="cls_030"><span class="cls_030">complex_formula</span></div>
<div style="position:absolute;left:108.15px;top:526.72px" class="cls_046"><span class="cls_046">v</span><span class="cls_030"> 0010 opt_send_simple</span></div>
<div style="position:absolute;left:213.48px;top:526.72px" class="cls_030"><span class="cls_030">&lt;callinfo!mid:core#define_method, argc:3, ARGS_SKIP></span></div>
<div style="position:absolute;left:120.00px;top:537.22px" class="cls_030"><span class="cls_030">0012 leave</span></div>
<div style="position:absolute;left:120.00px;top:547.72px" class="cls_030"><span class="cls_030">==</span></div>
<div style="position:absolute;left:132.75px;top:547.72px" class="cls_030"><span class="cls_030">disasm: &lt;RubyVM::InstructionSequence:complex_formula@&lt;compiled>>=====</span></div>
<div style="position:absolute;left:108.15px;top:558.22px" class="cls_046"><span class="cls_046">w</span><span class="cls_030"> local table (size: 5, argc: 2 [opts: 0, rest: 2, post: 1, block: -1] s0)</span></div>
<div style="position:absolute;left:108.15px;top:568.71px" class="cls_046"><span class="cls_046">x</span><span class="cls_030"> [ 5] a&lt;Arg></span></div>
<div style="position:absolute;left:187.98px;top:568.71px" class="cls_030"><span class="cls_030">[ 4] b&lt;Arg></span></div>
<div style="position:absolute;left:255.98px;top:568.71px" class="cls_030"><span class="cls_030">[ 3] args&lt;Rest> [ 2] c&lt;Post></span></div>
<div style="position:absolute;left:120.00px;top:579.21px" class="cls_030"><span class="cls_030">0000 trace</span></div>
<div style="position:absolute;left:213.50px;top:579.21px" class="cls_030"><span class="cls_030">8</span></div>
<div style="position:absolute;left:417.50px;top:579.21px" class="cls_030"><span class="cls_030">(</span></div>
<div style="position:absolute;left:434.50px;top:579.21px" class="cls_030"><span class="cls_030">1)</span></div>
<div style="position:absolute;left:120.00px;top:589.71px" class="cls_030"><span class="cls_030">0002 trace</span></div>
<div style="position:absolute;left:213.50px;top:589.71px" class="cls_030"><span class="cls_030">1</span></div>
<div style="position:absolute;left:417.50px;top:589.71px" class="cls_030"><span class="cls_030">(</span></div>
<div style="position:absolute;left:434.50px;top:589.71px" class="cls_030"><span class="cls_030">2)</span></div>
<div style="position:absolute;left:48.00px;top:633.00px" class="cls_020"><span class="cls_020">52</span></div>
<div style="position:absolute;left:69.81px;top:636.00px" class="cls_021"><span class="cls_021">Chapter 2</span></div>
</div>
<div style="position:absolute;left:50%;margin-left:-252px;top:49348px;width:504px;height:666px;border-style:outset;overflow:hidden">
<div style="position:absolute;left:0px;top:0px">
<img src="e698b76e-46bd-11eb-8b25-0cc47a792c0a_id_e698b76e-46bd-11eb-8b25-0cc47a792c0a_files/background077.jpg" width=504 height=666></div>
<div style="position:absolute;left:123.00px;top:42.82px" class="cls_030"><span class="cls_030">0004 getlocal_OP__WC__0 5</span></div>
<div style="position:absolute;left:123.00px;top:53.31px" class="cls_030"><span class="cls_030">0006 getlocal_OP__WC__0 4</span></div>
<div style="position:absolute;left:123.00px;top:63.81px" class="cls_030"><span class="cls_030">0008 opt_plus</span></div>
<div style="position:absolute;left:216.50px;top:63.81px" class="cls_030"><span class="cls_030">&lt;callinfo!mid:+, argc:1, ARGS_SKIP></span></div>
<div style="position:absolute;left:123.00px;top:74.31px" class="cls_030"><span class="cls_030">0010 getlocal_OP__WC__0 3</span></div>
<div style="position:absolute;left:123.00px;top:84.81px" class="cls_030"><span class="cls_030">0012 opt_size</span></div>
<div style="position:absolute;left:216.50px;top:84.81px" class="cls_030"><span class="cls_030">&lt;callinfo!mid:size, argc:0, ARGS_SKIP></span></div>
<div style="position:absolute;left:123.00px;top:95.30px" class="cls_030"><span class="cls_030">0014 opt_plus</span></div>
<div style="position:absolute;left:216.50px;top:95.30px" class="cls_030"><span class="cls_030">&lt;callinfo!mid:+, argc:1, ARGS_SKIP></span></div>
<div style="position:absolute;left:123.00px;top:105.80px" class="cls_030"><span class="cls_030">0016 getlocal_OP__WC__0 2</span></div>
<div style="position:absolute;left:123.00px;top:116.30px" class="cls_030"><span class="cls_030">0018 opt_plus</span></div>
<div style="position:absolute;left:216.50px;top:116.30px" class="cls_030"><span class="cls_030">&lt;callinfo!mid:+, argc:1, ARGS_SKIP></span></div>
<div style="position:absolute;left:123.00px;top:126.80px" class="cls_030"><span class="cls_030">0020 trace</span></div>
<div style="position:absolute;left:216.50px;top:126.80px" class="cls_030"><span class="cls_030">16</span></div>
<div style="position:absolute;left:420.50px;top:126.80px" class="cls_030"><span class="cls_030">(</span></div>
<div style="position:absolute;left:437.50px;top:126.80px" class="cls_030"><span class="cls_030">3)</span></div>
<div style="position:absolute;left:123.00px;top:137.29px" class="cls_030"><span class="cls_030">0022 leave</span></div>
<div style="position:absolute;left:420.50px;top:137.29px" class="cls_030"><span class="cls_030">(</span></div>
<div style="position:absolute;left:437.50px;top:137.29px" class="cls_030"><span class="cls_030">2)</span></div>
<div style="position:absolute;left:123.00px;top:159.79px" class="cls_038"><span class="cls_038">Listing 2-18: Displaying the YARV instructions for a call to a block</span></div>
<div style="position:absolute;left:141.00px;top:182.32px" class="cls_007"><span class="cls_007">The top YARV scope, around </span><span class="cls_050">u</span><span class="cls_007">, shows the instructions YARV uses to</span></div>
<div style="position:absolute;left:123.00px;top:194.32px" class="cls_007"><span class="cls_007">define a new method. Notice the call to </span><span class="cls_030">core#define_method</span><span class="cls_007"> at </span><span class="cls_050">v</span><span class="cls_007">, an internal</span></div>
<div style="position:absolute;left:123.00px;top:206.32px" class="cls_007"><span class="cls_007">C function that YARV uses to create new Ruby methods. This corresponds</span></div>
<div style="position:absolute;left:123.00px;top:218.32px" class="cls_007"><span class="cls_007">to calling </span><span class="cls_030">def complex_formula</span><span class="cls_007"> in my script. (I’ll discuss how Ruby implements</span></div>
<div style="position:absolute;left:123.00px;top:230.32px" class="cls_007"><span class="cls_007">methods in more detail in Chapters 5, 6, and 9.)</span></div>
<div style="position:absolute;left:141.00px;top:242.32px" class="cls_007"><span class="cls_007">Notice the local table for the lower YARV snippet at </span><span class="cls_050">w</span><span class="cls_007">. This line now</span></div>
<div style="position:absolute;left:123.00px;top:254.32px" class="cls_007"><span class="cls_007">shows more information about the unnamed arguments (</span><span class="cls_030">rest: 2</span><span class="cls_007">) and the</span></div>
<div style="position:absolute;left:123.00px;top:266.32px" class="cls_007"><span class="cls_007">last standard argument following them (</span><span class="cls_030">post: 1</span><span class="cls_007">). Finally, the line at </span><span class="cls_050">x</span></div>
<div style="position:absolute;left:123.00px;top:278.32px" class="cls_007"><span class="cls_007">shows the contents of the local table that I showed back in Figure 2-17.</span></div>
<div style="position:absolute;left:69.00px;top:312.32px" class="cls_031"><span class="cls_031">Summary</span></div>
<div style="position:absolute;left:123.00px;top:332.32px" class="cls_007"><span class="cls_007">In this chapter, we learned how Ruby compiles our code. You may think of</span></div>
<div style="position:absolute;left:123.00px;top:344.32px" class="cls_007"><span class="cls_007">Ruby as a dynamic scripting language, but, in fact, it uses a compiler just</span></div>
<div style="position:absolute;left:123.00px;top:356.32px" class="cls_007"><span class="cls_007">like C, Java, and many other programming languages. The obvious dif-</span></div>
<div style="position:absolute;left:123.00px;top:368.32px" class="cls_007"><span class="cls_007">ference is that Ruby’s compiler runs automatically behind the scenes; you</span></div>
<div style="position:absolute;left:123.00px;top:380.32px" class="cls_007"><span class="cls_007">never need to worry about compiling your Ruby code.</span></div>
<div style="position:absolute;left:141.00px;top:392.32px" class="cls_007"><span class="cls_007">We’ve learned that Ruby’s compiler works by iterating through the AST</span></div>
<div style="position:absolute;left:123.00px;top:404.32px" class="cls_007"><span class="cls_007">produced by the tokenizing and parsing processes, generating a series of</span></div>
<div style="position:absolute;left:123.00px;top:416.32px" class="cls_007"><span class="cls_007">bytecode instructions along the way. Ruby translates your code from Ruby</span></div>
<div style="position:absolute;left:123.00px;top:428.32px" class="cls_007"><span class="cls_007">into a language tailored for the YARV virtual machine, and it compiles</span></div>
<div style="position:absolute;left:123.00px;top:440.32px" class="cls_007"><span class="cls_007">every scope or section of your Ruby program into a different snippet or set</span></div>
<div style="position:absolute;left:123.00px;top:452.32px" class="cls_007"><span class="cls_007">of these YARV instructions. Every block, method, lambda, or other scope in</span></div>
<div style="position:absolute;left:123.00px;top:464.32px" class="cls_007"><span class="cls_007">your program has a corresponding set of bytecode instructions.</span></div>
<div style="position:absolute;left:141.00px;top:476.32px" class="cls_007"><span class="cls_007">We’ve also seen how Ruby handles different types of arguments. We</span></div>
<div style="position:absolute;left:123.00px;top:488.32px" class="cls_007"><span class="cls_007">were able to use the local table as a key or legend for understanding which</span></div>
<div style="position:absolute;left:123.00px;top:500.32px" class="cls_007"><span class="cls_007">YARV instructions accessed which arguments or local variables. And we</span></div>
<div style="position:absolute;left:123.00px;top:512.32px" class="cls_007"><span class="cls_007">saw how Ruby’s compiler generates additional, special YARV instructions</span></div>
<div style="position:absolute;left:123.00px;top:524.32px" class="cls_007"><span class="cls_007">to handle optional and keyword parameters.</span></div>
<div style="position:absolute;left:141.00px;top:536.32px" class="cls_007"><span class="cls_007">In Chapter 3, I’ll begin to explain how YARV executes the instructions</span></div>
<div style="position:absolute;left:123.00px;top:548.32px" class="cls_007"><span class="cls_007">produced by the compiler—that is, how YARV executes your Ruby program.</span></div>
<div style="position:absolute;left:401.71px;top:636.00px" class="cls_021"><span class="cls_021">Compilation</span></div>
<div style="position:absolute;left:446.99px;top:633.00px" class="cls_020"><span class="cls_020">53</span></div>
</div>
<div style="position:absolute;left:50%;margin-left:-252px;top:50024px;width:504px;height:666px;border-style:outset;overflow:hidden">
<div style="position:absolute;left:0px;top:0px">
<img src="e698b76e-46bd-11eb-8b25-0cc47a792c0a_id_e698b76e-46bd-11eb-8b25-0cc47a792c0a_files/background078.jpg" width=504 height=666></div>
<div style="position:absolute;left:246.35px;top:287.91px" class="cls_024"><span class="cls_024">YARV is not just a</span></div>
<div style="position:absolute;left:238.75px;top:305.92px" class="cls_024"><span class="cls_024">stack machine—it’s a</span></div>
<div style="position:absolute;left:237.12px;top:323.92px" class="cls_024"><span class="cls_024">double-stack machine!</span></div>
</div>
<div style="position:absolute;left:50%;margin-left:-252px;top:50700px;width:504px;height:666px;border-style:outset;overflow:hidden">
<div style="position:absolute;left:0px;top:0px">
<img src="e698b76e-46bd-11eb-8b25-0cc47a792c0a_id_e698b76e-46bd-11eb-8b25-0cc47a792c0a_files/background079.jpg" width=504 height=666></div>
<div style="position:absolute;left:260.10px;top:101.45px" class="cls_035"><span class="cls_035">3</span></div>
<div style="position:absolute;left:184.31px;top:253.45px" class="cls_016"><span class="cls_016">How Ruby Executes</span></div>
<div style="position:absolute;left:233.78px;top:271.45px" class="cls_016"><span class="cls_016">Your Code</span></div>
<div style="position:absolute;left:123.00px;top:387.45px" class="cls_023"><span class="cls_023">Now that Ruby has tokenized, parsed, and compiled</span></div>
<div style="position:absolute;left:123.00px;top:405.46px" class="cls_023"><span class="cls_023">your code, it’s finally ready to execute it. But just how</span></div>
<div style="position:absolute;left:123.00px;top:423.46px" class="cls_023"><span class="cls_023">does it do that? We’ve seen how the Ruby compiler</span></div>
<div style="position:absolute;left:123.00px;top:441.46px" class="cls_023"><span class="cls_023">creates YARV (Yet Another Ruby Virtual Machine)</span></div>
<div style="position:absolute;left:123.00px;top:459.47px" class="cls_023"><span class="cls_023">instructions, but how does YARV actually run them?</span></div>
<div style="position:absolute;left:123.00px;top:477.47px" class="cls_023"><span class="cls_023">How does it track variables and return values and</span></div>
<div style="position:absolute;left:123.00px;top:495.45px" class="cls_023"><span class="cls_023">arguments? How does it implement </span><span class="cls_028">if</span><span class="cls_023"> statements and</span></div>
<div style="position:absolute;left:123.00px;top:513.46px" class="cls_023"><span class="cls_023">other control structures?</span></div>
<div style="position:absolute;left:141.00px;top:532.45px" class="cls_007"><span class="cls_007">Koichi Sasada and the Ruby core team designed YARV to use a stack</span></div>
<div style="position:absolute;left:123.00px;top:544.45px" class="cls_007"><span class="cls_007">pointer and a program counter—that is, to function like your computer’s</span></div>
<div style="position:absolute;left:123.00px;top:556.45px" class="cls_007"><span class="cls_007">actual microprocessor. In this chapter, I’ll examine the basics of YARV</span></div>
<div style="position:absolute;left:123.00px;top:568.45px" class="cls_007"><span class="cls_007">instructions; namely, how they pop arguments off of and push return</span></div>
<div style="position:absolute;left:123.00px;top:580.45px" class="cls_007"><span class="cls_007">values onto an internal stack. We’ll also see how YARV keeps track of</span></div>
</div>
<div style="position:absolute;left:50%;margin-left:-252px;top:51376px;width:504px;height:666px;border-style:outset;overflow:hidden">
<div style="position:absolute;left:0px;top:0px">
<img src="e698b76e-46bd-11eb-8b25-0cc47a792c0a_id_e698b76e-46bd-11eb-8b25-0cc47a792c0a_files/background080.jpg" width=504 height=666></div>
<div style="position:absolute;left:120.00px;top:41.60px" class="cls_007"><span class="cls_007">your Ruby call stack along with its own internal stack. I’ll explain how</span></div>
<div style="position:absolute;left:120.00px;top:53.60px" class="cls_007"><span class="cls_007">Ruby accesses local variables and how it can find variables farther down</span></div>
<div style="position:absolute;left:120.00px;top:65.60px" class="cls_007"><span class="cls_007">your call stack using dynamic access. We’ll finish with a look at how Ruby</span></div>
<div style="position:absolute;left:120.00px;top:77.60px" class="cls_007"><span class="cls_007">implements special variables. In Chapter 4 I’ll continue the discussion</span></div>
<div style="position:absolute;left:120.00px;top:89.60px" class="cls_007"><span class="cls_007">of YARV by examining how it implements control structures and method</span></div>
<div style="position:absolute;left:120.00px;top:101.60px" class="cls_007"><span class="cls_007">dispatch.</span></div>
<div style="position:absolute;left:266.72px;top:148.31px" class="cls_020"><span class="cls_020">Roadmap</span></div>
<div style="position:absolute;left:132.00px;top:165.31px" class="cls_017"><span class="cls_017">YARV’s Internal Stack and Your Ruby Stack</span></div>
<div style="position:absolute;left:420.91px;top:165.31px" class="cls_017"><span class="cls_017">56</span></div>
<div style="position:absolute;left:150.00px;top:182.32px" class="cls_017"><span class="cls_017">Stepping Through How Ruby Executes a Simple Script</span></div>
<div style="position:absolute;left:420.91px;top:182.32px" class="cls_017"><span class="cls_017">58</span></div>
<div style="position:absolute;left:150.00px;top:199.32px" class="cls_017"><span class="cls_017">Executing a Call to a Block</span></div>
<div style="position:absolute;left:420.91px;top:199.32px" class="cls_017"><span class="cls_017">61</span></div>
<div style="position:absolute;left:150.00px;top:216.32px" class="cls_017"><span class="cls_017">Taking a Close Look at a YARV Instruction</span></div>
<div style="position:absolute;left:420.91px;top:216.32px" class="cls_017"><span class="cls_017">63</span></div>
<div style="position:absolute;left:132.00px;top:233.32px" class="cls_019"><span class="cls_019">Experiment 3-1: Benchmarking Ruby 2.0 and Ruby 1.9 vs. Ruby 1.8 .  .</span></div>
<div style="position:absolute;left:421.59px;top:233.32px" class="cls_019"><span class="cls_019">65</span></div>
<div style="position:absolute;left:132.00px;top:250.32px" class="cls_017"><span class="cls_017">Local and Dynamic Access of Ruby Variables</span></div>
<div style="position:absolute;left:420.91px;top:250.32px" class="cls_017"><span class="cls_017">67</span></div>
<div style="position:absolute;left:150.00px;top:267.32px" class="cls_017"><span class="cls_017">Local Variable Access</span></div>
<div style="position:absolute;left:420.91px;top:267.32px" class="cls_017"><span class="cls_017">67</span></div>
<div style="position:absolute;left:150.00px;top:284.32px" class="cls_017"><span class="cls_017">Method Arguments Are Treated Like Local Variables</span></div>
<div style="position:absolute;left:420.91px;top:284.32px" class="cls_017"><span class="cls_017">70</span></div>
<div style="position:absolute;left:150.00px;top:301.32px" class="cls_017"><span class="cls_017">Dynamic Variable Access</span></div>
<div style="position:absolute;left:420.91px;top:301.32px" class="cls_017"><span class="cls_017">71</span></div>
<div style="position:absolute;left:150.00px;top:318.32px" class="cls_017"><span class="cls_017">Climbing the Environment Pointer Ladder in C</span></div>
<div style="position:absolute;left:420.91px;top:318.32px" class="cls_017"><span class="cls_017">74</span></div>
<div style="position:absolute;left:132.00px;top:335.32px" class="cls_019"><span class="cls_019">Experiment 3-2: Exploring Special Variables</span></div>
<div style="position:absolute;left:421.59px;top:335.32px" class="cls_019"><span class="cls_019">75</span></div>
<div style="position:absolute;left:150.00px;top:352.33px" class="cls_017"><span class="cls_017">A Definitive List of Special Variables</span></div>
<div style="position:absolute;left:420.91px;top:352.33px" class="cls_017"><span class="cls_017">79</span></div>
<div style="position:absolute;left:132.00px;top:369.33px" class="cls_017"><span class="cls_017">Summary</span></div>
<div style="position:absolute;left:420.91px;top:369.33px" class="cls_017"><span class="cls_017">81</span></div>
<div style="position:absolute;left:66.00px;top:420.60px" class="cls_031"><span class="cls_031">YARV’s Internal Stack and Your Ruby Stack</span></div>
<div style="position:absolute;left:120.00px;top:440.60px" class="cls_007"><span class="cls_007">As we’ll see in a moment, YARV uses a stack internally to track intermedi-</span></div>
<div style="position:absolute;left:120.00px;top:452.60px" class="cls_007"><span class="cls_007">ate values, arguments, and return values. YARV is a stack-oriented virtual</span></div>
<div style="position:absolute;left:120.00px;top:464.60px" class="cls_007"><span class="cls_007">machine.</span></div>
<div style="position:absolute;left:138.00px;top:476.60px" class="cls_007"><span class="cls_007">In addition to its own internal stack, YARV keeps track of your Ruby</span></div>
<div style="position:absolute;left:120.00px;top:488.60px" class="cls_007"><span class="cls_007">program’s </span><span class="cls_008">call stack</span><span class="cls_007">, recording which methods call which other methods,</span></div>
<div style="position:absolute;left:120.00px;top:500.60px" class="cls_007"><span class="cls_007">functions, blocks, lambdas, and so on. In fact, YARV is not just a stack</span></div>
<div style="position:absolute;left:120.00px;top:512.60px" class="cls_007"><span class="cls_007">machine—it’s a double-stack machine! It has to track the arguments and</span></div>
<div style="position:absolute;left:120.00px;top:524.60px" class="cls_007"><span class="cls_007">return values not only for its own internal instructions but also for your</span></div>
<div style="position:absolute;left:120.00px;top:536.60px" class="cls_007"><span class="cls_007">Ruby program.</span></div>
<div style="position:absolute;left:138.00px;top:548.60px" class="cls_007"><span class="cls_007">Figure 3-1 shows YARV’s basic registers and internal stack.</span></div>
<div style="position:absolute;left:48.00px;top:633.00px" class="cls_020"><span class="cls_020">56</span></div>
<div style="position:absolute;left:69.98px;top:636.00px" class="cls_021"><span class="cls_021">Chapter 3</span></div>
</div>
<div style="position:absolute;left:50%;margin-left:-252px;top:52052px;width:504px;height:666px;border-style:outset;overflow:hidden">
<div style="position:absolute;left:0px;top:0px">
<img src="e698b76e-46bd-11eb-8b25-0cc47a792c0a_id_e698b76e-46bd-11eb-8b25-0cc47a792c0a_files/background081.jpg" width=504 height=666></div>
<div style="position:absolute;left:298.17px;top:44.02px" class="cls_054"><span class="cls_054">YARV instructions</span></div>
<div style="position:absolute;left:302.17px;top:60.35px" class="cls_014"><span class="cls_014">trace</span></div>
<div style="position:absolute;left:302.17px;top:69.46px" class="cls_014"><span class="cls_014">putself</span></div>
<div style="position:absolute;left:131.66px;top:80.02px" class="cls_054"><span class="cls_054">YARV</span></div>
<div style="position:absolute;left:192.72px;top:80.06px" class="cls_053"><span class="cls_053">rb_control_frame_t</span></div>
<div style="position:absolute;left:302.16px;top:78.57px" class="cls_014"><span class="cls_014">putobject</span></div>
<div style="position:absolute;left:366.41px;top:78.57px" class="cls_014"><span class="cls_014">2</span></div>
<div style="position:absolute;left:128.63px;top:89.62px" class="cls_054"><span class="cls_054">internal</span></div>
<div style="position:absolute;left:302.16px;top:87.68px" class="cls_014"><span class="cls_014">putobject</span></div>
<div style="position:absolute;left:366.41px;top:87.68px" class="cls_014"><span class="cls_014">2</span></div>
<div style="position:absolute;left:224.72px;top:97.67px" class="cls_014"><span class="cls_014">pc</span></div>
<div style="position:absolute;left:302.17px;top:96.79px" class="cls_014"><span class="cls_014">opt_plus</span></div>
<div style="position:absolute;left:132.85px;top:99.22px" class="cls_054"><span class="cls_054">stack</span></div>
<div style="position:absolute;left:302.17px;top:105.91px" class="cls_014"><span class="cls_014">opt_send_simple &lt;callinfo!mid:puts...</span></div>
<div style="position:absolute;left:276.21px;top:109.66px" class="cls_014"><span class="cls_014">PC</span></div>
<div style="position:absolute;left:224.72px;top:115.30px" class="cls_014"><span class="cls_014">sp</span></div>
<div style="position:absolute;left:302.17px;top:115.02px" class="cls_014"><span class="cls_014">leave</span></div>
<div style="position:absolute;left:172.25px;top:127.63px" class="cls_014"><span class="cls_014">SP</span></div>
<div style="position:absolute;left:139.50px;top:131.51px" class="cls_014"><span class="cls_014">2</span></div>
<div style="position:absolute;left:220.72px;top:132.93px" class="cls_014"><span class="cls_014">self</span></div>
<div style="position:absolute;left:139.50px;top:147.27px" class="cls_014"><span class="cls_014">2</span></div>
<div style="position:absolute;left:220.72px;top:150.56px" class="cls_014"><span class="cls_014">type</span></div>
<div style="position:absolute;left:133.50px;top:163.03px" class="cls_014"><span class="cls_014">self</span></div>
<div style="position:absolute;left:123.00px;top:184.79px" class="cls_038"><span class="cls_038">Figure 3-1: Some of YARV’s internal registers, including the program counter and stack</span></div>
<div style="position:absolute;left:123.00px;top:195.29px" class="cls_038"><span class="cls_038">pointer</span></div>
<div style="position:absolute;left:141.00px;top:217.79px" class="cls_007"><span class="cls_007">YARV’s internal stack is on the left.</span></div>
<div style="position:absolute;left:373.33px;top:224.80px" class="cls_053"><span class="cls_053">rb_control_frame_t</span></div>
<div style="position:absolute;left:123.00px;top:229.79px" class="cls_007"><span class="cls_007">The </span><span class="cls_030">SP</span><span class="cls_007"> label is the </span><span class="cls_008">stack pointer</span><span class="cls_007">, or the</span></div>
<div style="position:absolute;left:123.00px;top:241.79px" class="cls_007"><span class="cls_007">location of the top of the stack. On the</span></div>
<div style="position:absolute;left:393.33px;top:242.08px" class="cls_067"><span class="cls_067">[METHOD]</span></div>
<div style="position:absolute;left:339.13px;top:248.71px" class="cls_067"><span class="cls_067">CFP</span></div>
<div style="position:absolute;left:123.00px;top:253.79px" class="cls_007"><span class="cls_007">right are the instructions that YARV is</span></div>
<div style="position:absolute;left:123.00px;top:265.79px" class="cls_007"><span class="cls_007">executing. </span><span class="cls_030">PC</span><span class="cls_007"> is the </span><span class="cls_008">program counter</span><span class="cls_007">, or the</span></div>
<div style="position:absolute;left:373.33px;top:265.75px" class="cls_053"><span class="cls_053">rb_control_frame_t</span></div>
<div style="position:absolute;left:123.00px;top:277.79px" class="cls_007"><span class="cls_007">location of the current instruction.</span></div>
<div style="position:absolute;left:395.33px;top:283.02px" class="cls_067"><span class="cls_067">[BLOCK]</span></div>
<div style="position:absolute;left:141.00px;top:289.79px" class="cls_007"><span class="cls_007">You can see the YARV instructions</span></div>
<div style="position:absolute;left:123.00px;top:301.79px" class="cls_007"><span class="cls_007">that Ruby compiled from the </span><span class="cls_030">puts 2+2</span></div>
<div style="position:absolute;left:373.33px;top:306.69px" class="cls_053"><span class="cls_053">rb_control_frame_t</span></div>
<div style="position:absolute;left:123.00px;top:313.79px" class="cls_007"><span class="cls_007">example on the right side of Figure 3-1.</span></div>
<div style="position:absolute;left:393.33px;top:323.97px" class="cls_067"><span class="cls_067">[METHOD]</span></div>
<div style="position:absolute;left:123.00px;top:325.79px" class="cls_007"><span class="cls_007">YARV stores both the </span><span class="cls_030">SP</span><span class="cls_007"> and </span><span class="cls_030">PC</span><span class="cls_007"> registers</span></div>
<div style="position:absolute;left:123.00px;top:337.79px" class="cls_007"><span class="cls_007">in a C structure called </span><span class="cls_030">rb_control_frame_t</span><span class="cls_007">,</span></div>
<div style="position:absolute;left:373.33px;top:347.64px" class="cls_053"><span class="cls_053">rb_control_frame_t</span></div>
<div style="position:absolute;left:123.00px;top:349.79px" class="cls_007"><span class="cls_007">along with a </span><span class="cls_030">type</span><span class="cls_007"> field, the current value</span></div>
<div style="position:absolute;left:123.00px;top:361.79px" class="cls_007"><span class="cls_007">of Ruby’s </span><span class="cls_030">self</span><span class="cls_007"> variable, and some other</span></div>
<div style="position:absolute;left:397.33px;top:364.91px" class="cls_067"><span class="cls_067">[EVAL]</span></div>
<div style="position:absolute;left:123.00px;top:373.79px" class="cls_007"><span class="cls_007">values not shown here.</span></div>
<div style="position:absolute;left:141.00px;top:385.79px" class="cls_007"><span class="cls_007">At the same time, YARV maintains</span></div>
<div style="position:absolute;left:123.00px;top:397.79px" class="cls_007"><span class="cls_007">another stack of these </span><span class="cls_030">rb_control_frame_t</span></div>
<div style="position:absolute;left:400.69px;top:402.65px" class="cls_054"><span class="cls_054">etc...</span></div>
<div style="position:absolute;left:123.00px;top:409.79px" class="cls_007"><span class="cls_007">structures, as shown in Figure 3-2.</span></div>
<div style="position:absolute;left:141.00px;top:421.79px" class="cls_007"><span class="cls_007">This second stack of </span><span class="cls_030">rb_control_</span></div>
<div style="position:absolute;left:328.77px;top:424.55px" class="cls_038"><span class="cls_038">Figure 3-2: YARV keeps track of</span></div>
<div style="position:absolute;left:123.00px;top:433.79px" class="cls_030"><span class="cls_030">frame_t</span><span class="cls_007"> structures represents the path</span></div>
<div style="position:absolute;left:328.77px;top:435.05px" class="cls_038"><span class="cls_038">your Ruby call stack using a series</span></div>
<div style="position:absolute;left:123.00px;top:445.79px" class="cls_007"><span class="cls_007">that YARV has taken through your Ruby</span></div>
<div style="position:absolute;left:328.77px;top:445.55px" class="cls_038"><span class="cls_038">of </span><span class="cls_014">rb_control_frame_t</span><span class="cls_038"> structures.</span></div>
<div style="position:absolute;left:123.00px;top:457.79px" class="cls_007"><span class="cls_007">program, and YARV’s current location.</span></div>
<div style="position:absolute;left:123.00px;top:469.79px" class="cls_007"><span class="cls_007">In other words, this is your Ruby call</span></div>
<div style="position:absolute;left:123.00px;top:481.79px" class="cls_007"><span class="cls_007">stack—what you would see if you ran</span></div>
<div style="position:absolute;left:123.00px;top:493.79px" class="cls_030"><span class="cls_030">puts caller</span><span class="cls_007">.</span></div>
<div style="position:absolute;left:141.00px;top:505.79px" class="cls_007"><span class="cls_007">The </span><span class="cls_030">CFP</span><span class="cls_007"> pointer indicates the </span><span class="cls_008">control frame pointer</span><span class="cls_007">. Each stack frame in</span></div>
<div style="position:absolute;left:123.00px;top:517.79px" class="cls_007"><span class="cls_007">your Ruby program stack contains, in turn, a different value for the </span><span class="cls_030">self</span><span class="cls_007">, </span><span class="cls_030">PC</span><span class="cls_007">,</span></div>
<div style="position:absolute;left:123.00px;top:529.79px" class="cls_007"><span class="cls_007">and </span><span class="cls_030">SP</span><span class="cls_007"> registers, as shown in Figure 3-1. The </span><span class="cls_030">type</span><span class="cls_007"> field in each </span><span class="cls_030">rb_control_</span></div>
<div style="position:absolute;left:123.00px;top:541.79px" class="cls_030"><span class="cls_030">frame_t</span><span class="cls_007"> structure indicates the type of code running at this level in your</span></div>
<div style="position:absolute;left:123.00px;top:553.79px" class="cls_007"><span class="cls_007">Ruby call stack. As Ruby calls into the methods, blocks, or other structures</span></div>
<div style="position:absolute;left:123.00px;top:565.79px" class="cls_007"><span class="cls_007">in your program, the type might be set to </span><span class="cls_030">METHOD</span><span class="cls_007">, </span><span class="cls_030">BLOCK</span><span class="cls_007">, or one of a few other</span></div>
<div style="position:absolute;left:123.00px;top:577.79px" class="cls_007"><span class="cls_007">values.</span></div>
<div style="position:absolute;left:349.64px;top:636.00px" class="cls_021"><span class="cls_021">How Ruby Executes Your Code</span></div>
<div style="position:absolute;left:447.24px;top:633.00px" class="cls_020"><span class="cls_020">57</span></div>
</div>
<div style="position:absolute;left:50%;margin-left:-252px;top:52728px;width:504px;height:666px;border-style:outset;overflow:hidden">
<div style="position:absolute;left:0px;top:0px">
<img src="e698b76e-46bd-11eb-8b25-0cc47a792c0a_id_e698b76e-46bd-11eb-8b25-0cc47a792c0a_files/background082.jpg" width=504 height=666></div>
<div style="position:absolute;left:120.00px;top:42.05px" class="cls_055"><span class="cls_055">Stepping Through How Ruby Executes a Simple Script</span></div>
<div style="position:absolute;left:120.00px;top:60.05px" class="cls_007"><span class="cls_007">In order to help you understand this a bit better, here are a couple of</span></div>
<div style="position:absolute;left:120.00px;top:72.05px" class="cls_007"><span class="cls_007">examples. I’ll begin with the simple </span><span class="cls_030">2+2</span><span class="cls_007"> example from Chapters 1 and 2,</span></div>
<div style="position:absolute;left:120.00px;top:84.05px" class="cls_007"><span class="cls_007">shown again in Listing 3-1.</span></div>
<div style="position:absolute;left:120.00px;top:108.05px" class="cls_030"><span class="cls_030">puts 2+2</span></div>
<div style="position:absolute;left:120.00px;top:130.55px" class="cls_038"><span class="cls_038">Listing 3-1: A one-line Ruby program that we’ll execute as an example</span></div>
<div style="position:absolute;left:138.00px;top:153.05px" class="cls_007"><span class="cls_007">This one-line Ruby script doesn’t have a Ruby call stack, so I’ll focus on</span></div>
<div style="position:absolute;left:120.00px;top:165.05px" class="cls_007"><span class="cls_007">the internal YARV stack for now. Figure 3-3 shows how YARV will execute</span></div>
<div style="position:absolute;left:120.00px;top:177.05px" class="cls_007"><span class="cls_007">this script, beginning with the first instruction, </span><span class="cls_030">trace</span><span class="cls_007">.</span></div>
<div style="position:absolute;left:288.72px;top:201.82px" class="cls_014"><span class="cls_014">trace</span></div>
<div style="position:absolute;left:288.72px;top:210.88px" class="cls_014"><span class="cls_014">putself</span></div>
<div style="position:absolute;left:260.97px;top:214.92px" class="cls_014"><span class="cls_014">PC</span></div>
<div style="position:absolute;left:288.72px;top:219.94px" class="cls_014"><span class="cls_014">putobject</span></div>
<div style="position:absolute;left:358.17px;top:219.94px" class="cls_014"><span class="cls_014">2</span></div>
<div style="position:absolute;left:288.72px;top:229.01px" class="cls_014"><span class="cls_014">putobject</span></div>
<div style="position:absolute;left:358.17px;top:229.01px" class="cls_014"><span class="cls_014">2</span></div>
<div style="position:absolute;left:288.72px;top:238.07px" class="cls_014"><span class="cls_014">opt_plus</span></div>
<div style="position:absolute;left:288.72px;top:247.14px" class="cls_014"><span class="cls_014">opt_send_simple</span></div>
<div style="position:absolute;left:358.17px;top:247.14px" class="cls_014"><span class="cls_014">&lt;callinfo!mid:puts,</span></div>
<div style="position:absolute;left:358.17px;top:256.20px" class="cls_014"><span class="cls_014">argc:1...</span></div>
<div style="position:absolute;left:288.72px;top:265.26px" class="cls_014"><span class="cls_014">leave</span></div>
<div style="position:absolute;left:201.66px;top:282.91px" class="cls_014"><span class="cls_014">SP</span></div>
<div style="position:absolute;left:120.00px;top:300.97px" class="cls_038"><span class="cls_038">Figure 3-3: On the left is YARV’s internal stack, and on the right is the compiled version of</span></div>
<div style="position:absolute;left:120.00px;top:311.47px" class="cls_038"><span class="cls_038">my </span><span class="cls_014">puts 2+2</span><span class="cls_038"> program.</span></div>
<div style="position:absolute;left:138.00px;top:333.97px" class="cls_007"><span class="cls_007">As you can see in Figure 3-3, YARV starts the program counter (</span><span class="cls_030">PC</span><span class="cls_007">)</span></div>
<div style="position:absolute;left:120.00px;top:345.97px" class="cls_007"><span class="cls_007">at the first instruction, and initially the stack is empty. Now YARV will</span></div>
<div style="position:absolute;left:120.00px;top:357.97px" class="cls_007"><span class="cls_007">execute the </span><span class="cls_030">trace</span><span class="cls_007"> instruction, incrementing the </span><span class="cls_030">PC</span><span class="cls_007"> register, as shown in</span></div>
<div style="position:absolute;left:120.00px;top:369.97px" class="cls_007"><span class="cls_007">Figure 3-4.</span></div>
<div style="position:absolute;left:288.72px;top:395.72px" class="cls_014"><span class="cls_014">trace</span></div>
<div style="position:absolute;left:288.72px;top:404.75px" class="cls_014"><span class="cls_014">putself</span></div>
<div style="position:absolute;left:288.72px;top:413.78px" class="cls_014"><span class="cls_014">putobject</span></div>
<div style="position:absolute;left:358.17px;top:413.78px" class="cls_014"><span class="cls_014">2</span></div>
<div style="position:absolute;left:260.97px;top:416.28px" class="cls_014"><span class="cls_014">PC</span></div>
<div style="position:absolute;left:288.72px;top:422.81px" class="cls_014"><span class="cls_014">putobject</span></div>
<div style="position:absolute;left:358.17px;top:422.81px" class="cls_014"><span class="cls_014">2</span></div>
<div style="position:absolute;left:288.72px;top:431.84px" class="cls_014"><span class="cls_014">opt_plus</span></div>
<div style="position:absolute;left:288.72px;top:440.87px" class="cls_014"><span class="cls_014">opt_send_simple</span></div>
<div style="position:absolute;left:358.17px;top:440.87px" class="cls_014"><span class="cls_014">&lt;callinfo!mid:puts,</span></div>
<div style="position:absolute;left:358.17px;top:449.90px" class="cls_014"><span class="cls_014">argc:1...</span></div>
<div style="position:absolute;left:288.72px;top:458.93px" class="cls_014"><span class="cls_014">leave</span></div>
<div style="position:absolute;left:201.67px;top:475.49px" class="cls_014"><span class="cls_014">SP</span></div>
<div style="position:absolute;left:120.00px;top:493.54px" class="cls_038"><span class="cls_038">Figure 3-4: Ruby executes the first instruction, </span><span class="cls_014">trace</span><span class="cls_038">.</span></div>
<div style="position:absolute;left:138.00px;top:516.04px" class="cls_007"><span class="cls_007">Ruby uses the </span><span class="cls_030">trace</span><span class="cls_007"> instruction to support the </span><span class="cls_030">set_trace_func</span><span class="cls_007"> feature. If</span></div>
<div style="position:absolute;left:120.00px;top:528.04px" class="cls_007"><span class="cls_007">you call </span><span class="cls_030">set_trace_func</span><span class="cls_007"> and provide a function, Ruby will call it each time it</span></div>
<div style="position:absolute;left:120.00px;top:540.04px" class="cls_007"><span class="cls_007">executes a line of Ruby code.</span></div>
<div style="position:absolute;left:138.00px;top:552.04px" class="cls_007"><span class="cls_007">Next, YARV executes </span><span class="cls_030">putself</span><span class="cls_007"> and pushes the current value of </span><span class="cls_030">self</span><span class="cls_007"> onto</span></div>
<div style="position:absolute;left:120.00px;top:564.04px" class="cls_007"><span class="cls_007">the stack, as shown in Figure 3-5.</span></div>
<div style="position:absolute;left:48.00px;top:633.00px" class="cls_020"><span class="cls_020">58</span></div>
<div style="position:absolute;left:70.01px;top:636.00px" class="cls_021"><span class="cls_021">Chapter 3</span></div>
</div>
<div style="position:absolute;left:50%;margin-left:-252px;top:53404px;width:504px;height:666px;border-style:outset;overflow:hidden">
<div style="position:absolute;left:0px;top:0px">
<img src="e698b76e-46bd-11eb-8b25-0cc47a792c0a_id_e698b76e-46bd-11eb-8b25-0cc47a792c0a_files/background083.jpg" width=504 height=666></div>
<div style="position:absolute;left:291.72px;top:47.11px" class="cls_014"><span class="cls_014">trace</span></div>
<div style="position:absolute;left:291.72px;top:56.14px" class="cls_014"><span class="cls_014">putself</span></div>
<div style="position:absolute;left:291.72px;top:65.18px" class="cls_014"><span class="cls_014">putobject</span></div>
<div style="position:absolute;left:361.17px;top:65.18px" class="cls_014"><span class="cls_014">2</span></div>
<div style="position:absolute;left:263.97px;top:76.04px" class="cls_014"><span class="cls_014">PC</span></div>
<div style="position:absolute;left:291.72px;top:74.21px" class="cls_014"><span class="cls_014">putobject</span></div>
<div style="position:absolute;left:361.17px;top:74.21px" class="cls_014"><span class="cls_014">2</span></div>
<div style="position:absolute;left:291.72px;top:83.23px" class="cls_014"><span class="cls_014">opt_plus</span></div>
<div style="position:absolute;left:291.72px;top:92.26px" class="cls_014"><span class="cls_014">opt_send_simple</span></div>
<div style="position:absolute;left:361.17px;top:92.26px" class="cls_014"><span class="cls_014">&lt;callinfo!mid:puts,</span></div>
<div style="position:absolute;left:361.17px;top:101.30px" class="cls_014"><span class="cls_014">argc:1...</span></div>
<div style="position:absolute;left:204.67px;top:105.99px" class="cls_014"><span class="cls_014">SP</span></div>
<div style="position:absolute;left:291.72px;top:110.32px" class="cls_014"><span class="cls_014">leave</span></div>
<div style="position:absolute;left:149.88px;top:116.83px" class="cls_014"><span class="cls_014">self</span></div>
<div style="position:absolute;left:123.00px;top:142.50px" class="cls_038"><span class="cls_038">Figure 3-5: </span><span class="cls_014">putself</span><span class="cls_038"> pushes the </span><span class="cls_014">top self</span><span class="cls_038"> value onto the stack.</span></div>
<div style="position:absolute;left:141.00px;top:165.00px" class="cls_007"><span class="cls_007">Because this simple script contains no Ruby objects or classes, the</span></div>
<div style="position:absolute;left:123.00px;top:177.00px" class="cls_030"><span class="cls_030">self</span><span class="cls_007"> pointer is set to the default </span><span class="cls_030">top self</span><span class="cls_007"> object. This is an instance of the</span></div>
<div style="position:absolute;left:123.00px;top:189.00px" class="cls_030"><span class="cls_030">Object</span><span class="cls_007"> class that Ruby automatically creates when YARV starts. It serves</span></div>
<div style="position:absolute;left:123.00px;top:201.00px" class="cls_007"><span class="cls_007">as the receiver for method calls and the container for instance variables in</span></div>
<div style="position:absolute;left:123.00px;top:213.00px" class="cls_007"><span class="cls_007">the top-level scope. The </span><span class="cls_030">top self</span><span class="cls_007"> object contains a single, predefined </span><span class="cls_030">to_s</span></div>
<div style="position:absolute;left:123.00px;top:225.00px" class="cls_007"><span class="cls_007">method, which returns the string </span><span class="cls_030">main</span><span class="cls_007">. You can call this method by running</span></div>
<div style="position:absolute;left:123.00px;top:237.00px" class="cls_007"><span class="cls_007">the following command in the console:</span></div>
<div style="position:absolute;left:123.00px;top:261.00px" class="cls_030"><span class="cls_030">$ </span><span class="cls_040">ruby -e 'puts self'</span></div>
<div style="position:absolute;left:127.25px;top:271.50px" class="cls_030"><span class="cls_030">=> main</span></div>
<div style="position:absolute;left:141.00px;top:294.00px" class="cls_007"><span class="cls_007">YARV will use this </span><span class="cls_030">self</span><span class="cls_007"> value on the stack when it executes the </span><span class="cls_030">opt_send_</span></div>
<div style="position:absolute;left:123.00px;top:306.00px" class="cls_030"><span class="cls_030">simple</span><span class="cls_007"> instruction: </span><span class="cls_030">self</span><span class="cls_007"> is the receiver of the </span><span class="cls_030">puts</span><span class="cls_007"> method because I didn’t</span></div>
<div style="position:absolute;left:123.00px;top:318.00px" class="cls_007"><span class="cls_007">specify a receiver for this method call.</span></div>
<div style="position:absolute;left:141.00px;top:330.00px" class="cls_007"><span class="cls_007">Next, YARV executes </span><span class="cls_030">putobject 2</span><span class="cls_007">. It pushes the numeric value </span><span class="cls_030">2</span><span class="cls_007"> onto the</span></div>
<div style="position:absolute;left:123.00px;top:342.00px" class="cls_007"><span class="cls_007">stack and increments the </span><span class="cls_030">PC</span><span class="cls_007"> again, as shown in Figure 3-6.</span></div>
<div style="position:absolute;left:291.72px;top:366.81px" class="cls_014"><span class="cls_014">trace</span></div>
<div style="position:absolute;left:291.72px;top:375.76px" class="cls_014"><span class="cls_014">putself</span></div>
<div style="position:absolute;left:291.72px;top:384.72px" class="cls_014"><span class="cls_014">putobject</span></div>
<div style="position:absolute;left:361.17px;top:384.72px" class="cls_014"><span class="cls_014">2</span></div>
<div style="position:absolute;left:291.72px;top:393.67px" class="cls_014"><span class="cls_014">putobject</span></div>
<div style="position:absolute;left:361.17px;top:393.67px" class="cls_014"><span class="cls_014">2</span></div>
<div style="position:absolute;left:204.67px;top:404.07px" class="cls_014"><span class="cls_014">SP</span></div>
<div style="position:absolute;left:263.97px;top:404.07px" class="cls_014"><span class="cls_014">PC</span></div>
<div style="position:absolute;left:291.72px;top:402.63px" class="cls_014"><span class="cls_014">opt_plus</span></div>
<div style="position:absolute;left:291.72px;top:411.58px" class="cls_014"><span class="cls_014">opt_send_simple</span></div>
<div style="position:absolute;left:361.17px;top:411.58px" class="cls_014"><span class="cls_014">&lt;callinfo!mid:puts,</span></div>
<div style="position:absolute;left:155.42px;top:414.76px" class="cls_014"><span class="cls_014">2</span></div>
<div style="position:absolute;left:361.17px;top:420.53px" class="cls_014"><span class="cls_014">argc:1...</span></div>
<div style="position:absolute;left:291.72px;top:429.49px" class="cls_014"><span class="cls_014">leave</span></div>
<div style="position:absolute;left:149.42px;top:437.56px" class="cls_014"><span class="cls_014">self</span></div>
<div style="position:absolute;left:123.00px;top:461.90px" class="cls_038"><span class="cls_038">Figure 3-6: Ruby pushes the value </span><span class="cls_014">2</span><span class="cls_038"> onto the stack, the receiver of the </span><span class="cls_014">+</span><span class="cls_038"> method.</span></div>
<div style="position:absolute;left:143.60px;top:484.40px" class="cls_007"><span class="cls_007">This is the first step of the receiver (arguments) operation pattern</span></div>
<div style="position:absolute;left:123.00px;top:496.40px" class="cls_007"><span class="cls_007">described in “How Ruby Compiles a Simple Script” on page 34. First,</span></div>
<div style="position:absolute;left:123.00px;top:508.40px" class="cls_007"><span class="cls_007">Ruby pushes the receiver onto the internal YARV stack. In this example,</span></div>
<div style="position:absolute;left:123.00px;top:520.40px" class="cls_007"><span class="cls_007">the </span><span class="cls_030">Fixnum</span><span class="cls_007"> object </span><span class="cls_030">2</span><span class="cls_007"> is the receiver of the message/method </span><span class="cls_030">+</span><span class="cls_007">, which takes a</span></div>
<div style="position:absolute;left:123.00px;top:532.40px" class="cls_007"><span class="cls_007">single argument, also a </span><span class="cls_030">2</span><span class="cls_007">. Next, Ruby pushes the argument </span><span class="cls_030">2</span><span class="cls_007">, as shown in</span></div>
<div style="position:absolute;left:123.00px;top:544.40px" class="cls_007"><span class="cls_007">Figure 3-7.</span></div>
<div style="position:absolute;left:349.53px;top:636.00px" class="cls_021"><span class="cls_021">How Ruby Executes Your Code</span></div>
<div style="position:absolute;left:447.14px;top:633.00px" class="cls_020"><span class="cls_020">59</span></div>
</div>
<div style="position:absolute;left:50%;margin-left:-252px;top:54080px;width:504px;height:666px;border-style:outset;overflow:hidden">
<div style="position:absolute;left:0px;top:0px">
<img src="e698b76e-46bd-11eb-8b25-0cc47a792c0a_id_e698b76e-46bd-11eb-8b25-0cc47a792c0a_files/background084.jpg" width=504 height=666></div>
<div style="position:absolute;left:288.72px;top:47.02px" class="cls_014"><span class="cls_014">trace</span></div>
<div style="position:absolute;left:288.72px;top:55.97px" class="cls_014"><span class="cls_014">putself</span></div>
<div style="position:absolute;left:201.67px;top:62.85px" class="cls_014"><span class="cls_014">SP</span></div>
<div style="position:absolute;left:288.72px;top:64.92px" class="cls_014"><span class="cls_014">putobject</span></div>
<div style="position:absolute;left:358.17px;top:64.92px" class="cls_014"><span class="cls_014">2</span></div>
<div style="position:absolute;left:152.42px;top:73.74px" class="cls_014"><span class="cls_014">2</span></div>
<div style="position:absolute;left:288.72px;top:73.87px" class="cls_014"><span class="cls_014">putobject</span></div>
<div style="position:absolute;left:358.17px;top:73.87px" class="cls_014"><span class="cls_014">2</span></div>
<div style="position:absolute;left:288.72px;top:82.83px" class="cls_014"><span class="cls_014">opt_plus</span></div>
<div style="position:absolute;left:260.97px;top:93.47px" class="cls_014"><span class="cls_014">PC</span></div>
<div style="position:absolute;left:288.72px;top:91.79px" class="cls_014"><span class="cls_014">opt_send_simple</span></div>
<div style="position:absolute;left:358.17px;top:91.79px" class="cls_014"><span class="cls_014">&lt;callinfo!mid:puts,</span></div>
<div style="position:absolute;left:152.42px;top:95.36px" class="cls_014"><span class="cls_014">2</span></div>
<div style="position:absolute;left:358.17px;top:100.74px" class="cls_014"><span class="cls_014">argc:1...</span></div>
<div style="position:absolute;left:288.72px;top:109.70px" class="cls_014"><span class="cls_014">leave</span></div>
<div style="position:absolute;left:146.42px;top:116.16px" class="cls_014"><span class="cls_014">self</span></div>
<div style="position:absolute;left:120.00px;top:142.50px" class="cls_038"><span class="cls_038">Figure 3-7: Ruby pushes another value </span><span class="cls_014">2</span><span class="cls_038"> onto the stack, the argument of the </span><span class="cls_014">+</span><span class="cls_038"> method.</span></div>
<div style="position:absolute;left:138.00px;top:165.00px" class="cls_007"><span class="cls_007">Finally, Ruby executes the </span><span class="cls_030">+</span><span class="cls_007"> operation. In this case, </span><span class="cls_030">opt_plus</span><span class="cls_007"> is an opti-</span></div>
<div style="position:absolute;left:119.99px;top:177.00px" class="cls_007"><span class="cls_007">mized instruction that will add two values: the receiver and the argument,</span></div>
<div style="position:absolute;left:119.99px;top:189.00px" class="cls_007"><span class="cls_007">as shown in Figure 3-8.</span></div>
<div style="position:absolute;left:288.72px;top:213.62px" class="cls_014"><span class="cls_014">trace</span></div>
<div style="position:absolute;left:288.72px;top:222.58px" class="cls_014"><span class="cls_014">putself</span></div>
<div style="position:absolute;left:288.72px;top:231.53px" class="cls_014"><span class="cls_014">putobject</span></div>
<div style="position:absolute;left:358.17px;top:231.53px" class="cls_014"><span class="cls_014">2</span></div>
<div style="position:absolute;left:288.72px;top:240.48px" class="cls_014"><span class="cls_014">putobject</span></div>
<div style="position:absolute;left:358.17px;top:240.48px" class="cls_014"><span class="cls_014">2</span></div>
<div style="position:absolute;left:201.67px;top:250.37px" class="cls_014"><span class="cls_014">SP</span></div>
<div style="position:absolute;left:288.72px;top:249.44px" class="cls_014"><span class="cls_014">opt_plus</span></div>
<div style="position:absolute;left:288.72px;top:258.39px" class="cls_014"><span class="cls_014">opt_send_simple</span></div>
<div style="position:absolute;left:358.17px;top:258.39px" class="cls_014"><span class="cls_014">&lt;callinfo!mid:puts,</span></div>
<div style="position:absolute;left:152.42px;top:261.75px" class="cls_014"><span class="cls_014">4</span></div>
<div style="position:absolute;left:260.97px;top:268.85px" class="cls_014"><span class="cls_014">PC</span></div>
<div style="position:absolute;left:358.17px;top:267.34px" class="cls_014"><span class="cls_014">argc:1...</span></div>
<div style="position:absolute;left:288.72px;top:276.30px" class="cls_014"><span class="cls_014">leave</span></div>
<div style="position:absolute;left:146.42px;top:282.55px" class="cls_014"><span class="cls_014">self</span></div>
<div style="position:absolute;left:120.00px;top:308.90px" class="cls_038"><span class="cls_038">Figure 3-8: The </span><span class="cls_014">opt_plus</span><span class="cls_038"> instruction calculates 2 + 2 = 4.</span></div>
<div style="position:absolute;left:138.00px;top:331.40px" class="cls_007"><span class="cls_007">As you can see in Figure 3-8, the </span><span class="cls_030">opt_plus</span><span class="cls_007"> instruction leaves the result, </span><span class="cls_030">4</span><span class="cls_007">,</span></div>
<div style="position:absolute;left:120.00px;top:343.40px" class="cls_007"><span class="cls_007">at the top of the stack. Now Ruby is perfectly positioned to execute the </span><span class="cls_030">puts</span></div>
<div style="position:absolute;left:120.00px;top:355.40px" class="cls_007"><span class="cls_007">function call: The receiver </span><span class="cls_030">self</span><span class="cls_007"> is first on the stack, and the single argu-</span></div>
<div style="position:absolute;left:119.99px;top:367.40px" class="cls_007"><span class="cls_007">ment, </span><span class="cls_030">4</span><span class="cls_007">, is at the top of the stack. (I’ll describe how method lookup works</span></div>
<div style="position:absolute;left:120.00px;top:379.40px" class="cls_007"><span class="cls_007">in Chapter 6.)</span></div>
<div style="position:absolute;left:138.00px;top:391.40px" class="cls_007"><span class="cls_007">Next, Figure 3-9 shows what happens when Ruby executes the </span><span class="cls_030">puts</span></div>
<div style="position:absolute;left:120.00px;top:403.40px" class="cls_007"><span class="cls_007">method call. As you can see, the </span><span class="cls_030">opt_send_simple</span><span class="cls_007"> instruction leaves the return</span></div>
<div style="position:absolute;left:120.00px;top:415.40px" class="cls_007"><span class="cls_007">value, </span><span class="cls_030">nil</span><span class="cls_007">, at the top of the stack. Finally, Ruby executes the last instruction,</span></div>
<div style="position:absolute;left:120.00px;top:427.40px" class="cls_030"><span class="cls_030">leave</span><span class="cls_007">, which finishes the execution of our simple, one-line Ruby program.</span></div>
<div style="position:absolute;left:120.00px;top:439.40px" class="cls_007"><span class="cls_007">Of course, when Ruby executes the </span><span class="cls_030">puts</span><span class="cls_007"> call, the C code implementing the</span></div>
<div style="position:absolute;left:120.00px;top:451.40px" class="cls_030"><span class="cls_030">puts</span><span class="cls_007"> function will actually display the value </span><span class="cls_030">4</span><span class="cls_007"> in the console output.</span></div>
<div style="position:absolute;left:288.72px;top:476.03px" class="cls_014"><span class="cls_014">trace</span></div>
<div style="position:absolute;left:288.72px;top:484.98px" class="cls_014"><span class="cls_014">putself</span></div>
<div style="position:absolute;left:288.72px;top:493.93px" class="cls_014"><span class="cls_014">putobject</span></div>
<div style="position:absolute;left:358.17px;top:493.93px" class="cls_014"><span class="cls_014">2</span></div>
<div style="position:absolute;left:288.72px;top:502.89px" class="cls_014"><span class="cls_014">putobject</span></div>
<div style="position:absolute;left:358.17px;top:502.89px" class="cls_014"><span class="cls_014">2</span></div>
<div style="position:absolute;left:288.72px;top:511.85px" class="cls_014"><span class="cls_014">opt_plus</span></div>
<div style="position:absolute;left:288.72px;top:520.80px" class="cls_014"><span class="cls_014">opt_send_simple</span></div>
<div style="position:absolute;left:358.17px;top:520.80px" class="cls_014"><span class="cls_014">&lt;callinfo!mid:puts,</span></div>
<div style="position:absolute;left:358.17px;top:529.75px" class="cls_014"><span class="cls_014">argc:1...</span></div>
<div style="position:absolute;left:201.67px;top:534.78px" class="cls_014"><span class="cls_014">SP</span></div>
<div style="position:absolute;left:288.72px;top:538.71px" class="cls_014"><span class="cls_014">leave</span></div>
<div style="position:absolute;left:148.88px;top:544.95px" class="cls_014"><span class="cls_014">nil</span></div>
<div style="position:absolute;left:260.97px;top:548.38px" class="cls_014"><span class="cls_014">PC</span></div>
<div style="position:absolute;left:120.00px;top:571.29px" class="cls_038"><span class="cls_038">Figure 3-9: Ruby calls the </span><span class="cls_014">puts</span><span class="cls_038"> method on the </span><span class="cls_014">top self</span><span class="cls_038"> object.</span></div>
<div style="position:absolute;left:48.00px;top:633.00px" class="cls_020"><span class="cls_020">60</span></div>
<div style="position:absolute;left:70.03px;top:636.00px" class="cls_021"><span class="cls_021">Chapter 3</span></div>
</div>
<div style="position:absolute;left:50%;margin-left:-252px;top:54756px;width:504px;height:666px;border-style:outset;overflow:hidden">
<div style="position:absolute;left:0px;top:0px">
<img src="e698b76e-46bd-11eb-8b25-0cc47a792c0a_id_e698b76e-46bd-11eb-8b25-0cc47a792c0a_files/background085.jpg" width=504 height=666></div>
<div style="position:absolute;left:123.00px;top:42.55px" class="cls_055"><span class="cls_055">Executing a Call to a Block</span></div>
<div style="position:absolute;left:123.00px;top:60.55px" class="cls_007"><span class="cls_007">Now let’s see how the Ruby call stack works. In Listing 3-2, a slightly more</span></div>
<div style="position:absolute;left:123.00px;top:72.55px" class="cls_007"><span class="cls_007">complicated example, you see a simple Ruby script that calls a block 10</span></div>
<div style="position:absolute;left:123.00px;top:84.55px" class="cls_007"><span class="cls_007">times, printing out a string.</span></div>
<div style="position:absolute;left:123.00px;top:108.55px" class="cls_030"><span class="cls_030">10.times do</span></div>
<div style="position:absolute;left:131.50px;top:119.04px" class="cls_030"><span class="cls_030">puts "The quick brown fox jumps over the lazy dog."</span></div>
<div style="position:absolute;left:123.00px;top:129.54px" class="cls_030"><span class="cls_030">end</span></div>
<div style="position:absolute;left:123.00px;top:152.04px" class="cls_038"><span class="cls_038">Listing 3-2: This example program calls a block 10 times.</span></div>
<div style="position:absolute;left:141.00px;top:174.55px" class="cls_007"><span class="cls_007">Let’s skip over a few steps and start where YARV is about to call the</span></div>
<div style="position:absolute;left:123.00px;top:186.55px" class="cls_030"><span class="cls_030">times</span><span class="cls_007"> method, as shown in Figure 3-10.</span></div>
<div style="position:absolute;left:126.04px;top:211.33px" class="cls_014"><span class="cls_014">trace</span></div>
<div style="position:absolute;left:126.04px;top:220.42px" class="cls_014"><span class="cls_014">putobject</span></div>
<div style="position:absolute;left:169.92px;top:220.26px" class="cls_014"><span class="cls_014">10</span></div>
<div style="position:absolute;left:337.68px;top:223.64px" class="cls_053"><span class="cls_053">rb_control_frame_t</span></div>
<div style="position:absolute;left:126.04px;top:229.52px" class="cls_014"><span class="cls_014">send</span></div>
<div style="position:absolute;left:169.92px;top:229.35px" class="cls_014"><span class="cls_014">&lt;callinfo!mid:times, argc:0,</span></div>
<div style="position:absolute;left:169.92px;top:238.45px" class="cls_014"><span class="cls_014">block:block in &lt;compiled>></span></div>
<div style="position:absolute;left:361.68px;top:239.67px" class="cls_014"><span class="cls_014">[EVAL]</span></div>
<div style="position:absolute;left:435.40px;top:244.87px" class="cls_014"><span class="cls_014">CFP</span></div>
<div style="position:absolute;left:126.04px;top:247.70px" class="cls_014"><span class="cls_014">leave</span></div>
<div style="position:absolute;left:337.68px;top:265.42px" class="cls_053"><span class="cls_053">rb_control_frame_t</span></div>
<div style="position:absolute;left:363.68px;top:281.46px" class="cls_014"><span class="cls_014">[TOP]</span></div>
<div style="position:absolute;left:123.00px;top:311.02px" class="cls_038"><span class="cls_038">Figure 3-10: Every Ruby program starts with these two control frames.</span></div>
<div style="position:absolute;left:141.00px;top:333.52px" class="cls_007"><span class="cls_007">On the left side of the diagram are the YARV instructions that Ruby is</span></div>
<div style="position:absolute;left:123.00px;top:345.52px" class="cls_007"><span class="cls_007">executing. On the right, you see two control frame structures.</span></div>
<div style="position:absolute;left:141.00px;top:357.52px" class="cls_007"><span class="cls_007">At the bottom of the stack, you see a control frame with the type set to</span></div>
<div style="position:absolute;left:123.00px;top:369.52px" class="cls_030"><span class="cls_030">TOP</span><span class="cls_007">. Ruby always creates this frame first when starting a new program. At</span></div>
<div style="position:absolute;left:123.00px;top:381.52px" class="cls_007"><span class="cls_007">the top of the stack, at least initially, a frame of type </span><span class="cls_030">EVAL</span><span class="cls_007"> corresponds to the</span></div>
<div style="position:absolute;left:123.00px;top:393.52px" class="cls_007"><span class="cls_007">top level or main scope of the Ruby script.</span></div>
<div style="position:absolute;left:141.00px;top:405.52px" class="cls_007"><span class="cls_007">Next, Ruby calls the </span><span class="cls_030">times</span><span class="cls_007"> message on the </span><span class="cls_030">Fixnum</span><span class="cls_007"> object </span><span class="cls_030">10</span><span class="cls_007">—the receiver</span></div>
<div style="position:absolute;left:123.00px;top:417.52px" class="cls_007"><span class="cls_007">of the </span><span class="cls_030">times</span><span class="cls_007"> message. When it does so, it adds a new level to the control frame</span></div>
<div style="position:absolute;left:123.00px;top:429.52px" class="cls_007"><span class="cls_007">stack, as shown in Figure 3-11.</span></div>
<div style="position:absolute;left:337.67px;top:459.62px" class="cls_053"><span class="cls_053">rb_control_frame_t</span></div>
<div style="position:absolute;left:148.18px;top:470.40px" class="cls_014"><span class="cls_014">[ C function - int_dotimes ]</span></div>
<div style="position:absolute;left:359.67px;top:475.65px" class="cls_014"><span class="cls_014">[CFUNC]</span></div>
<div style="position:absolute;left:437.33px;top:479.67px" class="cls_014"><span class="cls_014">CFP</span></div>
<div style="position:absolute;left:337.67px;top:500.60px" class="cls_053"><span class="cls_053">rb_control_frame_t</span></div>
<div style="position:absolute;left:126.03px;top:518.40px" class="cls_014"><span class="cls_014">trace</span></div>
<div style="position:absolute;left:361.67px;top:516.64px" class="cls_014"><span class="cls_014">[EVAL]</span></div>
<div style="position:absolute;left:126.03px;top:527.32px" class="cls_014"><span class="cls_014">putobject</span></div>
<div style="position:absolute;left:169.92px;top:527.16px" class="cls_014"><span class="cls_014">10</span></div>
<div style="position:absolute;left:126.03px;top:536.24px" class="cls_014"><span class="cls_014">send</span></div>
<div style="position:absolute;left:169.92px;top:536.08px" class="cls_014"><span class="cls_014">&lt;callinfo!mid:times, argc:0,</span></div>
<div style="position:absolute;left:337.67px;top:541.59px" class="cls_053"><span class="cls_053">rb_control_frame_t</span></div>
<div style="position:absolute;left:169.92px;top:545.00px" class="cls_014"><span class="cls_014">block:block in &lt;compiled>></span></div>
<div style="position:absolute;left:126.03px;top:554.08px" class="cls_014"><span class="cls_014">leave</span></div>
<div style="position:absolute;left:363.67px;top:557.63px" class="cls_014"><span class="cls_014">[TOP]</span></div>
<div style="position:absolute;left:123.00px;top:587.21px" class="cls_038"><span class="cls_038">Figure 3-11: Ruby uses the </span><span class="cls_014">CFUNC</span><span class="cls_038"> frame when you call built-in functions implemented in C.</span></div>
<div style="position:absolute;left:349.97px;top:636.00px" class="cls_021"><span class="cls_021">How Ruby Executes Your Code</span></div>
<div style="position:absolute;left:447.57px;top:633.00px" class="cls_020"><span class="cls_020">61</span></div>
</div>
<div style="position:absolute;left:50%;margin-left:-252px;top:55432px;width:504px;height:666px;border-style:outset;overflow:hidden">
<div style="position:absolute;left:0px;top:0px">
<img src="e698b76e-46bd-11eb-8b25-0cc47a792c0a_id_e698b76e-46bd-11eb-8b25-0cc47a792c0a_files/background086.jpg" width=504 height=666></div>
<div style="position:absolute;left:138.00px;top:42.28px" class="cls_007"><span class="cls_007">This new entry (at the right of Figure 3-11) represents a new level in the</span></div>
<div style="position:absolute;left:120.00px;top:54.28px" class="cls_007"><span class="cls_007">program’s Ruby call stack, and the </span><span class="cls_030">CFP</span><span class="cls_007"> pointer has moved up to point at the</span></div>
<div style="position:absolute;left:120.00px;top:66.28px" class="cls_007"><span class="cls_007">new control frame structure. Also, notice that because the </span><span class="cls_030">Integer#times</span></div>
<div style="position:absolute;left:120.00px;top:78.28px" class="cls_007"><span class="cls_007">method is built into Ruby, there are no YARV instructions for it. Instead,</span></div>
<div style="position:absolute;left:120.00px;top:90.28px" class="cls_007"><span class="cls_007">Ruby will call some internal C code to pop the argument </span><span class="cls_030">10</span><span class="cls_007"> off the stack</span></div>
<div style="position:absolute;left:120.00px;top:102.28px" class="cls_007"><span class="cls_007">and call the provided block 10 times. Ruby gives this control frame a type</span></div>
<div style="position:absolute;left:120.00px;top:114.28px" class="cls_007"><span class="cls_007">of </span><span class="cls_030">CFUNC</span><span class="cls_007">.</span></div>
<div style="position:absolute;left:138.00px;top:126.28px" class="cls_007"><span class="cls_007">Finally, Figure 3-12 shows what the YARV and control frame stacks will</span></div>
<div style="position:absolute;left:120.00px;top:138.28px" class="cls_007"><span class="cls_007">look like if we interrupt the program inside the inner block.</span></div>
<div style="position:absolute;left:123.03px;top:162.92px" class="cls_014"><span class="cls_014">trace</span></div>
<div style="position:absolute;left:123.03px;top:172.01px" class="cls_014"><span class="cls_014">putself</span></div>
<div style="position:absolute;left:123.03px;top:181.11px" class="cls_014"><span class="cls_014">putstring</span></div>
<div style="position:absolute;left:191.10px;top:181.11px" class="cls_014"><span class="cls_014">"The quick brown fox..."</span></div>
<div style="position:absolute;left:123.03px;top:190.19px" class="cls_014"><span class="cls_014">opt_send_simple</span></div>
<div style="position:absolute;left:191.10px;top:190.19px" class="cls_014"><span class="cls_014">&lt;callinfo!mid:puts,</span></div>
<div style="position:absolute;left:191.10px;top:199.28px" class="cls_014"><span class="cls_014">argc:1...</span></div>
<div style="position:absolute;left:123.03px;top:208.38px" class="cls_014"><span class="cls_014">leave</span></div>
<div style="position:absolute;left:334.67px;top:206.06px" class="cls_053"><span class="cls_053">rb_control_frame_t</span></div>
<div style="position:absolute;left:356.67px;top:222.10px" class="cls_014"><span class="cls_014">[BLOCK]</span></div>
<div style="position:absolute;left:432.40px;top:227.42px" class="cls_014"><span class="cls_014">CFP</span></div>
<div style="position:absolute;left:334.67px;top:247.07px" class="cls_053"><span class="cls_053">rb_control_frame_t</span></div>
<div style="position:absolute;left:145.17px;top:257.04px" class="cls_014"><span class="cls_014">[ C function - int_dotimes ]</span></div>
<div style="position:absolute;left:356.67px;top:263.11px" class="cls_014"><span class="cls_014">[CFUNC]</span></div>
<div style="position:absolute;left:334.67px;top:288.09px" class="cls_053"><span class="cls_053">rb_control_frame_t</span></div>
<div style="position:absolute;left:358.67px;top:304.13px" class="cls_014"><span class="cls_014">[EVAL]</span></div>
<div style="position:absolute;left:123.03px;top:315.15px" class="cls_014"><span class="cls_014">trace</span></div>
<div style="position:absolute;left:123.03px;top:324.39px" class="cls_014"><span class="cls_014">putobject</span></div>
<div style="position:absolute;left:166.92px;top:324.39px" class="cls_014"><span class="cls_014">10</span></div>
<div style="position:absolute;left:334.67px;top:329.12px" class="cls_053"><span class="cls_053">rb_control_frame_t</span></div>
<div style="position:absolute;left:123.03px;top:333.63px" class="cls_014"><span class="cls_014">send</span></div>
<div style="position:absolute;left:166.92px;top:333.63px" class="cls_014"><span class="cls_014">&lt;callinfo!mid:times, argc:0,</span></div>
<div style="position:absolute;left:166.92px;top:342.87px" class="cls_014"><span class="cls_014">block:block in &lt;compiled>></span></div>
<div style="position:absolute;left:360.67px;top:345.15px" class="cls_014"><span class="cls_014">[TOP]</span></div>
<div style="position:absolute;left:123.03px;top:352.11px" class="cls_014"><span class="cls_014">leave</span></div>
<div style="position:absolute;left:120.00px;top:380.15px" class="cls_038"><span class="cls_038">Figure 3-12: The </span><span class="cls_014">CFP</span><span class="cls_038"> stack when we pause the code from Listing 3-2 inside the block</span></div>
<div style="position:absolute;left:138.00px;top:404.65px" class="cls_007"><span class="cls_007">There will now be four entries, as follows, in the control frame stack on</span></div>
<div style="position:absolute;left:120.00px;top:416.65px" class="cls_007"><span class="cls_007">the right:</span></div>
<div style="position:absolute;left:120.00px;top:439.65px" class="cls_050"><span class="cls_050">•</span><span class="cls_007">   The </span><span class="cls_030">TOP</span><span class="cls_007"> and </span><span class="cls_030">EVAL</span><span class="cls_007"> frames that Ruby always starts with</span></div>
<div style="position:absolute;left:120.00px;top:455.65px" class="cls_050"><span class="cls_050">•</span><span class="cls_007">   The </span><span class="cls_030">CFUNC</span><span class="cls_007"> frame for the call to </span><span class="cls_030">10.times</span></div>
<div style="position:absolute;left:120.00px;top:471.65px" class="cls_050"><span class="cls_050">•</span><span class="cls_007">   A </span><span class="cls_030">BLOCK</span><span class="cls_007"> frame at the top of the stack that corresponds to the code run-</span></div>
<div style="position:absolute;left:138.00px;top:483.65px" class="cls_007"><span class="cls_007">ning inside the block</span></div>
<div style="position:absolute;left:48.00px;top:633.00px" class="cls_020"><span class="cls_020">62</span></div>
<div style="position:absolute;left:69.68px;top:636.00px" class="cls_021"><span class="cls_021">Chapter 3</span></div>
</div>
<div style="position:absolute;left:50%;margin-left:-252px;top:56108px;width:504px;height:666px;border-style:outset;overflow:hidden">
<div style="position:absolute;left:0px;top:0px">
<img src="e698b76e-46bd-11eb-8b25-0cc47a792c0a_id_e698b76e-46bd-11eb-8b25-0cc47a792c0a_files/background087.jpg" width=504 height=666></div>
<div style="position:absolute;left:164.12px;top:60.53px" class="cls_020"><span class="cls_020">Taking a Close Look at a YARV Instruction</span></div>
<div style="position:absolute;left:123.50px;top:79.03px" class="cls_039"><span class="cls_039">As it does with most other things, Ruby implements all YARV instructions, like </span><span class="cls_009">putobject</span></div>
<div style="position:absolute;left:123.50px;top:91.03px" class="cls_039"><span class="cls_039">or </span><span class="cls_009">send</span><span class="cls_039">, using C code that is then compiled into machine language and executed</span></div>
<div style="position:absolute;left:123.50px;top:103.03px" class="cls_039"><span class="cls_039">directly by your hardware. Strangely, however, you won’t find the C source code for</span></div>
<div style="position:absolute;left:123.50px;top:115.03px" class="cls_039"><span class="cls_039">each YARV instruction in a C source file. Instead, the Ruby core team put the YARV-</span></div>
<div style="position:absolute;left:123.50px;top:127.03px" class="cls_039"><span class="cls_039">instruction C code in a single large file called </span><span class="cls_044">insns.def</span><span class="cls_039">. Listing 3-3 shows a small</span></div>
<div style="position:absolute;left:123.50px;top:139.03px" class="cls_039"><span class="cls_039">snippet from </span><span class="cls_044">insns.def</span><span class="cls_039">, where Ruby implements the </span><span class="cls_009">putself</span><span class="cls_039"> YARV instruction internally.</span></div>
<div style="position:absolute;left:123.50px;top:161.53px" class="cls_009"><span class="cls_009">/**</span></div>
<div style="position:absolute;left:131.00px;top:171.03px" class="cls_009"><span class="cls_009">@c put</span></div>
<div style="position:absolute;left:131.00px;top:180.53px" class="cls_009"><span class="cls_009">@e put self.</span></div>
<div style="position:absolute;left:131.00px;top:190.04px" class="cls_009"><span class="cls_009">@j </span><span class="cls_045">スタックに</span><span class="cls_009"> self </span><span class="cls_045">をプッシュする。</span></div>
<div style="position:absolute;left:127.25px;top:199.54px" class="cls_009"><span class="cls_009">*/</span></div>
<div style="position:absolute;left:123.50px;top:209.04px" class="cls_009"><span class="cls_009">DEFINE_INSN</span></div>
<div style="position:absolute;left:123.50px;top:218.54px" class="cls_009"><span class="cls_009">putself</span></div>
<div style="position:absolute;left:123.50px;top:228.05px" class="cls_009"><span class="cls_009">()</span></div>
<div style="position:absolute;left:123.50px;top:237.55px" class="cls_009"><span class="cls_009">()</span></div>
<div style="position:absolute;left:123.50px;top:247.05px" class="cls_009"><span class="cls_009">(VALUE val)</span></div>
<div style="position:absolute;left:123.50px;top:256.55px" class="cls_009"><span class="cls_009">{</span></div>
<div style="position:absolute;left:113.00px;top:266.06px" class="cls_045"><span class="cls_045">u</span><span class="cls_009">   val = GET_SELF();</span></div>
<div style="position:absolute;left:123.50px;top:275.56px" class="cls_009"><span class="cls_009">}</span></div>
<div style="position:absolute;left:123.50px;top:298.03px" class="cls_043"><span class="cls_043">Listing 3-3: The definition of the </span><span class="cls_015">putself</span><span class="cls_043"> YARV instruction</span></div>
<div style="position:absolute;left:141.50px;top:321.03px" class="cls_039"><span class="cls_039">This doesn’t look like C at all and, in fact, most of it is not. Instead, what</span></div>
<div style="position:absolute;left:123.51px;top:333.03px" class="cls_039"><span class="cls_039">you see here is a bit of C code (</span><span class="cls_009">val = GET_SELF()</span><span class="cls_039">) at </span><span class="cls_046">u</span><span class="cls_039"> that appears below a call</span></div>
<div style="position:absolute;left:123.50px;top:345.03px" class="cls_039"><span class="cls_039">to </span><span class="cls_009">DEFINE_INSN</span><span class="cls_039">.</span></div>
<div style="position:absolute;left:141.50px;top:357.03px" class="cls_039"><span class="cls_039">It’s not hard to figure out that </span><span class="cls_009">DEFINE_INSN</span><span class="cls_039"> stands for </span><span class="cls_044">define instruction</span><span class="cls_039">. In fact,</span></div>
<div style="position:absolute;left:123.50px;top:369.03px" class="cls_039"><span class="cls_039">Ruby processes and converts the </span><span class="cls_044">insns.def</span><span class="cls_039"> file into real C code during the Ruby build</span></div>
<div style="position:absolute;left:123.50px;top:381.03px" class="cls_039"><span class="cls_039">process, similar to the way that Bison converts the </span><span class="cls_044">parse.y</span><span class="cls_039"> file into </span><span class="cls_044">parse.c</span><span class="cls_039">, as shown</span></div>
<div style="position:absolute;left:123.50px;top:393.03px" class="cls_039"><span class="cls_039">in Figure 3-13.</span></div>
<div style="position:absolute;left:137.80px;top:426.88px" class="cls_076"><span class="cls_076">YARV Instruction</span></div>
<div style="position:absolute;left:371.78px;top:431.15px" class="cls_076"><span class="cls_076">YARV C Code</span></div>
<div style="position:absolute;left:146.95px;top:435.42px" class="cls_076"><span class="cls_076">Definitions</span></div>
<div style="position:absolute;left:261.81px;top:435.52px" class="cls_077"><span class="cls_077">Pre-Process</span></div>
<div style="position:absolute;left:376.04px;top:439.68px" class="cls_076"><span class="cls_076">(</span><span class="cls_078">vm.inc</span><span class="cls_076"> file)</span></div>
<div style="position:absolute;left:141.82px;top:443.95px" class="cls_076"><span class="cls_076">(</span><span class="cls_078">insns.def</span><span class="cls_076"> file)</span></div>
<div style="position:absolute;left:248.56px;top:473.20px" class="cls_079"><span class="cls_079">Ruby Build Time</span></div>
<div style="position:absolute;left:123.50px;top:497.00px" class="cls_043"><span class="cls_043">Figure 3-13: Ruby compiles the YARV-instruction definition script </span><span class="cls_065">insns.def</span><span class="cls_043"> into C code during</span></div>
<div style="position:absolute;left:123.51px;top:507.50px" class="cls_043"><span class="cls_043">the Ruby build process.</span></div>
<div style="position:absolute;left:405.40px;top:520.50px" class="cls_043"><span class="cls_043">continued</span></div>
<div style="position:absolute;left:349.34px;top:636.00px" class="cls_021"><span class="cls_021">How Ruby Executes Your Code</span></div>
<div style="position:absolute;left:446.95px;top:633.00px" class="cls_020"><span class="cls_020">63</span></div>
</div>
<div style="position:absolute;left:50%;margin-left:-252px;top:56784px;width:504px;height:666px;border-style:outset;overflow:hidden">
<div style="position:absolute;left:0px;top:0px">
<img src="e698b76e-46bd-11eb-8b25-0cc47a792c0a_id_e698b76e-46bd-11eb-8b25-0cc47a792c0a_files/background088.jpg" width=504 height=666></div>
<div style="position:absolute;left:138.50px;top:59.79px" class="cls_039"><span class="cls_039">Ruby processes the </span><span class="cls_044">insns.def</span><span class="cls_039"> file using Ruby: The build process first uses Ruby</span><span class="cls_080"><sup>1</sup></span></div>
<div style="position:absolute;left:120.50px;top:73.15px" class="cls_039"><span class="cls_039">to generate </span><span class="cls_044">vm.inc</span><span class="cls_039"> and a few similar files. Then it uses these C source code files to</span></div>
<div style="position:absolute;left:120.51px;top:85.15px" class="cls_039"><span class="cls_039">compile </span><span class="cls_044">Miniruby</span><span class="cls_039">, a small version of Ruby, which later helps compile the complete</span></div>
<div style="position:absolute;left:120.50px;top:97.16px" class="cls_039"><span class="cls_039">version of Ruby. The other generated C files are related to encodings and C exten-</span></div>
<div style="position:absolute;left:120.50px;top:109.16px" class="cls_039"><span class="cls_039">sion libraries.</span></div>
<div style="position:absolute;left:138.50px;top:121.15px" class="cls_039"><span class="cls_039">Listing 3-4 shows what the snippet for </span><span class="cls_009">putself</span><span class="cls_039"> looks like in </span><span class="cls_044">vm.inc</span><span class="cls_039"> once Ruby has</span></div>
<div style="position:absolute;left:120.50px;top:133.16px" class="cls_039"><span class="cls_039">processed it.</span></div>
<div style="position:absolute;left:120.50px;top:155.65px" class="cls_009"><span class="cls_009">INSN_ENTRY(putself){</span></div>
<div style="position:absolute;left:120.50px;top:165.16px" class="cls_009"><span class="cls_009">{</span></div>
<div style="position:absolute;left:128.00px;top:174.66px" class="cls_009"><span class="cls_009">VALUE val;</span></div>
<div style="position:absolute;left:128.00px;top:184.16px" class="cls_009"><span class="cls_009">DEBUG_ENTER_INSN("putself");</span></div>
<div style="position:absolute;left:110.00px;top:193.66px" class="cls_045"><span class="cls_045">u</span><span class="cls_009">   ADD_PC(1+0);</span></div>
<div style="position:absolute;left:128.00px;top:203.17px" class="cls_009"><span class="cls_009">PREFETCH(GET_PC());</span></div>
<div style="position:absolute;left:128.00px;top:212.67px" class="cls_009"><span class="cls_009">#define CURRENT_INSN_putself 1</span></div>
<div style="position:absolute;left:128.00px;top:222.17px" class="cls_009"><span class="cls_009">#define INSN_IS_SC()</span></div>
<div style="position:absolute;left:221.75px;top:222.17px" class="cls_009"><span class="cls_009">0</span></div>
<div style="position:absolute;left:128.00px;top:231.67px" class="cls_009"><span class="cls_009">#define INSN_LABEL(lab)</span></div>
<div style="position:absolute;left:221.75px;top:231.67px" class="cls_009"><span class="cls_009">LABEL_putself_##lab</span></div>
<div style="position:absolute;left:128.00px;top:241.18px" class="cls_009"><span class="cls_009">#define LABEL_IS_SC(lab) LABEL_##lab##_##t</span></div>
<div style="position:absolute;left:128.00px;top:250.68px" class="cls_009"><span class="cls_009">COLLECT_USAGE_INSN(BIN(putself));</span></div>
<div style="position:absolute;left:120.50px;top:260.18px" class="cls_009"><span class="cls_009">{</span></div>
<div style="position:absolute;left:120.50px;top:269.68px" class="cls_009"><span class="cls_009">#line 282 "insns.def"</span></div>
<div style="position:absolute;left:110.00px;top:279.19px" class="cls_045"><span class="cls_045">v</span><span class="cls_009">     val = GET_SELF();</span></div>
<div style="position:absolute;left:120.50px;top:288.69px" class="cls_009"><span class="cls_009">#line 408 "vm.inc"</span></div>
<div style="position:absolute;left:128.00px;top:298.19px" class="cls_009"><span class="cls_009">CHECK_VM_STACK_OVERFLOW(REG_CFP, 1);</span></div>
<div style="position:absolute;left:110.00px;top:307.69px" class="cls_045"><span class="cls_045">w</span><span class="cls_009">   PUSH(val);</span></div>
<div style="position:absolute;left:120.50px;top:317.20px" class="cls_009"><span class="cls_009">#undef CURRENT_INSN_putself</span></div>
<div style="position:absolute;left:120.50px;top:326.70px" class="cls_009"><span class="cls_009">#undef INSN_IS_SC</span></div>
<div style="position:absolute;left:120.50px;top:336.20px" class="cls_009"><span class="cls_009">#undef INSN_LABEL</span></div>
<div style="position:absolute;left:120.50px;top:345.70px" class="cls_009"><span class="cls_009">#undef LABEL_IS_SC</span></div>
<div style="position:absolute;left:128.00px;top:355.21px" class="cls_009"><span class="cls_009">END_INSN(putself);}}}</span></div>
<div style="position:absolute;left:120.50px;top:377.65px" class="cls_043"><span class="cls_043">Listing 3-4: The definition of </span><span class="cls_015">putself</span><span class="cls_043"> is transformed into this C code during the Ruby build</span></div>
<div style="position:absolute;left:120.50px;top:388.15px" class="cls_043"><span class="cls_043">process.</span></div>
<div style="position:absolute;left:138.50px;top:411.15px" class="cls_039"><span class="cls_039">The single line </span><span class="cls_009">val = GET_SELF()</span><span class="cls_039"> appears in the middle of the listing at </span><span class="cls_046">v</span><span class="cls_039">. Above</span></div>
<div style="position:absolute;left:120.51px;top:423.16px" class="cls_039"><span class="cls_039">and below this line, Ruby calls a few different C macros to do various things, like</span></div>
<div style="position:absolute;left:120.51px;top:435.15px" class="cls_039"><span class="cls_039">add </span><span class="cls_009">1</span><span class="cls_039"> to the program counter (</span><span class="cls_009">PC</span><span class="cls_039">) register at </span><span class="cls_046">u</span><span class="cls_039"> and push the </span><span class="cls_009">val</span><span class="cls_039"> value onto the</span></div>
<div style="position:absolute;left:120.50px;top:447.15px" class="cls_039"><span class="cls_039">YARV internal stack at </span><span class="cls_046">w</span><span class="cls_039">. If you look through </span><span class="cls_044">vm.inc</span><span class="cls_039">, you’ll see this same C code</span></div>
<div style="position:absolute;left:120.50px;top:459.16px" class="cls_039"><span class="cls_039">repeated over and over again for the definition of each YARV instruction.</span></div>
<div style="position:absolute;left:138.50px;top:471.15px" class="cls_039"><span class="cls_039">The </span><span class="cls_044">vm.inc</span><span class="cls_039"> C source code file, in turn, is included by the </span><span class="cls_044">vm_exec.c</span><span class="cls_039"> file, which</span></div>
<div style="position:absolute;left:120.50px;top:483.16px" class="cls_039"><span class="cls_039">contains the primary YARV instruction loop that steps through the YARV instruc-</span></div>
<div style="position:absolute;left:120.50px;top:495.16px" class="cls_039"><span class="cls_039">tions in your program one after another and calls the C code corresponding to</span></div>
<div style="position:absolute;left:120.50px;top:507.16px" class="cls_039"><span class="cls_039">each one.</span></div>
<div style="position:absolute;left:120.50px;top:536.60px" class="cls_051"><span class="cls_051">1. That is, Ruby is required to build Ruby. This design is based on the assumption that Ruby developers</span></div>
<div style="position:absolute;left:120.51px;top:545.60px" class="cls_051"><span class="cls_051">have Ruby in their development environments. The public source distribution includes the generated</span></div>
<div style="position:absolute;left:120.51px;top:554.60px" class="cls_052"><span class="cls_052">vm.inc</span><span class="cls_051">, so you do not need Ruby if you use it.</span></div>
<div style="position:absolute;left:48.00px;top:633.00px" class="cls_020"><span class="cls_020">64</span></div>
<div style="position:absolute;left:70.07px;top:636.00px" class="cls_021"><span class="cls_021">Chapter 3</span></div>
</div>
<div style="position:absolute;left:50%;margin-left:-252px;top:57460px;width:504px;height:666px;border-style:outset;overflow:hidden">
<div style="position:absolute;left:0px;top:0px">
<img src="e698b76e-46bd-11eb-8b25-0cc47a792c0a_id_e698b76e-46bd-11eb-8b25-0cc47a792c0a_files/background089.jpg" width=504 height=666></div>
<div style="position:absolute;left:123.00px;top:42.63px" class="cls_031"><span class="cls_031">Experiment 3-1: Benchmarking Ruby 2.0 and</span></div>
<div style="position:absolute;left:123.00px;top:57.63px" class="cls_031"><span class="cls_031">Ruby 1.9 vs. Ruby 1.8</span></div>
<div style="position:absolute;left:123.00px;top:77.63px" class="cls_007"><span class="cls_007">The Ruby core team introduced the YARV virtual machine with Ruby 1.9.</span></div>
<div style="position:absolute;left:123.00px;top:89.63px" class="cls_007"><span class="cls_007">Earlier versions of Ruby executed programs by directly stepping through</span></div>
<div style="position:absolute;left:123.00px;top:101.63px" class="cls_007"><span class="cls_007">the nodes of the </span><span class="cls_008">abstract syntax tree (AST)</span><span class="cls_007">. There was no compile step: Ruby</span></div>
<div style="position:absolute;left:123.00px;top:113.63px" class="cls_007"><span class="cls_007">just tokenized, parsed, and then immediately executed your code.</span></div>
<div style="position:absolute;left:141.00px;top:125.63px" class="cls_007"><span class="cls_007">Ruby 1.8 worked just fine. In fact, for years it was the most commonly</span></div>
<div style="position:absolute;left:123.00px;top:137.63px" class="cls_007"><span class="cls_007">used version. Then why did the Ruby core team do all of the extra work</span></div>
<div style="position:absolute;left:123.00px;top:149.63px" class="cls_007"><span class="cls_007">required to write a compiler and a new virtual machine? Speed. Executing</span></div>
<div style="position:absolute;left:123.00px;top:161.63px" class="cls_007"><span class="cls_007">a compiled Ruby program using YARV is much faster than walking through</span></div>
<div style="position:absolute;left:123.00px;top:173.63px" class="cls_007"><span class="cls_007">the AST directly.</span></div>
<div style="position:absolute;left:141.00px;top:185.63px" class="cls_007"><span class="cls_007">How much faster is YARV? Let’s take a look! In this experiment, we’ll</span></div>
<div style="position:absolute;left:123.00px;top:197.63px" class="cls_007"><span class="cls_007">measure how much faster Ruby 2.0 and 1.9 are compared to Ruby 1.8 by</span></div>
<div style="position:absolute;left:123.00px;top:209.63px" class="cls_007"><span class="cls_007">executing the very simple Ruby script shown in Listing 3-5.</span></div>
<div style="position:absolute;left:123.00px;top:233.63px" class="cls_030"><span class="cls_030">i = 0</span></div>
<div style="position:absolute;left:123.00px;top:244.12px" class="cls_030"><span class="cls_030">while i &lt; ARGV[0].to_i</span></div>
<div style="position:absolute;left:131.50px;top:254.62px" class="cls_030"><span class="cls_030">i += 1</span></div>
<div style="position:absolute;left:123.00px;top:265.12px" class="cls_030"><span class="cls_030">end</span></div>
<div style="position:absolute;left:123.00px;top:287.62px" class="cls_038"><span class="cls_038">Listing 3-5: A simple test script for benchmarking Ruby 2.0 and Ruby 1.9 vs. Ruby 1.8</span></div>
<div style="position:absolute;left:141.00px;top:310.13px" class="cls_007"><span class="cls_007">This script receives a count value from the command line via the </span><span class="cls_030">ARGV</span></div>
<div style="position:absolute;left:123.00px;top:322.13px" class="cls_007"><span class="cls_007">array and then just iterates in a </span><span class="cls_030">while</span><span class="cls_007"> loop counting up to that value. This</span></div>
<div style="position:absolute;left:123.00px;top:334.13px" class="cls_007"><span class="cls_007">Ruby script is very, very simple: By measuring the time it takes to execute</span></div>
<div style="position:absolute;left:123.00px;top:346.13px" class="cls_007"><span class="cls_007">this script for different values of </span><span class="cls_030">ARGV[0]</span><span class="cls_007">, we should get a good sense of</span></div>
<div style="position:absolute;left:123.00px;top:358.13px" class="cls_007"><span class="cls_007">whether executing YARV instructions is actually faster than iterating over</span></div>
<div style="position:absolute;left:123.00px;top:370.13px" class="cls_007"><span class="cls_007">AST nodes. (There are no database calls or other external code involved.)</span></div>
<div style="position:absolute;left:141.00px;top:382.13px" class="cls_007"><span class="cls_007">We can use the Unix </span><span class="cls_030">time</span><span class="cls_007"> command to measure how long it takes Ruby</span></div>
<div style="position:absolute;left:123.00px;top:394.13px" class="cls_007"><span class="cls_007">to iterate one time:</span></div>
<div style="position:absolute;left:123.00px;top:418.13px" class="cls_030"><span class="cls_030">$ </span><span class="cls_040">time ruby benchmark1.rb</span><span class="cls_030"> 1</span></div>
<div style="position:absolute;left:123.00px;top:428.62px" class="cls_030"><span class="cls_030">ruby benchmark1.rb 1</span></div>
<div style="position:absolute;left:216.50px;top:428.62px" class="cls_030"><span class="cls_030">0.02s user 0.00s system 92% cpu 0.023 total</span></div>
<div style="position:absolute;left:123.00px;top:451.13px" class="cls_007"><span class="cls_007">ten times:</span></div>
<div style="position:absolute;left:123.00px;top:475.13px" class="cls_030"><span class="cls_030">$ </span><span class="cls_040">time ruby benchmark1.rb 10</span></div>
<div style="position:absolute;left:123.00px;top:485.62px" class="cls_030"><span class="cls_030">ruby benchmark1.rb 10</span></div>
<div style="position:absolute;left:220.75px;top:485.62px" class="cls_030"><span class="cls_030">0.02s user 0.00s system 94% cpu 0.027 total</span></div>
<div style="position:absolute;left:123.00px;top:508.13px" class="cls_007"><span class="cls_007">and so on.</span></div>
<div style="position:absolute;left:141.00px;top:520.13px" class="cls_007"><span class="cls_007">Figure 3-14 shows a plot of the measured times on a logarithmic scale</span></div>
<div style="position:absolute;left:123.00px;top:532.13px" class="cls_007"><span class="cls_007">for Ruby 1.8.7, 1.9.3, and 2.0.</span></div>
<div style="position:absolute;left:349.54px;top:636.00px" class="cls_021"><span class="cls_021">How Ruby Executes Your Code</span></div>
<div style="position:absolute;left:447.14px;top:633.00px" class="cls_020"><span class="cls_020">65</span></div>
</div>
<div style="position:absolute;left:50%;margin-left:-252px;top:58136px;width:504px;height:666px;border-style:outset;overflow:hidden">
<div style="position:absolute;left:0px;top:0px">
<img src="e698b76e-46bd-11eb-8b25-0cc47a792c0a_id_e698b76e-46bd-11eb-8b25-0cc47a792c0a_files/background090.jpg" width=504 height=666></div>
<div style="position:absolute;left:134.45px;top:44.29px" class="cls_081"><span class="cls_081">100</span></div>
<div style="position:absolute;left:137.99px;top:90.19px" class="cls_081"><span class="cls_081">10</span></div>
<div style="position:absolute;left:141.53px;top:136.08px" class="cls_081"><span class="cls_081">1</span></div>
<div style="position:absolute;left:136.21px;top:181.98px" class="cls_081"><span class="cls_081">0.1</span></div>
<div style="position:absolute;left:388.11px;top:215.77px" class="cls_082"><span class="cls_082">Ruby 1.8.7</span></div>
<div style="position:absolute;left:132.66px;top:227.88px" class="cls_081"><span class="cls_081">0.01</span></div>
<div style="position:absolute;left:388.11px;top:229.14px" class="cls_082"><span class="cls_082">Ruby 1.9.3</span></div>
<div style="position:absolute;left:388.11px;top:242.52px" class="cls_082"><span class="cls_082">Ruby 2.0</span></div>
<div style="position:absolute;left:129.12px;top:273.77px" class="cls_081"><span class="cls_081">0.001</span></div>
<div style="position:absolute;left:180.31px;top:281.81px" class="cls_081"><span class="cls_081">10</span></div>
<div style="position:absolute;left:215.26px;top:281.81px" class="cls_081"><span class="cls_081">100</span></div>
<div style="position:absolute;left:250.20px;top:281.81px" class="cls_081"><span class="cls_081">1000</span></div>
<div style="position:absolute;left:284.26px;top:281.81px" class="cls_081"><span class="cls_081">10,000</span></div>
<div style="position:absolute;left:319.21px;top:281.81px" class="cls_081"><span class="cls_081">100,000</span></div>
<div style="position:absolute;left:356.63px;top:281.81px" class="cls_081"><span class="cls_081">1 million</span></div>
<div style="position:absolute;left:391.58px;top:281.81px" class="cls_081"><span class="cls_081">10 million</span></div>
<div style="position:absolute;left:426.52px;top:281.81px" class="cls_081"><span class="cls_081">100 million</span></div>
<div style="position:absolute;left:264.07px;top:293.65px" class="cls_082"><span class="cls_082">Number of Iterations</span></div>
<div style="position:absolute;left:120.00px;top:310.34px" class="cls_038"><span class="cls_038">Figure 3-14: Performance of Ruby 1.8.7 vs. Ruby 1.9.3 and Ruby 2.0; time (in seconds) vs.</span></div>
<div style="position:absolute;left:120.00px;top:320.83px" class="cls_038"><span class="cls_038">number of iterations on a logarithmic scale</span></div>
<div style="position:absolute;left:138.00px;top:343.34px" class="cls_007"><span class="cls_007">Looking at the chart, you can see that for short-lived processes, such</span></div>
<div style="position:absolute;left:120.00px;top:355.34px" class="cls_007"><span class="cls_007">as loops with a small number of iterations (see the left side of Figure 3-14),</span></div>
<div style="position:absolute;left:120.00px;top:367.34px" class="cls_007"><span class="cls_007">Ruby 1.8.7 is actually faster than Ruby 1.9.3 and 2.0 because there is no</span></div>
<div style="position:absolute;left:120.00px;top:379.34px" class="cls_007"><span class="cls_007">need to compile the Ruby code into YARV instructions. Instead, after</span></div>
<div style="position:absolute;left:120.00px;top:391.34px" class="cls_007"><span class="cls_007">tokenizing and parsing the code, Ruby 1.8.7 immediately executes it. The</span></div>
<div style="position:absolute;left:120.00px;top:403.34px" class="cls_007"><span class="cls_007">time difference between Ruby 1.8.7 and Ruby 1.9.3 and 2.0 at the left side</span></div>
<div style="position:absolute;left:120.00px;top:415.34px" class="cls_007"><span class="cls_007">of the chart, about 0.01 seconds, tells us how long it takes Ruby 1.9.3 or</span></div>
<div style="position:absolute;left:120.00px;top:427.34px" class="cls_007"><span class="cls_007">2.0 to compile the script into YARV instructions. You can also see that</span></div>
<div style="position:absolute;left:120.00px;top:439.34px" class="cls_007"><span class="cls_007">Ruby 2.0 is actually a bit slower than Ruby 1.9.3 for short loops.</span></div>
<div style="position:absolute;left:138.00px;top:451.34px" class="cls_007"><span class="cls_007">However, after about 11,000 iterations, Ruby 1.9.3 and 2.0 are faster.</span></div>
<div style="position:absolute;left:120.00px;top:463.34px" class="cls_007"><span class="cls_007">This crossover occurs when the additional speed provided by executing</span></div>
<div style="position:absolute;left:120.00px;top:475.34px" class="cls_007"><span class="cls_007">YARV instructions begins to pay off and make up for the additional time</span></div>
<div style="position:absolute;left:120.00px;top:487.34px" class="cls_007"><span class="cls_007">spent compiling. For long-lived processes, such as loops with a large number</span></div>
<div style="position:absolute;left:120.00px;top:499.34px" class="cls_007"><span class="cls_007">of iterations (see the right side of Figure 3-14), Ruby 1.9 and 2.0 are about</span></div>
<div style="position:absolute;left:120.00px;top:511.34px" class="cls_007"><span class="cls_007">4.25 times faster! Also, we can see that Ruby 2.0 and 1.9.3 execute YARV</span></div>
<div style="position:absolute;left:120.00px;top:523.34px" class="cls_007"><span class="cls_007">instructions at exactly the same speed for many iterations.</span></div>
<div style="position:absolute;left:138.00px;top:535.34px" class="cls_007"><span class="cls_007">This speed up doesn’t look like much on the logarithmic chart in</span></div>
<div style="position:absolute;left:120.00px;top:547.34px" class="cls_007"><span class="cls_007">Figure 3-14, but notice what happens if we redraw the right side of this</span></div>
<div style="position:absolute;left:120.00px;top:559.34px" class="cls_007"><span class="cls_007">chart using a linear scale instead, as shown in Figure 3-15.</span></div>
<div style="position:absolute;left:48.00px;top:633.00px" class="cls_020"><span class="cls_020">66</span></div>
<div style="position:absolute;left:70.03px;top:636.00px" class="cls_021"><span class="cls_021">Chapter 3</span></div>
</div>
<div style="position:absolute;left:50%;margin-left:-252px;top:58812px;width:504px;height:666px;border-style:outset;overflow:hidden">
<div style="position:absolute;left:0px;top:0px">
<img src="e698b76e-46bd-11eb-8b25-0cc47a792c0a_id_e698b76e-46bd-11eb-8b25-0cc47a792c0a_files/background091.jpg" width=504 height=666></div>
<div style="position:absolute;left:138.90px;top:44.29px" class="cls_081"><span class="cls_081">64</span></div>
<div style="position:absolute;left:138.90px;top:58.25px" class="cls_081"><span class="cls_081">60</span></div>
<div style="position:absolute;left:138.90px;top:76.52px" class="cls_081"><span class="cls_081">55</span></div>
<div style="position:absolute;left:138.90px;top:94.78px" class="cls_081"><span class="cls_081">50</span></div>
<div style="position:absolute;left:138.90px;top:113.05px" class="cls_081"><span class="cls_081">45</span></div>
<div style="position:absolute;left:138.90px;top:131.31px" class="cls_081"><span class="cls_081">40</span></div>
<div style="position:absolute;left:414.53px;top:129.26px" class="cls_082"><span class="cls_082">Ruby 1.8.7</span></div>
<div style="position:absolute;left:414.53px;top:142.63px" class="cls_082"><span class="cls_082">Ruby 1.9.3</span></div>
<div style="position:absolute;left:138.90px;top:149.58px" class="cls_081"><span class="cls_081">35</span></div>
<div style="position:absolute;left:414.53px;top:156.00px" class="cls_082"><span class="cls_082">Ruby 2.0</span></div>
<div style="position:absolute;left:138.90px;top:167.85px" class="cls_081"><span class="cls_081">30</span></div>
<div style="position:absolute;left:138.90px;top:186.11px" class="cls_081"><span class="cls_081">25</span></div>
<div style="position:absolute;left:138.90px;top:204.38px" class="cls_081"><span class="cls_081">20</span></div>
<div style="position:absolute;left:138.90px;top:222.65px" class="cls_081"><span class="cls_081">15</span></div>
<div style="position:absolute;left:138.90px;top:240.92px" class="cls_081"><span class="cls_081">10</span></div>
<div style="position:absolute;left:142.45px;top:259.18px" class="cls_081"><span class="cls_081">5</span></div>
<div style="position:absolute;left:142.45px;top:277.44px" class="cls_081"><span class="cls_081">0</span></div>
<div style="position:absolute;left:247.45px;top:283.20px" class="cls_081"><span class="cls_081">10 million</span></div>
<div style="position:absolute;left:369.43px;top:283.20px" class="cls_081"><span class="cls_081">100 million</span></div>
<div style="position:absolute;left:273.09px;top:292.71px" class="cls_082"><span class="cls_082">Number of Iterations</span></div>
<div style="position:absolute;left:123.00px;top:309.40px" class="cls_038"><span class="cls_038">Figure 3-15: Performance of Ruby 1.8.7 vs. Ruby 1.9.3 vs. Ruby 2.0; time (in seconds) for</span></div>
<div style="position:absolute;left:123.00px;top:319.89px" class="cls_038"><span class="cls_038">10 or 100 million iterations on a linear scale</span></div>
<div style="position:absolute;left:141.00px;top:342.40px" class="cls_007"><span class="cls_007">The difference is dramatic! Executing this simple Ruby script using</span></div>
<div style="position:absolute;left:123.00px;top:354.40px" class="cls_007"><span class="cls_007">Ruby 1.9.3 or Ruby 2.0 with YARV is about 4.25 times faster than it is</span></div>
<div style="position:absolute;left:123.00px;top:366.40px" class="cls_007"><span class="cls_007">using Ruby 1.8.7 without YARV.</span></div>
<div style="position:absolute;left:69.00px;top:400.40px" class="cls_031"><span class="cls_031">Local and Dynamic Access of Ruby Variables</span></div>
<div style="position:absolute;left:123.00px;top:420.40px" class="cls_007"><span class="cls_007">In the previous section, we saw how Ruby maintained an internal stack used</span></div>
<div style="position:absolute;left:123.00px;top:432.40px" class="cls_007"><span class="cls_007">by YARV as well as your Ruby program’s call stack. But something obvious</span></div>
<div style="position:absolute;left:123.00px;top:444.40px" class="cls_007"><span class="cls_007">was missing from both of the code examples: variables. Neither script used</span></div>
<div style="position:absolute;left:123.00px;top:456.40px" class="cls_007"><span class="cls_007">any Ruby variables. A more realistic example program would have used vari-</span></div>
<div style="position:absolute;left:123.00px;top:468.40px" class="cls_007"><span class="cls_007">ables many times. How does Ruby handle variables internally? And where</span></div>
<div style="position:absolute;left:123.00px;top:480.40px" class="cls_007"><span class="cls_007">are they stored?</span></div>
<div style="position:absolute;left:141.00px;top:492.40px" class="cls_007"><span class="cls_007">Ruby stores all of the values you save in variables on YARV’s stack,</span></div>
<div style="position:absolute;left:123.00px;top:504.40px" class="cls_007"><span class="cls_007">along with the parameters to and return values from the YARV instruc-</span></div>
<div style="position:absolute;left:123.00px;top:516.40px" class="cls_007"><span class="cls_007">tions. However, accessing these variables is not so simple. Internally, Ruby</span></div>
<div style="position:absolute;left:123.00px;top:528.40px" class="cls_007"><span class="cls_007">uses two very different methods for saving and retrieving a value you save</span></div>
<div style="position:absolute;left:123.00px;top:540.40px" class="cls_007"><span class="cls_007">in a variable: </span><span class="cls_008">local access</span><span class="cls_007"> and </span><span class="cls_008">dynamic access</span><span class="cls_007">.</span></div>
<div style="position:absolute;left:123.00px;top:565.40px" class="cls_055"><span class="cls_055">Local Variable Access</span></div>
<div style="position:absolute;left:123.00px;top:583.40px" class="cls_007"><span class="cls_007">Whenever you make a method call, Ruby sets aside some space on the YARV</span></div>
<div style="position:absolute;left:123.00px;top:595.40px" class="cls_007"><span class="cls_007">stack for any local variables declared inside the method you are calling.</span></div>
<div style="position:absolute;left:349.62px;top:636.00px" class="cls_021"><span class="cls_021">How Ruby Executes Your Code</span></div>
<div style="position:absolute;left:447.23px;top:633.00px" class="cls_020"><span class="cls_020">67</span></div>
</div>
<div style="position:absolute;left:50%;margin-left:-252px;top:59488px;width:504px;height:666px;border-style:outset;overflow:hidden">
<div style="position:absolute;left:0px;top:0px">
<img src="e698b76e-46bd-11eb-8b25-0cc47a792c0a_id_e698b76e-46bd-11eb-8b25-0cc47a792c0a_files/background092.jpg" width=504 height=666></div>
<div style="position:absolute;left:120.00px;top:41.60px" class="cls_007"><span class="cls_007">Ruby knows how many variables you are using by consulting the </span><span class="cls_008">local table</span></div>
<div style="position:absolute;left:120.00px;top:53.60px" class="cls_007"><span class="cls_007">created for each method during the compilation step discussed in “The</span></div>
<div style="position:absolute;left:120.00px;top:65.60px" class="cls_007"><span class="cls_007">Local Table” on page 46.</span></div>
<div style="position:absolute;left:138.00px;top:77.60px" class="cls_007"><span class="cls_007">For example, suppose we write the silly Ruby function you see in</span></div>
<div style="position:absolute;left:120.00px;top:89.60px" class="cls_007"><span class="cls_007">Figure 3-16.</span></div>
<div style="position:absolute;left:126.00px;top:116.29px" class="cls_014"><span class="cls_014">def display_string</span></div>
<div style="position:absolute;left:134.00px;top:125.90px" class="cls_014"><span class="cls_014">str = "Local access."</span></div>
<div style="position:absolute;left:134.00px;top:135.50px" class="cls_014"><span class="cls_014">puts str</span></div>
<div style="position:absolute;left:352.94px;top:142.30px" class="cls_014"><span class="cls_014">SP</span></div>
<div style="position:absolute;left:126.00px;top:145.09px" class="cls_014"><span class="cls_014">end</span></div>
<div style="position:absolute;left:278.03px;top:154.40px" class="cls_014"><span class="cls_014">special</span></div>
<div style="position:absolute;left:274.03px;top:167.90px" class="cls_014"><span class="cls_014">svar/cref</span></div>
<div style="position:absolute;left:319.87px;top:167.61px" class="cls_054"><span class="cls_054">Variables</span></div>
<div style="position:absolute;left:286.03px;top:181.40px" class="cls_014"><span class="cls_014">str</span></div>
<div style="position:absolute;left:120.00px;top:202.00px" class="cls_038"><span class="cls_038">Figure 3-16: An example Ruby script that uses a local variable</span></div>
<div style="position:absolute;left:138.00px;top:224.50px" class="cls_007"><span class="cls_007">The Ruby code is at the left of the figure; on the right is a diagram</span></div>
<div style="position:absolute;left:120.00px;top:236.50px" class="cls_007"><span class="cls_007">showing the YARV stack and stack pointer. You can see that Ruby stores the</span></div>
<div style="position:absolute;left:120.00px;top:248.50px" class="cls_007"><span class="cls_007">variables on the stack just under the stack pointer. (Notice that a space is</span></div>
<div style="position:absolute;left:120.00px;top:260.50px" class="cls_007"><span class="cls_007">reserved for the </span><span class="cls_030">str</span><span class="cls_007"> value on the stack, three slots under </span><span class="cls_030">SP</span><span class="cls_007">, at </span><span class="cls_030">SP-3</span><span class="cls_007">.)</span></div>
<div style="position:absolute;left:138.00px;top:272.50px" class="cls_007"><span class="cls_007">Ruby uses </span><span class="cls_030">svar/cref</span><span class="cls_007"> to contain one of two things: either a pointer to a</span></div>
<div style="position:absolute;left:120.00px;top:284.50px" class="cls_007"><span class="cls_007">table of the special variables in the current method (values such as </span><span class="cls_030">$!</span><span class="cls_007"> for</span></div>
<div style="position:absolute;left:120.00px;top:296.50px" class="cls_008"><span class="cls_008">last exception message</span><span class="cls_007"> or </span><span class="cls_030">$&</span><span class="cls_007"> for </span><span class="cls_008">last regular expression match</span><span class="cls_007">) or to the current</span></div>
<div style="position:absolute;left:120.00px;top:308.50px" class="cls_007"><span class="cls_007">lexical scope. In this context, </span><span class="cls_008">lexical scope</span><span class="cls_007"> indicates which class or module</span></div>
<div style="position:absolute;left:120.00px;top:320.50px" class="cls_007"><span class="cls_007">you are currently adding methods to. (In Experiment 3-2 we’ll explore</span></div>
<div style="position:absolute;left:120.00px;top:332.50px" class="cls_007"><span class="cls_007">special variables in more detail, and I’ll discuss lexical scope further in</span></div>
<div style="position:absolute;left:120.00px;top:344.50px" class="cls_007"><span class="cls_007">Chapter 6.) Ruby uses the first slot—the </span><span class="cls_030">special</span><span class="cls_007"> variable—to track informa-</span></div>
<div style="position:absolute;left:120.00px;top:356.50px" class="cls_007"><span class="cls_007">tion related to blocks. (More in a moment when we discuss dynamic vari-</span></div>
<div style="position:absolute;left:120.00px;top:368.50px" class="cls_007"><span class="cls_007">able access.)</span></div>
<div style="position:absolute;left:138.00px;top:380.50px" class="cls_007"><span class="cls_007">When the example code saves a value into </span><span class="cls_030">str</span><span class="cls_007">, Ruby just needs to write</span></div>
<div style="position:absolute;left:120.00px;top:392.50px" class="cls_007"><span class="cls_007">the value into that space on the stack, as shown in Figure 3-17.</span></div>
<div style="position:absolute;left:126.00px;top:419.20px" class="cls_083"><span class="cls_083">def display_string</span></div>
<div style="position:absolute;left:134.00px;top:428.80px" class="cls_014"><span class="cls_014">str</span><span class="cls_083"> =  Local access.</span></div>
<div style="position:absolute;left:134.00px;top:438.40px" class="cls_083"><span class="cls_083">puts str</span></div>
<div style="position:absolute;left:352.94px;top:444.70px" class="cls_014"><span class="cls_014">SP</span></div>
<div style="position:absolute;left:126.00px;top:448.00px" class="cls_083"><span class="cls_083">end</span></div>
<div style="position:absolute;left:278.04px;top:456.80px" class="cls_014"><span class="cls_014">special</span></div>
<div style="position:absolute;left:352.94px;top:457.60px" class="cls_014"><span class="cls_014">EP</span></div>
<div style="position:absolute;left:274.04px;top:470.30px" class="cls_014"><span class="cls_014">svar/cref</span></div>
<div style="position:absolute;left:286.04px;top:483.80px" class="cls_014"><span class="cls_014">str</span></div>
<div style="position:absolute;left:120.00px;top:504.90px" class="cls_038"><span class="cls_038">Figure 3-17: Ruby saves local variables on its stack near the</span></div>
<div style="position:absolute;left:120.00px;top:515.40px" class="cls_038"><span class="cls_038">environment pointer (</span><span class="cls_014">EP</span><span class="cls_038">).</span></div>
<div style="position:absolute;left:138.00px;top:537.90px" class="cls_007"><span class="cls_007">To implement this internally, YARV uses another pointer similar to the</span></div>
<div style="position:absolute;left:120.00px;top:549.90px" class="cls_007"><span class="cls_007">stack pointer, called the </span><span class="cls_030">EP</span><span class="cls_007"> or </span><span class="cls_008">environment pointer</span><span class="cls_007">. This points to where the</span></div>
<div style="position:absolute;left:120.01px;top:561.90px" class="cls_007"><span class="cls_007">local variables for the current method are located on the stack. Initially, </span><span class="cls_030">EP</span></div>
<div style="position:absolute;left:120.00px;top:573.90px" class="cls_007"><span class="cls_007">is set to </span><span class="cls_030">SP-1</span><span class="cls_007">. Later on, the value of </span><span class="cls_030">SP</span><span class="cls_007"> will change as YARV executes instruc-</span></div>
<div style="position:absolute;left:120.00px;top:585.90px" class="cls_007"><span class="cls_007">tions, while the </span><span class="cls_030">EP</span><span class="cls_007"> value will normally remain constant.</span></div>
<div style="position:absolute;left:138.00px;top:597.90px" class="cls_007"><span class="cls_007">Figure 3-18 shows the YARV instructions that Ruby compiled my</span></div>
<div style="position:absolute;left:120.00px;top:609.90px" class="cls_030"><span class="cls_030">display_string</span><span class="cls_007"> function into.</span></div>
<div style="position:absolute;left:48.00px;top:633.00px" class="cls_020"><span class="cls_020">68</span></div>
<div style="position:absolute;left:70.06px;top:636.00px" class="cls_021"><span class="cls_021">Chapter 3</span></div>
</div>
<div style="position:absolute;left:50%;margin-left:-252px;top:60164px;width:504px;height:666px;border-style:outset;overflow:hidden">
<div style="position:absolute;left:0px;top:0px">
<img src="e698b76e-46bd-11eb-8b25-0cc47a792c0a_id_e698b76e-46bd-11eb-8b25-0cc47a792c0a_files/background093.jpg" width=504 height=666></div>
<div style="position:absolute;left:446.79px;top:60.66px" class="cls_014"><span class="cls_014">SP</span></div>
<div style="position:absolute;left:129.00px;top:64.90px" class="cls_014"><span class="cls_014">putstring</span></div>
<div style="position:absolute;left:215.00px;top:64.90px" class="cls_014"><span class="cls_014">"Local access."</span></div>
<div style="position:absolute;left:129.00px;top:74.56px" class="cls_014"><span class="cls_014">setlocal_OP__WC__0</span></div>
<div style="position:absolute;left:215.00px;top:74.56px" class="cls_014"><span class="cls_014">2</span></div>
<div style="position:absolute;left:341.13px;top:74.56px" class="cls_014"><span class="cls_014">"Local access."</span></div>
<div style="position:absolute;left:129.00px;top:84.22px" class="cls_014"><span class="cls_014">putself</span></div>
<div style="position:absolute;left:357.13px;top:87.32px" class="cls_014"><span class="cls_014">special</span></div>
<div style="position:absolute;left:446.79px;top:87.41px" class="cls_014"><span class="cls_014">EP</span></div>
<div style="position:absolute;left:129.00px;top:93.89px" class="cls_014"><span class="cls_014">getlocal_OP__WC__0</span></div>
<div style="position:absolute;left:215.00px;top:93.89px" class="cls_014"><span class="cls_014">2</span></div>
<div style="position:absolute;left:353.13px;top:100.88px" class="cls_014"><span class="cls_014">svar/cref</span></div>
<div style="position:absolute;left:129.00px;top:103.55px" class="cls_014"><span class="cls_014">opt_send_simple</span></div>
<div style="position:absolute;left:215.00px;top:103.55px" class="cls_014"><span class="cls_014">&lt;callinfo!mid:puts,</span></div>
<div style="position:absolute;left:215.00px;top:113.22px" class="cls_014"><span class="cls_014">argc:1</span></div>
<div style="position:absolute;left:365.13px;top:114.44px" class="cls_014"><span class="cls_014">str</span></div>
<div style="position:absolute;left:123.00px;top:149.85px" class="cls_038"><span class="cls_038">Figure 3-18: The </span><span class="cls_014">display_string</span><span class="cls_038"> method compiled into YARV instructions</span></div>
<div style="position:absolute;left:141.00px;top:172.35px" class="cls_007"><span class="cls_007">Ruby uses the </span><span class="cls_030">setlocal</span><span class="cls_007"> YARV instruction to set the value of a local</span></div>
<div style="position:absolute;left:123.00px;top:184.35px" class="cls_007"><span class="cls_007">variable. However, instead of </span><span class="cls_030">setlocal</span><span class="cls_007"> in Figure 3-18, I show an instruction</span></div>
<div style="position:absolute;left:123.00px;top:196.35px" class="cls_007"><span class="cls_007">called </span><span class="cls_030">setlocal_OP__WC__0</span><span class="cls_007">.</span></div>
<div style="position:absolute;left:141.00px;top:208.35px" class="cls_007"><span class="cls_007">As it turns out, beginning with version 2.0, Ruby uses an optimized</span></div>
<div style="position:absolute;left:123.00px;top:220.35px" class="cls_007"><span class="cls_007">instruction with this confusing name instead of the simple </span><span class="cls_030">setlocal</span><span class="cls_007">. The</span></div>
<div style="position:absolute;left:123.00px;top:232.35px" class="cls_007"><span class="cls_007">difference is that Ruby 2.0 includes one of the parameters of the instruc-</span></div>
<div style="position:absolute;left:123.00px;top:244.35px" class="cls_007"><span class="cls_007">tion, </span><span class="cls_030">0</span><span class="cls_007">, in the instruction name itself.</span></div>
<div style="position:absolute;left:141.00px;top:256.35px" class="cls_007"><span class="cls_007">Internally, Ruby 2.0 calls this the </span><span class="cls_008">operand</span><span class="cls_007"> optimization. (In the opti-</span></div>
<div style="position:absolute;left:122.99px;top:268.35px" class="cls_007"><span class="cls_007">mized instruction name, </span><span class="cls_008">OP</span><span class="cls_007"> stands for </span><span class="cls_008">operand</span><span class="cls_007"> and </span><span class="cls_008">WC</span><span class="cls_007"> for </span><span class="cls_008">wildcard</span><span class="cls_007">.) In</span></div>
<div style="position:absolute;left:122.99px;top:280.35px" class="cls_007"><span class="cls_007">other words, </span><span class="cls_030">getlocal_OP__WC__0</span><span class="cls_007"> is equivalent to </span><span class="cls_030">getlocal *, 0</span><span class="cls_007">, and </span><span class="cls_030">setlocal_</span></div>
<div style="position:absolute;left:123.00px;top:292.35px" class="cls_030"><span class="cls_030">OP__WC__0</span><span class="cls_007"> is the same as </span><span class="cls_030">setlocal *, 0</span><span class="cls_007">. The instruction now requires only one</span></div>
<div style="position:absolute;left:123.00px;top:304.35px" class="cls_007"><span class="cls_007">parameter, as indicated by </span><span class="cls_030">*</span><span class="cls_007">. This trick allows Ruby 2.0 to save a bit of time</span></div>
<div style="position:absolute;left:123.00px;top:316.35px" class="cls_007"><span class="cls_007">because it doesn’t need to pass the </span><span class="cls_030">0</span><span class="cls_007"> argument separately.</span></div>
<div style="position:absolute;left:141.00px;top:328.35px" class="cls_007"><span class="cls_007">But to keep things simple, let’s ignore the operand optimization.</span></div>
<div style="position:absolute;left:123.00px;top:340.35px" class="cls_007"><span class="cls_007">Figure 3-19 repeats the YARV instructions for my example but shows</span></div>
<div style="position:absolute;left:123.00px;top:352.35px" class="cls_030"><span class="cls_030">getlocal</span><span class="cls_007"> and </span><span class="cls_030">setlocal</span><span class="cls_007"> with the second operand listed normally.</span></div>
<div style="position:absolute;left:129.00px;top:393.39px" class="cls_014"><span class="cls_014">putstring</span></div>
<div style="position:absolute;left:215.01px;top:394.11px" class="cls_014"><span class="cls_014">"Local access."</span></div>
<div style="position:absolute;left:446.79px;top:391.68px" class="cls_014"><span class="cls_014">SP</span></div>
<div style="position:absolute;left:129.00px;top:403.36px" class="cls_014"><span class="cls_014">setlocal</span></div>
<div style="position:absolute;left:215.01px;top:404.08px" class="cls_014"><span class="cls_014">2, 0</span></div>
<div style="position:absolute;left:341.14px;top:404.33px" class="cls_014"><span class="cls_014">"Local access."</span></div>
<div style="position:absolute;left:129.00px;top:413.34px" class="cls_014"><span class="cls_014">putself</span></div>
<div style="position:absolute;left:357.14px;top:417.09px" class="cls_014"><span class="cls_014">special</span></div>
<div style="position:absolute;left:446.79px;top:418.42px" class="cls_014"><span class="cls_014">EP</span></div>
<div style="position:absolute;left:129.00px;top:423.32px" class="cls_014"><span class="cls_014">getlocal</span></div>
<div style="position:absolute;left:215.01px;top:424.04px" class="cls_014"><span class="cls_014">2, 0</span></div>
<div style="position:absolute;left:353.14px;top:430.65px" class="cls_014"><span class="cls_014">svar/cref</span></div>
<div style="position:absolute;left:129.00px;top:433.29px" class="cls_014"><span class="cls_014">opt_send_simple</span></div>
<div style="position:absolute;left:215.01px;top:434.01px" class="cls_014"><span class="cls_014">&lt;callinfo!mid:puts,</span></div>
<div style="position:absolute;left:215.01px;top:443.99px" class="cls_014"><span class="cls_014">argc:1</span></div>
<div style="position:absolute;left:365.14px;top:444.21px" class="cls_014"><span class="cls_014">str</span></div>
<div style="position:absolute;left:123.00px;top:477.99px" class="cls_038"><span class="cls_038">Figure 3-19: The compiled version of </span><span class="cls_014">display_string</span><span class="cls_038"> shown without operand optimization</span></div>
<div style="position:absolute;left:141.00px;top:500.49px" class="cls_007"><span class="cls_007">This a bit easier to understand. As you can see, first the </span><span class="cls_030">putstring</span><span class="cls_007"> instruc-</span></div>
<div style="position:absolute;left:123.00px;top:512.49px" class="cls_007"><span class="cls_007">tion saves the </span><span class="cls_030">Local access</span><span class="cls_007"> string on top of the stack, incrementing the </span><span class="cls_030">SP</span></div>
<div style="position:absolute;left:123.00px;top:524.49px" class="cls_007"><span class="cls_007">pointer. Then, YARV uses the </span><span class="cls_030">setlocal</span><span class="cls_007"> instruction to get the value at the top</span></div>
<div style="position:absolute;left:123.00px;top:536.49px" class="cls_007"><span class="cls_007">of the stack and save it in the space allocated on the stack for the </span><span class="cls_030">str</span><span class="cls_007"> local</span></div>
<div style="position:absolute;left:123.00px;top:548.49px" class="cls_007"><span class="cls_007">variable. The two dashed arrows on the left side of Figure 3-19 show the</span></div>
<div style="position:absolute;left:123.00px;top:560.49px" class="cls_030"><span class="cls_030">setlocal</span><span class="cls_007"> instruction copying the value. This type of operation is called </span><span class="cls_008">local</span></div>
<div style="position:absolute;left:123.00px;top:572.49px" class="cls_008"><span class="cls_008">variable access</span><span class="cls_007">.</span></div>
<div style="position:absolute;left:349.47px;top:636.00px" class="cls_021"><span class="cls_021">How Ruby Executes Your Code</span></div>
<div style="position:absolute;left:447.07px;top:633.00px" class="cls_020"><span class="cls_020">69</span></div>
</div>
<div style="position:absolute;left:50%;margin-left:-252px;top:60840px;width:504px;height:666px;border-style:outset;overflow:hidden">
<div style="position:absolute;left:0px;top:0px">
<img src="e698b76e-46bd-11eb-8b25-0cc47a792c0a_id_e698b76e-46bd-11eb-8b25-0cc47a792c0a_files/background094.jpg" width=504 height=666></div>
<div style="position:absolute;left:138.00px;top:41.60px" class="cls_007"><span class="cls_007">To determine which variable to set, </span><span class="cls_030">setlocal</span><span class="cls_007"> uses the </span><span class="cls_030">EP</span><span class="cls_007"> pointer and</span></div>
<div style="position:absolute;left:120.00px;top:53.60px" class="cls_007"><span class="cls_007">the numerical index provided as the first parameter. In this example, that</span></div>
<div style="position:absolute;left:120.00px;top:65.60px" class="cls_007"><span class="cls_007">would be </span><span class="cls_030">address of str = EP-2</span><span class="cls_007">. We’ll discuss what the second parameter, </span><span class="cls_030">0</span><span class="cls_007">,</span></div>
<div style="position:absolute;left:120.00px;top:77.60px" class="cls_007"><span class="cls_007">means in “Dynamic Variable Access” on page 71.</span></div>
<div style="position:absolute;left:138.00px;top:89.60px" class="cls_007"><span class="cls_007">Next, for the call to </span><span class="cls_030">puts str</span><span class="cls_007">, Ruby uses the </span><span class="cls_030">getlocal</span><span class="cls_007"> instruction, as</span></div>
<div style="position:absolute;left:120.00px;top:101.60px" class="cls_007"><span class="cls_007">shown in Figure 3-20.</span></div>
<div style="position:absolute;left:338.14px;top:139.57px" class="cls_014"><span class="cls_014">"Local access."</span></div>
<div style="position:absolute;left:443.79px;top:140.01px" class="cls_014"><span class="cls_014">SP</span></div>
<div style="position:absolute;left:360.14px;top:153.04px" class="cls_014"><span class="cls_014">self</span></div>
<div style="position:absolute;left:126.00px;top:163.49px" class="cls_014"><span class="cls_014">putstring</span></div>
<div style="position:absolute;left:212.01px;top:164.19px" class="cls_014"><span class="cls_014">"Local access."</span></div>
<div style="position:absolute;left:354.14px;top:166.50px" class="cls_014"><span class="cls_014">special</span></div>
<div style="position:absolute;left:443.79px;top:166.76px" class="cls_014"><span class="cls_014">EP</span></div>
<div style="position:absolute;left:126.00px;top:173.26px" class="cls_014"><span class="cls_014">setlocal</span></div>
<div style="position:absolute;left:212.01px;top:173.96px" class="cls_014"><span class="cls_014">2, 0</span></div>
<div style="position:absolute;left:350.14px;top:179.97px" class="cls_014"><span class="cls_014">svar/cref</span></div>
<div style="position:absolute;left:126.00px;top:183.02px" class="cls_014"><span class="cls_014">putself</span></div>
<div style="position:absolute;left:126.00px;top:192.79px" class="cls_014"><span class="cls_014">getlocal</span></div>
<div style="position:absolute;left:212.01px;top:193.49px" class="cls_014"><span class="cls_014">2, 0</span></div>
<div style="position:absolute;left:362.14px;top:193.44px" class="cls_014"><span class="cls_014">str</span></div>
<div style="position:absolute;left:126.00px;top:202.56px" class="cls_014"><span class="cls_014">opt_send_simple</span></div>
<div style="position:absolute;left:212.01px;top:203.26px" class="cls_014"><span class="cls_014">&lt;callinfo!mid:puts,</span></div>
<div style="position:absolute;left:212.01px;top:213.02px" class="cls_014"><span class="cls_014">argc:1</span></div>
<div style="position:absolute;left:120.00px;top:248.33px" class="cls_038"><span class="cls_038">Figure 3-20: Getting the value of a local variable using </span><span class="cls_014">getlocal</span></div>
<div style="position:absolute;left:138.00px;top:270.83px" class="cls_007"><span class="cls_007">Here, Ruby has pushed the string value back onto the top of the stack,</span></div>
<div style="position:absolute;left:120.00px;top:282.83px" class="cls_007"><span class="cls_007">where it can be used as an argument for the call to the </span><span class="cls_030">puts</span><span class="cls_007"> function. Again,</span></div>
<div style="position:absolute;left:120.00px;top:294.83px" class="cls_007"><span class="cls_007">the first parameter to </span><span class="cls_030">getlocal</span><span class="cls_007">, </span><span class="cls_030">2</span><span class="cls_007">, indicates which local variable to access.</span></div>
<div style="position:absolute;left:120.00px;top:306.83px" class="cls_007"><span class="cls_007">Ruby uses the local table for this snippet at compile time to find out </span><span class="cls_030">2</span><span class="cls_007"> cor-</span></div>
<div style="position:absolute;left:120.01px;top:318.83px" class="cls_007"><span class="cls_007">responds to the variable </span><span class="cls_030">str</span><span class="cls_007">.</span></div>
<div style="position:absolute;left:120.00px;top:343.83px" class="cls_055"><span class="cls_055">Method Arguments Are Treated Like Local Variables</span></div>
<div style="position:absolute;left:120.00px;top:361.83px" class="cls_007"><span class="cls_007">Passing in a </span><span class="cls_008">method argument</span><span class="cls_007"> works the same way as accessing a local vari-</span></div>
<div style="position:absolute;left:120.00px;top:373.83px" class="cls_007"><span class="cls_007">able, as shown in Figure 3-21.</span></div>
<div style="position:absolute;left:126.00px;top:400.53px" class="cls_014"><span class="cls_014">def display_string(str)</span></div>
<div style="position:absolute;left:134.01px;top:410.12px" class="cls_014"><span class="cls_014">puts str</span></div>
<div style="position:absolute;left:126.00px;top:419.73px" class="cls_014"><span class="cls_014">end</span></div>
<div style="position:absolute;left:352.94px;top:429.02px" class="cls_014"><span class="cls_014">SP</span></div>
<div style="position:absolute;left:319.88px;top:447.62px" class="cls_054"><span class="cls_054">Variables</span></div>
<div style="position:absolute;left:319.88px;top:470.62px" class="cls_054"><span class="cls_054">Arguments</span></div>
<div style="position:absolute;left:120.00px;top:495.23px" class="cls_038"><span class="cls_038">Figure 3-21: Ruby stores method arguments on the stack just like</span></div>
<div style="position:absolute;left:120.00px;top:505.72px" class="cls_038"><span class="cls_038">local variables.</span></div>
<div style="position:absolute;left:140.60px;top:528.23px" class="cls_007"><span class="cls_007">Method arguments are essentially the same as local variables. The only</span></div>
<div style="position:absolute;left:120.00px;top:540.23px" class="cls_007"><span class="cls_007">difference between the two is that the calling code pushes the arguments</span></div>
<div style="position:absolute;left:120.00px;top:552.23px" class="cls_007"><span class="cls_007">onto the stack before the method call even occurs. In this example there</span></div>
<div style="position:absolute;left:120.00px;top:564.23px" class="cls_007"><span class="cls_007">are no local variables, but the single argument appears on the stack just like</span></div>
<div style="position:absolute;left:120.00px;top:576.23px" class="cls_007"><span class="cls_007">a local variable, as shown in Figure 3-22.</span></div>
<div style="position:absolute;left:48.00px;top:633.00px" class="cls_020"><span class="cls_020">70</span></div>
<div style="position:absolute;left:69.81px;top:636.00px" class="cls_021"><span class="cls_021">Chapter 3</span></div>
</div>
<div style="position:absolute;left:50%;margin-left:-252px;top:61516px;width:504px;height:666px;border-style:outset;overflow:hidden">
<div style="position:absolute;left:0px;top:0px">
<img src="e698b76e-46bd-11eb-8b25-0cc47a792c0a_id_e698b76e-46bd-11eb-8b25-0cc47a792c0a_files/background095.jpg" width=504 height=666></div>
<div style="position:absolute;left:129.00px;top:49.30px" class="cls_083"><span class="cls_083">def display_string(</span><span class="cls_014">str</span><span class="cls_083">)</span></div>
<div style="position:absolute;left:137.00px;top:58.90px" class="cls_083"><span class="cls_083">puts str</span></div>
<div style="position:absolute;left:129.00px;top:68.50px" class="cls_083"><span class="cls_083">end</span></div>
<div style="position:absolute;left:355.94px;top:74.80px" class="cls_014"><span class="cls_014">SP</span></div>
<div style="position:absolute;left:281.04px;top:86.90px" class="cls_014"><span class="cls_014">special</span></div>
<div style="position:absolute;left:355.94px;top:87.70px" class="cls_014"><span class="cls_014">EP</span></div>
<div style="position:absolute;left:277.04px;top:100.41px" class="cls_014"><span class="cls_014">svar/cref</span></div>
<div style="position:absolute;left:289.04px;top:113.90px" class="cls_014"><span class="cls_014">str</span></div>
<div style="position:absolute;left:123.00px;top:135.00px" class="cls_038"><span class="cls_038">Figure 3-22: The calling code saves the argument values before the</span></div>
<div style="position:absolute;left:123.00px;top:145.50px" class="cls_038"><span class="cls_038">method is called.</span></div>
<div style="position:absolute;left:123.00px;top:181.00px" class="cls_055"><span class="cls_055">Dynamic Variable Access</span></div>
<div style="position:absolute;left:123.00px;top:199.00px" class="cls_007"><span class="cls_007">Now let’s see how dynamic variable access works and what that </span><span class="cls_030">special</span><span class="cls_007"> value</span></div>
<div style="position:absolute;left:123.00px;top:211.00px" class="cls_007"><span class="cls_007">is. Ruby uses dynamic access when you use a variable that’s defined in a dif-</span></div>
<div style="position:absolute;left:123.00px;top:223.00px" class="cls_007"><span class="cls_007">ferent scope—for example, when you write a block that references values in</span></div>
<div style="position:absolute;left:123.00px;top:235.00px" class="cls_007"><span class="cls_007">the surrounding code. Listing 3-6 shows an example.</span></div>
<div style="position:absolute;left:123.00px;top:259.00px" class="cls_030"><span class="cls_030">def display_string</span></div>
<div style="position:absolute;left:131.50px;top:269.50px" class="cls_030"><span class="cls_030">str = "Dynamic access."</span></div>
<div style="position:absolute;left:131.50px;top:279.99px" class="cls_030"><span class="cls_030">10.times do</span></div>
<div style="position:absolute;left:140.00px;top:290.49px" class="cls_030"><span class="cls_030">puts str</span></div>
<div style="position:absolute;left:131.50px;top:300.99px" class="cls_030"><span class="cls_030">end</span></div>
<div style="position:absolute;left:123.00px;top:311.49px" class="cls_030"><span class="cls_030">end</span></div>
<div style="position:absolute;left:123.00px;top:333.99px" class="cls_038"><span class="cls_038">Listing 3-6: The code inside the block accesses </span><span class="cls_014">str</span><span class="cls_038"> in the surrounding method.</span></div>
<div style="position:absolute;left:141.00px;top:356.50px" class="cls_007"><span class="cls_007">Here, </span><span class="cls_030">str</span><span class="cls_007"> is a local variable in </span><span class="cls_030">display_string</span><span class="cls_007">. As you can see in</span></div>
<div style="position:absolute;left:123.00px;top:368.50px" class="cls_007"><span class="cls_007">Figure 3-23, Ruby will save </span><span class="cls_030">str</span><span class="cls_007"> using the </span><span class="cls_030">setlocal</span><span class="cls_007"> instruction in just</span></div>
<div style="position:absolute;left:123.00px;top:380.50px" class="cls_007"><span class="cls_007">the same way we saw in Figure 3-18.</span></div>
<div style="position:absolute;left:129.00px;top:446.80px" class="cls_083"><span class="cls_083">def display_string</span></div>
<div style="position:absolute;left:137.01px;top:456.40px" class="cls_014"><span class="cls_014">str = "Dynamic access."</span></div>
<div style="position:absolute;left:137.00px;top:466.00px" class="cls_083"><span class="cls_083">10.times </span><span class="cls_084">do</span></div>
<div style="position:absolute;left:355.94px;top:471.30px" class="cls_014"><span class="cls_014">SP</span></div>
<div style="position:absolute;left:145.00px;top:475.60px" class="cls_083"><span class="cls_083">puts str</span></div>
<div style="position:absolute;left:281.04px;top:482.87px" class="cls_014"><span class="cls_014">special</span></div>
<div style="position:absolute;left:137.00px;top:485.20px" class="cls_084"><span class="cls_084">end</span></div>
<div style="position:absolute;left:129.00px;top:494.80px" class="cls_083"><span class="cls_083">end</span></div>
<div style="position:absolute;left:277.04px;top:496.14px" class="cls_014"><span class="cls_014">svar/cref</span></div>
<div style="position:absolute;left:289.04px;top:509.40px" class="cls_014"><span class="cls_014">str</span></div>
<div style="position:absolute;left:123.00px;top:530.30px" class="cls_038"><span class="cls_038">Figure 3-23: Ruby saves the value of the </span><span class="cls_014">str</span><span class="cls_038"> local variable on the</span></div>
<div style="position:absolute;left:123.00px;top:540.79px" class="cls_038"><span class="cls_038">stack as usual.</span></div>
<div style="position:absolute;left:141.00px;top:563.30px" class="cls_007"><span class="cls_007">Next, Ruby will call the </span><span class="cls_030">10.times</span><span class="cls_007"> method, passing a block in as an argu-</span></div>
<div style="position:absolute;left:123.00px;top:575.30px" class="cls_007"><span class="cls_007">ment. Let’s step through the process of calling a method with a block.</span></div>
<div style="position:absolute;left:349.57px;top:636.00px" class="cls_021"><span class="cls_021">How Ruby Executes Your Code</span></div>
<div style="position:absolute;left:447.18px;top:633.00px" class="cls_020"><span class="cls_020">71</span></div>
</div>
<div style="position:absolute;left:50%;margin-left:-252px;top:62192px;width:504px;height:666px;border-style:outset;overflow:hidden">
<div style="position:absolute;left:0px;top:0px">
<img src="e698b76e-46bd-11eb-8b25-0cc47a792c0a_id_e698b76e-46bd-11eb-8b25-0cc47a792c0a_files/background096.jpg" width=504 height=666></div>
<div style="position:absolute;left:120.00px;top:41.60px" class="cls_007"><span class="cls_007">Figure 3-24 shows the same process we saw in Figures 3-10, 3-11, and 3-12</span></div>
<div style="position:absolute;left:120.00px;top:53.60px" class="cls_007"><span class="cls_007">but with more details about YARV’s internal stack.</span></div>
<div style="position:absolute;left:126.00px;top:105.70px" class="cls_083"><span class="cls_083">def display_string</span></div>
<div style="position:absolute;left:352.94px;top:105.00px" class="cls_014"><span class="cls_014">SP</span></div>
<div style="position:absolute;left:134.00px;top:115.30px" class="cls_083"><span class="cls_083">str =  Dynamic access."</span></div>
<div style="position:absolute;left:278.04px;top:116.81px" class="cls_014"><span class="cls_014">special</span></div>
<div style="position:absolute;left:393.86px;top:116.81px" class="cls_053"><span class="cls_053">rb_block_t</span></div>
<div style="position:absolute;left:134.00px;top:124.90px" class="cls_014"><span class="cls_014">10.times </span><span class="cls_053">do</span></div>
<div style="position:absolute;left:274.04px;top:129.94px" class="cls_014"><span class="cls_014">svar/cref</span></div>
<div style="position:absolute;left:142.00px;top:134.50px" class="cls_083"><span class="cls_083">puts str</span></div>
<div style="position:absolute;left:134.00px;top:144.10px" class="cls_085"><span class="cls_085">end</span></div>
<div style="position:absolute;left:288.04px;top:143.08px" class="cls_014"><span class="cls_014">10</span></div>
<div style="position:absolute;left:126.00px;top:153.70px" class="cls_083"><span class="cls_083">end</span></div>
<div style="position:absolute;left:278.04px;top:156.22px" class="cls_014"><span class="cls_014">special</span></div>
<div style="position:absolute;left:274.04px;top:169.37px" class="cls_014"><span class="cls_014">svar/cref</span></div>
<div style="position:absolute;left:286.04px;top:182.50px" class="cls_014"><span class="cls_014">str</span></div>
<div style="position:absolute;left:120.00px;top:203.40px" class="cls_038"><span class="cls_038">Figure 3-24: When Ruby calls a method passing in a block, it saves a pointer to a new</span></div>
<div style="position:absolute;left:120.00px;top:213.90px" class="cls_014"><span class="cls_014">rb_block_t</span><span class="cls_038"> structure as the special value in the new stack frame.</span></div>
<div style="position:absolute;left:138.00px;top:236.40px" class="cls_007"><span class="cls_007">Notice the value </span><span class="cls_030">10</span><span class="cls_007"> on the stack: This is the actual receiver of the </span><span class="cls_030">times</span></div>
<div style="position:absolute;left:120.00px;top:248.40px" class="cls_007"><span class="cls_007">method. Notice too that Ruby has created a new stack frame with </span><span class="cls_030">svar/cref</span></div>
<div style="position:absolute;left:120.00px;top:260.40px" class="cls_007"><span class="cls_007">and </span><span class="cls_030">special</span><span class="cls_007"> above the value </span><span class="cls_030">10</span><span class="cls_007"> for the C code that implements </span><span class="cls_030">Integer#times</span></div>
<div style="position:absolute;left:120.00px;top:272.40px" class="cls_007"><span class="cls_007">to use. Because we passed a block into the method call, Ruby saves a</span></div>
<div style="position:absolute;left:120.00px;top:284.40px" class="cls_007"><span class="cls_007">pointer to this block in the </span><span class="cls_030">special</span><span class="cls_007"> variable in the new stack frame. Each</span></div>
<div style="position:absolute;left:120.00px;top:296.40px" class="cls_007"><span class="cls_007">frame on the YARV stack corresponding to a method call tracks whether</span></div>
<div style="position:absolute;left:120.00px;top:308.40px" class="cls_007"><span class="cls_007">there was a block argument using this </span><span class="cls_030">special</span><span class="cls_007"> variable. (I’ll discuss blocks</span></div>
<div style="position:absolute;left:120.00px;top:320.40px" class="cls_007"><span class="cls_007">and the </span><span class="cls_030">rb_block_t</span><span class="cls_007"> structure in more detail in Chapter 8.)</span></div>
<div style="position:absolute;left:138.00px;top:332.40px" class="cls_007"><span class="cls_007">Now the </span><span class="cls_030">Integer#times</span><span class="cls_007"> method yields to or calls the block’s code 10 times.</span></div>
<div style="position:absolute;left:120.00px;top:344.40px" class="cls_007"><span class="cls_007">Figure 3-25 shows how the YARV stack appears when Ruby is executing the</span></div>
<div style="position:absolute;left:120.00px;top:356.40px" class="cls_007"><span class="cls_007">code inside the block.</span></div>
<div style="position:absolute;left:352.94px;top:381.80px" class="cls_014"><span class="cls_014">SP</span></div>
<div style="position:absolute;left:278.04px;top:393.20px" class="cls_014"><span class="cls_014">special</span></div>
<div style="position:absolute;left:352.94px;top:394.04px" class="cls_014"><span class="cls_014">EP</span></div>
<div style="position:absolute;left:126.00px;top:398.64px" class="cls_083"><span class="cls_083">def display_string</span></div>
<div style="position:absolute;left:134.00px;top:408.24px" class="cls_083"><span class="cls_083">str =  Dynamic access."</span></div>
<div style="position:absolute;left:274.04px;top:406.36px" class="cls_014"><span class="cls_014">svar/cref</span></div>
<div style="position:absolute;left:134.00px;top:417.84px" class="cls_083"><span class="cls_083">10.times </span><span class="cls_084">do</span></div>
<div style="position:absolute;left:278.04px;top:419.51px" class="cls_014"><span class="cls_014">special</span></div>
<div style="position:absolute;left:142.00px;top:427.44px" class="cls_014"><span class="cls_014">puts str</span></div>
<div style="position:absolute;left:274.04px;top:432.67px" class="cls_014"><span class="cls_014">svar/cref</span></div>
<div style="position:absolute;left:134.00px;top:437.04px" class="cls_084"><span class="cls_084">end</span></div>
<div style="position:absolute;left:126.00px;top:446.64px" class="cls_083"><span class="cls_083">end</span></div>
<div style="position:absolute;left:288.04px;top:445.83px" class="cls_014"><span class="cls_014">10</span></div>
<div style="position:absolute;left:278.04px;top:458.99px" class="cls_014"><span class="cls_014">special</span></div>
<div style="position:absolute;left:352.94px;top:459.40px" class="cls_054"><span class="cls_054">Previous </span><span class="cls_014">EP</span></div>
<div style="position:absolute;left:274.04px;top:472.14px" class="cls_014"><span class="cls_014">svar/cref</span></div>
<div style="position:absolute;left:286.04px;top:485.30px" class="cls_014"><span class="cls_014">str</span></div>
<div style="position:absolute;left:120.00px;top:506.19px" class="cls_038"><span class="cls_038">Figure 3-25: How YARV’s stack would appear if we halted execution</span></div>
<div style="position:absolute;left:120.00px;top:516.69px" class="cls_038"><span class="cls_038">inside the block</span></div>
<div style="position:absolute;left:138.00px;top:539.19px" class="cls_007"><span class="cls_007">Just as we saw in Figures 3-17 through 3-22, Ruby sets </span><span class="cls_030">EP</span><span class="cls_007"> to point to the</span></div>
<div style="position:absolute;left:120.00px;top:551.19px" class="cls_007"><span class="cls_007">location of the </span><span class="cls_030">special</span><span class="cls_007"> value in each stack frame. Figure 3-25 shows one</span></div>
<div style="position:absolute;left:48.00px;top:633.00px" class="cls_020"><span class="cls_020">72</span></div>
<div style="position:absolute;left:69.89px;top:636.00px" class="cls_021"><span class="cls_021">Chapter 3</span></div>
</div>
<div style="position:absolute;left:50%;margin-left:-252px;top:62868px;width:504px;height:666px;border-style:outset;overflow:hidden">
<div style="position:absolute;left:0px;top:0px">
<img src="e698b76e-46bd-11eb-8b25-0cc47a792c0a_id_e698b76e-46bd-11eb-8b25-0cc47a792c0a_files/background097.jpg" width=504 height=666></div>
<div style="position:absolute;left:123.00px;top:42.28px" class="cls_007"><span class="cls_007">value of </span><span class="cls_030">EP</span><span class="cls_007"> for the new stack frame used by the block near the top of the</span></div>
<div style="position:absolute;left:123.00px;top:54.28px" class="cls_007"><span class="cls_007">stack and a second value of </span><span class="cls_030">EP</span><span class="cls_007"> in the original method’s stack frame near</span></div>
<div style="position:absolute;left:123.00px;top:66.28px" class="cls_007"><span class="cls_007">the bottom. In Figure 3-25 this second pointer is labeled </span><span class="cls_008">Previous </span><span class="cls_030">EP</span><span class="cls_007">.</span></div>
<div style="position:absolute;left:141.00px;top:78.28px" class="cls_007"><span class="cls_007">Now, what happens when Ruby executes the </span><span class="cls_030">puts str</span><span class="cls_007"> code inside the</span></div>
<div style="position:absolute;left:123.00px;top:90.28px" class="cls_007"><span class="cls_007">block? Ruby needs to obtain the value of the local variable </span><span class="cls_030">str</span><span class="cls_007"> and pass it</span></div>
<div style="position:absolute;left:123.00px;top:102.28px" class="cls_007"><span class="cls_007">to the </span><span class="cls_030">puts</span><span class="cls_007"> function as an argument. But notice in Figure 3-25 that </span><span class="cls_030">str</span><span class="cls_007"> is</span></div>
<div style="position:absolute;left:123.00px;top:114.28px" class="cls_007"><span class="cls_007">located farther down the stack. It’s not a local variable inside the block;</span></div>
<div style="position:absolute;left:123.00px;top:126.28px" class="cls_007"><span class="cls_007">rather, it’s a variable in the surrounding method, </span><span class="cls_030">display_string</span><span class="cls_007">. How does</span></div>
<div style="position:absolute;left:123.00px;top:138.28px" class="cls_007"><span class="cls_007">Ruby obtain the value from farther down the stack while executing code</span></div>
<div style="position:absolute;left:123.00px;top:150.28px" class="cls_007"><span class="cls_007">inside the block?</span></div>
<div style="position:absolute;left:141.00px;top:162.28px" class="cls_007"><span class="cls_007">This is where dynamic variable access comes in and why Ruby needs</span></div>
<div style="position:absolute;left:123.00px;top:174.28px" class="cls_007"><span class="cls_007">those </span><span class="cls_030">special</span><span class="cls_007"> values in each stack frame. Figure 3-26 shows how dynamic</span></div>
<div style="position:absolute;left:123.00px;top:186.28px" class="cls_007"><span class="cls_007">variable access works.</span></div>
<div style="position:absolute;left:416.29px;top:212.25px" class="cls_014"><span class="cls_014">SP</span></div>
<div style="position:absolute;left:129.00px;top:216.61px" class="cls_014"><span class="cls_014">putself</span></div>
<div style="position:absolute;left:129.00px;top:226.00px" class="cls_014"><span class="cls_014">getlocal</span></div>
<div style="position:absolute;left:215.01px;top:226.01px" class="cls_014"><span class="cls_014">2, 1</span></div>
<div style="position:absolute;left:303.93px;top:225.65px" class="cls_014"><span class="cls_014">"Dynamic access."</span></div>
<div style="position:absolute;left:129.00px;top:235.39px" class="cls_014"><span class="cls_014">opt_send_simple</span></div>
<div style="position:absolute;left:329.93px;top:240.27px" class="cls_014"><span class="cls_014">self</span></div>
<div style="position:absolute;left:323.93px;top:254.90px" class="cls_014"><span class="cls_014">special</span></div>
<div style="position:absolute;left:416.29px;top:255.79px" class="cls_014"><span class="cls_014">EP</span></div>
<div style="position:absolute;left:319.93px;top:269.52px" class="cls_014"><span class="cls_014">svar/cref</span></div>
<div style="position:absolute;left:323.93px;top:284.14px" class="cls_014"><span class="cls_014">special</span></div>
<div style="position:absolute;left:319.93px;top:298.76px" class="cls_014"><span class="cls_014">svar/cref</span></div>
<div style="position:absolute;left:129.00px;top:305.89px" class="cls_014"><span class="cls_014">putstring "Dynamic access."</span></div>
<div style="position:absolute;left:129.00px;top:315.28px" class="cls_014"><span class="cls_014">setlocal 2, 0</span></div>
<div style="position:absolute;left:333.93px;top:313.39px" class="cls_014"><span class="cls_014">10</span></div>
<div style="position:absolute;left:129.00px;top:324.67px" class="cls_014"><span class="cls_014">putobject 10</span></div>
<div style="position:absolute;left:323.93px;top:328.01px" class="cls_014"><span class="cls_014">special</span></div>
<div style="position:absolute;left:416.29px;top:327.83px" class="cls_054"><span class="cls_054">Previous </span><span class="cls_014">EP</span></div>
<div style="position:absolute;left:129.00px;top:334.06px" class="cls_014"><span class="cls_014">send &lt;callinfo!mid:times,</span></div>
<div style="position:absolute;left:137.00px;top:343.45px" class="cls_014"><span class="cls_014">argc:0,</span></div>
<div style="position:absolute;left:319.93px;top:342.63px" class="cls_014"><span class="cls_014">svar/cref</span></div>
<div style="position:absolute;left:137.00px;top:352.84px" class="cls_014"><span class="cls_014">block:block in display_string</span></div>
<div style="position:absolute;left:331.93px;top:357.26px" class="cls_014"><span class="cls_014">str</span></div>
<div style="position:absolute;left:280.56px;top:401.89px" class="cls_054"><span class="cls_054">etc...</span></div>
<div style="position:absolute;left:123.00px;top:420.22px" class="cls_038"><span class="cls_038">Figure 3-26: Ruby using dynamic variable access to obtain the value of </span><span class="cls_014">str</span><span class="cls_038"> from farther</span></div>
<div style="position:absolute;left:123.00px;top:430.72px" class="cls_038"><span class="cls_038">down the stack</span></div>
<div style="position:absolute;left:141.00px;top:453.22px" class="cls_007"><span class="cls_007">The dashed arrows indicate dynamic variable access: The </span><span class="cls_030">getlocal</span></div>
<div style="position:absolute;left:123.00px;top:465.22px" class="cls_007"><span class="cls_007">YARV instruction copies the value of </span><span class="cls_030">str</span><span class="cls_007"> from the lower stack frame (from</span></div>
<div style="position:absolute;left:123.00px;top:477.22px" class="cls_007"><span class="cls_007">the parent or outer Ruby scope) to the top of the stack, where the block can</span></div>
<div style="position:absolute;left:123.00px;top:489.22px" class="cls_007"><span class="cls_007">access it. Notice how the </span><span class="cls_030">EP</span><span class="cls_007"> pointers form a kind of ladder that Ruby can</span></div>
<div style="position:absolute;left:123.00px;top:501.22px" class="cls_007"><span class="cls_007">climb to access the local variables in the parent scope, the grandparent</span></div>
<div style="position:absolute;left:123.00px;top:513.22px" class="cls_007"><span class="cls_007">scope, and so on.</span></div>
<div style="position:absolute;left:141.00px;top:525.22px" class="cls_007"><span class="cls_007">In the </span><span class="cls_030">getlocal 2, 1</span><span class="cls_007"> call in Figure 3-26, the second parameter, </span><span class="cls_030">1</span><span class="cls_007">, tells</span></div>
<div style="position:absolute;left:123.00px;top:537.22px" class="cls_007"><span class="cls_007">Ruby where to find the variable. In this example, Ruby will follow the lad-</span></div>
<div style="position:absolute;left:123.00px;top:549.22px" class="cls_007"><span class="cls_007">der of </span><span class="cls_030">EP</span><span class="cls_007"> pointers one level down the stack to find </span><span class="cls_030">str</span><span class="cls_007">. That is, </span><span class="cls_030">1</span><span class="cls_007"> means step</span></div>
<div style="position:absolute;left:123.00px;top:561.22px" class="cls_007"><span class="cls_007">once from the block’s scope to the surrounding method’s scope.</span></div>
<div style="position:absolute;left:349.53px;top:636.00px" class="cls_021"><span class="cls_021">How Ruby Executes Your Code</span></div>
<div style="position:absolute;left:447.13px;top:633.00px" class="cls_020"><span class="cls_020">73</span></div>
</div>
<div style="position:absolute;left:50%;margin-left:-252px;top:63544px;width:504px;height:666px;border-style:outset;overflow:hidden">
<div style="position:absolute;left:0px;top:0px">
<img src="e698b76e-46bd-11eb-8b25-0cc47a792c0a_id_e698b76e-46bd-11eb-8b25-0cc47a792c0a_files/background098.jpg" width=504 height=666></div>
<div style="position:absolute;left:138.00px;top:42.28px" class="cls_007"><span class="cls_007">Listing 3-7 shows another example of dynamic variable access.</span></div>
<div style="position:absolute;left:120.00px;top:66.28px" class="cls_030"><span class="cls_030">def display_string</span></div>
<div style="position:absolute;left:128.50px;top:76.78px" class="cls_030"><span class="cls_030">str = "Dynamic access."</span></div>
<div style="position:absolute;left:128.50px;top:87.28px" class="cls_030"><span class="cls_030">10.times do</span></div>
<div style="position:absolute;left:137.00px;top:97.77px" class="cls_030"><span class="cls_030">10.times do</span></div>
<div style="position:absolute;left:145.50px;top:108.27px" class="cls_030"><span class="cls_030">puts str</span></div>
<div style="position:absolute;left:137.00px;top:118.77px" class="cls_030"><span class="cls_030">end</span></div>
<div style="position:absolute;left:128.50px;top:129.26px" class="cls_030"><span class="cls_030">end</span></div>
<div style="position:absolute;left:120.00px;top:139.76px" class="cls_030"><span class="cls_030">end</span></div>
<div style="position:absolute;left:120.00px;top:162.26px" class="cls_038"><span class="cls_038">Listing 3-7: In this example, Ruby would step two levels down the stack to find </span><span class="cls_014">str</span><span class="cls_038"> using</span></div>
<div style="position:absolute;left:120.00px;top:172.78px" class="cls_038"><span class="cls_038">dynamic variable access.</span></div>
<div style="position:absolute;left:138.00px;top:195.28px" class="cls_007"><span class="cls_007">If I had two nested blocks, as in Listing 3-7, Ruby would have used</span></div>
<div style="position:absolute;left:120.00px;top:207.28px" class="cls_030"><span class="cls_030">getlocal 2, 2</span><span class="cls_007"> instead of </span><span class="cls_030">getlocal 2, 1</span><span class="cls_007">.</span></div>
<div style="position:absolute;left:146.84px;top:257.81px" class="cls_020"><span class="cls_020">Climbing the Environment Pointer Ladder in C</span></div>
<div style="position:absolute;left:120.00px;top:276.31px" class="cls_039"><span class="cls_039">Let’s look at the actual C implementation of </span><span class="cls_009">getlocal</span><span class="cls_039">. As it does with most YARV</span></div>
<div style="position:absolute;left:120.00px;top:288.31px" class="cls_039"><span class="cls_039">instructions, Ruby implements </span><span class="cls_009">getlocal</span><span class="cls_039"> in the </span><span class="cls_044">insns.def</span><span class="cls_039"> code file, using the code</span></div>
<div style="position:absolute;left:120.00px;top:300.32px" class="cls_039"><span class="cls_039">shown in Listing 3-8.</span></div>
<div style="position:absolute;left:120.00px;top:322.81px" class="cls_009"><span class="cls_009">/**</span></div>
<div style="position:absolute;left:127.50px;top:332.32px" class="cls_009"><span class="cls_009">@c variable</span></div>
<div style="position:absolute;left:127.50px;top:341.82px" class="cls_009"><span class="cls_009">@e Get local variable (pointed by `idx' and `level').</span></div>
<div style="position:absolute;left:138.75px;top:351.32px" class="cls_009"><span class="cls_009">'level' indicates the nesting depth from the current block.</span></div>
<div style="position:absolute;left:127.50px;top:360.82px" class="cls_009"><span class="cls_009">@j level, idx </span><span class="cls_045">で指定されたローカル変数の値をスタックに置く。</span></div>
<div style="position:absolute;left:138.75px;top:370.33px" class="cls_009"><span class="cls_009">level </span><span class="cls_045">はブロックのネストレベルで、何段上かを示す。</span></div>
<div style="position:absolute;left:123.75px;top:379.83px" class="cls_009"><span class="cls_009">*/</span></div>
<div style="position:absolute;left:120.00px;top:389.33px" class="cls_009"><span class="cls_009">DEFINE_INSN</span></div>
<div style="position:absolute;left:120.00px;top:398.83px" class="cls_009"><span class="cls_009">getlocal</span></div>
<div style="position:absolute;left:120.00px;top:408.34px" class="cls_009"><span class="cls_009">(lindex_t idx, rb_num_t level)</span></div>
<div style="position:absolute;left:120.00px;top:417.84px" class="cls_009"><span class="cls_009">()</span></div>
<div style="position:absolute;left:120.00px;top:427.34px" class="cls_009"><span class="cls_009">(VALUE val)</span></div>
<div style="position:absolute;left:120.00px;top:436.84px" class="cls_009"><span class="cls_009">{</span></div>
<div style="position:absolute;left:135.00px;top:446.35px" class="cls_009"><span class="cls_009">int i, lev = (int)level;</span></div>
<div style="position:absolute;left:109.50px;top:455.85px" class="cls_045"><span class="cls_045">u</span><span class="cls_009">     VALUE *ep = GET_EP();</span></div>
<div style="position:absolute;left:135.00px;top:474.85px" class="cls_009"><span class="cls_009">for (i = 0; i &lt; lev; i++) {</span></div>
<div style="position:absolute;left:109.50px;top:484.35px" class="cls_045"><span class="cls_045">v</span></div>
<div style="position:absolute;left:149.94px;top:484.35px" class="cls_009"><span class="cls_009">ep = GET_PREV_EP(ep);</span></div>
<div style="position:absolute;left:135.00px;top:493.85px" class="cls_009"><span class="cls_009">}</span></div>
<div style="position:absolute;left:109.50px;top:503.35px" class="cls_045"><span class="cls_045">w</span><span class="cls_009">     val = *(ep - idx);</span></div>
<div style="position:absolute;left:120.00px;top:512.86px" class="cls_009"><span class="cls_009">}</span></div>
<div style="position:absolute;left:120.00px;top:535.31px" class="cls_043"><span class="cls_043">Listing 3-8: The C implementation of the </span><span class="cls_015">getlocal</span><span class="cls_043"> YARV instruction</span></div>
<div style="position:absolute;left:138.00px;top:558.31px" class="cls_039"><span class="cls_039">First, the </span><span class="cls_009">GET_EP</span><span class="cls_039"> macro </span><span class="cls_046">u</span><span class="cls_039"> returns the </span><span class="cls_009">EP</span><span class="cls_039"> from the current scope. (This macro is</span></div>
<div style="position:absolute;left:120.00px;top:570.31px" class="cls_039"><span class="cls_039">defined in the </span><span class="cls_044">vm_insnhelper.h </span><span class="cls_039">file along with a number of other macros related to</span></div>
<div style="position:absolute;left:48.00px;top:633.00px" class="cls_020"><span class="cls_020">74</span></div>
<div style="position:absolute;left:69.47px;top:636.00px" class="cls_021"><span class="cls_021">Chapter 3</span></div>
</div>
<div style="position:absolute;left:50%;margin-left:-252px;top:64220px;width:504px;height:666px;border-style:outset;overflow:hidden">
<div style="position:absolute;left:0px;top:0px">
<img src="e698b76e-46bd-11eb-8b25-0cc47a792c0a_id_e698b76e-46bd-11eb-8b25-0cc47a792c0a_files/background099.jpg" width=504 height=666></div>
<div style="position:absolute;left:122.50px;top:61.15px" class="cls_039"><span class="cls_039">YARV instructions.) Next, Ruby iterates over the </span><span class="cls_009">EP</span><span class="cls_039"> pointers, moving from the current</span></div>
<div style="position:absolute;left:122.50px;top:73.16px" class="cls_039"><span class="cls_039">to the parent scope and then from the parent to the grandparent scope by repeatedly</span></div>
<div style="position:absolute;left:122.50px;top:85.15px" class="cls_039"><span class="cls_039">dereferencing the </span><span class="cls_009">EP</span><span class="cls_039"> pointers. Ruby uses the </span><span class="cls_009">GET_PREV_EP</span><span class="cls_039"> macro at </span><span class="cls_046">v</span><span class="cls_039"> (also defined in</span></div>
<div style="position:absolute;left:122.50px;top:97.15px" class="cls_044"><span class="cls_044">vm_insnhelper.h</span><span class="cls_039">) to move from one </span><span class="cls_009">EP</span><span class="cls_039"> to another. The </span><span class="cls_009">level</span><span class="cls_039"> parameter tells Ruby how</span></div>
<div style="position:absolute;left:122.50px;top:109.16px" class="cls_039"><span class="cls_039">many times to iterate or how many rungs of the ladder to climb.</span></div>
<div style="position:absolute;left:140.50px;top:121.15px" class="cls_039"><span class="cls_039">Finally, Ruby obtains the target variable using the </span><span class="cls_009">idx</span><span class="cls_039"> parameter at </span><span class="cls_046">w</span><span class="cls_039">, which is</span></div>
<div style="position:absolute;left:122.50px;top:133.16px" class="cls_039"><span class="cls_039">the index of the target variable. As a result, this line of code gets the value from the</span></div>
<div style="position:absolute;left:122.50px;top:145.16px" class="cls_039"><span class="cls_039">target variable.</span></div>
<div style="position:absolute;left:122.50px;top:167.65px" class="cls_009"><span class="cls_009">val = *(ep - idx);</span></div>
<div style="position:absolute;left:140.50px;top:190.65px" class="cls_039"><span class="cls_039">This code means the following:</span></div>
<div style="position:absolute;left:122.50px;top:208.65px" class="cls_039"><span class="cls_039">•   Start from the address of the </span><span class="cls_009">EP</span><span class="cls_039"> for the target scope </span><span class="cls_009">ep</span><span class="cls_039">, obtained previously</span></div>
<div style="position:absolute;left:140.50px;top:220.65px" class="cls_039"><span class="cls_039">from the </span><span class="cls_009">GET_PREV_EP</span><span class="cls_039"> iterations.</span></div>
<div style="position:absolute;left:122.50px;top:235.65px" class="cls_039"><span class="cls_039">•   Subtract </span><span class="cls_009">idx</span><span class="cls_039"> from this address. The integer value </span><span class="cls_009">idx</span><span class="cls_039"> gives </span><span class="cls_009">getlocal</span><span class="cls_039"> the index of</span></div>
<div style="position:absolute;left:140.50px;top:247.66px" class="cls_039"><span class="cls_039">the local variable that you want to load from the local table. In other words, it</span></div>
<div style="position:absolute;left:140.50px;top:259.65px" class="cls_039"><span class="cls_039">tells </span><span class="cls_009">getlocal</span><span class="cls_039"> how far down the stack the target variable is located.</span></div>
<div style="position:absolute;left:122.50px;top:274.66px" class="cls_039"><span class="cls_039">•   Get the value from the YARV stack at the adjusted address.</span></div>
<div style="position:absolute;left:140.51px;top:292.65px" class="cls_039"><span class="cls_039">Therefore, in the call to </span><span class="cls_009">getlocal</span><span class="cls_039"> in Figure 3-26, YARV will take the </span><span class="cls_009">EP</span><span class="cls_039"> from the</span></div>
<div style="position:absolute;left:122.50px;top:304.65px" class="cls_039"><span class="cls_039">scope one level down on the YARV stack and subtract the index value </span><span class="cls_009">str</span><span class="cls_039"> (in this</span></div>
<div style="position:absolute;left:122.50px;top:316.65px" class="cls_039"><span class="cls_039">case, </span><span class="cls_009">2</span><span class="cls_039">) to obtain a pointer to the </span><span class="cls_009">str</span><span class="cls_039"> variable.</span></div>
<div style="position:absolute;left:122.50px;top:339.15px" class="cls_009"><span class="cls_009">getlocal 2, 1</span></div>
<div style="position:absolute;left:123.00px;top:414.63px" class="cls_031"><span class="cls_031">Experiment 3-2: Exploring Special Variables</span></div>
<div style="position:absolute;left:123.00px;top:434.63px" class="cls_007"><span class="cls_007">In Figures 3-16 through 3-26, I showed you a value called </span><span class="cls_030">svar/cref</span><span class="cls_007"> in the</span></div>
<div style="position:absolute;left:123.00px;top:446.63px" class="cls_030"><span class="cls_030">EP-1</span><span class="cls_007"> position on the stack. What are these two values, and how can Ruby</span></div>
<div style="position:absolute;left:123.00px;top:458.63px" class="cls_007"><span class="cls_007">save two values in one location on the stack? For that matter, why does it</span></div>
<div style="position:absolute;left:123.00px;top:470.63px" class="cls_007"><span class="cls_007">do this? Let’s find out.</span></div>
<div style="position:absolute;left:141.00px;top:482.63px" class="cls_007"><span class="cls_007">Usually, the </span><span class="cls_030">EP-1</span><span class="cls_007"> slot in the stack will contain the </span><span class="cls_030">svar</span><span class="cls_007"> value, which is</span></div>
<div style="position:absolute;left:123.00px;top:494.63px" class="cls_007"><span class="cls_007">a pointer to a table of any special variables defined in this stack frame. In</span></div>
<div style="position:absolute;left:123.00px;top:506.63px" class="cls_007"><span class="cls_007">Ruby the term </span><span class="cls_008">special variables</span><span class="cls_007"> refers to values that Ruby automatically cre-</span></div>
<div style="position:absolute;left:123.00px;top:518.63px" class="cls_007"><span class="cls_007">ates as a matter of convenience, based on the environment or on recent</span></div>
<div style="position:absolute;left:123.00px;top:530.63px" class="cls_007"><span class="cls_007">operations. For example, Ruby sets </span><span class="cls_030">$*</span><span class="cls_007"> to the </span><span class="cls_030">ARGV</span><span class="cls_007"> array and </span><span class="cls_030">$!</span><span class="cls_007"> to the last</span></div>
<div style="position:absolute;left:123.00px;top:542.63px" class="cls_007"><span class="cls_007">exception raised.</span></div>
<div style="position:absolute;left:141.00px;top:554.63px" class="cls_007"><span class="cls_007">All special variables begin with the dollar sign (</span><span class="cls_030">$</span><span class="cls_007">) character, which usu-</span></div>
<div style="position:absolute;left:123.00px;top:566.63px" class="cls_007"><span class="cls_007">ally indicates a global variable. Does that mean that special variables are</span></div>
<div style="position:absolute;left:123.00px;top:578.63px" class="cls_007"><span class="cls_007">global variables? If so, then why does Ruby save a pointer to them on the</span></div>
<div style="position:absolute;left:123.00px;top:590.63px" class="cls_007"><span class="cls_007">stack?</span></div>
<div style="position:absolute;left:349.64px;top:636.00px" class="cls_021"><span class="cls_021">How Ruby Executes Your Code</span></div>
<div style="position:absolute;left:447.25px;top:633.00px" class="cls_020"><span class="cls_020">75</span></div>
</div>
<div style="position:absolute;left:50%;margin-left:-252px;top:64896px;width:504px;height:666px;border-style:outset;overflow:hidden">
<div style="position:absolute;left:0px;top:0px">
<img src="e698b76e-46bd-11eb-8b25-0cc47a792c0a_id_e698b76e-46bd-11eb-8b25-0cc47a792c0a_files/background100.jpg" width=504 height=666></div>
<div style="position:absolute;left:138.00px;top:41.60px" class="cls_007"><span class="cls_007">To answer this question, let’s create a simple Ruby script to match a</span></div>
<div style="position:absolute;left:120.00px;top:53.60px" class="cls_007"><span class="cls_007">string using a regular expression.</span></div>
<div style="position:absolute;left:120.00px;top:77.60px" class="cls_030"><span class="cls_030">/fox/.match("The quick brown fox jumped over the lazy dog.\n")</span></div>
<div style="position:absolute;left:120.00px;top:88.10px" class="cls_030"><span class="cls_030">puts "Value of $& in the top level scope: #{$&}"</span></div>
<div style="position:absolute;left:138.00px;top:110.60px" class="cls_007"><span class="cls_007">Here I match the word </span><span class="cls_030">fox</span><span class="cls_007"> in the string using a regex, and then I print</span></div>
<div style="position:absolute;left:120.00px;top:122.60px" class="cls_007"><span class="cls_007">the matching string using the </span><span class="cls_030">$&</span><span class="cls_007"> special variable. Here’s the output I get</span></div>
<div style="position:absolute;left:120.00px;top:134.60px" class="cls_007"><span class="cls_007">running this at the console.</span></div>
<div style="position:absolute;left:120.00px;top:158.60px" class="cls_030"><span class="cls_030">$ </span><span class="cls_040">ruby regex.rb</span></div>
<div style="position:absolute;left:120.00px;top:169.10px" class="cls_030"><span class="cls_030">Value of $& in the top level scope: fox</span></div>
<div style="position:absolute;left:138.00px;top:191.60px" class="cls_007"><span class="cls_007">Listing 3-9 shows another example, this time searching for the same</span></div>
<div style="position:absolute;left:120.00px;top:203.60px" class="cls_007"><span class="cls_007">string twice: first in the top-level scope and then again from inside a</span></div>
<div style="position:absolute;left:120.00px;top:215.60px" class="cls_007"><span class="cls_007">method call.</span></div>
<div style="position:absolute;left:120.00px;top:239.60px" class="cls_030"><span class="cls_030">str = "The quick brown fox jumped over the lazy dog.\n"</span></div>
<div style="position:absolute;left:108.15px;top:250.10px" class="cls_046"><span class="cls_046">u</span><span class="cls_030"> /fox/.match(str)</span></div>
<div style="position:absolute;left:120.00px;top:271.10px" class="cls_030"><span class="cls_030">def search(str)</span></div>
<div style="position:absolute;left:108.15px;top:281.60px" class="cls_046"><span class="cls_046">v</span></div>
<div style="position:absolute;left:128.48px;top:281.60px" class="cls_030"><span class="cls_030">/dog/.match(str)</span></div>
<div style="position:absolute;left:108.15px;top:292.10px" class="cls_046"><span class="cls_046">w</span></div>
<div style="position:absolute;left:128.48px;top:292.10px" class="cls_030"><span class="cls_030">puts "Value of $& inside method: #{$&}"</span></div>
<div style="position:absolute;left:120.00px;top:302.59px" class="cls_030"><span class="cls_030">end</span></div>
<div style="position:absolute;left:120.00px;top:313.09px" class="cls_030"><span class="cls_030">search(str)</span></div>
<div style="position:absolute;left:108.15px;top:334.09px" class="cls_046"><span class="cls_046">x</span><span class="cls_030"> puts "Value of $& in the top level scope: #{$&}"</span></div>
<div style="position:absolute;left:120.00px;top:356.59px" class="cls_038"><span class="cls_038">Listing 3-9: Referring to </span><span class="cls_014">$&</span><span class="cls_038"> from two different scopes</span></div>
<div style="position:absolute;left:138.00px;top:379.10px" class="cls_007"><span class="cls_007">This is simple Ruby code, but it still may be a bit confusing. Here’s how</span></div>
<div style="position:absolute;left:120.00px;top:391.10px" class="cls_007"><span class="cls_007">this works:</span></div>
<div style="position:absolute;left:120.00px;top:412.10px" class="cls_050"><span class="cls_050">•</span><span class="cls_007">   We search the string in the top scope for </span><span class="cls_030">fox</span><span class="cls_007"> at </span><span class="cls_050">u</span><span class="cls_007">. This matches and</span></div>
<div style="position:absolute;left:138.00px;top:424.10px" class="cls_007"><span class="cls_007">saves </span><span class="cls_030">fox</span><span class="cls_007"> into the </span><span class="cls_030">$&</span><span class="cls_007"> special variable.</span></div>
<div style="position:absolute;left:120.00px;top:439.10px" class="cls_050"><span class="cls_050">•</span><span class="cls_007">   We call the </span><span class="cls_030">search</span><span class="cls_007"> method and search for </span><span class="cls_030">dog</span><span class="cls_007"> at </span><span class="cls_050">v</span><span class="cls_030">.</span><span class="cls_007"> I immediately print</span></div>
<div style="position:absolute;left:138.00px;top:451.10px" class="cls_007"><span class="cls_007">the match using the same </span><span class="cls_030">$&</span><span class="cls_007"> variable inside the method at </span><span class="cls_050">w</span><span class="cls_007">.</span></div>
<div style="position:absolute;left:120.00px;top:466.10px" class="cls_050"><span class="cls_050">•</span><span class="cls_007">   Finally, we return to the top-level scope and print the value of </span><span class="cls_030">$&</span></div>
<div style="position:absolute;left:138.00px;top:478.10px" class="cls_007"><span class="cls_007">again at </span><span class="cls_050">x</span><span class="cls_007">.</span></div>
<div style="position:absolute;left:138.00px;top:499.10px" class="cls_007"><span class="cls_007">Running this test gives the following output.</span></div>
<div style="position:absolute;left:120.00px;top:523.10px" class="cls_030"><span class="cls_030">$ </span><span class="cls_040">ruby regex_method.rb</span></div>
<div style="position:absolute;left:120.00px;top:533.60px" class="cls_030"><span class="cls_030">Value of $& inside method: dog</span></div>
<div style="position:absolute;left:120.00px;top:544.09px" class="cls_030"><span class="cls_030">Value of $& in the top level scope: fox</span></div>
<div style="position:absolute;left:48.00px;top:633.00px" class="cls_020"><span class="cls_020">76</span></div>
<div style="position:absolute;left:69.54px;top:636.00px" class="cls_021"><span class="cls_021">Chapter 3</span></div>
</div>
<div style="position:absolute;left:50%;margin-left:-252px;top:65572px;width:504px;height:666px;border-style:outset;overflow:hidden">
<div style="position:absolute;left:0px;top:0px">
<img src="e698b76e-46bd-11eb-8b25-0cc47a792c0a_id_e698b76e-46bd-11eb-8b25-0cc47a792c0a_files/background101.jpg" width=504 height=666></div>
<div style="position:absolute;left:141.00px;top:42.28px" class="cls_007"><span class="cls_007">This is what we expect, but consider the following for a moment. The</span></div>
<div style="position:absolute;left:123.00px;top:54.28px" class="cls_030"><span class="cls_030">$&</span><span class="cls_007"> variable is obviously not global because it has different values at different</span></div>
<div style="position:absolute;left:123.00px;top:66.28px" class="cls_007"><span class="cls_007">places in my Ruby script. Ruby preserves the value of </span><span class="cls_030">$&</span><span class="cls_007"> from the top-level</span></div>
<div style="position:absolute;left:123.00px;top:78.28px" class="cls_007"><span class="cls_007">scope when executing the </span><span class="cls_030">search</span><span class="cls_007"> method, which allows me to print the match-</span></div>
<div style="position:absolute;left:123.00px;top:90.28px" class="cls_007"><span class="cls_007">ing word </span><span class="cls_030">fox</span><span class="cls_007"> from the original search. Ruby provides for this behavior by</span></div>
<div style="position:absolute;left:123.00px;top:102.28px" class="cls_007"><span class="cls_007">saving a separate set of special variables at each level of the stack using the</span></div>
<div style="position:absolute;left:123.00px;top:114.28px" class="cls_030"><span class="cls_030">svar</span><span class="cls_007"> value, as shown in Figure 3-27.</span></div>
<div style="position:absolute;left:185.35px;top:161.12px" class="cls_086"><span class="cls_086">special</span></div>
<div style="position:absolute;left:279.10px;top:161.21px" class="cls_086"><span class="cls_086">EP</span></div>
<div style="position:absolute;left:125.39px;top:176.46px" class="cls_087"><span class="cls_087">Method</span></div>
<div style="position:absolute;left:191.36px;top:180.90px" class="cls_086"><span class="cls_086">svar</span></div>
<div style="position:absolute;left:264.36px;top:182.25px" class="cls_086"><span class="cls_086">$& ="dog"</span></div>
<div style="position:absolute;left:319.72px;top:182.70px" class="cls_086"><span class="cls_086">etc...</span></div>
<div style="position:absolute;left:127.92px;top:186.08px" class="cls_087"><span class="cls_087">Scope</span></div>
<div style="position:absolute;left:193.36px;top:200.68px" class="cls_086"><span class="cls_086">str</span></div>
<div style="position:absolute;left:185.35px;top:220.61px" class="cls_086"><span class="cls_086">special</span></div>
<div style="position:absolute;left:279.10px;top:220.25px" class="cls_087"><span class="cls_087">Previous </span><span class="cls_086">EP</span></div>
<div style="position:absolute;left:123.00px;top:235.55px" class="cls_087"><span class="cls_087">Top-Level</span></div>
<div style="position:absolute;left:191.36px;top:239.88px" class="cls_086"><span class="cls_086">svar</span></div>
<div style="position:absolute;left:264.36px;top:240.76px" class="cls_086"><span class="cls_086">$& ="fox"</span></div>
<div style="position:absolute;left:319.72px;top:241.21px" class="cls_086"><span class="cls_086">etc...</span></div>
<div style="position:absolute;left:127.91px;top:245.16px" class="cls_087"><span class="cls_087">Scope</span></div>
<div style="position:absolute;left:193.36px;top:259.57px" class="cls_086"><span class="cls_086">str</span></div>
<div style="position:absolute;left:123.00px;top:282.48px" class="cls_038"><span class="cls_038">Figure 3-27: Each stack frame has its own set of special variables.</span></div>
<div style="position:absolute;left:141.00px;top:304.98px" class="cls_007"><span class="cls_007">Notice that Ruby saved the </span><span class="cls_030">fox</span><span class="cls_007"> string in a table referred to by the </span><span class="cls_030">svar</span></div>
<div style="position:absolute;left:123.00px;top:316.98px" class="cls_007"><span class="cls_007">pointer for the top-level scope and saved the </span><span class="cls_030">dog</span><span class="cls_007"> string in a different table</span></div>
<div style="position:absolute;left:123.00px;top:328.98px" class="cls_007"><span class="cls_007">for the inner-method scope. Ruby finds the proper special variable table</span></div>
<div style="position:absolute;left:123.00px;top:340.98px" class="cls_007"><span class="cls_007">using the </span><span class="cls_030">EP</span><span class="cls_007"> pointer for each stack frame.</span></div>
<div style="position:absolute;left:141.00px;top:352.98px" class="cls_007"><span class="cls_007">Ruby saves actual global variables (variables you define using a dol-</span></div>
<div style="position:absolute;left:123.00px;top:364.98px" class="cls_007"><span class="cls_007">lar sign prefix) in a single, global hash table. Regardless of where you save</span></div>
<div style="position:absolute;left:123.00px;top:376.98px" class="cls_007"><span class="cls_007">or retrieve the value of a normal global variable, Ruby accesses the same</span></div>
<div style="position:absolute;left:123.00px;top:388.98px" class="cls_007"><span class="cls_007">global hash table.</span></div>
<div style="position:absolute;left:141.00px;top:400.98px" class="cls_007"><span class="cls_007">Now for one more test: What if I perform the search inside a block and</span></div>
<div style="position:absolute;left:123.00px;top:412.98px" class="cls_007"><span class="cls_007">not a method? Listing 3-10 shows this new search.</span></div>
<div style="position:absolute;left:123.00px;top:436.98px" class="cls_030"><span class="cls_030">str = "The quick brown fox jumped over the lazy dog.\n"</span></div>
<div style="position:absolute;left:123.00px;top:447.48px" class="cls_030"><span class="cls_030">/fox/.match(str)</span></div>
<div style="position:absolute;left:123.00px;top:468.48px" class="cls_030"><span class="cls_030">2.times do</span></div>
<div style="position:absolute;left:131.50px;top:478.98px" class="cls_030"><span class="cls_030">/dog/.match(str)</span></div>
<div style="position:absolute;left:131.50px;top:489.48px" class="cls_030"><span class="cls_030">puts "Value of $& inside block: #{$&}"</span></div>
<div style="position:absolute;left:123.00px;top:499.97px" class="cls_030"><span class="cls_030">end</span></div>
<div style="position:absolute;left:123.00px;top:520.98px" class="cls_030"><span class="cls_030">puts "Value of $& in the top-level scope: #{$&}"</span></div>
<div style="position:absolute;left:123.00px;top:543.48px" class="cls_038"><span class="cls_038">Listing 3-10: Displaying the value of </span><span class="cls_014">$&</span><span class="cls_038"> from inside a block</span></div>
<div style="position:absolute;left:349.41px;top:636.00px" class="cls_021"><span class="cls_021">How Ruby Executes Your Code</span></div>
<div style="position:absolute;left:447.02px;top:633.00px" class="cls_020"><span class="cls_020">77</span></div>
</div>
<div style="position:absolute;left:50%;margin-left:-252px;top:66248px;width:504px;height:666px;border-style:outset;overflow:hidden">
<div style="position:absolute;left:0px;top:0px">
<img src="e698b76e-46bd-11eb-8b25-0cc47a792c0a_id_e698b76e-46bd-11eb-8b25-0cc47a792c0a_files/background102.jpg" width=504 height=666></div>
<div style="position:absolute;left:138.00px;top:42.28px" class="cls_007"><span class="cls_007">Here’s the output I get at the console this time.</span></div>
<div style="position:absolute;left:120.00px;top:66.28px" class="cls_030"><span class="cls_030">$ </span><span class="cls_040">ruby regex_block.rb</span></div>
<div style="position:absolute;left:120.00px;top:76.78px" class="cls_030"><span class="cls_030">Value of $& inside block: dog</span></div>
<div style="position:absolute;left:120.00px;top:87.28px" class="cls_030"><span class="cls_030">Value of $& inside block: dog</span></div>
<div style="position:absolute;left:120.00px;top:97.77px" class="cls_030"><span class="cls_030">Value of $& in the top-level scope: dog</span></div>
<div style="position:absolute;left:138.00px;top:120.28px" class="cls_007"><span class="cls_007">Notice that now Ruby has overwritten the value of </span><span class="cls_030">$&</span><span class="cls_007"> in the top scope</span></div>
<div style="position:absolute;left:120.00px;top:132.28px" class="cls_007"><span class="cls_007">with the matching word </span><span class="cls_030">dog</span><span class="cls_007"> from the search I performed inside the block!</span></div>
<div style="position:absolute;left:120.00px;top:144.28px" class="cls_007"><span class="cls_007">This is by design: Ruby considers the top-level and inner-block scope to be</span></div>
<div style="position:absolute;left:120.00px;top:156.28px" class="cls_007"><span class="cls_007">the same with regard to special variables. This is similar to how dynamic</span></div>
<div style="position:absolute;left:120.00px;top:168.28px" class="cls_007"><span class="cls_007">variable access works; we expect variables inside the block to have the same</span></div>
<div style="position:absolute;left:120.00px;top:180.28px" class="cls_007"><span class="cls_007">values as those in the parent scope.</span></div>
<div style="position:absolute;left:138.00px;top:192.28px" class="cls_007"><span class="cls_007">Figure 3-28 shows how Ruby implements this behavior.</span></div>
<div style="position:absolute;left:182.26px;top:239.94px" class="cls_014"><span class="cls_014">special</span></div>
<div style="position:absolute;left:272.88px;top:239.67px" class="cls_014"><span class="cls_014">EP</span></div>
<div style="position:absolute;left:126.47px;top:254.22px" class="cls_054"><span class="cls_054">Block</span></div>
<div style="position:absolute;left:188.26px;top:259.70px" class="cls_014"><span class="cls_014">cref</span></div>
<div style="position:absolute;left:256.22px;top:259.02px" class="cls_054"><span class="cls_054">Lexical Scope</span></div>
<div style="position:absolute;left:124.91px;top:263.82px" class="cls_054"><span class="cls_054">Scope</span></div>
<div style="position:absolute;left:182.26px;top:277.69px" class="cls_014"><span class="cls_014">special</span></div>
<div style="position:absolute;left:188.26px;top:297.44px" class="cls_014"><span class="cls_014">svar</span></div>
<div style="position:absolute;left:182.26px;top:317.50px" class="cls_014"><span class="cls_014">special</span></div>
<div style="position:absolute;left:272.87px;top:316.83px" class="cls_054"><span class="cls_054">Previous </span><span class="cls_014">EP</span></div>
<div style="position:absolute;left:120.00px;top:332.22px" class="cls_054"><span class="cls_054">Top-Level</span></div>
<div style="position:absolute;left:188.26px;top:336.74px" class="cls_014"><span class="cls_014">svar</span></div>
<div style="position:absolute;left:261.16px;top:337.62px" class="cls_014"><span class="cls_014">$& ="dog"</span></div>
<div style="position:absolute;left:316.44px;top:338.06px" class="cls_014"><span class="cls_014">etc...</span></div>
<div style="position:absolute;left:124.90px;top:341.82px" class="cls_054"><span class="cls_054">Scope</span></div>
<div style="position:absolute;left:190.26px;top:356.40px" class="cls_014"><span class="cls_014">str</span></div>
<div style="position:absolute;left:120.00px;top:379.98px" class="cls_038"><span class="cls_038">Figure 3-28: Ruby uses the </span><span class="cls_014">EP-1</span><span class="cls_038"> stack position for </span><span class="cls_014">cref</span><span class="cls_038"> in blocks and for </span><span class="cls_014">svar</span></div>
<div style="position:absolute;left:120.00px;top:390.48px" class="cls_038"><span class="cls_038">otherwise.</span></div>
<div style="position:absolute;left:138.00px;top:412.98px" class="cls_007"><span class="cls_007">As you can see in Figure 3-28, Ruby has just a single special variable</span></div>
<div style="position:absolute;left:120.00px;top:424.98px" class="cls_007"><span class="cls_007">table for the top-level scope. It finds the special variables using the previ-</span></div>
<div style="position:absolute;left:120.00px;top:436.98px" class="cls_007"><span class="cls_007">ous </span><span class="cls_030">EP</span><span class="cls_007"> pointer, which points to the top-level scope. Inside the block scope</span></div>
<div style="position:absolute;left:120.00px;top:448.98px" class="cls_007"><span class="cls_007">(because there is no need for a separate copy of the special variables),</span></div>
<div style="position:absolute;left:120.00px;top:460.98px" class="cls_007"><span class="cls_007">Ruby takes advantage of the </span><span class="cls_030">EP-1</span><span class="cls_007"> open slot and saves the value </span><span class="cls_030">cref</span><span class="cls_007"> there</span></div>
<div style="position:absolute;left:120.00px;top:472.98px" class="cls_007"><span class="cls_007">instead. Ruby uses the </span><span class="cls_030">cref</span><span class="cls_007"> value to keep track of which lexical scope this</span></div>
<div style="position:absolute;left:120.00px;top:484.98px" class="cls_007"><span class="cls_007">block belongs to. </span><span class="cls_008">Lexical scope</span><span class="cls_007"> refers to a section of code within the syntac-</span></div>
<div style="position:absolute;left:120.00px;top:496.98px" class="cls_007"><span class="cls_007">tical structure of your program and is used by Ruby to look up constant</span></div>
<div style="position:absolute;left:120.00px;top:508.98px" class="cls_007"><span class="cls_007">values. (See Chapter 6 for more on lexical scope.) Specifically, Ruby uses</span></div>
<div style="position:absolute;left:120.00px;top:520.98px" class="cls_007"><span class="cls_007">the </span><span class="cls_030">cref</span><span class="cls_007"> value here to implement metaprogramming API calls, such as </span><span class="cls_030">eval</span></div>
<div style="position:absolute;left:120.00px;top:532.98px" class="cls_007"><span class="cls_007">and </span><span class="cls_030">instance_eval</span><span class="cls_007">. The </span><span class="cls_030">cref</span><span class="cls_007"> value indicates whether the given block should</span></div>
<div style="position:absolute;left:120.00px;top:544.98px" class="cls_007"><span class="cls_007">be executed in a different lexical scope compared to the parent scope.</span></div>
<div style="position:absolute;left:120.00px;top:556.98px" class="cls_007"><span class="cls_007">(See “instance_eval Creates a Singleton Class for a New Lexical Scope” on</span></div>
<div style="position:absolute;left:120.00px;top:568.98px" class="cls_007"><span class="cls_007">page 243.)</span></div>
<div style="position:absolute;left:48.00px;top:633.00px" class="cls_020"><span class="cls_020">78</span></div>
<div style="position:absolute;left:69.85px;top:636.00px" class="cls_021"><span class="cls_021">Chapter 3</span></div>
</div>
<div style="position:absolute;left:50%;margin-left:-252px;top:66924px;width:504px;height:666px;border-style:outset;overflow:hidden">
<div style="position:absolute;left:0px;top:0px">
<img src="e698b76e-46bd-11eb-8b25-0cc47a792c0a_id_e698b76e-46bd-11eb-8b25-0cc47a792c0a_files/background103.jpg" width=504 height=666></div>
<div style="position:absolute;left:176.87px;top:60.81px" class="cls_020"><span class="cls_020">A Def initive List of Special Variables</span></div>
<div style="position:absolute;left:123.00px;top:79.31px" class="cls_039"><span class="cls_039">One place to find an accurate list of all the special variables that Ruby supports is</span></div>
<div style="position:absolute;left:123.00px;top:91.32px" class="cls_039"><span class="cls_039">the C source itself. For example, Listing 3-11 is a piece of Ruby’s C source code that</span></div>
<div style="position:absolute;left:123.00px;top:103.31px" class="cls_039"><span class="cls_039">tokenizes your Ruby program, as snipped from the </span><span class="cls_009">parser_yylex</span><span class="cls_039"> function located in</span></div>
<div style="position:absolute;left:123.00px;top:115.31px" class="cls_044"><span class="cls_044">parse.y</span><span class="cls_039">:</span></div>
<div style="position:absolute;left:112.50px;top:137.81px" class="cls_045"><span class="cls_045">u</span><span class="cls_009"> case '$':</span></div>
<div style="position:absolute;left:123.00px;top:147.32px" class="cls_009"><span class="cls_009">lex_state = EXPR_END;</span></div>
<div style="position:absolute;left:123.00px;top:156.82px" class="cls_009"><span class="cls_009">newtok();</span></div>
<div style="position:absolute;left:123.00px;top:166.32px" class="cls_009"><span class="cls_009">c = nextc();</span></div>
<div style="position:absolute;left:112.50px;top:175.82px" class="cls_045"><span class="cls_045">v</span><span class="cls_009"> switch (c) {</span></div>
<div style="position:absolute;left:112.50px;top:185.33px" class="cls_045"><span class="cls_045">w</span><span class="cls_009">   case '_':</span></div>
<div style="position:absolute;left:209.19px;top:185.33px" class="cls_009"><span class="cls_009">/* $_: last read line string */</span></div>
<div style="position:absolute;left:138.00px;top:194.83px" class="cls_009"><span class="cls_009">c = nextc();</span></div>
<div style="position:absolute;left:138.00px;top:204.33px" class="cls_009"><span class="cls_009">if (parser_is_identchar()) {</span></div>
<div style="position:absolute;left:153.00px;top:213.83px" class="cls_009"><span class="cls_009">tokadd('$');</span></div>
<div style="position:absolute;left:153.00px;top:223.34px" class="cls_009"><span class="cls_009">tokadd('_');</span></div>
<div style="position:absolute;left:153.00px;top:232.84px" class="cls_009"><span class="cls_009">break;</span></div>
<div style="position:absolute;left:138.00px;top:242.34px" class="cls_009"><span class="cls_009">}</span></div>
<div style="position:absolute;left:138.00px;top:251.84px" class="cls_009"><span class="cls_009">pushback(c);</span></div>
<div style="position:absolute;left:138.00px;top:261.35px" class="cls_009"><span class="cls_009">c = '_';</span></div>
<div style="position:absolute;left:138.00px;top:270.85px" class="cls_009"><span class="cls_009">/* fall through */</span></div>
<div style="position:absolute;left:112.50px;top:280.35px" class="cls_045"><span class="cls_045">x</span><span class="cls_009">   case '~':</span></div>
<div style="position:absolute;left:209.19px;top:280.35px" class="cls_009"><span class="cls_009">/* $~: match-data */</span></div>
<div style="position:absolute;left:130.50px;top:289.85px" class="cls_009"><span class="cls_009">case '*':</span></div>
<div style="position:absolute;left:209.25px;top:289.85px" class="cls_009"><span class="cls_009">/* $*: argv */</span></div>
<div style="position:absolute;left:130.50px;top:299.36px" class="cls_009"><span class="cls_009">case '$':</span></div>
<div style="position:absolute;left:209.25px;top:299.36px" class="cls_009"><span class="cls_009">/* $$: pid */</span></div>
<div style="position:absolute;left:130.50px;top:308.86px" class="cls_009"><span class="cls_009">case '?':</span></div>
<div style="position:absolute;left:209.25px;top:308.86px" class="cls_009"><span class="cls_009">/* $?: last status */</span></div>
<div style="position:absolute;left:130.50px;top:318.36px" class="cls_009"><span class="cls_009">case '!':</span></div>
<div style="position:absolute;left:209.25px;top:318.36px" class="cls_009"><span class="cls_009">/* $!: error string */</span></div>
<div style="position:absolute;left:130.50px;top:327.86px" class="cls_009"><span class="cls_009">case '@':</span></div>
<div style="position:absolute;left:209.25px;top:327.86px" class="cls_009"><span class="cls_009">/* $@: error position */</span></div>
<div style="position:absolute;left:130.50px;top:337.37px" class="cls_009"><span class="cls_009">case '/':</span></div>
<div style="position:absolute;left:209.25px;top:337.37px" class="cls_009"><span class="cls_009">/* $/: input record separator */</span></div>
<div style="position:absolute;left:130.50px;top:346.87px" class="cls_009"><span class="cls_009">case '\\':</span></div>
<div style="position:absolute;left:209.25px;top:346.87px" class="cls_009"><span class="cls_009">/* $\: output record separator */</span></div>
<div style="position:absolute;left:130.50px;top:356.37px" class="cls_009"><span class="cls_009">case ';':</span></div>
<div style="position:absolute;left:209.25px;top:356.37px" class="cls_009"><span class="cls_009">/* $;: field separator */</span></div>
<div style="position:absolute;left:130.50px;top:365.87px" class="cls_009"><span class="cls_009">case ',':</span></div>
<div style="position:absolute;left:209.25px;top:365.87px" class="cls_009"><span class="cls_009">/* $,: output field separator */</span></div>
<div style="position:absolute;left:130.50px;top:375.38px" class="cls_009"><span class="cls_009">case '.':</span></div>
<div style="position:absolute;left:209.25px;top:375.38px" class="cls_009"><span class="cls_009">/* $.: last read line number */</span></div>
<div style="position:absolute;left:130.50px;top:384.88px" class="cls_009"><span class="cls_009">case '=':</span></div>
<div style="position:absolute;left:209.25px;top:384.88px" class="cls_009"><span class="cls_009">/* $=: ignorecase */</span></div>
<div style="position:absolute;left:130.50px;top:394.38px" class="cls_009"><span class="cls_009">case ':':</span></div>
<div style="position:absolute;left:209.25px;top:394.38px" class="cls_009"><span class="cls_009">/* $:: load path */</span></div>
<div style="position:absolute;left:130.50px;top:403.88px" class="cls_009"><span class="cls_009">case '&lt;':</span></div>
<div style="position:absolute;left:209.25px;top:403.88px" class="cls_009"><span class="cls_009">/* $&lt;: reading filename */</span></div>
<div style="position:absolute;left:130.50px;top:413.39px" class="cls_009"><span class="cls_009">case '>':</span></div>
<div style="position:absolute;left:209.25px;top:413.39px" class="cls_009"><span class="cls_009">/* $>: default output handle */</span></div>
<div style="position:absolute;left:130.50px;top:422.89px" class="cls_009"><span class="cls_009">case '\"':</span></div>
<div style="position:absolute;left:209.25px;top:422.89px" class="cls_009"><span class="cls_009">/* $": already loaded files */</span></div>
<div style="position:absolute;left:138.00px;top:432.39px" class="cls_009"><span class="cls_009">tokadd('$');</span></div>
<div style="position:absolute;left:138.00px;top:441.89px" class="cls_009"><span class="cls_009">tokadd(c);</span></div>
<div style="position:absolute;left:138.00px;top:451.40px" class="cls_009"><span class="cls_009">tokfix();</span></div>
<div style="position:absolute;left:138.00px;top:460.90px" class="cls_009"><span class="cls_009">set_yylval_name(rb_intern(tok()));</span></div>
<div style="position:absolute;left:138.00px;top:470.40px" class="cls_009"><span class="cls_009">return tGVAR;</span></div>
<div style="position:absolute;left:123.00px;top:492.90px" class="cls_043"><span class="cls_043">Listing 3-11: Consulting </span><span class="cls_065">parse.y</span><span class="cls_043"> is a good way to find a definitive list of Ruby’s many special</span></div>
<div style="position:absolute;left:123.00px;top:503.40px" class="cls_043"><span class="cls_043">variables.</span></div>
<div style="position:absolute;left:141.00px;top:526.31px" class="cls_039"><span class="cls_039">Notice at </span><span class="cls_046">u</span><span class="cls_039"> that Ruby matches a dollar sign character (</span><span class="cls_009">$</span><span class="cls_039">). This is part of the</span></div>
<div style="position:absolute;left:123.01px;top:538.31px" class="cls_039"><span class="cls_039">large C </span><span class="cls_009">switch</span><span class="cls_039"> statement that tokenizes your Ruby code—the process I discussed</span></div>
<div style="position:absolute;left:123.00px;top:550.32px" class="cls_039"><span class="cls_039">in “Tokens: The Words That Make Up the Ruby Language” on page 4. This is</span></div>
<div style="position:absolute;left:405.40px;top:575.87px" class="cls_043"><span class="cls_043">continued</span></div>
<div style="position:absolute;left:349.49px;top:636.00px" class="cls_021"><span class="cls_021">How Ruby Executes Your Code</span></div>
<div style="position:absolute;left:447.10px;top:633.00px" class="cls_020"><span class="cls_020">79</span></div>
</div>
<div style="position:absolute;left:50%;margin-left:-252px;top:67600px;width:504px;height:666px;border-style:outset;overflow:hidden">
<div style="position:absolute;left:0px;top:0px">
<img src="e698b76e-46bd-11eb-8b25-0cc47a792c0a_id_e698b76e-46bd-11eb-8b25-0cc47a792c0a_files/background104.jpg" width=504 height=666></div>
<div style="position:absolute;left:120.00px;top:60.65px" class="cls_039"><span class="cls_039">followed by an inner </span><span class="cls_009">switch</span><span class="cls_039"> statement at </span><span class="cls_046">v</span><span class="cls_039"> that matches on the following character.</span></div>
<div style="position:absolute;left:120.00px;top:72.65px" class="cls_039"><span class="cls_039">Each of these characters and each of the </span><span class="cls_009">case</span><span class="cls_039"> statements that follow (at </span><span class="cls_046">w</span><span class="cls_039"> and</span></div>
<div style="position:absolute;left:120.00px;top:84.66px" class="cls_039"><span class="cls_039">after </span><span class="cls_046">x</span><span class="cls_039">) correspond to one of Ruby’s special variables.</span></div>
<div style="position:absolute;left:138.00px;top:96.66px" class="cls_039"><span class="cls_039">Just a bit farther down in the function, more C code (see Listing 3-12) parses</span></div>
<div style="position:absolute;left:120.00px;top:108.65px" class="cls_039"><span class="cls_039">other special variable tokens that you write in your Ruby code, such as </span><span class="cls_009">$&</span><span class="cls_039"> and</span></div>
<div style="position:absolute;left:120.00px;top:120.66px" class="cls_039"><span class="cls_039">related special variables.</span></div>
<div style="position:absolute;left:109.50px;top:143.15px" class="cls_045"><span class="cls_045">u</span><span class="cls_009"> case '&':</span></div>
<div style="position:absolute;left:213.69px;top:143.15px" class="cls_009"><span class="cls_009">/* $&: last match */</span></div>
<div style="position:absolute;left:120.00px;top:152.66px" class="cls_009"><span class="cls_009">case '`':</span></div>
<div style="position:absolute;left:213.75px;top:152.66px" class="cls_009"><span class="cls_009">/* $`: string before last match */</span></div>
<div style="position:absolute;left:120.00px;top:162.16px" class="cls_009"><span class="cls_009">case '\'':</span></div>
<div style="position:absolute;left:213.75px;top:162.16px" class="cls_009"><span class="cls_009">/* $': string after last match */</span></div>
<div style="position:absolute;left:120.00px;top:171.66px" class="cls_009"><span class="cls_009">case '+':</span></div>
<div style="position:absolute;left:213.75px;top:171.66px" class="cls_009"><span class="cls_009">/* $+: string matches last paren. */</span></div>
<div style="position:absolute;left:127.50px;top:181.16px" class="cls_009"><span class="cls_009">if (last_state == EXPR_FNAME) {</span></div>
<div style="position:absolute;left:142.50px;top:190.67px" class="cls_009"><span class="cls_009">tokadd('$');</span></div>
<div style="position:absolute;left:142.50px;top:200.17px" class="cls_009"><span class="cls_009">tokadd(c);</span></div>
<div style="position:absolute;left:142.50px;top:209.67px" class="cls_009"><span class="cls_009">goto gvar;</span></div>
<div style="position:absolute;left:127.50px;top:219.17px" class="cls_009"><span class="cls_009">}</span></div>
<div style="position:absolute;left:127.50px;top:228.68px" class="cls_009"><span class="cls_009">set_yylval_node(NEW_BACK_REF(c));</span></div>
<div style="position:absolute;left:127.50px;top:238.18px" class="cls_009"><span class="cls_009">return tBACK_REF;</span></div>
<div style="position:absolute;left:120.00px;top:260.65px" class="cls_043"><span class="cls_043">Listing 3-12: These </span><span class="cls_015">case</span><span class="cls_043"> statements correspond to Ruby’s regex-related special variables.</span></div>
<div style="position:absolute;left:138.00px;top:283.65px" class="cls_039"><span class="cls_039">At </span><span class="cls_046">u</span><span class="cls_039"> you can see four more </span><span class="cls_009">case</span><span class="cls_039"> statements corresponding to the special vari-</span></div>
<div style="position:absolute;left:120.00px;top:295.65px" class="cls_039"><span class="cls_039">ables </span><span class="cls_009">$&</span><span class="cls_039">, </span><span class="cls_009">$`</span><span class="cls_039">, </span><span class="cls_009">$/</span><span class="cls_039">, and </span><span class="cls_009">$+</span><span class="cls_039">, all related to regular expressions.</span></div>
<div style="position:absolute;left:138.00px;top:307.65px" class="cls_039"><span class="cls_039">Finally, the code in Listing 3-13 tokenizes </span><span class="cls_009">$1</span><span class="cls_039">, </span><span class="cls_009">$2</span><span class="cls_039">, and so on, producing the</span></div>
<div style="position:absolute;left:120.00px;top:319.66px" class="cls_039"><span class="cls_039">special variables that return the nth back reference from the last regular expression</span></div>
<div style="position:absolute;left:120.00px;top:331.66px" class="cls_039"><span class="cls_039">operation.</span></div>
<div style="position:absolute;left:109.50px;top:354.15px" class="cls_045"><span class="cls_045">u</span><span class="cls_009"> case '1': case '2': case '3':</span></div>
<div style="position:absolute;left:120.00px;top:363.66px" class="cls_009"><span class="cls_009">case '4': case '5': case '6':</span></div>
<div style="position:absolute;left:120.00px;top:373.16px" class="cls_009"><span class="cls_009">case '7': case '8': case '9':</span></div>
<div style="position:absolute;left:127.50px;top:382.66px" class="cls_009"><span class="cls_009">tokadd('$');</span></div>
<div style="position:absolute;left:109.50px;top:392.16px" class="cls_045"><span class="cls_045">v</span><span class="cls_009">   do {</span></div>
<div style="position:absolute;left:142.50px;top:401.67px" class="cls_009"><span class="cls_009">tokadd(c);</span></div>
<div style="position:absolute;left:142.50px;top:411.17px" class="cls_009"><span class="cls_009">c = nextc();</span></div>
<div style="position:absolute;left:127.50px;top:420.67px" class="cls_009"><span class="cls_009">} while (c != -1 && ISDIGIT(c));</span></div>
<div style="position:absolute;left:127.50px;top:430.17px" class="cls_009"><span class="cls_009">pushback(c);</span></div>
<div style="position:absolute;left:127.50px;top:439.68px" class="cls_009"><span class="cls_009">if (last_state == EXPR_FNAME) goto gvar;</span></div>
<div style="position:absolute;left:127.50px;top:449.18px" class="cls_009"><span class="cls_009">tokfix();</span></div>
<div style="position:absolute;left:127.50px;top:458.68px" class="cls_009"><span class="cls_009">set_yylval_node(NEW_NTH_REF(atoi(tok()+1)));</span></div>
<div style="position:absolute;left:127.50px;top:468.18px" class="cls_009"><span class="cls_009">return tNTH_REF;</span></div>
<div style="position:absolute;left:120.00px;top:490.65px" class="cls_043"><span class="cls_043">Listing 3-13: This C code tokenizes Ruby’s nth back reference special variables: </span><span class="cls_015">$1</span><span class="cls_043">, </span><span class="cls_015">$2</span><span class="cls_043">, and so</span></div>
<div style="position:absolute;left:120.00px;top:501.15px" class="cls_043"><span class="cls_043">forth.</span></div>
<div style="position:absolute;left:138.00px;top:524.15px" class="cls_039"><span class="cls_039">The </span><span class="cls_009">case</span><span class="cls_039"> statements at </span><span class="cls_046">u</span><span class="cls_039"> match the numerical digits 1 through 9, while the C</span></div>
<div style="position:absolute;left:120.00px;top:536.15px" class="cls_009"><span class="cls_009">do...while</span><span class="cls_039"> loop at </span><span class="cls_046">v</span><span class="cls_039"> continues to process digits until an entire number is read in.</span></div>
<div style="position:absolute;left:120.00px;top:548.15px" class="cls_039"><span class="cls_039">This allows you to create special variables with multiple digits, such as </span><span class="cls_009">$12</span><span class="cls_039">.</span></div>
<div style="position:absolute;left:48.00px;top:633.00px" class="cls_020"><span class="cls_020">80</span></div>
<div style="position:absolute;left:70.04px;top:636.00px" class="cls_021"><span class="cls_021">Chapter 3</span></div>
</div>
<div style="position:absolute;left:50%;margin-left:-252px;top:68276px;width:504px;height:666px;border-style:outset;overflow:hidden">
<div style="position:absolute;left:0px;top:0px">
<img src="e698b76e-46bd-11eb-8b25-0cc47a792c0a_id_e698b76e-46bd-11eb-8b25-0cc47a792c0a_files/background105.jpg" width=504 height=666></div>
<div style="position:absolute;left:69.00px;top:42.05px" class="cls_031"><span class="cls_031">Summary</span></div>
<div style="position:absolute;left:123.00px;top:62.05px" class="cls_007"><span class="cls_007">We’ve covered a lot of ground in this chapter. We began by looking at how</span></div>
<div style="position:absolute;left:123.00px;top:74.05px" class="cls_007"><span class="cls_007">Ruby keeps track of two stacks: an internal stack YARV uses and your Ruby</span></div>
<div style="position:absolute;left:123.00px;top:86.05px" class="cls_007"><span class="cls_007">call stack. Next, we saw how YARV executed two simple Ruby programs:</span></div>
<div style="position:absolute;left:123.00px;top:98.05px" class="cls_007"><span class="cls_007">one that calculated 2 + 2 = 4 and another that called a block 10 times. In</span></div>
<div style="position:absolute;left:123.00px;top:110.05px" class="cls_007"><span class="cls_007">Experiment 3-1 we learned that executing YARV instructions in Ruby 2.0</span></div>
<div style="position:absolute;left:123.00px;top:122.05px" class="cls_007"><span class="cls_007">and 1.9 is almost four times faster than in Ruby 1.8, which executes your</span></div>
<div style="position:absolute;left:123.00px;top:134.05px" class="cls_007"><span class="cls_007">program directly from the AST.</span></div>
<div style="position:absolute;left:141.00px;top:146.05px" class="cls_007"><span class="cls_007">We moved on to look at how Ruby saves variables on the internal YARV</span></div>
<div style="position:absolute;left:123.00px;top:158.05px" class="cls_007"><span class="cls_007">stack using two methods: local and dynamic variable access. We also saw</span></div>
<div style="position:absolute;left:123.00px;top:170.05px" class="cls_007"><span class="cls_007">how method arguments are handled by Ruby in just the same way as local</span></div>
<div style="position:absolute;left:123.00px;top:182.05px" class="cls_007"><span class="cls_007">variables. In Experiment 3-2 we finished with a look at how Ruby handles</span></div>
<div style="position:absolute;left:123.00px;top:194.05px" class="cls_007"><span class="cls_007">special variables.</span></div>
<div style="position:absolute;left:141.00px;top:206.05px" class="cls_007"><span class="cls_007">When you run any Ruby program, you are actually using a virtual</span></div>
<div style="position:absolute;left:123.00px;top:218.05px" class="cls_007"><span class="cls_007">machine designed specifically to execute Ruby programs. By examining</span></div>
<div style="position:absolute;left:123.00px;top:230.05px" class="cls_007"><span class="cls_007">how this machine works on a detailed level, we’ve acquired a deeper under-</span></div>
<div style="position:absolute;left:123.00px;top:242.05px" class="cls_007"><span class="cls_007">standing of how the Ruby language works and, for example, what happens</span></div>
<div style="position:absolute;left:123.00px;top:254.05px" class="cls_007"><span class="cls_007">when you call a method or save a value in a local variable. In Chapter 4 we’ll</span></div>
<div style="position:absolute;left:123.00px;top:266.05px" class="cls_007"><span class="cls_007">continue to explore this virtual machine by looking at how control struc-</span></div>
<div style="position:absolute;left:123.00px;top:278.05px" class="cls_007"><span class="cls_007">tures work and at YARV’s method dispatch process.</span></div>
<div style="position:absolute;left:349.76px;top:636.00px" class="cls_021"><span class="cls_021">How Ruby Executes Your Code</span></div>
<div style="position:absolute;left:447.36px;top:633.00px" class="cls_020"><span class="cls_020">81</span></div>
</div>
<div style="position:absolute;left:50%;margin-left:-252px;top:68952px;width:504px;height:666px;border-style:outset;overflow:hidden">
<div style="position:absolute;left:0px;top:0px">
<img src="e698b76e-46bd-11eb-8b25-0cc47a792c0a_id_e698b76e-46bd-11eb-8b25-0cc47a792c0a_files/background106.jpg" width=504 height=666></div>
<div style="position:absolute;left:226.70px;top:287.91px" class="cls_024"><span class="cls_024">YARV uses its own internal set</span></div>
<div style="position:absolute;left:234.47px;top:305.92px" class="cls_024"><span class="cls_024">of control structures, like the</span></div>
<div style="position:absolute;left:236.79px;top:323.92px" class="cls_024"><span class="cls_024">structures you use in Ruby.</span></div>
</div>
<div style="position:absolute;left:50%;margin-left:-252px;top:69628px;width:504px;height:666px;border-style:outset;overflow:hidden">
<div style="position:absolute;left:0px;top:0px">
<img src="e698b76e-46bd-11eb-8b25-0cc47a792c0a_id_e698b76e-46bd-11eb-8b25-0cc47a792c0a_files/background107.jpg" width=504 height=666></div>
<div style="position:absolute;left:260.10px;top:101.45px" class="cls_035"><span class="cls_035">4</span></div>
<div style="position:absolute;left:154.47px;top:253.45px" class="cls_016"><span class="cls_016">Control Structures and</span></div>
<div style="position:absolute;left:197.57px;top:271.45px" class="cls_016"><span class="cls_016">Method Dispatch</span></div>
<div style="position:absolute;left:123.00px;top:387.45px" class="cls_023"><span class="cls_023">In Chapter 3 I explained how YARV uses a stack while</span></div>
<div style="position:absolute;left:123.00px;top:405.46px" class="cls_023"><span class="cls_023">executing its instruction set and how it can access</span></div>
<div style="position:absolute;left:123.00px;top:423.46px" class="cls_023"><span class="cls_023">variables locally or dynamically. Controlling the flow</span></div>
<div style="position:absolute;left:123.00px;top:441.46px" class="cls_023"><span class="cls_023">of execution is another fundamental requirement for</span></div>
<div style="position:absolute;left:123.00px;top:459.47px" class="cls_023"><span class="cls_023">any programming language, and Ruby has a rich set</span></div>
<div style="position:absolute;left:123.00px;top:477.47px" class="cls_023"><span class="cls_023">of control structures, too. How does YARV implement</span></div>
<div style="position:absolute;left:123.00px;top:495.48px" class="cls_023"><span class="cls_023">control structures?</span></div>
<div style="position:absolute;left:141.00px;top:514.45px" class="cls_007"><span class="cls_007">Like Ruby, YARV has its own control structures, albeit at a much lower</span></div>
<div style="position:absolute;left:123.00px;top:526.45px" class="cls_007"><span class="cls_007">level. Instead of </span><span class="cls_030">if</span><span class="cls_007"> or </span><span class="cls_030">unless</span><span class="cls_007"> statements, YARV uses two low-level instruc-</span></div>
<div style="position:absolute;left:123.00px;top:538.45px" class="cls_007"><span class="cls_007">tions called </span><span class="cls_030">branchif</span><span class="cls_007"> and </span><span class="cls_030">branchunless</span><span class="cls_007">. Instead of using control structures</span></div>
<div style="position:absolute;left:123.00px;top:550.45px" class="cls_007"><span class="cls_007">such as </span><span class="cls_030">while...end</span><span class="cls_007"> or </span><span class="cls_030">until...end</span><span class="cls_007"> loops, YARV has a single low-level function</span></div>
<div style="position:absolute;left:123.00px;top:562.45px" class="cls_007"><span class="cls_007">called </span><span class="cls_030">jump</span><span class="cls_007"> that allows it to change the program counter and move through</span></div>
<div style="position:absolute;left:123.00px;top:574.45px" class="cls_007"><span class="cls_007">your compiled program. By combining the </span><span class="cls_030">branchif</span><span class="cls_007"> or </span><span class="cls_030">branchunless</span><span class="cls_007"> instruc-</span></div>
<div style="position:absolute;left:123.00px;top:586.45px" class="cls_007"><span class="cls_007">tion with the </span><span class="cls_030">jump</span><span class="cls_007"> instruction, YARV can execute most of Ruby’s simple con-</span></div>
<div style="position:absolute;left:122.99px;top:598.45px" class="cls_007"><span class="cls_007">trol structures.</span></div>
</div>
<div style="position:absolute;left:50%;margin-left:-252px;top:70304px;width:504px;height:666px;border-style:outset;overflow:hidden">
<div style="position:absolute;left:0px;top:0px">
<img src="e698b76e-46bd-11eb-8b25-0cc47a792c0a_id_e698b76e-46bd-11eb-8b25-0cc47a792c0a_files/background108.jpg" width=504 height=666></div>
<div style="position:absolute;left:138.00px;top:41.60px" class="cls_007"><span class="cls_007">When your code calls a method, YARV uses the </span><span class="cls_030">send</span><span class="cls_007"> instruction. This</span></div>
<div style="position:absolute;left:120.00px;top:53.60px" class="cls_007"><span class="cls_007">process is known as </span><span class="cls_008">method dispatch</span><span class="cls_007">. You can consider </span><span class="cls_030">send</span><span class="cls_007"> to be another one</span></div>
<div style="position:absolute;left:120.00px;top:65.60px" class="cls_007"><span class="cls_007">of Ruby’s control structures—the most complex and sophisticated one of all.</span></div>
<div style="position:absolute;left:138.00px;top:77.60px" class="cls_007"><span class="cls_007">In this chapter we’ll learn more about YARV by exploring how it con-</span></div>
<div style="position:absolute;left:120.00px;top:89.60px" class="cls_007"><span class="cls_007">trols execution flow in your program. We’ll also look at the method dis-</span></div>
<div style="position:absolute;left:120.00px;top:101.60px" class="cls_007"><span class="cls_007">patch process as we learn how Ruby categorizes methods into types, calling</span></div>
<div style="position:absolute;left:120.00px;top:113.60px" class="cls_007"><span class="cls_007">each method type differently.</span></div>
<div style="position:absolute;left:261.47px;top:148.31px" class="cls_020"><span class="cls_020">Roadma p</span></div>
<div style="position:absolute;left:132.00px;top:165.31px" class="cls_017"><span class="cls_017">How Ruby Executes an </span><span class="cls_030">if</span><span class="cls_017"> Statement</span></div>
<div style="position:absolute;left:420.91px;top:165.31px" class="cls_017"><span class="cls_017">84</span></div>
<div style="position:absolute;left:132.00px;top:182.31px" class="cls_017"><span class="cls_017">Jumping from One Scope to Another</span></div>
<div style="position:absolute;left:420.91px;top:182.31px" class="cls_017"><span class="cls_017">86</span></div>
<div style="position:absolute;left:150.00px;top:199.32px" class="cls_017"><span class="cls_017">Catch Tables</span></div>
<div style="position:absolute;left:420.91px;top:199.32px" class="cls_017"><span class="cls_017">88</span></div>
<div style="position:absolute;left:150.00px;top:216.32px" class="cls_017"><span class="cls_017">Other Uses for Catch Tables</span></div>
<div style="position:absolute;left:420.91px;top:216.32px" class="cls_017"><span class="cls_017">90</span></div>
<div style="position:absolute;left:132.00px;top:233.31px" class="cls_019"><span class="cls_019">Experiment 4-1: Testing How Ruby Implements </span><span class="cls_040">for</span><span class="cls_019"> Loops Internally</span></div>
<div style="position:absolute;left:421.60px;top:233.31px" class="cls_019"><span class="cls_019">90</span></div>
<div style="position:absolute;left:132.00px;top:250.31px" class="cls_017"><span class="cls_017">The </span><span class="cls_030">send</span><span class="cls_017"> Instruction: Ruby’s Most Complex Control Structure</span></div>
<div style="position:absolute;left:420.91px;top:250.31px" class="cls_017"><span class="cls_017">92</span></div>
<div style="position:absolute;left:150.00px;top:267.31px" class="cls_017"><span class="cls_017">Method Lookup and Method Dispatch</span></div>
<div style="position:absolute;left:420.91px;top:267.31px" class="cls_017"><span class="cls_017">92</span></div>
<div style="position:absolute;left:150.00px;top:284.32px" class="cls_017"><span class="cls_017">Eleven Types of Ruby Methods</span></div>
<div style="position:absolute;left:420.91px;top:284.32px" class="cls_017"><span class="cls_017">93</span></div>
<div style="position:absolute;left:132.00px;top:301.32px" class="cls_017"><span class="cls_017">Calling Normal Ruby Methods</span></div>
<div style="position:absolute;left:420.91px;top:301.32px" class="cls_017"><span class="cls_017">95</span></div>
<div style="position:absolute;left:150.00px;top:318.32px" class="cls_017"><span class="cls_017">Preparing Arguments for Normal Ruby Methods</span></div>
<div style="position:absolute;left:420.91px;top:318.32px" class="cls_017"><span class="cls_017">95</span></div>
<div style="position:absolute;left:132.00px;top:335.32px" class="cls_017"><span class="cls_017">Calling Built-In Ruby Methods</span></div>
<div style="position:absolute;left:420.91px;top:335.32px" class="cls_017"><span class="cls_017">97</span></div>
<div style="position:absolute;left:150.00px;top:352.31px" class="cls_017"><span class="cls_017">Calling </span><span class="cls_030">attr_reader</span><span class="cls_017"> and </span><span class="cls_030">attr_writer</span></div>
<div style="position:absolute;left:420.91px;top:352.31px" class="cls_017"><span class="cls_017">97</span></div>
<div style="position:absolute;left:150.00px;top:369.31px" class="cls_017"><span class="cls_017">Method Dispatch Optimizes </span><span class="cls_030">attr_reader</span><span class="cls_017"> and </span><span class="cls_030">attr_writer</span></div>
<div style="position:absolute;left:420.92px;top:369.31px" class="cls_017"><span class="cls_017">98</span></div>
<div style="position:absolute;left:132.01px;top:386.31px" class="cls_019"><span class="cls_019">Experiment 4-2: Exploring How Ruby Implements Keyword Arguments</span></div>
<div style="position:absolute;left:421.60px;top:386.31px" class="cls_019"><span class="cls_019">99</span></div>
<div style="position:absolute;left:132.01px;top:403.32px" class="cls_017"><span class="cls_017">Summary</span></div>
<div style="position:absolute;left:415.37px;top:403.32px" class="cls_017"><span class="cls_017">103</span></div>
<div style="position:absolute;left:66.00px;top:440.60px" class="cls_031"><span class="cls_031">How Ruby Executes an if Statement</span></div>
<div style="position:absolute;left:120.00px;top:460.60px" class="cls_007"><span class="cls_007">In order to understand how YARV controls execution flow, let’s see how the</span></div>
<div style="position:absolute;left:120.00px;top:472.60px" class="cls_030"><span class="cls_030">if...else</span><span class="cls_007"> statement works. The left side of Figure 4-1 shows a simple Ruby</span></div>
<div style="position:absolute;left:120.00px;top:484.60px" class="cls_007"><span class="cls_007">script that uses both </span><span class="cls_030">if</span><span class="cls_007"> and </span><span class="cls_030">else</span><span class="cls_007">. On the right side of the figure, you can</span></div>
<div style="position:absolute;left:120.00px;top:496.60px" class="cls_007"><span class="cls_007">see the corresponding snippet of compiled YARV instructions. Reading the</span></div>
<div style="position:absolute;left:120.00px;top:508.60px" class="cls_007"><span class="cls_007">YARV instructions, you see that Ruby follows a pattern for implementing</span></div>
<div style="position:absolute;left:120.00px;top:520.60px" class="cls_007"><span class="cls_007">the </span><span class="cls_030">if...else</span><span class="cls_007"> statement. It goes like this:</span></div>
<div style="position:absolute;left:120.00px;top:541.60px" class="cls_007"><span class="cls_007">1.   Evaluate condition</span></div>
<div style="position:absolute;left:120.00px;top:556.60px" class="cls_007"><span class="cls_007">2.  Jump to false code if condition is false</span></div>
<div style="position:absolute;left:120.00px;top:571.60px" class="cls_007"><span class="cls_007">3.  True code; jump past false code</span></div>
<div style="position:absolute;left:120.00px;top:586.60px" class="cls_007"><span class="cls_007">4.  False code</span></div>
<div style="position:absolute;left:48.00px;top:633.00px" class="cls_020"><span class="cls_020">84</span></div>
<div style="position:absolute;left:70.10px;top:636.00px" class="cls_021"><span class="cls_021">Chapter 4</span></div>
</div>
<div style="position:absolute;left:50%;margin-left:-252px;top:70980px;width:504px;height:666px;border-style:outset;overflow:hidden">
<div style="position:absolute;left:0px;top:0px">
<img src="e698b76e-46bd-11eb-8b25-0cc47a792c0a_id_e698b76e-46bd-11eb-8b25-0cc47a792c0a_files/background109.jpg" width=504 height=666></div>
<div style="position:absolute;left:125.66px;top:46.60px" class="cls_063"><span class="cls_063">i = 0</span></div>
<div style="position:absolute;left:237.70px;top:46.62px" class="cls_014"><span class="cls_014">0000 trace</span></div>
<div style="position:absolute;left:325.76px;top:46.62px" class="cls_014"><span class="cls_014">1</span></div>
<div style="position:absolute;left:237.70px;top:55.12px" class="cls_014"><span class="cls_014">0002 putobject</span></div>
<div style="position:absolute;left:325.76px;top:55.12px" class="cls_014"><span class="cls_014">0</span></div>
<div style="position:absolute;left:125.66px;top:57.69px" class="cls_063"><span class="cls_063">if i &lt; 10</span></div>
<div style="position:absolute;left:237.70px;top:63.63px" class="cls_014"><span class="cls_014">0003 setlocal</span></div>
<div style="position:absolute;left:325.76px;top:63.63px" class="cls_014"><span class="cls_014">2, 0</span></div>
<div style="position:absolute;left:135.16px;top:68.45px" class="cls_063"><span class="cls_063">puts "small"</span></div>
<div style="position:absolute;left:237.70px;top:72.13px" class="cls_014"><span class="cls_014">0005 trace</span></div>
<div style="position:absolute;left:325.76px;top:72.13px" class="cls_014"><span class="cls_014">1</span></div>
<div style="position:absolute;left:125.66px;top:79.89px" class="cls_063"><span class="cls_063">else</span></div>
<div style="position:absolute;left:237.70px;top:80.63px" class="cls_014"><span class="cls_014">0007 getlocal</span></div>
<div style="position:absolute;left:325.76px;top:80.63px" class="cls_014"><span class="cls_014">2, 0</span></div>
<div style="position:absolute;left:237.70px;top:89.14px" class="cls_014"><span class="cls_014">0009 putobject</span></div>
<div style="position:absolute;left:325.76px;top:89.14px" class="cls_014"><span class="cls_014">10</span></div>
<div style="position:absolute;left:135.16px;top:90.65px" class="cls_063"><span class="cls_063">puts "large"</span></div>
<div style="position:absolute;left:237.70px;top:97.64px" class="cls_014"><span class="cls_014">0011 opt_lt</span></div>
<div style="position:absolute;left:325.76px;top:97.64px" class="cls_014"><span class="cls_014">&lt;callinfo!mid:&lt;, argc:1</span></div>
<div style="position:absolute;left:125.66px;top:103.09px" class="cls_063"><span class="cls_063">end</span></div>
<div style="position:absolute;left:237.70px;top:106.15px" class="cls_014"><span class="cls_014">0013 branchunless</span></div>
<div style="position:absolute;left:325.76px;top:106.15px" class="cls_014"><span class="cls_014">25</span></div>
<div style="position:absolute;left:125.66px;top:113.19px" class="cls_063"><span class="cls_063">puts "done"</span></div>
<div style="position:absolute;left:237.70px;top:114.65px" class="cls_014"><span class="cls_014">0015 trace</span></div>
<div style="position:absolute;left:325.76px;top:114.65px" class="cls_014"><span class="cls_014">1</span></div>
<div style="position:absolute;left:237.70px;top:123.15px" class="cls_014"><span class="cls_014">0017 putself</span></div>
<div style="position:absolute;left:237.70px;top:131.66px" class="cls_014"><span class="cls_014">0018 putstring</span></div>
<div style="position:absolute;left:325.76px;top:131.66px" class="cls_014"><span class="cls_014">"small"</span></div>
<div style="position:absolute;left:237.70px;top:140.16px" class="cls_014"><span class="cls_014">0020 opt_send_simple</span></div>
<div style="position:absolute;left:325.76px;top:140.16px" class="cls_014"><span class="cls_014">&lt;callinfo!mid:puts, argc:1</span></div>
<div style="position:absolute;left:237.70px;top:148.67px" class="cls_014"><span class="cls_014">0022 pop</span></div>
<div style="position:absolute;left:237.70px;top:157.17px" class="cls_014"><span class="cls_014">0023 jump</span></div>
<div style="position:absolute;left:325.76px;top:157.17px" class="cls_014"><span class="cls_014">33</span></div>
<div style="position:absolute;left:237.70px;top:165.67px" class="cls_014"><span class="cls_014">0025 trace</span></div>
<div style="position:absolute;left:325.76px;top:165.67px" class="cls_014"><span class="cls_014">1</span></div>
<div style="position:absolute;left:237.70px;top:174.18px" class="cls_014"><span class="cls_014">0027 putself</span></div>
<div style="position:absolute;left:237.70px;top:182.68px" class="cls_014"><span class="cls_014">0028 putstring</span></div>
<div style="position:absolute;left:325.76px;top:182.68px" class="cls_014"><span class="cls_014">"large"</span></div>
<div style="position:absolute;left:237.70px;top:191.19px" class="cls_014"><span class="cls_014">0030 opt_send_simple</span></div>
<div style="position:absolute;left:325.76px;top:191.19px" class="cls_014"><span class="cls_014">&lt;callinfo!mid:puts, argc:1</span></div>
<div style="position:absolute;left:237.70px;top:199.69px" class="cls_014"><span class="cls_014">0032 pop</span></div>
<div style="position:absolute;left:237.70px;top:208.19px" class="cls_014"><span class="cls_014">0033 trace</span></div>
<div style="position:absolute;left:325.76px;top:208.19px" class="cls_014"><span class="cls_014">1</span></div>
<div style="position:absolute;left:237.70px;top:216.70px" class="cls_014"><span class="cls_014">0035 putself</span></div>
<div style="position:absolute;left:237.70px;top:225.20px" class="cls_014"><span class="cls_014">0036 putstring</span></div>
<div style="position:absolute;left:325.76px;top:225.20px" class="cls_014"><span class="cls_014">"done"</span></div>
<div style="position:absolute;left:237.70px;top:233.71px" class="cls_014"><span class="cls_014">0038 opt_send_simple</span></div>
<div style="position:absolute;left:325.76px;top:233.71px" class="cls_014"><span class="cls_014">&lt;callinfo!mid:puts, argc:1</span></div>
<div style="position:absolute;left:237.70px;top:242.21px" class="cls_014"><span class="cls_014">0040 leave</span></div>
<div style="position:absolute;left:123.00px;top:263.56px" class="cls_038"><span class="cls_038">Figure 4-1: How Ruby compiles an </span><span class="cls_014">if...else</span><span class="cls_038"> statement</span></div>
<div style="position:absolute;left:141.00px;top:286.06px" class="cls_007"><span class="cls_007">This pattern should be a bit easier to follow in the flowchart shown</span></div>
<div style="position:absolute;left:123.00px;top:298.06px" class="cls_007"><span class="cls_007">in Figure 4-2 on the next page. The </span><span class="cls_030">branchunless</span><span class="cls_007"> instruction in the center</span></div>
<div style="position:absolute;left:123.00px;top:310.06px" class="cls_007"><span class="cls_007">of the figure is the key to how Ruby implements </span><span class="cls_030">if</span><span class="cls_007"> statements. It works as</span></div>
<div style="position:absolute;left:123.00px;top:322.06px" class="cls_007"><span class="cls_007">follows:</span></div>
<div style="position:absolute;left:123.00px;top:343.06px" class="cls_007"><span class="cls_007">1.   Ruby evaluates the condition of the </span><span class="cls_030">if</span><span class="cls_007"> statement, </span><span class="cls_030">i &lt; 10</span><span class="cls_007">, using the </span><span class="cls_030">opt_lt</span></div>
<div style="position:absolute;left:141.00px;top:355.06px" class="cls_007"><span class="cls_007">(optimized less-than) instruction. This evaluation leaves either a true</span></div>
<div style="position:absolute;left:141.00px;top:367.06px" class="cls_007"><span class="cls_007">or false value on the stack.</span></div>
<div style="position:absolute;left:123.00px;top:382.06px" class="cls_007"><span class="cls_007">2.</span><span class="cls_030">  branchunless</span><span class="cls_007"> jumps down to the </span><span class="cls_030">else</span><span class="cls_007"> code if the condition is false. That</span></div>
<div style="position:absolute;left:141.00px;top:394.06px" class="cls_007"><span class="cls_007">is, it “branches unless” the condition is true. Ruby uses </span><span class="cls_030">branchunless</span><span class="cls_007">, not</span></div>
<div style="position:absolute;left:141.00px;top:406.06px" class="cls_030"><span class="cls_030">branchif</span><span class="cls_007">, for </span><span class="cls_030">if...else</span><span class="cls_007"> conditions because the positive case is compiled</span></div>
<div style="position:absolute;left:141.00px;top:418.06px" class="cls_007"><span class="cls_007">to appear right after the condition code. Therefore, YARV needs to</span></div>
<div style="position:absolute;left:141.00px;top:430.06px" class="cls_007"><span class="cls_007">jump if the condition is false.</span></div>
<div style="position:absolute;left:123.00px;top:445.06px" class="cls_007"><span class="cls_007">3.  If the condition is true, Ruby does not branch and just continues to</span></div>
<div style="position:absolute;left:141.00px;top:457.06px" class="cls_007"><span class="cls_007">execute the positive case code. Once it’s finished, it jumps down to the</span></div>
<div style="position:absolute;left:141.00px;top:469.06px" class="cls_007"><span class="cls_007">instructions following the </span><span class="cls_030">if...else</span><span class="cls_007"> statement using the </span><span class="cls_030">jump</span><span class="cls_007"> instruction.</span></div>
<div style="position:absolute;left:123.00px;top:484.06px" class="cls_007"><span class="cls_007">4.  Whether or not it branches, Ruby continues to execute the</span></div>
<div style="position:absolute;left:141.00px;top:496.06px" class="cls_007"><span class="cls_007">subsequent code.</span></div>
<div style="position:absolute;left:141.00px;top:517.06px" class="cls_007"><span class="cls_007">YARV implements the </span><span class="cls_030">unless</span><span class="cls_007"> statement similarly to how it implements</span></div>
<div style="position:absolute;left:123.00px;top:529.06px" class="cls_030"><span class="cls_030">if</span><span class="cls_007">, except that the positive and negative code snippets are in reverse order.</span></div>
<div style="position:absolute;left:123.00px;top:541.06px" class="cls_007"><span class="cls_007">For looping control structures like </span><span class="cls_030">while...end</span><span class="cls_007"> and </span><span class="cls_030">until...end</span><span class="cls_007">, YARV uses</span></div>
<div style="position:absolute;left:123.00px;top:553.06px" class="cls_007"><span class="cls_007">the </span><span class="cls_030">branchif</span><span class="cls_007"> instruction instead, but the idea is the same: Calculate the</span></div>
<div style="position:absolute;left:123.00px;top:565.06px" class="cls_007"><span class="cls_007">loop condition, execute </span><span class="cls_030">branchif</span><span class="cls_007"> to jump as necessary, and then use </span><span class="cls_030">jump</span></div>
<div style="position:absolute;left:123.00px;top:577.06px" class="cls_007"><span class="cls_007">statements to implement the loop.</span></div>
<div style="position:absolute;left:327.49px;top:636.00px" class="cls_021"><span class="cls_021">Control Structures and Method Dispatch</span></div>
<div style="position:absolute;left:447.08px;top:633.00px" class="cls_020"><span class="cls_020">85</span></div>
</div>
<div style="position:absolute;left:50%;margin-left:-252px;top:71656px;width:504px;height:666px;border-style:outset;overflow:hidden">
<div style="position:absolute;left:0px;top:0px">
<img src="e698b76e-46bd-11eb-8b25-0cc47a792c0a_id_e698b76e-46bd-11eb-8b25-0cc47a792c0a_files/background110.jpg" width=504 height=666></div>
<div style="position:absolute;left:141.07px;top:49.83px" class="cls_088"><span class="cls_088">0002 putobject</span></div>
<div style="position:absolute;left:207.65px;top:50.38px" class="cls_088"><span class="cls_088">0</span></div>
<div style="position:absolute;left:141.07px;top:60.43px" class="cls_088"><span class="cls_088">0003 setlocal</span></div>
<div style="position:absolute;left:207.65px;top:60.98px" class="cls_088"><span class="cls_088">2, 0</span></div>
<div style="position:absolute;left:141.07px;top:71.03px" class="cls_088"><span class="cls_088">0007 getlocal</span></div>
<div style="position:absolute;left:207.65px;top:71.59px" class="cls_088"><span class="cls_088">2, 0</span></div>
<div style="position:absolute;left:141.07px;top:81.63px" class="cls_088"><span class="cls_088">0009 putobject</span></div>
<div style="position:absolute;left:207.65px;top:82.19px" class="cls_088"><span class="cls_088">10</span></div>
<div style="position:absolute;left:141.07px;top:92.23px" class="cls_088"><span class="cls_088">0011 opt_lt</span></div>
<div style="position:absolute;left:330.10px;top:132.98px" class="cls_089"><span class="cls_089">Jump if</span></div>
<div style="position:absolute;left:312.42px;top:142.26px" class="cls_089"><span class="cls_089">condition is false.</span></div>
<div style="position:absolute;left:189.97px;top:156.82px" class="cls_088"><span class="cls_088">0013 branchunless 25</span></div>
<div style="position:absolute;left:141.07px;top:226.72px" class="cls_088"><span class="cls_088">0017 putself</span></div>
<div style="position:absolute;left:141.07px;top:237.32px" class="cls_088"><span class="cls_088">0018 putstring</span></div>
<div style="position:absolute;left:230.51px;top:237.32px" class="cls_088"><span class="cls_088">"small"</span></div>
<div style="position:absolute;left:141.07px;top:247.92px" class="cls_088"><span class="cls_088">0020 opt_send_simple</span></div>
<div style="position:absolute;left:230.51px;top:247.92px" class="cls_088"><span class="cls_088">&lt;callinfo!mid:puts, argc:1</span></div>
<div style="position:absolute;left:141.07px;top:258.52px" class="cls_088"><span class="cls_088">0022 pop</span></div>
<div style="position:absolute;left:141.07px;top:269.12px" class="cls_088"><span class="cls_088">0023 jump</span></div>
<div style="position:absolute;left:230.51px;top:269.12px" class="cls_088"><span class="cls_088">33</span></div>
<div style="position:absolute;left:141.07px;top:306.77px" class="cls_088"><span class="cls_088">0025 trace</span></div>
<div style="position:absolute;left:230.51px;top:307.44px" class="cls_088"><span class="cls_088">1</span></div>
<div style="position:absolute;left:141.07px;top:317.37px" class="cls_088"><span class="cls_088">0027 putself</span></div>
<div style="position:absolute;left:141.07px;top:327.97px" class="cls_088"><span class="cls_088">0028 putstring</span></div>
<div style="position:absolute;left:230.51px;top:328.64px" class="cls_088"><span class="cls_088">"large"</span></div>
<div style="position:absolute;left:141.07px;top:338.57px" class="cls_088"><span class="cls_088">0030 opt_send_simple</span></div>
<div style="position:absolute;left:230.51px;top:339.24px" class="cls_088"><span class="cls_088">&lt;callinfo!mid:puts, argc:1</span></div>
<div style="position:absolute;left:141.07px;top:349.17px" class="cls_088"><span class="cls_088">0032 pop</span></div>
<div style="position:absolute;left:141.07px;top:386.83px" class="cls_088"><span class="cls_088">0033 trace</span></div>
<div style="position:absolute;left:230.51px;top:386.83px" class="cls_088"><span class="cls_088">1</span></div>
<div style="position:absolute;left:141.07px;top:397.43px" class="cls_088"><span class="cls_088">0035 putself</span></div>
<div style="position:absolute;left:141.07px;top:408.03px" class="cls_088"><span class="cls_088">0036 putstring</span></div>
<div style="position:absolute;left:230.51px;top:408.03px" class="cls_088"><span class="cls_088">"done"</span></div>
<div style="position:absolute;left:141.07px;top:418.63px" class="cls_088"><span class="cls_088">0038 opt_send_simple</span></div>
<div style="position:absolute;left:230.51px;top:418.63px" class="cls_088"><span class="cls_088">&lt;callinfo!mid:puts, argc:1</span></div>
<div style="position:absolute;left:141.07px;top:429.23px" class="cls_088"><span class="cls_088">0040 leave</span></div>
<div style="position:absolute;left:120.00px;top:455.16px" class="cls_038"><span class="cls_038">Figure 4-2: This flowchart shows the pattern Ruby uses to compile</span></div>
<div style="position:absolute;left:120.00px;top:465.66px" class="cls_014"><span class="cls_014">if...else</span><span class="cls_038"> statements.</span></div>
<div style="position:absolute;left:66.00px;top:498.16px" class="cls_031"><span class="cls_031">Jumping from One Scope to Another</span></div>
<div style="position:absolute;left:120.00px;top:518.16px" class="cls_007"><span class="cls_007">One of the challenges YARV has in implementing some control structures</span></div>
<div style="position:absolute;left:120.00px;top:530.16px" class="cls_007"><span class="cls_007">is that, as with dynamic variable access, Ruby can jump from one scope to</span></div>
<div style="position:absolute;left:120.00px;top:542.16px" class="cls_007"><span class="cls_007">another. For example, </span><span class="cls_030">break</span><span class="cls_007"> can be used to exit a simple loop like the one</span></div>
<div style="position:absolute;left:120.00px;top:554.16px" class="cls_007"><span class="cls_007">in Listing 4-1.</span></div>
<div style="position:absolute;left:48.00px;top:633.00px" class="cls_020"><span class="cls_020">86</span></div>
<div style="position:absolute;left:70.06px;top:636.00px" class="cls_021"><span class="cls_021">Chapter 4</span></div>
</div>
<div style="position:absolute;left:50%;margin-left:-252px;top:72332px;width:504px;height:666px;border-style:outset;overflow:hidden">
<div style="position:absolute;left:0px;top:0px">
<img src="e698b76e-46bd-11eb-8b25-0cc47a792c0a_id_e698b76e-46bd-11eb-8b25-0cc47a792c0a_files/background111.jpg" width=504 height=666></div>
<div style="position:absolute;left:123.00px;top:49.00px" class="cls_030"><span class="cls_030">i = 0</span></div>
<div style="position:absolute;left:123.00px;top:59.50px" class="cls_030"><span class="cls_030">while i&lt;10</span></div>
<div style="position:absolute;left:131.50px;top:70.00px" class="cls_030"><span class="cls_030">puts i</span></div>
<div style="position:absolute;left:131.50px;top:80.49px" class="cls_030"><span class="cls_030">i += 1</span></div>
<div style="position:absolute;left:131.50px;top:90.99px" class="cls_030"><span class="cls_030">break</span></div>
<div style="position:absolute;left:123.00px;top:101.49px" class="cls_030"><span class="cls_030">end</span></div>
<div style="position:absolute;left:123.00px;top:123.99px" class="cls_038"><span class="cls_038">Listing 4-1: </span><span class="cls_014">break</span><span class="cls_038"> used to exit a simple loop</span></div>
<div style="position:absolute;left:141.00px;top:146.50px" class="cls_007"><span class="cls_007">And it can also be used to exit a block iteration, like the one in Listing 4-2.</span></div>
<div style="position:absolute;left:123.00px;top:170.50px" class="cls_030"><span class="cls_030">10.times do |n|</span></div>
<div style="position:absolute;left:131.50px;top:181.00px" class="cls_030"><span class="cls_030">puts n</span></div>
<div style="position:absolute;left:131.50px;top:191.49px" class="cls_030"><span class="cls_030">break</span></div>
<div style="position:absolute;left:123.00px;top:201.99px" class="cls_030"><span class="cls_030">end</span></div>
<div style="position:absolute;left:123.00px;top:212.49px" class="cls_030"><span class="cls_030">puts "continue from here"</span></div>
<div style="position:absolute;left:123.00px;top:234.99px" class="cls_038"><span class="cls_038">Listing 4-2: </span><span class="cls_014">break</span><span class="cls_038"> used to exit a block</span></div>
<div style="position:absolute;left:141.00px;top:257.50px" class="cls_007"><span class="cls_007">In the first listing, YARV can exit the </span><span class="cls_030">while</span><span class="cls_007"> loop using simple </span><span class="cls_030">jump</span><span class="cls_007"> instruc-</span></div>
<div style="position:absolute;left:123.00px;top:269.50px" class="cls_007"><span class="cls_007">tions. But exiting a block like the one in the second listing is not so simple:</span></div>
<div style="position:absolute;left:123.00px;top:281.50px" class="cls_007"><span class="cls_007">In this case, YARV needs to jump to the parent scope and continue execution</span></div>
<div style="position:absolute;left:123.00px;top:293.50px" class="cls_007"><span class="cls_007">after the call to </span><span class="cls_030">10.times</span><span class="cls_007">. How does YARV know where to jump to? And how</span></div>
<div style="position:absolute;left:123.00px;top:305.50px" class="cls_007"><span class="cls_007">does it adjust both its internal stack and your Ruby call stack in order to</span></div>
<div style="position:absolute;left:123.00px;top:317.50px" class="cls_007"><span class="cls_007">continue execution properly in the parent scope?</span></div>
<div style="position:absolute;left:141.00px;top:329.50px" class="cls_007"><span class="cls_007">To implement jumping from one place to another in the Ruby call stack</span></div>
<div style="position:absolute;left:123.00px;top:341.50px" class="cls_007"><span class="cls_007">(that is, outside the current scope), Ruby uses the </span><span class="cls_030">throw</span><span class="cls_007"> YARV instruction.</span></div>
<div style="position:absolute;left:123.00px;top:353.50px" class="cls_007"><span class="cls_007">This instruction resembles the Ruby </span><span class="cls_030">throw</span><span class="cls_007"> method: It sends, or throws, the</span></div>
<div style="position:absolute;left:123.00px;top:365.50px" class="cls_007"><span class="cls_007">execution path back up to a higher scope. For example, Figure 4-3 shows</span></div>
<div style="position:absolute;left:123.00px;top:377.50px" class="cls_007"><span class="cls_007">how Ruby compiles Listing 4-2, with the block containing a </span><span class="cls_030">break</span><span class="cls_007"> statement.</span></div>
<div style="position:absolute;left:123.00px;top:389.50px" class="cls_007"><span class="cls_007">The Ruby code is on the left, and the compiled version is on the right.</span></div>
<div style="position:absolute;left:125.98px;top:413.16px" class="cls_090"><span class="cls_090">10.times do |n|</span></div>
<div style="position:absolute;left:280.18px;top:414.65px" class="cls_091"><span class="cls_091">putself</span></div>
<div style="position:absolute;left:135.45px;top:424.50px" class="cls_090"><span class="cls_090">puts n</span></div>
<div style="position:absolute;left:280.18px;top:424.94px" class="cls_091"><span class="cls_091">getlocal</span></div>
<div style="position:absolute;left:347.02px;top:424.98px" class="cls_091"><span class="cls_091">2, 0</span></div>
<div style="position:absolute;left:135.45px;top:435.77px" class="cls_090"><span class="cls_090">break</span></div>
<div style="position:absolute;left:280.18px;top:435.22px" class="cls_091"><span class="cls_091">opt_send_simple</span></div>
<div style="position:absolute;left:347.02px;top:435.26px" class="cls_091"><span class="cls_091">&lt;callinfo!mid:puts, argc:1</span></div>
<div style="position:absolute;left:280.18px;top:445.50px" class="cls_091"><span class="cls_091">pop</span></div>
<div style="position:absolute;left:125.98px;top:446.99px" class="cls_090"><span class="cls_090">end</span></div>
<div style="position:absolute;left:280.18px;top:455.78px" class="cls_091"><span class="cls_091">putnil</span></div>
<div style="position:absolute;left:125.98px;top:458.27px" class="cls_090"><span class="cls_090">puts "continue from here"</span></div>
<div style="position:absolute;left:280.18px;top:466.06px" class="cls_091"><span class="cls_091">throw</span></div>
<div style="position:absolute;left:347.02px;top:466.11px" class="cls_091"><span class="cls_091">2</span></div>
<div style="position:absolute;left:280.18px;top:476.34px" class="cls_091"><span class="cls_091">leave</span></div>
<div style="position:absolute;left:280.18px;top:503.66px" class="cls_091"><span class="cls_091">putobject</span></div>
<div style="position:absolute;left:345.73px;top:503.77px" class="cls_091"><span class="cls_091">10</span></div>
<div style="position:absolute;left:280.18px;top:513.94px" class="cls_091"><span class="cls_091">send</span></div>
<div style="position:absolute;left:345.73px;top:514.05px" class="cls_091"><span class="cls_091">&lt;callinfo!mid:times, argc:0</span></div>
<div style="position:absolute;left:280.18px;top:524.23px" class="cls_091"><span class="cls_091">pop</span></div>
<div style="position:absolute;left:280.18px;top:534.51px" class="cls_091"><span class="cls_091">putself</span></div>
<div style="position:absolute;left:280.18px;top:544.79px" class="cls_091"><span class="cls_091">putstring</span></div>
<div style="position:absolute;left:345.73px;top:544.90px" class="cls_091"><span class="cls_091">"continue from here"</span></div>
<div style="position:absolute;left:280.18px;top:555.07px" class="cls_091"><span class="cls_091">opt_send_simple</span></div>
<div style="position:absolute;left:345.73px;top:555.18px" class="cls_091"><span class="cls_091">&lt;callinfo!mid:puts, argc:1</span></div>
<div style="position:absolute;left:280.18px;top:565.35px" class="cls_091"><span class="cls_091">leave</span></div>
<div style="position:absolute;left:123.00px;top:589.73px" class="cls_038"><span class="cls_038">Figure 4-3: How Ruby compiles a </span><span class="cls_014">break</span><span class="cls_038"> statement used inside a block</span></div>
<div style="position:absolute;left:327.57px;top:636.00px" class="cls_021"><span class="cls_021">Control Structures and Method Dispatch</span></div>
<div style="position:absolute;left:447.16px;top:633.00px" class="cls_020"><span class="cls_020">87</span></div>
</div>
<div style="position:absolute;left:50%;margin-left:-252px;top:73008px;width:504px;height:666px;border-style:outset;overflow:hidden">
<div style="position:absolute;left:0px;top:0px">
<img src="e698b76e-46bd-11eb-8b25-0cc47a792c0a_id_e698b76e-46bd-11eb-8b25-0cc47a792c0a_files/background112.jpg" width=504 height=666></div>
<div style="position:absolute;left:120.00px;top:42.55px" class="cls_055"><span class="cls_055">Catch Tables</span></div>
<div style="position:absolute;left:120.00px;top:60.55px" class="cls_007"><span class="cls_007">At the top right of Figure 4-3, the </span><span class="cls_030">throw 2</span><span class="cls_007"> in the compiled code for the</span></div>
<div style="position:absolute;left:120.00px;top:72.55px" class="cls_007"><span class="cls_007">block throws an exception at the YARV instruction level using a </span><span class="cls_008">catch table</span><span class="cls_007">, or a</span></div>
<div style="position:absolute;left:120.00px;top:84.55px" class="cls_007"><span class="cls_007">table of pointers that may be attached to any YARV code snippet. Conceptually,</span></div>
<div style="position:absolute;left:120.00px;top:96.55px" class="cls_007"><span class="cls_007">a catch table might look like Figure 4-4.</span></div>
<div style="position:absolute;left:125.60px;top:122.55px" class="cls_067"><span class="cls_067">YARV instructions</span></div>
<div style="position:absolute;left:323.07px;top:122.55px" class="cls_067"><span class="cls_067">Catch Table</span></div>
<div style="position:absolute;left:125.48px;top:141.07px" class="cls_014"><span class="cls_014">putobject</span></div>
<div style="position:absolute;left:195.31px;top:140.61px" class="cls_014"><span class="cls_014">10</span></div>
<div style="position:absolute;left:125.48px;top:152.20px" class="cls_014"><span class="cls_014">send</span></div>
<div style="position:absolute;left:195.31px;top:151.74px" class="cls_014"><span class="cls_014">&lt;callinfo!mid:times, argc:0</span></div>
<div style="position:absolute;left:125.48px;top:163.33px" class="cls_014"><span class="cls_014">pop</span></div>
<div style="position:absolute;left:331.60px;top:163.79px" class="cls_014"><span class="cls_014">BREAK</span></div>
<div style="position:absolute;left:125.48px;top:174.45px" class="cls_014"><span class="cls_014">putself</span></div>
<div style="position:absolute;left:125.48px;top:185.58px" class="cls_014"><span class="cls_014">putstring</span></div>
<div style="position:absolute;left:195.31px;top:185.11px" class="cls_014"><span class="cls_014">"continue from here"</span></div>
<div style="position:absolute;left:125.48px;top:196.71px" class="cls_014"><span class="cls_014">opt_send_simple</span></div>
<div style="position:absolute;left:195.31px;top:196.24px" class="cls_014"><span class="cls_014">&lt;callinfo!mid:puts, argc:1</span></div>
<div style="position:absolute;left:125.48px;top:207.84px" class="cls_014"><span class="cls_014">leave</span></div>
<div style="position:absolute;left:120.00px;top:229.48px" class="cls_038"><span class="cls_038">Figure 4-4: Each snippet of YARV code can contain a catch table.</span></div>
<div style="position:absolute;left:138.00px;top:251.98px" class="cls_007"><span class="cls_007">This catch table contains just a single pointer to the </span><span class="cls_030">pop</span><span class="cls_007"> statement,</span></div>
<div style="position:absolute;left:120.00px;top:263.98px" class="cls_007"><span class="cls_007">where execution would continue after an exception. Whenever you use a</span></div>
<div style="position:absolute;left:120.00px;top:275.98px" class="cls_030"><span class="cls_030">break</span><span class="cls_007"> statement in a block, Ruby compiles the </span><span class="cls_030">throw</span><span class="cls_007"> instruction into the</span></div>
<div style="position:absolute;left:120.00px;top:287.98px" class="cls_007"><span class="cls_007">block’s code. And whenever you call a block or write a loop using </span><span class="cls_030">while</span><span class="cls_007">, </span><span class="cls_030">for</span><span class="cls_007">,</span></div>
<div style="position:absolute;left:120.00px;top:299.98px" class="cls_007"><span class="cls_007">and so on, Ruby adds the </span><span class="cls_030">BREAK</span><span class="cls_007"> entry into the parent scope’s catch table. If</span></div>
<div style="position:absolute;left:120.00px;top:311.98px" class="cls_007"><span class="cls_007">you wrote a nested loop, Ruby would add the </span><span class="cls_030">BREAK</span><span class="cls_007"> entry to the outer loop</span></div>
<div style="position:absolute;left:120.00px;top:323.98px" class="cls_007"><span class="cls_007">scope’s catch table.</span></div>
<div style="position:absolute;left:138.00px;top:335.98px" class="cls_007"><span class="cls_007">Later, when YARV executes the </span><span class="cls_030">throw</span><span class="cls_007"> instruction, it checks to see whether</span></div>
<div style="position:absolute;left:120.00px;top:347.98px" class="cls_007"><span class="cls_007">there’s a catch table containing a break pointer for the current YARV instruc-</span></div>
<div style="position:absolute;left:120.00px;top:359.98px" class="cls_007"><span class="cls_007">tion sequence, as shown in Figure 4-5.</span></div>
<div style="position:absolute;left:198.11px;top:389.41px" class="cls_054"><span class="cls_054">Catch</span></div>
<div style="position:absolute;left:122.84px;top:393.61px" class="cls_054"><span class="cls_054">YARV instructions</span></div>
<div style="position:absolute;left:276.77px;top:393.54px" class="cls_053"><span class="cls_053">rb_control_frame_t</span></div>
<div style="position:absolute;left:198.78px;top:399.01px" class="cls_054"><span class="cls_054">Table</span></div>
<div style="position:absolute;left:237.88px;top:402.25px" class="cls_054"><span class="cls_054">Break</span></div>
<div style="position:absolute;left:371.99px;top:404.74px" class="cls_067"><span class="cls_067">CFP</span></div>
<div style="position:absolute;left:233.71px;top:410.65px" class="cls_054"><span class="cls_054">pointer?</span></div>
<div style="position:absolute;left:276.77px;top:424.26px" class="cls_053"><span class="cls_053">rb_control_frame_t</span></div>
<div style="position:absolute;left:276.77px;top:455.10px" class="cls_053"><span class="cls_053">rb_control_frame_t</span></div>
<div style="position:absolute;left:120.00px;top:485.53px" class="cls_038"><span class="cls_038">Figure 4-5: While executing a </span><span class="cls_014">throw</span><span class="cls_038"> instruction, YARV starts iterating down</span></div>
<div style="position:absolute;left:120.00px;top:496.02px" class="cls_038"><span class="cls_038">the Ruby call stack.</span></div>
<div style="position:absolute;left:138.00px;top:518.53px" class="cls_007"><span class="cls_007">If it doesn’t find a catch table, Ruby starts to iterate down through the</span></div>
<div style="position:absolute;left:120.00px;top:530.53px" class="cls_007"><span class="cls_007">stack of </span><span class="cls_030">rb_control_frame_t</span><span class="cls_007"> structures in search of a catch table containing a</span></div>
<div style="position:absolute;left:120.00px;top:542.53px" class="cls_007"><span class="cls_007">break pointer, as shown in Figure 4-6.</span></div>
<div style="position:absolute;left:48.00px;top:633.00px" class="cls_020"><span class="cls_020">88</span></div>
<div style="position:absolute;left:70.10px;top:636.00px" class="cls_021"><span class="cls_021">Chapter 4</span></div>
</div>
<div style="position:absolute;left:50%;margin-left:-252px;top:73684px;width:504px;height:666px;border-style:outset;overflow:hidden">
<div style="position:absolute;left:0px;top:0px">
<img src="e698b76e-46bd-11eb-8b25-0cc47a792c0a_id_e698b76e-46bd-11eb-8b25-0cc47a792c0a_files/background113.jpg" width=504 height=666></div>
<div style="position:absolute;left:280.37px;top:56.23px" class="cls_053"><span class="cls_053">rb_control_frame_t</span></div>
<div style="position:absolute;left:201.11px;top:83.77px" class="cls_054"><span class="cls_054">Catch</span></div>
<div style="position:absolute;left:125.84px;top:87.97px" class="cls_054"><span class="cls_054">YARV instructions</span></div>
<div style="position:absolute;left:280.37px;top:86.89px" class="cls_053"><span class="cls_053">rb_control_frame_t</span></div>
<div style="position:absolute;left:201.78px;top:93.37px" class="cls_054"><span class="cls_054">Table</span></div>
<div style="position:absolute;left:238.55px;top:96.61px" class="cls_054"><span class="cls_054">Break</span></div>
<div style="position:absolute;left:374.60px;top:98.02px" class="cls_067"><span class="cls_067">CFP</span></div>
<div style="position:absolute;left:234.95px;top:105.01px" class="cls_054"><span class="cls_054">pointer?</span></div>
<div style="position:absolute;left:280.37px;top:117.73px" class="cls_053"><span class="cls_053">rb_control_frame_t</span></div>
<div style="position:absolute;left:123.00px;top:148.16px" class="cls_038"><span class="cls_038">Figure 4-6: Ruby continues to iterate down the call stack looking for a catch</span></div>
<div style="position:absolute;left:123.00px;top:158.66px" class="cls_038"><span class="cls_038">table with a break pointer.</span></div>
<div style="position:absolute;left:141.00px;top:181.16px" class="cls_007"><span class="cls_007">As you can see in Figure 4-7, Ruby continues to iterate until it finds a</span></div>
<div style="position:absolute;left:123.00px;top:193.16px" class="cls_007"><span class="cls_007">catch table with a break pointer.</span></div>
<div style="position:absolute;left:279.78px;top:226.79px" class="cls_053"><span class="cls_053">rb_control_frame_t</span></div>
<div style="position:absolute;left:279.78px;top:257.45px" class="cls_053"><span class="cls_053">rb_control_frame_t</span></div>
<div style="position:absolute;left:201.11px;top:285.18px" class="cls_054"><span class="cls_054">Catch</span></div>
<div style="position:absolute;left:125.84px;top:289.37px" class="cls_054"><span class="cls_054">YARV instructions</span></div>
<div style="position:absolute;left:279.78px;top:288.29px" class="cls_053"><span class="cls_053">rb_control_frame_t</span></div>
<div style="position:absolute;left:201.78px;top:294.78px" class="cls_054"><span class="cls_054">Table</span></div>
<div style="position:absolute;left:238.55px;top:298.02px" class="cls_054"><span class="cls_054">Break</span></div>
<div style="position:absolute;left:374.00px;top:299.69px" class="cls_067"><span class="cls_067">CFP</span></div>
<div style="position:absolute;left:234.95px;top:306.41px" class="cls_054"><span class="cls_054">pointer?</span></div>
<div style="position:absolute;left:123.00px;top:324.75px" class="cls_038"><span class="cls_038">Figure 4-7: Ruby keeps iterating until it finds a catch table with a break pointer</span></div>
<div style="position:absolute;left:123.00px;top:335.25px" class="cls_038"><span class="cls_038">or reaches the end of the call stack.</span></div>
<div style="position:absolute;left:141.00px;top:357.75px" class="cls_007"><span class="cls_007">In this simple example, there is only one level of block nesting, so Ruby</span></div>
<div style="position:absolute;left:123.00px;top:369.75px" class="cls_007"><span class="cls_007">finds the catch table and break pointer after just one iteration, as shown in</span></div>
<div style="position:absolute;left:123.00px;top:381.75px" class="cls_007"><span class="cls_007">Figure 4-8.</span></div>
<div style="position:absolute;left:126.33px;top:406.05px" class="cls_063"><span class="cls_063">10.times do |n|</span></div>
<div style="position:absolute;left:267.71px;top:406.26px" class="cls_067"><span class="cls_067">YARV instructions</span></div>
<div style="position:absolute;left:135.83px;top:417.70px" class="cls_063"><span class="cls_063">puts n</span></div>
<div style="position:absolute;left:267.71px;top:422.55px" class="cls_014"><span class="cls_014">putself</span></div>
<div style="position:absolute;left:135.83px;top:429.36px" class="cls_063"><span class="cls_063">break</span></div>
<div style="position:absolute;left:267.71px;top:433.20px" class="cls_014"><span class="cls_014">getlocal</span></div>
<div style="position:absolute;left:336.98px;top:433.25px" class="cls_014"><span class="cls_014">2, 0</span></div>
<div style="position:absolute;left:126.33px;top:441.02px" class="cls_063"><span class="cls_063">end</span></div>
<div style="position:absolute;left:267.71px;top:443.86px" class="cls_014"><span class="cls_014">opt_send_simple</span></div>
<div style="position:absolute;left:336.98px;top:443.91px" class="cls_014"><span class="cls_014">&lt;callinfo!mid:puts, argc:1</span></div>
<div style="position:absolute;left:126.33px;top:452.67px" class="cls_063"><span class="cls_063">puts "continue from here"</span></div>
<div style="position:absolute;left:267.71px;top:454.51px" class="cls_014"><span class="cls_014">pop</span></div>
<div style="position:absolute;left:267.71px;top:465.17px" class="cls_014"><span class="cls_014">putnil</span></div>
<div style="position:absolute;left:267.71px;top:475.83px" class="cls_014"><span class="cls_014">throw</span></div>
<div style="position:absolute;left:336.98px;top:475.88px" class="cls_014"><span class="cls_014">2</span></div>
<div style="position:absolute;left:267.71px;top:486.48px" class="cls_014"><span class="cls_014">leave</span></div>
<div style="position:absolute;left:194.85px;top:509.67px" class="cls_067"><span class="cls_067">YARV instructions</span></div>
<div style="position:absolute;left:391.93px;top:509.67px" class="cls_067"><span class="cls_067">Catch Table</span></div>
<div style="position:absolute;left:194.72px;top:525.73px" class="cls_014"><span class="cls_014">putobject</span></div>
<div style="position:absolute;left:264.58px;top:525.28px" class="cls_014"><span class="cls_014">10</span></div>
<div style="position:absolute;left:194.72px;top:536.55px" class="cls_014"><span class="cls_014">send</span></div>
<div style="position:absolute;left:264.58px;top:536.11px" class="cls_014"><span class="cls_014">&lt;callinfo!mid:times, argc:0</span></div>
<div style="position:absolute;left:194.72px;top:547.36px" class="cls_014"><span class="cls_014">pop</span></div>
<div style="position:absolute;left:403.94px;top:547.82px" class="cls_014"><span class="cls_014">BREAK</span></div>
<div style="position:absolute;left:194.72px;top:558.18px" class="cls_014"><span class="cls_014">putself</span></div>
<div style="position:absolute;left:194.72px;top:569.00px" class="cls_014"><span class="cls_014">putstring</span></div>
<div style="position:absolute;left:264.58px;top:568.56px" class="cls_014"><span class="cls_014">"continue from here"</span></div>
<div style="position:absolute;left:194.72px;top:579.81px" class="cls_014"><span class="cls_014">opt_send_simple</span></div>
<div style="position:absolute;left:264.58px;top:579.38px" class="cls_014"><span class="cls_014">&lt;callinfo!mid:puts, argc:1</span></div>
<div style="position:absolute;left:194.72px;top:590.63px" class="cls_014"><span class="cls_014">leave</span></div>
<div style="position:absolute;left:123.00px;top:612.20px" class="cls_038"><span class="cls_038">Figure 4-8: Ruby finds a catch table with a break pointer.</span></div>
<div style="position:absolute;left:327.45px;top:636.00px" class="cls_021"><span class="cls_021">Control Structures and Method Dispatch</span></div>
<div style="position:absolute;left:447.04px;top:633.00px" class="cls_020"><span class="cls_020">89</span></div>
</div>
<div style="position:absolute;left:50%;margin-left:-252px;top:74360px;width:504px;height:666px;border-style:outset;overflow:hidden">
<div style="position:absolute;left:0px;top:0px">
<img src="e698b76e-46bd-11eb-8b25-0cc47a792c0a_id_e698b76e-46bd-11eb-8b25-0cc47a792c0a_files/background114.jpg" width=504 height=666></div>
<div style="position:absolute;left:138.00px;top:42.28px" class="cls_007"><span class="cls_007">Once Ruby finds the catch table pointer, it resets both the Ruby call</span></div>
<div style="position:absolute;left:120.00px;top:54.28px" class="cls_007"><span class="cls_007">stack (the </span><span class="cls_030">CFP</span><span class="cls_007"> pointer) and the internal YARV stack to reflect the new pro-</span></div>
<div style="position:absolute;left:120.01px;top:66.28px" class="cls_007"><span class="cls_007">gram execution point. YARV continues to execute your code from there—</span></div>
<div style="position:absolute;left:120.01px;top:78.28px" class="cls_007"><span class="cls_007">that is, it resets the internal </span><span class="cls_030">PC</span><span class="cls_007"> and </span><span class="cls_030">SP</span><span class="cls_007"> pointers as needed.</span></div>
<div style="position:absolute;left:78.00px;top:104.78px" class="cls_032"><span class="cls_032">NOTE</span></div>
<div style="position:absolute;left:120.00px;top:102.28px" class="cls_008"><span class="cls_008">Ruby uses a process similar to raising and rescuing an exception internally in order</span></div>
<div style="position:absolute;left:120.00px;top:114.28px" class="cls_008"><span class="cls_008">to implement a very commonly used control structure: the </span><span class="cls_030">break</span><span class="cls_008"> keyword. In other</span></div>
<div style="position:absolute;left:120.00px;top:126.28px" class="cls_008"><span class="cls_008">words, what in more verbose languages is an exceptional occurrence becomes in Ruby</span></div>
<div style="position:absolute;left:120.00px;top:138.28px" class="cls_008"><span class="cls_008">a common, everyday action. Ruby has wrapped up a confusing, unusual syntax—</span></div>
<div style="position:absolute;left:120.00px;top:150.28px" class="cls_008"><span class="cls_008">the raising/rescuing of exceptions—into a simple keyword, </span><span class="cls_030">break</span><span class="cls_008">, and made it very</span></div>
<div style="position:absolute;left:120.00px;top:162.28px" class="cls_008"><span class="cls_008">easy to understand and use. (Of course, Ruby needs to use exceptions because of the</span></div>
<div style="position:absolute;left:120.00px;top:174.28px" class="cls_008"><span class="cls_008">way blocks work. On the one hand, they’re like separate functions or subroutines, but</span></div>
<div style="position:absolute;left:120.00px;top:186.28px" class="cls_008"><span class="cls_008">on the other, they’re just part of the surrounding code.)</span></div>
<div style="position:absolute;left:120.00px;top:225.28px" class="cls_055"><span class="cls_055">Other Uses for Catch Tables</span></div>
<div style="position:absolute;left:120.00px;top:243.28px" class="cls_007"><span class="cls_007">The </span><span class="cls_030">return</span><span class="cls_007"> keyword is another ordinary Ruby control structure that also</span></div>
<div style="position:absolute;left:120.00px;top:255.28px" class="cls_007"><span class="cls_007">uses catch tables. Whenever you call </span><span class="cls_030">return</span><span class="cls_007"> from inside a block, Ruby raises</span></div>
<div style="position:absolute;left:120.00px;top:267.28px" class="cls_007"><span class="cls_007">an internal exception that it rescues with a catch table pointer in the same</span></div>
<div style="position:absolute;left:120.00px;top:279.28px" class="cls_007"><span class="cls_007">way it does when you call </span><span class="cls_030">break</span><span class="cls_007">. In fact, </span><span class="cls_030">break</span><span class="cls_007"> and </span><span class="cls_030">return</span><span class="cls_007"> are implemented</span></div>
<div style="position:absolute;left:120.00px;top:291.28px" class="cls_007"><span class="cls_007">with the same YARV instructions with one exception: For </span><span class="cls_030">return</span><span class="cls_007">, Ruby</span></div>
<div style="position:absolute;left:120.00px;top:303.28px" class="cls_007"><span class="cls_007">passes a 1 to the </span><span class="cls_030">throw</span><span class="cls_007"> instruction (for example, </span><span class="cls_030">throw 1</span><span class="cls_007">), while for </span><span class="cls_030">break</span><span class="cls_007">,</span></div>
<div style="position:absolute;left:120.00px;top:315.28px" class="cls_007"><span class="cls_007">it passes a 2 (</span><span class="cls_030">throw 2</span><span class="cls_007">). The </span><span class="cls_030">return</span><span class="cls_007"> and </span><span class="cls_030">break</span><span class="cls_007"> keywords are really two sides of</span></div>
<div style="position:absolute;left:120.00px;top:327.28px" class="cls_007"><span class="cls_007">the same coin.</span></div>
<div style="position:absolute;left:138.00px;top:339.28px" class="cls_007"><span class="cls_007">Besides </span><span class="cls_030">break</span><span class="cls_007">, Ruby uses the catch table to implement the control struc-</span></div>
<div style="position:absolute;left:120.00px;top:351.28px" class="cls_007"><span class="cls_007">tures </span><span class="cls_030">rescue</span><span class="cls_007">, </span><span class="cls_030">ensure</span><span class="cls_007">, </span><span class="cls_030">retry</span><span class="cls_007">, </span><span class="cls_030">redo</span><span class="cls_007">, and </span><span class="cls_030">next</span><span class="cls_007">. For example, when you explicitly</span></div>
<div style="position:absolute;left:120.00px;top:363.28px" class="cls_007"><span class="cls_007">raise an exception in your Ruby code using the </span><span class="cls_030">raise</span><span class="cls_007"> keyword, Ruby imple-</span></div>
<div style="position:absolute;left:120.00px;top:375.28px" class="cls_007"><span class="cls_007">ments the </span><span class="cls_030">rescue</span><span class="cls_007"> block using the catch table, but with a </span><span class="cls_030">rescue</span><span class="cls_007"> pointer. The</span></div>
<div style="position:absolute;left:120.00px;top:387.28px" class="cls_007"><span class="cls_007">catch table is simply a list of event types that can be caught and handled by</span></div>
<div style="position:absolute;left:120.00px;top:399.28px" class="cls_007"><span class="cls_007">that sequence of YARV instructions, just as you would use a </span><span class="cls_030">rescue</span><span class="cls_007"> block in</span></div>
<div style="position:absolute;left:120.00px;top:411.28px" class="cls_007"><span class="cls_007">your Ruby code.</span></div>
<div style="position:absolute;left:120.00px;top:447.28px" class="cls_031"><span class="cls_031">Experiment 4-1: Testing How Ruby Implements</span></div>
<div style="position:absolute;left:120.00px;top:462.28px" class="cls_031"><span class="cls_031">for Loops Internally</span></div>
<div style="position:absolute;left:120.00px;top:482.28px" class="cls_007"><span class="cls_007">I had always known that Ruby’s </span><span class="cls_030">for</span><span class="cls_007"> loop control structure worked essentially</span></div>
<div style="position:absolute;left:120.00px;top:494.28px" class="cls_007"><span class="cls_007">the same way as a block with the </span><span class="cls_030">each</span><span class="cls_007"> method of the </span><span class="cls_030">Enumerable</span><span class="cls_007"> module. That</span></div>
<div style="position:absolute;left:120.00px;top:506.28px" class="cls_007"><span class="cls_007">is, I knew that this code:</span></div>
<div style="position:absolute;left:120.00px;top:530.28px" class="cls_030"><span class="cls_030">for i in 0..5</span></div>
<div style="position:absolute;left:132.75px;top:540.78px" class="cls_030"><span class="cls_030">puts i</span></div>
<div style="position:absolute;left:120.00px;top:551.28px" class="cls_030"><span class="cls_030">end</span></div>
<div style="position:absolute;left:48.00px;top:633.00px" class="cls_020"><span class="cls_020">90</span></div>
<div style="position:absolute;left:70.03px;top:636.00px" class="cls_021"><span class="cls_021">Chapter 4</span></div>
</div>
<div style="position:absolute;left:50%;margin-left:-252px;top:75036px;width:504px;height:666px;border-style:outset;overflow:hidden">
<div style="position:absolute;left:0px;top:0px">
<img src="e698b76e-46bd-11eb-8b25-0cc47a792c0a_id_e698b76e-46bd-11eb-8b25-0cc47a792c0a_files/background115.jpg" width=504 height=666></div>
<div style="position:absolute;left:123.00px;top:41.60px" class="cls_007"><span class="cls_007">worked like this code:</span></div>
<div style="position:absolute;left:123.00px;top:65.60px" class="cls_030"><span class="cls_030">(0..5).each do |i|</span></div>
<div style="position:absolute;left:131.50px;top:76.10px" class="cls_030"><span class="cls_030">puts i</span></div>
<div style="position:absolute;left:123.00px;top:86.60px" class="cls_030"><span class="cls_030">end</span></div>
<div style="position:absolute;left:141.00px;top:109.10px" class="cls_007"><span class="cls_007">But I never suspected that internally Ruby actually implements </span><span class="cls_030">for</span><span class="cls_007"> loops</span></div>
<div style="position:absolute;left:123.00px;top:121.10px" class="cls_007"><span class="cls_007">using </span><span class="cls_030">each</span><span class="cls_007">! In other words, Ruby has no </span><span class="cls_030">for</span><span class="cls_007"> loop control structure. Instead,</span></div>
<div style="position:absolute;left:123.00px;top:133.10px" class="cls_007"><span class="cls_007">the </span><span class="cls_030">for</span><span class="cls_007"> keyword is really just syntactical sugar for calling </span><span class="cls_030">each</span><span class="cls_007"> with a range.</span></div>
<div style="position:absolute;left:141.00px;top:145.10px" class="cls_007"><span class="cls_007">To prove this, simply inspect the YARV instructions produced by Ruby</span></div>
<div style="position:absolute;left:123.00px;top:157.10px" class="cls_007"><span class="cls_007">when you compile a </span><span class="cls_030">for</span><span class="cls_007"> loop. In Listing 4-3, let’s use the same </span><span class="cls_030">RubyVM::</span></div>
<div style="position:absolute;left:123.00px;top:169.10px" class="cls_030"><span class="cls_030">InstructionSequence.compile</span><span class="cls_007"> method to display the YARV instructions.</span></div>
<div style="position:absolute;left:123.00px;top:193.10px" class="cls_030"><span class="cls_030">code = &lt;&lt;END</span></div>
<div style="position:absolute;left:123.00px;top:203.60px" class="cls_030"><span class="cls_030">for i in 0..5</span></div>
<div style="position:absolute;left:131.50px;top:214.10px" class="cls_030"><span class="cls_030">puts i</span></div>
<div style="position:absolute;left:123.00px;top:224.59px" class="cls_030"><span class="cls_030">end</span></div>
<div style="position:absolute;left:123.00px;top:235.09px" class="cls_030"><span class="cls_030">END</span></div>
<div style="position:absolute;left:123.00px;top:245.59px" class="cls_030"><span class="cls_030">puts RubyVM::InstructionSequence.compile(code).disasm</span></div>
<div style="position:absolute;left:123.00px;top:268.09px" class="cls_038"><span class="cls_038">Listing 4-3: This code will display how Ruby compiles a </span><span class="cls_014">for</span><span class="cls_038"> loop.</span></div>
<div style="position:absolute;left:141.00px;top:290.60px" class="cls_007"><span class="cls_007">Running this code gives the output shown in Listing 4-4.</span></div>
<div style="position:absolute;left:123.00px;top:314.60px" class="cls_030"><span class="cls_030">==</span></div>
<div style="position:absolute;left:135.75px;top:314.60px" class="cls_030"><span class="cls_030">disasm: &lt;RubyVM::InstructionSequence:&lt;compiled>@&lt;compiled>>==========</span></div>
<div style="position:absolute;left:123.00px;top:325.10px" class="cls_030"><span class="cls_030">==</span></div>
<div style="position:absolute;left:135.75px;top:325.10px" class="cls_030"><span class="cls_030">catch table</span></div>
<div style="position:absolute;left:123.00px;top:335.60px" class="cls_030"><span class="cls_030">| catch type: break  st: 0002 ed: 0006 sp: 0000 cont: 0006</span></div>
<div style="position:absolute;left:123.00px;top:346.09px" class="cls_030"><span class="cls_030">|------------------------------------------------------------------------</span></div>
<div style="position:absolute;left:123.00px;top:356.59px" class="cls_030"><span class="cls_030">local table (size: 2, argc: 0 [opts: 0, rest: -1, post: 0, block: -1] s1)</span></div>
<div style="position:absolute;left:123.00px;top:367.09px" class="cls_030"><span class="cls_030">[ 2] i</span></div>
<div style="position:absolute;left:123.00px;top:377.58px" class="cls_030"><span class="cls_030">0000 trace</span></div>
<div style="position:absolute;left:216.50px;top:377.58px" class="cls_030"><span class="cls_030">1</span></div>
<div style="position:absolute;left:420.50px;top:377.58px" class="cls_030"><span class="cls_030">(</span></div>
<div style="position:absolute;left:437.50px;top:377.58px" class="cls_030"><span class="cls_030">1)</span></div>
<div style="position:absolute;left:123.00px;top:388.08px" class="cls_030"><span class="cls_030">0002 putobject</span></div>
<div style="position:absolute;left:216.50px;top:388.08px" class="cls_030"><span class="cls_030">0..5</span></div>
<div style="position:absolute;left:123.00px;top:398.58px" class="cls_030"><span class="cls_030">0004 send</span></div>
<div style="position:absolute;left:216.50px;top:398.58px" class="cls_030"><span class="cls_030">&lt;callinfo!mid:each, argc:0, block:block in &lt;compiled>></span></div>
<div style="position:absolute;left:123.00px;top:409.08px" class="cls_030"><span class="cls_030">0006 leave</span></div>
<div style="position:absolute;left:123.00px;top:419.58px" class="cls_030"><span class="cls_030">==</span></div>
<div style="position:absolute;left:135.75px;top:419.58px" class="cls_030"><span class="cls_030">disasm: &lt;RubyVM::InstructionSequence:block in &lt;compiled>@&lt;compiled>>=</span></div>
<div style="position:absolute;left:123.00px;top:430.07px" class="cls_030"><span class="cls_030">==</span></div>
<div style="position:absolute;left:135.75px;top:430.07px" class="cls_030"><span class="cls_030">catch table</span></div>
<div style="position:absolute;left:123.00px;top:440.57px" class="cls_030"><span class="cls_030">| catch type: redo   st: 0004 ed: 0015 sp: 0000 cont: 0004</span></div>
<div style="position:absolute;left:123.00px;top:451.07px" class="cls_030"><span class="cls_030">| catch type: next   st: 0004 ed: 0015 sp: 0000 cont: 0015</span></div>
<div style="position:absolute;left:123.00px;top:461.57px" class="cls_030"><span class="cls_030">|------------------------------------------------------------------------</span></div>
<div style="position:absolute;left:123.00px;top:472.06px" class="cls_030"><span class="cls_030">local table (size: 2, argc: 1 [opts: 0, rest: -1, post: 0, block: -1] s3)</span></div>
<div style="position:absolute;left:123.00px;top:482.56px" class="cls_030"><span class="cls_030">[ 2] ?&lt;Arg></span></div>
<div style="position:absolute;left:123.00px;top:493.06px" class="cls_030"><span class="cls_030">0000 getlocal_OP__WC__0 2</span></div>
<div style="position:absolute;left:420.50px;top:493.06px" class="cls_030"><span class="cls_030">(</span></div>
<div style="position:absolute;left:437.50px;top:493.06px" class="cls_030"><span class="cls_030">3)</span></div>
<div style="position:absolute;left:123.00px;top:503.55px" class="cls_030"><span class="cls_030">0002 setlocal_OP__WC__1 2</span></div>
<div style="position:absolute;left:420.50px;top:503.55px" class="cls_030"><span class="cls_030">(</span></div>
<div style="position:absolute;left:437.50px;top:503.55px" class="cls_030"><span class="cls_030">1)</span></div>
<div style="position:absolute;left:123.00px;top:514.05px" class="cls_030"><span class="cls_030">0004 trace</span></div>
<div style="position:absolute;left:216.50px;top:514.05px" class="cls_030"><span class="cls_030">256</span></div>
<div style="position:absolute;left:123.00px;top:524.55px" class="cls_030"><span class="cls_030">0006 trace</span></div>
<div style="position:absolute;left:216.50px;top:524.55px" class="cls_030"><span class="cls_030">1</span></div>
<div style="position:absolute;left:420.50px;top:524.55px" class="cls_030"><span class="cls_030">(</span></div>
<div style="position:absolute;left:437.50px;top:524.55px" class="cls_030"><span class="cls_030">2)</span></div>
<div style="position:absolute;left:123.00px;top:535.05px" class="cls_030"><span class="cls_030">0008 putself</span></div>
<div style="position:absolute;left:123.00px;top:545.54px" class="cls_030"><span class="cls_030">0009 getlocal_OP__WC__1 2</span></div>
<div style="position:absolute;left:123.00px;top:556.04px" class="cls_030"><span class="cls_030">0011 opt_send_simple</span></div>
<div style="position:absolute;left:216.50px;top:556.04px" class="cls_030"><span class="cls_030">&lt;callinfo!mid:puts, argc:1, FCALL|ARGS_SKIP></span></div>
<div style="position:absolute;left:123.00px;top:566.54px" class="cls_030"><span class="cls_030">0013 trace</span></div>
<div style="position:absolute;left:216.50px;top:566.54px" class="cls_030"><span class="cls_030">512</span></div>
<div style="position:absolute;left:420.50px;top:566.54px" class="cls_030"><span class="cls_030">(</span></div>
<div style="position:absolute;left:437.50px;top:566.54px" class="cls_030"><span class="cls_030">3)</span></div>
<div style="position:absolute;left:123.00px;top:577.04px" class="cls_030"><span class="cls_030">0015 leave</span></div>
<div style="position:absolute;left:123.00px;top:599.54px" class="cls_038"><span class="cls_038">Listing 4-4: The output generated by Listing 4-3</span></div>
<div style="position:absolute;left:327.73px;top:636.00px" class="cls_021"><span class="cls_021">Control Structures and Method Dispatch</span></div>
<div style="position:absolute;left:447.31px;top:633.00px" class="cls_020"><span class="cls_020">91</span></div>
</div>
<div style="position:absolute;left:50%;margin-left:-252px;top:75712px;width:504px;height:666px;border-style:outset;overflow:hidden">
<div style="position:absolute;left:0px;top:0px">
<img src="e698b76e-46bd-11eb-8b25-0cc47a792c0a_id_e698b76e-46bd-11eb-8b25-0cc47a792c0a_files/background116.jpg" width=504 height=666></div>
<div style="position:absolute;left:138.00px;top:42.28px" class="cls_007"><span class="cls_007">Figure 4-9 shows the Ruby code on the left and YARV instructions on</span></div>
<div style="position:absolute;left:120.00px;top:54.28px" class="cls_007"><span class="cls_007">the right. (I’ve removed some of the technical details, like the </span><span class="cls_030">trace</span><span class="cls_007"> state-</span></div>
<div style="position:absolute;left:120.01px;top:66.28px" class="cls_007"><span class="cls_007">ments, in order to simplify things a bit.)</span></div>
<div style="position:absolute;left:123.20px;top:91.98px" class="cls_092"><span class="cls_092">for i in 0..5</span></div>
<div style="position:absolute;left:234.56px;top:93.48px" class="cls_093"><span class="cls_093">putobject</span></div>
<div style="position:absolute;left:282.06px;top:93.49px" class="cls_093"><span class="cls_093">0..5</span></div>
<div style="position:absolute;left:132.71px;top:103.04px" class="cls_092"><span class="cls_092">puts i</span></div>
<div style="position:absolute;left:234.56px;top:103.54px" class="cls_093"><span class="cls_093">send</span></div>
<div style="position:absolute;left:282.06px;top:103.55px" class="cls_093"><span class="cls_093">&lt;callinfo!mid:each, argc:0</span></div>
<div style="position:absolute;left:234.56px;top:113.79px" class="cls_093"><span class="cls_093">leave</span></div>
<div style="position:absolute;left:123.20px;top:115.29px" class="cls_092"><span class="cls_092">end</span></div>
<div style="position:absolute;left:234.56px;top:140.88px" class="cls_093"><span class="cls_093">getlocal</span></div>
<div style="position:absolute;left:300.85px;top:140.61px" class="cls_093"><span class="cls_093">2, 0</span></div>
<div style="position:absolute;left:234.56px;top:151.12px" class="cls_093"><span class="cls_093">setlocal</span></div>
<div style="position:absolute;left:300.85px;top:150.86px" class="cls_093"><span class="cls_093">2, 1</span></div>
<div style="position:absolute;left:234.56px;top:161.37px" class="cls_093"><span class="cls_093">putself</span></div>
<div style="position:absolute;left:234.56px;top:171.62px" class="cls_093"><span class="cls_093">getlocal</span></div>
<div style="position:absolute;left:300.85px;top:171.36px" class="cls_093"><span class="cls_093">2, 1</span></div>
<div style="position:absolute;left:234.56px;top:181.88px" class="cls_093"><span class="cls_093">opt_send_simple</span></div>
<div style="position:absolute;left:300.85px;top:181.60px" class="cls_093"><span class="cls_093">&lt;callinfo!mid:puts, argc:1</span></div>
<div style="position:absolute;left:234.56px;top:192.12px" class="cls_093"><span class="cls_093">leave</span></div>
<div style="position:absolute;left:120.00px;top:210.18px" class="cls_038"><span class="cls_038">Figure 4-9: A simplified display of the YARV instructions in Listing 4-4</span></div>
<div style="position:absolute;left:138.00px;top:232.68px" class="cls_007"><span class="cls_007">Notice that there are two separate YARV code blocks: The outer scope</span></div>
<div style="position:absolute;left:120.00px;top:244.68px" class="cls_007"><span class="cls_007">calls </span><span class="cls_030">each</span><span class="cls_007"> on the range </span><span class="cls_030">0..5</span><span class="cls_007">, and an inner block makes the </span><span class="cls_030">puts i</span><span class="cls_007"> call. The</span></div>
<div style="position:absolute;left:120.00px;top:256.68px" class="cls_030"><span class="cls_030">getlocal 2, 0</span><span class="cls_007"> instruction in the inner block loads the implied block param-</span></div>
<div style="position:absolute;left:120.00px;top:268.68px" class="cls_007"><span class="cls_007">eter value, and the </span><span class="cls_030">setlocal</span><span class="cls_007"> instruction that follows saves it into the local</span></div>
<div style="position:absolute;left:120.00px;top:280.68px" class="cls_007"><span class="cls_007">variable </span><span class="cls_030">i</span><span class="cls_007">, located back in the parent scope using dynamic variable access.</span></div>
<div style="position:absolute;left:138.00px;top:292.68px" class="cls_007"><span class="cls_007">In effect, Ruby has automatically done the following:</span></div>
<div style="position:absolute;left:120.00px;top:313.68px" class="cls_050"><span class="cls_050">•</span><span class="cls_007">   Converted the </span><span class="cls_030">for i in 0..5</span><span class="cls_007"> code into </span><span class="cls_030">(0..5).each do</span></div>
<div style="position:absolute;left:120.00px;top:328.68px" class="cls_050"><span class="cls_050">•</span><span class="cls_007">   Created a block parameter to hold each value in the range</span></div>
<div style="position:absolute;left:120.00px;top:343.68px" class="cls_050"><span class="cls_050">•</span><span class="cls_007">   Copied the block parameter, or the iteration counter, back into the</span></div>
<div style="position:absolute;left:138.00px;top:355.68px" class="cls_007"><span class="cls_007">local variable </span><span class="cls_030">i</span><span class="cls_007"> each time around the loop</span></div>
<div style="position:absolute;left:66.00px;top:399.68px" class="cls_031"><span class="cls_031">The send Instruction: Ruby’s Most Complex Control Structure</span></div>
<div style="position:absolute;left:120.00px;top:419.68px" class="cls_007"><span class="cls_007">We’ve seen how YARV controls the execution flow of our Ruby program</span></div>
<div style="position:absolute;left:120.00px;top:431.68px" class="cls_007"><span class="cls_007">using low-level instructions such as </span><span class="cls_030">branchunless</span><span class="cls_007"> and </span><span class="cls_030">jump</span><span class="cls_007">. However, the most</span></div>
<div style="position:absolute;left:120.00px;top:443.68px" class="cls_007"><span class="cls_007">commonly used and important YARV instruction for controlling Ruby pro-</span></div>
<div style="position:absolute;left:120.00px;top:455.68px" class="cls_007"><span class="cls_007">gram execution flow is the </span><span class="cls_030">send</span><span class="cls_007"> instruction. The </span><span class="cls_030">send</span><span class="cls_007"> instruction tells YARV</span></div>
<div style="position:absolute;left:120.00px;top:467.68px" class="cls_007"><span class="cls_007">to jump to another method and start executing it.</span></div>
<div style="position:absolute;left:120.00px;top:494.68px" class="cls_055"><span class="cls_055">Method Lookup and Method Dispatch</span></div>
<div style="position:absolute;left:120.00px;top:512.68px" class="cls_007"><span class="cls_007">How does </span><span class="cls_030">send</span><span class="cls_007"> work? How does YARV know which method to call, and how</span></div>
<div style="position:absolute;left:120.00px;top:524.68px" class="cls_007"><span class="cls_007">does it actually call the method? Figure 4-10 shows a high-level overview of</span></div>
<div style="position:absolute;left:120.00px;top:536.68px" class="cls_007"><span class="cls_007">the process.</span></div>
<div style="position:absolute;left:138.00px;top:548.68px" class="cls_007"><span class="cls_007">This seems very simple, but the algorithm Ruby uses to find and call</span></div>
<div style="position:absolute;left:120.00px;top:560.68px" class="cls_007"><span class="cls_007">the target method is actually very complex. First, in </span><span class="cls_008">method lookup</span><span class="cls_007">, Ruby</span></div>
<div style="position:absolute;left:120.00px;top:572.68px" class="cls_007"><span class="cls_007">searches for the method your code actually should call. This involves loop-</span></div>
<div style="position:absolute;left:120.00px;top:584.68px" class="cls_007"><span class="cls_007">ing through the classes and modules that make up the receiver object.</span></div>
<div style="position:absolute;left:48.00px;top:633.00px" class="cls_020"><span class="cls_020">92</span></div>
<div style="position:absolute;left:69.97px;top:636.00px" class="cls_021"><span class="cls_021">Chapter 4</span></div>
</div>
<div style="position:absolute;left:50%;margin-left:-252px;top:76388px;width:504px;height:666px;border-style:outset;overflow:hidden">
<div style="position:absolute;left:0px;top:0px">
<img src="e698b76e-46bd-11eb-8b25-0cc47a792c0a_id_e698b76e-46bd-11eb-8b25-0cc47a792c0a_files/background117.jpg" width=504 height=666></div>
<div style="position:absolute;left:151.72px;top:54.81px" class="cls_054"><span class="cls_054">YARV</span></div>
<div style="position:absolute;left:144.70px;top:63.61px" class="cls_054"><span class="cls_054">calls </span><span class="cls_067">send</span></div>
<div style="position:absolute;left:225.43px;top:117.80px" class="cls_054"><span class="cls_054">Search for the right</span></div>
<div style="position:absolute;left:135.39px;top:123.42px" class="cls_054"><span class="cls_054">Method lookup</span></div>
<div style="position:absolute;left:234.25px;top:128.73px" class="cls_054"><span class="cls_054">method to call</span></div>
<div style="position:absolute;left:132.49px;top:188.12px" class="cls_054"><span class="cls_054">Method dispatch</span></div>
<div style="position:absolute;left:217.25px;top:187.47px" class="cls_054"><span class="cls_054">Actually call the method</span></div>
<div style="position:absolute;left:151.72px;top:243.41px" class="cls_054"><span class="cls_054">YARV</span></div>
<div style="position:absolute;left:134.40px;top:252.21px" class="cls_054"><span class="cls_054">executes target</span></div>
<div style="position:absolute;left:148.78px;top:261.01px" class="cls_054"><span class="cls_054">method</span></div>
<div style="position:absolute;left:123.00px;top:283.44px" class="cls_038"><span class="cls_038">Figure 4-10: Ruby uses method lookup to find which</span></div>
<div style="position:absolute;left:123.00px;top:293.94px" class="cls_038"><span class="cls_038">method to call, and uses method dispatch to call it.</span></div>
<div style="position:absolute;left:141.00px;top:316.44px" class="cls_007"><span class="cls_007">Once Ruby finds the method your code is trying to call, it uses </span><span class="cls_008">method</span></div>
<div style="position:absolute;left:123.00px;top:328.44px" class="cls_008"><span class="cls_008">dispatch</span><span class="cls_007"> to actually execute the method call. This involves preparing the</span></div>
<div style="position:absolute;left:123.00px;top:340.44px" class="cls_007"><span class="cls_007">arguments to the method, pushing a new frame onto YARV’s internal stack,</span></div>
<div style="position:absolute;left:123.00px;top:352.44px" class="cls_007"><span class="cls_007">and changing YARV’s internal registers in order to actually start executing</span></div>
<div style="position:absolute;left:123.00px;top:364.44px" class="cls_007"><span class="cls_007">the target method. Like method lookup, method dispatch is a complex pro-</span></div>
<div style="position:absolute;left:123.00px;top:376.44px" class="cls_007"><span class="cls_007">cess because of the way Ruby categorizes your methods.</span></div>
<div style="position:absolute;left:141.00px;top:388.44px" class="cls_007"><span class="cls_007">During the rest of this chapter I’ll discuss the method dispatch process.</span></div>
<div style="position:absolute;left:123.00px;top:400.44px" class="cls_007"><span class="cls_007">We’ll see how method lookup works in Chapter 6, once we have learned</span></div>
<div style="position:absolute;left:123.00px;top:412.44px" class="cls_007"><span class="cls_007">more about how Ruby implements objects, classes, and modules.</span></div>
<div style="position:absolute;left:123.00px;top:437.44px" class="cls_055"><span class="cls_055">Eleven Types of Ruby Methods</span></div>
<div style="position:absolute;left:123.00px;top:455.44px" class="cls_007"><span class="cls_007">Internally, Ruby categorizes your methods into 11 different types! During</span></div>
<div style="position:absolute;left:123.00px;top:467.44px" class="cls_007"><span class="cls_007">the method dispatch process, Ruby determines which type of method your</span></div>
<div style="position:absolute;left:123.00px;top:479.44px" class="cls_007"><span class="cls_007">code is trying to call. It then calls each type of method differently depend-</span></div>
<div style="position:absolute;left:123.00px;top:491.44px" class="cls_007"><span class="cls_007">ing on its type, as shown in Figure 4-11.</span></div>
<div style="position:absolute;left:141.00px;top:503.44px" class="cls_007"><span class="cls_007">Most methods—including all methods you write with Ruby code in</span></div>
<div style="position:absolute;left:123.00px;top:515.44px" class="cls_007"><span class="cls_007">your program—are referred to as ISEQ, or </span><span class="cls_008">instruction sequence</span><span class="cls_007"> methods, by</span></div>
<div style="position:absolute;left:123.00px;top:527.44px" class="cls_007"><span class="cls_007">YARV’s internal source code because Ruby compiles your code into a series</span></div>
<div style="position:absolute;left:123.00px;top:539.44px" class="cls_007"><span class="cls_007">of YARV bytecode instructions. But internally, YARV uses 10 other method</span></div>
<div style="position:absolute;left:123.00px;top:551.44px" class="cls_007"><span class="cls_007">types as well. These other method types are required because Ruby needs</span></div>
<div style="position:absolute;left:123.00px;top:563.44px" class="cls_007"><span class="cls_007">to call certain methods in a special way in order to speed up method dis-</span></div>
<div style="position:absolute;left:123.00px;top:575.44px" class="cls_007"><span class="cls_007">patch, because these methods are implemented with C code or for various</span></div>
<div style="position:absolute;left:123.00px;top:587.44px" class="cls_007"><span class="cls_007">internal, technical reasons.</span></div>
<div style="position:absolute;left:327.48px;top:636.00px" class="cls_021"><span class="cls_021">Control Structures and Method Dispatch</span></div>
<div style="position:absolute;left:447.07px;top:633.00px" class="cls_020"><span class="cls_020">93</span></div>
</div>
<div style="position:absolute;left:50%;margin-left:-252px;top:77064px;width:504px;height:666px;border-style:outset;overflow:hidden">
<div style="position:absolute;left:0px;top:0px">
<img src="e698b76e-46bd-11eb-8b25-0cc47a792c0a_id_e698b76e-46bd-11eb-8b25-0cc47a792c0a_files/background118.jpg" width=504 height=666></div>
<div style="position:absolute;left:294.09px;top:53.88px" class="cls_054"><span class="cls_054">ISEQ</span></div>
<div style="position:absolute;left:345.78px;top:89.16px" class="cls_054"><span class="cls_054">CFUNC</span></div>
<div style="position:absolute;left:261.39px;top:131.00px" class="cls_054"><span class="cls_054">Switch on</span></div>
<div style="position:absolute;left:335.11px;top:129.89px" class="cls_054"><span class="cls_054">…and 7 other</span></div>
<div style="position:absolute;left:132.16px;top:134.71px" class="cls_054"><span class="cls_054">YARV calls </span><span class="cls_067">send</span></div>
<div style="position:absolute;left:258.16px;top:139.16px" class="cls_054"><span class="cls_054">method type</span></div>
<div style="position:absolute;left:336.48px;top:139.53px" class="cls_054"><span class="cls_054">internal types</span></div>
<div style="position:absolute;left:344.53px;top:180.00px" class="cls_054"><span class="cls_054">ATTRSET</span></div>
<div style="position:absolute;left:294.45px;top:215.77px" class="cls_054"><span class="cls_054">IVAR</span></div>
<div style="position:absolute;left:120.00px;top:244.64px" class="cls_038"><span class="cls_038">Figure 4-11: While executing </span><span class="cls_014">send</span><span class="cls_038">, YARV switches on the type of the target method.</span></div>
<div style="position:absolute;left:138.00px;top:267.14px" class="cls_007"><span class="cls_007">Here’s a quick description of all 11 method types. We’ll explore some of</span></div>
<div style="position:absolute;left:120.00px;top:279.14px" class="cls_007"><span class="cls_007">these in more detail in the following sections.</span></div>
<div style="position:absolute;left:138.00px;top:297.14px" class="cls_034"><span class="cls_034">ISEQ</span><span class="cls_007">   A normal method that you write using Ruby code, this is the</span></div>
<div style="position:absolute;left:138.00px;top:309.14px" class="cls_007"><span class="cls_007">most common method type. ISEQ stands for </span><span class="cls_008">instruction sequence</span><span class="cls_007">.</span></div>
<div style="position:absolute;left:138.00px;top:324.14px" class="cls_034"><span class="cls_034">CFUNC</span><span class="cls_007">   Using C code included directly inside the Ruby executable,</span></div>
<div style="position:absolute;left:138.00px;top:336.14px" class="cls_007"><span class="cls_007">these are the methods that Ruby implements rather than you. CFUNC</span></div>
<div style="position:absolute;left:138.00px;top:348.14px" class="cls_007"><span class="cls_007">stands for </span><span class="cls_008">C function</span><span class="cls_007">.</span></div>
<div style="position:absolute;left:138.00px;top:363.14px" class="cls_034"><span class="cls_034">ATTRSET</span><span class="cls_007">   A method of this type is created by the </span><span class="cls_030">attr_writer</span><span class="cls_007"> method.</span></div>
<div style="position:absolute;left:138.00px;top:375.14px" class="cls_007"><span class="cls_007">ATTRSET stands for </span><span class="cls_008">attribute set</span><span class="cls_007">.</span></div>
<div style="position:absolute;left:138.00px;top:390.14px" class="cls_034"><span class="cls_034">IVAR</span><span class="cls_007">   Ruby uses this method type when you call </span><span class="cls_030">attr_reader</span><span class="cls_007">. IVAR</span></div>
<div style="position:absolute;left:138.00px;top:402.14px" class="cls_007"><span class="cls_007">stands for </span><span class="cls_008">instance variable</span><span class="cls_007">.</span></div>
<div style="position:absolute;left:138.00px;top:417.14px" class="cls_034"><span class="cls_034">BMETHOD</span><span class="cls_007">   Ruby uses this method type when you call </span><span class="cls_030">define_method</span></div>
<div style="position:absolute;left:138.00px;top:429.14px" class="cls_007"><span class="cls_007">and pass in a proc object. Because the method is represented internally</span></div>
<div style="position:absolute;left:138.00px;top:441.14px" class="cls_007"><span class="cls_007">by a proc, Ruby needs to handle this method type in a special way.</span></div>
<div style="position:absolute;left:138.00px;top:456.14px" class="cls_034"><span class="cls_034">ZSUPER</span><span class="cls_007">   Ruby uses this method type when you set a method to be</span></div>
<div style="position:absolute;left:138.00px;top:468.14px" class="cls_007"><span class="cls_007">public or private in a particular class or module when it was actually</span></div>
<div style="position:absolute;left:138.00px;top:480.14px" class="cls_007"><span class="cls_007">defined in some superclass. This method is not commonly used.</span></div>
<div style="position:absolute;left:138.00px;top:495.14px" class="cls_034"><span class="cls_034">UNDEF</span><span class="cls_007">   Ruby uses this method type internally when it needs to</span></div>
<div style="position:absolute;left:138.00px;top:507.14px" class="cls_007"><span class="cls_007">remove a method from a class. Also, if you remove a method using</span></div>
<div style="position:absolute;left:138.00px;top:519.14px" class="cls_030"><span class="cls_030">undef_method</span><span class="cls_007">, Ruby creates a new method of the same name using the</span></div>
<div style="position:absolute;left:138.00px;top:531.14px" class="cls_007"><span class="cls_007">UNDEF method type.</span></div>
<div style="position:absolute;left:138.00px;top:546.14px" class="cls_034"><span class="cls_034">NOTIMPLEMENTED</span><span class="cls_007">   Like UNDEF, Ruby uses this method type</span></div>
<div style="position:absolute;left:138.00px;top:558.14px" class="cls_007"><span class="cls_007">to mark certain methods as not implemented. This is necessary, for</span></div>
<div style="position:absolute;left:138.00px;top:570.14px" class="cls_007"><span class="cls_007">example, when you run Ruby on a platform that doesn’t support a</span></div>
<div style="position:absolute;left:138.00px;top:582.14px" class="cls_007"><span class="cls_007">particular operating system call.</span></div>
<div style="position:absolute;left:138.00px;top:597.14px" class="cls_034"><span class="cls_034">OPTIMIZED</span><span class="cls_007">   Ruby speeds up some important methods using this</span></div>
<div style="position:absolute;left:138.00px;top:609.14px" class="cls_007"><span class="cls_007">type, like the </span><span class="cls_030">Kernel#send</span><span class="cls_007"> method.</span></div>
<div style="position:absolute;left:48.00px;top:633.00px" class="cls_020"><span class="cls_020">94</span></div>
<div style="position:absolute;left:69.94px;top:636.00px" class="cls_021"><span class="cls_021">Chapter 4</span></div>
</div>
<div style="position:absolute;left:50%;margin-left:-252px;top:77740px;width:504px;height:666px;border-style:outset;overflow:hidden">
<div style="position:absolute;left:0px;top:0px">
<img src="e698b76e-46bd-11eb-8b25-0cc47a792c0a_id_e698b76e-46bd-11eb-8b25-0cc47a792c0a_files/background119.jpg" width=504 height=666></div>
<div style="position:absolute;left:141.00px;top:41.60px" class="cls_034"><span class="cls_034">MISSING</span><span class="cls_007">   Ruby uses this method type if you ask for a method object</span></div>
<div style="position:absolute;left:141.00px;top:53.60px" class="cls_007"><span class="cls_007">from a module or class using </span><span class="cls_030">Kernel#method</span><span class="cls_007"> and the method is missing.</span></div>
<div style="position:absolute;left:141.00px;top:68.60px" class="cls_034"><span class="cls_034">REFINED</span><span class="cls_007">   Ruby uses this method type in its implementation of</span></div>
<div style="position:absolute;left:141.00px;top:80.60px" class="cls_007"><span class="cls_007">refinements, a new feature introduced in version 2.0.</span></div>
<div style="position:absolute;left:141.00px;top:98.60px" class="cls_007"><span class="cls_007">Now let’s focus on the most important and frequently used method</span></div>
<div style="position:absolute;left:123.00px;top:110.60px" class="cls_007"><span class="cls_007">types: ISEQ, CFUNC, ATTRSET, and IVAR.</span></div>
<div style="position:absolute;left:69.00px;top:144.60px" class="cls_031"><span class="cls_031">Calling Normal Ruby Methods</span></div>
<div style="position:absolute;left:123.00px;top:164.60px" class="cls_007"><span class="cls_007">Most methods in your Ruby code are identified by the constant </span><span class="cls_030">VM_METHOD_</span></div>
<div style="position:absolute;left:123.00px;top:176.60px" class="cls_030"><span class="cls_030">TYPE_ISEQ</span><span class="cls_007"> inside Ruby’s source code. This means that they consist of a</span></div>
<div style="position:absolute;left:123.00px;top:188.60px" class="cls_007"><span class="cls_007">sequence of YARV instructions.</span></div>
<div style="position:absolute;left:141.00px;top:200.60px" class="cls_007"><span class="cls_007">You define standard Ruby methods in your code with the </span><span class="cls_030">def</span><span class="cls_007"> keyword,</span></div>
<div style="position:absolute;left:123.00px;top:212.60px" class="cls_007"><span class="cls_007">as shown here.</span></div>
<div style="position:absolute;left:123.00px;top:236.60px" class="cls_030"><span class="cls_030">def display_message</span></div>
<div style="position:absolute;left:131.50px;top:247.10px" class="cls_030"><span class="cls_030">puts "The quick brown fox jumps over the lazy dog."</span></div>
<div style="position:absolute;left:123.00px;top:257.60px" class="cls_030"><span class="cls_030">end</span></div>
<div style="position:absolute;left:123.00px;top:268.09px" class="cls_030"><span class="cls_030">display_message</span></div>
<div style="position:absolute;left:141.00px;top:290.60px" class="cls_030"><span class="cls_030">display_message</span><span class="cls_007"> is a standard method because it’s created using the </span><span class="cls_030">def</span></div>
<div style="position:absolute;left:123.00px;top:302.60px" class="cls_007"><span class="cls_007">keyword followed by normal Ruby code. Figure 4-12 shows how Ruby calls</span></div>
<div style="position:absolute;left:123.00px;top:314.60px" class="cls_007"><span class="cls_007">the </span><span class="cls_030">display_message</span><span class="cls_007"> method.</span></div>
<div style="position:absolute;left:126.70px;top:338.97px" class="cls_094"><span class="cls_094">putself</span></div>
<div style="position:absolute;left:126.70px;top:348.95px" class="cls_094"><span class="cls_094">putstring</span></div>
<div style="position:absolute;left:193.59px;top:348.95px" class="cls_094"><span class="cls_094">"The quick brown fox jumps..."</span></div>
<div style="position:absolute;left:343.43px;top:353.27px" class="cls_095"><span class="cls_095">rb_control_frame_t</span></div>
<div style="position:absolute;left:126.70px;top:358.93px" class="cls_094"><span class="cls_094">opt_send_simple</span></div>
<div style="position:absolute;left:193.34px;top:358.93px" class="cls_094"><span class="cls_094">&lt;callinfo!mid:puts, argc:1,</span></div>
<div style="position:absolute;left:359.95px;top:365.97px" class="cls_096"><span class="cls_096">[METHOD]</span></div>
<div style="position:absolute;left:193.59px;top:368.91px" class="cls_094"><span class="cls_094">FCALL|ARGS_SKIP></span></div>
<div style="position:absolute;left:435.28px;top:369.67px" class="cls_094"><span class="cls_094">CFP</span></div>
<div style="position:absolute;left:343.43px;top:388.32px" class="cls_095"><span class="cls_095">rb_control_frame_t</span></div>
<div style="position:absolute;left:126.70px;top:407.28px" class="cls_094"><span class="cls_094">opt_send_simple</span></div>
<div style="position:absolute;left:193.34px;top:407.28px" class="cls_094"><span class="cls_094">&lt;callinfo!mid:display_message,</span></div>
<div style="position:absolute;left:193.59px;top:416.98px" class="cls_094"><span class="cls_094">argc:0, FCALL|VCALL|ARGS_SKIP></span></div>
<div style="position:absolute;left:123.00px;top:438.94px" class="cls_038"><span class="cls_038">Figure 4-12: A normal method is comprised of YARV instructions.</span></div>
<div style="position:absolute;left:141.00px;top:461.44px" class="cls_007"><span class="cls_007">On the left are two snippets of YARV code: the calling code at the bot-</span></div>
<div style="position:absolute;left:123.00px;top:473.44px" class="cls_007"><span class="cls_007">tom and the target method at the top. On the right you can see that Ruby</span></div>
<div style="position:absolute;left:123.00px;top:485.44px" class="cls_007"><span class="cls_007">created a new stack frame using a new </span><span class="cls_030">rb_control_frame_t</span><span class="cls_007"> structure, set to</span></div>
<div style="position:absolute;left:123.00px;top:497.44px" class="cls_007"><span class="cls_007">type METHOD.</span></div>
<div style="position:absolute;left:141.00px;top:509.44px" class="cls_007"><span class="cls_007">The key idea in Figure 4-12 is that both the calling code and the tar-</span></div>
<div style="position:absolute;left:123.00px;top:521.44px" class="cls_007"><span class="cls_007">get method are comprised of YARV instructions. When you call a standard</span></div>
<div style="position:absolute;left:123.00px;top:533.44px" class="cls_007"><span class="cls_007">method, YARV creates a new stack frame and then starts executing the</span></div>
<div style="position:absolute;left:123.00px;top:545.44px" class="cls_007"><span class="cls_007">instructions in the target method.</span></div>
<div style="position:absolute;left:123.00px;top:570.44px" class="cls_055"><span class="cls_055">Preparing Arguments for Normal Ruby Methods</span></div>
<div style="position:absolute;left:123.00px;top:588.44px" class="cls_007"><span class="cls_007">When Ruby compiles your code, it creates a table of local variables and</span></div>
<div style="position:absolute;left:123.00px;top:600.44px" class="cls_007"><span class="cls_007">arguments for each method. Each argument listed in the local table is</span></div>
<div style="position:absolute;left:327.56px;top:636.00px" class="cls_021"><span class="cls_021">Control Structures and Method Dispatch</span></div>
<div style="position:absolute;left:447.14px;top:633.00px" class="cls_020"><span class="cls_020">95</span></div>
</div>
<div style="position:absolute;left:50%;margin-left:-252px;top:78416px;width:504px;height:666px;border-style:outset;overflow:hidden">
<div style="position:absolute;left:0px;top:0px">
<img src="e698b76e-46bd-11eb-8b25-0cc47a792c0a_id_e698b76e-46bd-11eb-8b25-0cc47a792c0a_files/background120.jpg" width=504 height=666></div>
<div style="position:absolute;left:120.00px;top:42.28px" class="cls_007"><span class="cls_007">labeled as standard (</span><span class="cls_030">&lt;Arg></span><span class="cls_007">) or as one of a few different special types, such</span></div>
<div style="position:absolute;left:120.00px;top:54.28px" class="cls_007"><span class="cls_007">as block, optional, and so on. Ruby records the type of each method’s argu-</span></div>
<div style="position:absolute;left:120.00px;top:66.28px" class="cls_007"><span class="cls_007">ments in this way so it can tell whether any additional work is required when</span></div>
<div style="position:absolute;left:120.00px;top:78.28px" class="cls_007"><span class="cls_007">your code calls the method. Listing 4-5 shows a single Ruby method that</span></div>
<div style="position:absolute;left:120.00px;top:90.28px" class="cls_007"><span class="cls_007">uses each type of argument.</span></div>
<div style="position:absolute;left:120.00px;top:114.28px" class="cls_030"><span class="cls_030">def five_argument_types(a, b = 1, *args, c, &d)</span></div>
<div style="position:absolute;left:128.50px;top:124.78px" class="cls_030"><span class="cls_030">puts "Standard argument #{a.inspect}"</span></div>
<div style="position:absolute;left:128.50px;top:135.27px" class="cls_030"><span class="cls_030">puts "Optional argument #{b.inspect}"</span></div>
<div style="position:absolute;left:128.50px;top:145.77px" class="cls_030"><span class="cls_030">puts "Splat argument array #{args.inspect}"</span></div>
<div style="position:absolute;left:128.50px;top:156.27px" class="cls_030"><span class="cls_030">puts "Post argument #{c.inspect}"</span></div>
<div style="position:absolute;left:128.50px;top:166.77px" class="cls_030"><span class="cls_030">puts "Block argument #{d.inspect}"</span></div>
<div style="position:absolute;left:120.00px;top:177.26px" class="cls_030"><span class="cls_030">end</span></div>
<div style="position:absolute;left:120.00px;top:198.27px" class="cls_030"><span class="cls_030">five_argument_types(1, 2, 3, 4, 5, 6) do</span></div>
<div style="position:absolute;left:128.50px;top:208.77px" class="cls_030"><span class="cls_030">puts "block"</span></div>
<div style="position:absolute;left:120.00px;top:219.26px" class="cls_030"><span class="cls_030">end</span></div>
<div style="position:absolute;left:120.00px;top:241.76px" class="cls_038"><span class="cls_038">Listing 4-5: Ruby’s argument types </span><span class="cls_039">(argument_types.rb)</span></div>
<div style="position:absolute;left:138.00px;top:264.28px" class="cls_007"><span class="cls_007">Listing 4-6 shows the result when we call the example method with the</span></div>
<div style="position:absolute;left:120.00px;top:276.28px" class="cls_007"><span class="cls_007">numbers 1 through 6 and a block.</span></div>
<div style="position:absolute;left:120.00px;top:300.28px" class="cls_030"><span class="cls_030">$ </span><span class="cls_040">ruby argument_types.rb</span></div>
<div style="position:absolute;left:120.00px;top:310.78px" class="cls_030"><span class="cls_030">Standard argument 1</span></div>
<div style="position:absolute;left:120.00px;top:321.27px" class="cls_030"><span class="cls_030">Optional argument 2</span></div>
<div style="position:absolute;left:120.00px;top:331.77px" class="cls_030"><span class="cls_030">Splat argument array [3, 4, 5]</span></div>
<div style="position:absolute;left:120.00px;top:342.27px" class="cls_030"><span class="cls_030">Post argument 6</span></div>
<div style="position:absolute;left:120.00px;top:352.77px" class="cls_030"><span class="cls_030">Block argument #&lt;Proc:0x007ff4b2045ac0@argument_types.rb:9></span></div>
<div style="position:absolute;left:120.00px;top:375.27px" class="cls_038"><span class="cls_038">Listing 4-6: The output generated by Listing 4-5</span></div>
<div style="position:absolute;left:138.00px;top:397.78px" class="cls_007"><span class="cls_007">To make this behavior possible, YARV does some additional processing</span></div>
<div style="position:absolute;left:120.00px;top:409.78px" class="cls_007"><span class="cls_007">on each type of argument when you call a method:</span></div>
<div style="position:absolute;left:138.00px;top:427.78px" class="cls_034"><span class="cls_034">Block arguments</span><span class="cls_007">   When you use the </span><span class="cls_030">&</span><span class="cls_007"> operator in an argument list,</span></div>
<div style="position:absolute;left:138.00px;top:439.78px" class="cls_007"><span class="cls_007">Ruby needs to convert the provided block into a proc object.</span></div>
<div style="position:absolute;left:138.00px;top:454.78px" class="cls_034"><span class="cls_034">Optional arguments</span><span class="cls_007">   Ruby adds additional code to the target method</span></div>
<div style="position:absolute;left:138.00px;top:466.78px" class="cls_007"><span class="cls_007">when you use an optional argument with a default value. This code sets</span></div>
<div style="position:absolute;left:138.00px;top:478.78px" class="cls_007"><span class="cls_007">the default value into the argument. When you later call a method with</span></div>
<div style="position:absolute;left:138.00px;top:490.78px" class="cls_007"><span class="cls_007">an optional argument, YARV resets the program counter or PC register</span></div>
<div style="position:absolute;left:138.00px;top:502.78px" class="cls_007"><span class="cls_007">to skip this added code when a value is provided.</span></div>
<div style="position:absolute;left:138.00px;top:517.78px" class="cls_034"><span class="cls_034">Splat argument array</span><span class="cls_007">   For these, YARV creates a new array object and</span></div>
<div style="position:absolute;left:138.00px;top:529.78px" class="cls_007"><span class="cls_007">collects the provided argument values into it. (See the array </span><span class="cls_030">[3, 4, 5]</span></div>
<div style="position:absolute;left:138.00px;top:541.78px" class="cls_007"><span class="cls_007">in Listing 4-6.)</span></div>
<div style="position:absolute;left:138.00px;top:556.78px" class="cls_034"><span class="cls_034">Standard and post arguments</span><span class="cls_007">   Because these need no special treat-</span></div>
<div style="position:absolute;left:138.00px;top:568.78px" class="cls_007"><span class="cls_007">ment, YARV has no additional work to do.</span></div>
<div style="position:absolute;left:48.00px;top:633.00px" class="cls_020"><span class="cls_020">96</span></div>
<div style="position:absolute;left:69.93px;top:636.00px" class="cls_021"><span class="cls_021">Chapter 4</span></div>
</div>
<div style="position:absolute;left:50%;margin-left:-252px;top:79092px;width:504px;height:666px;border-style:outset;overflow:hidden">
<div style="position:absolute;left:0px;top:0px">
<img src="e698b76e-46bd-11eb-8b25-0cc47a792c0a_id_e698b76e-46bd-11eb-8b25-0cc47a792c0a_files/background121.jpg" width=504 height=666></div>
<div style="position:absolute;left:141.00px;top:41.60px" class="cls_007"><span class="cls_007">Then there are keyword arguments. Whenever Ruby calls a</span></div>
<div style="position:absolute;left:123.00px;top:53.60px" class="cls_007"><span class="cls_007">method that uses keyword arguments, YARV has even more work to do.</span></div>
<div style="position:absolute;left:123.00px;top:65.60px" class="cls_007"><span class="cls_007">(“Experiment 4-2: Exploring How Ruby Implements Keyword Arguments”</span></div>
<div style="position:absolute;left:123.00px;top:77.60px" class="cls_007"><span class="cls_007">on page 99 explores this in more detail.)</span></div>
<div style="position:absolute;left:69.00px;top:111.60px" class="cls_031"><span class="cls_031">Calling Built-In Ruby Methods</span></div>
<div style="position:absolute;left:123.00px;top:131.60px" class="cls_007"><span class="cls_007">Many of the methods built into the Ruby language are CFUNC methods</span></div>
<div style="position:absolute;left:123.00px;top:143.60px" class="cls_007"><span class="cls_007">(</span><span class="cls_030">VM_METHOD_TYPE_CFUNC</span><span class="cls_007"> in Ruby’s C source code). Ruby implements these using</span></div>
<div style="position:absolute;left:123.00px;top:155.60px" class="cls_007"><span class="cls_007">C code rather than Ruby code. For example, consider the </span><span class="cls_030">Integer#times</span></div>
<div style="position:absolute;left:123.00px;top:167.60px" class="cls_007"><span class="cls_007">method from “Executing a Call to a Block” on page 61. The </span><span class="cls_030">Integer</span><span class="cls_007"> class</span></div>
<div style="position:absolute;left:123.00px;top:179.60px" class="cls_007"><span class="cls_007">is included in the Ruby interpreter, and the </span><span class="cls_030">times</span><span class="cls_007"> method is implemented</span></div>
<div style="position:absolute;left:123.00px;top:191.60px" class="cls_007"><span class="cls_007">by C code in the file </span><span class="cls_008">numeric.c</span><span class="cls_007">.</span></div>
<div style="position:absolute;left:141.00px;top:203.60px" class="cls_007"><span class="cls_007">The classes you use every day have many examples of CFUNC methods,</span></div>
<div style="position:absolute;left:123.00px;top:215.60px" class="cls_007"><span class="cls_007">such as </span><span class="cls_030">String</span><span class="cls_007">, </span><span class="cls_030">Array</span><span class="cls_007">, </span><span class="cls_030">Object</span><span class="cls_007">, </span><span class="cls_030">Kernel</span><span class="cls_007">, and so on. For example, the </span><span class="cls_030">String#upcase</span></div>
<div style="position:absolute;left:123.00px;top:227.60px" class="cls_007"><span class="cls_007">method is implemented by C code in </span><span class="cls_008">string.c</span><span class="cls_007">, and </span><span class="cls_030">Struct#each</span><span class="cls_007"> is implemented</span></div>
<div style="position:absolute;left:123.00px;top:239.60px" class="cls_007"><span class="cls_007">by C code in </span><span class="cls_008">struct.c</span><span class="cls_007">.</span></div>
<div style="position:absolute;left:141.00px;top:251.60px" class="cls_007"><span class="cls_007">When Ruby calls a built-in CFUNC method, it doesn’t need to prepare</span></div>
<div style="position:absolute;left:123.00px;top:263.60px" class="cls_007"><span class="cls_007">the method arguments in the same way it does with normal ISEQ methods;</span></div>
<div style="position:absolute;left:123.00px;top:275.60px" class="cls_007"><span class="cls_007">it simply creates a new stack frame and calls the target method, as shown in</span></div>
<div style="position:absolute;left:123.00px;top:287.60px" class="cls_007"><span class="cls_007">Figure 4-13.</span></div>
<div style="position:absolute;left:161.94px;top:321.16px" class="cls_094"><span class="cls_094">[ C function - int_dotimes ]</span></div>
<div style="position:absolute;left:199.18px;top:329.96px" class="cls_094"><span class="cls_094">numeric.c</span></div>
<div style="position:absolute;left:343.16px;top:328.18px" class="cls_095"><span class="cls_095">rb_control_frame_t</span></div>
<div style="position:absolute;left:362.53px;top:340.88px" class="cls_096"><span class="cls_096">[CFUNC]</span></div>
<div style="position:absolute;left:435.06px;top:344.36px" class="cls_094"><span class="cls_094">CFP</span></div>
<div style="position:absolute;left:343.16px;top:363.54px" class="cls_095"><span class="cls_095">rb_control_frame_t</span></div>
<div style="position:absolute;left:125.75px;top:377.68px" class="cls_094"><span class="cls_094">opt_send_simple</span></div>
<div style="position:absolute;left:192.39px;top:377.68px" class="cls_094"><span class="cls_094">&lt;callinfo!mid:times, argc:0,</span></div>
<div style="position:absolute;left:193.06px;top:387.45px" class="cls_094"><span class="cls_094">block:block in &lt;compiled></span></div>
<div style="position:absolute;left:123.00px;top:435.02px" class="cls_038"><span class="cls_038">Figure 4-13: Ruby implements CFUNC methods using C code in one of Ruby’s C</span></div>
<div style="position:absolute;left:123.00px;top:445.51px" class="cls_038"><span class="cls_038">source files.</span></div>
<div style="position:absolute;left:141.00px;top:468.02px" class="cls_007"><span class="cls_007">As we saw with ISEQ methods in Figure 4-12, calling a CFUNC</span></div>
<div style="position:absolute;left:123.00px;top:480.02px" class="cls_007"><span class="cls_007">method involves creating a new stack frame. This time, however, Ruby</span></div>
<div style="position:absolute;left:123.00px;top:492.02px" class="cls_007"><span class="cls_007">uses a </span><span class="cls_030">rb_control_frame_t</span><span class="cls_007"> structure with type CFUNC instead.</span></div>
<div style="position:absolute;left:123.00px;top:517.02px" class="cls_055"><span class="cls_055">Calling attr_reader and attr_writer</span></div>
<div style="position:absolute;left:123.00px;top:535.02px" class="cls_007"><span class="cls_007">Ruby uses two special method types, IVAR and ATTRSET, to speed up the</span></div>
<div style="position:absolute;left:123.00px;top:547.02px" class="cls_007"><span class="cls_007">process of accessing and setting instance variables in your code. Before I</span></div>
<div style="position:absolute;left:123.00px;top:559.02px" class="cls_007"><span class="cls_007">explain what these method types mean and how method dispatch works</span></div>
<div style="position:absolute;left:123.00px;top:571.02px" class="cls_007"><span class="cls_007">with them, have a look at Listing 4-7, which retrieves and sets the value of</span></div>
<div style="position:absolute;left:123.00px;top:583.02px" class="cls_007"><span class="cls_007">an instance variable.</span></div>
<div style="position:absolute;left:327.57px;top:636.00px" class="cls_021"><span class="cls_021">Control Structures and Method Dispatch</span></div>
<div style="position:absolute;left:447.15px;top:633.00px" class="cls_020"><span class="cls_020">97</span></div>
</div>
<div style="position:absolute;left:50%;margin-left:-252px;top:79768px;width:504px;height:666px;border-style:outset;overflow:hidden">
<div style="position:absolute;left:0px;top:0px">
<img src="e698b76e-46bd-11eb-8b25-0cc47a792c0a_id_e698b76e-46bd-11eb-8b25-0cc47a792c0a_files/background122.jpg" width=504 height=666></div>
<div style="position:absolute;left:120.00px;top:49.00px" class="cls_030"><span class="cls_030">class InstanceVariableTest</span></div>
<div style="position:absolute;left:108.15px;top:59.50px" class="cls_046"><span class="cls_046">u</span><span class="cls_030">   def var</span></div>
<div style="position:absolute;left:137.00px;top:70.00px" class="cls_030"><span class="cls_030">@var</span></div>
<div style="position:absolute;left:128.50px;top:80.49px" class="cls_030"><span class="cls_030">end</span></div>
<div style="position:absolute;left:108.15px;top:90.99px" class="cls_046"><span class="cls_046">v</span><span class="cls_030">   def var=(val)</span></div>
<div style="position:absolute;left:137.00px;top:101.49px" class="cls_030"><span class="cls_030">@var = val</span></div>
<div style="position:absolute;left:128.50px;top:111.99px" class="cls_030"><span class="cls_030">end</span></div>
<div style="position:absolute;left:120.00px;top:122.48px" class="cls_030"><span class="cls_030">end</span></div>
<div style="position:absolute;left:120.00px;top:144.98px" class="cls_038"><span class="cls_038">Listing 4-7: A Ruby class with an instance variable and accessor methods</span></div>
<div style="position:absolute;left:138.00px;top:167.50px" class="cls_007"><span class="cls_007">In this listing, the class </span><span class="cls_030">InstanceVariableTest</span><span class="cls_007"> contains an instance vari-</span></div>
<div style="position:absolute;left:120.00px;top:179.50px" class="cls_007"><span class="cls_007">able, </span><span class="cls_030">@var</span><span class="cls_007">, and two methods, </span><span class="cls_030">var</span><span class="cls_007"> </span><span class="cls_050">u</span><span class="cls_007"> and </span><span class="cls_030">var=</span><span class="cls_007"> </span><span class="cls_050">v</span><span class="cls_007">. Because I wrote these</span></div>
<div style="position:absolute;left:120.00px;top:191.50px" class="cls_007"><span class="cls_007">methods using Ruby code, both will be standard Ruby methods with the</span></div>
<div style="position:absolute;left:120.00px;top:203.50px" class="cls_007"><span class="cls_007">type set to </span><span class="cls_030">VM_METHOD_TYPE_ISEQ</span><span class="cls_007">. As you can see, they allow you to get or set</span></div>
<div style="position:absolute;left:120.00px;top:215.50px" class="cls_007"><span class="cls_007">the value of </span><span class="cls_030">@var</span><span class="cls_007">.</span></div>
<div style="position:absolute;left:138.00px;top:227.50px" class="cls_007"><span class="cls_007">Ruby actually provides a shortcut for creating these methods: </span><span class="cls_030">attr_</span></div>
<div style="position:absolute;left:120.00px;top:239.50px" class="cls_030"><span class="cls_030">reader</span><span class="cls_007"> and </span><span class="cls_030">attr_writer</span><span class="cls_007">. The following code shows a shorter way of writing</span></div>
<div style="position:absolute;left:120.00px;top:251.50px" class="cls_007"><span class="cls_007">the same class, using these shortcuts.</span></div>
<div style="position:absolute;left:120.00px;top:275.50px" class="cls_030"><span class="cls_030">class InstanceVariableTest</span></div>
<div style="position:absolute;left:128.50px;top:286.00px" class="cls_030"><span class="cls_030">attr_reader :var</span></div>
<div style="position:absolute;left:128.50px;top:296.49px" class="cls_030"><span class="cls_030">attr_writer :var</span></div>
<div style="position:absolute;left:120.00px;top:306.99px" class="cls_030"><span class="cls_030">end</span></div>
<div style="position:absolute;left:138.00px;top:329.50px" class="cls_007"><span class="cls_007">Here, </span><span class="cls_030">attr_reader</span><span class="cls_007"> automatically defines the same </span><span class="cls_030">var</span><span class="cls_007"> method, and </span><span class="cls_030">attr_</span></div>
<div style="position:absolute;left:120.00px;top:341.50px" class="cls_030"><span class="cls_030">writer</span><span class="cls_007"> automatically defines the </span><span class="cls_030">var=</span><span class="cls_007"> method, both from Listing 4-7.</span></div>
<div style="position:absolute;left:138.00px;top:353.50px" class="cls_007"><span class="cls_007">And here’s an even simpler, more concise way of defining the same two</span></div>
<div style="position:absolute;left:120.00px;top:365.50px" class="cls_007"><span class="cls_007">methods using </span><span class="cls_030">attr_accessor</span><span class="cls_007">.</span></div>
<div style="position:absolute;left:120.00px;top:389.50px" class="cls_030"><span class="cls_030">class InstanceVariableTest</span></div>
<div style="position:absolute;left:128.50px;top:400.00px" class="cls_030"><span class="cls_030">attr_accessor :var</span></div>
<div style="position:absolute;left:120.00px;top:410.49px" class="cls_030"><span class="cls_030">end</span></div>
<div style="position:absolute;left:138.00px;top:433.00px" class="cls_007"><span class="cls_007">As you can see, </span><span class="cls_030">attr_accessor</span><span class="cls_007"> is shorthand for calling </span><span class="cls_030">attr_reader</span><span class="cls_007"> and</span></div>
<div style="position:absolute;left:120.00px;top:445.00px" class="cls_030"><span class="cls_030">attr_writer</span><span class="cls_007"> together for the same instance variable.</span></div>
<div style="position:absolute;left:120.00px;top:470.00px" class="cls_055"><span class="cls_055">Method Dispatch Optimizes attr_reader and attr_writer</span></div>
<div style="position:absolute;left:120.00px;top:488.00px" class="cls_007"><span class="cls_007">Since Ruby developers use </span><span class="cls_030">attr_reader</span><span class="cls_007"> and </span><span class="cls_030">attr_writer</span><span class="cls_007"> so often, YARV uses</span></div>
<div style="position:absolute;left:120.00px;top:500.00px" class="cls_007"><span class="cls_007">two special method types, IVAR and ATTRSET, to speed up method dispatch</span></div>
<div style="position:absolute;left:120.00px;top:512.00px" class="cls_007"><span class="cls_007">and make your program run faster.</span></div>
<div style="position:absolute;left:138.00px;top:524.00px" class="cls_007"><span class="cls_007">Let’s begin with the ATTRSET method type. Whenever you define</span></div>
<div style="position:absolute;left:120.00px;top:536.00px" class="cls_007"><span class="cls_007">a method using </span><span class="cls_030">attr_writer</span><span class="cls_007"> or </span><span class="cls_030">attr_accessor</span><span class="cls_007">, Ruby marks the generated</span></div>
<div style="position:absolute;left:120.00px;top:548.00px" class="cls_007"><span class="cls_007">method with the </span><span class="cls_030">VM_METHOD_TYPE_ATTRSET</span><span class="cls_007"> method type internally. When Ruby</span></div>
<div style="position:absolute;left:120.00px;top:560.00px" class="cls_007"><span class="cls_007">executes the code and calls the method, it uses a C function, </span><span class="cls_030">vm_setivar</span><span class="cls_007">, to</span></div>
<div style="position:absolute;left:120.00px;top:572.00px" class="cls_007"><span class="cls_007">set the instance variable in a fast, optimized manner. Figure 4-14 shows how</span></div>
<div style="position:absolute;left:120.00px;top:584.00px" class="cls_007"><span class="cls_007">YARV calls the generated </span><span class="cls_030">var=</span><span class="cls_007"> method to set </span><span class="cls_030">var</span><span class="cls_007">.</span></div>
<div style="position:absolute;left:48.00px;top:633.00px" class="cls_020"><span class="cls_020">98</span></div>
<div style="position:absolute;left:69.94px;top:636.00px" class="cls_021"><span class="cls_021">Chapter 4</span></div>
</div>
<div style="position:absolute;left:50%;margin-left:-252px;top:80444px;width:504px;height:666px;border-style:outset;overflow:hidden">
<div style="position:absolute;left:0px;top:0px">
<img src="e698b76e-46bd-11eb-8b25-0cc47a792c0a_id_e698b76e-46bd-11eb-8b25-0cc47a792c0a_files/background123.jpg" width=504 height=666></div>
<div style="position:absolute;left:125.08px;top:59.72px" class="cls_097"><span class="cls_097">opt_send_simple</span></div>
<div style="position:absolute;left:186.91px;top:59.72px" class="cls_097"><span class="cls_097">&lt;callinfo!mid:var=, argc:1, ARGS_SKIP></span></div>
<div style="position:absolute;left:345.83px;top:59.72px" class="cls_097"><span class="cls_097">[ C function - vm_setivar ]</span></div>
<div style="position:absolute;left:123.00px;top:93.56px" class="cls_038"><span class="cls_038">Figure 4-14: </span><span class="cls_014">VM_METHOD_TYPE_ATTRSET</span><span class="cls_038"> methods call </span><span class="cls_014">vm_setivar</span><span class="cls_038"> directly.</span></div>
<div style="position:absolute;left:141.00px;top:115.06px" class="cls_007"><span class="cls_007">Notice that this figure is similar to Figure 4-13. In both cases, Ruby calls</span></div>
<div style="position:absolute;left:123.00px;top:127.06px" class="cls_007"><span class="cls_007">an internal C function when executing our code. But notice in Figure 4-14</span></div>
<div style="position:absolute;left:123.00px;top:139.06px" class="cls_007"><span class="cls_007">that when executing an ATTRSET method, Ruby doesn’t even create a new</span></div>
<div style="position:absolute;left:123.00px;top:151.06px" class="cls_007"><span class="cls_007">stack frame. It doesn’t need to because the method is so short and simple.</span></div>
<div style="position:absolute;left:123.00px;top:163.06px" class="cls_007"><span class="cls_007">Also, because the generated </span><span class="cls_030">var=</span><span class="cls_007"> method will never raise an exception, Ruby</span></div>
<div style="position:absolute;left:123.00px;top:175.06px" class="cls_007"><span class="cls_007">doesn’t need a new stack frame to display in error messages. The </span><span class="cls_030">vm_setivar</span></div>
<div style="position:absolute;left:123.00px;top:187.06px" class="cls_007"><span class="cls_007">C function can very quickly set the value and return.</span></div>
<div style="position:absolute;left:141.00px;top:199.06px" class="cls_007"><span class="cls_007">The IVAR method type works similarly. When you define a method</span></div>
<div style="position:absolute;left:123.00px;top:211.06px" class="cls_007"><span class="cls_007">using </span><span class="cls_030">attr_reader</span><span class="cls_007"> or </span><span class="cls_030">attr_accessor</span><span class="cls_007">, Ruby marks the generated method with</span></div>
<div style="position:absolute;left:123.00px;top:223.06px" class="cls_007"><span class="cls_007">the </span><span class="cls_030">VM_METHOD_TYPE_IVAR</span><span class="cls_007"> method type internally. When it executes IVAR</span></div>
<div style="position:absolute;left:123.00px;top:235.06px" class="cls_007"><span class="cls_007">methods, Ruby calls an internal C function called </span><span class="cls_030">vm_getivar</span><span class="cls_007"> to get and</span></div>
<div style="position:absolute;left:123.00px;top:247.06px" class="cls_007"><span class="cls_007">return the instance variable’s value quickly, as shown in Figure 4-15.</span></div>
<div style="position:absolute;left:125.44px;top:284.36px" class="cls_097"><span class="cls_097">opt_send_simple</span></div>
<div style="position:absolute;left:187.28px;top:284.36px" class="cls_097"><span class="cls_097">&lt;callinfo!mid:var, argc:0, ARGS_SKIP></span></div>
<div style="position:absolute;left:345.26px;top:284.36px" class="cls_097"><span class="cls_097">[ C function - vm_getivar ]</span></div>
<div style="position:absolute;left:123.00px;top:318.36px" class="cls_038"><span class="cls_038">Figure 4-15: </span><span class="cls_014">VM_METHOD_TYPE_IVAR</span><span class="cls_038"> methods call </span><span class="cls_014">vm_getivar</span><span class="cls_038"> directly.</span></div>
<div style="position:absolute;left:141.00px;top:339.86px" class="cls_007"><span class="cls_007">Here, the </span><span class="cls_030">opt_send_simple</span><span class="cls_007"> YARV instruction on the left calls the </span><span class="cls_030">vm_getivar</span></div>
<div style="position:absolute;left:123.00px;top:351.86px" class="cls_007"><span class="cls_007">C function on the right. As in Figure 4-14, when calling </span><span class="cls_030">vm_setivar</span><span class="cls_007">, Ruby</span></div>
<div style="position:absolute;left:123.00px;top:363.86px" class="cls_007"><span class="cls_007">doesn’t need to create a new stack frame or execute YARV instructions. It</span></div>
<div style="position:absolute;left:123.00px;top:375.86px" class="cls_007"><span class="cls_007">simply returns the value of </span><span class="cls_030">var</span><span class="cls_007"> immediately.</span></div>
<div style="position:absolute;left:123.00px;top:405.86px" class="cls_031"><span class="cls_031">Experiment 4-2: Exploring How Ruby Implements</span></div>
<div style="position:absolute;left:123.00px;top:420.86px" class="cls_031"><span class="cls_031">Keyword Arguments</span></div>
<div style="position:absolute;left:123.00px;top:440.86px" class="cls_007"><span class="cls_007">Beginning with Ruby 2.0, you can specify labels for method arguments.</span></div>
<div style="position:absolute;left:123.00px;top:452.86px" class="cls_007"><span class="cls_007">Listing 4-8 shows a simple example.</span></div>
<div style="position:absolute;left:111.15px;top:476.86px" class="cls_046"><span class="cls_046">u</span><span class="cls_030"> def add_two(a: 2, b: 3)</span></div>
<div style="position:absolute;left:131.50px;top:487.36px" class="cls_030"><span class="cls_030">a+b</span></div>
<div style="position:absolute;left:123.00px;top:497.86px" class="cls_030"><span class="cls_030">end</span></div>
<div style="position:absolute;left:111.15px;top:518.86px" class="cls_046"><span class="cls_046">v</span><span class="cls_030"> puts add_two(a: 1, b: 1)</span></div>
<div style="position:absolute;left:127.25px;top:529.36px" class="cls_030"><span class="cls_030">=> 2</span></div>
<div style="position:absolute;left:123.00px;top:551.86px" class="cls_038"><span class="cls_038">Listing 4-8: A simple example of using keyword arguments</span></div>
<div style="position:absolute;left:141.00px;top:574.36px" class="cls_007"><span class="cls_007">We use the labels </span><span class="cls_030">a</span><span class="cls_007"> and </span><span class="cls_030">b</span><span class="cls_007"> for the keyword arguments to </span><span class="cls_030">add_two </span><span class="cls_050">u</span><span class="cls_007">.</span></div>
<div style="position:absolute;left:123.00px;top:586.36px" class="cls_007"><span class="cls_007">When we call the function </span><span class="cls_050">v</span><span class="cls_007">, we get the result 2. I hinted in Chapter 2 that</span></div>
<div style="position:absolute;left:123.00px;top:598.36px" class="cls_007"><span class="cls_007">Ruby uses a hash to implement keyword arguments. Let’s prove this is the</span></div>
<div style="position:absolute;left:123.00px;top:610.36px" class="cls_007"><span class="cls_007">case using Listing 4-9.</span></div>
<div style="position:absolute;left:327.36px;top:636.00px" class="cls_021"><span class="cls_021">Control Structures and Method Dispatch</span></div>
<div style="position:absolute;left:446.95px;top:633.00px" class="cls_020"><span class="cls_020">99</span></div>
</div>
<div style="position:absolute;left:50%;margin-left:-252px;top:81120px;width:504px;height:666px;border-style:outset;overflow:hidden">
<div style="position:absolute;left:0px;top:0px">
<img src="e698b76e-46bd-11eb-8b25-0cc47a792c0a_id_e698b76e-46bd-11eb-8b25-0cc47a792c0a_files/background124.jpg" width=504 height=666></div>
<div style="position:absolute;left:120.00px;top:49.00px" class="cls_030"><span class="cls_030">class Hash</span></div>
<div style="position:absolute;left:108.15px;top:59.50px" class="cls_046"><span class="cls_046">u</span><span class="cls_030">   def key?(val)</span></div>
<div style="position:absolute;left:108.15px;top:70.00px" class="cls_046"><span class="cls_046">v</span><span class="cls_030">     puts "Looking for key #{val}"</span></div>
<div style="position:absolute;left:137.00px;top:80.49px" class="cls_030"><span class="cls_030">false</span></div>
<div style="position:absolute;left:128.50px;top:90.99px" class="cls_030"><span class="cls_030">end</span></div>
<div style="position:absolute;left:120.00px;top:101.49px" class="cls_030"><span class="cls_030">end</span></div>
<div style="position:absolute;left:120.00px;top:122.49px" class="cls_030"><span class="cls_030">def add_two(a: 2, b: 3)</span></div>
<div style="position:absolute;left:128.50px;top:132.99px" class="cls_030"><span class="cls_030">a+b</span></div>
<div style="position:absolute;left:120.00px;top:143.49px" class="cls_030"><span class="cls_030">end</span></div>
<div style="position:absolute;left:120.00px;top:164.49px" class="cls_030"><span class="cls_030">puts add_two (a: 1, b: 1)</span></div>
<div style="position:absolute;left:120.00px;top:186.99px" class="cls_038"><span class="cls_038">Listing 4-9: Demonstrating that Ruby uses a hash to implement keyword arguments</span></div>
<div style="position:absolute;left:138.00px;top:209.50px" class="cls_007"><span class="cls_007">We override the </span><span class="cls_030">key?</span><span class="cls_007"> method </span><span class="cls_050">u</span><span class="cls_007"> of the </span><span class="cls_030">Hash</span><span class="cls_007"> class, which displays a</span></div>
<div style="position:absolute;left:120.00px;top:221.50px" class="cls_007"><span class="cls_007">message </span><span class="cls_050">v</span><span class="cls_007"> and then returns </span><span class="cls_030">false</span><span class="cls_007">. Here’s the output we get when we</span></div>
<div style="position:absolute;left:120.00px;top:233.50px" class="cls_007"><span class="cls_007">run Listing 4-9.</span></div>
<div style="position:absolute;left:120.00px;top:257.50px" class="cls_030"><span class="cls_030">Looking for key a</span></div>
<div style="position:absolute;left:120.00px;top:268.00px" class="cls_030"><span class="cls_030">Looking for key b</span></div>
<div style="position:absolute;left:120.00px;top:278.49px" class="cls_030"><span class="cls_030">5</span></div>
<div style="position:absolute;left:138.00px;top:301.00px" class="cls_007"><span class="cls_007">As you can see, Ruby is calling </span><span class="cls_030">Hash#key?</span><span class="cls_007"> twice: once to find the key </span><span class="cls_030">a</span></div>
<div style="position:absolute;left:120.00px;top:313.00px" class="cls_007"><span class="cls_007">and a second time to find the key </span><span class="cls_030">b</span><span class="cls_007">. For some reason, Ruby has created</span></div>
<div style="position:absolute;left:120.00px;top:325.00px" class="cls_007"><span class="cls_007">a hash even though we never used a hash in the code. Also, Ruby is now</span></div>
<div style="position:absolute;left:120.00px;top:337.00px" class="cls_007"><span class="cls_007">ignoring the values we pass into </span><span class="cls_030">add_two</span><span class="cls_007">. Instead of 2, we get 5. It looks like</span></div>
<div style="position:absolute;left:120.00px;top:349.00px" class="cls_007"><span class="cls_007">Ruby is using the default values for </span><span class="cls_030">a</span><span class="cls_007"> and </span><span class="cls_030">b</span><span class="cls_007">, not the values we provided. Why</span></div>
<div style="position:absolute;left:120.00px;top:361.00px" class="cls_007"><span class="cls_007">did Ruby create a hash, and what does it contain? And why did Ruby ignore</span></div>
<div style="position:absolute;left:120.00px;top:373.00px" class="cls_007"><span class="cls_007">my parameter values when I overrode </span><span class="cls_030">Hash#key?</span><span class="cls_007">?</span></div>
<div style="position:absolute;left:138.00px;top:385.00px" class="cls_007"><span class="cls_007">To learn how Ruby implements keyword arguments and to explain the</span></div>
<div style="position:absolute;left:120.00px;top:397.00px" class="cls_007"><span class="cls_007">results we see running Listing 4-9, we can examine the YARV instructions</span></div>
<div style="position:absolute;left:120.00px;top:409.00px" class="cls_007"><span class="cls_007">generated by Ruby’s compiler for </span><span class="cls_030">add_two</span><span class="cls_007">. Running Listing 4-10 displays the</span></div>
<div style="position:absolute;left:120.00px;top:421.00px" class="cls_007"><span class="cls_007">YARV instructions that correspond to Listing 4-9.</span></div>
<div style="position:absolute;left:120.00px;top:445.00px" class="cls_030"><span class="cls_030">code = &lt;&lt;END</span></div>
<div style="position:absolute;left:120.00px;top:455.50px" class="cls_030"><span class="cls_030">def add_two(a: 2, b: 3)</span></div>
<div style="position:absolute;left:128.50px;top:465.99px" class="cls_030"><span class="cls_030">a+b</span></div>
<div style="position:absolute;left:120.00px;top:476.49px" class="cls_030"><span class="cls_030">end</span></div>
<div style="position:absolute;left:120.00px;top:497.50px" class="cls_030"><span class="cls_030">puts add_two(a: 1, b: 1)</span></div>
<div style="position:absolute;left:120.00px;top:507.99px" class="cls_030"><span class="cls_030">END</span></div>
<div style="position:absolute;left:120.00px;top:529.00px" class="cls_030"><span class="cls_030">puts RubyVM::InstructionSequence.compile(code).disasm</span></div>
<div style="position:absolute;left:120.00px;top:551.50px" class="cls_038"><span class="cls_038">Listing 4-10: Displaying the YARV instructions for the code in Listing 4-9</span></div>
<div style="position:absolute;left:138.00px;top:574.00px" class="cls_007"><span class="cls_007">Figure 4-16 shows a simplified version of the output generated by</span></div>
<div style="position:absolute;left:120.00px;top:586.00px" class="cls_007"><span class="cls_007">Listing 4-10.</span></div>
<div style="position:absolute;left:48.00px;top:633.00px" class="cls_020"><span class="cls_020">100</span></div>
<div style="position:absolute;left:74.31px;top:636.00px" class="cls_021"><span class="cls_021">Chapter 4</span></div>
</div>
<div style="position:absolute;left:50%;margin-left:-252px;top:81796px;width:504px;height:666px;border-style:outset;overflow:hidden">
<div style="position:absolute;left:0px;top:0px">
<img src="e698b76e-46bd-11eb-8b25-0cc47a792c0a_id_e698b76e-46bd-11eb-8b25-0cc47a792c0a_files/background125.jpg" width=504 height=666></div>
<div style="position:absolute;left:125.68px;top:47.16px" class="cls_033"><span class="cls_033">def add_two(a: 2, b: 3)</span></div>
<div style="position:absolute;left:264.09px;top:55.43px" class="cls_014"><span class="cls_014">putself</span></div>
<div style="position:absolute;left:134.68px;top:57.43px" class="cls_033"><span class="cls_033">a+b</span></div>
<div style="position:absolute;left:264.09px;top:64.39px" class="cls_014"><span class="cls_014">putself</span></div>
<div style="position:absolute;left:125.68px;top:68.97px" class="cls_033"><span class="cls_033">end</span></div>
<div style="position:absolute;left:264.09px;top:73.34px" class="cls_014"><span class="cls_014">putspecialobject 1</span></div>
<div style="position:absolute;left:264.09px;top:82.29px" class="cls_014"><span class="cls_014">putobject</span></div>
<div style="position:absolute;left:331.67px;top:82.29px" class="cls_014"><span class="cls_014">[:a, 1, :b, 1]</span></div>
<div style="position:absolute;left:125.68px;top:89.46px" class="cls_033"><span class="cls_033">puts add_two(a: 1, b: 1)</span></div>
<div style="position:absolute;left:264.09px;top:91.24px" class="cls_014"><span class="cls_014">opt_send_simple</span></div>
<div style="position:absolute;left:331.67px;top:91.24px" class="cls_014"><span class="cls_014">&lt;callinfo!</span></div>
<div style="position:absolute;left:331.67px;top:100.19px" class="cls_014"><span class="cls_014">mid:core#hash_from_ary, argc:1</span></div>
<div style="position:absolute;left:264.09px;top:109.15px" class="cls_014"><span class="cls_014">opt_send_simple</span></div>
<div style="position:absolute;left:331.67px;top:109.15px" class="cls_014"><span class="cls_014">&lt;callinfo!mid:add_two, argc:1</span></div>
<div style="position:absolute;left:264.09px;top:118.10px" class="cls_014"><span class="cls_014">opt_send_simple</span></div>
<div style="position:absolute;left:331.67px;top:118.10px" class="cls_014"><span class="cls_014">&lt;callinfo!mid:puts, argc:1</span></div>
<div style="position:absolute;left:123.00px;top:138.85px" class="cls_038"><span class="cls_038">Figure 4-16: Part of the output generated by Listing 4-10</span></div>
<div style="position:absolute;left:141.00px;top:161.35px" class="cls_007"><span class="cls_007">On the right of Figure 4-16, you can see that Ruby first pushes an</span></div>
<div style="position:absolute;left:123.00px;top:173.35px" class="cls_007"><span class="cls_007">array onto the stack: </span><span class="cls_030">[:a, 1, :b, 1]</span><span class="cls_007">. Next, it calls the internal C function</span></div>
<div style="position:absolute;left:123.00px;top:185.35px" class="cls_030"><span class="cls_030">hash_from_ary</span><span class="cls_007">, which we can guess will convert the </span><span class="cls_030">[:a, 1, :b, 1]</span><span class="cls_007"> array into a</span></div>
<div style="position:absolute;left:123.00px;top:197.35px" class="cls_007"><span class="cls_007">hash. Finally, Ruby calls the </span><span class="cls_030">add_two</span><span class="cls_007"> method to add the numbers and the </span><span class="cls_030">puts</span></div>
<div style="position:absolute;left:123.00px;top:209.35px" class="cls_007"><span class="cls_007">method to display the result.</span></div>
<div style="position:absolute;left:141.00px;top:221.35px" class="cls_007"><span class="cls_007">Now let’s look at the YARV instructions for the </span><span class="cls_030">add_two</span><span class="cls_007"> method itself,</span></div>
<div style="position:absolute;left:123.00px;top:233.35px" class="cls_007"><span class="cls_007">shown in Figure 4-17.</span></div>
<div style="position:absolute;left:241.71px;top:258.04px" class="cls_067"><span class="cls_067">YARV instructions</span></div>
<div style="position:absolute;left:415.43px;top:258.04px" class="cls_067"><span class="cls_067">Local Table</span></div>
<div style="position:absolute;left:241.59px;top:274.04px" class="cls_099"><span class="cls_099">0000 getlocal 2, 0</span></div>
<div style="position:absolute;left:241.59px;top:282.20px" class="cls_099"><span class="cls_099">0002 dup</span></div>
<div style="position:absolute;left:241.59px;top:290.35px" class="cls_099"><span class="cls_099">0003 putobject :a</span></div>
<div style="position:absolute;left:422.66px;top:296.02px" class="cls_099"><span class="cls_099">[ 2] ?</span></div>
<div style="position:absolute;left:241.59px;top:298.50px" class="cls_099"><span class="cls_099">0005 opt_send_simple &lt;callinfo!mid:key?...</span></div>
<div style="position:absolute;left:422.66px;top:304.17px" class="cls_099"><span class="cls_099">[ 3] b</span></div>
<div style="position:absolute;left:241.59px;top:306.65px" class="cls_099"><span class="cls_099">0007 branchunless 18</span></div>
<div style="position:absolute;left:125.72px;top:313.19px" class="cls_100"><span class="cls_100">def add_two(a: 2, b: 3)</span></div>
<div style="position:absolute;left:241.59px;top:314.81px" class="cls_099"><span class="cls_099">0009 dup</span></div>
<div style="position:absolute;left:422.66px;top:312.33px" class="cls_099"><span class="cls_099">[ 4] a</span></div>
<div style="position:absolute;left:134.36px;top:323.47px" class="cls_100"><span class="cls_100">a+b</span></div>
<div style="position:absolute;left:241.59px;top:322.96px" class="cls_099"><span class="cls_099">0010 putobject :a</span></div>
<div style="position:absolute;left:241.59px;top:331.11px" class="cls_099"><span class="cls_099">0012 opt_send_simple &lt;callinfo!mid:delete...</span></div>
<div style="position:absolute;left:125.72px;top:334.01px" class="cls_100"><span class="cls_100">end</span></div>
<div style="position:absolute;left:241.59px;top:339.26px" class="cls_099"><span class="cls_099">0014 setlocal 4, 0</span></div>
<div style="position:absolute;left:241.59px;top:347.42px" class="cls_099"><span class="cls_099">0016 jump 22</span></div>
<div style="position:absolute;left:125.72px;top:354.50px" class="cls_100"><span class="cls_100">puts add_two(a: 1, b: 1)</span></div>
<div style="position:absolute;left:241.59px;top:355.57px" class="cls_099"><span class="cls_099">0018 putobject 2</span></div>
<div style="position:absolute;left:241.59px;top:363.72px" class="cls_099"><span class="cls_099">0020 setlocal 4, 0</span></div>
<div style="position:absolute;left:241.59px;top:371.87px" class="cls_099"><span class="cls_099">0022 dup</span></div>
<div style="position:absolute;left:241.59px;top:388.18px" class="cls_099"><span class="cls_099">etc...</span></div>
<div style="position:absolute;left:123.00px;top:408.58px" class="cls_038"><span class="cls_038">Figure 4-17: The YARV instructions compiled from the beginning of the </span><span class="cls_014">add_two</span><span class="cls_038"> method</span></div>
<div style="position:absolute;left:141.00px;top:431.08px" class="cls_007"><span class="cls_007">What are these YARV instructions doing? The Ruby method </span><span class="cls_030">add_two</span></div>
<div style="position:absolute;left:123.00px;top:443.08px" class="cls_007"><span class="cls_007">didn’t contain any code similar to this! (All </span><span class="cls_030">add_two</span><span class="cls_007"> does is add </span><span class="cls_030">a</span><span class="cls_007"> and </span><span class="cls_030">b</span></div>
<div style="position:absolute;left:123.00px;top:455.08px" class="cls_007"><span class="cls_007">together and return the sum.)</span></div>
<div style="position:absolute;left:141.00px;top:467.08px" class="cls_007"><span class="cls_007">To find out, let’s walk through Figure 4-17. On the left side, we see the</span></div>
<div style="position:absolute;left:123.00px;top:479.08px" class="cls_007"><span class="cls_007">Ruby </span><span class="cls_030">add_two</span><span class="cls_007"> method, and on the right, the YARV instructions for </span><span class="cls_030">add_two</span><span class="cls_007">.</span></div>
<div style="position:absolute;left:123.00px;top:491.08px" class="cls_007"><span class="cls_007">On the far right, you see the local table for </span><span class="cls_030">add_two</span><span class="cls_007">. Notice that there are</span></div>
<div style="position:absolute;left:123.00px;top:503.08px" class="cls_007"><span class="cls_007">three values listed there: </span><span class="cls_030">[ 2] ?</span><span class="cls_007">, </span><span class="cls_030">[ 3] b</span><span class="cls_007">, and </span><span class="cls_030">[ 4] a</span><span class="cls_007">. It should be clear that</span></div>
<div style="position:absolute;left:123.00px;top:515.08px" class="cls_030"><span class="cls_030">a</span><span class="cls_007"> and </span><span class="cls_030">b</span><span class="cls_007"> correspond to the two arguments to </span><span class="cls_030">add_two</span><span class="cls_007">, but what does </span><span class="cls_030">[ 2] ?</span></div>
<div style="position:absolute;left:123.00px;top:527.08px" class="cls_007"><span class="cls_007">mean? This appears to be some sort of mystery value.</span></div>
<div style="position:absolute;left:141.00px;top:539.08px" class="cls_007"><span class="cls_007">The mystery value is the hash we saw created in Figure 4-16! In order to</span></div>
<div style="position:absolute;left:123.00px;top:551.08px" class="cls_007"><span class="cls_007">implement keyword arguments, Ruby has created this third, hidden argu-</span></div>
<div style="position:absolute;left:123.00px;top:563.08px" class="cls_007"><span class="cls_007">ment to </span><span class="cls_030">add_two</span><span class="cls_007">.</span></div>
<div style="position:absolute;left:323.57px;top:636.00px" class="cls_021"><span class="cls_021">Control Structures and Method Dispatch</span></div>
<div style="position:absolute;left:443.15px;top:633.00px" class="cls_020"><span class="cls_020">101</span></div>
</div>
<div style="position:absolute;left:50%;margin-left:-252px;top:82472px;width:504px;height:666px;border-style:outset;overflow:hidden">
<div style="position:absolute;left:0px;top:0px">
<img src="e698b76e-46bd-11eb-8b25-0cc47a792c0a_id_e698b76e-46bd-11eb-8b25-0cc47a792c0a_files/background126.jpg" width=504 height=666></div>
<div style="position:absolute;left:138.00px;top:42.28px" class="cls_007"><span class="cls_007">The YARV instructions in Figure 4-17 show that </span><span class="cls_030">getlocal 2, 0</span><span class="cls_007"> followed</span></div>
<div style="position:absolute;left:120.00px;top:54.28px" class="cls_007"><span class="cls_007">by </span><span class="cls_030">dup</span><span class="cls_007"> places this hash onto the stack as a receiver. Next, </span><span class="cls_030">putobject :a</span><span class="cls_007"> puts</span></div>
<div style="position:absolute;left:120.00px;top:66.28px" class="cls_007"><span class="cls_007">the symbol </span><span class="cls_030">:a</span><span class="cls_007"> onto the stack as a method parameter, and </span><span class="cls_030">opt_send_simple</span></div>
<div style="position:absolute;left:120.00px;top:78.28px" class="cls_030"><span class="cls_030">&lt;callinfo!mid:key?</span><span class="cls_007"> calls the </span><span class="cls_030">key?</span><span class="cls_007"> method on the receiver, which is the hash.</span></div>
<div style="position:absolute;left:138.00px;top:90.28px" class="cls_007"><span class="cls_007">These YARV instructions are equivalent to the following line of Ruby</span></div>
<div style="position:absolute;left:120.00px;top:102.28px" class="cls_007"><span class="cls_007">code. Ruby is querying the hidden hash object to see whether it contains</span></div>
<div style="position:absolute;left:120.00px;top:114.28px" class="cls_007"><span class="cls_007">the key </span><span class="cls_030">:a</span><span class="cls_007">.</span></div>
<div style="position:absolute;left:120.00px;top:138.28px" class="cls_030"><span class="cls_030">hidden_hash.key?(:a)</span></div>
<div style="position:absolute;left:138.00px;top:160.78px" class="cls_007"><span class="cls_007">Reading the rest of the YARV instructions from Figure 4-17, we see that</span></div>
<div style="position:absolute;left:120.00px;top:172.78px" class="cls_007"><span class="cls_007">if the hash contains the key, Ruby calls the </span><span class="cls_030">delete</span><span class="cls_007"> method, which removes</span></div>
<div style="position:absolute;left:120.00px;top:184.78px" class="cls_007"><span class="cls_007">the key from the hash and returns the corresponding value. Next, </span><span class="cls_030">setlocal 4,</span></div>
<div style="position:absolute;left:120.00px;top:196.78px" class="cls_030"><span class="cls_030">0</span><span class="cls_007"> saves this value into the </span><span class="cls_030">a</span><span class="cls_007"> argument. If the hash didn’t contain the key </span><span class="cls_030">:a</span><span class="cls_007">,</span></div>
<div style="position:absolute;left:120.00px;top:208.78px" class="cls_007"><span class="cls_007">Ruby would call </span><span class="cls_030">putobject 2</span><span class="cls_007"> and </span><span class="cls_030">setlocal 4, 0</span><span class="cls_007"> to save the default value 2 into</span></div>
<div style="position:absolute;left:120.00px;top:220.78px" class="cls_007"><span class="cls_007">the argument.</span></div>
<div style="position:absolute;left:138.00px;top:232.78px" class="cls_007"><span class="cls_007">To summarize, all of the YARV instructions shown in Figure 4-17 imple-</span></div>
<div style="position:absolute;left:120.00px;top:244.78px" class="cls_007"><span class="cls_007">ment the snippet of Ruby code shown in Listing 4-11.</span></div>
<div style="position:absolute;left:120.00px;top:268.78px" class="cls_030"><span class="cls_030">if hidden_hash.key?(:a)</span></div>
<div style="position:absolute;left:128.50px;top:279.28px" class="cls_030"><span class="cls_030">a = hidden_hash.delete(:a)</span></div>
<div style="position:absolute;left:120.00px;top:289.77px" class="cls_030"><span class="cls_030">else</span></div>
<div style="position:absolute;left:128.50px;top:300.27px" class="cls_030"><span class="cls_030">a = 2</span></div>
<div style="position:absolute;left:120.00px;top:310.77px" class="cls_030"><span class="cls_030">end</span></div>
<div style="position:absolute;left:120.00px;top:333.27px" class="cls_038"><span class="cls_038">Listing 4-11: The YARV instructions shown in Figure 4-17 are equivalent to this Ruby code.</span></div>
<div style="position:absolute;left:138.00px;top:358.78px" class="cls_007"><span class="cls_007">Now we can see that Ruby stores the keyword arguments and their values</span></div>
<div style="position:absolute;left:120.00px;top:370.78px" class="cls_007"><span class="cls_007">in the hidden hash argument. When the method starts, it first loads each</span></div>
<div style="position:absolute;left:120.00px;top:382.78px" class="cls_007"><span class="cls_007">argument’s value from the hash or uses the default value if there is none.</span></div>
<div style="position:absolute;left:120.00px;top:394.78px" class="cls_007"><span class="cls_007">The behavior indicated by the Ruby code in Figure 4-14 explains the results</span></div>
<div style="position:absolute;left:120.00px;top:406.78px" class="cls_007"><span class="cls_007">we saw when running Listing 4-9. Remember that we changed the </span><span class="cls_030">Hash#key?</span></div>
<div style="position:absolute;left:120.00px;top:418.78px" class="cls_007"><span class="cls_007">method to always return </span><span class="cls_030">false</span><span class="cls_007">. If </span><span class="cls_030">hidden_hash.key?</span><span class="cls_007"> always returns </span><span class="cls_030">false</span><span class="cls_007">, Ruby</span></div>
<div style="position:absolute;left:120.00px;top:430.78px" class="cls_007"><span class="cls_007">will ignore the value of each argument and use the default value instead,</span></div>
<div style="position:absolute;left:120.00px;top:442.78px" class="cls_007"><span class="cls_007">even if a value was provided.</span></div>
<div style="position:absolute;left:138.00px;top:454.78px" class="cls_007"><span class="cls_007">One last detail about keyword arguments: Whenever you call any</span></div>
<div style="position:absolute;left:120.00px;top:466.78px" class="cls_007"><span class="cls_007">method and use keyword arguments, YARV checks to see whether the</span></div>
<div style="position:absolute;left:120.00px;top:478.78px" class="cls_007"><span class="cls_007">keyword arguments you provide are expected by the target method.</span></div>
<div style="position:absolute;left:120.00px;top:490.78px" class="cls_007"><span class="cls_007">Ruby raises an exception if there is an unexpected argument, as shown</span></div>
<div style="position:absolute;left:120.00px;top:502.78px" class="cls_007"><span class="cls_007">in Listing 4-12.</span></div>
<div style="position:absolute;left:48.00px;top:633.00px" class="cls_020"><span class="cls_020">102</span></div>
<div style="position:absolute;left:74.18px;top:636.00px" class="cls_021"><span class="cls_021">Chapter 4</span></div>
</div>
<div style="position:absolute;left:50%;margin-left:-252px;top:83148px;width:504px;height:666px;border-style:outset;overflow:hidden">
<div style="position:absolute;left:0px;top:0px">
<img src="e698b76e-46bd-11eb-8b25-0cc47a792c0a_id_e698b76e-46bd-11eb-8b25-0cc47a792c0a_files/background127.jpg" width=504 height=666></div>
<div style="position:absolute;left:123.00px;top:49.00px" class="cls_030"><span class="cls_030">def add_two(a: 2, b: 3)</span></div>
<div style="position:absolute;left:131.50px;top:59.50px" class="cls_030"><span class="cls_030">a+b</span></div>
<div style="position:absolute;left:123.00px;top:70.00px" class="cls_030"><span class="cls_030">end</span></div>
<div style="position:absolute;left:123.00px;top:91.00px" class="cls_030"><span class="cls_030">puts add_two(c: 9)</span></div>
<div style="position:absolute;left:127.25px;top:101.50px" class="cls_030"><span class="cls_030">=> unknown keyword: c (ArgumentError)</span></div>
<div style="position:absolute;left:123.00px;top:124.00px" class="cls_038"><span class="cls_038">Listing 4-12: Ruby throws an exception if you pass an unexpected keyword argument.</span></div>
<div style="position:absolute;left:141.00px;top:146.50px" class="cls_007"><span class="cls_007">Because the argument list for </span><span class="cls_030">add_two</span><span class="cls_007"> didn’t include the letter </span><span class="cls_030">c</span><span class="cls_007">, Ruby</span></div>
<div style="position:absolute;left:123.00px;top:158.50px" class="cls_007"><span class="cls_007">throws an exception when we try to call the method with </span><span class="cls_030">c</span><span class="cls_007">. This special</span></div>
<div style="position:absolute;left:123.00px;top:170.50px" class="cls_007"><span class="cls_007">check happens during the method dispatch process.</span></div>
<div style="position:absolute;left:69.00px;top:204.50px" class="cls_031"><span class="cls_031">Summary</span></div>
<div style="position:absolute;left:123.00px;top:224.50px" class="cls_007"><span class="cls_007">This chapter began with a look at how YARV controls the execution flow of</span></div>
<div style="position:absolute;left:123.00px;top:236.50px" class="cls_007"><span class="cls_007">your Ruby program using a series of low-level control structures. By display-</span></div>
<div style="position:absolute;left:123.00px;top:248.50px" class="cls_007"><span class="cls_007">ing the YARV instructions produced by Ruby’s compiler, we saw some of</span></div>
<div style="position:absolute;left:123.00px;top:260.50px" class="cls_007"><span class="cls_007">YARV’s control structures and learned how they work. In Experiment 4-1, we</span></div>
<div style="position:absolute;left:123.00px;top:272.50px" class="cls_007"><span class="cls_007">discovered that Ruby implements </span><span class="cls_030">for</span><span class="cls_007"> loops internally using the </span><span class="cls_030">each</span><span class="cls_007"> method</span></div>
<div style="position:absolute;left:123.00px;top:284.50px" class="cls_007"><span class="cls_007">with a block.</span></div>
<div style="position:absolute;left:141.00px;top:296.50px" class="cls_007"><span class="cls_007">We also learned that internally Ruby categorizes methods into 11 types.</span></div>
<div style="position:absolute;left:123.00px;top:308.50px" class="cls_007"><span class="cls_007">We saw that Ruby creates a standard ISEQ method when you write a method</span></div>
<div style="position:absolute;left:123.00px;top:320.50px" class="cls_007"><span class="cls_007">using the </span><span class="cls_030">def</span><span class="cls_007"> keyword and that Ruby labels its own built-in methods as</span></div>
<div style="position:absolute;left:123.00px;top:332.50px" class="cls_007"><span class="cls_007">CFUNC methods because they are implemented using C code. We learned</span></div>
<div style="position:absolute;left:123.00px;top:344.50px" class="cls_007"><span class="cls_007">about the ATTRSET and IVAR method types and saw how Ruby switches on</span></div>
<div style="position:absolute;left:123.00px;top:356.50px" class="cls_007"><span class="cls_007">the type of the target method during the method dispatch process.</span></div>
<div style="position:absolute;left:141.00px;top:368.50px" class="cls_007"><span class="cls_007">Finally, in Experiment 4-2, we looked at how Ruby implements keyword</span></div>
<div style="position:absolute;left:123.00px;top:380.50px" class="cls_007"><span class="cls_007">arguments, and we discovered along the way that Ruby uses a hash to track</span></div>
<div style="position:absolute;left:123.00px;top:392.50px" class="cls_007"><span class="cls_007">the argument labels and default values.</span></div>
<div style="position:absolute;left:141.00px;top:404.50px" class="cls_007"><span class="cls_007">In Chapter 5 we’ll switch gears and explore objects and classes. We’ll</span></div>
<div style="position:absolute;left:123.00px;top:416.50px" class="cls_007"><span class="cls_007">return to YARV internals again in Chapter 6 when we look at how the method</span></div>
<div style="position:absolute;left:123.00px;top:428.50px" class="cls_007"><span class="cls_007">lookup process works and discuss the concept of lexical scope.</span></div>
<div style="position:absolute;left:323.17px;top:636.00px" class="cls_021"><span class="cls_021">Control Structures and Method Dispatch</span></div>
<div style="position:absolute;left:442.76px;top:633.00px" class="cls_020"><span class="cls_020">103</span></div>
</div>
<div style="position:absolute;left:50%;margin-left:-252px;top:83824px;width:504px;height:666px;border-style:outset;overflow:hidden">
<div style="position:absolute;left:0px;top:0px">
<img src="e698b76e-46bd-11eb-8b25-0cc47a792c0a_id_e698b76e-46bd-11eb-8b25-0cc47a792c0a_files/background128.jpg" width=504 height=666></div>
<div style="position:absolute;left:233.64px;top:287.91px" class="cls_024"><span class="cls_024">Every Ruby object is the</span></div>
<div style="position:absolute;left:237.10px;top:305.92px" class="cls_024"><span class="cls_024">combination of a class</span></div>
<div style="position:absolute;left:233.09px;top:323.92px" class="cls_024"><span class="cls_024">pointer and an array of</span></div>
<div style="position:absolute;left:246.52px;top:341.93px" class="cls_024"><span class="cls_024">instance variables.</span></div>
</div>
<div style="position:absolute;left:50%;margin-left:-252px;top:84500px;width:504px;height:666px;border-style:outset;overflow:hidden">
<div style="position:absolute;left:0px;top:0px">
<img src="e698b76e-46bd-11eb-8b25-0cc47a792c0a_id_e698b76e-46bd-11eb-8b25-0cc47a792c0a_files/background129.jpg" width=504 height=666></div>
<div style="position:absolute;left:260.10px;top:101.45px" class="cls_035"><span class="cls_035">5</span></div>
<div style="position:absolute;left:178.00px;top:253.45px" class="cls_016"><span class="cls_016">Objects and Classes</span></div>
<div style="position:absolute;left:123.00px;top:369.45px" class="cls_023"><span class="cls_023">We learn early on that Ruby is an object-oriented</span></div>
<div style="position:absolute;left:123.00px;top:387.46px" class="cls_023"><span class="cls_023">language, descended from languages like Smalltalk</span></div>
<div style="position:absolute;left:123.00px;top:405.46px" class="cls_023"><span class="cls_023">and Simula. Every value is an object, and all Ruby pro-</span></div>
<div style="position:absolute;left:123.00px;top:423.46px" class="cls_023"><span class="cls_023">grams consist of a set of objects and the messages sent</span></div>
<div style="position:absolute;left:123.00px;top:442.45px" class="cls_007"><span class="cls_007">between them. Typically, we learn about object-oriented programming by</span></div>
<div style="position:absolute;left:123.00px;top:454.45px" class="cls_007"><span class="cls_007">looking at how to use objects and what they can do: how they can group</span></div>
<div style="position:absolute;left:123.00px;top:466.45px" class="cls_007"><span class="cls_007">together data values and behavior related to those values; how each class</span></div>
<div style="position:absolute;left:123.00px;top:478.45px" class="cls_007"><span class="cls_007">should have a single responsibility or purpose; and how different classes</span></div>
<div style="position:absolute;left:123.00px;top:490.45px" class="cls_007"><span class="cls_007">can be related to each other through encapsulation or inheritance.</span></div>
<div style="position:absolute;left:141.00px;top:502.45px" class="cls_007"><span class="cls_007">But what are Ruby objects? What information does an object contain?</span></div>
<div style="position:absolute;left:123.00px;top:514.45px" class="cls_007"><span class="cls_007">If we were to look at a Ruby object through a microscope, what would we</span></div>
<div style="position:absolute;left:123.00px;top:526.45px" class="cls_007"><span class="cls_007">see? Are there any moving parts inside? And what about Ruby classes?</span></div>
<div style="position:absolute;left:123.00px;top:538.45px" class="cls_007"><span class="cls_007">What exactly is a class?</span></div>
<div style="position:absolute;left:141.00px;top:550.45px" class="cls_007"><span class="cls_007">I’ll answer these questions in this chapter by exploring how Ruby works</span></div>
<div style="position:absolute;left:123.00px;top:562.45px" class="cls_007"><span class="cls_007">internally. By looking at how Ruby implements objects and classes, you’ll</span></div>
<div style="position:absolute;left:123.00px;top:574.45px" class="cls_007"><span class="cls_007">learn how to use them and how to write object-oriented programs using Ruby.</span></div>
</div>
<div style="position:absolute;left:50%;margin-left:-252px;top:85176px;width:504px;height:666px;border-style:outset;overflow:hidden">
<div style="position:absolute;left:0px;top:0px">
<img src="e698b76e-46bd-11eb-8b25-0cc47a792c0a_id_e698b76e-46bd-11eb-8b25-0cc47a792c0a_files/background130.jpg" width=504 height=666></div>
<div style="position:absolute;left:261.47px;top:56.31px" class="cls_020"><span class="cls_020">Roadmap</span></div>
<div style="position:absolute;left:131.99px;top:73.31px" class="cls_017"><span class="cls_017">Inside a Ruby Object</span></div>
<div style="position:absolute;left:415.35px;top:73.31px" class="cls_017"><span class="cls_017">106</span></div>
<div style="position:absolute;left:149.99px;top:90.31px" class="cls_017"><span class="cls_017">Inspecting </span><span class="cls_030">klass</span><span class="cls_017"> and </span><span class="cls_030">ivptr</span></div>
<div style="position:absolute;left:415.36px;top:90.31px" class="cls_017"><span class="cls_017">107</span></div>
<div style="position:absolute;left:150.00px;top:107.31px" class="cls_017"><span class="cls_017">Visualizing Two Instances of One Class</span></div>
<div style="position:absolute;left:415.36px;top:107.31px" class="cls_017"><span class="cls_017">108</span></div>
<div style="position:absolute;left:150.00px;top:124.32px" class="cls_017"><span class="cls_017">Generic Objects</span></div>
<div style="position:absolute;left:415.36px;top:124.32px" class="cls_017"><span class="cls_017">109</span></div>
<div style="position:absolute;left:150.00px;top:141.32px" class="cls_017"><span class="cls_017">Simple Ruby Values Don’t Require a Structure at All</span></div>
<div style="position:absolute;left:415.36px;top:141.32px" class="cls_017"><span class="cls_017">110</span></div>
<div style="position:absolute;left:150.00px;top:158.32px" class="cls_017"><span class="cls_017">Do Generic Objects Have Instance Variables?</span></div>
<div style="position:absolute;left:415.36px;top:158.32px" class="cls_017"><span class="cls_017">111</span></div>
<div style="position:absolute;left:150.00px;top:175.31px" class="cls_017"><span class="cls_017">Reading the </span><span class="cls_030">RBasic</span><span class="cls_017"> and </span><span class="cls_030">RObject</span><span class="cls_017"> C Structure Definitions</span></div>
<div style="position:absolute;left:415.37px;top:175.31px" class="cls_017"><span class="cls_017">112</span></div>
<div style="position:absolute;left:150.01px;top:192.31px" class="cls_017"><span class="cls_017">Where Does Ruby Save Instance Variables for Generic Objects?</span></div>
<div style="position:absolute;left:415.37px;top:192.31px" class="cls_017"><span class="cls_017">113</span></div>
<div style="position:absolute;left:132.01px;top:209.32px" class="cls_019"><span class="cls_019">Experiment 5-1: How Long Does It Take to Save a</span></div>
<div style="position:absolute;left:150.01px;top:220.31px" class="cls_019"><span class="cls_019">New Instance Variable?</span></div>
<div style="position:absolute;left:416.40px;top:220.31px" class="cls_019"><span class="cls_019">113</span></div>
<div style="position:absolute;left:132.01px;top:237.31px" class="cls_017"><span class="cls_017">What’s Inside the </span><span class="cls_030">RClass</span><span class="cls_017"> Structure?</span></div>
<div style="position:absolute;left:415.37px;top:237.31px" class="cls_017"><span class="cls_017">115</span></div>
<div style="position:absolute;left:150.00px;top:254.31px" class="cls_017"><span class="cls_017">Inheritance</span></div>
<div style="position:absolute;left:415.37px;top:254.31px" class="cls_017"><span class="cls_017">118</span></div>
<div style="position:absolute;left:150.00px;top:271.32px" class="cls_017"><span class="cls_017">Class Instance Variables vs. Class Variables</span></div>
<div style="position:absolute;left:415.37px;top:271.32px" class="cls_017"><span class="cls_017">120</span></div>
<div style="position:absolute;left:150.00px;top:288.32px" class="cls_017"><span class="cls_017">Getting and Setting Class Variables</span></div>
<div style="position:absolute;left:415.37px;top:288.32px" class="cls_017"><span class="cls_017">122</span></div>
<div style="position:absolute;left:150.00px;top:305.32px" class="cls_017"><span class="cls_017">Constants</span></div>
<div style="position:absolute;left:415.37px;top:305.32px" class="cls_017"><span class="cls_017">124</span></div>
<div style="position:absolute;left:150.00px;top:322.31px" class="cls_017"><span class="cls_017">The Actual </span><span class="cls_030">RClass</span><span class="cls_017"> Structure</span></div>
<div style="position:absolute;left:415.37px;top:322.31px" class="cls_017"><span class="cls_017">125</span></div>
<div style="position:absolute;left:150.00px;top:339.31px" class="cls_017"><span class="cls_017">Reading the </span><span class="cls_030">RClass</span><span class="cls_017"> C Structure Definition</span></div>
<div style="position:absolute;left:415.37px;top:339.31px" class="cls_017"><span class="cls_017">127</span></div>
<div style="position:absolute;left:132.00px;top:356.31px" class="cls_019"><span class="cls_019">Experiment 5-2: Where Does Ruby Save Class Methods?</span></div>
<div style="position:absolute;left:416.39px;top:356.31px" class="cls_019"><span class="cls_019">127</span></div>
<div style="position:absolute;left:132.00px;top:373.32px" class="cls_017"><span class="cls_017">Summary</span></div>
<div style="position:absolute;left:415.37px;top:373.32px" class="cls_017"><span class="cls_017">131</span></div>
<div style="position:absolute;left:66.00px;top:409.36px" class="cls_031"><span class="cls_031">Inside a Ruby Object</span></div>
<div style="position:absolute;left:120.00px;top:429.36px" class="cls_007"><span class="cls_007">Ruby saves each of your custom objects</span></div>
<div style="position:absolute;left:120.00px;top:441.36px" class="cls_007"><span class="cls_007">in a C structure called </span><span class="cls_030">RObject</span><span class="cls_007">, which</span></div>
<div style="position:absolute;left:120.00px;top:453.36px" class="cls_007"><span class="cls_007">looks like Figure 5-1 in Ruby 1.9</span></div>
<div style="position:absolute;left:120.00px;top:465.36px" class="cls_007"><span class="cls_007">and 2.0.</span></div>
<div style="position:absolute;left:138.00px;top:477.36px" class="cls_007"><span class="cls_007">At the top of the figure is a pointer</span></div>
<div style="position:absolute;left:120.00px;top:489.36px" class="cls_007"><span class="cls_007">to the </span><span class="cls_030">RObject</span><span class="cls_007"> structure. (Internally,</span></div>
<div style="position:absolute;left:120.00px;top:501.36px" class="cls_007"><span class="cls_007">Ruby always refers to any value with a</span></div>
<div style="position:absolute;left:120.00px;top:513.36px" class="cls_030"><span class="cls_030">VALUE</span><span class="cls_007"> pointer.) Below this pointer, the</span></div>
<div style="position:absolute;left:120.00px;top:525.36px" class="cls_030"><span class="cls_030">RObject</span><span class="cls_007"> structure contains an inner</span></div>
<div style="position:absolute;left:321.02px;top:527.52px" class="cls_038"><span class="cls_038">If I could slice open a Ruby object,</span></div>
<div style="position:absolute;left:120.00px;top:537.36px" class="cls_030"><span class="cls_030">RBasic</span><span class="cls_007"> structure and information spe-</span></div>
<div style="position:absolute;left:321.02px;top:538.01px" class="cls_038"><span class="cls_038">what would I see?</span></div>
<div style="position:absolute;left:120.00px;top:549.36px" class="cls_007"><span class="cls_007">cific to custom objects. The </span><span class="cls_030">RBasic</span></div>
<div style="position:absolute;left:120.00px;top:561.36px" class="cls_007"><span class="cls_007">section contains information that all</span></div>
<div style="position:absolute;left:120.00px;top:573.36px" class="cls_007"><span class="cls_007">objects use: a set of Boolean values</span></div>
<div style="position:absolute;left:120.00px;top:585.36px" class="cls_007"><span class="cls_007">called </span><span class="cls_030">flags</span><span class="cls_007"> that store a variety of inter-</span></div>
<div style="position:absolute;left:120.00px;top:597.36px" class="cls_007"><span class="cls_007">nal technical values, and a class pointer</span></div>
<div style="position:absolute;left:120.00px;top:609.36px" class="cls_007"><span class="cls_007">called </span><span class="cls_030">klass</span><span class="cls_007">. The class pointer indicates</span></div>
<div style="position:absolute;left:48.00px;top:633.00px" class="cls_020"><span class="cls_020">106</span></div>
<div style="position:absolute;left:74.26px;top:636.00px" class="cls_021"><span class="cls_021">Chapter 5</span></div>
</div>
<div style="position:absolute;left:50%;margin-left:-252px;top:85852px;width:504px;height:666px;border-style:outset;overflow:hidden">
<div style="position:absolute;left:0px;top:0px">
<img src="e698b76e-46bd-11eb-8b25-0cc47a792c0a_id_e698b76e-46bd-11eb-8b25-0cc47a792c0a_files/background131.jpg" width=504 height=666></div>
<div style="position:absolute;left:123.00px;top:42.28px" class="cls_007"><span class="cls_007">which class an object is an instance of.</span></div>
<div style="position:absolute;left:376.19px;top:47.69px" class="cls_033"><span class="cls_033">VALUE</span></div>
<div style="position:absolute;left:123.00px;top:54.28px" class="cls_007"><span class="cls_007">In the </span><span class="cls_030">RObject</span><span class="cls_007"> section, Ruby saves an array</span></div>
<div style="position:absolute;left:123.00px;top:66.28px" class="cls_007"><span class="cls_007">of instance variables that each object con-</span></div>
<div style="position:absolute;left:123.00px;top:78.28px" class="cls_007"><span class="cls_007">tains, using </span><span class="cls_030">numiv</span><span class="cls_007">, the instance variable</span></div>
<div style="position:absolute;left:123.00px;top:90.28px" class="cls_007"><span class="cls_007">count, and </span><span class="cls_030">ivptr</span><span class="cls_007">, a pointer to an array of</span></div>
<div style="position:absolute;left:350.50px;top:95.97px" class="cls_020"><span class="cls_020">RObject</span></div>
<div style="position:absolute;left:123.00px;top:102.28px" class="cls_007"><span class="cls_007">values.</span></div>
<div style="position:absolute;left:141.00px;top:114.28px" class="cls_007"><span class="cls_007">If we were to define the Ruby object</span></div>
<div style="position:absolute;left:358.07px;top:115.01px" class="cls_020"><span class="cls_020">RBasic</span></div>
<div style="position:absolute;left:123.00px;top:126.28px" class="cls_007"><span class="cls_007">structure in technical terms, we could say</span></div>
<div style="position:absolute;left:377.44px;top:131.76px" class="cls_014"><span class="cls_014">flags</span></div>
<div style="position:absolute;left:159.00px;top:145.28px" class="cls_033"><span class="cls_033">Every Ruby object is the com-</span></div>
<div style="position:absolute;left:377.44px;top:154.03px" class="cls_014"><span class="cls_014">klass</span></div>
<div style="position:absolute;left:159.00px;top:157.28px" class="cls_033"><span class="cls_033">bination of a class pointer and</span></div>
<div style="position:absolute;left:159.00px;top:169.27px" class="cls_033"><span class="cls_033">an array of instance variables.</span></div>
<div style="position:absolute;left:141.00px;top:186.28px" class="cls_007"><span class="cls_007">At first glance, this definition doesn’t</span></div>
<div style="position:absolute;left:377.44px;top:186.88px" class="cls_014"><span class="cls_014">numiv</span></div>
<div style="position:absolute;left:123.00px;top:198.28px" class="cls_007"><span class="cls_007">seem very useful because it doesn’t help</span></div>
<div style="position:absolute;left:123.00px;top:210.28px" class="cls_007"><span class="cls_007">us understand the meaning or purpose</span></div>
<div style="position:absolute;left:377.44px;top:210.06px" class="cls_014"><span class="cls_014">ivptr</span></div>
<div style="position:absolute;left:123.00px;top:222.28px" class="cls_007"><span class="cls_007">behind objects or how to use them in a</span></div>
<div style="position:absolute;left:123.00px;top:234.28px" class="cls_007"><span class="cls_007">Ruby program.</span></div>
<div style="position:absolute;left:337.92px;top:240.44px" class="cls_038"><span class="cls_038">Figure 5-1: The </span><span class="cls_014">RObject</span><span class="cls_038"> structure</span></div>
<div style="position:absolute;left:123.00px;top:259.28px" class="cls_055"><span class="cls_055">Inspecting klass and ivptr</span></div>
<div style="position:absolute;left:123.00px;top:277.28px" class="cls_007"><span class="cls_007">To understand how Ruby uses </span><span class="cls_030">RObject</span><span class="cls_007"> in programs, we’ll create a simple</span></div>
<div style="position:absolute;left:123.00px;top:289.28px" class="cls_007"><span class="cls_007">Ruby class and then inspect an instance of this class using IRB. For example,</span></div>
<div style="position:absolute;left:123.00px;top:301.28px" class="cls_007"><span class="cls_007">suppose I have the simple Ruby class shown in Listing 5-1.</span></div>
<div style="position:absolute;left:123.00px;top:325.28px" class="cls_030"><span class="cls_030">class Mathematician</span></div>
<div style="position:absolute;left:131.50px;top:335.78px" class="cls_030"><span class="cls_030">attr_accessor :first_name</span></div>
<div style="position:absolute;left:131.50px;top:346.27px" class="cls_030"><span class="cls_030">attr_accessor :last_name</span></div>
<div style="position:absolute;left:123.00px;top:356.77px" class="cls_030"><span class="cls_030">end</span></div>
<div style="position:absolute;left:123.00px;top:379.27px" class="cls_038"><span class="cls_038">Listing 5-1: A simple Ruby class</span></div>
<div style="position:absolute;left:141.00px;top:399.78px" class="cls_007"><span class="cls_007">Ruby needs to save the class pointer in </span><span class="cls_030">RObject</span><span class="cls_007"> because every object</span></div>
<div style="position:absolute;left:123.00px;top:411.78px" class="cls_007"><span class="cls_007">must track the class you used to create it. When you create an instance of a</span></div>
<div style="position:absolute;left:123.00px;top:423.78px" class="cls_007"><span class="cls_007">class, Ruby internally saves a pointer to that class inside </span><span class="cls_030">RObject</span><span class="cls_007">, as shown in</span></div>
<div style="position:absolute;left:123.00px;top:435.78px" class="cls_007"><span class="cls_007">Listing 5-2.</span></div>
<div style="position:absolute;left:123.00px;top:459.78px" class="cls_030"><span class="cls_030">$ </span><span class="cls_040">irb</span></div>
<div style="position:absolute;left:123.00px;top:470.28px" class="cls_030"><span class="cls_030">> </span><span class="cls_040">euler = Mathematician.new</span></div>
<div style="position:absolute;left:111.00px;top:480.77px" class="cls_046"><span class="cls_046">u</span><span class="cls_030">  => #&lt;Mathematician:0x007fbd738608c0></span></div>
<div style="position:absolute;left:123.00px;top:503.27px" class="cls_038"><span class="cls_038">Listing 5-2: Creating an object instance in IRB</span></div>
<div style="position:absolute;left:141.00px;top:524.78px" class="cls_007"><span class="cls_007">By displaying the class name </span><span class="cls_030">#&lt;Mathematician</span><span class="cls_007"> at </span><span class="cls_050">u</span><span class="cls_007">, Ruby displays the</span></div>
<div style="position:absolute;left:123.00px;top:536.78px" class="cls_007"><span class="cls_007">value of the class pointer for the </span><span class="cls_030">euler</span><span class="cls_007"> object. The hex string that follows is</span></div>
<div style="position:absolute;left:123.00px;top:548.78px" class="cls_007"><span class="cls_007">actually the </span><span class="cls_030">VALUE</span><span class="cls_007"> pointer for the object. (This will differ for every instance</span></div>
<div style="position:absolute;left:123.00px;top:560.78px" class="cls_007"><span class="cls_007">of </span><span class="cls_030">Mathematician</span><span class="cls_007">.)</span></div>
<div style="position:absolute;left:141.00px;top:572.78px" class="cls_007"><span class="cls_007">Ruby also uses the instance variable array to track the values you save in</span></div>
<div style="position:absolute;left:123.00px;top:584.78px" class="cls_007"><span class="cls_007">an object, as shown in Listing 5-3.</span></div>
<div style="position:absolute;left:374.67px;top:636.00px" class="cls_021"><span class="cls_021">Objects and Classes</span></div>
<div style="position:absolute;left:443.00px;top:633.00px" class="cls_020"><span class="cls_020">107</span></div>
</div>
<div style="position:absolute;left:50%;margin-left:-252px;top:86528px;width:504px;height:666px;border-style:outset;overflow:hidden">
<div style="position:absolute;left:0px;top:0px">
<img src="e698b76e-46bd-11eb-8b25-0cc47a792c0a_id_e698b76e-46bd-11eb-8b25-0cc47a792c0a_files/background132.jpg" width=504 height=666></div>
<div style="position:absolute;left:120.00px;top:49.00px" class="cls_030"><span class="cls_030">> </span><span class="cls_040">euler.first_name = 'Leonhard'</span></div>
<div style="position:absolute;left:124.17px;top:59.50px" class="cls_030"><span class="cls_030">=> "Leonhard"</span></div>
<div style="position:absolute;left:120.00px;top:70.00px" class="cls_030"><span class="cls_030">> </span><span class="cls_040">euler.last_name</span></div>
<div style="position:absolute;left:199.13px;top:70.00px" class="cls_040"><span class="cls_040">= 'Euler'</span></div>
<div style="position:absolute;left:124.17px;top:80.49px" class="cls_030"><span class="cls_030">=> "Euler"</span></div>
<div style="position:absolute;left:120.00px;top:90.99px" class="cls_030"><span class="cls_030">> </span><span class="cls_040">euler</span></div>
<div style="position:absolute;left:108.00px;top:101.49px" class="cls_046"><span class="cls_046">u</span><span class="cls_030">  => #&lt;Mathematician:0x007fbd738608c0 @first_name="Leonhard", @last_name="Euler"></span></div>
<div style="position:absolute;left:120.00px;top:123.99px" class="cls_038"><span class="cls_038">Listing 5-3: Inspecting instance variables in IRB</span></div>
<div style="position:absolute;left:138.00px;top:144.50px" class="cls_007"><span class="cls_007">As you can see, in IRB Ruby also displays the instance variable array for</span></div>
<div style="position:absolute;left:120.00px;top:156.50px" class="cls_030"><span class="cls_030">euler</span><span class="cls_007"> at </span><span class="cls_050">u</span><span class="cls_007">. Ruby needs to save this array of values in each object because</span></div>
<div style="position:absolute;left:120.00px;top:168.50px" class="cls_007"><span class="cls_007">every object instance can have different values for the same instance vari-</span></div>
<div style="position:absolute;left:120.00px;top:180.50px" class="cls_007"><span class="cls_007">ables, as shown at </span><span class="cls_050">u</span><span class="cls_007"> in Listing 5-4.</span></div>
<div style="position:absolute;left:120.00px;top:204.50px" class="cls_030"><span class="cls_030">> </span><span class="cls_040">euclid = Mathematician.new</span></div>
<div style="position:absolute;left:120.00px;top:215.00px" class="cls_030"><span class="cls_030">> </span><span class="cls_040">euclid.first_name = 'Euclid'</span></div>
<div style="position:absolute;left:120.00px;top:225.49px" class="cls_030"><span class="cls_030">> </span><span class="cls_040">euclid</span></div>
<div style="position:absolute;left:108.00px;top:235.99px" class="cls_046"><span class="cls_046">u</span><span class="cls_030">  => #&lt;Mathematician:0x007fabdb850690 @first_name="Euclid"></span></div>
<div style="position:absolute;left:120.00px;top:258.49px" class="cls_038"><span class="cls_038">Listing 5-4: A different instance of the </span><span class="cls_014">Mathematician</span><span class="cls_038"> class</span></div>
<div style="position:absolute;left:120.00px;top:294.00px" class="cls_055"><span class="cls_055">Visualizing Two Instances of One Class</span></div>
<div style="position:absolute;left:120.00px;top:312.00px" class="cls_007"><span class="cls_007">Let’s look at Ruby’s C structures in a bit more detail. When you run the</span></div>
<div style="position:absolute;left:120.00px;top:324.00px" class="cls_007"><span class="cls_007">Ruby code shown in Figure 5-2, Ruby creates one </span><span class="cls_030">RClass</span><span class="cls_007"> structure and two</span></div>
<div style="position:absolute;left:120.00px;top:336.00px" class="cls_030"><span class="cls_030">RObject</span><span class="cls_007"> structures.</span></div>
<div style="position:absolute;left:122.82px;top:360.68px" class="cls_033"><span class="cls_033">class Mathematician</span></div>
<div style="position:absolute;left:290.77px;top:368.90px" class="cls_042"><span class="cls_042">RClass</span></div>
<div style="position:absolute;left:131.82px;top:372.21px" class="cls_033"><span class="cls_033">attr_accessor :first_name</span></div>
<div style="position:absolute;left:299.14px;top:380.19px" class="cls_014"><span class="cls_014">Mathematician</span></div>
<div style="position:absolute;left:131.82px;top:382.93px" class="cls_033"><span class="cls_033">attr_accessor :last_name</span></div>
<div style="position:absolute;left:122.82px;top:392.83px" class="cls_033"><span class="cls_033">end</span></div>
<div style="position:absolute;left:122.82px;top:424.97px" class="cls_033"><span class="cls_033">euler = Mathematician.new</span></div>
<div style="position:absolute;left:290.77px;top:426.88px" class="cls_042"><span class="cls_042">RObject</span></div>
<div style="position:absolute;left:122.82px;top:435.68px" class="cls_033"><span class="cls_033">euler.first_name = 'Leonhard'</span></div>
<div style="position:absolute;left:315.14px;top:438.17px" class="cls_014"><span class="cls_014">euler</span></div>
<div style="position:absolute;left:122.82px;top:446.39px" class="cls_033"><span class="cls_033">euler.last_name = 'Euler'</span></div>
<div style="position:absolute;left:290.77px;top:475.42px" class="cls_042"><span class="cls_042">RObject</span></div>
<div style="position:absolute;left:122.82px;top:478.53px" class="cls_033"><span class="cls_033">euclid = Mathematician.new</span></div>
<div style="position:absolute;left:313.14px;top:486.71px" class="cls_014"><span class="cls_014">euclid</span></div>
<div style="position:absolute;left:122.82px;top:489.25px" class="cls_033"><span class="cls_033">euclid.first_name = 'Euclid'</span></div>
<div style="position:absolute;left:120.00px;top:524.84px" class="cls_038"><span class="cls_038">Figure 5-2: Creating two instances of one class</span></div>
<div style="position:absolute;left:138.00px;top:547.34px" class="cls_007"><span class="cls_007">I’ll discuss how Ruby implements classes with the </span><span class="cls_030">RClass</span><span class="cls_007"> structure in the</span></div>
<div style="position:absolute;left:120.00px;top:559.34px" class="cls_007"><span class="cls_007">next section. For now, let’s look at Figure 5-3, which shows how Ruby saves</span></div>
<div style="position:absolute;left:120.00px;top:571.34px" class="cls_007"><span class="cls_007">the </span><span class="cls_030">Mathematician</span><span class="cls_007"> information in the two </span><span class="cls_030">RObject</span><span class="cls_007"> structures.</span></div>
<div style="position:absolute;left:48.00px;top:633.00px" class="cls_020"><span class="cls_020">108</span></div>
<div style="position:absolute;left:74.27px;top:636.00px" class="cls_021"><span class="cls_021">Chapter 5</span></div>
</div>
<div style="position:absolute;left:50%;margin-left:-252px;top:87204px;width:504px;height:666px;border-style:outset;overflow:hidden">
<div style="position:absolute;left:0px;top:0px">
<img src="e698b76e-46bd-11eb-8b25-0cc47a792c0a_id_e698b76e-46bd-11eb-8b25-0cc47a792c0a_files/background133.jpg" width=504 height=666></div>
<div style="position:absolute;left:247.07px;top:50.16px" class="cls_042"><span class="cls_042">RClass</span></div>
<div style="position:absolute;left:262.04px;top:64.22px" class="cls_014"><span class="cls_014">Mathematician</span></div>
<div style="position:absolute;left:129.83px;top:114.02px" class="cls_042"><span class="cls_042">RObject</span></div>
<div style="position:absolute;left:374.33px;top:114.02px" class="cls_042"><span class="cls_042">RObject</span></div>
<div style="position:absolute;left:156.25px;top:127.33px" class="cls_014"><span class="cls_014">klass</span></div>
<div style="position:absolute;left:400.75px;top:127.33px" class="cls_014"><span class="cls_014">klass</span></div>
<div style="position:absolute;left:150.25px;top:150.81px" class="cls_014"><span class="cls_014">numiv: 2</span></div>
<div style="position:absolute;left:394.75px;top:150.81px" class="cls_014"><span class="cls_014">numiv: 1</span></div>
<div style="position:absolute;left:156.19px;top:174.28px" class="cls_014"><span class="cls_014">ivptr</span></div>
<div style="position:absolute;left:400.69px;top:174.28px" class="cls_014"><span class="cls_014">ivptr</span></div>
<div style="position:absolute;left:150.14px;top:214.28px" class="cls_014"><span class="cls_014">Leonhard</span></div>
<div style="position:absolute;left:398.62px;top:214.28px" class="cls_014"><span class="cls_014">Euclid</span></div>
<div style="position:absolute;left:156.14px;top:231.60px" class="cls_014"><span class="cls_014">Euler</span></div>
<div style="position:absolute;left:123.00px;top:254.10px" class="cls_038"><span class="cls_038">Figure 5-3: Visualizing two instances of one class</span></div>
<div style="position:absolute;left:141.00px;top:276.60px" class="cls_007"><span class="cls_007">As you can see, each </span><span class="cls_030">klass</span><span class="cls_007"> value points to the </span><span class="cls_030">Mathematician</span><span class="cls_007"> </span><span class="cls_030">RClass</span><span class="cls_007"> struc-</span></div>
<div style="position:absolute;left:123.00px;top:288.60px" class="cls_007"><span class="cls_007">ture, and each </span><span class="cls_030">RObject</span><span class="cls_007"> structure has a separate array of instance variables.</span></div>
<div style="position:absolute;left:123.00px;top:300.60px" class="cls_007"><span class="cls_007">Both arrays contain </span><span class="cls_030">VALUE</span><span class="cls_007"> pointers—the same pointer that Ruby uses to</span></div>
<div style="position:absolute;left:123.00px;top:312.60px" class="cls_007"><span class="cls_007">refer to the </span><span class="cls_030">RObject</span><span class="cls_007"> structure. (Notice that one of the objects contains two</span></div>
<div style="position:absolute;left:123.00px;top:324.60px" class="cls_007"><span class="cls_007">instance variables, while the other contains only one.)</span></div>
<div style="position:absolute;left:123.00px;top:349.60px" class="cls_055"><span class="cls_055">Generic Objects</span></div>
<div style="position:absolute;left:123.00px;top:367.60px" class="cls_007"><span class="cls_007">Now you know how Ruby saves custom classes, like the </span><span class="cls_030">Mathematician</span><span class="cls_007"> class, in</span></div>
<div style="position:absolute;left:123.00px;top:379.60px" class="cls_030"><span class="cls_030">RObject</span><span class="cls_007"> structures. But remember that every Ruby value—including basic data</span></div>
<div style="position:absolute;left:123.00px;top:391.60px" class="cls_007"><span class="cls_007">types such as integers, strings, and symbols—is an object. The Ruby source</span></div>
<div style="position:absolute;left:123.00px;top:403.60px" class="cls_007"><span class="cls_007">code internally refers to these built-in types as “generic” types. How does</span></div>
<div style="position:absolute;left:123.00px;top:415.60px" class="cls_007"><span class="cls_007">Ruby store these generic objects? Do they also use the </span><span class="cls_030">RObject</span><span class="cls_007"> structure?</span></div>
<div style="position:absolute;left:141.00px;top:427.60px" class="cls_007"><span class="cls_007">The answer is no. Internally, Ruby uses a different C structure, not</span></div>
<div style="position:absolute;left:123.00px;top:439.60px" class="cls_030"><span class="cls_030">RObject</span><span class="cls_007">, to save values for each of its generic data types. For example, Ruby</span></div>
<div style="position:absolute;left:123.00px;top:451.60px" class="cls_007"><span class="cls_007">saves string values in </span><span class="cls_030">RString</span><span class="cls_007"> structures, arrays in </span><span class="cls_030">RArray</span><span class="cls_007"> structures, regular</span></div>
<div style="position:absolute;left:123.00px;top:463.60px" class="cls_007"><span class="cls_007">expressions in </span><span class="cls_030">RRegexp</span><span class="cls_007"> structures, and so on. Ruby uses </span><span class="cls_030">RObject</span><span class="cls_007"> only to save</span></div>
<div style="position:absolute;left:123.00px;top:475.60px" class="cls_007"><span class="cls_007">instances of custom object classes that you create and a few custom object</span></div>
<div style="position:absolute;left:123.00px;top:487.60px" class="cls_007"><span class="cls_007">classes that Ruby creates internally. However, all of these different struc-</span></div>
<div style="position:absolute;left:123.00px;top:499.60px" class="cls_007"><span class="cls_007">tures share the same </span><span class="cls_030">RBasic</span><span class="cls_007"> information that we saw in </span><span class="cls_030">RObject</span><span class="cls_007">, as shown in</span></div>
<div style="position:absolute;left:123.00px;top:511.60px" class="cls_007"><span class="cls_007">Figure 5-4.</span></div>
<div style="position:absolute;left:141.00px;top:523.60px" class="cls_007"><span class="cls_007">Since the </span><span class="cls_030">RBasic</span><span class="cls_007"> structure contains the class pointer, each of these</span></div>
<div style="position:absolute;left:123.00px;top:535.60px" class="cls_007"><span class="cls_007">generic data types is also an object. Each is an instance of some Ruby class,</span></div>
<div style="position:absolute;left:123.00px;top:547.60px" class="cls_007"><span class="cls_007">as indicated by the class pointer saved inside </span><span class="cls_030">RBasic</span><span class="cls_007">.</span></div>
<div style="position:absolute;left:374.39px;top:636.00px" class="cls_021"><span class="cls_021">Objects and Classes</span></div>
<div style="position:absolute;left:442.71px;top:633.00px" class="cls_020"><span class="cls_020">109</span></div>
</div>
<div style="position:absolute;left:50%;margin-left:-252px;top:87880px;width:504px;height:666px;border-style:outset;overflow:hidden">
<div style="position:absolute;left:0px;top:0px">
<img src="e698b76e-46bd-11eb-8b25-0cc47a792c0a_id_e698b76e-46bd-11eb-8b25-0cc47a792c0a_files/background134.jpg" width=504 height=666></div>
<div style="position:absolute;left:151.94px;top:45.81px" class="cls_033"><span class="cls_033">VALUE</span></div>
<div style="position:absolute;left:257.34px;top:45.81px" class="cls_033"><span class="cls_033">VALUE</span></div>
<div style="position:absolute;left:362.56px;top:45.81px" class="cls_033"><span class="cls_033">VALUE</span></div>
<div style="position:absolute;left:125.84px;top:90.92px" class="cls_020"><span class="cls_020">RString</span></div>
<div style="position:absolute;left:231.06px;top:90.92px" class="cls_020"><span class="cls_020">RArray</span></div>
<div style="position:absolute;left:336.28px;top:90.92px" class="cls_020"><span class="cls_020">RRegexp</span></div>
<div style="position:absolute;left:133.53px;top:110.25px" class="cls_020"><span class="cls_020">RBasic</span></div>
<div style="position:absolute;left:238.75px;top:110.25px" class="cls_020"><span class="cls_020">RBasic</span></div>
<div style="position:absolute;left:343.97px;top:110.25px" class="cls_020"><span class="cls_020">RBasic</span></div>
<div style="position:absolute;left:153.30px;top:127.26px" class="cls_014"><span class="cls_014">flags</span></div>
<div style="position:absolute;left:258.59px;top:127.26px" class="cls_014"><span class="cls_014">flags</span></div>
<div style="position:absolute;left:363.81px;top:127.26px" class="cls_014"><span class="cls_014">flags</span></div>
<div style="position:absolute;left:153.30px;top:149.87px" class="cls_014"><span class="cls_014">klass</span></div>
<div style="position:absolute;left:258.59px;top:149.87px" class="cls_014"><span class="cls_014">klass</span></div>
<div style="position:absolute;left:363.81px;top:149.87px" class="cls_014"><span class="cls_014">klass</span></div>
<div style="position:absolute;left:138.92px;top:183.25px" class="cls_054"><span class="cls_054">String info...</span></div>
<div style="position:absolute;left:247.38px;top:183.22px" class="cls_054"><span class="cls_054">Array info...</span></div>
<div style="position:absolute;left:351.74px;top:183.22px" class="cls_054"><span class="cls_054">Regex info...</span></div>
<div style="position:absolute;left:120.00px;top:212.89px" class="cls_038"><span class="cls_038">Figure 5-4: Different Ruby object structures all use the </span><span class="cls_014">RBasic</span><span class="cls_038"> structure.</span></div>
<div style="position:absolute;left:120.00px;top:248.39px" class="cls_055"><span class="cls_055">Simple Ruby Values Don’t Require</span></div>
<div style="position:absolute;left:120.00px;top:263.39px" class="cls_055"><span class="cls_055">a Structure at All</span></div>
<div style="position:absolute;left:120.00px;top:281.39px" class="cls_007"><span class="cls_007">As a performance optimization,</span></div>
<div style="position:absolute;left:335.54px;top:290.32px" class="cls_102"><span class="cls_102">Integer value</span></div>
<div style="position:absolute;left:421.03px;top:290.32px" class="cls_102"><span class="cls_102">Flags</span></div>
<div style="position:absolute;left:120.00px;top:293.39px" class="cls_007"><span class="cls_007">Ruby saves small integers, symbols,</span></div>
<div style="position:absolute;left:120.00px;top:305.39px" class="cls_007"><span class="cls_007">and a few other simple values with-</span></div>
<div style="position:absolute;left:364.55px;top:311.53px" class="cls_104"><span class="cls_104">VALUE</span></div>
<div style="position:absolute;left:120.00px;top:317.39px" class="cls_007"><span class="cls_007">out any structure at all, placing</span></div>
<div style="position:absolute;left:120.00px;top:329.39px" class="cls_007"><span class="cls_007">them right inside the </span><span class="cls_030">VALUE</span><span class="cls_007"> pointer,</span></div>
<div style="position:absolute;left:302.47px;top:332.29px" class="cls_038"><span class="cls_038">Figure 5-5: Ruby saves integers in the</span></div>
<div style="position:absolute;left:120.00px;top:341.39px" class="cls_007"><span class="cls_007">as shown in Figure 5-5.</span></div>
<div style="position:absolute;left:302.47px;top:342.79px" class="cls_014"><span class="cls_014">VALUE</span><span class="cls_038"> pointer.</span></div>
<div style="position:absolute;left:138.00px;top:353.39px" class="cls_007"><span class="cls_007">These </span><span class="cls_030">VALUE</span><span class="cls_007">s are not pointers at</span></div>
<div style="position:absolute;left:120.00px;top:365.39px" class="cls_007"><span class="cls_007">all; they’re values themselves. For</span></div>
<div style="position:absolute;left:407.69px;top:374.58px" class="cls_103"><span class="cls_103">FIXNUM_FLAG</span></div>
<div style="position:absolute;left:120.00px;top:377.39px" class="cls_007"><span class="cls_007">these simple data types, there is no</span></div>
<div style="position:absolute;left:120.00px;top:389.39px" class="cls_007"><span class="cls_007">class pointer. Instead, Ruby remem-</span></div>
<div style="position:absolute;left:120.00px;top:401.39px" class="cls_007"><span class="cls_007">bers the class using a series of bit</span></div>
<div style="position:absolute;left:335.54px;top:402.90px" class="cls_102"><span class="cls_102">Integer value</span></div>
<div style="position:absolute;left:428.28px;top:402.90px" class="cls_103"><span class="cls_103">1</span></div>
<div style="position:absolute;left:120.00px;top:413.39px" class="cls_007"><span class="cls_007">flags saved in the first few bits of the</span></div>
<div style="position:absolute;left:364.55px;top:424.12px" class="cls_103"><span class="cls_103">VALUE</span></div>
<div style="position:absolute;left:120.00px;top:425.39px" class="cls_030"><span class="cls_030">VALUE</span><span class="cls_007">. For example, all small integers</span></div>
<div style="position:absolute;left:120.00px;top:437.39px" class="cls_007"><span class="cls_007">have the </span><span class="cls_030">FIXNUM_FLAG</span><span class="cls_007"> bit set, as shown</span></div>
<div style="position:absolute;left:302.47px;top:446.15px" class="cls_038"><span class="cls_038">Figure 5-6: </span><span class="cls_014">FIXNUM_FLAG</span><span class="cls_038"> indicates this is</span></div>
<div style="position:absolute;left:120.00px;top:449.39px" class="cls_007"><span class="cls_007">in Figure 5-6.</span></div>
<div style="position:absolute;left:302.46px;top:456.65px" class="cls_038"><span class="cls_038">an instance of the </span><span class="cls_014">Fixnum</span><span class="cls_038"> class.</span></div>
<div style="position:absolute;left:138.00px;top:461.39px" class="cls_007"><span class="cls_007">Whenever the </span><span class="cls_030">FIXNUM_FLAG</span><span class="cls_007"> is set,</span></div>
<div style="position:absolute;left:120.00px;top:473.39px" class="cls_007"><span class="cls_007">Ruby knows that this </span><span class="cls_030">VALUE</span><span class="cls_007"> is really</span></div>
<div style="position:absolute;left:120.00px;top:485.39px" class="cls_007"><span class="cls_007">a small integer, an instance of the</span></div>
<div style="position:absolute;left:120.00px;top:497.39px" class="cls_030"><span class="cls_030">Fixnum</span><span class="cls_007"> class, and not a pointer to a value structure. (A similar bit flag indi-</span></div>
<div style="position:absolute;left:120.00px;top:509.39px" class="cls_007"><span class="cls_007">cates whether the </span><span class="cls_030">VALUE</span><span class="cls_007"> is a symbol, and values such as </span><span class="cls_030">nil</span><span class="cls_007">, </span><span class="cls_030">true</span><span class="cls_007">, and </span><span class="cls_030">false</span></div>
<div style="position:absolute;left:120.00px;top:521.39px" class="cls_007"><span class="cls_007">also have their own flags.)</span></div>
<div style="position:absolute;left:138.00px;top:533.39px" class="cls_007"><span class="cls_007">It’s easy to see that integers, strings, and other generic values are all</span></div>
<div style="position:absolute;left:120.00px;top:545.39px" class="cls_007"><span class="cls_007">objects by using IRB, as you can see in Listing 5-5.</span></div>
<div style="position:absolute;left:48.00px;top:633.00px" class="cls_020"><span class="cls_020">110</span></div>
<div style="position:absolute;left:73.40px;top:636.00px" class="cls_021"><span class="cls_021">Chapter 5</span></div>
</div>
<div style="position:absolute;left:50%;margin-left:-252px;top:88556px;width:504px;height:666px;border-style:outset;overflow:hidden">
<div style="position:absolute;left:0px;top:0px">
<img src="e698b76e-46bd-11eb-8b25-0cc47a792c0a_id_e698b76e-46bd-11eb-8b25-0cc47a792c0a_files/background135.jpg" width=504 height=666></div>
<div style="position:absolute;left:123.00px;top:49.00px" class="cls_030"><span class="cls_030">$ </span><span class="cls_040">irb</span></div>
<div style="position:absolute;left:123.00px;top:59.50px" class="cls_030"><span class="cls_030">> "string".class</span></div>
<div style="position:absolute;left:127.25px;top:70.00px" class="cls_030"><span class="cls_030">=> String</span></div>
<div style="position:absolute;left:123.00px;top:80.49px" class="cls_030"><span class="cls_030">> </span><span class="cls_040">1.class</span></div>
<div style="position:absolute;left:127.25px;top:90.99px" class="cls_030"><span class="cls_030">=> Fixnum</span></div>
<div style="position:absolute;left:123.00px;top:101.49px" class="cls_030"><span class="cls_030">> </span><span class="cls_040">:symbol.class</span></div>
<div style="position:absolute;left:127.25px;top:111.99px" class="cls_030"><span class="cls_030">=> Symbol</span></div>
<div style="position:absolute;left:123.00px;top:134.48px" class="cls_038"><span class="cls_038">Listing 5-5: Inspecting classes for some generic values</span></div>
<div style="position:absolute;left:141.00px;top:157.00px" class="cls_007"><span class="cls_007">Here, we see that Ruby saves a class pointer or the equivalent bit flag for</span></div>
<div style="position:absolute;left:123.00px;top:169.00px" class="cls_007"><span class="cls_007">all values by calling the </span><span class="cls_030">class</span><span class="cls_007"> method on each. In turn, the </span><span class="cls_030">class</span><span class="cls_007"> method</span></div>
<div style="position:absolute;left:123.00px;top:181.00px" class="cls_007"><span class="cls_007">returns the class pointer, or at least the name of the class that each </span><span class="cls_030">klass</span></div>
<div style="position:absolute;left:123.00px;top:193.00px" class="cls_007"><span class="cls_007">pointer refers to.</span></div>
<div style="position:absolute;left:123.00px;top:218.00px" class="cls_055"><span class="cls_055">Do Generic Objects Have Instance Variables?</span></div>
<div style="position:absolute;left:123.00px;top:236.00px" class="cls_007"><span class="cls_007">Let’s go back to our definition of a Ruby object:</span></div>
<div style="position:absolute;left:159.00px;top:255.00px" class="cls_033"><span class="cls_033">Every Ruby object is the combination of a class pointer and an</span></div>
<div style="position:absolute;left:159.00px;top:267.00px" class="cls_033"><span class="cls_033">array of instance variables.</span></div>
<div style="position:absolute;left:141.00px;top:284.00px" class="cls_007"><span class="cls_007">What about instance variables for generic objects? Do integers, strings,</span></div>
<div style="position:absolute;left:123.00px;top:296.00px" class="cls_007"><span class="cls_007">and other generic data values have instance variables? That would seem</span></div>
<div style="position:absolute;left:123.00px;top:308.00px" class="cls_007"><span class="cls_007">odd, but if integers and strings are objects, this must be true! And if it is true,</span></div>
<div style="position:absolute;left:123.00px;top:320.00px" class="cls_007"><span class="cls_007">where does Ruby save these values if it doesn’t use the </span><span class="cls_030">RObject</span><span class="cls_007"> structure?</span></div>
<div style="position:absolute;left:141.00px;top:332.00px" class="cls_007"><span class="cls_007">Using the </span><span class="cls_030">instance_variables</span><span class="cls_007"> method, shown in Listing 5-6, you can see</span></div>
<div style="position:absolute;left:123.00px;top:344.00px" class="cls_007"><span class="cls_007">that each of these basic values can also contain an array of instance variables,</span></div>
<div style="position:absolute;left:123.00px;top:356.00px" class="cls_007"><span class="cls_007">strange as that may seem.</span></div>
<div style="position:absolute;left:123.00px;top:380.00px" class="cls_030"><span class="cls_030">$ </span><span class="cls_040">irb</span></div>
<div style="position:absolute;left:123.00px;top:390.50px" class="cls_030"><span class="cls_030">> </span><span class="cls_040">str = "some string value"</span></div>
<div style="position:absolute;left:127.25px;top:400.99px" class="cls_030"><span class="cls_030">=> "some string value"</span></div>
<div style="position:absolute;left:123.00px;top:411.49px" class="cls_030"><span class="cls_030">> </span><span class="cls_040">str.instance_variables</span></div>
<div style="position:absolute;left:127.25px;top:421.99px" class="cls_030"><span class="cls_030">=> []</span></div>
<div style="position:absolute;left:123.00px;top:432.49px" class="cls_030"><span class="cls_030">> </span><span class="cls_040">str.instance_variable_set("@val1", "value one")</span></div>
<div style="position:absolute;left:127.25px;top:442.98px" class="cls_030"><span class="cls_030">=> "value one"</span></div>
<div style="position:absolute;left:123.00px;top:453.48px" class="cls_030"><span class="cls_030">> </span><span class="cls_040">str.instance_variables</span></div>
<div style="position:absolute;left:127.25px;top:463.98px" class="cls_030"><span class="cls_030">=> [:@val1]</span></div>
<div style="position:absolute;left:123.00px;top:474.48px" class="cls_030"><span class="cls_030">> </span><span class="cls_040">str.instance_variable_set("@val2", "value two")</span></div>
<div style="position:absolute;left:127.25px;top:484.98px" class="cls_030"><span class="cls_030">=> "value two"</span></div>
<div style="position:absolute;left:123.00px;top:495.47px" class="cls_030"><span class="cls_030">> </span><span class="cls_040">str.instance_variables</span></div>
<div style="position:absolute;left:127.25px;top:505.97px" class="cls_030"><span class="cls_030">=> [:@val1, :@val2]</span></div>
<div style="position:absolute;left:123.00px;top:528.47px" class="cls_038"><span class="cls_038">Listing 5-6: Saving instance variables in a Ruby string object</span></div>
<div style="position:absolute;left:141.00px;top:551.00px" class="cls_007"><span class="cls_007">Repeat this exercise using symbols, arrays, or any Ruby value, and you’ll</span></div>
<div style="position:absolute;left:123.00px;top:563.00px" class="cls_007"><span class="cls_007">find that every Ruby value is an object and every object contains a class</span></div>
<div style="position:absolute;left:123.00px;top:575.00px" class="cls_007"><span class="cls_007">pointer and an array of instance variables.</span></div>
<div style="position:absolute;left:375.69px;top:636.00px" class="cls_021"><span class="cls_021">Objects and Classes</span></div>
<div style="position:absolute;left:444.02px;top:633.00px" class="cls_020"><span class="cls_020">111</span></div>
</div>
<div style="position:absolute;left:50%;margin-left:-252px;top:89232px;width:504px;height:666px;border-style:outset;overflow:hidden">
<div style="position:absolute;left:0px;top:0px">
<img src="e698b76e-46bd-11eb-8b25-0cc47a792c0a_id_e698b76e-46bd-11eb-8b25-0cc47a792c0a_files/background136.jpg" width=504 height=666></div>
<div style="position:absolute;left:122.66px;top:61.31px" class="cls_020"><span class="cls_020">Reading the RBasic and RObject C Structure Definitions</span></div>
<div style="position:absolute;left:120.50px;top:79.81px" class="cls_039"><span class="cls_039">Listing 5-7 shows the definitions of the </span><span class="cls_009">RBasic</span><span class="cls_039"> and </span><span class="cls_009">RObject</span><span class="cls_039"> C structures. (You can find</span></div>
<div style="position:absolute;left:120.50px;top:91.81px" class="cls_039"><span class="cls_039">this code in the </span><span class="cls_044">include/ruby/ruby.h</span><span class="cls_039"> header file.)</span></div>
<div style="position:absolute;left:120.50px;top:114.31px" class="cls_009"><span class="cls_009">struct RBasic {</span></div>
<div style="position:absolute;left:110.00px;top:122.81px" class="cls_046"><span class="cls_046">u</span><span class="cls_009">   VALUE flags;</span></div>
<div style="position:absolute;left:110.00px;top:132.31px" class="cls_046"><span class="cls_046">v</span><span class="cls_009">   const VALUE klass;</span></div>
<div style="position:absolute;left:120.50px;top:142.82px" class="cls_009"><span class="cls_009">};</span></div>
<div style="position:absolute;left:120.50px;top:161.81px" class="cls_009"><span class="cls_009">#define ROBJECT_EMBED_LEN_MAX 3</span></div>
<div style="position:absolute;left:120.50px;top:171.32px" class="cls_009"><span class="cls_009">struct RObject {</span></div>
<div style="position:absolute;left:110.00px;top:179.81px" class="cls_046"><span class="cls_046">w</span><span class="cls_009">   struct RBasic basic;</span></div>
<div style="position:absolute;left:128.00px;top:190.32px" class="cls_009"><span class="cls_009">union {</span></div>
<div style="position:absolute;left:135.50px;top:199.82px" class="cls_009"><span class="cls_009">struct {</span></div>
<div style="position:absolute;left:110.00px;top:208.31px" class="cls_046"><span class="cls_046">x</span><span class="cls_009">       long numiv;</span></div>
<div style="position:absolute;left:110.00px;top:217.81px" class="cls_046"><span class="cls_046">y</span><span class="cls_009">       VALUE *ivptr;</span></div>
<div style="position:absolute;left:110.00px;top:227.31px" class="cls_046"><span class="cls_046">z</span><span class="cls_009">       struct st_table *iv_index_tbl;</span></div>
<div style="position:absolute;left:110.00px;top:236.81px" class="cls_046"><span class="cls_046">{</span></div>
<div style="position:absolute;left:136.33px;top:237.81px" class="cls_009"><span class="cls_009">} heap;</span></div>
<div style="position:absolute;left:110.00px;top:246.31px" class="cls_046"><span class="cls_046">|</span></div>
<div style="position:absolute;left:136.33px;top:247.31px" class="cls_009"><span class="cls_009">VALUE ary[ROBJECT_EMBED_LEN_MAX];</span></div>
<div style="position:absolute;left:128.00px;top:256.82px" class="cls_009"><span class="cls_009">} as;</span></div>
<div style="position:absolute;left:120.50px;top:266.32px" class="cls_009"><span class="cls_009">};</span></div>
<div style="position:absolute;left:120.50px;top:288.81px" class="cls_043"><span class="cls_043">Listing 5-7: The definitions of the </span><span class="cls_015">RBasic</span><span class="cls_043"> and </span><span class="cls_015">RObject</span><span class="cls_043"> C structures</span></div>
<div style="position:absolute;left:138.50px;top:311.81px" class="cls_039"><span class="cls_039">At the top, you see the definition of </span><span class="cls_009">RBasic</span><span class="cls_039">. This definition contains the two val-</span></div>
<div style="position:absolute;left:120.50px;top:323.81px" class="cls_039"><span class="cls_039">ues: </span><span class="cls_009">flags</span><span class="cls_039"> </span><span class="cls_046">u</span><span class="cls_039"> and </span><span class="cls_009">klass</span><span class="cls_039"> </span><span class="cls_046">v</span><span class="cls_039">. Below, you see the </span><span class="cls_009">RObject</span><span class="cls_039"> definition. Notice that it con-</span></div>
<div style="position:absolute;left:120.50px;top:335.81px" class="cls_039"><span class="cls_039">tains a copy of the </span><span class="cls_009">RBasic</span><span class="cls_039"> structure at </span><span class="cls_046">w</span><span class="cls_039">. Following this, the </span><span class="cls_009">union</span><span class="cls_039"> keyword contains</span></div>
<div style="position:absolute;left:120.50px;top:347.81px" class="cls_039"><span class="cls_039">a structure called </span><span class="cls_009">heap</span><span class="cls_039"> at </span><span class="cls_046">{</span><span class="cls_039">, followed by an array called </span><span class="cls_009">ary</span><span class="cls_039"> at </span><span class="cls_046">|</span><span class="cls_039">.</span></div>
<div style="position:absolute;left:138.50px;top:359.81px" class="cls_039"><span class="cls_039">The </span><span class="cls_009">heap</span><span class="cls_039"> structure at </span><span class="cls_046">{</span><span class="cls_039"> contains the following values:</span></div>
<div style="position:absolute;left:120.50px;top:377.81px" class="cls_039"><span class="cls_039">•   First, the value </span><span class="cls_009">numiv</span><span class="cls_039"> at </span><span class="cls_046">x</span><span class="cls_039"> tracks the number of instance variables contained in</span></div>
<div style="position:absolute;left:138.50px;top:389.82px" class="cls_039"><span class="cls_039">this object.</span></div>
<div style="position:absolute;left:120.50px;top:404.81px" class="cls_039"><span class="cls_039">•   Next, </span><span class="cls_009">ivptr</span><span class="cls_039"> at </span><span class="cls_046">y</span><span class="cls_039"> is a pointer to an array containing the values of this object’s</span></div>
<div style="position:absolute;left:138.50px;top:416.82px" class="cls_039"><span class="cls_039">instance variables. Notice that the names, or IDs, of the instance variables are</span></div>
<div style="position:absolute;left:138.50px;top:428.82px" class="cls_039"><span class="cls_039">not stored here; only the values are stored.</span></div>
<div style="position:absolute;left:120.49px;top:443.81px" class="cls_039"><span class="cls_039">•</span><span class="cls_009">   iv_index_tbl</span><span class="cls_039"> at </span><span class="cls_046">z</span><span class="cls_039"> points to a hash table that maps between the name, or ID,</span></div>
<div style="position:absolute;left:138.50px;top:455.81px" class="cls_039"><span class="cls_039">of each instance variable and its location in the </span><span class="cls_009">ivptr</span><span class="cls_039"> array. This value is actu-</span></div>
<div style="position:absolute;left:138.50px;top:467.81px" class="cls_039"><span class="cls_039">ally stored in the </span><span class="cls_009">RClass</span><span class="cls_039"> structure for this object’s class; this pointer is simply</span></div>
<div style="position:absolute;left:138.50px;top:479.82px" class="cls_039"><span class="cls_039">a cache, or shortcut, that Ruby uses to obtain that hash table quickly. (The</span></div>
<div style="position:absolute;left:138.50px;top:491.81px" class="cls_009"><span class="cls_009">st_table</span><span class="cls_039"> type refers to Ruby’s implementation of hash tables, which I’ll discuss</span></div>
<div style="position:absolute;left:138.50px;top:503.82px" class="cls_039"><span class="cls_039">in Chapter 7.)</span></div>
<div style="position:absolute;left:138.50px;top:521.81px" class="cls_039"><span class="cls_039">The last member of the </span><span class="cls_009">RObject</span><span class="cls_039"> structure, </span><span class="cls_009">ary</span><span class="cls_039"> at </span><span class="cls_046">|</span><span class="cls_039">, occupies the same memory</span></div>
<div style="position:absolute;left:120.50px;top:533.81px" class="cls_039"><span class="cls_039">space as all previous values because of the </span><span class="cls_009">union</span><span class="cls_039"> keyword at the top. Using this </span><span class="cls_009">ary</span></div>
<div style="position:absolute;left:120.50px;top:545.81px" class="cls_039"><span class="cls_039">value, Ruby can save all of the instance variables right inside the </span><span class="cls_009">RObject</span><span class="cls_039"> structure—</span></div>
<div style="position:absolute;left:120.50px;top:557.81px" class="cls_039"><span class="cls_039">if they’ll fit. This eliminates the need to call </span><span class="cls_009">malloc</span><span class="cls_039"> to allocate extra memory to hold</span></div>
<div style="position:absolute;left:120.50px;top:569.82px" class="cls_039"><span class="cls_039">the instance variable value array. (Ruby also uses this sort of optimization for the</span></div>
<div style="position:absolute;left:120.50px;top:581.81px" class="cls_009"><span class="cls_009">RString</span><span class="cls_039">, </span><span class="cls_009">RArray</span><span class="cls_039">, </span><span class="cls_009">RStruct</span><span class="cls_039">, and </span><span class="cls_009">RBignum</span><span class="cls_039"> structures.)</span></div>
<div style="position:absolute;left:48.00px;top:633.00px" class="cls_020"><span class="cls_020">112</span></div>
<div style="position:absolute;left:73.25px;top:636.00px" class="cls_021"><span class="cls_021">Chapter 5</span></div>
</div>
<div style="position:absolute;left:50%;margin-left:-252px;top:89908px;width:504px;height:666px;border-style:outset;overflow:hidden">
<div style="position:absolute;left:0px;top:0px">
<img src="e698b76e-46bd-11eb-8b25-0cc47a792c0a_id_e698b76e-46bd-11eb-8b25-0cc47a792c0a_files/background137.jpg" width=504 height=666></div>
<div style="position:absolute;left:123.00px;top:42.55px" class="cls_055"><span class="cls_055">Where Does Ruby Save Instance Variables for Generic Objects?</span></div>
<div style="position:absolute;left:123.00px;top:60.55px" class="cls_007"><span class="cls_007">Internally, Ruby uses a bit of a hack to save instance variables for generic</span></div>
<div style="position:absolute;left:123.00px;top:72.55px" class="cls_007"><span class="cls_007">objects—that is, for objects that don’t use an </span><span class="cls_030">RObject</span><span class="cls_007"> structure. When you</span></div>
<div style="position:absolute;left:123.00px;top:84.55px" class="cls_007"><span class="cls_007">save an instance variable in a generic object, Ruby saves it in a special hash</span></div>
<div style="position:absolute;left:123.00px;top:96.55px" class="cls_007"><span class="cls_007">called </span><span class="cls_030">generic_iv_tbl</span><span class="cls_007">. This hash maintains a map between generic objects</span></div>
<div style="position:absolute;left:123.00px;top:108.55px" class="cls_007"><span class="cls_007">and pointers to other hashes that contain each object’s instance variables.</span></div>
<div style="position:absolute;left:123.00px;top:120.55px" class="cls_007"><span class="cls_007">Figure 5-7 shows how this would look for the </span><span class="cls_030">str</span><span class="cls_007"> string example in Listing 5-6.</span></div>
<div style="position:absolute;left:141.88px;top:146.69px" class="cls_106"><span class="cls_106">generic_iv_tbl</span></div>
<div style="position:absolute;left:159.53px;top:170.54px" class="cls_105"><span class="cls_105">str => hash</span></div>
<div style="position:absolute;left:222.65px;top:170.54px" class="cls_105"><span class="cls_105">etc...</span></div>
<div style="position:absolute;left:276.37px;top:170.54px" class="cls_105"><span class="cls_105">etc...</span></div>
<div style="position:absolute;left:217.31px;top:213.00px" class="cls_105"><span class="cls_105">@val1 => "value one"</span></div>
<div style="position:absolute;left:304.03px;top:213.00px" class="cls_105"><span class="cls_105">@val2 => "value two"</span></div>
<div style="position:absolute;left:128.23px;top:240.25px" class="cls_106"><span class="cls_106">RString</span></div>
<div style="position:absolute;left:128.85px;top:256.29px" class="cls_105"><span class="cls_105">"some string value"</span></div>
<div style="position:absolute;left:123.00px;top:284.05px" class="cls_038"><span class="cls_038">Figure 5-7: </span><span class="cls_014">generic_iv_tbl</span><span class="cls_038"> stores instance variables for generic objects.</span></div>
<div style="position:absolute;left:123.00px;top:328.55px" class="cls_031"><span class="cls_031">Experiment 5-1: How Long Does It Take to Save a</span></div>
<div style="position:absolute;left:123.00px;top:343.55px" class="cls_031"><span class="cls_031">New Instance Variable?</span></div>
<div style="position:absolute;left:123.00px;top:363.55px" class="cls_007"><span class="cls_007">To learn more about how Ruby saves instance variables internally, let’s mea-</span></div>
<div style="position:absolute;left:123.00px;top:375.55px" class="cls_007"><span class="cls_007">sure how long it takes Ruby to save one in an object. To do this, I’ll create a</span></div>
<div style="position:absolute;left:123.00px;top:387.55px" class="cls_007"><span class="cls_007">large number of test objects, as shown in Listing 5-8.</span></div>
<div style="position:absolute;left:123.00px;top:411.55px" class="cls_030"><span class="cls_030">ITERATIONS = 100000</span></div>
<div style="position:absolute;left:111.00px;top:422.05px" class="cls_046"><span class="cls_046">u</span><span class="cls_030"> GC.disable</span></div>
<div style="position:absolute;left:111.00px;top:432.55px" class="cls_046"><span class="cls_046">v</span><span class="cls_030"> obj = ITERATIONS.times.map { Class.new.new }</span></div>
<div style="position:absolute;left:123.00px;top:455.05px" class="cls_038"><span class="cls_038">Listing 5-8: Creating test objects using </span><span class="cls_014">Class.new</span></div>
<div style="position:absolute;left:141.00px;top:477.55px" class="cls_007"><span class="cls_007">Here, I’m using </span><span class="cls_030">Class.new</span><span class="cls_007"> at </span><span class="cls_050">v</span><span class="cls_007"> to create a unique class for each new</span></div>
<div style="position:absolute;left:123.00px;top:489.55px" class="cls_007"><span class="cls_007">object in order to make sure they’re all independent. I’ve also disabled gar-</span></div>
<div style="position:absolute;left:123.00px;top:501.55px" class="cls_007"><span class="cls_007">bage collection at </span><span class="cls_050">u</span><span class="cls_007"> to avoid skewing the results with GC operations. Then,</span></div>
<div style="position:absolute;left:123.00px;top:513.55px" class="cls_007"><span class="cls_007">in Listing 5-9, I add instance variables to each.</span></div>
<div style="position:absolute;left:123.00px;top:537.55px" class="cls_030"><span class="cls_030">Benchmark.bm do |bench|</span></div>
<div style="position:absolute;left:131.50px;top:548.05px" class="cls_030"><span class="cls_030">20.times do |count|</span></div>
<div style="position:absolute;left:140.00px;top:558.55px" class="cls_030"><span class="cls_030">bench.report("adding instance variable number #{count+1}") do</span></div>
<div style="position:absolute;left:148.50px;top:569.05px" class="cls_030"><span class="cls_030">ITERATIONS.times do |n|</span></div>
<div style="position:absolute;left:157.00px;top:579.54px" class="cls_030"><span class="cls_030">obj[n].instance_variable_set("@var#{count}", "value")</span></div>
<div style="position:absolute;left:375.36px;top:636.00px" class="cls_021"><span class="cls_021">Objects and Classes</span></div>
<div style="position:absolute;left:443.69px;top:633.00px" class="cls_020"><span class="cls_020">113</span></div>
</div>
<div style="position:absolute;left:50%;margin-left:-252px;top:90584px;width:504px;height:666px;border-style:outset;overflow:hidden">
<div style="position:absolute;left:0px;top:0px">
<img src="e698b76e-46bd-11eb-8b25-0cc47a792c0a_id_e698b76e-46bd-11eb-8b25-0cc47a792c0a_files/background138.jpg" width=504 height=666></div>
<div style="position:absolute;left:145.50px;top:42.82px" class="cls_030"><span class="cls_030">end</span></div>
<div style="position:absolute;left:137.00px;top:53.31px" class="cls_030"><span class="cls_030">end</span></div>
<div style="position:absolute;left:128.50px;top:63.81px" class="cls_030"><span class="cls_030">end</span></div>
<div style="position:absolute;left:120.00px;top:74.31px" class="cls_030"><span class="cls_030">end</span></div>
<div style="position:absolute;left:120.00px;top:96.81px" class="cls_038"><span class="cls_038">Listing 5-9: Adding instance variables to each test object</span></div>
<div style="position:absolute;left:138.00px;top:119.32px" class="cls_007"><span class="cls_007">Listing 5-9 iterates 20 times, repeatedly saving one more new instance</span></div>
<div style="position:absolute;left:120.00px;top:131.32px" class="cls_007"><span class="cls_007">variable to each of the objects. Figure 5-8 shows the time that it takes</span></div>
<div style="position:absolute;left:120.00px;top:143.32px" class="cls_007"><span class="cls_007">Ruby 2.0 to add each variable: The first bar on the left is the time it takes to</span></div>
<div style="position:absolute;left:120.00px;top:155.32px" class="cls_007"><span class="cls_007">save the first instance variable in all the objects, and each subsequent bar is</span></div>
<div style="position:absolute;left:120.00px;top:167.32px" class="cls_007"><span class="cls_007">the additional time taken to save one more instance variable in each object.</span></div>
<div style="position:absolute;left:136.41px;top:189.01px" class="cls_107"><span class="cls_107">0.20</span></div>
<div style="position:absolute;left:136.41px;top:210.54px" class="cls_107"><span class="cls_107">0.18</span></div>
<div style="position:absolute;left:136.41px;top:231.73px" class="cls_107"><span class="cls_107">0.16</span></div>
<div style="position:absolute;left:136.41px;top:252.92px" class="cls_107"><span class="cls_107">0.14</span></div>
<div style="position:absolute;left:136.41px;top:273.80px" class="cls_107"><span class="cls_107">0.12</span></div>
<div style="position:absolute;left:136.41px;top:294.99px" class="cls_107"><span class="cls_107">0.10</span></div>
<div style="position:absolute;left:136.41px;top:316.18px" class="cls_107"><span class="cls_107">0.08</span></div>
<div style="position:absolute;left:136.41px;top:337.38px" class="cls_107"><span class="cls_107">0.06</span></div>
<div style="position:absolute;left:136.41px;top:358.25px" class="cls_107"><span class="cls_107">0.04</span></div>
<div style="position:absolute;left:136.41px;top:379.44px" class="cls_107"><span class="cls_107">0.02</span></div>
<div style="position:absolute;left:164.35px;top:405.45px" class="cls_107"><span class="cls_107">1</span></div>
<div style="position:absolute;left:179.12px;top:405.45px" class="cls_107"><span class="cls_107">2</span></div>
<div style="position:absolute;left:194.21px;top:405.45px" class="cls_107"><span class="cls_107">3</span></div>
<div style="position:absolute;left:208.98px;top:405.45px" class="cls_107"><span class="cls_107">4</span></div>
<div style="position:absolute;left:224.07px;top:405.45px" class="cls_107"><span class="cls_107">5</span></div>
<div style="position:absolute;left:238.84px;top:405.45px" class="cls_107"><span class="cls_107">6</span></div>
<div style="position:absolute;left:253.61px;top:405.45px" class="cls_107"><span class="cls_107">7</span></div>
<div style="position:absolute;left:268.70px;top:405.45px" class="cls_107"><span class="cls_107">8</span></div>
<div style="position:absolute;left:283.47px;top:405.45px" class="cls_107"><span class="cls_107">9</span></div>
<div style="position:absolute;left:297.52px;top:405.45px" class="cls_107"><span class="cls_107">10</span></div>
<div style="position:absolute;left:311.73px;top:405.45px" class="cls_107"><span class="cls_107">11</span></div>
<div style="position:absolute;left:326.50px;top:405.45px" class="cls_107"><span class="cls_107">12</span></div>
<div style="position:absolute;left:341.27px;top:405.45px" class="cls_107"><span class="cls_107">13</span></div>
<div style="position:absolute;left:356.35px;top:405.45px" class="cls_107"><span class="cls_107">14</span></div>
<div style="position:absolute;left:371.12px;top:405.45px" class="cls_107"><span class="cls_107">15</span></div>
<div style="position:absolute;left:386.21px;top:405.45px" class="cls_107"><span class="cls_107">16</span></div>
<div style="position:absolute;left:400.98px;top:405.45px" class="cls_107"><span class="cls_107">17</span></div>
<div style="position:absolute;left:415.75px;top:405.45px" class="cls_107"><span class="cls_107">18</span></div>
<div style="position:absolute;left:430.84px;top:405.45px" class="cls_107"><span class="cls_107">19</span></div>
<div style="position:absolute;left:446.29px;top:405.45px" class="cls_107"><span class="cls_107">20</span></div>
<div style="position:absolute;left:262.88px;top:420.15px" class="cls_108"><span class="cls_108">Instance Variable Count</span></div>
<div style="position:absolute;left:120.00px;top:436.75px" class="cls_038"><span class="cls_038">Figure 5-8: Time to add one more instance variable (in seconds x 100,000) vs. instance</span></div>
<div style="position:absolute;left:120.00px;top:447.24px" class="cls_038"><span class="cls_038">variable count</span></div>
<div style="position:absolute;left:138.00px;top:469.75px" class="cls_007"><span class="cls_007">Figure 5-8 shows a strange pattern. Sometimes it takes Ruby longer to</span></div>
<div style="position:absolute;left:120.00px;top:481.75px" class="cls_007"><span class="cls_007">add a new instance variable. What’s going on here?</span></div>
<div style="position:absolute;left:138.00px;top:493.75px" class="cls_007"><span class="cls_007">The reason for this behavior has to do with the </span><span class="cls_030">ivptr</span><span class="cls_007"> array where Ruby</span></div>
<div style="position:absolute;left:120.00px;top:505.75px" class="cls_007"><span class="cls_007">stores the instance variables, as shown in Figure 5-9.</span></div>
<div style="position:absolute;left:126.49px;top:533.41px" class="cls_020"><span class="cls_020">RObject</span></div>
<div style="position:absolute;left:154.50px;top:547.72px" class="cls_014"><span class="cls_014">ivptr</span></div>
<div style="position:absolute;left:251.12px;top:548.11px" class="cls_014"><span class="cls_014">Leonhard</span></div>
<div style="position:absolute;left:307.39px;top:548.11px" class="cls_014"><span class="cls_014">Euler</span></div>
<div style="position:absolute;left:120.00px;top:579.81px" class="cls_038"><span class="cls_038">Figure 5-9: Two instance variables saved in an object</span></div>
<div style="position:absolute;left:48.00px;top:633.00px" class="cls_020"><span class="cls_020">114</span></div>
<div style="position:absolute;left:73.31px;top:636.00px" class="cls_021"><span class="cls_021">Chapter 5</span></div>
</div>
<div style="position:absolute;left:50%;margin-left:-252px;top:91260px;width:504px;height:666px;border-style:outset;overflow:hidden">
<div style="position:absolute;left:0px;top:0px">
<img src="e698b76e-46bd-11eb-8b25-0cc47a792c0a_id_e698b76e-46bd-11eb-8b25-0cc47a792c0a_files/background139.jpg" width=504 height=666></div>
<div style="position:absolute;left:141.00px;top:42.28px" class="cls_007"><span class="cls_007">In Ruby 1.8 this array is a hash table containing both the variable names</span></div>
<div style="position:absolute;left:123.00px;top:54.28px" class="cls_007"><span class="cls_007">(the hash keys) and the values, which will automatically expand to accom-</span></div>
<div style="position:absolute;left:123.00px;top:66.28px" class="cls_007"><span class="cls_007">modate any number of elements.</span></div>
<div style="position:absolute;left:141.00px;top:78.28px" class="cls_007"><span class="cls_007">Ruby 1.9 and later save memory by storing the values in a simple array.</span></div>
<div style="position:absolute;left:123.00px;top:90.28px" class="cls_007"><span class="cls_007">The instance variable names are saved in the object’s class instead, because</span></div>
<div style="position:absolute;left:123.00px;top:102.28px" class="cls_007"><span class="cls_007">they’re the same for all instances of a class. As a result, Ruby 1.9 and 2.0</span></div>
<div style="position:absolute;left:123.00px;top:114.28px" class="cls_007"><span class="cls_007">need to either preallocate a large array to handle any number of instance</span></div>
<div style="position:absolute;left:123.00px;top:126.28px" class="cls_007"><span class="cls_007">variables or repeatedly increase the size of this array as you save more</span></div>
<div style="position:absolute;left:123.00px;top:138.28px" class="cls_007"><span class="cls_007">variables.</span></div>
<div style="position:absolute;left:141.00px;top:150.28px" class="cls_007"><span class="cls_007">In fact, as you can see in Figure 5-8, Ruby 1.9 and 2.0 repeatedly</span></div>
<div style="position:absolute;left:123.00px;top:162.28px" class="cls_007"><span class="cls_007">increase the array size. For example, suppose you have seven instance</span></div>
<div style="position:absolute;left:123.00px;top:174.28px" class="cls_007"><span class="cls_007">variables in a given object, as shown in Figure 5-10.</span></div>
<div style="position:absolute;left:129.49px;top:201.95px" class="cls_020"><span class="cls_020">RObject</span></div>
<div style="position:absolute;left:157.50px;top:216.26px" class="cls_067"><span class="cls_067">ivptr</span></div>
<div style="position:absolute;left:252.88px;top:215.66px" class="cls_019"><span class="cls_019">1</span></div>
<div style="position:absolute;left:274.15px;top:215.66px" class="cls_019"><span class="cls_019">2</span></div>
<div style="position:absolute;left:295.43px;top:215.66px" class="cls_019"><span class="cls_019">3</span></div>
<div style="position:absolute;left:316.98px;top:215.66px" class="cls_019"><span class="cls_019">4</span></div>
<div style="position:absolute;left:338.25px;top:215.66px" class="cls_019"><span class="cls_019">5</span></div>
<div style="position:absolute;left:359.53px;top:215.66px" class="cls_019"><span class="cls_019">6</span></div>
<div style="position:absolute;left:380.81px;top:215.66px" class="cls_019"><span class="cls_019">7</span></div>
<div style="position:absolute;left:123.00px;top:248.35px" class="cls_038"><span class="cls_038">Figure 5-10: Seven instance variables in an object</span></div>
<div style="position:absolute;left:141.00px;top:270.85px" class="cls_007"><span class="cls_007">When you add the eighth variable—bar  8 in Figure 5-8—Ruby 1.9</span></div>
<div style="position:absolute;left:123.00px;top:282.85px" class="cls_007"><span class="cls_007">and 2.0 increase the array size by three, anticipating that you will soon add</span></div>
<div style="position:absolute;left:123.00px;top:294.85px" class="cls_007"><span class="cls_007">more variables, as shown in Figure 5-11.</span></div>
<div style="position:absolute;left:129.49px;top:322.51px" class="cls_020"><span class="cls_020">RObject</span></div>
<div style="position:absolute;left:157.50px;top:336.82px" class="cls_067"><span class="cls_067">ivptr</span></div>
<div style="position:absolute;left:252.88px;top:336.61px" class="cls_019"><span class="cls_019">1</span></div>
<div style="position:absolute;left:274.15px;top:336.18px" class="cls_019"><span class="cls_019">2</span></div>
<div style="position:absolute;left:295.43px;top:336.18px" class="cls_019"><span class="cls_019">3</span></div>
<div style="position:absolute;left:316.98px;top:336.18px" class="cls_019"><span class="cls_019">4</span></div>
<div style="position:absolute;left:338.25px;top:336.18px" class="cls_019"><span class="cls_019">5</span></div>
<div style="position:absolute;left:359.53px;top:336.18px" class="cls_019"><span class="cls_019">6</span></div>
<div style="position:absolute;left:380.81px;top:336.18px" class="cls_019"><span class="cls_019">7</span></div>
<div style="position:absolute;left:402.09px;top:336.18px" class="cls_019"><span class="cls_019">8</span></div>
<div style="position:absolute;left:123.00px;top:368.92px" class="cls_038"><span class="cls_038">Figure 5-11: Adding an eighth value allocates extra space.</span></div>
<div style="position:absolute;left:141.00px;top:391.42px" class="cls_007"><span class="cls_007">Allocating more memory takes extra time, which is why bar 8 is higher.</span></div>
<div style="position:absolute;left:123.00px;top:403.42px" class="cls_007"><span class="cls_007">Now if you add two more instance variables, Ruby 1.9 and 2.0 won’t need to</span></div>
<div style="position:absolute;left:123.00px;top:415.42px" class="cls_007"><span class="cls_007">reallocate memory for this array because the space will already be available.</span></div>
<div style="position:absolute;left:123.00px;top:427.42px" class="cls_007"><span class="cls_007">This explains the shorter times for bars 9 and 10.</span></div>
<div style="position:absolute;left:69.00px;top:461.42px" class="cls_031"><span class="cls_031">What’s Inside the RClass Structure?</span></div>
<div style="position:absolute;left:123.00px;top:481.42px" class="cls_007"><span class="cls_007">Every object remembers its class by sav-</span></div>
<div style="position:absolute;left:123.00px;top:493.42px" class="cls_007"><span class="cls_007">ing a pointer to an </span><span class="cls_030">RClass</span><span class="cls_007"> structure.</span></div>
<div style="position:absolute;left:123.00px;top:505.42px" class="cls_007"><span class="cls_007">What information does each </span><span class="cls_030">RClass</span></div>
<div style="position:absolute;left:123.00px;top:517.42px" class="cls_007"><span class="cls_007">structure contain? What would we see</span></div>
<div style="position:absolute;left:123.00px;top:529.42px" class="cls_007"><span class="cls_007">if we could look inside a Ruby class?</span></div>
<div style="position:absolute;left:123.00px;top:541.42px" class="cls_007"><span class="cls_007">Let’s build a model of the information</span></div>
<div style="position:absolute;left:123.00px;top:553.42px" class="cls_007"><span class="cls_007">that must be present in </span><span class="cls_030">RClass</span><span class="cls_007">. This</span></div>
<div style="position:absolute;left:123.00px;top:565.42px" class="cls_007"><span class="cls_007">model will give us a technical definition</span></div>
<div style="position:absolute;left:324.00px;top:573.15px" class="cls_038"><span class="cls_038">Two objects, one class</span></div>
<div style="position:absolute;left:123.00px;top:577.42px" class="cls_007"><span class="cls_007">of what a Ruby class is, based on what</span></div>
<div style="position:absolute;left:123.00px;top:589.42px" class="cls_007"><span class="cls_007">we know classes can do.</span></div>
<div style="position:absolute;left:375.41px;top:636.00px" class="cls_021"><span class="cls_021">Objects and Classes</span></div>
<div style="position:absolute;left:443.74px;top:633.00px" class="cls_020"><span class="cls_020">115</span></div>
</div>
<div style="position:absolute;left:50%;margin-left:-252px;top:91936px;width:504px;height:666px;border-style:outset;overflow:hidden">
<div style="position:absolute;left:0px;top:0px">
<img src="e698b76e-46bd-11eb-8b25-0cc47a792c0a_id_e698b76e-46bd-11eb-8b25-0cc47a792c0a_files/background140.jpg" width=504 height=666></div>
<div style="position:absolute;left:138.00px;top:42.28px" class="cls_007"><span class="cls_007">Every Ruby developer knows how to write a class: You type the </span><span class="cls_030">class</span><span class="cls_007"> key-</span></div>
<div style="position:absolute;left:120.00px;top:54.28px" class="cls_007"><span class="cls_007">word, specify a name for the new class, and then type in the class’s methods.</span></div>
<div style="position:absolute;left:120.00px;top:66.28px" class="cls_007"><span class="cls_007">Listing 5-10 shows a familiar example.</span></div>
<div style="position:absolute;left:120.00px;top:90.28px" class="cls_030"><span class="cls_030">class Mathematician</span></div>
<div style="position:absolute;left:128.50px;top:100.78px" class="cls_030"><span class="cls_030">attr_accessor :first_name</span></div>
<div style="position:absolute;left:128.50px;top:111.28px" class="cls_030"><span class="cls_030">attr_accessor :last_name</span></div>
<div style="position:absolute;left:120.00px;top:121.77px" class="cls_030"><span class="cls_030">end</span></div>
<div style="position:absolute;left:120.00px;top:144.27px" class="cls_038"><span class="cls_038">Listing 5-10: The same simple Ruby class we saw in Listing 5-1</span></div>
<div style="position:absolute;left:138.00px;top:166.78px" class="cls_030"><span class="cls_030">attr_accessor</span><span class="cls_007"> is shorthand for defining get and set methods for</span></div>
<div style="position:absolute;left:120.00px;top:178.78px" class="cls_007"><span class="cls_007">an attribute. (The methods defined by </span><span class="cls_030">attr_accessor</span><span class="cls_007"> also check for </span><span class="cls_030">nil</span></div>
<div style="position:absolute;left:120.00px;top:190.78px" class="cls_007"><span class="cls_007">values). Listing 5-11 shows a more verbose way of defining the same</span></div>
<div style="position:absolute;left:120.00px;top:202.78px" class="cls_030"><span class="cls_030">Mathematician</span><span class="cls_007"> class.</span></div>
<div style="position:absolute;left:120.00px;top:226.78px" class="cls_030"><span class="cls_030">class Mathematician</span></div>
<div style="position:absolute;left:128.50px;top:237.28px" class="cls_030"><span class="cls_030">def first_name</span></div>
<div style="position:absolute;left:137.00px;top:247.77px" class="cls_030"><span class="cls_030">@first_name</span></div>
<div style="position:absolute;left:128.50px;top:258.27px" class="cls_030"><span class="cls_030">end</span></div>
<div style="position:absolute;left:128.50px;top:268.77px" class="cls_030"><span class="cls_030">def first_name=(value)</span></div>
<div style="position:absolute;left:137.00px;top:279.27px" class="cls_030"><span class="cls_030">@first_name = value</span></div>
<div style="position:absolute;left:128.50px;top:289.77px" class="cls_030"><span class="cls_030">end</span></div>
<div style="position:absolute;left:128.50px;top:300.26px" class="cls_030"><span class="cls_030">def last_name</span></div>
<div style="position:absolute;left:137.00px;top:310.76px" class="cls_030"><span class="cls_030">@last_name</span></div>
<div style="position:absolute;left:128.50px;top:321.26px" class="cls_030"><span class="cls_030">end</span></div>
<div style="position:absolute;left:128.50px;top:331.76px" class="cls_030"><span class="cls_030">def last_name=(value)</span></div>
<div style="position:absolute;left:137.00px;top:342.25px" class="cls_030"><span class="cls_030">@last_name = value</span></div>
<div style="position:absolute;left:128.50px;top:352.75px" class="cls_030"><span class="cls_030">end</span></div>
<div style="position:absolute;left:120.00px;top:363.25px" class="cls_030"><span class="cls_030">end</span></div>
<div style="position:absolute;left:120.00px;top:385.75px" class="cls_038"><span class="cls_038">Listing 5-11: The same class written without </span><span class="cls_014">attr_accessor</span></div>
<div style="position:absolute;left:138.00px;top:408.28px" class="cls_007"><span class="cls_007">It appears that this class—and every Ruby class—is just a group of method</span></div>
<div style="position:absolute;left:120.00px;top:420.28px" class="cls_007"><span class="cls_007">definitions. You can assign behavior to an object by adding methods to its</span></div>
<div style="position:absolute;left:120.00px;top:432.28px" class="cls_007"><span class="cls_007">class, and when you call a method on an object, Ruby looks for the method</span></div>
<div style="position:absolute;left:120.00px;top:444.28px" class="cls_007"><span class="cls_007">in the object’s class. This leads to our first definition of a Ruby class:</span></div>
<div style="position:absolute;left:156.00px;top:463.28px" class="cls_033"><span class="cls_033">A Ruby class is a group of method definitions.</span></div>
<div style="position:absolute;left:138.00px;top:480.28px" class="cls_007"><span class="cls_007">Therefore, the </span><span class="cls_030">RClass</span><span class="cls_007"> structure for </span><span class="cls_030">Mathematician</span><span class="cls_007"> must save a list of all</span></div>
<div style="position:absolute;left:120.00px;top:492.28px" class="cls_007"><span class="cls_007">the methods defined in the class, as shown in Figure 5-12.</span></div>
<div style="position:absolute;left:138.00px;top:504.28px" class="cls_007"><span class="cls_007">Notice in Listing 5-11 that I’ve also created two instance variables:</span></div>
<div style="position:absolute;left:120.00px;top:516.28px" class="cls_030"><span class="cls_030">@first_name</span><span class="cls_007"> and </span><span class="cls_030">@last_name</span><span class="cls_007">. We saw earlier how Ruby stores these values in</span></div>
<div style="position:absolute;left:120.00px;top:528.28px" class="cls_007"><span class="cls_007">each </span><span class="cls_030">RObject</span><span class="cls_007"> structure, but you may have noticed that only the </span><span class="cls_008">values</span><span class="cls_007"> of</span></div>
<div style="position:absolute;left:120.00px;top:540.28px" class="cls_007"><span class="cls_007">these variables are stored in </span><span class="cls_030">RObject</span><span class="cls_007">, not their names. (Ruby 1.8 does store</span></div>
<div style="position:absolute;left:120.00px;top:552.28px" class="cls_007"><span class="cls_007">the names in </span><span class="cls_030">RObject</span><span class="cls_007">.) Ruby must store the attribute names in </span><span class="cls_030">RClass</span><span class="cls_007">, which</span></div>
<div style="position:absolute;left:120.00px;top:564.28px" class="cls_007"><span class="cls_007">makes sense because the names will be the same for every </span><span class="cls_030">Mathematician</span></div>
<div style="position:absolute;left:120.00px;top:576.28px" class="cls_007"><span class="cls_007">instance.</span></div>
<div style="position:absolute;left:48.00px;top:633.00px" class="cls_020"><span class="cls_020">116</span></div>
<div style="position:absolute;left:73.33px;top:636.00px" class="cls_021"><span class="cls_021">Chapter 5</span></div>
</div>
<div style="position:absolute;left:50%;margin-left:-252px;top:92612px;width:504px;height:666px;border-style:outset;overflow:hidden">
<div style="position:absolute;left:0px;top:0px">
<img src="e698b76e-46bd-11eb-8b25-0cc47a792c0a_id_e698b76e-46bd-11eb-8b25-0cc47a792c0a_files/background141.jpg" width=504 height=666></div>
<div style="position:absolute;left:131.45px;top:52.13px" class="cls_042"><span class="cls_042">RClass</span></div>
<div style="position:absolute;left:171.68px;top:67.31px" class="cls_017"><span class="cls_017">method table:</span></div>
<div style="position:absolute;left:178.45px;top:90.74px" class="cls_014"><span class="cls_014">first_name</span></div>
<div style="position:absolute;left:176.45px;top:111.27px" class="cls_014"><span class="cls_014">first_name=</span></div>
<div style="position:absolute;left:180.45px;top:131.79px" class="cls_014"><span class="cls_014">last_name</span></div>
<div style="position:absolute;left:178.45px;top:152.32px" class="cls_014"><span class="cls_014">last_name=</span></div>
<div style="position:absolute;left:123.00px;top:192.40px" class="cls_038"><span class="cls_038">Figure 5-12: Ruby classes contain a method table.</span></div>
<div style="position:absolute;left:141.00px;top:214.90px" class="cls_007"><span class="cls_007">Let’s redraw </span><span class="cls_030">RClass</span><span class="cls_007"> again and include a table of attribute names this</span></div>
<div style="position:absolute;left:123.00px;top:226.90px" class="cls_007"><span class="cls_007">time, as shown in Figure 5-13.</span></div>
<div style="position:absolute;left:131.46px;top:257.86px" class="cls_109"><span class="cls_109">RClass</span></div>
<div style="position:absolute;left:164.15px;top:275.47px" class="cls_110"><span class="cls_110">method table:</span></div>
<div style="position:absolute;left:252.82px;top:275.47px" class="cls_110"><span class="cls_110">attribute names:</span></div>
<div style="position:absolute;left:170.78px;top:299.47px" class="cls_111"><span class="cls_111">first_name</span></div>
<div style="position:absolute;left:261.72px;top:299.47px" class="cls_111"><span class="cls_111">@first_name</span></div>
<div style="position:absolute;left:168.82px;top:320.54px" class="cls_111"><span class="cls_111">first_name=</span></div>
<div style="position:absolute;left:263.68px;top:320.54px" class="cls_111"><span class="cls_111">@last_name</span></div>
<div style="position:absolute;left:172.73px;top:341.61px" class="cls_111"><span class="cls_111">last_name</span></div>
<div style="position:absolute;left:170.78px;top:362.68px" class="cls_111"><span class="cls_111">last_name=</span></div>
<div style="position:absolute;left:123.00px;top:400.29px" class="cls_038"><span class="cls_038">Figure 5-13: Ruby classes also contain a table of attribute names.</span></div>
<div style="position:absolute;left:141.00px;top:422.79px" class="cls_007"><span class="cls_007">Now our definition of a Ruby class is as follows:</span></div>
<div style="position:absolute;left:159.00px;top:441.79px" class="cls_033"><span class="cls_033">A Ruby class is a group of method definitions and a table of</span></div>
<div style="position:absolute;left:159.00px;top:453.79px" class="cls_033"><span class="cls_033">attribute names.</span></div>
<div style="position:absolute;left:141.00px;top:470.79px" class="cls_007"><span class="cls_007">At the beginning of this chapter, I mentioned that every value in Ruby</span></div>
<div style="position:absolute;left:123.00px;top:482.79px" class="cls_007"><span class="cls_007">is an object. This might be true for classes, too. Let’s prove this using IRB.</span></div>
<div style="position:absolute;left:123.00px;top:506.79px" class="cls_030"><span class="cls_030">> </span><span class="cls_040">p Mathematician.class</span></div>
<div style="position:absolute;left:127.25px;top:517.29px" class="cls_030"><span class="cls_030">=> Class</span></div>
<div style="position:absolute;left:141.00px;top:539.79px" class="cls_007"><span class="cls_007">As you can see, Ruby classes are all instances of the </span><span class="cls_030">Class</span><span class="cls_007"> class; therefore,</span></div>
<div style="position:absolute;left:123.00px;top:551.79px" class="cls_007"><span class="cls_007">classes are also objects. Now to update our definition of a Ruby class again:</span></div>
<div style="position:absolute;left:159.00px;top:570.79px" class="cls_033"><span class="cls_033">A Ruby class is a Ruby object that also contains method definitions</span></div>
<div style="position:absolute;left:159.00px;top:582.79px" class="cls_033"><span class="cls_033">and attribute names.</span></div>
<div style="position:absolute;left:375.40px;top:636.00px" class="cls_021"><span class="cls_021">Objects and Classes</span></div>
<div style="position:absolute;left:443.72px;top:633.00px" class="cls_020"><span class="cls_020">117</span></div>
</div>
<div style="position:absolute;left:50%;margin-left:-252px;top:93288px;width:504px;height:666px;border-style:outset;overflow:hidden">
<div style="position:absolute;left:0px;top:0px">
<img src="e698b76e-46bd-11eb-8b25-0cc47a792c0a_id_e698b76e-46bd-11eb-8b25-0cc47a792c0a_files/background142.jpg" width=504 height=666></div>
<div style="position:absolute;left:138.00px;top:42.28px" class="cls_007"><span class="cls_007">Because Ruby classes are objects, we know that the </span><span class="cls_030">RClass</span><span class="cls_007"> structure</span></div>
<div style="position:absolute;left:120.00px;top:54.28px" class="cls_007"><span class="cls_007">must also contain a class pointer and an instance variable array, the values</span></div>
<div style="position:absolute;left:120.00px;top:66.28px" class="cls_007"><span class="cls_007">that we know every Ruby object contains, as shown in Figure 5-14.</span></div>
<div style="position:absolute;left:130.47px;top:94.59px" class="cls_112"><span class="cls_112">RClass</span></div>
<div style="position:absolute;left:227.48px;top:103.06px" class="cls_113"><span class="cls_113">instance-level</span></div>
<div style="position:absolute;left:144.78px;top:112.85px" class="cls_113"><span class="cls_113">method table:</span></div>
<div style="position:absolute;left:222.05px;top:112.24px" class="cls_113"><span class="cls_113">attribute names:</span></div>
<div style="position:absolute;left:308.91px;top:111.89px" class="cls_113"><span class="cls_113">class pointer:</span></div>
<div style="position:absolute;left:399.73px;top:118.48px" class="cls_112"><span class="cls_112">RClass</span></div>
<div style="position:absolute;left:151.49px;top:130.71px" class="cls_114"><span class="cls_114">first_name</span></div>
<div style="position:absolute;left:231.05px;top:130.71px" class="cls_114"><span class="cls_114">@first_name</span></div>
<div style="position:absolute;left:326.25px;top:130.71px" class="cls_114"><span class="cls_114">klass</span></div>
<div style="position:absolute;left:414.08px;top:130.71px" class="cls_114"><span class="cls_114">Class</span></div>
<div style="position:absolute;left:149.51px;top:149.07px" class="cls_114"><span class="cls_114">first_name=</span></div>
<div style="position:absolute;left:233.04px;top:149.07px" class="cls_114"><span class="cls_114">@last_name</span></div>
<div style="position:absolute;left:315.48px;top:159.68px" class="cls_113"><span class="cls_113">class-level</span></div>
<div style="position:absolute;left:153.47px;top:167.43px" class="cls_114"><span class="cls_114">last_name</span></div>
<div style="position:absolute;left:298.37px;top:168.86px" class="cls_113"><span class="cls_113">instance variables:</span></div>
<div style="position:absolute;left:151.49px;top:185.79px" class="cls_114"><span class="cls_114">last_name=</span></div>
<div style="position:absolute;left:322.29px;top:186.50px" class="cls_114"><span class="cls_114">@value1</span></div>
<div style="position:absolute;left:322.29px;top:204.86px" class="cls_114"><span class="cls_114">@value2</span></div>
<div style="position:absolute;left:120.00px;top:261.14px" class="cls_038"><span class="cls_038">Figure 5-14: Ruby classes also contain a class pointer and instance variables.</span></div>
<div style="position:absolute;left:138.00px;top:283.64px" class="cls_007"><span class="cls_007">As you can see, I’ve added a pointer to the </span><span class="cls_030">Class</span><span class="cls_007"> class, which is in theory</span></div>
<div style="position:absolute;left:120.00px;top:295.64px" class="cls_007"><span class="cls_007">the class of every Ruby class object. However, in Experiment 5-2 on page 127,</span></div>
<div style="position:absolute;left:120.00px;top:307.64px" class="cls_007"><span class="cls_007">I’ll show that this diagram is in fact not accurate—that </span><span class="cls_030">klass</span><span class="cls_007"> actually points</span></div>
<div style="position:absolute;left:120.00px;top:319.64px" class="cls_007"><span class="cls_007">to something else! I’ve also added a table of instance variables.</span></div>
<div style="position:absolute;left:78.00px;top:346.14px" class="cls_032"><span class="cls_032">Not e</span></div>
<div style="position:absolute;left:120.00px;top:343.64px" class="cls_008"><span class="cls_008">These are the class-level instance variables. Don’t confuse these with the table of attri-</span></div>
<div style="position:absolute;left:120.00px;top:355.64px" class="cls_008"><span class="cls_008">bute names for the object-level instance variables.</span></div>
<div style="position:absolute;left:138.00px;top:379.64px" class="cls_007"><span class="cls_007">This is rapidly getting out of control! The </span><span class="cls_030">RClass</span><span class="cls_007"> structure seems to be</span></div>
<div style="position:absolute;left:120.00px;top:391.64px" class="cls_007"><span class="cls_007">much more complex than the </span><span class="cls_030">RObject</span><span class="cls_007"> structure. But don’t worry—we’re</span></div>
<div style="position:absolute;left:120.00px;top:403.64px" class="cls_007"><span class="cls_007">getting close to an accurate picture of the </span><span class="cls_030">RClass</span><span class="cls_007"> structure. Next we need</span></div>
<div style="position:absolute;left:120.00px;top:415.64px" class="cls_007"><span class="cls_007">to consider two more important types of information contained in each</span></div>
<div style="position:absolute;left:120.00px;top:427.64px" class="cls_007"><span class="cls_007">Ruby class.</span></div>
<div style="position:absolute;left:120.00px;top:452.64px" class="cls_055"><span class="cls_055">Inheritance</span></div>
<div style="position:absolute;left:120.00px;top:470.64px" class="cls_007"><span class="cls_007">Inheritance is an essential feature of object-oriented programming. Ruby</span></div>
<div style="position:absolute;left:120.00px;top:482.64px" class="cls_007"><span class="cls_007">implements single inheritance by allowing us to optionally specify one</span></div>
<div style="position:absolute;left:120.00px;top:494.64px" class="cls_007"><span class="cls_007">superclass when we create a class. If we don’t specify a superclass, Ruby</span></div>
<div style="position:absolute;left:120.00px;top:506.64px" class="cls_007"><span class="cls_007">assigns the </span><span class="cls_030">Object</span><span class="cls_007"> class as the superclass. For example, we could rewrite the</span></div>
<div style="position:absolute;left:120.00px;top:518.64px" class="cls_030"><span class="cls_030">Mathematician</span><span class="cls_007"> class using a superclass like this:</span></div>
<div style="position:absolute;left:120.00px;top:542.64px" class="cls_030"><span class="cls_030">class Mathematician &lt; Person</span></div>
<div style="position:absolute;left:120.00px;top:553.14px" class="cls_030"><span class="cls_030">--snip--</span></div>
<div style="position:absolute;left:138.00px;top:575.64px" class="cls_007"><span class="cls_007">Now every instance of </span><span class="cls_030">Mathematician</span><span class="cls_007"> will include the same methods</span></div>
<div style="position:absolute;left:120.00px;top:587.64px" class="cls_007"><span class="cls_007">that instances of </span><span class="cls_030">Person</span><span class="cls_007"> have. In this example, we might want to move the</span></div>
<div style="position:absolute;left:120.00px;top:599.64px" class="cls_030"><span class="cls_030">first_name</span><span class="cls_007"> and </span><span class="cls_030">last_name</span><span class="cls_007"> accessor methods into </span><span class="cls_030">Person</span><span class="cls_007">. We could also move</span></div>
<div style="position:absolute;left:48.00px;top:633.00px" class="cls_020"><span class="cls_020">118</span></div>
<div style="position:absolute;left:73.37px;top:636.00px" class="cls_021"><span class="cls_021">Chapter 5</span></div>
</div>
<div style="position:absolute;left:50%;margin-left:-252px;top:93964px;width:504px;height:666px;border-style:outset;overflow:hidden">
<div style="position:absolute;left:0px;top:0px">
<img src="e698b76e-46bd-11eb-8b25-0cc47a792c0a_id_e698b76e-46bd-11eb-8b25-0cc47a792c0a_files/background143.jpg" width=504 height=666></div>
<div style="position:absolute;left:123.00px;top:42.28px" class="cls_007"><span class="cls_007">the </span><span class="cls_030">@first_name</span><span class="cls_007"> and </span><span class="cls_030">@last_name</span><span class="cls_007"> attributes into the </span><span class="cls_030">Person</span><span class="cls_007"> class. Every instance</span></div>
<div style="position:absolute;left:123.00px;top:54.28px" class="cls_007"><span class="cls_007">of </span><span class="cls_030">Mathematician</span><span class="cls_007"> will contain these methods and attributes, even though we</span></div>
<div style="position:absolute;left:123.00px;top:66.28px" class="cls_007"><span class="cls_007">moved them to the </span><span class="cls_030">Person</span><span class="cls_007"> class.</span></div>
<div style="position:absolute;left:141.00px;top:78.28px" class="cls_007"><span class="cls_007">The </span><span class="cls_030">Mathematician</span><span class="cls_007"> class must contain a reference to the </span><span class="cls_030">Person</span><span class="cls_007"> class (its</span></div>
<div style="position:absolute;left:123.00px;top:90.28px" class="cls_007"><span class="cls_007">superclass) so that Ruby can find any methods or attributes defined in</span></div>
<div style="position:absolute;left:123.00px;top:102.28px" class="cls_007"><span class="cls_007">the superclass.</span></div>
<div style="position:absolute;left:141.00px;top:114.28px" class="cls_007"><span class="cls_007">Let’s update our definition again, assuming that Ruby tracks the super-</span></div>
<div style="position:absolute;left:123.00px;top:126.28px" class="cls_007"><span class="cls_007">class using another pointer similar to </span><span class="cls_030">klass</span><span class="cls_007">:</span></div>
<div style="position:absolute;left:159.00px;top:145.28px" class="cls_033"><span class="cls_033">A Ruby class is a Ruby object that also contains method definitions,</span></div>
<div style="position:absolute;left:159.00px;top:157.28px" class="cls_033"><span class="cls_033">attribute names, and a superclass pointer.</span></div>
<div style="position:absolute;left:141.00px;top:174.28px" class="cls_007"><span class="cls_007">And let’s redraw the </span><span class="cls_030">RClass</span><span class="cls_007"> structure to include the new superclass</span></div>
<div style="position:absolute;left:123.00px;top:186.28px" class="cls_007"><span class="cls_007">pointer, as shown in Figure 5-15.</span></div>
<div style="position:absolute;left:133.47px;top:216.59px" class="cls_112"><span class="cls_112">RClass</span></div>
<div style="position:absolute;left:230.48px;top:225.07px" class="cls_113"><span class="cls_113">instance-level</span></div>
<div style="position:absolute;left:147.78px;top:234.85px" class="cls_113"><span class="cls_113">method table:</span></div>
<div style="position:absolute;left:225.05px;top:234.25px" class="cls_113"><span class="cls_113">attribute names:</span></div>
<div style="position:absolute;left:311.91px;top:233.90px" class="cls_113"><span class="cls_113">class pointer:</span></div>
<div style="position:absolute;left:402.73px;top:240.49px" class="cls_112"><span class="cls_112">RClass</span></div>
<div style="position:absolute;left:154.49px;top:252.71px" class="cls_114"><span class="cls_114">first_name</span></div>
<div style="position:absolute;left:234.05px;top:252.71px" class="cls_114"><span class="cls_114">@first_name</span></div>
<div style="position:absolute;left:329.25px;top:252.71px" class="cls_114"><span class="cls_114">klass</span></div>
<div style="position:absolute;left:417.08px;top:252.71px" class="cls_114"><span class="cls_114">Class</span></div>
<div style="position:absolute;left:152.51px;top:271.08px" class="cls_114"><span class="cls_114">first_name=</span></div>
<div style="position:absolute;left:236.04px;top:271.08px" class="cls_114"><span class="cls_114">@last_name</span></div>
<div style="position:absolute;left:318.48px;top:281.68px" class="cls_113"><span class="cls_113">class-level</span></div>
<div style="position:absolute;left:156.47px;top:289.44px" class="cls_114"><span class="cls_114">last_name</span></div>
<div style="position:absolute;left:301.37px;top:290.86px" class="cls_113"><span class="cls_113">instance variables:</span></div>
<div style="position:absolute;left:154.49px;top:307.80px" class="cls_114"><span class="cls_114">last_name=</span></div>
<div style="position:absolute;left:325.29px;top:308.50px" class="cls_114"><span class="cls_114">@value1</span></div>
<div style="position:absolute;left:325.29px;top:326.87px" class="cls_114"><span class="cls_114">@value2</span></div>
<div style="position:absolute;left:316.32px;top:352.74px" class="cls_113"><span class="cls_113">superclass:</span></div>
<div style="position:absolute;left:402.73px;top:359.85px" class="cls_112"><span class="cls_112">RClass</span></div>
<div style="position:absolute;left:329.25px;top:371.56px" class="cls_114"><span class="cls_114">super</span></div>
<div style="position:absolute;left:415.10px;top:372.07px" class="cls_114"><span class="cls_114">Person</span></div>
<div style="position:absolute;left:123.00px;top:419.37px" class="cls_038"><span class="cls_038">Figure 5-15: Ruby classes also contain a superclass pointer.</span></div>
<div style="position:absolute;left:141.00px;top:441.87px" class="cls_007"><span class="cls_007">At this point, it is critical to understand the difference between the</span></div>
<div style="position:absolute;left:123.00px;top:453.87px" class="cls_030"><span class="cls_030">klass</span><span class="cls_007"> pointer and the </span><span class="cls_030">super</span><span class="cls_007"> pointer. The </span><span class="cls_030">klass</span><span class="cls_007"> pointer indicates which class</span></div>
<div style="position:absolute;left:123.00px;top:465.87px" class="cls_007"><span class="cls_007">the Ruby class object is an instance of. This will always be the </span><span class="cls_030">Class</span><span class="cls_007"> class:</span></div>
<div style="position:absolute;left:123.00px;top:489.87px" class="cls_030"><span class="cls_030">> </span><span class="cls_040">p Mathematician.class</span></div>
<div style="position:absolute;left:127.25px;top:500.36px" class="cls_030"><span class="cls_030">=> Class</span></div>
<div style="position:absolute;left:141.00px;top:522.87px" class="cls_007"><span class="cls_007">Ruby uses the </span><span class="cls_030">klass</span><span class="cls_007"> pointer to find the methods of the </span><span class="cls_030">Mathematician</span></div>
<div style="position:absolute;left:123.00px;top:534.87px" class="cls_007"><span class="cls_007">class object, such as the </span><span class="cls_030">new</span><span class="cls_007"> method that every Ruby class implements.</span></div>
<div style="position:absolute;left:123.00px;top:546.87px" class="cls_007"><span class="cls_007">However, the </span><span class="cls_030">super</span><span class="cls_007"> pointer records the class’s superclass:</span></div>
<div style="position:absolute;left:123.00px;top:570.87px" class="cls_030"><span class="cls_030">> </span><span class="cls_040">p Mathematician.superclass</span></div>
<div style="position:absolute;left:127.25px;top:581.36px" class="cls_030"><span class="cls_030">=> Person</span></div>
<div style="position:absolute;left:375.38px;top:636.00px" class="cls_021"><span class="cls_021">Objects and Classes</span></div>
<div style="position:absolute;left:443.71px;top:633.00px" class="cls_020"><span class="cls_020">119</span></div>
</div>
<div style="position:absolute;left:50%;margin-left:-252px;top:94640px;width:504px;height:666px;border-style:outset;overflow:hidden">
<div style="position:absolute;left:0px;top:0px">
<img src="e698b76e-46bd-11eb-8b25-0cc47a792c0a_id_e698b76e-46bd-11eb-8b25-0cc47a792c0a_files/background144.jpg" width=504 height=666></div>
<div style="position:absolute;left:138.00px;top:42.28px" class="cls_007"><span class="cls_007">Ruby uses the </span><span class="cls_030">super</span><span class="cls_007"> pointer to help find methods contained in each</span></div>
<div style="position:absolute;left:120.00px;top:54.28px" class="cls_030"><span class="cls_030">Mathematician</span><span class="cls_007"> instance, such as </span><span class="cls_030">first_name=</span><span class="cls_007"> or </span><span class="cls_030">last_name</span><span class="cls_007">. As we’ll see next,</span></div>
<div style="position:absolute;left:120.00px;top:66.28px" class="cls_007"><span class="cls_007">Ruby also uses the </span><span class="cls_030">super</span><span class="cls_007"> pointer when getting or setting class variables.</span></div>
<div style="position:absolute;left:120.00px;top:91.28px" class="cls_055"><span class="cls_055">Class Instance Variables vs. Class Variables</span></div>
<div style="position:absolute;left:120.00px;top:109.28px" class="cls_007"><span class="cls_007">One confusing bit of Ruby syntax is the concept of </span><span class="cls_008">class variables</span><span class="cls_007">. You might</span></div>
<div style="position:absolute;left:120.00px;top:121.28px" class="cls_007"><span class="cls_007">think that these are simply the instance variables of a class (the class-level</span></div>
<div style="position:absolute;left:120.00px;top:133.28px" class="cls_007"><span class="cls_007">instance variables from Figure 5-14), but class instance variables and class</span></div>
<div style="position:absolute;left:120.00px;top:145.28px" class="cls_007"><span class="cls_007">variables are distinctly different.</span></div>
<div style="position:absolute;left:138.00px;top:157.28px" class="cls_007"><span class="cls_007">To create a class instance variable, you simply create an instance vari-</span></div>
<div style="position:absolute;left:120.00px;top:169.28px" class="cls_007"><span class="cls_007">able using the </span><span class="cls_030">@</span><span class="cls_007"> symbol, but in the context of a class rather than an object.</span></div>
<div style="position:absolute;left:120.00px;top:181.28px" class="cls_007"><span class="cls_007">For example, Listing 5-12 shows how we could use an instance variable of</span></div>
<div style="position:absolute;left:120.00px;top:193.28px" class="cls_030"><span class="cls_030">Mathematician</span><span class="cls_007"> to indicate a branch of mathematics this class corresponds to.</span></div>
<div style="position:absolute;left:120.00px;top:205.28px" class="cls_007"><span class="cls_007">We create the </span><span class="cls_030">@type</span><span class="cls_007"> instance variable at </span><span class="cls_050">u</span><span class="cls_007">.</span></div>
<div style="position:absolute;left:120.00px;top:229.28px" class="cls_030"><span class="cls_030">class Mathematician</span></div>
<div style="position:absolute;left:108.00px;top:239.78px" class="cls_046"><span class="cls_046">u</span></div>
<div style="position:absolute;left:128.33px;top:239.78px" class="cls_030"><span class="cls_030">@type = "General"</span></div>
<div style="position:absolute;left:128.50px;top:250.27px" class="cls_030"><span class="cls_030">def self.type</span></div>
<div style="position:absolute;left:137.00px;top:260.77px" class="cls_030"><span class="cls_030">@type</span></div>
<div style="position:absolute;left:128.50px;top:271.27px" class="cls_030"><span class="cls_030">end</span></div>
<div style="position:absolute;left:120.00px;top:281.77px" class="cls_030"><span class="cls_030">end</span></div>
<div style="position:absolute;left:120.00px;top:302.77px" class="cls_030"><span class="cls_030">puts Mathematician.type</span></div>
<div style="position:absolute;left:124.25px;top:313.27px" class="cls_030"><span class="cls_030">=> General</span></div>
<div style="position:absolute;left:120.00px;top:335.77px" class="cls_038"><span class="cls_038">Listing 5-12: Creating a class-level instance variable</span></div>
<div style="position:absolute;left:138.00px;top:358.28px" class="cls_007"><span class="cls_007">In contrast, to create a class variable, you would use the </span><span class="cls_030">@@</span><span class="cls_007"> notation.</span></div>
<div style="position:absolute;left:120.00px;top:370.28px" class="cls_007"><span class="cls_007">Listing 5-13 shows the same example, with the class variable </span><span class="cls_030">@@type</span><span class="cls_007"> </span><span class="cls_050">u</span></div>
<div style="position:absolute;left:120.00px;top:382.28px" class="cls_007"><span class="cls_007">created.</span></div>
<div style="position:absolute;left:120.00px;top:406.28px" class="cls_030"><span class="cls_030">class Mathematician</span></div>
<div style="position:absolute;left:108.00px;top:416.78px" class="cls_046"><span class="cls_046">u</span></div>
<div style="position:absolute;left:128.33px;top:416.78px" class="cls_030"><span class="cls_030">@@type = "General"</span></div>
<div style="position:absolute;left:128.50px;top:427.27px" class="cls_030"><span class="cls_030">def self.type</span></div>
<div style="position:absolute;left:137.00px;top:437.77px" class="cls_030"><span class="cls_030">@@type</span></div>
<div style="position:absolute;left:128.50px;top:448.27px" class="cls_030"><span class="cls_030">end</span></div>
<div style="position:absolute;left:120.00px;top:458.77px" class="cls_030"><span class="cls_030">end</span></div>
<div style="position:absolute;left:120.00px;top:479.77px" class="cls_030"><span class="cls_030">puts Mathematician.type</span></div>
<div style="position:absolute;left:124.25px;top:490.27px" class="cls_030"><span class="cls_030">=> General</span></div>
<div style="position:absolute;left:120.00px;top:512.77px" class="cls_038"><span class="cls_038">Listing 5-13: Creating a class variable</span></div>
<div style="position:absolute;left:138.00px;top:535.28px" class="cls_007"><span class="cls_007">What’s the difference? When you create a class variable, Ruby creates</span></div>
<div style="position:absolute;left:120.00px;top:547.28px" class="cls_007"><span class="cls_007">a single value for you to use in that class and in any subclasses you might</span></div>
<div style="position:absolute;left:120.00px;top:559.28px" class="cls_007"><span class="cls_007">define. On the other hand, using a class </span><span class="cls_008">instance</span><span class="cls_007"> variable causes Ruby to cre-</span></div>
<div style="position:absolute;left:120.00px;top:571.28px" class="cls_007"><span class="cls_007">ate a separate value for each class or subclass.</span></div>
<div style="position:absolute;left:48.00px;top:633.00px" class="cls_020"><span class="cls_020">120</span></div>
<div style="position:absolute;left:74.05px;top:636.00px" class="cls_021"><span class="cls_021">Chapter 5</span></div>
</div>
<div style="position:absolute;left:50%;margin-left:-252px;top:95316px;width:504px;height:666px;border-style:outset;overflow:hidden">
<div style="position:absolute;left:0px;top:0px">
<img src="e698b76e-46bd-11eb-8b25-0cc47a792c0a_id_e698b76e-46bd-11eb-8b25-0cc47a792c0a_files/background145.jpg" width=504 height=666></div>
<div style="position:absolute;left:141.00px;top:42.28px" class="cls_007"><span class="cls_007">Let’s review Listing 5-14 to see how Ruby handles these two types of</span></div>
<div style="position:absolute;left:123.00px;top:54.28px" class="cls_007"><span class="cls_007">variables differently. First, I define a class instance variable called </span><span class="cls_030">@type</span><span class="cls_007"> in</span></div>
<div style="position:absolute;left:123.00px;top:66.28px" class="cls_007"><span class="cls_007">the </span><span class="cls_030">Mathematician</span><span class="cls_007"> class and set its value to the string </span><span class="cls_030">General</span><span class="cls_007">. Next, I create</span></div>
<div style="position:absolute;left:123.00px;top:78.28px" class="cls_007"><span class="cls_007">a second class called </span><span class="cls_030">Statistician</span><span class="cls_007">, which is a subclass of </span><span class="cls_030">Mathematician</span><span class="cls_007">, and</span></div>
<div style="position:absolute;left:123.00px;top:90.28px" class="cls_007"><span class="cls_007">change the value of </span><span class="cls_030">@type</span><span class="cls_007"> to the string </span><span class="cls_030">Statistics</span><span class="cls_007">.</span></div>
<div style="position:absolute;left:123.00px;top:114.28px" class="cls_030"><span class="cls_030">class Mathematician</span></div>
<div style="position:absolute;left:131.50px;top:124.78px" class="cls_030"><span class="cls_030">@type = "General"</span></div>
<div style="position:absolute;left:131.50px;top:135.27px" class="cls_030"><span class="cls_030">def self.type</span></div>
<div style="position:absolute;left:140.00px;top:145.77px" class="cls_030"><span class="cls_030">@type</span></div>
<div style="position:absolute;left:131.50px;top:156.27px" class="cls_030"><span class="cls_030">end</span></div>
<div style="position:absolute;left:123.00px;top:166.77px" class="cls_030"><span class="cls_030">end</span></div>
<div style="position:absolute;left:123.00px;top:187.77px" class="cls_030"><span class="cls_030">class Statistician &lt; Mathematician</span></div>
<div style="position:absolute;left:131.50px;top:198.27px" class="cls_030"><span class="cls_030">@type = "Statistics"</span></div>
<div style="position:absolute;left:123.00px;top:208.77px" class="cls_030"><span class="cls_030">end</span></div>
<div style="position:absolute;left:123.00px;top:229.77px" class="cls_030"><span class="cls_030">puts Statistician.type</span></div>
<div style="position:absolute;left:111.00px;top:240.27px" class="cls_046"><span class="cls_046">u</span><span class="cls_030">  => Statistics</span></div>
<div style="position:absolute;left:123.00px;top:250.76px" class="cls_030"><span class="cls_030">puts Mathematician.type</span></div>
<div style="position:absolute;left:111.00px;top:261.26px" class="cls_046"><span class="cls_046">v</span><span class="cls_030">  => General</span></div>
<div style="position:absolute;left:123.00px;top:283.76px" class="cls_038"><span class="cls_038">Listing 5-14: Each class and subclass has its own instance variables.</span></div>
<div style="position:absolute;left:141.00px;top:306.28px" class="cls_007"><span class="cls_007">Notice that the values of </span><span class="cls_030">@type</span><span class="cls_007"> in </span><span class="cls_030">Statistician</span><span class="cls_007"> at </span><span class="cls_050">u</span><span class="cls_007"> and </span><span class="cls_030">Mathematician</span><span class="cls_007"> at </span><span class="cls_050">v</span></div>
<div style="position:absolute;left:123.00px;top:318.28px" class="cls_007"><span class="cls_007">are different. Each class has its own separate copy of </span><span class="cls_030">@type</span><span class="cls_007">.</span></div>
<div style="position:absolute;left:141.00px;top:330.28px" class="cls_007"><span class="cls_007">However, if I use a class variable instead, Ruby shares that value between</span></div>
<div style="position:absolute;left:123.00px;top:342.28px" class="cls_030"><span class="cls_030">Mathematician</span><span class="cls_007"> and </span><span class="cls_030">Statistician</span><span class="cls_007">, as demonstrated in Listing 5-15.</span></div>
<div style="position:absolute;left:123.00px;top:366.28px" class="cls_030"><span class="cls_030">class Mathematician</span></div>
<div style="position:absolute;left:131.50px;top:376.78px" class="cls_030"><span class="cls_030">@@type = "General"</span></div>
<div style="position:absolute;left:131.50px;top:387.27px" class="cls_030"><span class="cls_030">def self.type</span></div>
<div style="position:absolute;left:140.00px;top:397.77px" class="cls_030"><span class="cls_030">@@type</span></div>
<div style="position:absolute;left:131.50px;top:408.27px" class="cls_030"><span class="cls_030">end</span></div>
<div style="position:absolute;left:123.00px;top:418.77px" class="cls_030"><span class="cls_030">end</span></div>
<div style="position:absolute;left:123.00px;top:439.77px" class="cls_030"><span class="cls_030">class Statistician &lt; Mathematician</span></div>
<div style="position:absolute;left:131.50px;top:450.27px" class="cls_030"><span class="cls_030">@@type = "Statistics"</span></div>
<div style="position:absolute;left:123.00px;top:460.77px" class="cls_030"><span class="cls_030">end</span></div>
<div style="position:absolute;left:123.00px;top:481.77px" class="cls_030"><span class="cls_030">puts Statistician.type</span></div>
<div style="position:absolute;left:111.00px;top:492.27px" class="cls_046"><span class="cls_046">u</span><span class="cls_030">  => Statistics</span></div>
<div style="position:absolute;left:123.00px;top:502.76px" class="cls_030"><span class="cls_030">puts Mathematician.type</span></div>
<div style="position:absolute;left:111.00px;top:513.26px" class="cls_046"><span class="cls_046">v</span><span class="cls_030">  => Statistics</span></div>
<div style="position:absolute;left:123.00px;top:535.76px" class="cls_038"><span class="cls_038">Listing 5-15: Ruby shares class variables among a class and all of its subclasses.</span></div>
<div style="position:absolute;left:141.00px;top:558.28px" class="cls_007"><span class="cls_007">Here, Ruby shows the same value for </span><span class="cls_030">@@type</span><span class="cls_007"> in </span><span class="cls_030">Statistician</span><span class="cls_007"> at </span><span class="cls_050">u</span><span class="cls_007"> and in</span></div>
<div style="position:absolute;left:123.00px;top:570.28px" class="cls_030"><span class="cls_030">Mathematician</span><span class="cls_007"> at </span><span class="cls_050">v</span><span class="cls_007">.</span></div>
<div style="position:absolute;left:374.87px;top:636.00px" class="cls_021"><span class="cls_021">Objects and Classes</span></div>
<div style="position:absolute;left:443.20px;top:633.00px" class="cls_020"><span class="cls_020">121</span></div>
</div>
<div style="position:absolute;left:50%;margin-left:-252px;top:95992px;width:504px;height:666px;border-style:outset;overflow:hidden">
<div style="position:absolute;left:0px;top:0px">
<img src="e698b76e-46bd-11eb-8b25-0cc47a792c0a_id_e698b76e-46bd-11eb-8b25-0cc47a792c0a_files/background146.jpg" width=504 height=666></div>
<div style="position:absolute;left:138.00px;top:42.28px" class="cls_007"><span class="cls_007">Internally, however, Ruby actually saves</span></div>
<div style="position:absolute;left:345.86px;top:50.25px" class="cls_042"><span class="cls_042">RClass</span></div>
<div style="position:absolute;left:120.00px;top:54.28px" class="cls_007"><span class="cls_007">both class variables and class instance</span></div>
<div style="position:absolute;left:376.17px;top:63.81px" class="cls_017"><span class="cls_017">class-level</span></div>
<div style="position:absolute;left:120.00px;top:66.28px" class="cls_007"><span class="cls_007">variables in the same table inside the</span></div>
<div style="position:absolute;left:358.89px;top:72.54px" class="cls_017"><span class="cls_017">instance variables:</span></div>
<div style="position:absolute;left:120.00px;top:78.28px" class="cls_030"><span class="cls_030">RClass</span><span class="cls_007"> structure. Figure 5-16 shows how the</span></div>
<div style="position:absolute;left:385.25px;top:89.78px" class="cls_067"><span class="cls_067">@type</span></div>
<div style="position:absolute;left:120.00px;top:90.28px" class="cls_030"><span class="cls_030">Mathematician</span><span class="cls_007"> class would save the </span><span class="cls_030">@type</span><span class="cls_007"> and</span></div>
<div style="position:absolute;left:120.00px;top:102.28px" class="cls_030"><span class="cls_030">@@type</span><span class="cls_007"> values if you created both of them.</span></div>
<div style="position:absolute;left:383.25px;top:107.25px" class="cls_067"><span class="cls_067">@@type</span></div>
<div style="position:absolute;left:120.00px;top:114.28px" class="cls_007"><span class="cls_007">The extra </span><span class="cls_030">@</span><span class="cls_007"> symbol in the name allows Ruby</span></div>
<div style="position:absolute;left:120.00px;top:126.28px" class="cls_007"><span class="cls_007">to distinguish between the two types of</span></div>
<div style="position:absolute;left:120.00px;top:138.28px" class="cls_007"><span class="cls_007">variables.</span></div>
<div style="position:absolute;left:339.00px;top:143.29px" class="cls_038"><span class="cls_038">Figure 5-16: Ruby saves class</span></div>
<div style="position:absolute;left:339.00px;top:153.79px" class="cls_038"><span class="cls_038">variables and class instance</span></div>
<div style="position:absolute;left:339.00px;top:164.29px" class="cls_038"><span class="cls_038">variables in the same table.</span></div>
<div style="position:absolute;left:120.00px;top:193.28px" class="cls_055"><span class="cls_055">Getting and Setting Class Variables</span></div>
<div style="position:absolute;left:120.00px;top:211.28px" class="cls_007"><span class="cls_007">It’s true: Ruby saves both class variables and class instance variables in the</span></div>
<div style="position:absolute;left:120.00px;top:223.28px" class="cls_007"><span class="cls_007">same table. However, the ways Ruby gets or sets these two types of variables</span></div>
<div style="position:absolute;left:120.00px;top:235.28px" class="cls_007"><span class="cls_007">are quite different.</span></div>
<div style="position:absolute;left:138.00px;top:247.28px" class="cls_007"><span class="cls_007">When you get or set a class instance variable, Ruby looks up the variable</span></div>
<div style="position:absolute;left:120.00px;top:259.28px" class="cls_007"><span class="cls_007">in the </span><span class="cls_030">RClass</span><span class="cls_007"> structure corresponding to the target class and either saves or</span></div>
<div style="position:absolute;left:120.00px;top:271.28px" class="cls_007"><span class="cls_007">retrieves the value. Figure 5-17 shows how Ruby saves the class instance vari-</span></div>
<div style="position:absolute;left:120.00px;top:283.28px" class="cls_007"><span class="cls_007">ables from Listing 5-14.</span></div>
<div style="position:absolute;left:244.06px;top:311.46px" class="cls_042"><span class="cls_042">RClass: Mathematician</span></div>
<div style="position:absolute;left:277.97px;top:326.17px" class="cls_017"><span class="cls_017">class-level</span></div>
<div style="position:absolute;left:260.69px;top:335.33px" class="cls_017"><span class="cls_017">instance variables:</span></div>
<div style="position:absolute;left:120.00px;top:339.78px" class="cls_033"><span class="cls_033">class </span><span class="cls_042">Mathematician</span></div>
<div style="position:absolute;left:129.00px;top:353.18px" class="cls_033"><span class="cls_033">@type = "General"</span></div>
<div style="position:absolute;left:279.06px;top:353.00px" class="cls_014"><span class="cls_014">"General"</span></div>
<div style="position:absolute;left:120.00px;top:366.57px" class="cls_033"><span class="cls_033">end</span></div>
<div style="position:absolute;left:285.06px;top:371.33px" class="cls_014"><span class="cls_014">etc...</span></div>
<div style="position:absolute;left:244.06px;top:433.66px" class="cls_042"><span class="cls_042">RClass: Statistician</span></div>
<div style="position:absolute;left:277.97px;top:449.07px" class="cls_017"><span class="cls_017">class-level</span></div>
<div style="position:absolute;left:260.69px;top:458.24px" class="cls_017"><span class="cls_017">instance variables:</span></div>
<div style="position:absolute;left:120.00px;top:461.39px" class="cls_033"><span class="cls_033">class </span><span class="cls_042">Statistician</span></div>
<div style="position:absolute;left:129.00px;top:474.79px" class="cls_033"><span class="cls_033">@type = "Statistics"</span></div>
<div style="position:absolute;left:273.06px;top:475.90px" class="cls_014"><span class="cls_014">"Statistics"</span></div>
<div style="position:absolute;left:120.00px;top:488.19px" class="cls_033"><span class="cls_033">end</span></div>
<div style="position:absolute;left:285.06px;top:494.22px" class="cls_014"><span class="cls_014">etc...</span></div>
<div style="position:absolute;left:120.00px;top:527.71px" class="cls_038"><span class="cls_038">Figure 5-17: Ruby saves class instance variables in the </span><span class="cls_014">RClass</span></div>
<div style="position:absolute;left:120.00px;top:538.21px" class="cls_038"><span class="cls_038">structure of the target class.</span></div>
<div style="position:absolute;left:48.00px;top:633.00px" class="cls_020"><span class="cls_020">122</span></div>
<div style="position:absolute;left:74.04px;top:636.00px" class="cls_021"><span class="cls_021">Chapter 5</span></div>
</div>
<div style="position:absolute;left:50%;margin-left:-252px;top:96668px;width:504px;height:666px;border-style:outset;overflow:hidden">
<div style="position:absolute;left:0px;top:0px">
<img src="e698b76e-46bd-11eb-8b25-0cc47a792c0a_id_e698b76e-46bd-11eb-8b25-0cc47a792c0a_files/background147.jpg" width=504 height=666></div>
<div style="position:absolute;left:141.00px;top:41.60px" class="cls_007"><span class="cls_007">At the top of the figure, you can see a line of code that saves a class</span></div>
<div style="position:absolute;left:123.00px;top:53.60px" class="cls_007"><span class="cls_007">instance variable in </span><span class="cls_030">Mathematician</span><span class="cls_007">. Below that is a similar line of code that</span></div>
<div style="position:absolute;left:123.00px;top:65.60px" class="cls_007"><span class="cls_007">saves a value in </span><span class="cls_030">Statistician</span><span class="cls_007">. In both cases, Ruby saves the class instance</span></div>
<div style="position:absolute;left:123.00px;top:77.60px" class="cls_007"><span class="cls_007">variable in the </span><span class="cls_030">RClass</span><span class="cls_007"> structure for the current class.</span></div>
<div style="position:absolute;left:141.00px;top:89.60px" class="cls_007"><span class="cls_007">Ruby uses a more complex algorithm for class variables. To produce the</span></div>
<div style="position:absolute;left:123.00px;top:101.60px" class="cls_007"><span class="cls_007">behavior we saw in Listing 5-15, Ruby needs to search through all the super-</span></div>
<div style="position:absolute;left:123.00px;top:113.60px" class="cls_007"><span class="cls_007">classes to see whether any of them define the same class variable. Figure 5-18</span></div>
<div style="position:absolute;left:123.00px;top:125.60px" class="cls_007"><span class="cls_007">shows an example.</span></div>
<div style="position:absolute;left:328.07px;top:159.78px" class="cls_042"><span class="cls_042">RClass: Mathematician</span></div>
<div style="position:absolute;left:361.98px;top:174.49px" class="cls_017"><span class="cls_017">class-level</span></div>
<div style="position:absolute;left:344.70px;top:183.65px" class="cls_017"><span class="cls_017">instance variables:</span></div>
<div style="position:absolute;left:278.31px;top:193.56px" class="cls_017"><span class="cls_017">class var</span></div>
<div style="position:absolute;left:363.06px;top:201.32px" class="cls_014"><span class="cls_014">"General"</span></div>
<div style="position:absolute;left:279.01px;top:203.05px" class="cls_017"><span class="cls_017">present?</span></div>
<div style="position:absolute;left:384.51px;top:272.01px" class="cls_017"><span class="cls_017">super</span></div>
<div style="position:absolute;left:327.07px;top:307.10px" class="cls_042"><span class="cls_042">RClass: Statistician</span></div>
<div style="position:absolute;left:360.98px;top:322.51px" class="cls_017"><span class="cls_017">class-level</span></div>
<div style="position:absolute;left:123.00px;top:332.06px" class="cls_033"><span class="cls_033">class </span><span class="cls_042">Statistician</span></div>
<div style="position:absolute;left:343.70px;top:331.68px" class="cls_017"><span class="cls_017">instance variables:</span></div>
<div style="position:absolute;left:132.00px;top:345.45px" class="cls_033"><span class="cls_033">@@type = "Statistics"</span></div>
<div style="position:absolute;left:278.31px;top:344.93px" class="cls_017"><span class="cls_017">class var</span></div>
<div style="position:absolute;left:279.01px;top:354.43px" class="cls_017"><span class="cls_017">present?</span></div>
<div style="position:absolute;left:123.00px;top:358.85px" class="cls_033"><span class="cls_033">end</span></div>
<div style="position:absolute;left:123.00px;top:401.16px" class="cls_038"><span class="cls_038">Figure 5-18: Before saving it, Ruby checks whether the class variable exists in the</span></div>
<div style="position:absolute;left:123.00px;top:411.65px" class="cls_038"><span class="cls_038">target class or any of its superclasses.</span></div>
<div style="position:absolute;left:141.00px;top:440.16px" class="cls_007"><span class="cls_007">When you save a class variable, Ruby looks in the target class and</span></div>
<div style="position:absolute;left:123.00px;top:452.16px" class="cls_007"><span class="cls_007">all of its superclasses for an existing variable. It will find </span><span class="cls_030">@@type</span><span class="cls_007"> in the</span></div>
<div style="position:absolute;left:123.00px;top:464.16px" class="cls_007"><span class="cls_007">highest superclass. In Figure 5-18 you can see Ruby checks both the</span></div>
<div style="position:absolute;left:123.00px;top:476.16px" class="cls_030"><span class="cls_030">Statistician</span><span class="cls_007"> and </span><span class="cls_030">Mathematician</span><span class="cls_007"> classes when saving the </span><span class="cls_030">@@type</span><span class="cls_007"> class vari-</span></div>
<div style="position:absolute;left:123.00px;top:488.16px" class="cls_007"><span class="cls_007">able in </span><span class="cls_030">Statistician</span><span class="cls_007">. Because I already saved the same class variable in</span></div>
<div style="position:absolute;left:123.00px;top:500.16px" class="cls_030"><span class="cls_030">Mathematician</span><span class="cls_007"> (Listing 5-15), Ruby will use that and overwrite it with the</span></div>
<div style="position:absolute;left:123.00px;top:512.16px" class="cls_007"><span class="cls_007">new value, as shown in Figure 5-19.</span></div>
<div style="position:absolute;left:374.60px;top:636.00px" class="cls_021"><span class="cls_021">Objects and Classes</span></div>
<div style="position:absolute;left:442.93px;top:633.00px" class="cls_020"><span class="cls_020">123</span></div>
</div>
<div style="position:absolute;left:50%;margin-left:-252px;top:97344px;width:504px;height:666px;border-style:outset;overflow:hidden">
<div style="position:absolute;left:0px;top:0px">
<img src="e698b76e-46bd-11eb-8b25-0cc47a792c0a_id_e698b76e-46bd-11eb-8b25-0cc47a792c0a_files/background148.jpg" width=504 height=666></div>
<div style="position:absolute;left:314.49px;top:50.78px" class="cls_042"><span class="cls_042">RClass: Mathematician</span></div>
<div style="position:absolute;left:348.40px;top:65.49px" class="cls_017"><span class="cls_017">class-level</span></div>
<div style="position:absolute;left:331.13px;top:74.65px" class="cls_017"><span class="cls_017">instance variables:</span></div>
<div style="position:absolute;left:343.49px;top:92.32px" class="cls_014"><span class="cls_014">"Statistics"</span></div>
<div style="position:absolute;left:371.84px;top:157.73px" class="cls_017"><span class="cls_017">super</span></div>
<div style="position:absolute;left:313.44px;top:185.92px" class="cls_042"><span class="cls_042">RClass: Statistician</span></div>
<div style="position:absolute;left:347.35px;top:201.33px" class="cls_017"><span class="cls_017">class-level</span></div>
<div style="position:absolute;left:330.07px;top:210.50px" class="cls_017"><span class="cls_017">instance variables:</span></div>
<div style="position:absolute;left:120.00px;top:215.53px" class="cls_033"><span class="cls_033">class </span><span class="cls_042">Statistician</span></div>
<div style="position:absolute;left:129.00px;top:228.93px" class="cls_033"><span class="cls_033">@@type = "Statistics"</span></div>
<div style="position:absolute;left:120.00px;top:242.33px" class="cls_033"><span class="cls_033">end</span></div>
<div style="position:absolute;left:120.00px;top:279.97px" class="cls_038"><span class="cls_038">Figure 5-19: Ruby uses the class variable copy found in the highest superclass.</span></div>
<div style="position:absolute;left:120.00px;top:315.47px" class="cls_055"><span class="cls_055">Constants</span></div>
<div style="position:absolute;left:120.00px;top:333.47px" class="cls_007"><span class="cls_007">We have one more feature of Ruby classes to cover: </span><span class="cls_008">constants</span><span class="cls_007">. As you may</span></div>
<div style="position:absolute;left:120.00px;top:345.47px" class="cls_007"><span class="cls_007">know, Ruby allows you to define constant values inside a class, like this:</span></div>
<div style="position:absolute;left:120.00px;top:369.47px" class="cls_030"><span class="cls_030">class Mathematician &lt; Person</span></div>
<div style="position:absolute;left:128.50px;top:379.97px" class="cls_030"><span class="cls_030">AREA_OF_EXPERTISE = "Mathematics"</span></div>
<div style="position:absolute;left:128.50px;top:390.47px" class="cls_030"><span class="cls_030">--snip--</span></div>
<div style="position:absolute;left:138.00px;top:412.97px" class="cls_007"><span class="cls_007">Constant values must start with a capital letter, and they are valid</span></div>
<div style="position:absolute;left:120.00px;top:424.97px" class="cls_007"><span class="cls_007">within the scope of the current class. (Curiously, Ruby allows you to change</span></div>
<div style="position:absolute;left:120.00px;top:436.97px" class="cls_007"><span class="cls_007">a constant value, but it will display a warning when you do so.) Let’s add a</span></div>
<div style="position:absolute;left:120.00px;top:448.97px" class="cls_007"><span class="cls_007">constant table to our </span><span class="cls_030">RClass</span><span class="cls_007"> structure, because Ruby must save these values</span></div>
<div style="position:absolute;left:120.00px;top:460.97px" class="cls_007"><span class="cls_007">inside each class, as shown in Figure 5-20.</span></div>
<div style="position:absolute;left:138.00px;top:472.97px" class="cls_007"><span class="cls_007">Now we can write a complete, technical definition of a Ruby class:</span></div>
<div style="position:absolute;left:156.00px;top:491.97px" class="cls_033"><span class="cls_033">A Ruby class is a Ruby object that also contains method definitions,</span></div>
<div style="position:absolute;left:156.00px;top:503.97px" class="cls_033"><span class="cls_033">attribute names, a superclass pointer, and a constants table.</span></div>
<div style="position:absolute;left:138.00px;top:520.97px" class="cls_007"><span class="cls_007">Granted, this isn’t as concise as the simple definition we had for a Ruby</span></div>
<div style="position:absolute;left:120.00px;top:532.97px" class="cls_007"><span class="cls_007">object, but each Ruby class contains much more information than each</span></div>
<div style="position:absolute;left:120.00px;top:544.97px" class="cls_007"><span class="cls_007">Ruby object. Ruby classes are obviously fundamental to the language.</span></div>
<div style="position:absolute;left:48.00px;top:633.00px" class="cls_020"><span class="cls_020">124</span></div>
<div style="position:absolute;left:73.92px;top:636.00px" class="cls_021"><span class="cls_021">Chapter 5</span></div>
</div>
<div style="position:absolute;left:50%;margin-left:-252px;top:98020px;width:504px;height:666px;border-style:outset;overflow:hidden">
<div style="position:absolute;left:0px;top:0px">
<img src="e698b76e-46bd-11eb-8b25-0cc47a792c0a_id_e698b76e-46bd-11eb-8b25-0cc47a792c0a_files/background149.jpg" width=504 height=666></div>
<div style="position:absolute;left:133.47px;top:52.91px" class="cls_112"><span class="cls_112">RClass</span></div>
<div style="position:absolute;left:230.48px;top:61.39px" class="cls_113"><span class="cls_113">instance-level</span></div>
<div style="position:absolute;left:147.78px;top:71.17px" class="cls_113"><span class="cls_113">method table:</span></div>
<div style="position:absolute;left:225.05px;top:70.57px" class="cls_113"><span class="cls_113">attribute names:</span></div>
<div style="position:absolute;left:311.91px;top:70.22px" class="cls_113"><span class="cls_113">class pointer:</span></div>
<div style="position:absolute;left:402.73px;top:76.81px" class="cls_112"><span class="cls_112">RClass</span></div>
<div style="position:absolute;left:154.49px;top:89.03px" class="cls_114"><span class="cls_114">first_name</span></div>
<div style="position:absolute;left:234.05px;top:89.03px" class="cls_114"><span class="cls_114">@first_name</span></div>
<div style="position:absolute;left:329.25px;top:89.03px" class="cls_114"><span class="cls_114">klass</span></div>
<div style="position:absolute;left:417.08px;top:89.03px" class="cls_114"><span class="cls_114">Class</span></div>
<div style="position:absolute;left:152.51px;top:107.40px" class="cls_114"><span class="cls_114">first_name=</span></div>
<div style="position:absolute;left:236.04px;top:107.40px" class="cls_114"><span class="cls_114">@last_name</span></div>
<div style="position:absolute;left:318.48px;top:118.00px" class="cls_113"><span class="cls_113">class-level</span></div>
<div style="position:absolute;left:156.47px;top:125.76px" class="cls_114"><span class="cls_114">last_name</span></div>
<div style="position:absolute;left:301.37px;top:127.18px" class="cls_113"><span class="cls_113">instance variables:</span></div>
<div style="position:absolute;left:154.49px;top:144.12px" class="cls_114"><span class="cls_114">last_name=</span></div>
<div style="position:absolute;left:325.29px;top:144.83px" class="cls_114"><span class="cls_114">@value1</span></div>
<div style="position:absolute;left:325.29px;top:163.19px" class="cls_114"><span class="cls_114">@value2</span></div>
<div style="position:absolute;left:146.08px;top:172.58px" class="cls_113"><span class="cls_113">constant table:</span></div>
<div style="position:absolute;left:140.63px;top:190.22px" class="cls_114"><span class="cls_114">AREA_OF_EXPERTISE</span></div>
<div style="position:absolute;left:316.32px;top:189.06px" class="cls_113"><span class="cls_113">superclass:</span></div>
<div style="position:absolute;left:402.73px;top:196.17px" class="cls_112"><span class="cls_112">RClass</span></div>
<div style="position:absolute;left:162.41px;top:208.58px" class="cls_114"><span class="cls_114">etc...</span></div>
<div style="position:absolute;left:329.25px;top:207.88px" class="cls_114"><span class="cls_114">super</span></div>
<div style="position:absolute;left:415.10px;top:208.39px" class="cls_114"><span class="cls_114">Person</span></div>
<div style="position:absolute;left:123.00px;top:255.69px" class="cls_038"><span class="cls_038">Figure 5-20: Ruby classes also contain a constants table.</span></div>
<div style="position:absolute;left:123.00px;top:291.19px" class="cls_055"><span class="cls_055">The Actual RClass Structure</span></div>
<div style="position:absolute;left:123.00px;top:309.19px" class="cls_007"><span class="cls_007">Having built up a conceptual model for what information must be stored in</span></div>
<div style="position:absolute;left:123.00px;top:321.19px" class="cls_030"><span class="cls_030">RClass</span><span class="cls_007">, let’s look at the actual structure that Ruby uses to represent classes,</span></div>
<div style="position:absolute;left:123.00px;top:333.19px" class="cls_007"><span class="cls_007">as shown in Figure 5-21.</span></div>
<div style="position:absolute;left:141.00px;top:345.19px" class="cls_007"><span class="cls_007">As you can see, Ruby uses two separate structures to represent each</span></div>
<div style="position:absolute;left:123.00px;top:357.19px" class="cls_007"><span class="cls_007">class: </span><span class="cls_030">RClass</span><span class="cls_007"> and </span><span class="cls_030">rb_classext_struct</span><span class="cls_007">. But these two structures act as one</span></div>
<div style="position:absolute;left:123.00px;top:369.19px" class="cls_007"><span class="cls_007">large structure because each </span><span class="cls_030">RClass</span><span class="cls_007"> always contains a pointer (</span><span class="cls_030">ptr</span><span class="cls_007">) to a cor-</span></div>
<div style="position:absolute;left:123.00px;top:381.19px" class="cls_007"><span class="cls_007">responding </span><span class="cls_030">rb_classext_struct</span><span class="cls_007">. You might guess that the Ruby core team</span></div>
<div style="position:absolute;left:123.00px;top:393.19px" class="cls_007"><span class="cls_007">decided to use two different structures because there are so many different</span></div>
<div style="position:absolute;left:123.00px;top:405.19px" class="cls_007"><span class="cls_007">values to save, but in fact they probably created </span><span class="cls_030">rb_classext_struct</span><span class="cls_007"> to save</span></div>
<div style="position:absolute;left:123.00px;top:417.19px" class="cls_007"><span class="cls_007">internal values that they didn’t want to expose in the public Ruby C exten-</span></div>
<div style="position:absolute;left:123.00px;top:429.19px" class="cls_007"><span class="cls_007">sion API.</span></div>
<div style="position:absolute;left:141.00px;top:441.19px" class="cls_007"><span class="cls_007">Like </span><span class="cls_030">RObject</span><span class="cls_007">, </span><span class="cls_030">RClass</span><span class="cls_007"> has a </span><span class="cls_030">VALUE</span><span class="cls_007"> pointer (shown on the left of Figure 5-21).</span></div>
<div style="position:absolute;left:123.00px;top:453.19px" class="cls_007"><span class="cls_007">Ruby always accesses classes using these </span><span class="cls_030">VALUE</span><span class="cls_007"> pointers. The right side of the</span></div>
<div style="position:absolute;left:123.00px;top:465.19px" class="cls_007"><span class="cls_007">figure shows the technical names for the fields:</span></div>
<div style="position:absolute;left:123.00px;top:486.19px" class="cls_050"><span class="cls_050">•</span><span class="cls_030">   flags</span><span class="cls_007"> and </span><span class="cls_030">klass</span><span class="cls_007"> are the same </span><span class="cls_030">RBasic</span><span class="cls_007"> values that every Ruby value contains.</span></div>
<div style="position:absolute;left:123.00px;top:501.19px" class="cls_050"><span class="cls_050">•</span><span class="cls_030">   m_tbl</span><span class="cls_007"> is the method table, a hash whose keys are the names, or IDs, of</span></div>
<div style="position:absolute;left:141.00px;top:513.19px" class="cls_007"><span class="cls_007">each method and whose values are pointers to the definition of each</span></div>
<div style="position:absolute;left:141.00px;top:525.19px" class="cls_007"><span class="cls_007">method, including the compiled YARV instructions.</span></div>
<div style="position:absolute;left:123.00px;top:540.19px" class="cls_050"><span class="cls_050">•</span><span class="cls_030">   iv_index_tbl</span><span class="cls_007"> is the attribute names table, a hash that maps each instance</span></div>
<div style="position:absolute;left:141.00px;top:552.19px" class="cls_007"><span class="cls_007">variable name to the index of the attribute’s value in each </span><span class="cls_030">RObject</span></div>
<div style="position:absolute;left:141.00px;top:564.19px" class="cls_007"><span class="cls_007">instance variable array.</span></div>
<div style="position:absolute;left:123.00px;top:579.19px" class="cls_050"><span class="cls_050">•</span><span class="cls_030">   super</span><span class="cls_007"> is a pointer to the </span><span class="cls_030">RClass</span><span class="cls_007"> structure for this class’s superclass.</span></div>
<div style="position:absolute;left:374.66px;top:636.00px" class="cls_021"><span class="cls_021">Objects and Classes</span></div>
<div style="position:absolute;left:442.99px;top:633.00px" class="cls_020"><span class="cls_020">125</span></div>
</div>
<div style="position:absolute;left:50%;margin-left:-252px;top:98696px;width:504px;height:666px;border-style:outset;overflow:hidden">
<div style="position:absolute;left:0px;top:0px">
<img src="e698b76e-46bd-11eb-8b25-0cc47a792c0a_id_e698b76e-46bd-11eb-8b25-0cc47a792c0a_files/background150.jpg" width=504 height=666></div>
<div style="position:absolute;left:251.07px;top:48.95px" class="cls_042"><span class="cls_042">RClass</span></div>
<div style="position:absolute;left:258.58px;top:67.86px" class="cls_042"><span class="cls_042">RBasic</span></div>
<div style="position:absolute;left:277.74px;top:84.16px" class="cls_014"><span class="cls_014">flags</span></div>
<div style="position:absolute;left:352.03px;top:105.80px" class="cls_017"><span class="cls_017">Class pointer</span></div>
<div style="position:absolute;left:277.74px;top:106.19px" class="cls_014"><span class="cls_014">klass</span></div>
<div style="position:absolute;left:152.75px;top:116.01px" class="cls_019"><span class="cls_019">VALUE</span></div>
<div style="position:absolute;left:277.74px;top:139.51px" class="cls_014"><span class="cls_014">m_tbl</span></div>
<div style="position:absolute;left:351.98px;top:139.42px" class="cls_017"><span class="cls_017">Method table</span></div>
<div style="position:absolute;left:351.95px;top:156.81px" class="cls_017"><span class="cls_017">Instance-level</span></div>
<div style="position:absolute;left:263.74px;top:161.69px" class="cls_014"><span class="cls_014">iv_index_tbl</span></div>
<div style="position:absolute;left:351.95px;top:166.61px" class="cls_017"><span class="cls_017">attribute names</span></div>
<div style="position:absolute;left:281.74px;top:181.83px" class="cls_014"><span class="cls_014">ptr</span></div>
<div style="position:absolute;left:251.50px;top:222.37px" class="cls_053"><span class="cls_053">rb_classext_struct</span></div>
<div style="position:absolute;left:277.74px;top:238.12px" class="cls_014"><span class="cls_014">super</span></div>
<div style="position:absolute;left:351.95px;top:237.76px" class="cls_017"><span class="cls_017">Superclass pointer</span></div>
<div style="position:absolute;left:351.95px;top:258.02px" class="cls_017"><span class="cls_017">Class-level</span></div>
<div style="position:absolute;left:275.74px;top:263.31px" class="cls_014"><span class="cls_014">iv_tbl</span></div>
<div style="position:absolute;left:351.95px;top:267.83px" class="cls_017"><span class="cls_017">instance variables</span></div>
<div style="position:absolute;left:269.74px;top:288.21px" class="cls_014"><span class="cls_014">const_tbl</span></div>
<div style="position:absolute;left:351.95px;top:288.32px" class="cls_017"><span class="cls_017">Constants table</span></div>
<div style="position:absolute;left:351.95px;top:308.60px" class="cls_017"><span class="cls_017">Used by</span></div>
<div style="position:absolute;left:275.74px;top:313.85px" class="cls_014"><span class="cls_014">origin</span></div>
<div style="position:absolute;left:351.95px;top:318.40px" class="cls_033"><span class="cls_033">Module#prepend</span></div>
<div style="position:absolute;left:351.95px;top:333.76px" class="cls_017"><span class="cls_017">Used to implement</span></div>
<div style="position:absolute;left:261.74px;top:339.01px" class="cls_014"><span class="cls_014">refined_class</span></div>
<div style="position:absolute;left:351.95px;top:343.56px" class="cls_017"><span class="cls_017">refinements</span></div>
<div style="position:absolute;left:351.95px;top:359.63px" class="cls_017"><span class="cls_017">Used to allocate memory</span></div>
<div style="position:absolute;left:269.74px;top:364.42px" class="cls_014"><span class="cls_014">allocator</span></div>
<div style="position:absolute;left:351.95px;top:369.43px" class="cls_017"><span class="cls_017">for new objects</span></div>
<div style="position:absolute;left:120.00px;top:392.63px" class="cls_038"><span class="cls_038">Figure 5-21: How Ruby actually represents a class</span></div>
<div style="position:absolute;left:120.00px;top:421.13px" class="cls_050"><span class="cls_050">•</span><span class="cls_030">   iv_tbl</span><span class="cls_007"> contains the class-level instance variables and class variables,</span></div>
<div style="position:absolute;left:138.00px;top:433.13px" class="cls_007"><span class="cls_007">including both their names and values.</span></div>
<div style="position:absolute;left:120.00px;top:448.13px" class="cls_050"><span class="cls_050">•</span><span class="cls_030">   const_tbl</span><span class="cls_007"> is a hash containing all of the constants (names and values)</span></div>
<div style="position:absolute;left:138.00px;top:460.13px" class="cls_007"><span class="cls_007">defined in this class’s scope. You can see that Ruby implements </span><span class="cls_030">iv_tbl</span></div>
<div style="position:absolute;left:138.00px;top:472.13px" class="cls_007"><span class="cls_007">and </span><span class="cls_030">const_tbl</span><span class="cls_007"> in the same way: Class-level instance variables and con-</span></div>
<div style="position:absolute;left:138.00px;top:484.13px" class="cls_007"><span class="cls_007">stants are almost the same thing.</span></div>
<div style="position:absolute;left:120.00px;top:499.13px" class="cls_050"><span class="cls_050">•</span><span class="cls_007">   Ruby uses </span><span class="cls_030">origin</span><span class="cls_007"> to implement the </span><span class="cls_030">Module#prepend</span><span class="cls_007"> feature. I’ll discuss</span></div>
<div style="position:absolute;left:138.00px;top:511.13px" class="cls_007"><span class="cls_007">what </span><span class="cls_030">prepend</span><span class="cls_007"> does and how Ruby implements it in Chapter 6.</span></div>
<div style="position:absolute;left:120.00px;top:526.13px" class="cls_050"><span class="cls_050">•</span><span class="cls_007">   Ruby uses the </span><span class="cls_030">refined_class</span><span class="cls_007"> pointer to implement the new experimental</span></div>
<div style="position:absolute;left:138.00px;top:538.13px" class="cls_007"><span class="cls_007">refinements feature, which I’ll discuss further in Chapter 9.</span></div>
<div style="position:absolute;left:120.00px;top:553.13px" class="cls_050"><span class="cls_050">•</span><span class="cls_007">   Finally, Ruby uses </span><span class="cls_030">allocator</span><span class="cls_007"> internally to allocate memory for new</span></div>
<div style="position:absolute;left:138.00px;top:565.13px" class="cls_007"><span class="cls_007">instances of this class.</span></div>
<div style="position:absolute;left:48.00px;top:633.00px" class="cls_020"><span class="cls_020">126</span></div>
<div style="position:absolute;left:73.98px;top:636.00px" class="cls_021"><span class="cls_021">Chapter 5</span></div>
</div>
<div style="position:absolute;left:50%;margin-left:-252px;top:99372px;width:504px;height:666px;border-style:outset;overflow:hidden">
<div style="position:absolute;left:0px;top:0px">
<img src="e698b76e-46bd-11eb-8b25-0cc47a792c0a_id_e698b76e-46bd-11eb-8b25-0cc47a792c0a_files/background151.jpg" width=504 height=666></div>
<div style="position:absolute;left:160.60px;top:61.31px" class="cls_020"><span class="cls_020">Reading the RClass C Structure Definition</span></div>
<div style="position:absolute;left:124.00px;top:79.81px" class="cls_039"><span class="cls_039">Now for a quick look at the actual </span><span class="cls_009">RClass</span><span class="cls_039"> structure definition, as shown in Listing 5-16.</span></div>
<div style="position:absolute;left:124.00px;top:102.31px" class="cls_009"><span class="cls_009">typedef struct rb_classext_struct rb_classext_t;</span></div>
<div style="position:absolute;left:124.00px;top:111.82px" class="cls_009"><span class="cls_009">struct RClass {</span></div>
<div style="position:absolute;left:139.00px;top:121.32px" class="cls_009"><span class="cls_009">struct RBasic basic;</span></div>
<div style="position:absolute;left:139.00px;top:130.82px" class="cls_009"><span class="cls_009">rb_classext_t *ptr;</span></div>
<div style="position:absolute;left:139.00px;top:140.32px" class="cls_009"><span class="cls_009">struct st_table *m_tbl;</span></div>
<div style="position:absolute;left:139.00px;top:149.83px" class="cls_009"><span class="cls_009">struct st_table *iv_index_tbl;</span></div>
<div style="position:absolute;left:124.00px;top:159.33px" class="cls_009"><span class="cls_009">};</span></div>
<div style="position:absolute;left:124.00px;top:181.81px" class="cls_043"><span class="cls_043">Listing 5-16: The definition of the </span><span class="cls_015">RClass</span><span class="cls_043"> C structure</span></div>
<div style="position:absolute;left:142.00px;top:204.81px" class="cls_039"><span class="cls_039">Like the </span><span class="cls_009">RObject</span><span class="cls_039"> definition we saw in Listing 5-7, this structure definition—including</span></div>
<div style="position:absolute;left:124.00px;top:216.81px" class="cls_039"><span class="cls_039">all of the values shown in Figure 5-21—can be found in the </span><span class="cls_044">include/ruby/ruby.h</span><span class="cls_039"> file.</span></div>
<div style="position:absolute;left:142.00px;top:228.81px" class="cls_039"><span class="cls_039">The </span><span class="cls_009">rb_classext_struct</span><span class="cls_039"> structure definition, on the other hand, can be found in</span></div>
<div style="position:absolute;left:124.00px;top:240.81px" class="cls_039"><span class="cls_039">the </span><span class="cls_044">internal.h</span><span class="cls_039"> C header file, as shown in Listing 5-17.</span></div>
<div style="position:absolute;left:124.00px;top:263.31px" class="cls_009"><span class="cls_009">struct rb_classext_struct {</span></div>
<div style="position:absolute;left:139.00px;top:272.82px" class="cls_009"><span class="cls_009">VALUE super;</span></div>
<div style="position:absolute;left:139.00px;top:282.32px" class="cls_009"><span class="cls_009">struct st_table *iv_tbl;</span></div>
<div style="position:absolute;left:139.00px;top:291.82px" class="cls_009"><span class="cls_009">struct st_table *const_tbl;</span></div>
<div style="position:absolute;left:139.00px;top:301.32px" class="cls_009"><span class="cls_009">VALUE origin;</span></div>
<div style="position:absolute;left:139.00px;top:310.83px" class="cls_009"><span class="cls_009">VALUE refined_class;</span></div>
<div style="position:absolute;left:139.00px;top:320.33px" class="cls_009"><span class="cls_009">rb_alloc_func_t allocator;</span></div>
<div style="position:absolute;left:124.00px;top:329.83px" class="cls_009"><span class="cls_009">};</span></div>
<div style="position:absolute;left:124.00px;top:352.31px" class="cls_043"><span class="cls_043">Listing 5-17: The definition of the </span><span class="cls_015">rb_classext_struct</span><span class="cls_043"> C structure</span></div>
<div style="position:absolute;left:142.00px;top:375.31px" class="cls_039"><span class="cls_039">Again, you can see the values from Figure 5-21. Notice that the </span><span class="cls_030">st_table</span><span class="cls_039"> C</span></div>
<div style="position:absolute;left:124.01px;top:387.32px" class="cls_039"><span class="cls_039">type appears four times in Listings 5-16 and 5-17; this is Ruby’s hash table data struc-</span></div>
<div style="position:absolute;left:124.01px;top:399.32px" class="cls_039"><span class="cls_039">ture. Internally, Ruby saves much of the information for each class using hash tables:</span></div>
<div style="position:absolute;left:124.01px;top:411.32px" class="cls_039"><span class="cls_039">the attribute names table, the method table, the class-level instance variable table,</span></div>
<div style="position:absolute;left:124.01px;top:423.32px" class="cls_039"><span class="cls_039">and the constants table.</span></div>
<div style="position:absolute;left:123.00px;top:469.83px" class="cls_031"><span class="cls_031">Experiment 5-2: Where Does Ruby Save Class</span></div>
<div style="position:absolute;left:123.00px;top:484.83px" class="cls_031"><span class="cls_031">Methods?</span></div>
<div style="position:absolute;left:123.00px;top:504.83px" class="cls_007"><span class="cls_007">We’ve seen how each </span><span class="cls_030">RClass</span><span class="cls_007"> structure saves all methods defined in a certain</span></div>
<div style="position:absolute;left:123.00px;top:516.83px" class="cls_007"><span class="cls_007">class. In this example, Ruby stores information about the </span><span class="cls_030">first_name</span><span class="cls_007"> method</span></div>
<div style="position:absolute;left:123.00px;top:528.83px" class="cls_007"><span class="cls_007">inside the </span><span class="cls_030">RClass</span><span class="cls_007"> structure for </span><span class="cls_030">Mathematician</span><span class="cls_007"> using the method table:</span></div>
<div style="position:absolute;left:123.00px;top:552.83px" class="cls_030"><span class="cls_030">class Mathematician</span></div>
<div style="position:absolute;left:131.50px;top:563.32px" class="cls_030"><span class="cls_030">def first_name</span></div>
<div style="position:absolute;left:140.00px;top:573.82px" class="cls_030"><span class="cls_030">@first_name</span></div>
<div style="position:absolute;left:131.50px;top:584.32px" class="cls_030"><span class="cls_030">end</span></div>
<div style="position:absolute;left:123.00px;top:594.82px" class="cls_030"><span class="cls_030">end</span></div>
<div style="position:absolute;left:374.63px;top:636.00px" class="cls_021"><span class="cls_021">Objects and Classes</span></div>
<div style="position:absolute;left:442.95px;top:633.00px" class="cls_020"><span class="cls_020">127</span></div>
</div>
<div style="position:absolute;left:50%;margin-left:-252px;top:100048px;width:504px;height:666px;border-style:outset;overflow:hidden">
<div style="position:absolute;left:0px;top:0px">
<img src="e698b76e-46bd-11eb-8b25-0cc47a792c0a_id_e698b76e-46bd-11eb-8b25-0cc47a792c0a_files/background152.jpg" width=504 height=666></div>
<div style="position:absolute;left:138.00px;top:42.28px" class="cls_007"><span class="cls_007">But what about class methods? It’s common in Ruby to save methods in</span></div>
<div style="position:absolute;left:120.00px;top:54.28px" class="cls_007"><span class="cls_007">a class directly, using the syntax shown in Listing 5-18.</span></div>
<div style="position:absolute;left:120.00px;top:78.28px" class="cls_030"><span class="cls_030">class Mathematician</span></div>
<div style="position:absolute;left:128.50px;top:88.78px" class="cls_030"><span class="cls_030">def self.class_method</span></div>
<div style="position:absolute;left:137.00px;top:99.28px" class="cls_030"><span class="cls_030">puts "This is a class method."</span></div>
<div style="position:absolute;left:128.50px;top:109.77px" class="cls_030"><span class="cls_030">end</span></div>
<div style="position:absolute;left:120.00px;top:120.27px" class="cls_030"><span class="cls_030">end</span></div>
<div style="position:absolute;left:120.00px;top:142.77px" class="cls_038"><span class="cls_038">Listing 5-18: Defining a class method using </span><span class="cls_014">def self</span></div>
<div style="position:absolute;left:138.00px;top:165.28px" class="cls_007"><span class="cls_007">Alternatively, you can use the syntax shown in Listing 5-19.</span></div>
<div style="position:absolute;left:120.00px;top:189.28px" class="cls_030"><span class="cls_030">class Mathematician</span></div>
<div style="position:absolute;left:128.50px;top:199.78px" class="cls_030"><span class="cls_030">class &lt;&lt; self</span></div>
<div style="position:absolute;left:137.00px;top:210.27px" class="cls_030"><span class="cls_030">def class_method</span></div>
<div style="position:absolute;left:145.50px;top:220.77px" class="cls_030"><span class="cls_030">puts "This is a class method."</span></div>
<div style="position:absolute;left:137.00px;top:231.27px" class="cls_030"><span class="cls_030">end</span></div>
<div style="position:absolute;left:128.50px;top:241.77px" class="cls_030"><span class="cls_030">end</span></div>
<div style="position:absolute;left:120.00px;top:252.27px" class="cls_030"><span class="cls_030">end</span></div>
<div style="position:absolute;left:120.00px;top:274.76px" class="cls_038"><span class="cls_038">Listing 5-19: Defining a class method using </span><span class="cls_014">class &lt;&lt; self</span></div>
<div style="position:absolute;left:138.00px;top:297.28px" class="cls_007"><span class="cls_007">Are they saved in the </span><span class="cls_030">RClass</span><span class="cls_007"> structure along with the normal methods</span></div>
<div style="position:absolute;left:120.00px;top:309.28px" class="cls_007"><span class="cls_007">for each class, perhaps with a flag to indicate they are class methods and</span></div>
<div style="position:absolute;left:120.00px;top:321.28px" class="cls_007"><span class="cls_007">not normal methods? Or are they saved somewhere else? Let’s find out!</span></div>
<div style="position:absolute;left:138.00px;top:333.28px" class="cls_007"><span class="cls_007">It’s easy to see where class methods are </span><span class="cls_008">not</span><span class="cls_007"> saved. They are obviously</span></div>
<div style="position:absolute;left:120.00px;top:345.28px" class="cls_007"><span class="cls_007">not saved in the </span><span class="cls_030">RClass</span><span class="cls_007"> method table along with normal methods, because</span></div>
<div style="position:absolute;left:120.00px;top:357.28px" class="cls_007"><span class="cls_007">instances of </span><span class="cls_030">Mathematician</span><span class="cls_007"> cannot call them, as demonstrated here:</span></div>
<div style="position:absolute;left:120.00px;top:381.28px" class="cls_030"><span class="cls_030">></span><span class="cls_040"> obj = Mathematician.new</span></div>
<div style="position:absolute;left:120.00px;top:391.78px" class="cls_030"><span class="cls_030">></span><span class="cls_040"> obj.class_method</span></div>
<div style="position:absolute;left:124.25px;top:402.27px" class="cls_030"><span class="cls_030">=> undefined method `class_method' for</span></div>
<div style="position:absolute;left:120.00px;top:412.77px" class="cls_030"><span class="cls_030">#&lt; Mathematician:0x007fdd8384d1c8 (NoMethodError)</span></div>
<div style="position:absolute;left:138.00px;top:435.28px" class="cls_007"><span class="cls_007">Now, keeping in mind that </span><span class="cls_030">Mathematician</span><span class="cls_007"> is also a Ruby object, recall the</span></div>
<div style="position:absolute;left:120.00px;top:447.28px" class="cls_007"><span class="cls_007">following definition:</span></div>
<div style="position:absolute;left:156.00px;top:466.28px" class="cls_033"><span class="cls_033">A Ruby class is a Ruby object that also contains method defini-</span></div>
<div style="position:absolute;left:156.00px;top:478.28px" class="cls_033"><span class="cls_033">tions, attribute names, a superclass pointer, and a constants table.</span></div>
<div style="position:absolute;left:138.00px;top:495.28px" class="cls_007"><span class="cls_007">We assume that Ruby should save methods for </span><span class="cls_030">Mathematician</span><span class="cls_007"> just as it saves</span></div>
<div style="position:absolute;left:120.00px;top:507.28px" class="cls_007"><span class="cls_007">them for any object: in the method table for the object’s class. In other words,</span></div>
<div style="position:absolute;left:120.00px;top:519.28px" class="cls_007"><span class="cls_007">Ruby should get </span><span class="cls_030">Mathematician</span><span class="cls_007">’s class using the </span><span class="cls_030">klass</span><span class="cls_007"> pointer and save the</span></div>
<div style="position:absolute;left:120.00px;top:531.28px" class="cls_007"><span class="cls_007">method in the method table in that </span><span class="cls_030">RClass</span><span class="cls_007"> structure, as shown in Figure 5-22.</span></div>
<div style="position:absolute;left:48.00px;top:633.00px" class="cls_020"><span class="cls_020">128</span></div>
<div style="position:absolute;left:74.04px;top:636.00px" class="cls_021"><span class="cls_021">Chapter 5</span></div>
</div>
<div style="position:absolute;left:50%;margin-left:-252px;top:100724px;width:504px;height:666px;border-style:outset;overflow:hidden">
<div style="position:absolute;left:0px;top:0px">
<img src="e698b76e-46bd-11eb-8b25-0cc47a792c0a_id_e698b76e-46bd-11eb-8b25-0cc47a792c0a_files/background153.jpg" width=504 height=666></div>
<div style="position:absolute;left:136.53px;top:43.54px" class="cls_033"><span class="cls_033">Mathematician</span></div>
<div style="position:absolute;left:265.74px;top:43.54px" class="cls_033"><span class="cls_033">Class</span></div>
<div style="position:absolute;left:354.71px;top:57.95px" class="cls_014"><span class="cls_014">"class_method"</span></div>
<div style="position:absolute;left:128.79px;top:62.65px" class="cls_042"><span class="cls_042">RClass</span></div>
<div style="position:absolute;left:240.01px;top:62.65px" class="cls_042"><span class="cls_042">RClass</span></div>
<div style="position:absolute;left:155.78px;top:75.08px" class="cls_014"><span class="cls_014">klass</span></div>
<div style="position:absolute;left:266.99px;top:75.17px" class="cls_014"><span class="cls_014">m_tbl</span></div>
<div style="position:absolute;left:370.71px;top:75.17px" class="cls_014"><span class="cls_014">etc...</span></div>
<div style="position:absolute;left:123.00px;top:114.97px" class="cls_038"><span class="cls_038">Figure 5-22: Shouldn’t Ruby save class methods in the method table for the class’s class?</span></div>
<div style="position:absolute;left:141.00px;top:137.47px" class="cls_007"><span class="cls_007">But Ruby doesn’t actually do this, as you can discover by creating another</span></div>
<div style="position:absolute;left:123.00px;top:149.47px" class="cls_007"><span class="cls_007">class and trying to call the new method:</span></div>
<div style="position:absolute;left:123.00px;top:173.47px" class="cls_030"><span class="cls_030">> </span><span class="cls_040">class AnotherClass; end</span></div>
<div style="position:absolute;left:123.00px;top:183.96px" class="cls_030"><span class="cls_030">> </span><span class="cls_040">AnotherClass.class_method</span></div>
<div style="position:absolute;left:127.25px;top:194.46px" class="cls_030"><span class="cls_030">=> undefined method `class_method' for AnotherClass:Class (NoMethodError)</span></div>
<div style="position:absolute;left:141.00px;top:216.97px" class="cls_007"><span class="cls_007">If Ruby had added the class method to the method table in the </span><span class="cls_030">Class</span></div>
<div style="position:absolute;left:123.00px;top:228.97px" class="cls_007"><span class="cls_007">class, all classes in your application would have the method. Obviously</span></div>
<div style="position:absolute;left:123.00px;top:240.97px" class="cls_007"><span class="cls_007">this isn’t what we intended by writing a class method, and thankfully Ruby</span></div>
<div style="position:absolute;left:123.00px;top:252.97px" class="cls_007"><span class="cls_007">doesn’t implement class methods this way.</span></div>
<div style="position:absolute;left:141.00px;top:264.97px" class="cls_007"><span class="cls_007">Then where do the class methods go? For a clue, use the method</span></div>
<div style="position:absolute;left:123.00px;top:276.97px" class="cls_030"><span class="cls_030">ObjectSpace.count_objects</span><span class="cls_007">,</span><span class="cls_030"> </span><span class="cls_007">shown in Listing 5-20:</span></div>
<div style="position:absolute;left:123.00px;top:300.97px" class="cls_030"><span class="cls_030">$ </span><span class="cls_040">irb</span></div>
<div style="position:absolute;left:111.00px;top:311.46px" class="cls_046"><span class="cls_046">u</span><span class="cls_030"> > </span><span class="cls_040">ObjectSpace.count_objects[:T_CLASS]</span></div>
<div style="position:absolute;left:111.00px;top:321.96px" class="cls_046"><span class="cls_046">v</span><span class="cls_030">  => 859</span></div>
<div style="position:absolute;left:123.00px;top:332.46px" class="cls_030"><span class="cls_030">> class Mathematician; end</span></div>
<div style="position:absolute;left:127.25px;top:342.96px" class="cls_030"><span class="cls_030">=> nil</span></div>
<div style="position:absolute;left:123.00px;top:353.45px" class="cls_030"><span class="cls_030">> </span><span class="cls_040">ObjectSpace.count_objects[:T_CLASS]</span></div>
<div style="position:absolute;left:111.00px;top:363.95px" class="cls_046"><span class="cls_046">w</span><span class="cls_030">  => 861</span></div>
<div style="position:absolute;left:123.00px;top:386.45px" class="cls_038"><span class="cls_038">Listing 5-20: Using </span><span class="cls_014">ObjectSpace.count_objects</span><span class="cls_038"> with </span><span class="cls_014">:T_CLASS</span></div>
<div style="position:absolute;left:141.00px;top:408.97px" class="cls_030"><span class="cls_030">ObjectSpace.count_objects</span><span class="cls_007"> at </span><span class="cls_050">u</span><span class="cls_007"> returns the number of objects of a given</span></div>
<div style="position:absolute;left:123.00px;top:420.97px" class="cls_007"><span class="cls_007">type that exist. In this test, I’m passing the :</span><span class="cls_030">T_CLASS</span><span class="cls_007"> symbol to get the count</span></div>
<div style="position:absolute;left:123.00px;top:432.97px" class="cls_007"><span class="cls_007">of class objects that exist in my IRB session. Before I create </span><span class="cls_030">Mathematician</span><span class="cls_007">,</span></div>
<div style="position:absolute;left:123.00px;top:444.97px" class="cls_007"><span class="cls_007">there are 859 classes at </span><span class="cls_050">v</span><span class="cls_007">. After I declare </span><span class="cls_030">Mathematician</span><span class="cls_007">, there are 861 at </span><span class="cls_050">w</span><span class="cls_007">—</span></div>
<div style="position:absolute;left:123.00px;top:456.97px" class="cls_007"><span class="cls_007">two more. That’s odd. I declared one new class, but Ruby actually created</span></div>
<div style="position:absolute;left:123.00px;top:468.97px" class="cls_007"><span class="cls_007">two! What is the second one for and where is it?</span></div>
<div style="position:absolute;left:141.00px;top:480.97px" class="cls_007"><span class="cls_007">It turns out that whenever you create a new class, internally Ruby cre-</span></div>
<div style="position:absolute;left:123.00px;top:492.97px" class="cls_007"><span class="cls_007">ates two classes! The first class is your new class: Ruby creates a new </span><span class="cls_030">RClass</span></div>
<div style="position:absolute;left:123.00px;top:504.97px" class="cls_007"><span class="cls_007">structure to represent your class, as described above. But internally Ruby</span></div>
<div style="position:absolute;left:123.00px;top:516.97px" class="cls_007"><span class="cls_007">also creates a second, hidden class called the </span><span class="cls_008">metaclass</span><span class="cls_007">. Why? To save any</span></div>
<div style="position:absolute;left:123.00px;top:528.97px" class="cls_007"><span class="cls_007">class methods that you might later create for your new class. In fact, Ruby</span></div>
<div style="position:absolute;left:123.00px;top:540.97px" class="cls_007"><span class="cls_007">sets the metaclass to be the class of your new class: It sets the </span><span class="cls_030">klass</span><span class="cls_007"> pointer</span></div>
<div style="position:absolute;left:123.00px;top:552.97px" class="cls_007"><span class="cls_007">of your new </span><span class="cls_030">RClass</span><span class="cls_007"> structure to point to the metaclass.</span></div>
<div style="position:absolute;left:374.57px;top:636.00px" class="cls_021"><span class="cls_021">Objects and Classes</span></div>
<div style="position:absolute;left:442.89px;top:633.00px" class="cls_020"><span class="cls_020">129</span></div>
</div>
<div style="position:absolute;left:50%;margin-left:-252px;top:101400px;width:504px;height:666px;border-style:outset;overflow:hidden">
<div style="position:absolute;left:0px;top:0px">
<img src="e698b76e-46bd-11eb-8b25-0cc47a792c0a_id_e698b76e-46bd-11eb-8b25-0cc47a792c0a_files/background154.jpg" width=504 height=666></div>
<div style="position:absolute;left:138.00px;top:42.28px" class="cls_007"><span class="cls_007">Without writing C code, there’s no easy way to see the metaclass or the</span></div>
<div style="position:absolute;left:120.00px;top:54.28px" class="cls_030"><span class="cls_030">klass</span><span class="cls_007"> pointer value, but you can obtain the metaclass as a Ruby object like this:</span></div>
<div style="position:absolute;left:120.00px;top:78.28px" class="cls_030"><span class="cls_030">class Mathematician</span></div>
<div style="position:absolute;left:120.00px;top:88.78px" class="cls_030"><span class="cls_030">end</span></div>
<div style="position:absolute;left:120.00px;top:109.78px" class="cls_030"><span class="cls_030">p Mathematician</span></div>
<div style="position:absolute;left:124.25px;top:120.28px" class="cls_030"><span class="cls_030">=> Mathematician</span></div>
<div style="position:absolute;left:120.00px;top:141.28px" class="cls_030"><span class="cls_030">p Mathematician.singleton_class</span></div>
<div style="position:absolute;left:124.25px;top:151.78px" class="cls_030"><span class="cls_030">=> #&lt;Class:Mathematician></span></div>
<div style="position:absolute;left:138.00px;top:174.28px" class="cls_007"><span class="cls_007">The first print statement displays the object’s class, while the second dis-</span></div>
<div style="position:absolute;left:120.00px;top:186.28px" class="cls_007"><span class="cls_007">plays the object’s metaclass. The odd </span><span class="cls_030">#&lt;Class:Mathematician></span><span class="cls_007"> syntax indicates</span></div>
<div style="position:absolute;left:120.00px;top:198.28px" class="cls_007"><span class="cls_007">that the second class is the metaclass for </span><span class="cls_030">Mathematician</span><span class="cls_007">. This is the second</span></div>
<div style="position:absolute;left:120.00px;top:210.28px" class="cls_030"><span class="cls_030">RClass</span><span class="cls_007"> structure that Ruby automatically created for me when I declared the</span></div>
<div style="position:absolute;left:120.00px;top:222.28px" class="cls_030"><span class="cls_030">Mathematician</span><span class="cls_007"> class. And this second </span><span class="cls_030">RClass</span><span class="cls_007"> structure is where Ruby saves my</span></div>
<div style="position:absolute;left:120.00px;top:234.28px" class="cls_007"><span class="cls_007">class method, as shown in Figure 5-23.</span></div>
<div style="position:absolute;left:143.56px;top:255.22px" class="cls_033"><span class="cls_033">euler</span></div>
<div style="position:absolute;left:232.69px;top:255.22px" class="cls_033"><span class="cls_033">Mathematician</span></div>
<div style="position:absolute;left:320.55px;top:255.22px" class="cls_033"><span class="cls_033">#&lt;Class:Mathematician></span></div>
<div style="position:absolute;left:224.06px;top:278.14px" class="cls_053"><span class="cls_053">RClass</span></div>
<div style="position:absolute;left:332.48px;top:278.14px" class="cls_053"><span class="cls_053">RClass</span></div>
<div style="position:absolute;left:124.77px;top:297.05px" class="cls_053"><span class="cls_053">RObject</span></div>
<div style="position:absolute;left:231.90px;top:297.05px" class="cls_053"><span class="cls_053">RBasic</span></div>
<div style="position:absolute;left:340.00px;top:297.05px" class="cls_053"><span class="cls_053">RBasic</span></div>
<div style="position:absolute;left:144.81px;top:309.52px" class="cls_014"><span class="cls_014">klass</span></div>
<div style="position:absolute;left:251.94px;top:309.52px" class="cls_014"><span class="cls_014">klass</span></div>
<div style="position:absolute;left:360.05px;top:309.52px" class="cls_014"><span class="cls_014">klass</span></div>
<div style="position:absolute;left:251.94px;top:342.62px" class="cls_014"><span class="cls_014">m_tbl</span></div>
<div style="position:absolute;left:360.05px;top:342.62px" class="cls_014"><span class="cls_014">m_tbl</span></div>
<div style="position:absolute;left:239.94px;top:379.96px" class="cls_014"><span class="cls_014">first_name=</span></div>
<div style="position:absolute;left:346.05px;top:388.45px" class="cls_014"><span class="cls_014">class_method</span></div>
<div style="position:absolute;left:241.94px;top:396.95px" class="cls_014"><span class="cls_014">first_name</span></div>
<div style="position:absolute;left:241.94px;top:413.93px" class="cls_014"><span class="cls_014">last_name=</span></div>
<div style="position:absolute;left:243.94px;top:430.91px" class="cls_014"><span class="cls_014">last_name</span></div>
<div style="position:absolute;left:120.00px;top:453.29px" class="cls_038"><span class="cls_038">Figure 5-23: An object, its class, and its metaclass</span></div>
<div style="position:absolute;left:138.00px;top:475.79px" class="cls_007"><span class="cls_007">If we now display the methods for the metaclass, we’ll see all</span></div>
<div style="position:absolute;left:120.00px;top:487.79px" class="cls_007"><span class="cls_007">the methods of the </span><span class="cls_030">Class</span><span class="cls_007"> class, along with the new class method for</span></div>
<div style="position:absolute;left:120.00px;top:499.79px" class="cls_030"><span class="cls_030">Mathematician</span><span class="cls_007">:</span></div>
<div style="position:absolute;left:120.00px;top:523.79px" class="cls_030"><span class="cls_030">p obj.singleton_class.methods</span></div>
<div style="position:absolute;left:124.25px;top:534.29px" class="cls_030"><span class="cls_030">=> [ ... :class_method, ...</span></div>
<div style="position:absolute;left:247.50px;top:534.29px" class="cls_030"><span class="cls_030">]</span></div>
<div style="position:absolute;left:48.00px;top:633.00px" class="cls_020"><span class="cls_020">130</span></div>
<div style="position:absolute;left:74.13px;top:636.00px" class="cls_021"><span class="cls_021">Chapter 5</span></div>
</div>
<div style="position:absolute;left:50%;margin-left:-252px;top:102076px;width:504px;height:666px;border-style:outset;overflow:hidden">
<div style="position:absolute;left:0px;top:0px">
<img src="e698b76e-46bd-11eb-8b25-0cc47a792c0a_id_e698b76e-46bd-11eb-8b25-0cc47a792c0a_files/background155.jpg" width=504 height=666></div>
<div style="position:absolute;left:69.00px;top:42.05px" class="cls_031"><span class="cls_031">Summary</span></div>
<div style="position:absolute;left:123.00px;top:62.05px" class="cls_007"><span class="cls_007">In this chapter we’ve seen how Ruby represents objects and classes inter-</span></div>
<div style="position:absolute;left:123.00px;top:74.05px" class="cls_007"><span class="cls_007">nally: Ruby uses the </span><span class="cls_030">RObject</span><span class="cls_007"> structure to represent instances of any custom</span></div>
<div style="position:absolute;left:123.00px;top:86.05px" class="cls_007"><span class="cls_007">classes you define in your code and of some classes predefined by Ruby</span></div>
<div style="position:absolute;left:123.00px;top:98.05px" class="cls_007"><span class="cls_007">itself. The </span><span class="cls_030">RObject</span><span class="cls_007"> structure is remarkably simple, containing just a pointer</span></div>
<div style="position:absolute;left:123.00px;top:110.05px" class="cls_007"><span class="cls_007">to the object’s class and a table of instance variable values, along with a</span></div>
<div style="position:absolute;left:123.00px;top:122.05px" class="cls_007"><span class="cls_007">count of the variables. The simplicity of its structure leads us to a very simple</span></div>
<div style="position:absolute;left:123.00px;top:134.05px" class="cls_007"><span class="cls_007">definition of a Ruby object:</span></div>
<div style="position:absolute;left:159.00px;top:153.05px" class="cls_033"><span class="cls_033">Every Ruby object is the combination of a class pointer and an</span></div>
<div style="position:absolute;left:159.00px;top:165.04px" class="cls_033"><span class="cls_033">array of instance variables.</span></div>
<div style="position:absolute;left:141.00px;top:182.05px" class="cls_007"><span class="cls_007">This definition is powerful and useful because everything in Ruby is</span></div>
<div style="position:absolute;left:123.00px;top:194.05px" class="cls_007"><span class="cls_007">an object: Whenever you use a value in your Ruby program, regardless of</span></div>
<div style="position:absolute;left:123.00px;top:206.05px" class="cls_007"><span class="cls_007">what it is, remember that it will be an object and will therefore have a class</span></div>
<div style="position:absolute;left:123.00px;top:218.05px" class="cls_007"><span class="cls_007">pointer and instance variables.</span></div>
<div style="position:absolute;left:141.00px;top:230.05px" class="cls_007"><span class="cls_007">We also saw that Ruby uses special C structures to represent instances</span></div>
<div style="position:absolute;left:123.00px;top:242.05px" class="cls_007"><span class="cls_007">of many commonly used, built-in Ruby classes called ”generic” objects. For</span></div>
<div style="position:absolute;left:123.00px;top:254.05px" class="cls_007"><span class="cls_007">example, Ruby uses the </span><span class="cls_030">RString</span><span class="cls_007"> structure to represent an instance of the</span></div>
<div style="position:absolute;left:123.00px;top:266.05px" class="cls_030"><span class="cls_030">String</span><span class="cls_007"> class, </span><span class="cls_030">RArray</span><span class="cls_007"> for an instance of the </span><span class="cls_030">Array</span><span class="cls_007"> class, or </span><span class="cls_030">RRegexp</span><span class="cls_007"> for an</span></div>
<div style="position:absolute;left:123.00px;top:278.05px" class="cls_007"><span class="cls_007">instance of the </span><span class="cls_030">Regexp</span><span class="cls_007"> class. While these structures are different, Ruby</span></div>
<div style="position:absolute;left:123.00px;top:290.05px" class="cls_007"><span class="cls_007">also saves a class pointer and an array of instance variables for each of these</span></div>
<div style="position:absolute;left:123.00px;top:302.05px" class="cls_007"><span class="cls_007">generic objects. Finally, we saw that Ruby saves some simple values, such as</span></div>
<div style="position:absolute;left:123.00px;top:314.05px" class="cls_007"><span class="cls_007">small integers and symbols, without using a C structure at all. Ruby saves</span></div>
<div style="position:absolute;left:123.00px;top:326.05px" class="cls_007"><span class="cls_007">these values right inside the </span><span class="cls_030">VALUE</span><span class="cls_007"> pointers that otherwise would point to</span></div>
<div style="position:absolute;left:123.00px;top:338.05px" class="cls_007"><span class="cls_007">the structure holding the value.</span></div>
<div style="position:absolute;left:141.00px;top:350.05px" class="cls_007"><span class="cls_007">While Ruby objects are simple, we learned in this chapter that Ruby</span></div>
<div style="position:absolute;left:123.00px;top:362.05px" class="cls_007"><span class="cls_007">classes aren’t quite so simple. The </span><span class="cls_030">RClass</span><span class="cls_007"> structure working with the</span></div>
<div style="position:absolute;left:123.00px;top:374.05px" class="cls_030"><span class="cls_030">rb_classext_struct</span><span class="cls_007"> structure saves a large set of information. Learning</span></div>
<div style="position:absolute;left:123.00px;top:386.05px" class="cls_007"><span class="cls_007">this forced us to write a more complex definition for Ruby classes:</span></div>
<div style="position:absolute;left:159.00px;top:405.05px" class="cls_033"><span class="cls_033">A Ruby class is a Ruby object that also contains method definitions,</span></div>
<div style="position:absolute;left:159.00px;top:417.05px" class="cls_033"><span class="cls_033">attribute names, a superclass pointer, and a constants table.</span></div>
<div style="position:absolute;left:141.00px;top:434.05px" class="cls_007"><span class="cls_007">Looking inside </span><span class="cls_030">RClass</span><span class="cls_007"> and </span><span class="cls_030">rb_classext_struct</span><span class="cls_007">, we saw that Ruby classes</span></div>
<div style="position:absolute;left:123.00px;top:446.05px" class="cls_007"><span class="cls_007">are also Ruby objects, which therefore also contain instance variables and</span></div>
<div style="position:absolute;left:123.00px;top:458.05px" class="cls_007"><span class="cls_007">a class pointer. We looked at the difference between a class’s instance vari-</span></div>
<div style="position:absolute;left:123.00px;top:470.05px" class="cls_007"><span class="cls_007">ables and class variables and learned that Ruby saves both of these variable</span></div>
<div style="position:absolute;left:123.00px;top:482.05px" class="cls_007"><span class="cls_007">types in the same hash table. We discovered how classes also contain a</span></div>
<div style="position:absolute;left:123.00px;top:494.05px" class="cls_007"><span class="cls_007">series of hash tables that store their methods, the names of the object-level</span></div>
<div style="position:absolute;left:123.00px;top:506.05px" class="cls_007"><span class="cls_007">instance variables, and constants defined within the class. Finally, we saw</span></div>
<div style="position:absolute;left:123.00px;top:518.05px" class="cls_007"><span class="cls_007">how each Ruby class records its superclass using the </span><span class="cls_030">super</span><span class="cls_007"> pointer.</span></div>
<div style="position:absolute;left:374.92px;top:636.00px" class="cls_021"><span class="cls_021">Objects and Classes</span></div>
<div style="position:absolute;left:443.25px;top:633.00px" class="cls_020"><span class="cls_020">131</span></div>
</div>
<div style="position:absolute;left:50%;margin-left:-252px;top:102752px;width:504px;height:666px;border-style:outset;overflow:hidden">
<div style="position:absolute;left:0px;top:0px">
<img src="e698b76e-46bd-11eb-8b25-0cc47a792c0a_id_e698b76e-46bd-11eb-8b25-0cc47a792c0a_files/background156.jpg" width=504 height=666></div>
<div style="position:absolute;left:244.95px;top:297.91px" class="cls_024"><span class="cls_024">Inside of Ruby,</span></div>
<div style="position:absolute;left:232.56px;top:315.92px" class="cls_024"><span class="cls_024">modules are classes.</span></div>
</div>
<div style="position:absolute;left:50%;margin-left:-252px;top:103428px;width:504px;height:666px;border-style:outset;overflow:hidden">
<div style="position:absolute;left:0px;top:0px">
<img src="e698b76e-46bd-11eb-8b25-0cc47a792c0a_id_e698b76e-46bd-11eb-8b25-0cc47a792c0a_files/background157.jpg" width=504 height=666></div>
<div style="position:absolute;left:260.10px;top:101.45px" class="cls_035"><span class="cls_035">6</span></div>
<div style="position:absolute;left:183.26px;top:253.45px" class="cls_016"><span class="cls_016">Method Lookup and</span></div>
<div style="position:absolute;left:196.30px;top:271.45px" class="cls_016"><span class="cls_016">Constant Lookup</span></div>
<div style="position:absolute;left:123.00px;top:387.45px" class="cls_023"><span class="cls_023">As we saw in Chapter 5, classes play an important role</span></div>
<div style="position:absolute;left:123.00px;top:405.46px" class="cls_023"><span class="cls_023">in Ruby, holding method definitions and constant</span></div>
<div style="position:absolute;left:123.00px;top:423.46px" class="cls_023"><span class="cls_023">values, among other things. We also learned how</span></div>
<div style="position:absolute;left:123.00px;top:441.45px" class="cls_023"><span class="cls_023">Ruby implements inheritance using the </span><span class="cls_028">super</span><span class="cls_023"> pointer</span></div>
<div style="position:absolute;left:123.00px;top:459.45px" class="cls_023"><span class="cls_023">in each </span><span class="cls_028">RClass</span><span class="cls_023"> structure.</span></div>
<div style="position:absolute;left:141.00px;top:478.45px" class="cls_007"><span class="cls_007">In fact, as your program grows, you might imagine it organized by class</span></div>
<div style="position:absolute;left:123.00px;top:490.45px" class="cls_007"><span class="cls_007">and superclass, creating a kind of giant tree structure. At the base is the</span></div>
<div style="position:absolute;left:123.00px;top:502.45px" class="cls_030"><span class="cls_030">Object</span><span class="cls_007"> class (or, actually, the internal </span><span class="cls_030">BasicObject</span><span class="cls_007"> class). This class is Ruby’s</span></div>
<div style="position:absolute;left:123.00px;top:514.45px" class="cls_007"><span class="cls_007">default superclass, and all of your classes appear somewhere higher up in</span></div>
<div style="position:absolute;left:123.00px;top:526.45px" class="cls_007"><span class="cls_007">the tree, branching out in different directions. In this chapter we’ll study</span></div>
<div style="position:absolute;left:123.00px;top:538.45px" class="cls_007"><span class="cls_007">how Ruby uses this superclass tree to look up methods. When you write</span></div>
<div style="position:absolute;left:123.00px;top:550.45px" class="cls_007"><span class="cls_007">code that calls a method, Ruby looks through this tree in a very precise</span></div>
<div style="position:absolute;left:123.00px;top:562.45px" class="cls_007"><span class="cls_007">manner. We’ll step through a concrete example to see the method lookup</span></div>
<div style="position:absolute;left:123.00px;top:574.45px" class="cls_007"><span class="cls_007">process in action.</span></div>
</div>
<div style="position:absolute;left:50%;margin-left:-252px;top:104104px;width:504px;height:666px;border-style:outset;overflow:hidden">
<div style="position:absolute;left:0px;top:0px">
<img src="e698b76e-46bd-11eb-8b25-0cc47a792c0a_id_e698b76e-46bd-11eb-8b25-0cc47a792c0a_files/background158.jpg" width=504 height=666></div>
<div style="position:absolute;left:138.00px;top:41.60px" class="cls_007"><span class="cls_007">Later in this chapter we’ll learn another way to visualize your Ruby</span></div>
<div style="position:absolute;left:120.00px;top:53.60px" class="cls_007"><span class="cls_007">code. Every time you create a new class or module, Ruby adds a new scope</span></div>
<div style="position:absolute;left:120.00px;top:65.60px" class="cls_007"><span class="cls_007">to a different tree, a tree based on the syntactical structure of your pro-</span></div>
<div style="position:absolute;left:120.00px;top:77.60px" class="cls_007"><span class="cls_007">gram. The trunk of this tree is the top-level scope, or the beginning of your</span></div>
<div style="position:absolute;left:120.00px;top:89.60px" class="cls_007"><span class="cls_007">Ruby code file where you start typing. As you define more and more highly</span></div>
<div style="position:absolute;left:120.00px;top:101.60px" class="cls_007"><span class="cls_007">nested modules and classes, this tree would grow higher and higher as well.</span></div>
<div style="position:absolute;left:120.00px;top:113.60px" class="cls_007"><span class="cls_007">We’ll learn how this syntax, or namespace, tree allows Ruby to find constant</span></div>
<div style="position:absolute;left:120.00px;top:125.60px" class="cls_007"><span class="cls_007">definitions, just as the superclass tree allows Ruby to find methods.</span></div>
<div style="position:absolute;left:138.00px;top:137.60px" class="cls_007"><span class="cls_007">But before we get to method and constant lookup, let’s get started with</span></div>
<div style="position:absolute;left:120.00px;top:149.60px" class="cls_007"><span class="cls_007">a look at Ruby modules. What are modules? How are they different from</span></div>
<div style="position:absolute;left:120.00px;top:161.60px" class="cls_007"><span class="cls_007">classes? What happens when you include a module into a class?</span></div>
<div style="position:absolute;left:261.47px;top:205.31px" class="cls_020"><span class="cls_020">Roadmap</span></div>
<div style="position:absolute;left:132.00px;top:222.31px" class="cls_017"><span class="cls_017">How Ruby Implements Modules</span></div>
<div style="position:absolute;left:415.36px;top:222.31px" class="cls_017"><span class="cls_017">135</span></div>
<div style="position:absolute;left:150.00px;top:239.32px" class="cls_017"><span class="cls_017">Modules Are Classes</span></div>
<div style="position:absolute;left:415.36px;top:239.32px" class="cls_017"><span class="cls_017">135</span></div>
<div style="position:absolute;left:150.00px;top:256.32px" class="cls_017"><span class="cls_017">Including a Module into a Class</span></div>
<div style="position:absolute;left:415.36px;top:256.32px" class="cls_017"><span class="cls_017">136</span></div>
<div style="position:absolute;left:132.00px;top:273.32px" class="cls_017"><span class="cls_017">Ruby’s Method Lookup Algorithm</span></div>
<div style="position:absolute;left:415.36px;top:273.32px" class="cls_017"><span class="cls_017">138</span></div>
<div style="position:absolute;left:150.00px;top:290.32px" class="cls_017"><span class="cls_017">A Method Lookup Example</span></div>
<div style="position:absolute;left:415.36px;top:290.32px" class="cls_017"><span class="cls_017">139</span></div>
<div style="position:absolute;left:150.00px;top:307.32px" class="cls_017"><span class="cls_017">The Method Lookup Algorithm in Action</span></div>
<div style="position:absolute;left:415.36px;top:307.32px" class="cls_017"><span class="cls_017">140</span></div>
<div style="position:absolute;left:150.00px;top:324.32px" class="cls_017"><span class="cls_017">Multiple Inheritance in Ruby</span></div>
<div style="position:absolute;left:415.36px;top:324.32px" class="cls_017"><span class="cls_017">141</span></div>
<div style="position:absolute;left:150.00px;top:341.32px" class="cls_017"><span class="cls_017">The Global Method Cache</span></div>
<div style="position:absolute;left:415.36px;top:341.32px" class="cls_017"><span class="cls_017">142</span></div>
<div style="position:absolute;left:150.00px;top:358.32px" class="cls_017"><span class="cls_017">The Inline Method Cache</span></div>
<div style="position:absolute;left:415.36px;top:358.32px" class="cls_017"><span class="cls_017">143</span></div>
<div style="position:absolute;left:150.00px;top:375.32px" class="cls_017"><span class="cls_017">Clearing Ruby’s Method Caches</span></div>
<div style="position:absolute;left:415.36px;top:375.32px" class="cls_017"><span class="cls_017">143</span></div>
<div style="position:absolute;left:150.00px;top:392.32px" class="cls_017"><span class="cls_017">Including Two Modules into One Class</span></div>
<div style="position:absolute;left:415.36px;top:392.32px" class="cls_017"><span class="cls_017">144</span></div>
<div style="position:absolute;left:150.00px;top:409.33px" class="cls_017"><span class="cls_017">Including One Module into Another</span></div>
<div style="position:absolute;left:415.36px;top:409.33px" class="cls_017"><span class="cls_017">145</span></div>
<div style="position:absolute;left:150.00px;top:426.31px" class="cls_017"><span class="cls_017">A </span><span class="cls_030">Module#prepend</span><span class="cls_017"> Example</span></div>
<div style="position:absolute;left:415.37px;top:426.31px" class="cls_017"><span class="cls_017">146</span></div>
<div style="position:absolute;left:150.00px;top:443.31px" class="cls_017"><span class="cls_017">How Ruby Implements </span><span class="cls_030">Module#prepend</span></div>
<div style="position:absolute;left:415.36px;top:443.31px" class="cls_017"><span class="cls_017">150</span></div>
<div style="position:absolute;left:132.00px;top:460.31px" class="cls_019"><span class="cls_019">Experiment 6-1: Modifying a Module After Including It</span></div>
<div style="position:absolute;left:416.39px;top:460.31px" class="cls_019"><span class="cls_019">151</span></div>
<div style="position:absolute;left:150.00px;top:477.32px" class="cls_017"><span class="cls_017">Classes See Methods Added to a Module Later</span></div>
<div style="position:absolute;left:415.36px;top:477.32px" class="cls_017"><span class="cls_017">152</span></div>
<div style="position:absolute;left:150.00px;top:494.32px" class="cls_017"><span class="cls_017">Classes Don’t See Submodules Included Later</span></div>
<div style="position:absolute;left:415.36px;top:494.32px" class="cls_017"><span class="cls_017">152</span></div>
<div style="position:absolute;left:150.00px;top:511.32px" class="cls_017"><span class="cls_017">Included Classes Share the Method Table with the</span></div>
<div style="position:absolute;left:168.00px;top:522.32px" class="cls_017"><span class="cls_017">Original Module</span></div>
<div style="position:absolute;left:415.36px;top:522.32px" class="cls_017"><span class="cls_017">153</span></div>
<div style="position:absolute;left:150.00px;top:539.32px" class="cls_017"><span class="cls_017">A Close Look at How Ruby Copies Modules</span></div>
<div style="position:absolute;left:415.36px;top:539.32px" class="cls_017"><span class="cls_017">154</span></div>
<div style="position:absolute;left:48.00px;top:633.00px" class="cls_020"><span class="cls_020">134</span></div>
<div style="position:absolute;left:74.19px;top:636.00px" class="cls_021"><span class="cls_021">Chapter 6</span></div>
</div>
<div style="position:absolute;left:50%;margin-left:-252px;top:104780px;width:504px;height:666px;border-style:outset;overflow:hidden">
<div style="position:absolute;left:0px;top:0px">
<img src="e698b76e-46bd-11eb-8b25-0cc47a792c0a_id_e698b76e-46bd-11eb-8b25-0cc47a792c0a_files/background159.jpg" width=504 height=666></div>
<div style="position:absolute;left:135.00px;top:55.05px" class="cls_017"><span class="cls_017">Constant Lookup</span></div>
<div style="position:absolute;left:418.36px;top:55.05px" class="cls_017"><span class="cls_017">155</span></div>
<div style="position:absolute;left:153.00px;top:72.05px" class="cls_017"><span class="cls_017">Finding a Constant in a Superclass</span></div>
<div style="position:absolute;left:418.36px;top:72.05px" class="cls_017"><span class="cls_017">156</span></div>
<div style="position:absolute;left:153.00px;top:89.05px" class="cls_017"><span class="cls_017">How Does Ruby Find a Constant in the Parent Namespace?</span></div>
<div style="position:absolute;left:418.36px;top:89.05px" class="cls_017"><span class="cls_017">157</span></div>
<div style="position:absolute;left:135.00px;top:106.05px" class="cls_017"><span class="cls_017">Lexical Scope in Ruby</span></div>
<div style="position:absolute;left:418.36px;top:106.05px" class="cls_017"><span class="cls_017">158</span></div>
<div style="position:absolute;left:153.00px;top:123.05px" class="cls_017"><span class="cls_017">Creating a Constant for a New Class or Module</span></div>
<div style="position:absolute;left:418.36px;top:123.05px" class="cls_017"><span class="cls_017">159</span></div>
<div style="position:absolute;left:153.00px;top:140.05px" class="cls_017"><span class="cls_017">Finding a Constant in the Parent Namespace Using</span></div>
<div style="position:absolute;left:171.00px;top:151.05px" class="cls_017"><span class="cls_017">Lexical Scope</span></div>
<div style="position:absolute;left:418.36px;top:151.05px" class="cls_017"><span class="cls_017">160</span></div>
<div style="position:absolute;left:153.00px;top:168.05px" class="cls_017"><span class="cls_017">Ruby’s Constant Lookup Algorithm</span></div>
<div style="position:absolute;left:418.36px;top:168.05px" class="cls_017"><span class="cls_017">162</span></div>
<div style="position:absolute;left:135.00px;top:185.05px" class="cls_019"><span class="cls_019">Experiment 6-2: Which Constant Will Ruby Find First?</span></div>
<div style="position:absolute;left:419.39px;top:185.05px" class="cls_019"><span class="cls_019">162</span></div>
<div style="position:absolute;left:153.00px;top:202.05px" class="cls_017"><span class="cls_017">Ruby’s Actual Constant Lookup Algorithm</span></div>
<div style="position:absolute;left:418.36px;top:202.05px" class="cls_017"><span class="cls_017">163</span></div>
<div style="position:absolute;left:135.00px;top:219.05px" class="cls_017"><span class="cls_017">Summary</span></div>
<div style="position:absolute;left:418.36px;top:219.05px" class="cls_017"><span class="cls_017">165</span></div>
<div style="position:absolute;left:69.00px;top:258.05px" class="cls_031"><span class="cls_031">How Ruby Implements Modules</span></div>
<div style="position:absolute;left:123.00px;top:278.05px" class="cls_007"><span class="cls_007">As you may know, modules are very similar to classes in Ruby. You can create</span></div>
<div style="position:absolute;left:123.00px;top:290.05px" class="cls_007"><span class="cls_007">a module just as you create a class—by typing the </span><span class="cls_030">module</span><span class="cls_007"> keyword followed</span></div>
<div style="position:absolute;left:123.00px;top:302.05px" class="cls_007"><span class="cls_007">by a series of method definitions. But while modules are similar to classes,</span></div>
<div style="position:absolute;left:123.00px;top:314.05px" class="cls_007"><span class="cls_007">they are handled differently by Ruby in three important ways:</span></div>
<div style="position:absolute;left:123.00px;top:335.05px" class="cls_050"><span class="cls_050">•</span><span class="cls_007">   Ruby doesn’t allow you to create objects directly from modules. In prac-</span></div>
<div style="position:absolute;left:141.00px;top:347.05px" class="cls_007"><span class="cls_007">tice this means that you can’t call the </span><span class="cls_030">new</span><span class="cls_007"> method on a module because</span></div>
<div style="position:absolute;left:141.00px;top:359.05px" class="cls_030"><span class="cls_030">new</span><span class="cls_007"> is a method of </span><span class="cls_030">Class</span><span class="cls_007">, not of </span><span class="cls_030">Module</span><span class="cls_007">.</span></div>
<div style="position:absolute;left:123.00px;top:374.05px" class="cls_050"><span class="cls_050">•</span><span class="cls_007">   Ruby doesn’t allow you to specify a superclass for a module.</span></div>
<div style="position:absolute;left:123.00px;top:389.05px" class="cls_050"><span class="cls_050">•</span><span class="cls_007">   In addition, you can include a module into a class using the </span><span class="cls_030">include</span></div>
<div style="position:absolute;left:141.00px;top:401.05px" class="cls_007"><span class="cls_007">keyword.</span></div>
<div style="position:absolute;left:141.00px;top:422.05px" class="cls_007"><span class="cls_007">But what are modules exactly? How does Ruby represent them internally?</span></div>
<div style="position:absolute;left:123.00px;top:434.05px" class="cls_007"><span class="cls_007">Does it use an </span><span class="cls_030">RModule</span><span class="cls_007"> structure? And what does it mean to “include” a mod-</span></div>
<div style="position:absolute;left:122.99px;top:446.05px" class="cls_007"><span class="cls_007">ule into a class?</span></div>
<div style="position:absolute;left:123.00px;top:471.05px" class="cls_055"><span class="cls_055">Modules Are Classes</span></div>
<div style="position:absolute;left:123.00px;top:489.05px" class="cls_007"><span class="cls_007">As it turns out, internally Ruby implements modules as classes. When you</span></div>
<div style="position:absolute;left:123.00px;top:501.05px" class="cls_007"><span class="cls_007">create a module, Ruby creates another </span><span class="cls_030">RClass</span><span class="cls_007">/</span><span class="cls_030">rb_classext_struct</span><span class="cls_007"> structure</span></div>
<div style="position:absolute;left:123.00px;top:513.05px" class="cls_007"><span class="cls_007">pair, just as it would for a new class. For example, suppose we define a new</span></div>
<div style="position:absolute;left:123.00px;top:525.05px" class="cls_007"><span class="cls_007">module like this.</span></div>
<div style="position:absolute;left:123.00px;top:549.05px" class="cls_030"><span class="cls_030">module Professor</span></div>
<div style="position:absolute;left:123.00px;top:559.55px" class="cls_030"><span class="cls_030">end</span></div>
<div style="position:absolute;left:141.00px;top:582.05px" class="cls_007"><span class="cls_007">Internally, Ruby would create a class, not a module! Figure 6-1 shows</span></div>
<div style="position:absolute;left:123.00px;top:594.05px" class="cls_007"><span class="cls_007">how Ruby represents a module internally.</span></div>
<div style="position:absolute;left:330.73px;top:636.00px" class="cls_021"><span class="cls_021">Method Lookup and Constant Lookup</span></div>
<div style="position:absolute;left:442.99px;top:633.00px" class="cls_020"><span class="cls_020">135</span></div>
</div>
<div style="position:absolute;left:50%;margin-left:-252px;top:105456px;width:504px;height:666px;border-style:outset;overflow:hidden">
<div style="position:absolute;left:0px;top:0px">
<img src="e698b76e-46bd-11eb-8b25-0cc47a792c0a_id_e698b76e-46bd-11eb-8b25-0cc47a792c0a_files/background160.jpg" width=504 height=666></div>
<div style="position:absolute;left:283.99px;top:49.37px" class="cls_042"><span class="cls_042">RClass: module</span></div>
<div style="position:absolute;left:293.09px;top:66.22px" class="cls_042"><span class="cls_042">RBasic</span></div>
<div style="position:absolute;left:311.71px;top:82.61px" class="cls_015"><span class="cls_015">flags</span></div>
<div style="position:absolute;left:311.71px;top:103.50px" class="cls_015"><span class="cls_015">klass</span></div>
<div style="position:absolute;left:381.75px;top:102.99px" class="cls_054"><span class="cls_054">Class pointer</span></div>
<div style="position:absolute;left:154.79px;top:105.65px" class="cls_054"><span class="cls_054">VALUE</span></div>
<div style="position:absolute;left:311.71px;top:135.13px" class="cls_015"><span class="cls_015">m_tbl</span></div>
<div style="position:absolute;left:381.75px;top:134.81px" class="cls_054"><span class="cls_054">Method table</span></div>
<div style="position:absolute;left:315.21px;top:158.12px" class="cls_015"><span class="cls_015">ptr</span></div>
<div style="position:absolute;left:280.81px;top:202.88px" class="cls_042"><span class="cls_042">rb_classext_struct</span></div>
<div style="position:absolute;left:311.71px;top:217.68px" class="cls_015"><span class="cls_015">super</span></div>
<div style="position:absolute;left:381.76px;top:217.30px" class="cls_054"><span class="cls_054">Superclass pointer</span></div>
<div style="position:absolute;left:381.76px;top:236.43px" class="cls_054"><span class="cls_054">Class-level</span></div>
<div style="position:absolute;left:309.96px;top:241.44px" class="cls_015"><span class="cls_015">iv_tbl</span></div>
<div style="position:absolute;left:381.76px;top:245.69px" class="cls_054"><span class="cls_054">instance variables</span></div>
<div style="position:absolute;left:304.71px;top:265.32px" class="cls_015"><span class="cls_015">const_tbl</span></div>
<div style="position:absolute;left:381.76px;top:265.04px" class="cls_054"><span class="cls_054">Constants table</span></div>
<div style="position:absolute;left:381.75px;top:284.18px" class="cls_054"><span class="cls_054">Used by</span></div>
<div style="position:absolute;left:309.96px;top:289.19px" class="cls_015"><span class="cls_015">origin</span></div>
<div style="position:absolute;left:381.75px;top:293.43px" class="cls_014"><span class="cls_014">Module#prepend</span></div>
<div style="position:absolute;left:120.00px;top:319.79px" class="cls_038"><span class="cls_038">Figure 6-1: The portion of Ruby’s class structures that’s used for modules</span></div>
<div style="position:absolute;left:138.00px;top:342.29px" class="cls_007"><span class="cls_007">In this figure I show Ruby’s </span><span class="cls_030">RClass</span><span class="cls_007"> structure again. However, I’ve</span></div>
<div style="position:absolute;left:120.00px;top:354.29px" class="cls_007"><span class="cls_007">removed some of the values from the diagram because modules don’t use</span></div>
<div style="position:absolute;left:120.00px;top:366.29px" class="cls_007"><span class="cls_007">all of them. Most importantly, I removed </span><span class="cls_030">iv_index_tbl</span><span class="cls_007"> because you can’t</span></div>
<div style="position:absolute;left:120.00px;top:378.29px" class="cls_007"><span class="cls_007">create object instances of a module—in other words, you can’t call the </span><span class="cls_030">new</span></div>
<div style="position:absolute;left:120.00px;top:390.29px" class="cls_007"><span class="cls_007">method on a module. This means there are no object-level attributes to</span></div>
<div style="position:absolute;left:120.00px;top:402.29px" class="cls_007"><span class="cls_007">keep track of. I also removed the </span><span class="cls_030">refined_class</span><span class="cls_007"> and </span><span class="cls_030">allocator</span><span class="cls_007"> values because</span></div>
<div style="position:absolute;left:120.00px;top:414.29px" class="cls_007"><span class="cls_007">modules don’t use them either. I’ve left the </span><span class="cls_030">super</span><span class="cls_007"> pointer because modules</span></div>
<div style="position:absolute;left:120.00px;top:426.29px" class="cls_007"><span class="cls_007">do have superclasses internally even though you aren’t allowed to specify</span></div>
<div style="position:absolute;left:120.00px;top:438.29px" class="cls_007"><span class="cls_007">them yourself.</span></div>
<div style="position:absolute;left:138.00px;top:450.29px" class="cls_007"><span class="cls_007">A technical definition of a Ruby module (ignoring the </span><span class="cls_030">origin</span><span class="cls_007"> value for</span></div>
<div style="position:absolute;left:120.00px;top:462.29px" class="cls_007"><span class="cls_007">now) might look like this:</span></div>
<div style="position:absolute;left:156.00px;top:481.29px" class="cls_033"><span class="cls_033">A Ruby module is a Ruby object that also contains method defini-</span></div>
<div style="position:absolute;left:156.00px;top:493.29px" class="cls_033"><span class="cls_033">tions, a superclass pointer, and a constants table.</span></div>
<div style="position:absolute;left:120.00px;top:523.29px" class="cls_055"><span class="cls_055">Including a Module into a Class</span></div>
<div style="position:absolute;left:120.00px;top:541.29px" class="cls_007"><span class="cls_007">The real magic behind modules happens when you include a module into a</span></div>
<div style="position:absolute;left:120.00px;top:553.29px" class="cls_007"><span class="cls_007">class, as shown in Listing 6-1.</span></div>
<div style="position:absolute;left:120.00px;top:577.29px" class="cls_030"><span class="cls_030">module Professor</span></div>
<div style="position:absolute;left:120.00px;top:587.79px" class="cls_030"><span class="cls_030">end</span></div>
<div style="position:absolute;left:48.00px;top:633.00px" class="cls_020"><span class="cls_020">136</span></div>
<div style="position:absolute;left:74.15px;top:636.00px" class="cls_021"><span class="cls_021">Chapter 6</span></div>
</div>
<div style="position:absolute;left:50%;margin-left:-252px;top:106132px;width:504px;height:666px;border-style:outset;overflow:hidden">
<div style="position:absolute;left:0px;top:0px">
<img src="e698b76e-46bd-11eb-8b25-0cc47a792c0a_id_e698b76e-46bd-11eb-8b25-0cc47a792c0a_files/background161.jpg" width=504 height=666></div>
<div style="position:absolute;left:123.00px;top:42.24px" class="cls_030"><span class="cls_030">class Mathematician &lt; Person</span></div>
<div style="position:absolute;left:131.50px;top:52.74px" class="cls_030"><span class="cls_030">include Professor</span></div>
<div style="position:absolute;left:123.00px;top:63.23px" class="cls_030"><span class="cls_030">end</span></div>
<div style="position:absolute;left:123.00px;top:85.73px" class="cls_038"><span class="cls_038">Listing 6-1: Including a module into a class</span></div>
<div style="position:absolute;left:141.00px;top:108.24px" class="cls_007"><span class="cls_007">When we run Listing 6-1, Ruby creates a copy of the </span><span class="cls_030">RClass</span><span class="cls_007"> structure</span></div>
<div style="position:absolute;left:123.00px;top:120.24px" class="cls_007"><span class="cls_007">for the </span><span class="cls_030">Professor</span><span class="cls_007"> module and uses it as the new superclass for </span><span class="cls_030">Mathematician</span><span class="cls_007">.</span></div>
<div style="position:absolute;left:123.00px;top:132.24px" class="cls_007"><span class="cls_007">Ruby’s C source code refers to this copy of the module as an </span><span class="cls_008">included class</span><span class="cls_007">.</span></div>
<div style="position:absolute;left:123.00px;top:144.24px" class="cls_007"><span class="cls_007">The superclass of the new copy of </span><span class="cls_030">Professor</span><span class="cls_007"> is set to the original superclass</span></div>
<div style="position:absolute;left:123.00px;top:156.24px" class="cls_007"><span class="cls_007">of </span><span class="cls_030">Mathematician</span><span class="cls_007">, which preserves the superclass, or ancestor chain. Figure 6-2</span></div>
<div style="position:absolute;left:123.00px;top:168.24px" class="cls_007"><span class="cls_007">summarizes this somewhat confusing state of affairs.</span></div>
<div style="position:absolute;left:128.45px;top:189.65px" class="cls_054"><span class="cls_054">Ruby saves your class’s ancestors</span></div>
<div style="position:absolute;left:124.22px;top:199.83px" class="cls_054"><span class="cls_054">using a linked list of </span><span class="cls_014">super</span><span class="cls_054"> pointers:</span></div>
<div style="position:absolute;left:194.32px;top:224.78px" class="cls_042"><span class="cls_042">RClass</span></div>
<div style="position:absolute;left:296.38px;top:226.74px" class="cls_054"><span class="cls_054">When you include a module,</span></div>
<div style="position:absolute;left:123.00px;top:231.86px" class="cls_033"><span class="cls_033">Mathematician</span></div>
<div style="position:absolute;left:206.74px;top:236.92px" class="cls_014"><span class="cls_014">super</span></div>
<div style="position:absolute;left:288.32px;top:236.92px" class="cls_054"><span class="cls_054">Ruby inserts a copy of the module</span></div>
<div style="position:absolute;left:281.90px;top:247.09px" class="cls_054"><span class="cls_054">into your class’s superclass linked list:</span></div>
<div style="position:absolute;left:267.72px;top:272.28px" class="cls_042"><span class="cls_042">RClass</span></div>
<div style="position:absolute;left:381.16px;top:272.28px" class="cls_042"><span class="cls_042">RClass</span></div>
<div style="position:absolute;left:280.14px;top:284.42px" class="cls_014"><span class="cls_014">super</span></div>
<div style="position:absolute;left:393.59px;top:284.42px" class="cls_014"><span class="cls_014">super</span></div>
<div style="position:absolute;left:337.35px;top:290.43px" class="cls_017"><span class="cls_017">copy</span></div>
<div style="position:absolute;left:273.69px;top:312.84px" class="cls_017"><span class="cls_017">Included</span></div>
<div style="position:absolute;left:383.34px;top:313.24px" class="cls_033"><span class="cls_033">Professor</span></div>
<div style="position:absolute;left:194.32px;top:321.77px" class="cls_042"><span class="cls_042">RClass</span></div>
<div style="position:absolute;left:280.80px;top:323.81px" class="cls_017"><span class="cls_017">class</span></div>
<div style="position:absolute;left:138.75px;top:328.85px" class="cls_033"><span class="cls_033">Person</span></div>
<div style="position:absolute;left:206.74px;top:333.91px" class="cls_014"><span class="cls_014">super</span></div>
<div style="position:absolute;left:136.50px;top:381.34px" class="cls_033"><span class="cls_033">Another</span></div>
<div style="position:absolute;left:194.32px;top:379.74px" class="cls_042"><span class="cls_042">RClass</span></div>
<div style="position:absolute;left:129.75px;top:392.30px" class="cls_033"><span class="cls_033">Superclass</span></div>
<div style="position:absolute;left:206.74px;top:391.88px" class="cls_014"><span class="cls_014">super</span></div>
<div style="position:absolute;left:194.32px;top:432.20px" class="cls_042"><span class="cls_042">RClass</span></div>
<div style="position:absolute;left:138.73px;top:439.28px" class="cls_033"><span class="cls_033">Object</span></div>
<div style="position:absolute;left:206.74px;top:444.34px" class="cls_014"><span class="cls_014">super</span></div>
<div style="position:absolute;left:123.00px;top:470.78px" class="cls_038"><span class="cls_038">Figure 6-2: Including a module into a class</span></div>
<div style="position:absolute;left:141.00px;top:493.28px" class="cls_007"><span class="cls_007">You can see the </span><span class="cls_030">Mathematician</span><span class="cls_007"> class at the top-left corner of Figure 6-2.</span></div>
<div style="position:absolute;left:123.00px;top:505.28px" class="cls_007"><span class="cls_007">Below it and along the left side, you see its superclass chain: </span><span class="cls_030">Mathematician</span><span class="cls_007">’s</span></div>
<div style="position:absolute;left:123.00px;top:517.28px" class="cls_007"><span class="cls_007">superclass is </span><span class="cls_030">Person</span><span class="cls_007">, whose superclass is </span><span class="cls_030">Another Superclass</span><span class="cls_007">, and so on. The</span></div>
<div style="position:absolute;left:123.00px;top:529.28px" class="cls_030"><span class="cls_030">super</span><span class="cls_007"> pointer in each </span><span class="cls_030">RClass</span><span class="cls_007"> structure (actually, each </span><span class="cls_030">rb_classext_struct</span></div>
<div style="position:absolute;left:123.00px;top:541.28px" class="cls_007"><span class="cls_007">structure) points down to the next superclass.</span></div>
<div style="position:absolute;left:141.00px;top:553.28px" class="cls_007"><span class="cls_007">Now to the </span><span class="cls_030">Professor</span><span class="cls_007"> module on the right side of Figure 6-2. When</span></div>
<div style="position:absolute;left:123.00px;top:565.28px" class="cls_007"><span class="cls_007">we include this module into the </span><span class="cls_030">Mathematician</span><span class="cls_007"> class, Ruby changes the</span></div>
<div style="position:absolute;left:123.00px;top:577.28px" class="cls_030"><span class="cls_030">super</span><span class="cls_007"> pointer of </span><span class="cls_030">Mathematician</span><span class="cls_007"> to point to a copy of </span><span class="cls_030">Professor</span><span class="cls_007"> and the </span><span class="cls_030">super</span></div>
<div style="position:absolute;left:123.00px;top:589.28px" class="cls_007"><span class="cls_007">pointer of this copy of </span><span class="cls_030">Professor</span><span class="cls_007"> to point to </span><span class="cls_030">Person</span><span class="cls_007">, the original superclass</span></div>
<div style="position:absolute;left:123.00px;top:601.28px" class="cls_007"><span class="cls_007">of </span><span class="cls_030">Mathematician</span><span class="cls_007">.</span></div>
<div style="position:absolute;left:330.80px;top:636.00px" class="cls_021"><span class="cls_021">Method Lookup and Constant Lookup</span></div>
<div style="position:absolute;left:443.07px;top:633.00px" class="cls_020"><span class="cls_020">137</span></div>
</div>
<div style="position:absolute;left:50%;margin-left:-252px;top:106808px;width:504px;height:666px;border-style:outset;overflow:hidden">
<div style="position:absolute;left:0px;top:0px">
<img src="e698b76e-46bd-11eb-8b25-0cc47a792c0a_id_e698b76e-46bd-11eb-8b25-0cc47a792c0a_files/background162.jpg" width=504 height=666></div>
<div style="position:absolute;left:78.00px;top:46.00px" class="cls_032"><span class="cls_032">NOTE</span></div>
<div style="position:absolute;left:120.00px;top:43.50px" class="cls_008"><span class="cls_008">Ruby implements </span><span class="cls_030">extend</span><span class="cls_008"> in exactly the same way, except the included class becomes</span></div>
<div style="position:absolute;left:120.00px;top:55.50px" class="cls_008"><span class="cls_008">the superclass of the target class’s class, or metaclass. Thus, </span><span class="cls_030">extend</span><span class="cls_008"> allows you to add</span></div>
<div style="position:absolute;left:120.00px;top:67.50px" class="cls_008"><span class="cls_008">class methods to a class.</span></div>
<div style="position:absolute;left:66.00px;top:101.50px" class="cls_031"><span class="cls_031">Ruby’s Method Lookup Algorithm</span></div>
<div style="position:absolute;left:120.00px;top:121.50px" class="cls_007"><span class="cls_007">Whenever you call a method, whenever you “send a message to a receiver”</span></div>
<div style="position:absolute;left:120.00px;top:133.50px" class="cls_007"><span class="cls_007">to use object-oriented programming jargon, Ruby needs to determine</span></div>
<div style="position:absolute;left:120.00px;top:145.50px" class="cls_007"><span class="cls_007">which class implements that method. Sometimes this is obvious: The</span></div>
<div style="position:absolute;left:120.00px;top:157.50px" class="cls_007"><span class="cls_007">receiver’s class might implement the target method. However, this isn’t</span></div>
<div style="position:absolute;left:120.00px;top:169.50px" class="cls_007"><span class="cls_007">often the case. It might be that some other module or class in your system</span></div>
<div style="position:absolute;left:120.00px;top:181.50px" class="cls_007"><span class="cls_007">implements the method. Ruby uses a very precise algorithm to search</span></div>
<div style="position:absolute;left:120.00px;top:193.50px" class="cls_007"><span class="cls_007">through the modules and classes in your program in a particular order to</span></div>
<div style="position:absolute;left:120.00px;top:205.50px" class="cls_007"><span class="cls_007">find the target method. An understanding of this process is essential for</span></div>
<div style="position:absolute;left:120.00px;top:217.50px" class="cls_007"><span class="cls_007">every Ruby developer, so let’s take a close look at it.</span></div>
<div style="position:absolute;left:138.00px;top:229.50px" class="cls_007"><span class="cls_007">The flowchart in Figure 6-3 gives you a graphical picture of Ruby’s</span></div>
<div style="position:absolute;left:120.00px;top:241.50px" class="cls_007"><span class="cls_007">method lookup algorithm.</span></div>
<div style="position:absolute;left:159.06px;top:270.50px" class="cls_054"><span class="cls_054">set current</span></div>
<div style="position:absolute;left:163.95px;top:279.36px" class="cls_054"><span class="cls_054">class to</span></div>
<div style="position:absolute;left:164.22px;top:288.23px" class="cls_054"><span class="cls_054">receiver</span></div>
<div style="position:absolute;left:155.05px;top:343.01px" class="cls_054"><span class="cls_054">look through</span></div>
<div style="position:absolute;left:149.74px;top:351.87px" class="cls_054"><span class="cls_054">method table in</span></div>
<div style="position:absolute;left:156.61px;top:360.73px" class="cls_054"><span class="cls_054">current class</span></div>
<div style="position:absolute;left:262.03px;top:416.71px" class="cls_054"><span class="cls_054">not</span></div>
<div style="position:absolute;left:257.55px;top:424.77px" class="cls_054"><span class="cls_054">found</span></div>
<div style="position:absolute;left:309.38px;top:425.23px" class="cls_054"><span class="cls_054">set current</span></div>
<div style="position:absolute;left:163.93px;top:433.41px" class="cls_054"><span class="cls_054">method</span></div>
<div style="position:absolute;left:314.27px;top:434.09px" class="cls_054"><span class="cls_054">class to</span></div>
<div style="position:absolute;left:166.17px;top:442.27px" class="cls_054"><span class="cls_054">found?</span></div>
<div style="position:absolute;left:304.77px;top:442.96px" class="cls_054"><span class="cls_054">superclass of</span></div>
<div style="position:absolute;left:306.93px;top:451.82px" class="cls_054"><span class="cls_054">current class</span></div>
<div style="position:absolute;left:191.57px;top:483.15px" class="cls_054"><span class="cls_054">found</span></div>
<div style="position:absolute;left:157.90px;top:525.18px" class="cls_054"><span class="cls_054">call method</span></div>
<div style="position:absolute;left:120.00px;top:559.00px" class="cls_038"><span class="cls_038">Figure 6-3: Ruby’s method lookup algorithm</span></div>
<div style="position:absolute;left:138.00px;top:581.50px" class="cls_007"><span class="cls_007">This algorithm is remarkably simple, isn’t it? As you can see, Ruby simply</span></div>
<div style="position:absolute;left:120.00px;top:593.50px" class="cls_007"><span class="cls_007">follows the </span><span class="cls_030">super</span><span class="cls_007"> pointers until it finds the class or module that contains</span></div>
<div style="position:absolute;left:48.00px;top:633.00px" class="cls_020"><span class="cls_020">138</span></div>
<div style="position:absolute;left:74.18px;top:636.00px" class="cls_021"><span class="cls_021">Chapter 6</span></div>
</div>
<div style="position:absolute;left:50%;margin-left:-252px;top:107484px;width:504px;height:666px;border-style:outset;overflow:hidden">
<div style="position:absolute;left:0px;top:0px">
<img src="e698b76e-46bd-11eb-8b25-0cc47a792c0a_id_e698b76e-46bd-11eb-8b25-0cc47a792c0a_files/background163.jpg" width=504 height=666></div>
<div style="position:absolute;left:123.00px;top:41.60px" class="cls_007"><span class="cls_007">the target method. You might imagine that Ruby would have to distinguish</span></div>
<div style="position:absolute;left:123.00px;top:53.60px" class="cls_007"><span class="cls_007">between modules and classes using some special logic—that it would have</span></div>
<div style="position:absolute;left:123.00px;top:65.60px" class="cls_007"><span class="cls_007">to handle the case where there are multiple included modules, for example.</span></div>
<div style="position:absolute;left:123.00px;top:77.60px" class="cls_007"><span class="cls_007">But no, it’s just a simple loop on the </span><span class="cls_030">super</span><span class="cls_007"> pointer linked list.</span></div>
<div style="position:absolute;left:123.00px;top:102.60px" class="cls_055"><span class="cls_055">A Method Lookup Example</span></div>
<div style="position:absolute;left:123.00px;top:120.60px" class="cls_007"><span class="cls_007">In a moment we’ll walk through this algorithm to be sure we understand it</span></div>
<div style="position:absolute;left:123.00px;top:132.60px" class="cls_007"><span class="cls_007">thoroughly. But first, let’s set up an example we can use that has a class, a</span></div>
<div style="position:absolute;left:123.00px;top:144.60px" class="cls_007"><span class="cls_007">superclass, and a module. This will allow us to see how classes and modules</span></div>
<div style="position:absolute;left:123.00px;top:156.60px" class="cls_007"><span class="cls_007">work together inside of Ruby.</span></div>
<div style="position:absolute;left:141.00px;top:168.60px" class="cls_007"><span class="cls_007">Listing 6-2 shows the </span><span class="cls_030">Mathematician</span><span class="cls_007"> class with the accessor methods</span></div>
<div style="position:absolute;left:123.00px;top:180.60px" class="cls_030"><span class="cls_030">first_name</span><span class="cls_007"> and </span><span class="cls_030">last_name</span><span class="cls_007">.</span></div>
<div style="position:absolute;left:123.00px;top:204.60px" class="cls_030"><span class="cls_030">class Mathematician</span></div>
<div style="position:absolute;left:131.50px;top:215.10px" class="cls_030"><span class="cls_030">attr_accessor :first_name</span></div>
<div style="position:absolute;left:131.50px;top:225.60px" class="cls_030"><span class="cls_030">attr_accessor :last_name</span></div>
<div style="position:absolute;left:123.00px;top:236.09px" class="cls_030"><span class="cls_030">end</span></div>
<div style="position:absolute;left:123.00px;top:258.59px" class="cls_038"><span class="cls_038">Listing 6-2: A simple Ruby class, repeated from Listing 5-1</span></div>
<div style="position:absolute;left:141.00px;top:281.10px" class="cls_007"><span class="cls_007">Now let’s introduce a superclass. In Listing 6-3, at </span><span class="cls_050">u</span><span class="cls_007"> we set </span><span class="cls_030">Person</span><span class="cls_007"> as the</span></div>
<div style="position:absolute;left:123.00px;top:293.10px" class="cls_007"><span class="cls_007">superclass of </span><span class="cls_030">Mathematician</span><span class="cls_007">.</span></div>
<div style="position:absolute;left:123.00px;top:317.10px" class="cls_030"><span class="cls_030">class Person</span></div>
<div style="position:absolute;left:123.00px;top:327.60px" class="cls_030"><span class="cls_030">end</span></div>
<div style="position:absolute;left:111.15px;top:348.60px" class="cls_046"><span class="cls_046">u</span><span class="cls_030"> class Mathematician &lt; Person</span></div>
<div style="position:absolute;left:131.50px;top:359.10px" class="cls_030"><span class="cls_030">attr_accessor :first_name</span></div>
<div style="position:absolute;left:131.50px;top:369.60px" class="cls_030"><span class="cls_030">attr_accessor :last_name</span></div>
<div style="position:absolute;left:123.00px;top:380.09px" class="cls_030"><span class="cls_030">end</span></div>
<div style="position:absolute;left:123.00px;top:402.59px" class="cls_038"><span class="cls_038">Listing 6-3: </span><span class="cls_014">Person</span><span class="cls_038"> is the superclass of </span><span class="cls_014">Mathematician</span><span class="cls_038">.</span></div>
<div style="position:absolute;left:141.00px;top:425.10px" class="cls_007"><span class="cls_007">We’ll move the name attributes to the </span><span class="cls_030">Person</span><span class="cls_007"> superclass because not only</span></div>
<div style="position:absolute;left:123.00px;top:437.10px" class="cls_007"><span class="cls_007">mathematicians have names. We end up with the code shown in Listing 6-4.</span></div>
<div style="position:absolute;left:123.00px;top:461.10px" class="cls_030"><span class="cls_030">class Person</span></div>
<div style="position:absolute;left:131.50px;top:471.60px" class="cls_030"><span class="cls_030">attr_accessor :first_name</span></div>
<div style="position:absolute;left:131.50px;top:482.10px" class="cls_030"><span class="cls_030">attr_accessor :last_name</span></div>
<div style="position:absolute;left:123.00px;top:492.59px" class="cls_030"><span class="cls_030">end</span></div>
<div style="position:absolute;left:123.00px;top:513.60px" class="cls_030"><span class="cls_030">class Mathematician &lt; Person</span></div>
<div style="position:absolute;left:123.00px;top:524.09px" class="cls_030"><span class="cls_030">end</span></div>
<div style="position:absolute;left:123.00px;top:546.59px" class="cls_038"><span class="cls_038">Listing 6-4: Now the name attributes are in the </span><span class="cls_014">Person</span><span class="cls_038"> superclass.</span></div>
<div style="position:absolute;left:141.00px;top:569.10px" class="cls_007"><span class="cls_007">Finally, we’ll include the </span><span class="cls_030">Professor</span><span class="cls_007"> module into the </span><span class="cls_030">Mathematician</span><span class="cls_007"> class</span></div>
<div style="position:absolute;left:123.00px;top:581.10px" class="cls_007"><span class="cls_007">at </span><span class="cls_050">u</span><span class="cls_007">. Listing 6-5 shows the completed example.</span></div>
<div style="position:absolute;left:330.67px;top:636.00px" class="cls_021"><span class="cls_021">Method Lookup and Constant Lookup</span></div>
<div style="position:absolute;left:442.93px;top:633.00px" class="cls_020"><span class="cls_020">139</span></div>
</div>
<div style="position:absolute;left:50%;margin-left:-252px;top:108160px;width:504px;height:666px;border-style:outset;overflow:hidden">
<div style="position:absolute;left:0px;top:0px">
<img src="e698b76e-46bd-11eb-8b25-0cc47a792c0a_id_e698b76e-46bd-11eb-8b25-0cc47a792c0a_files/background164.jpg" width=504 height=666></div>
<div style="position:absolute;left:120.00px;top:49.00px" class="cls_030"><span class="cls_030">class Person</span></div>
<div style="position:absolute;left:128.50px;top:59.50px" class="cls_030"><span class="cls_030">attr_accessor :first_name</span></div>
<div style="position:absolute;left:128.50px;top:70.00px" class="cls_030"><span class="cls_030">attr_accessor :last_name</span></div>
<div style="position:absolute;left:120.00px;top:80.49px" class="cls_030"><span class="cls_030">end</span></div>
<div style="position:absolute;left:120.00px;top:101.50px" class="cls_030"><span class="cls_030">module Professor</span></div>
<div style="position:absolute;left:128.50px;top:111.99px" class="cls_030"><span class="cls_030">def lectures; end</span></div>
<div style="position:absolute;left:120.00px;top:122.49px" class="cls_030"><span class="cls_030">end</span></div>
<div style="position:absolute;left:120.00px;top:143.49px" class="cls_030"><span class="cls_030">class Mathematician &lt; Person</span></div>
<div style="position:absolute;left:108.15px;top:153.99px" class="cls_046"><span class="cls_046">u</span><span class="cls_030">   include Professor</span></div>
<div style="position:absolute;left:120.00px;top:164.49px" class="cls_030"><span class="cls_030">end</span></div>
<div style="position:absolute;left:120.00px;top:186.99px" class="cls_038"><span class="cls_038">Listing 6-5: Now we have a class that includes a module and has a superclass.</span></div>
<div style="position:absolute;left:120.00px;top:222.50px" class="cls_055"><span class="cls_055">The Method Lookup Algorithm in Action</span></div>
<div style="position:absolute;left:120.00px;top:240.50px" class="cls_007"><span class="cls_007">Now that we have our example set up, we’re ready to see how Ruby finds a</span></div>
<div style="position:absolute;left:120.00px;top:252.50px" class="cls_007"><span class="cls_007">method we call. Every time you call any method in one of your programs,</span></div>
<div style="position:absolute;left:120.00px;top:264.50px" class="cls_007"><span class="cls_007">Ruby follows the same process we’re about to see here.</span></div>
<div style="position:absolute;left:138.00px;top:276.50px" class="cls_007"><span class="cls_007">To kick things off, let’s call a method. Using this code, we create a new</span></div>
<div style="position:absolute;left:120.00px;top:288.50px" class="cls_007"><span class="cls_007">mathematician object and set its first name:</span></div>
<div style="position:absolute;left:120.00px;top:312.50px" class="cls_030"><span class="cls_030">ramanujan = Mathematician.new</span></div>
<div style="position:absolute;left:120.00px;top:323.00px" class="cls_030"><span class="cls_030">ramanujan.first_name = "Srinivasa"</span></div>
<div style="position:absolute;left:138.00px;top:345.50px" class="cls_007"><span class="cls_007">To execute this code, Ruby needs to find the </span><span class="cls_030">first_name=</span><span class="cls_007"> method. Where</span></div>
<div style="position:absolute;left:120.00px;top:357.50px" class="cls_007"><span class="cls_007">is this method? How does Ruby find it exactly?</span></div>
<div style="position:absolute;left:138.00px;top:369.50px" class="cls_007"><span class="cls_007">First, Ruby gets the class from the </span><span class="cls_030">ramanujan</span><span class="cls_007"> object via the </span><span class="cls_030">klass</span><span class="cls_007"> pointer,</span></div>
<div style="position:absolute;left:120.00px;top:381.50px" class="cls_007"><span class="cls_007">as shown in Figure 6-4.</span></div>
<div style="position:absolute;left:353.61px;top:402.44px" class="cls_033"><span class="cls_033">Mathematician</span></div>
<div style="position:absolute;left:240.59px;top:423.05px" class="cls_042"><span class="cls_042">RObject</span></div>
<div style="position:absolute;left:345.37px;top:423.03px" class="cls_042"><span class="cls_042">RClass</span></div>
<div style="position:absolute;left:142.58px;top:436.06px" class="cls_014"><span class="cls_014">ramanujan</span></div>
<div style="position:absolute;left:268.08px;top:435.72px" class="cls_014"><span class="cls_014">klass</span></div>
<div style="position:absolute;left:372.86px;top:436.03px" class="cls_014"><span class="cls_014">m_tbl</span></div>
<div style="position:absolute;left:120.00px;top:463.36px" class="cls_038"><span class="cls_038">Figure 6-4: Ruby first looks for the </span><span class="cls_014">first_name=</span><span class="cls_038"> method in the object’s class.</span></div>
<div style="position:absolute;left:138.00px;top:485.86px" class="cls_007"><span class="cls_007">Next, Ruby checks to see whether </span><span class="cls_030">Mathematician</span><span class="cls_007"> implements </span><span class="cls_030">first_name=</span></div>
<div style="position:absolute;left:120.00px;top:497.86px" class="cls_007"><span class="cls_007">directly by looking through its method table, as shown in Figure 6-5.</span></div>
<div style="position:absolute;left:139.25px;top:518.80px" class="cls_033"><span class="cls_033">Mathematician</span></div>
<div style="position:absolute;left:126.25px;top:540.30px" class="cls_042"><span class="cls_042">RClass</span></div>
<div style="position:absolute;left:158.50px;top:554.93px" class="cls_014"><span class="cls_014">m_tbl</span></div>
<div style="position:absolute;left:272.48px;top:553.89px" class="cls_054"><span class="cls_054">[ empty ]</span></div>
<div style="position:absolute;left:120.00px;top:584.41px" class="cls_038"><span class="cls_038">Figure 6-5: Ruby first looks for </span><span class="cls_014">first_name=</span><span class="cls_038"> in the class’s</span></div>
<div style="position:absolute;left:120.00px;top:594.91px" class="cls_038"><span class="cls_038">method table.</span></div>
<div style="position:absolute;left:48.00px;top:633.00px" class="cls_020"><span class="cls_020">140</span></div>
<div style="position:absolute;left:74.17px;top:636.00px" class="cls_021"><span class="cls_021">Chapter 6</span></div>
</div>
<div style="position:absolute;left:50%;margin-left:-252px;top:108836px;width:504px;height:666px;border-style:outset;overflow:hidden">
<div style="position:absolute;left:0px;top:0px">
<img src="e698b76e-46bd-11eb-8b25-0cc47a792c0a_id_e698b76e-46bd-11eb-8b25-0cc47a792c0a_files/background165.jpg" width=504 height=666></div>
<div style="position:absolute;left:141.00px;top:41.60px" class="cls_007"><span class="cls_007">Because we’ve moved all of the methods down into the </span><span class="cls_030">Person</span><span class="cls_007"> super-</span></div>
<div style="position:absolute;left:123.01px;top:53.60px" class="cls_007"><span class="cls_007">class, the </span><span class="cls_030">first_name=</span><span class="cls_007"> method is no longer there. Ruby continues through</span></div>
<div style="position:absolute;left:123.00px;top:65.60px" class="cls_007"><span class="cls_007">the algorithm and gets the superclass of </span><span class="cls_030">Mathematician</span><span class="cls_007"> using the </span><span class="cls_030">super</span></div>
<div style="position:absolute;left:123.00px;top:77.60px" class="cls_007"><span class="cls_007">pointer, as shown in Figure 6-6.</span></div>
<div style="position:absolute;left:261.88px;top:98.89px" class="cls_017"><span class="cls_017">Copy of</span></div>
<div style="position:absolute;left:136.95px;top:108.21px" class="cls_033"><span class="cls_033">Mathematician</span></div>
<div style="position:absolute;left:241.78px;top:108.87px" class="cls_033"><span class="cls_033">Professor</span><span class="cls_017"> module</span></div>
<div style="position:absolute;left:128.76px;top:128.11px" class="cls_042"><span class="cls_042">RClass</span></div>
<div style="position:absolute;left:240.22px;top:128.11px" class="cls_042"><span class="cls_042">RClass</span></div>
<div style="position:absolute;left:156.20px;top:140.90px" class="cls_014"><span class="cls_014">super</span></div>
<div style="position:absolute;left:267.66px;top:140.90px" class="cls_014"><span class="cls_014">m_tbl</span></div>
<div style="position:absolute;left:367.57px;top:140.90px" class="cls_014"><span class="cls_014">lectures</span></div>
<div style="position:absolute;left:123.00px;top:168.97px" class="cls_038"><span class="cls_038">Figure 6-6: The superclass of </span><span class="cls_014">Mathematician</span><span class="cls_038"> is the copy of the </span><span class="cls_014">Professor</span><span class="cls_038"> module.</span></div>
<div style="position:absolute;left:141.00px;top:191.47px" class="cls_007"><span class="cls_007">Remember, this is not the </span><span class="cls_030">Person</span><span class="cls_007"> class; it’s the </span><span class="cls_008">included</span><span class="cls_007"> class, which is</span></div>
<div style="position:absolute;left:123.00px;top:203.47px" class="cls_007"><span class="cls_007">a copy of the </span><span class="cls_030">Professor</span><span class="cls_007"> module. This copy refers to the same method table</span></div>
<div style="position:absolute;left:123.00px;top:215.47px" class="cls_007"><span class="cls_007">as the original module, which Ruby now searches. Recall from Listing 6-5</span></div>
<div style="position:absolute;left:123.00px;top:227.47px" class="cls_007"><span class="cls_007">that </span><span class="cls_030">Professor</span><span class="cls_007"> contains only the single method </span><span class="cls_030">lectures</span><span class="cls_007">. Ruby won’t find the</span></div>
<div style="position:absolute;left:123.00px;top:239.47px" class="cls_030"><span class="cls_030">first_name=</span><span class="cls_007"> method.</span></div>
<div style="position:absolute;left:81.00px;top:265.97px" class="cls_032"><span class="cls_032">NOTE</span></div>
<div style="position:absolute;left:123.00px;top:263.47px" class="cls_008"><span class="cls_008">Notice that because Ruby inserts modules above the original superclass in the super-</span></div>
<div style="position:absolute;left:123.00px;top:275.47px" class="cls_008"><span class="cls_008">class chain, methods in an included module override methods present in a superclass.</span></div>
<div style="position:absolute;left:123.00px;top:287.47px" class="cls_008"><span class="cls_008">In this case, if </span><span class="cls_030">Professor</span><span class="cls_008"> also had a </span><span class="cls_030">first_name=</span><span class="cls_008"> method, Ruby would call it and not</span></div>
<div style="position:absolute;left:123.00px;top:299.47px" class="cls_008"><span class="cls_008">the method in </span><span class="cls_030">Person</span><span class="cls_008">.</span></div>
<div style="position:absolute;left:141.00px;top:323.47px" class="cls_007"><span class="cls_007">Because Ruby doesn’t find </span><span class="cls_030">first_name=</span><span class="cls_007"> in </span><span class="cls_030">Professor</span><span class="cls_007">, it continues to iterate</span></div>
<div style="position:absolute;left:123.00px;top:335.47px" class="cls_007"><span class="cls_007">over the </span><span class="cls_030">super</span><span class="cls_007"> pointers, but this time it uses the </span><span class="cls_030">super</span><span class="cls_007"> pointer in </span><span class="cls_030">Professor</span><span class="cls_007">, as</span></div>
<div style="position:absolute;left:123.00px;top:347.47px" class="cls_007"><span class="cls_007">shown in Figure 6-7.</span></div>
<div style="position:absolute;left:150.42px;top:368.76px" class="cls_017"><span class="cls_017">Copy of</span></div>
<div style="position:absolute;left:130.32px;top:378.74px" class="cls_033"><span class="cls_033">Professor</span><span class="cls_017"> module</span></div>
<div style="position:absolute;left:264.16px;top:378.30px" class="cls_033"><span class="cls_033">Person</span></div>
<div style="position:absolute;left:359.79px;top:384.12px" class="cls_014"><span class="cls_014">first_name=</span></div>
<div style="position:absolute;left:128.76px;top:396.70px" class="cls_042"><span class="cls_042">RClass</span></div>
<div style="position:absolute;left:240.22px;top:396.70px" class="cls_042"><span class="cls_042">RClass</span></div>
<div style="position:absolute;left:361.79px;top:401.42px" class="cls_014"><span class="cls_014">first_name</span></div>
<div style="position:absolute;left:156.20px;top:409.74px" class="cls_014"><span class="cls_014">super</span></div>
<div style="position:absolute;left:267.66px;top:409.74px" class="cls_014"><span class="cls_014">m_tbl</span></div>
<div style="position:absolute;left:361.79px;top:418.72px" class="cls_014"><span class="cls_014">last_name=</span></div>
<div style="position:absolute;left:363.79px;top:436.02px" class="cls_014"><span class="cls_014">last_name</span></div>
<div style="position:absolute;left:123.00px;top:458.51px" class="cls_038"><span class="cls_038">Figure 6-7: The </span><span class="cls_014">Person</span><span class="cls_038"> class is the superclass of the included copy of the </span><span class="cls_014">Professor</span><span class="cls_038"> module.</span></div>
<div style="position:absolute;left:141.00px;top:481.01px" class="cls_007"><span class="cls_007">Note that the superclass of the </span><span class="cls_030">Professor</span><span class="cls_007"> module—or more precisely,</span></div>
<div style="position:absolute;left:123.00px;top:493.01px" class="cls_007"><span class="cls_007">the superclass of the included copy of the </span><span class="cls_030">Professor</span><span class="cls_007"> module—is the </span><span class="cls_030">Person</span></div>
<div style="position:absolute;left:123.00px;top:505.01px" class="cls_007"><span class="cls_007">class. This was the original superclass of </span><span class="cls_030">Mathematician</span><span class="cls_007">. Finally, Ruby sees the</span></div>
<div style="position:absolute;left:123.00px;top:517.01px" class="cls_030"><span class="cls_030">first_name=</span><span class="cls_007"> method in the method table for </span><span class="cls_030">Person</span><span class="cls_007">. Because it has identified</span></div>
<div style="position:absolute;left:123.00px;top:529.01px" class="cls_007"><span class="cls_007">which class implements </span><span class="cls_030">first_name=</span><span class="cls_007">, Ruby can now call the method using the</span></div>
<div style="position:absolute;left:123.00px;top:541.01px" class="cls_007"><span class="cls_007">method dispatch process we learned about in Chapter 4.</span></div>
<div style="position:absolute;left:123.00px;top:566.01px" class="cls_055"><span class="cls_055">Multiple Inheritance in Ruby</span></div>
<div style="position:absolute;left:123.00px;top:584.01px" class="cls_007"><span class="cls_007">What is most interesting here is that internally, Ruby implements module</span></div>
<div style="position:absolute;left:123.00px;top:596.01px" class="cls_007"><span class="cls_007">inclusion using class inheritance. Essentially, there is no difference between</span></div>
<div style="position:absolute;left:123.00px;top:608.01px" class="cls_007"><span class="cls_007">including a module and specifying a superclass. Both procedures make new</span></div>
<div style="position:absolute;left:331.11px;top:636.00px" class="cls_021"><span class="cls_021">Method Lookup and Constant Lookup</span></div>
<div style="position:absolute;left:443.37px;top:633.00px" class="cls_020"><span class="cls_020">141</span></div>
</div>
<div style="position:absolute;left:50%;margin-left:-252px;top:109512px;width:504px;height:666px;border-style:outset;overflow:hidden">
<div style="position:absolute;left:0px;top:0px">
<img src="e698b76e-46bd-11eb-8b25-0cc47a792c0a_id_e698b76e-46bd-11eb-8b25-0cc47a792c0a_files/background166.jpg" width=504 height=666></div>
<div style="position:absolute;left:120.00px;top:42.28px" class="cls_007"><span class="cls_007">methods available to the target class, and both use the class’s </span><span class="cls_030">super</span><span class="cls_007"> pointer</span></div>
<div style="position:absolute;left:120.00px;top:54.28px" class="cls_007"><span class="cls_007">internally. Including multiple modules into a Ruby class is equivalent to</span></div>
<div style="position:absolute;left:120.00px;top:66.28px" class="cls_007"><span class="cls_007">specifying multiple superclasses.</span></div>
<div style="position:absolute;left:138.00px;top:78.28px" class="cls_007"><span class="cls_007">Still, Ruby keeps things simple by enforcing a single list of ancestors.</span></div>
<div style="position:absolute;left:120.00px;top:90.28px" class="cls_007"><span class="cls_007">While including multiple modules does create multiple superclasses inter-</span></div>
<div style="position:absolute;left:120.00px;top:102.28px" class="cls_007"><span class="cls_007">nally, Ruby maintains them in a single list. The result? As a Ruby developer,</span></div>
<div style="position:absolute;left:120.00px;top:114.28px" class="cls_007"><span class="cls_007">you get the benefits of multiple inheritance (adding new behavior to a class</span></div>
<div style="position:absolute;left:120.00px;top:126.28px" class="cls_007"><span class="cls_007">from as many different modules as you would like) while keeping the sim-</span></div>
<div style="position:absolute;left:120.00px;top:138.28px" class="cls_007"><span class="cls_007">plicity of the single inheritance model.</span></div>
<div style="position:absolute;left:138.00px;top:150.28px" class="cls_007"><span class="cls_007">Ruby benefits from this simplicity as well! By enforcing this single list</span></div>
<div style="position:absolute;left:120.00px;top:162.28px" class="cls_007"><span class="cls_007">of superclass ancestors, its method lookup algorithm can be very simple.</span></div>
<div style="position:absolute;left:120.00px;top:174.28px" class="cls_007"><span class="cls_007">Whenever you call a method on an object, Ruby simply has to iterate through</span></div>
<div style="position:absolute;left:120.00px;top:186.28px" class="cls_007"><span class="cls_007">the superclass linked list until it finds the class or module that contains the</span></div>
<div style="position:absolute;left:120.00px;top:198.28px" class="cls_007"><span class="cls_007">target method.</span></div>
<div style="position:absolute;left:120.00px;top:223.28px" class="cls_055"><span class="cls_055">The Global Method Cache</span></div>
<div style="position:absolute;left:120.00px;top:241.28px" class="cls_007"><span class="cls_007">Depending on the number of superclasses in the chain, method lookup</span></div>
<div style="position:absolute;left:120.00px;top:253.28px" class="cls_007"><span class="cls_007">can be time consuming. To alleviate this, Ruby caches the result of a</span></div>
<div style="position:absolute;left:120.00px;top:265.28px" class="cls_007"><span class="cls_007">lookup for later use. It records which class or module implemented the</span></div>
<div style="position:absolute;left:120.00px;top:277.28px" class="cls_007"><span class="cls_007">method that your code called in two caches: a global method cache and</span></div>
<div style="position:absolute;left:120.00px;top:289.28px" class="cls_007"><span class="cls_007">an inline method cache.</span></div>
<div style="position:absolute;left:138.00px;top:301.28px" class="cls_007"><span class="cls_007">Let’s learn about the global method cache first. Ruby uses the </span><span class="cls_008">global</span></div>
<div style="position:absolute;left:120.00px;top:313.28px" class="cls_008"><span class="cls_008">method cache</span><span class="cls_007"> to save a mapping between the receiver and implementer</span></div>
<div style="position:absolute;left:120.00px;top:325.28px" class="cls_007"><span class="cls_007">classes, as shown in Table 6-1.</span></div>
<div style="position:absolute;left:120.00px;top:350.28px" class="cls_059"><span class="cls_059">Table 6-1: </span><span class="cls_017">An Example of What the Global Method Cache Might Contain</span></div>
<div style="position:absolute;left:124.00px;top:367.62px" class="cls_040"><span class="cls_040">klass</span></div>
<div style="position:absolute;left:265.60px;top:367.62px" class="cls_040"><span class="cls_040">defined_class</span></div>
<div style="position:absolute;left:124.00px;top:383.19px" class="cls_009"><span class="cls_009">Fixnum#times</span></div>
<div style="position:absolute;left:265.60px;top:383.19px" class="cls_009"><span class="cls_009">Integer#times</span></div>
<div style="position:absolute;left:124.00px;top:396.77px" class="cls_009"><span class="cls_009">Object#puts</span></div>
<div style="position:absolute;left:265.60px;top:396.77px" class="cls_009"><span class="cls_009">BasicObject#puts</span></div>
<div style="position:absolute;left:124.00px;top:410.42px" class="cls_039"><span class="cls_039">etc...</span></div>
<div style="position:absolute;left:265.60px;top:410.42px" class="cls_039"><span class="cls_039">etc...</span></div>
<div style="position:absolute;left:138.00px;top:437.42px" class="cls_007"><span class="cls_007">The left column in Table 6-1, </span><span class="cls_030">klass</span><span class="cls_007">, shows the receiver class; this is the</span></div>
<div style="position:absolute;left:120.00px;top:449.42px" class="cls_007"><span class="cls_007">class of the object you call a method on. The right column, </span><span class="cls_030">defined_class</span><span class="cls_007">,</span></div>
<div style="position:absolute;left:120.00px;top:461.42px" class="cls_007"><span class="cls_007">records the result of the method lookup. This is the implementer class, or</span></div>
<div style="position:absolute;left:120.00px;top:473.42px" class="cls_007"><span class="cls_007">the class that implements the method Ruby was looking for.</span></div>
<div style="position:absolute;left:138.00px;top:485.42px" class="cls_007"><span class="cls_007">Let’s take the first row of Table 6-1 as an example; it reads </span><span class="cls_030">Fixnum#times</span></div>
<div style="position:absolute;left:120.00px;top:497.42px" class="cls_007"><span class="cls_007">and </span><span class="cls_030">Integer#times</span><span class="cls_007">. In the global method cache, this information means</span></div>
<div style="position:absolute;left:120.00px;top:509.42px" class="cls_007"><span class="cls_007">that Ruby’s method lookup algorithm started to look for the </span><span class="cls_030">times</span><span class="cls_007"> method</span></div>
<div style="position:absolute;left:120.00px;top:521.42px" class="cls_007"><span class="cls_007">in the </span><span class="cls_030">Fixnum</span><span class="cls_007"> class but actually found it in the </span><span class="cls_030">Integer</span><span class="cls_007"> class. In a similar way,</span></div>
<div style="position:absolute;left:120.00px;top:533.42px" class="cls_007"><span class="cls_007">the second row of Table 6-1 means that Ruby started to look for the </span><span class="cls_030">puts</span></div>
<div style="position:absolute;left:120.00px;top:545.42px" class="cls_007"><span class="cls_007">method in the </span><span class="cls_030">Object</span><span class="cls_007"> class but actually found it in the </span><span class="cls_030">BasicObject</span><span class="cls_007"> class.</span></div>
<div style="position:absolute;left:138.00px;top:557.42px" class="cls_007"><span class="cls_007">The global method cache allows Ruby to skip the method lookup pro-</span></div>
<div style="position:absolute;left:120.00px;top:569.42px" class="cls_007"><span class="cls_007">cess the next time your code calls a method listed in the first column of the</span></div>
<div style="position:absolute;left:120.00px;top:581.42px" class="cls_007"><span class="cls_007">global cache. After your code has called </span><span class="cls_030">Fixnum#times</span><span class="cls_007"> once, Ruby knows that</span></div>
<div style="position:absolute;left:120.00px;top:593.42px" class="cls_007"><span class="cls_007">it can execute the </span><span class="cls_030">Integer#times</span><span class="cls_007"> method, regardless of from where in your</span></div>
<div style="position:absolute;left:120.00px;top:605.42px" class="cls_007"><span class="cls_007">program you call </span><span class="cls_030">times</span><span class="cls_007">.</span></div>
<div style="position:absolute;left:48.00px;top:633.00px" class="cls_020"><span class="cls_020">142</span></div>
<div style="position:absolute;left:73.90px;top:636.00px" class="cls_021"><span class="cls_021">Chapter 6</span></div>
</div>
<div style="position:absolute;left:50%;margin-left:-252px;top:110188px;width:504px;height:666px;border-style:outset;overflow:hidden">
<div style="position:absolute;left:0px;top:0px">
<img src="e698b76e-46bd-11eb-8b25-0cc47a792c0a_id_e698b76e-46bd-11eb-8b25-0cc47a792c0a_files/background167.jpg" width=504 height=666></div>
<div style="position:absolute;left:123.00px;top:42.05px" class="cls_055"><span class="cls_055">The Inline Method Cache</span></div>
<div style="position:absolute;left:123.00px;top:60.05px" class="cls_007"><span class="cls_007">Ruby uses another type of cache, called an </span><span class="cls_008">inline method cache</span><span class="cls_007">, to speed up</span></div>
<div style="position:absolute;left:123.00px;top:72.05px" class="cls_007"><span class="cls_007">method lookup even more. The inline cache saves information alongside</span></div>
<div style="position:absolute;left:123.00px;top:84.05px" class="cls_007"><span class="cls_007">the compiled YARV instructions that Ruby executes (see Figure 6-8).</span></div>
<div style="position:absolute;left:126.07px;top:109.52px" class="cls_014"><span class="cls_014">putobject 10</span></div>
<div style="position:absolute;left:126.07px;top:119.36px" class="cls_014"><span class="cls_014">send</span></div>
<div style="position:absolute;left:166.07px;top:119.36px" class="cls_014"><span class="cls_014">&lt;callinfo!mid:times, argc:0,</span></div>
<div style="position:absolute;left:166.07px;top:129.58px" class="cls_014"><span class="cls_014">block:block in &lt;compiled>></span></div>
<div style="position:absolute;left:353.05px;top:129.60px" class="cls_014"><span class="cls_014">Integer#times</span></div>
<div style="position:absolute;left:123.00px;top:160.86px" class="cls_038"><span class="cls_038">Figure 6-8: The YARV instructions on the left should call the implementation of</span></div>
<div style="position:absolute;left:123.00px;top:171.36px" class="cls_014"><span class="cls_014">Integer#times</span><span class="cls_038"> on the right.</span></div>
<div style="position:absolute;left:141.00px;top:193.86px" class="cls_007"><span class="cls_007">On the left side of this figure, we see the compiled YARV instructions</span></div>
<div style="position:absolute;left:123.00px;top:205.86px" class="cls_007"><span class="cls_007">that correspond to the code </span><span class="cls_030">10.times do... end</span><span class="cls_007">. First, </span><span class="cls_030">putobject 10</span><span class="cls_007"> pushes</span></div>
<div style="position:absolute;left:123.00px;top:217.86px" class="cls_007"><span class="cls_007">the </span><span class="cls_030">Fixnum</span><span class="cls_007"> object </span><span class="cls_030">10</span><span class="cls_007"> onto YARV’s internal stack. This is the receiver of the</span></div>
<div style="position:absolute;left:123.00px;top:229.86px" class="cls_030"><span class="cls_030">times</span><span class="cls_007"> method call. Next, </span><span class="cls_030">send</span><span class="cls_007"> calls the </span><span class="cls_030">times</span><span class="cls_007"> method, as indicated by the text</span></div>
<div style="position:absolute;left:123.00px;top:241.86px" class="cls_007"><span class="cls_007">between the angle brackets.</span></div>
<div style="position:absolute;left:141.00px;top:253.86px" class="cls_007"><span class="cls_007">The rectangle on the right side of the figure represents the </span><span class="cls_030">Integer#times</span></div>
<div style="position:absolute;left:123.00px;top:265.86px" class="cls_007"><span class="cls_007">method, which Ruby found using its method lookup algorithm (after look-</span></div>
<div style="position:absolute;left:123.00px;top:277.86px" class="cls_007"><span class="cls_007">ing up the </span><span class="cls_030">times</span><span class="cls_007"> method among the </span><span class="cls_030">Fixnum</span><span class="cls_007"> class and its superclasses). Ruby’s</span></div>
<div style="position:absolute;left:123.00px;top:289.86px" class="cls_007"><span class="cls_007">inline cache enables it to save the mapping between the </span><span class="cls_030">times</span><span class="cls_007"> method</span></div>
<div style="position:absolute;left:123.00px;top:301.86px" class="cls_007"><span class="cls_007">call and the </span><span class="cls_030">Integer#times</span><span class="cls_007"> implementation right in the YARV instructions.</span></div>
<div style="position:absolute;left:123.00px;top:313.86px" class="cls_007"><span class="cls_007">Figure 6-9 shows how the inline cache might look.</span></div>
<div style="position:absolute;left:126.07px;top:339.33px" class="cls_014"><span class="cls_014">putobject 10</span></div>
<div style="position:absolute;left:126.07px;top:359.01px" class="cls_014"><span class="cls_014">send</span></div>
<div style="position:absolute;left:179.03px;top:359.00px" class="cls_014"><span class="cls_014">Integer#times</span></div>
<div style="position:absolute;left:351.05px;top:359.41px" class="cls_014"><span class="cls_014">Integer#times</span></div>
<div style="position:absolute;left:123.00px;top:388.32px" class="cls_038"><span class="cls_038">Figure 6-9: The inline cache saves the result of method lookup next to the </span><span class="cls_014">send</span></div>
<div style="position:absolute;left:123.00px;top:398.82px" class="cls_038"><span class="cls_038">instruction that needs to call the method.</span></div>
<div style="position:absolute;left:141.00px;top:421.32px" class="cls_007"><span class="cls_007">If Ruby executes this line of code again, it will immediately execute</span></div>
<div style="position:absolute;left:123.00px;top:433.32px" class="cls_030"><span class="cls_030">Integer#times</span><span class="cls_007"> without having to call the method lookup algorithm.</span></div>
<div style="position:absolute;left:123.00px;top:458.32px" class="cls_055"><span class="cls_055">Clearing Ruby’s Method Caches</span></div>
<div style="position:absolute;left:123.00px;top:476.32px" class="cls_007"><span class="cls_007">Because Ruby is a dynamic language, you can define new methods when</span></div>
<div style="position:absolute;left:123.00px;top:488.32px" class="cls_007"><span class="cls_007">you like. In order for you to be able to do so, Ruby must clear the global and</span></div>
<div style="position:absolute;left:123.00px;top:500.32px" class="cls_007"><span class="cls_007">inline method caches, because the results of method lookups might change.</span></div>
<div style="position:absolute;left:123.00px;top:512.32px" class="cls_007"><span class="cls_007">For example, if we add a new definition of the </span><span class="cls_030">times</span><span class="cls_007"> method to the </span><span class="cls_030">Fixnum</span></div>
<div style="position:absolute;left:123.00px;top:524.32px" class="cls_007"><span class="cls_007">or </span><span class="cls_030">Integer</span><span class="cls_007"> classes, Ruby would need to call the new </span><span class="cls_030">times</span><span class="cls_007"> method, not the</span></div>
<div style="position:absolute;left:123.00px;top:536.32px" class="cls_030"><span class="cls_030">Integer#times</span><span class="cls_007"> method that it was previously using.</span></div>
<div style="position:absolute;left:141.00px;top:548.32px" class="cls_007"><span class="cls_007">In effect, whenever you create or remove (</span><span class="cls_008">undefine</span><span class="cls_007">) a method, include</span></div>
<div style="position:absolute;left:123.00px;top:560.32px" class="cls_007"><span class="cls_007">a module into a class, or perform a similar action, Ruby clears the global</span></div>
<div style="position:absolute;left:123.00px;top:572.32px" class="cls_007"><span class="cls_007">and inline method caches, forcing a new call to the method lookup code.</span></div>
<div style="position:absolute;left:123.00px;top:584.32px" class="cls_007"><span class="cls_007">Ruby also clears the cache when you use refinements or employ other types</span></div>
<div style="position:absolute;left:330.53px;top:636.00px" class="cls_021"><span class="cls_021">Method Lookup and Constant Lookup</span></div>
<div style="position:absolute;left:442.80px;top:633.00px" class="cls_020"><span class="cls_020">143</span></div>
</div>
<div style="position:absolute;left:50%;margin-left:-252px;top:110864px;width:504px;height:666px;border-style:outset;overflow:hidden">
<div style="position:absolute;left:0px;top:0px">
<img src="e698b76e-46bd-11eb-8b25-0cc47a792c0a_id_e698b76e-46bd-11eb-8b25-0cc47a792c0a_files/background168.jpg" width=504 height=666></div>
<div style="position:absolute;left:120.00px;top:42.28px" class="cls_007"><span class="cls_007">of metaprogramming. In fact, clearing the cache happens quite frequently</span></div>
<div style="position:absolute;left:120.00px;top:54.28px" class="cls_007"><span class="cls_007">in Ruby. The global and inline method caches might remain valid for only a</span></div>
<div style="position:absolute;left:120.00px;top:66.28px" class="cls_007"><span class="cls_007">short time.</span></div>
<div style="position:absolute;left:120.00px;top:91.28px" class="cls_055"><span class="cls_055">Including Two Modules into One Class</span></div>
<div style="position:absolute;left:120.00px;top:109.28px" class="cls_007"><span class="cls_007">While Ruby’s method lookup algorithm may be simple, the code that it</span></div>
<div style="position:absolute;left:120.00px;top:121.28px" class="cls_007"><span class="cls_007">uses to include modules is not. As we saw above, when you include a mod-</span></div>
<div style="position:absolute;left:120.00px;top:133.28px" class="cls_007"><span class="cls_007">ule into a class, Ruby inserts a copy of the module into the class’s ancestor</span></div>
<div style="position:absolute;left:120.00px;top:145.28px" class="cls_007"><span class="cls_007">chain. This means that if you include two modules, one after the other, the</span></div>
<div style="position:absolute;left:120.00px;top:157.28px" class="cls_007"><span class="cls_007">second module appears first in the ancestor chain and is found first by Ruby’s</span></div>
<div style="position:absolute;left:120.00px;top:169.28px" class="cls_007"><span class="cls_007">method lookup logic.</span></div>
<div style="position:absolute;left:138.00px;top:181.28px" class="cls_007"><span class="cls_007">For example, suppose we include two modules into </span><span class="cls_030">Mathematician</span><span class="cls_007">, as</span></div>
<div style="position:absolute;left:120.00px;top:193.28px" class="cls_007"><span class="cls_007">shown in Listing 6-6.</span></div>
<div style="position:absolute;left:120.00px;top:217.28px" class="cls_030"><span class="cls_030">class Mathematician &lt; Person</span></div>
<div style="position:absolute;left:128.50px;top:227.78px" class="cls_030"><span class="cls_030">include Professor</span></div>
<div style="position:absolute;left:128.50px;top:238.27px" class="cls_030"><span class="cls_030">include Employee</span></div>
<div style="position:absolute;left:120.00px;top:248.77px" class="cls_030"><span class="cls_030">end</span></div>
<div style="position:absolute;left:120.00px;top:271.27px" class="cls_038"><span class="cls_038">Listing 6-6: Including two modules into one class</span></div>
<div style="position:absolute;left:138.00px;top:293.78px" class="cls_007"><span class="cls_007">Now </span><span class="cls_030">Mathematician</span><span class="cls_007"> objects have methods from the </span><span class="cls_030">Professor</span><span class="cls_007"> module, the</span></div>
<div style="position:absolute;left:120.00px;top:305.78px" class="cls_030"><span class="cls_030">Employee</span><span class="cls_007"> module, and the </span><span class="cls_030">Person</span><span class="cls_007"> class. But which methods does Ruby find</span></div>
<div style="position:absolute;left:120.00px;top:317.78px" class="cls_007"><span class="cls_007">first and which methods override which?</span></div>
<div style="position:absolute;left:138.00px;top:329.78px" class="cls_007"><span class="cls_007">Figures 6-10 and 6-11 show the order of precedence. Because we include</span></div>
<div style="position:absolute;left:120.00px;top:341.78px" class="cls_007"><span class="cls_007">the </span><span class="cls_030">Professor</span><span class="cls_007"> module first, Ruby inserts the included class corresponding</span></div>
<div style="position:absolute;left:120.00px;top:353.78px" class="cls_007"><span class="cls_007">to the </span><span class="cls_030">Professor</span><span class="cls_007"> module as a superclass first.</span></div>
<div style="position:absolute;left:187.90px;top:380.10px" class="cls_042"><span class="cls_042">RClass</span></div>
<div style="position:absolute;left:120.00px;top:387.31px" class="cls_019"><span class="cls_019">Mathematician</span></div>
<div style="position:absolute;left:200.89px;top:392.53px" class="cls_067"><span class="cls_067">super</span></div>
<div style="position:absolute;left:263.07px;top:428.75px" class="cls_042"><span class="cls_042">RClass</span></div>
<div style="position:absolute;left:379.24px;top:428.75px" class="cls_042"><span class="cls_042">RClass</span></div>
<div style="position:absolute;left:276.05px;top:441.18px" class="cls_067"><span class="cls_067">super</span></div>
<div style="position:absolute;left:392.23px;top:441.18px" class="cls_067"><span class="cls_067">super</span></div>
<div style="position:absolute;left:334.62px;top:447.36px" class="cls_017"><span class="cls_017">copy</span></div>
<div style="position:absolute;left:269.61px;top:470.31px" class="cls_017"><span class="cls_017">Included</span></div>
<div style="position:absolute;left:381.98px;top:470.31px" class="cls_019"><span class="cls_019">Professor</span></div>
<div style="position:absolute;left:187.90px;top:480.63px" class="cls_042"><span class="cls_042">RClass</span></div>
<div style="position:absolute;left:276.71px;top:481.53px" class="cls_017"><span class="cls_017">class</span></div>
<div style="position:absolute;left:135.75px;top:487.84px" class="cls_019"><span class="cls_019">Person</span></div>
<div style="position:absolute;left:200.89px;top:493.06px" class="cls_067"><span class="cls_067">super</span></div>
<div style="position:absolute;left:120.00px;top:519.71px" class="cls_038"><span class="cls_038">Figure 6-10: In Listing 6-6 we include the </span><span class="cls_014">Professor</span><span class="cls_038"> module first.</span></div>
<div style="position:absolute;left:138.00px;top:542.21px" class="cls_007"><span class="cls_007">Now, when we include the </span><span class="cls_030">Employee</span><span class="cls_007"> module, the included class for the</span></div>
<div style="position:absolute;left:120.00px;top:554.21px" class="cls_030"><span class="cls_030">Employee</span><span class="cls_007"> module is inserted above the included class for the </span><span class="cls_030">Professor</span><span class="cls_007"> mod-</span></div>
<div style="position:absolute;left:120.00px;top:566.21px" class="cls_007"><span class="cls_007">ule, as shown in Figure 6-11.</span></div>
<div style="position:absolute;left:48.00px;top:633.00px" class="cls_020"><span class="cls_020">144</span></div>
<div style="position:absolute;left:74.20px;top:636.00px" class="cls_021"><span class="cls_021">Chapter 6</span></div>
</div>
<div style="position:absolute;left:50%;margin-left:-252px;top:111540px;width:504px;height:666px;border-style:outset;overflow:hidden">
<div style="position:absolute;left:0px;top:0px">
<img src="e698b76e-46bd-11eb-8b25-0cc47a792c0a_id_e698b76e-46bd-11eb-8b25-0cc47a792c0a_files/background169.jpg" width=504 height=666></div>
<div style="position:absolute;left:192.82px;top:48.71px" class="cls_042"><span class="cls_042">RClass</span></div>
<div style="position:absolute;left:123.00px;top:60.68px" class="cls_033"><span class="cls_033">Mathematician</span></div>
<div style="position:absolute;left:205.32px;top:60.89px" class="cls_014"><span class="cls_014">super</span></div>
<div style="position:absolute;left:266.46px;top:96.37px" class="cls_042"><span class="cls_042">RClass</span></div>
<div style="position:absolute;left:380.29px;top:96.37px" class="cls_042"><span class="cls_042">RClass</span></div>
<div style="position:absolute;left:278.97px;top:108.55px" class="cls_014"><span class="cls_014">super</span></div>
<div style="position:absolute;left:392.80px;top:108.55px" class="cls_014"><span class="cls_014">super</span></div>
<div style="position:absolute;left:336.37px;top:116.52px" class="cls_017"><span class="cls_017">copy</span></div>
<div style="position:absolute;left:261.78px;top:137.48px" class="cls_017"><span class="cls_017">Included class</span></div>
<div style="position:absolute;left:384.80px;top:137.48px" class="cls_033"><span class="cls_033">Employee</span></div>
<div style="position:absolute;left:125.06px;top:148.93px" class="cls_017"><span class="cls_017">Included class</span></div>
<div style="position:absolute;left:192.82px;top:146.81px" class="cls_042"><span class="cls_042">RClass</span></div>
<div style="position:absolute;left:264.31px;top:148.48px" class="cls_017"><span class="cls_017">for </span><span class="cls_033">Employee</span></div>
<div style="position:absolute;left:125.34px;top:159.93px" class="cls_017"><span class="cls_017">for </span><span class="cls_033">Professor</span></div>
<div style="position:absolute;left:205.32px;top:158.99px" class="cls_014"><span class="cls_014">super</span></div>
<div style="position:absolute;left:192.82px;top:216.11px" class="cls_042"><span class="cls_042">RClass</span></div>
<div style="position:absolute;left:138.75px;top:228.07px" class="cls_033"><span class="cls_033">Person</span></div>
<div style="position:absolute;left:205.32px;top:228.29px" class="cls_014"><span class="cls_014">super</span></div>
<div style="position:absolute;left:123.00px;top:254.76px" class="cls_038"><span class="cls_038">Figure 6-11: In Listing 6-6 we include the </span><span class="cls_014">Employee</span><span class="cls_038"> module second, after including</span></div>
<div style="position:absolute;left:123.00px;top:265.26px" class="cls_014"><span class="cls_014">Professor</span><span class="cls_038">.</span></div>
<div style="position:absolute;left:141.00px;top:287.76px" class="cls_007"><span class="cls_007">Because </span><span class="cls_030">Employee</span><span class="cls_007"> appears above </span><span class="cls_030">Professor</span><span class="cls_007"> in the superclass chain, as</span></div>
<div style="position:absolute;left:123.00px;top:299.76px" class="cls_007"><span class="cls_007">shown along the left side of Figure 6-11, methods from </span><span class="cls_030">Employee</span><span class="cls_007"> override</span></div>
<div style="position:absolute;left:123.00px;top:311.76px" class="cls_007"><span class="cls_007">methods from </span><span class="cls_030">Professor</span><span class="cls_007">, which in turn override methods from </span><span class="cls_030">Person</span><span class="cls_007">, the</span></div>
<div style="position:absolute;left:123.00px;top:323.76px" class="cls_007"><span class="cls_007">actual superclass.</span></div>
<div style="position:absolute;left:123.00px;top:348.76px" class="cls_055"><span class="cls_055">Including One Module into Another</span></div>
<div style="position:absolute;left:123.00px;top:366.76px" class="cls_007"><span class="cls_007">Modules don’t allow you to specify superclasses. For example, we can’t write</span></div>
<div style="position:absolute;left:123.00px;top:378.76px" class="cls_007"><span class="cls_007">the following:</span></div>
<div style="position:absolute;left:123.00px;top:402.76px" class="cls_030"><span class="cls_030">module Professor &lt; Employee</span></div>
<div style="position:absolute;left:123.00px;top:413.26px" class="cls_030"><span class="cls_030">end</span></div>
<div style="position:absolute;left:141.00px;top:435.76px" class="cls_007"><span class="cls_007">But we can include one module into another, as shown in Listing 6-7.</span></div>
<div style="position:absolute;left:123.00px;top:459.76px" class="cls_030"><span class="cls_030">module Professor</span></div>
<div style="position:absolute;left:131.50px;top:470.26px" class="cls_030"><span class="cls_030">include Employee</span></div>
<div style="position:absolute;left:123.00px;top:480.75px" class="cls_030"><span class="cls_030">end</span></div>
<div style="position:absolute;left:123.00px;top:503.25px" class="cls_038"><span class="cls_038">Listing 6-7: One module including another module</span></div>
<div style="position:absolute;left:141.00px;top:525.76px" class="cls_007"><span class="cls_007">What if we include </span><span class="cls_030">Professor</span><span class="cls_007">, a module with other modules included</span></div>
<div style="position:absolute;left:123.00px;top:537.76px" class="cls_007"><span class="cls_007">into it, into </span><span class="cls_030">Mathematician</span><span class="cls_007">? Which methods will Ruby find first? As shown in</span></div>
<div style="position:absolute;left:123.00px;top:549.76px" class="cls_007"><span class="cls_007">Figure 6-12, when we include </span><span class="cls_030">Employee</span><span class="cls_007"> into </span><span class="cls_030">Professor</span><span class="cls_007">, Ruby creates a copy of</span></div>
<div style="position:absolute;left:123.00px;top:561.76px" class="cls_030"><span class="cls_030">Employee</span><span class="cls_007"> and sets it as the superclass of </span><span class="cls_030">Professor</span><span class="cls_007">.</span></div>
<div style="position:absolute;left:330.78px;top:636.00px" class="cls_021"><span class="cls_021">Method Lookup and Constant Lookup</span></div>
<div style="position:absolute;left:443.04px;top:633.00px" class="cls_020"><span class="cls_020">145</span></div>
</div>
<div style="position:absolute;left:50%;margin-left:-252px;top:112216px;width:504px;height:666px;border-style:outset;overflow:hidden">
<div style="position:absolute;left:0px;top:0px">
<img src="e698b76e-46bd-11eb-8b25-0cc47a792c0a_id_e698b76e-46bd-11eb-8b25-0cc47a792c0a_files/background170.jpg" width=504 height=666></div>
<div style="position:absolute;left:128.81px;top:43.54px" class="cls_033"><span class="cls_033">Professor</span></div>
<div style="position:absolute;left:126.44px;top:66.45px" class="cls_042"><span class="cls_042">RClass</span></div>
<div style="position:absolute;left:139.75px;top:80.39px" class="cls_014"><span class="cls_014">super</span></div>
<div style="position:absolute;left:127.14px;top:137.71px" class="cls_042"><span class="cls_042">RClass</span></div>
<div style="position:absolute;left:239.66px;top:137.71px" class="cls_042"><span class="cls_042">RClass</span></div>
<div style="position:absolute;left:139.75px;top:149.94px" class="cls_014"><span class="cls_014">super</span></div>
<div style="position:absolute;left:252.28px;top:149.94px" class="cls_014"><span class="cls_014">super</span></div>
<div style="position:absolute;left:196.30px;top:156.48px" class="cls_017"><span class="cls_017">copy</span></div>
<div style="position:absolute;left:122.57px;top:179.57px" class="cls_017"><span class="cls_017">Included class</span></div>
<div style="position:absolute;left:244.28px;top:179.97px" class="cls_033"><span class="cls_033">Employee</span></div>
<div style="position:absolute;left:125.10px;top:190.62px" class="cls_017"><span class="cls_017">for </span><span class="cls_033">Employee</span></div>
<div style="position:absolute;left:120.00px;top:210.61px" class="cls_038"><span class="cls_038">Figure 6-12: When you include one module</span></div>
<div style="position:absolute;left:120.00px;top:221.11px" class="cls_038"><span class="cls_038">into another, Ruby sets it as the superclass</span></div>
<div style="position:absolute;left:120.00px;top:231.61px" class="cls_038"><span class="cls_038">of the target module.</span></div>
<div style="position:absolute;left:138.00px;top:254.11px" class="cls_007"><span class="cls_007">Modules can’t have a superclass in your code, but they can inside Ruby</span></div>
<div style="position:absolute;left:120.00px;top:266.11px" class="cls_007"><span class="cls_007">because Ruby represents modules with classes internally!</span></div>
<div style="position:absolute;left:138.00px;top:278.11px" class="cls_007"><span class="cls_007">Finally, when we include </span><span class="cls_030">Professor</span><span class="cls_007"> into </span><span class="cls_030">Mathematician</span><span class="cls_007">, Ruby iterates over</span></div>
<div style="position:absolute;left:120.00px;top:290.11px" class="cls_007"><span class="cls_007">the two modules and inserts them both as superclasses of </span><span class="cls_030">Mathematician</span><span class="cls_007">, as</span></div>
<div style="position:absolute;left:120.00px;top:302.11px" class="cls_007"><span class="cls_007">shown in Figure 6-13.</span></div>
<div style="position:absolute;left:135.53px;top:333.55px" class="cls_042"><span class="cls_042">RClass</span></div>
<div style="position:absolute;left:66.00px;top:338.75px" class="cls_033"><span class="cls_033">Mathematician</span></div>
<div style="position:absolute;left:190.27px;top:337.57px" class="cls_017"><span class="cls_017">Included class</span></div>
<div style="position:absolute;left:144.17px;top:344.73px" class="cls_014"><span class="cls_014">super</span></div>
<div style="position:absolute;left:190.55px;top:348.37px" class="cls_017"><span class="cls_017">for </span><span class="cls_033">Professor</span></div>
<div style="position:absolute;left:294.08px;top:348.69px" class="cls_033"><span class="cls_033">Professor</span></div>
<div style="position:absolute;left:198.80px;top:368.93px" class="cls_042"><span class="cls_042">RClass</span></div>
<div style="position:absolute;left:295.68px;top:367.16px" class="cls_042"><span class="cls_042">RClass</span></div>
<div style="position:absolute;left:306.01px;top:377.76px" class="cls_014"><span class="cls_014">super</span></div>
<div style="position:absolute;left:207.45px;top:380.11px" class="cls_014"><span class="cls_014">super</span></div>
<div style="position:absolute;left:255.84px;top:384.61px" class="cls_017"><span class="cls_017">copy</span></div>
<div style="position:absolute;left:198.80px;top:426.81px" class="cls_042"><span class="cls_042">RClass</span></div>
<div style="position:absolute;left:296.26px;top:426.46px" class="cls_042"><span class="cls_042">RClass</span></div>
<div style="position:absolute;left:389.22px;top:426.46px" class="cls_042"><span class="cls_042">RClass</span></div>
<div style="position:absolute;left:207.45px;top:437.76px" class="cls_014"><span class="cls_014">super</span></div>
<div style="position:absolute;left:307.65px;top:435.64px" class="cls_014"><span class="cls_014">super</span></div>
<div style="position:absolute;left:400.61px;top:435.64px" class="cls_014"><span class="cls_014">super</span></div>
<div style="position:absolute;left:255.84px;top:443.57px" class="cls_017"><span class="cls_017">copy</span></div>
<div style="position:absolute;left:352.53px;top:443.57px" class="cls_017"><span class="cls_017">copy</span></div>
<div style="position:absolute;left:201.01px;top:460.13px" class="cls_017"><span class="cls_017">Included</span></div>
<div style="position:absolute;left:287.14px;top:460.13px" class="cls_017"><span class="cls_017">Included class</span></div>
<div style="position:absolute;left:389.87px;top:459.77px" class="cls_033"><span class="cls_033">Employee</span></div>
<div style="position:absolute;left:135.53px;top:469.52px" class="cls_042"><span class="cls_042">RClass</span></div>
<div style="position:absolute;left:201.17px;top:470.93px" class="cls_017"><span class="cls_017">class #2</span></div>
<div style="position:absolute;left:289.67px;top:470.93px" class="cls_017"><span class="cls_017">for </span><span class="cls_033">Employee</span></div>
<div style="position:absolute;left:81.75px;top:474.71px" class="cls_033"><span class="cls_033">Person</span></div>
<div style="position:absolute;left:144.17px;top:480.70px" class="cls_014"><span class="cls_014">super</span></div>
<div style="position:absolute;left:192.80px;top:481.73px" class="cls_017"><span class="cls_017">for </span><span class="cls_033">Employee</span></div>
<div style="position:absolute;left:66.00px;top:509.69px" class="cls_038"><span class="cls_038">Figure 6-13: Including two modules into a class at the same time</span></div>
<div style="position:absolute;left:138.00px;top:535.19px" class="cls_007"><span class="cls_007">Now Ruby will find the methods in </span><span class="cls_030">Professor</span><span class="cls_007"> first and </span><span class="cls_030">Employee</span><span class="cls_007"> second.</span></div>
<div style="position:absolute;left:120.00px;top:560.19px" class="cls_055"><span class="cls_055">A Module#prepend Example</span></div>
<div style="position:absolute;left:120.00px;top:578.19px" class="cls_007"><span class="cls_007">In Figure 6-2 we saw how Ruby includes a module into a class. Specifically,</span></div>
<div style="position:absolute;left:120.00px;top:590.19px" class="cls_007"><span class="cls_007">we saw how Ruby inserts a copy of the module’s </span><span class="cls_030">RClass</span><span class="cls_007"> structure into the</span></div>
<div style="position:absolute;left:120.00px;top:602.19px" class="cls_007"><span class="cls_007">superclass chain for the target class, between the class and its superclass.</span></div>
<div style="position:absolute;left:48.00px;top:633.00px" class="cls_020"><span class="cls_020">146</span></div>
<div style="position:absolute;left:74.16px;top:636.00px" class="cls_021"><span class="cls_021">Chapter 6</span></div>
</div>
<div style="position:absolute;left:50%;margin-left:-252px;top:112892px;width:504px;height:666px;border-style:outset;overflow:hidden">
<div style="position:absolute;left:0px;top:0px">
<img src="e698b76e-46bd-11eb-8b25-0cc47a792c0a_id_e698b76e-46bd-11eb-8b25-0cc47a792c0a_files/background171.jpg" width=504 height=666></div>
<div style="position:absolute;left:141.00px;top:41.60px" class="cls_007"><span class="cls_007">Beginning with version 2.0, Ruby now allows you to “prepend” a mod-</span></div>
<div style="position:absolute;left:123.00px;top:53.60px" class="cls_007"><span class="cls_007">ule into a class. We’ll use the </span><span class="cls_030">Mathematician</span><span class="cls_007"> class to explain, as shown in</span></div>
<div style="position:absolute;left:123.00px;top:65.60px" class="cls_007"><span class="cls_007">Listing 6-8.</span></div>
<div style="position:absolute;left:123.00px;top:89.60px" class="cls_030"><span class="cls_030">class Mathematician</span></div>
<div style="position:absolute;left:111.15px;top:100.10px" class="cls_046"><span class="cls_046">u</span><span class="cls_030">   attr_accessor :name</span></div>
<div style="position:absolute;left:123.00px;top:110.60px" class="cls_030"><span class="cls_030">end</span></div>
<div style="position:absolute;left:123.00px;top:131.60px" class="cls_030"><span class="cls_030">poincaré = Mathematician.new</span></div>
<div style="position:absolute;left:123.00px;top:142.10px" class="cls_030"><span class="cls_030">poincaré.name = "Henri Poincaré"</span></div>
<div style="position:absolute;left:111.15px;top:152.59px" class="cls_046"><span class="cls_046">v</span><span class="cls_030"> p poincaré.name</span></div>
<div style="position:absolute;left:127.25px;top:163.09px" class="cls_030"><span class="cls_030">=> "Henri Poincaré"</span></div>
<div style="position:absolute;left:123.00px;top:185.59px" class="cls_038"><span class="cls_038">Listing 6-8: A simple Ruby class with a </span><span class="cls_014">name</span><span class="cls_038"> attribute</span></div>
<div style="position:absolute;left:141.00px;top:208.10px" class="cls_007"><span class="cls_007">First, we define the </span><span class="cls_030">Mathematician</span><span class="cls_007"> class with just the single attribute </span><span class="cls_030">name</span></div>
<div style="position:absolute;left:123.00px;top:220.10px" class="cls_007"><span class="cls_007">at </span><span class="cls_050">u</span><span class="cls_007">. Then, we create an instance of </span><span class="cls_030">Mathematician</span><span class="cls_007">, set its name, and display</span></div>
<div style="position:absolute;left:123.00px;top:232.10px" class="cls_007"><span class="cls_007">it at </span><span class="cls_050">v</span><span class="cls_007">.</span></div>
<div style="position:absolute;left:141.00px;top:244.10px" class="cls_007"><span class="cls_007">Now suppose we make all of our mathematicians professors by includ-</span></div>
<div style="position:absolute;left:123.00px;top:256.10px" class="cls_007"><span class="cls_007">ing the </span><span class="cls_030">Professor</span><span class="cls_007"> module into the </span><span class="cls_030">Mathematician</span><span class="cls_007"> class again, as shown at </span><span class="cls_050">u</span><span class="cls_007"> in</span></div>
<div style="position:absolute;left:123.00px;top:268.10px" class="cls_007"><span class="cls_007">Listing 6-9.</span></div>
<div style="position:absolute;left:123.00px;top:292.10px" class="cls_030"><span class="cls_030">module Professor</span></div>
<div style="position:absolute;left:123.00px;top:302.60px" class="cls_030"><span class="cls_030">end</span></div>
<div style="position:absolute;left:123.00px;top:323.60px" class="cls_030"><span class="cls_030">class Mathematician</span></div>
<div style="position:absolute;left:131.50px;top:334.10px" class="cls_030"><span class="cls_030">attr_accessor :name</span></div>
<div style="position:absolute;left:111.15px;top:344.60px" class="cls_046"><span class="cls_046">u</span><span class="cls_030">   include Professor</span></div>
<div style="position:absolute;left:123.00px;top:355.09px" class="cls_030"><span class="cls_030">end</span></div>
<div style="position:absolute;left:123.00px;top:377.59px" class="cls_038"><span class="cls_038">Listing 6-9: Including the </span><span class="cls_014">Professor</span><span class="cls_038"> module into the </span><span class="cls_014">Mathematician</span><span class="cls_038"> class</span></div>
<div style="position:absolute;left:141.00px;top:400.10px" class="cls_007"><span class="cls_007">Figure 6-14 shows the superclass chain for </span><span class="cls_030">Mathematician</span><span class="cls_007"> and </span><span class="cls_030">Professor</span><span class="cls_007">.</span></div>
<div style="position:absolute;left:193.68px;top:426.10px" class="cls_117"><span class="cls_117">RClass</span></div>
<div style="position:absolute;left:123.00px;top:433.12px" class="cls_118"><span class="cls_118">Mathematician</span></div>
<div style="position:absolute;left:205.91px;top:438.13px" class="cls_119"><span class="cls_119">super</span></div>
<div style="position:absolute;left:125.06px;top:487.71px" class="cls_120"><span class="cls_120">Included class</span></div>
<div style="position:absolute;left:193.68px;top:486.12px" class="cls_117"><span class="cls_117">RClass</span></div>
<div style="position:absolute;left:125.34px;top:498.58px" class="cls_120"><span class="cls_120">for </span><span class="cls_118">Professor</span></div>
<div style="position:absolute;left:205.91px;top:498.15px" class="cls_119"><span class="cls_119">super</span></div>
<div style="position:absolute;left:193.68px;top:546.52px" class="cls_117"><span class="cls_117">RClass</span></div>
<div style="position:absolute;left:138.70px;top:553.55px" class="cls_118"><span class="cls_118">Object</span></div>
<div style="position:absolute;left:205.91px;top:558.55px" class="cls_119"><span class="cls_119">super</span></div>
<div style="position:absolute;left:123.00px;top:585.17px" class="cls_038"><span class="cls_038">Figure 6-14: </span><span class="cls_014">Professor</span><span class="cls_038"> is a superclass</span></div>
<div style="position:absolute;left:123.00px;top:595.67px" class="cls_038"><span class="cls_038">of </span><span class="cls_014">Mathematician</span><span class="cls_038">.</span></div>
<div style="position:absolute;left:330.83px;top:636.00px" class="cls_021"><span class="cls_021">Method Lookup and Constant Lookup</span></div>
<div style="position:absolute;left:443.10px;top:633.00px" class="cls_020"><span class="cls_020">147</span></div>
</div>
<div style="position:absolute;left:50%;margin-left:-252px;top:113568px;width:504px;height:666px;border-style:outset;overflow:hidden">
<div style="position:absolute;left:0px;top:0px">
<img src="e698b76e-46bd-11eb-8b25-0cc47a792c0a_id_e698b76e-46bd-11eb-8b25-0cc47a792c0a_files/background172.jpg" width=504 height=666></div>
<div style="position:absolute;left:138.00px;top:42.28px" class="cls_007"><span class="cls_007">If we decide to display the title </span><span class="cls_030">Prof.</span><span class="cls_007"> in front of each mathematician’s</span></div>
<div style="position:absolute;left:120.00px;top:54.28px" class="cls_007"><span class="cls_007">name, we can just add that behavior to the </span><span class="cls_030">Mathematician</span><span class="cls_007"> class, as shown in</span></div>
<div style="position:absolute;left:120.00px;top:66.28px" class="cls_007"><span class="cls_007">Listing 6-10.</span></div>
<div style="position:absolute;left:120.00px;top:90.28px" class="cls_030"><span class="cls_030">module Professor</span></div>
<div style="position:absolute;left:120.00px;top:100.78px" class="cls_030"><span class="cls_030">end</span></div>
<div style="position:absolute;left:120.00px;top:121.78px" class="cls_030"><span class="cls_030">class Mathematician</span></div>
<div style="position:absolute;left:128.50px;top:132.28px" class="cls_030"><span class="cls_030">attr_writer :name</span></div>
<div style="position:absolute;left:128.50px;top:142.78px" class="cls_030"><span class="cls_030">include Professor</span></div>
<div style="position:absolute;left:108.15px;top:153.27px" class="cls_046"><span class="cls_046">u</span><span class="cls_030">   def name</span></div>
<div style="position:absolute;left:137.00px;top:163.77px" class="cls_030"><span class="cls_030">"Prof. #{@name}"</span></div>
<div style="position:absolute;left:128.50px;top:174.27px" class="cls_030"><span class="cls_030">end</span></div>
<div style="position:absolute;left:120.00px;top:184.77px" class="cls_030"><span class="cls_030">end</span></div>
<div style="position:absolute;left:120.00px;top:207.27px" class="cls_038"><span class="cls_038">Listing 6-10: An ugly way to display the </span><span class="cls_014">Prof.</span><span class="cls_038"> title before each mathematician’s name</span></div>
<div style="position:absolute;left:138.00px;top:229.78px" class="cls_007"><span class="cls_007">But this is a very ugly solution: The </span><span class="cls_030">Mathematician</span><span class="cls_007"> class has to do the work</span></div>
<div style="position:absolute;left:120.00px;top:241.78px" class="cls_007"><span class="cls_007">of displaying the professor title at </span><span class="cls_050">u</span><span class="cls_007">. What if other classes include </span><span class="cls_030">Professor</span><span class="cls_007">?</span></div>
<div style="position:absolute;left:120.00px;top:253.78px" class="cls_007"><span class="cls_007">Shouldn’t they display the </span><span class="cls_030">Prof.</span><span class="cls_007"> title also? If </span><span class="cls_030">Mathematician</span><span class="cls_007"> contains the code</span></div>
<div style="position:absolute;left:120.00px;top:265.78px" class="cls_007"><span class="cls_007">for showing </span><span class="cls_030">Prof.</span><span class="cls_007">, then any other classes that include </span><span class="cls_030">Professor</span><span class="cls_007"> would be</span></div>
<div style="position:absolute;left:120.00px;top:277.78px" class="cls_007"><span class="cls_007">missing this code.</span></div>
<div style="position:absolute;left:138.00px;top:289.78px" class="cls_007"><span class="cls_007">It makes more sense to include the code for displaying the title in</span></div>
<div style="position:absolute;left:120.00px;top:301.78px" class="cls_007"><span class="cls_007">the </span><span class="cls_030">Professor</span><span class="cls_007"> module, as shown in Listing 6-11. This way every class that</span></div>
<div style="position:absolute;left:120.00px;top:313.78px" class="cls_007"><span class="cls_007">includes </span><span class="cls_030">Professor</span><span class="cls_007"> will be able to display the title </span><span class="cls_030">Prof.</span><span class="cls_007"> along with its</span></div>
<div style="position:absolute;left:120.00px;top:325.78px" class="cls_007"><span class="cls_007">class name.</span></div>
<div style="position:absolute;left:120.00px;top:349.78px" class="cls_030"><span class="cls_030">module Professor</span></div>
<div style="position:absolute;left:108.15px;top:360.28px" class="cls_046"><span class="cls_046">u</span><span class="cls_030">   def name</span></div>
<div style="position:absolute;left:137.00px;top:370.77px" class="cls_030"><span class="cls_030">"Prof. #{super}"</span></div>
<div style="position:absolute;left:128.50px;top:381.27px" class="cls_030"><span class="cls_030">end</span></div>
<div style="position:absolute;left:120.00px;top:391.77px" class="cls_030"><span class="cls_030">end</span></div>
<div style="position:absolute;left:120.00px;top:412.77px" class="cls_030"><span class="cls_030">class Mathematician</span></div>
<div style="position:absolute;left:128.50px;top:423.27px" class="cls_030"><span class="cls_030">attr_accessor :name</span></div>
<div style="position:absolute;left:108.15px;top:433.77px" class="cls_046"><span class="cls_046">v</span><span class="cls_030">   include Professor</span></div>
<div style="position:absolute;left:120.00px;top:444.27px" class="cls_030"><span class="cls_030">end</span></div>
<div style="position:absolute;left:120.00px;top:465.27px" class="cls_030"><span class="cls_030">poincaré = Mathematician.new</span></div>
<div style="position:absolute;left:120.00px;top:475.77px" class="cls_030"><span class="cls_030">poincaré.name = "Henri Poincaré"</span></div>
<div style="position:absolute;left:108.15px;top:486.26px" class="cls_046"><span class="cls_046">w</span><span class="cls_030"> p poincaré.name</span></div>
<div style="position:absolute;left:124.25px;top:496.76px" class="cls_030"><span class="cls_030">=> "Henri Poincaré"</span></div>
<div style="position:absolute;left:120.00px;top:519.26px" class="cls_038"><span class="cls_038">Listing 6-11: How can we get Ruby to call the module’s </span><span class="cls_014">name</span><span class="cls_038"> method?</span></div>
<div style="position:absolute;left:138.00px;top:541.78px" class="cls_007"><span class="cls_007">At </span><span class="cls_050">u</span><span class="cls_007"> we define a </span><span class="cls_030">name</span><span class="cls_007"> method inside </span><span class="cls_030">Professor</span><span class="cls_007"> that will display the </span><span class="cls_030">Prof.</span></div>
<div style="position:absolute;left:120.00px;top:553.78px" class="cls_007"><span class="cls_007">title before the actual name (assuming that </span><span class="cls_030">name</span><span class="cls_007"> is defined in a superclass).</span></div>
<div style="position:absolute;left:120.00px;top:565.78px" class="cls_007"><span class="cls_007">At </span><span class="cls_050">v</span><span class="cls_007"> we include </span><span class="cls_030">Professor</span><span class="cls_007"> into </span><span class="cls_030">Mathematician</span><span class="cls_007">. Finally, at </span><span class="cls_050">w</span><span class="cls_007"> we call the </span><span class="cls_030">name</span></div>
<div style="position:absolute;left:120.00px;top:577.78px" class="cls_007"><span class="cls_007">method, but we get the name </span><span class="cls_030">Henri Poincaré</span><span class="cls_007"> without the </span><span class="cls_030">Prof.</span><span class="cls_007"> title. What</span></div>
<div style="position:absolute;left:120.00px;top:589.78px" class="cls_007"><span class="cls_007">went wrong?</span></div>
<div style="position:absolute;left:48.00px;top:633.00px" class="cls_020"><span class="cls_020">148</span></div>
<div style="position:absolute;left:74.20px;top:636.00px" class="cls_021"><span class="cls_021">Chapter 6</span></div>
</div>
<div style="position:absolute;left:50%;margin-left:-252px;top:114244px;width:504px;height:666px;border-style:outset;overflow:hidden">
<div style="position:absolute;left:0px;top:0px">
<img src="e698b76e-46bd-11eb-8b25-0cc47a792c0a_id_e698b76e-46bd-11eb-8b25-0cc47a792c0a_files/background173.jpg" width=504 height=666></div>
<div style="position:absolute;left:141.00px;top:41.60px" class="cls_007"><span class="cls_007">The problem, as shown in Figure 6-14, is that </span><span class="cls_030">Professor</span><span class="cls_007"> is a super-</span></div>
<div style="position:absolute;left:123.00px;top:53.60px" class="cls_007"><span class="cls_007">class of </span><span class="cls_030">Mathematician</span><span class="cls_007">, not the other way around. This means when I</span></div>
<div style="position:absolute;left:123.00px;top:65.60px" class="cls_007"><span class="cls_007">call </span><span class="cls_030">poincaré.name</span><span class="cls_007"> at </span><span class="cls_050">w</span><span class="cls_007"> in Listing 6-11, Ruby finds the </span><span class="cls_030">name</span><span class="cls_007"> method from</span></div>
<div style="position:absolute;left:123.00px;top:77.60px" class="cls_030"><span class="cls_030">Mathematician</span><span class="cls_007">, not from </span><span class="cls_030">Professor</span><span class="cls_007">. Figure 6-15 shows visually what Ruby’s</span></div>
<div style="position:absolute;left:123.00px;top:89.60px" class="cls_007"><span class="cls_007">method lookup algorithm finds when I call </span><span class="cls_030">poincaré.name</span><span class="cls_007">.</span></div>
<div style="position:absolute;left:201.52px;top:116.70px" class="cls_042"><span class="cls_042">RClass</span></div>
<div style="position:absolute;left:284.13px;top:127.00px" class="cls_053"><span class="cls_053">attr_accessor</span><span class="cls_067"> :name</span></div>
<div style="position:absolute;left:123.00px;top:129.91px" class="cls_019"><span class="cls_019">Mathematician</span></div>
<div style="position:absolute;left:216.29px;top:130.05px" class="cls_067"><span class="cls_067">super</span></div>
<div style="position:absolute;left:201.52px;top:185.49px" class="cls_042"><span class="cls_042">RClass</span></div>
<div style="position:absolute;left:284.13px;top:184.68px" class="cls_067"><span class="cls_067">def name</span></div>
<div style="position:absolute;left:125.06px;top:187.90px" class="cls_017"><span class="cls_017">Included class</span></div>
<div style="position:absolute;left:292.13px;top:195.07px" class="cls_067"><span class="cls_067">"Prof. #{</span><span class="cls_053">super</span><span class="cls_067">}"</span></div>
<div style="position:absolute;left:125.34px;top:199.96px" class="cls_017"><span class="cls_017">for </span><span class="cls_019">Professor</span></div>
<div style="position:absolute;left:216.29px;top:198.84px" class="cls_067"><span class="cls_067">super</span></div>
<div style="position:absolute;left:284.13px;top:204.16px" class="cls_067"><span class="cls_067">end</span></div>
<div style="position:absolute;left:201.52px;top:254.24px" class="cls_042"><span class="cls_042">RClass</span></div>
<div style="position:absolute;left:138.73px;top:267.45px" class="cls_019"><span class="cls_019">Object</span></div>
<div style="position:absolute;left:216.29px;top:267.59px" class="cls_067"><span class="cls_067">super</span></div>
<div style="position:absolute;left:123.00px;top:294.93px" class="cls_038"><span class="cls_038">Figure 6-15: Ruby calls the </span><span class="cls_014">attr_accessor</span><span class="cls_038"> method before finding</span></div>
<div style="position:absolute;left:123.00px;top:305.43px" class="cls_038"><span class="cls_038">the </span><span class="cls_014">name</span><span class="cls_038"> method from </span><span class="cls_014">Professor</span><span class="cls_038">.</span></div>
<div style="position:absolute;left:141.00px;top:327.93px" class="cls_007"><span class="cls_007">When we call </span><span class="cls_030">name</span><span class="cls_007"> at </span><span class="cls_050">w</span><span class="cls_007"> in Listing 6-11, Ruby finds the first </span><span class="cls_030">name</span><span class="cls_007"> method</span></div>
<div style="position:absolute;left:123.00px;top:339.93px" class="cls_007"><span class="cls_007">that it sees in the superclass chain starting from the top and moving down.</span></div>
<div style="position:absolute;left:123.00px;top:351.93px" class="cls_007"><span class="cls_007">As you can see in Figure 6-15, the first </span><span class="cls_030">name</span><span class="cls_007"> method is the simple </span><span class="cls_030">attr_accessor</span></div>
<div style="position:absolute;left:123.00px;top:363.93px" class="cls_007"><span class="cls_007">method in </span><span class="cls_030">Mathematician</span><span class="cls_007">.</span></div>
<div style="position:absolute;left:141.00px;top:375.93px" class="cls_007"><span class="cls_007">However, if we prepend </span><span class="cls_030">Professor</span><span class="cls_007"> instead of including it, we get the</span></div>
<div style="position:absolute;left:123.00px;top:387.93px" class="cls_007"><span class="cls_007">behavior we were hoping for, as shown in Listing 6-12.</span></div>
<div style="position:absolute;left:123.00px;top:411.93px" class="cls_030"><span class="cls_030">module Professor</span></div>
<div style="position:absolute;left:131.50px;top:422.43px" class="cls_030"><span class="cls_030">def name</span></div>
<div style="position:absolute;left:140.00px;top:432.92px" class="cls_030"><span class="cls_030">"Prof. #{super}"</span></div>
<div style="position:absolute;left:131.50px;top:443.42px" class="cls_030"><span class="cls_030">end</span></div>
<div style="position:absolute;left:123.00px;top:453.92px" class="cls_030"><span class="cls_030">end</span></div>
<div style="position:absolute;left:123.00px;top:474.92px" class="cls_030"><span class="cls_030">class Mathematician</span></div>
<div style="position:absolute;left:131.50px;top:485.42px" class="cls_030"><span class="cls_030">attr_accessor :name</span></div>
<div style="position:absolute;left:111.15px;top:495.92px" class="cls_046"><span class="cls_046">u</span><span class="cls_030">   prepend Professor</span></div>
<div style="position:absolute;left:123.00px;top:506.41px" class="cls_030"><span class="cls_030">end</span></div>
<div style="position:absolute;left:123.00px;top:527.42px" class="cls_030"><span class="cls_030">poincaré = Mathematician.new</span></div>
<div style="position:absolute;left:123.00px;top:537.92px" class="cls_030"><span class="cls_030">poincaré.name = "Henri Poincaré"</span></div>
<div style="position:absolute;left:111.15px;top:548.41px" class="cls_046"><span class="cls_046">v</span><span class="cls_030"> p poincaré.name</span></div>
<div style="position:absolute;left:127.25px;top:558.91px" class="cls_030"><span class="cls_030">=> "Prof. Henri Poincaré"</span></div>
<div style="position:absolute;left:123.00px;top:581.41px" class="cls_038"><span class="cls_038">Listing 6-12: Using </span><span class="cls_014">prepend</span><span class="cls_038">, Ruby finds the module’s </span><span class="cls_014">name</span><span class="cls_038"> method first.</span></div>
<div style="position:absolute;left:141.00px;top:603.93px" class="cls_007"><span class="cls_007">The only difference here is the use of </span><span class="cls_030">prepend</span><span class="cls_007"> at </span><span class="cls_050">u</span><span class="cls_007">.</span></div>
<div style="position:absolute;left:330.77px;top:636.00px" class="cls_021"><span class="cls_021">Method Lookup and Constant Lookup</span></div>
<div style="position:absolute;left:443.04px;top:633.00px" class="cls_020"><span class="cls_020">149</span></div>
</div>
<div style="position:absolute;left:50%;margin-left:-252px;top:114920px;width:504px;height:666px;border-style:outset;overflow:hidden">
<div style="position:absolute;left:0px;top:0px">
<img src="e698b76e-46bd-11eb-8b25-0cc47a792c0a_id_e698b76e-46bd-11eb-8b25-0cc47a792c0a_files/background174.jpg" width=504 height=666></div>
<div style="position:absolute;left:120.00px;top:42.55px" class="cls_055"><span class="cls_055">How Ruby Implements Module#prepend</span></div>
<div style="position:absolute;left:120.00px;top:60.55px" class="cls_007"><span class="cls_007">When you prepend a module to a class, Ruby places it before the class in</span></div>
<div style="position:absolute;left:120.00px;top:72.55px" class="cls_007"><span class="cls_007">the superclass chain, as shown in Figure 6-16.</span></div>
<div style="position:absolute;left:276.40px;top:97.83px" class="cls_067"><span class="cls_067">def name</span></div>
<div style="position:absolute;left:196.25px;top:99.64px" class="cls_042"><span class="cls_042">RClass</span></div>
<div style="position:absolute;left:122.07px;top:102.05px" class="cls_017"><span class="cls_017">Included class</span></div>
<div style="position:absolute;left:284.40px;top:108.76px" class="cls_067"><span class="cls_067">"Prof. #{</span><span class="cls_053">super</span><span class="cls_067">}"</span></div>
<div style="position:absolute;left:209.29px;top:112.99px" class="cls_067"><span class="cls_067">super</span></div>
<div style="position:absolute;left:122.34px;top:114.11px" class="cls_017"><span class="cls_017">for </span><span class="cls_019">Professor</span></div>
<div style="position:absolute;left:276.40px;top:118.39px" class="cls_067"><span class="cls_067">end</span></div>
<div style="position:absolute;left:196.25px;top:168.43px" class="cls_042"><span class="cls_042">RClass</span></div>
<div style="position:absolute;left:120.00px;top:176.88px" class="cls_019"><span class="cls_019">Mathematician</span></div>
<div style="position:absolute;left:278.13px;top:177.23px" class="cls_053"><span class="cls_053">attr_accessor</span><span class="cls_067"> :name</span></div>
<div style="position:absolute;left:209.29px;top:181.79px" class="cls_067"><span class="cls_067">super</span></div>
<div style="position:absolute;left:196.25px;top:236.19px" class="cls_042"><span class="cls_042">RClass</span></div>
<div style="position:absolute;left:135.73px;top:249.40px" class="cls_019"><span class="cls_019">Object</span></div>
<div style="position:absolute;left:209.29px;top:249.54px" class="cls_067"><span class="cls_067">super</span></div>
<div style="position:absolute;left:120.00px;top:276.87px" class="cls_038"><span class="cls_038">Figure 6-16: Using </span><span class="cls_014">prepend</span><span class="cls_038">, Ruby places the module before the</span></div>
<div style="position:absolute;left:120.00px;top:287.37px" class="cls_038"><span class="cls_038">target class in the superclass chain.</span></div>
<div style="position:absolute;left:138.00px;top:309.87px" class="cls_007"><span class="cls_007">But there is something odd here. When we call </span><span class="cls_030">name</span><span class="cls_007"> on a mathematician</span></div>
<div style="position:absolute;left:120.00px;top:321.87px" class="cls_007"><span class="cls_007">object, how does Ruby find the module’s method? That is, at </span><span class="cls_050">v</span><span class="cls_007"> in Listing 6-12,</span></div>
<div style="position:absolute;left:120.00px;top:333.87px" class="cls_007"><span class="cls_007">we’re calling </span><span class="cls_030">name</span><span class="cls_007"> on the </span><span class="cls_030">Mathematician</span><span class="cls_007"> class, not on the </span><span class="cls_030">Professor</span><span class="cls_007"> module.</span></div>
<div style="position:absolute;left:120.00px;top:345.87px" class="cls_007"><span class="cls_007">Ruby should find the simple </span><span class="cls_030">attr_accessor</span><span class="cls_007"> method, not the version from the</span></div>
<div style="position:absolute;left:120.00px;top:357.87px" class="cls_007"><span class="cls_007">module, but that’s not the case. Does Ruby look backward up the superclass</span></div>
<div style="position:absolute;left:120.00px;top:369.87px" class="cls_007"><span class="cls_007">chain to find the module? If so, how does it do this when the </span><span class="cls_030">super</span><span class="cls_007"> pointers</span></div>
<div style="position:absolute;left:120.00px;top:381.87px" class="cls_007"><span class="cls_007">point down?</span></div>
<div style="position:absolute;left:138.00px;top:393.87px" class="cls_007"><span class="cls_007">The secret is that internally Ruby uses a trick to make it seem as if</span></div>
<div style="position:absolute;left:120.00px;top:405.87px" class="cls_030"><span class="cls_030">Mathematician</span><span class="cls_007"> is the superclass of </span><span class="cls_030">Professor</span><span class="cls_007"> when it’s not, as shown in Figure 6-17.</span></div>
<div style="position:absolute;left:120.00px;top:417.87px" class="cls_007"><span class="cls_007">Prepending a module is like including a module. </span><span class="cls_030">Mathematician</span><span class="cls_007"> is at the top</span></div>
<div style="position:absolute;left:120.00px;top:429.87px" class="cls_007"><span class="cls_007">of the superclass chain, and moving down the chain, we see that Ruby still</span></div>
<div style="position:absolute;left:120.00px;top:441.87px" class="cls_007"><span class="cls_007">sets the included class for </span><span class="cls_030">Professor</span><span class="cls_007"> to be the superclass of </span><span class="cls_030">Mathematician</span><span class="cls_007">.</span></div>
<div style="position:absolute;left:138.00px;top:453.87px" class="cls_007"><span class="cls_007">But below </span><span class="cls_030">Professor</span><span class="cls_007"> in Figure 6-17 we see something new, the </span><span class="cls_008">origin class</span></div>
<div style="position:absolute;left:120.00px;top:465.87px" class="cls_007"><span class="cls_007">for </span><span class="cls_030">Mathematician</span><span class="cls_007">. This is a new copy of </span><span class="cls_030">Mathematician</span><span class="cls_007"> that Ruby creates to</span></div>
<div style="position:absolute;left:120.00px;top:477.87px" class="cls_007"><span class="cls_007">make </span><span class="cls_030">prepend</span><span class="cls_007"> work.</span></div>
<div style="position:absolute;left:138.00px;top:489.87px" class="cls_007"><span class="cls_007">When you prepend a module, Ruby creates a copy of the target class</span></div>
<div style="position:absolute;left:120.00px;top:501.87px" class="cls_007"><span class="cls_007">(called the </span><span class="cls_008">origin class</span><span class="cls_007"> internally) and sets it as the superclass of the prepended</span></div>
<div style="position:absolute;left:120.00px;top:513.87px" class="cls_007"><span class="cls_007">module. Ruby uses the </span><span class="cls_030">origin</span><span class="cls_007"> pointer that we saw in the </span><span class="cls_030">rb_classext_struct</span></div>
<div style="position:absolute;left:120.00px;top:525.87px" class="cls_007"><span class="cls_007">structure in Figures 6-1 and 6-2 to track this new origin copy of the class.</span></div>
<div style="position:absolute;left:120.00px;top:537.87px" class="cls_007"><span class="cls_007">In addition, Ruby moves all of the methods from the original class to the</span></div>
<div style="position:absolute;left:120.00px;top:549.87px" class="cls_007"><span class="cls_007">origin class, which means that those methods may now be overridden by</span></div>
<div style="position:absolute;left:120.00px;top:561.87px" class="cls_007"><span class="cls_007">methods with the same name in the prepended module. In Figure 6-17 you</span></div>
<div style="position:absolute;left:120.00px;top:573.87px" class="cls_007"><span class="cls_007">can see that Ruby moved the </span><span class="cls_030">attr_accessor</span><span class="cls_007"> method down from </span><span class="cls_030">Mathematician</span></div>
<div style="position:absolute;left:120.00px;top:585.87px" class="cls_007"><span class="cls_007">to the origin class.</span></div>
<div style="position:absolute;left:48.00px;top:633.00px" class="cls_020"><span class="cls_020">150</span></div>
<div style="position:absolute;left:74.04px;top:636.00px" class="cls_021"><span class="cls_021">Chapter 6</span></div>
</div>
<div style="position:absolute;left:50%;margin-left:-252px;top:115596px;width:504px;height:666px;border-style:outset;overflow:hidden">
<div style="position:absolute;left:0px;top:0px">
<img src="e698b76e-46bd-11eb-8b25-0cc47a792c0a_id_e698b76e-46bd-11eb-8b25-0cc47a792c0a_files/background175.jpg" width=504 height=666></div>
<div style="position:absolute;left:200.56px;top:49.70px" class="cls_042"><span class="cls_042">RClass</span></div>
<div style="position:absolute;left:213.32px;top:66.85px" class="cls_067"><span class="cls_067">origin</span></div>
<div style="position:absolute;left:123.00px;top:68.01px" class="cls_019"><span class="cls_019">Mathematician</span></div>
<div style="position:absolute;left:215.32px;top:91.15px" class="cls_067"><span class="cls_067">super</span></div>
<div style="position:absolute;left:278.84px;top:142.50px" class="cls_067"><span class="cls_067">def name</span></div>
<div style="position:absolute;left:125.07px;top:146.73px" class="cls_017"><span class="cls_017">Included class</span></div>
<div style="position:absolute;left:200.56px;top:144.32px" class="cls_042"><span class="cls_042">RClass</span></div>
<div style="position:absolute;left:286.84px;top:153.94px" class="cls_067"><span class="cls_067">"Prof. #{</span><span class="cls_053">super</span><span class="cls_067">}"</span></div>
<div style="position:absolute;left:125.34px;top:158.79px" class="cls_017"><span class="cls_017">for </span><span class="cls_019">Professor</span></div>
<div style="position:absolute;left:215.32px;top:157.67px" class="cls_067"><span class="cls_067">super</span></div>
<div style="position:absolute;left:278.84px;top:164.06px" class="cls_067"><span class="cls_067">end</span></div>
<div style="position:absolute;left:123.00px;top:213.53px" class="cls_019"><span class="cls_019">Mathematician</span></div>
<div style="position:absolute;left:200.56px;top:211.11px" class="cls_042"><span class="cls_042">RClass</span></div>
<div style="position:absolute;left:278.84px;top:219.90px" class="cls_053"><span class="cls_053">attr_accessor </span><span class="cls_067">:name</span></div>
<div style="position:absolute;left:126.02px;top:225.59px" class="cls_017"><span class="cls_017">“origin” class</span></div>
<div style="position:absolute;left:215.32px;top:224.46px" class="cls_067"><span class="cls_067">super</span></div>
<div style="position:absolute;left:200.56px;top:277.86px" class="cls_042"><span class="cls_042">RClass</span></div>
<div style="position:absolute;left:138.18px;top:291.08px" class="cls_019"><span class="cls_019">Object</span></div>
<div style="position:absolute;left:215.32px;top:291.22px" class="cls_067"><span class="cls_067">super</span></div>
<div style="position:absolute;left:123.00px;top:318.55px" class="cls_038"><span class="cls_038">Figure 6-17: Ruby creates a copy of the target class and sets it as</span></div>
<div style="position:absolute;left:123.00px;top:329.05px" class="cls_038"><span class="cls_038">the superclass of the prepended module.</span></div>
<div style="position:absolute;left:123.00px;top:373.55px" class="cls_031"><span class="cls_031">Experiment 6-1: Modifying a Module After</span></div>
<div style="position:absolute;left:123.00px;top:388.55px" class="cls_031"><span class="cls_031">Including It</span></div>
<div style="position:absolute;left:123.00px;top:408.55px" class="cls_007"><span class="cls_007">Following a suggestion by Xavier Noria, this experiment will explore what</span></div>
<div style="position:absolute;left:123.00px;top:420.55px" class="cls_007"><span class="cls_007">happens when you modify a module once it’s been included into a class.</span></div>
<div style="position:absolute;left:123.00px;top:432.55px" class="cls_007"><span class="cls_007">We’ll use the same </span><span class="cls_030">Mathematician</span><span class="cls_007"> class and the </span><span class="cls_030">Professor</span><span class="cls_007"> module but with dif-</span></div>
<div style="position:absolute;left:123.00px;top:444.55px" class="cls_007"><span class="cls_007">ferent methods, as shown in Listing 6-13.</span></div>
<div style="position:absolute;left:123.00px;top:468.55px" class="cls_030"><span class="cls_030">module Professor</span></div>
<div style="position:absolute;left:131.50px;top:479.05px" class="cls_030"><span class="cls_030">def lectures; end</span></div>
<div style="position:absolute;left:123.00px;top:489.55px" class="cls_030"><span class="cls_030">end</span></div>
<div style="position:absolute;left:123.00px;top:510.55px" class="cls_030"><span class="cls_030">class Mathematician</span></div>
<div style="position:absolute;left:111.15px;top:521.05px" class="cls_046"><span class="cls_046">u</span><span class="cls_030">   attr_accessor :first_name</span></div>
<div style="position:absolute;left:131.50px;top:531.55px" class="cls_030"><span class="cls_030">attr_accessor :last_name</span></div>
<div style="position:absolute;left:111.15px;top:542.04px" class="cls_046"><span class="cls_046">v</span><span class="cls_030">   include Professor</span></div>
<div style="position:absolute;left:123.00px;top:552.54px" class="cls_030"><span class="cls_030">end</span></div>
<div style="position:absolute;left:123.00px;top:575.04px" class="cls_038"><span class="cls_038">Listing 6-13: Another example of including a module into a class</span></div>
<div style="position:absolute;left:331.08px;top:636.00px" class="cls_021"><span class="cls_021">Method Lookup and Constant Lookup</span></div>
<div style="position:absolute;left:443.34px;top:633.00px" class="cls_020"><span class="cls_020">151</span></div>
</div>
<div style="position:absolute;left:50%;margin-left:-252px;top:116272px;width:504px;height:666px;border-style:outset;overflow:hidden">
<div style="position:absolute;left:0px;top:0px">
<img src="e698b76e-46bd-11eb-8b25-0cc47a792c0a_id_e698b76e-46bd-11eb-8b25-0cc47a792c0a_files/background176.jpg" width=504 height=666></div>
<div style="position:absolute;left:138.00px;top:42.71px" class="cls_007"><span class="cls_007">This time the </span><span class="cls_030">Mathematician</span><span class="cls_007"> class contains the accessor methods at </span><span class="cls_050">u</span><span class="cls_007"> for</span></div>
<div style="position:absolute;left:120.00px;top:54.71px" class="cls_030"><span class="cls_030">@first_name</span><span class="cls_007"> and </span><span class="cls_030">@last_name</span><span class="cls_007">, and we’ve included the </span><span class="cls_030">Professor</span><span class="cls_007"> module again</span></div>
<div style="position:absolute;left:120.00px;top:66.71px" class="cls_007"><span class="cls_007">at </span><span class="cls_050">v</span><span class="cls_007">. If we inspect the methods of a mathematician object, as shown in</span></div>
<div style="position:absolute;left:120.00px;top:78.71px" class="cls_007"><span class="cls_007">Listing 6-14, we should see the attribute methods, such as </span><span class="cls_030">first_name=</span><span class="cls_007"> and</span></div>
<div style="position:absolute;left:120.00px;top:90.71px" class="cls_007"><span class="cls_007">the </span><span class="cls_030">lectures</span><span class="cls_007"> method from </span><span class="cls_030">Professor</span><span class="cls_007">.</span></div>
<div style="position:absolute;left:120.00px;top:114.71px" class="cls_030"><span class="cls_030">fermat = Mathematician.new</span></div>
<div style="position:absolute;left:120.00px;top:125.21px" class="cls_030"><span class="cls_030">fermat.first_name = 'Pierre'</span></div>
<div style="position:absolute;left:120.00px;top:135.71px" class="cls_030"><span class="cls_030">fermat.last_name = 'de Fermat'</span></div>
<div style="position:absolute;left:120.00px;top:156.71px" class="cls_030"><span class="cls_030">p fermat.methods.sort</span></div>
<div style="position:absolute;left:124.08px;top:167.21px" class="cls_030"><span class="cls_030">=> [ ... :first_name, :first_name=, ... :last_name, :last_name=, :lectures ... ]</span></div>
<div style="position:absolute;left:120.00px;top:189.71px" class="cls_038"><span class="cls_038">Listing 6-14: Inspecting the methods of a mathematician object</span></div>
<div style="position:absolute;left:138.00px;top:212.21px" class="cls_007"><span class="cls_007">No surprise; we see all the methods.</span></div>
<div style="position:absolute;left:120.00px;top:237.21px" class="cls_055"><span class="cls_055">Classes See Methods Added to a Module Later</span></div>
<div style="position:absolute;left:120.00px;top:255.21px" class="cls_007"><span class="cls_007">Now let’s add some new methods to the </span><span class="cls_030">Professor</span><span class="cls_007"> module after including it</span></div>
<div style="position:absolute;left:120.00px;top:267.21px" class="cls_007"><span class="cls_007">into the </span><span class="cls_030">Mathematician</span><span class="cls_007"> class. Does Ruby know that the new methods should</span></div>
<div style="position:absolute;left:120.00px;top:279.21px" class="cls_007"><span class="cls_007">be added to </span><span class="cls_030">Mathematician</span><span class="cls_007"> as well? Let’s find out by running Listing 6-15</span></div>
<div style="position:absolute;left:120.00px;top:291.21px" class="cls_007"><span class="cls_007">right after Listing 6-14 finishes.</span></div>
<div style="position:absolute;left:120.00px;top:315.21px" class="cls_030"><span class="cls_030">module Professor</span></div>
<div style="position:absolute;left:128.50px;top:325.71px" class="cls_030"><span class="cls_030">def primary_classroom; end</span></div>
<div style="position:absolute;left:120.00px;top:336.20px" class="cls_030"><span class="cls_030">end</span></div>
<div style="position:absolute;left:120.00px;top:357.21px" class="cls_030"><span class="cls_030">p fermat.methods.sort</span></div>
<div style="position:absolute;left:108.15px;top:367.71px" class="cls_046"><span class="cls_046">u</span><span class="cls_030">  => [ ... :first_name, :first_name=, ... :last_name, :last_name=, :lectures,</span></div>
<div style="position:absolute;left:120.00px;top:378.20px" class="cls_030"><span class="cls_030">... :primary_classroom, ... ]</span></div>
<div style="position:absolute;left:120.00px;top:400.70px" class="cls_038"><span class="cls_038">Listing 6-15: Adding a new method to </span><span class="cls_014">Professor</span><span class="cls_038"> after including it into </span><span class="cls_014">Mathematician</span></div>
<div style="position:absolute;left:138.00px;top:423.21px" class="cls_007"><span class="cls_007">As you can see, at </span><span class="cls_050">u</span><span class="cls_007"> we get all the methods, including the new</span></div>
<div style="position:absolute;left:120.00px;top:435.21px" class="cls_030"><span class="cls_030">primary_classroom</span><span class="cls_007"> method that was added to </span><span class="cls_030">Professor</span><span class="cls_007"> after it was included</span></div>
<div style="position:absolute;left:120.00px;top:447.21px" class="cls_007"><span class="cls_007">into </span><span class="cls_030">Mathematician</span><span class="cls_007">. No surprise here either. Ruby is one step ahead of us.</span></div>
<div style="position:absolute;left:120.00px;top:472.21px" class="cls_055"><span class="cls_055">Classes Don’t See Submodules Included Later</span></div>
<div style="position:absolute;left:120.00px;top:490.21px" class="cls_007"><span class="cls_007">Now for one more test. What if we reopen the </span><span class="cls_030">Professor</span><span class="cls_007"> module and include</span></div>
<div style="position:absolute;left:120.00px;top:502.21px" class="cls_007"><span class="cls_007">yet another module into it using Listing 6-16?</span></div>
<div style="position:absolute;left:120.00px;top:526.21px" class="cls_030"><span class="cls_030">module Employee</span></div>
<div style="position:absolute;left:128.50px;top:536.71px" class="cls_030"><span class="cls_030">def hire_date; end</span></div>
<div style="position:absolute;left:120.00px;top:547.21px" class="cls_030"><span class="cls_030">end</span></div>
<div style="position:absolute;left:120.00px;top:568.21px" class="cls_030"><span class="cls_030">module Professor</span></div>
<div style="position:absolute;left:128.50px;top:578.71px" class="cls_030"><span class="cls_030">include Employee</span></div>
<div style="position:absolute;left:120.00px;top:589.20px" class="cls_030"><span class="cls_030">end</span></div>
<div style="position:absolute;left:120.00px;top:611.70px" class="cls_038"><span class="cls_038">Listing 6-16: Including a new module into </span><span class="cls_014">Professor</span><span class="cls_038"> after it was included into </span><span class="cls_014">Mathematician</span></div>
<div style="position:absolute;left:48.00px;top:633.00px" class="cls_020"><span class="cls_020">152</span></div>
<div style="position:absolute;left:73.88px;top:636.00px" class="cls_021"><span class="cls_021">Chapter 6</span></div>
</div>
<div style="position:absolute;left:50%;margin-left:-252px;top:116948px;width:504px;height:666px;border-style:outset;overflow:hidden">
<div style="position:absolute;left:0px;top:0px">
<img src="e698b76e-46bd-11eb-8b25-0cc47a792c0a_id_e698b76e-46bd-11eb-8b25-0cc47a792c0a_files/background177.jpg" width=504 height=666></div>
<div style="position:absolute;left:141.00px;top:41.60px" class="cls_007"><span class="cls_007">This is getting confusing, so let’s review what we did in Listings 6-13</span></div>
<div style="position:absolute;left:123.00px;top:53.60px" class="cls_007"><span class="cls_007">and 6-16:</span></div>
<div style="position:absolute;left:123.00px;top:74.60px" class="cls_050"><span class="cls_050">•</span><span class="cls_007">   In Listing 6-13 we included the </span><span class="cls_030">Professor</span><span class="cls_007"> module into the </span><span class="cls_030">Mathematician</span></div>
<div style="position:absolute;left:141.00px;top:86.60px" class="cls_007"><span class="cls_007">class.</span></div>
<div style="position:absolute;left:123.00px;top:101.60px" class="cls_050"><span class="cls_050">•</span><span class="cls_007">   Then, in Listing 6-16 we included the </span><span class="cls_030">Employee</span><span class="cls_007"> module into the </span><span class="cls_030">Professor</span></div>
<div style="position:absolute;left:141.00px;top:113.60px" class="cls_007"><span class="cls_007">module. Therefore, the methods of the </span><span class="cls_030">Employee</span><span class="cls_007"> module should now be</span></div>
<div style="position:absolute;left:141.00px;top:125.60px" class="cls_007"><span class="cls_007">available on a mathematician object.</span></div>
<div style="position:absolute;left:141.00px;top:146.60px" class="cls_007"><span class="cls_007">Let’s see whether Ruby works as expected:</span></div>
<div style="position:absolute;left:123.00px;top:170.60px" class="cls_030"><span class="cls_030">p fermat.methods.sort</span></div>
<div style="position:absolute;left:127.08px;top:181.10px" class="cls_030"><span class="cls_030">=> [ ... :first_name, :first_name=, ... :last_name, :last_name=, :lectures ... ]</span></div>
<div style="position:absolute;left:141.00px;top:203.60px" class="cls_007"><span class="cls_007">It didn’t work! The </span><span class="cls_030">hire_date</span><span class="cls_007"> method is </span><span class="cls_008">not</span><span class="cls_007"> available in the </span><span class="cls_030">fermat</span><span class="cls_007"> object.</span></div>
<div style="position:absolute;left:123.00px;top:215.60px" class="cls_007"><span class="cls_007">Including a module into a module already included into a class </span><span class="cls_008">does not</span></div>
<div style="position:absolute;left:123.00px;top:227.60px" class="cls_007"><span class="cls_007">affect that class.</span></div>
<div style="position:absolute;left:141.00px;top:239.60px" class="cls_007"><span class="cls_007">As we’ve learned how Ruby implements modules, this fact shouldn’t</span></div>
<div style="position:absolute;left:123.00px;top:251.60px" class="cls_007"><span class="cls_007">be too hard to understand. Including </span><span class="cls_030">Employee</span><span class="cls_007"> into </span><span class="cls_030">Professor</span><span class="cls_007"> changes the</span></div>
<div style="position:absolute;left:123.00px;top:263.60px" class="cls_030"><span class="cls_030">Professor</span><span class="cls_007"> module, not the copy of </span><span class="cls_030">Professor</span><span class="cls_007"> that Ruby created when we</span></div>
<div style="position:absolute;left:123.00px;top:275.60px" class="cls_007"><span class="cls_007">included it into </span><span class="cls_030">Mathematician</span><span class="cls_007">, as shown in Figure 6-18.</span></div>
<div style="position:absolute;left:123.00px;top:296.55px" class="cls_122"><span class="cls_122">Mathematician</span></div>
<div style="position:absolute;left:130.34px;top:317.57px" class="cls_112"><span class="cls_112">RClass</span></div>
<div style="position:absolute;left:142.06px;top:329.29px" class="cls_114"><span class="cls_114">super</span></div>
<div style="position:absolute;left:288.89px;top:348.62px" class="cls_122"><span class="cls_122">Professor</span></div>
<div style="position:absolute;left:201.68px;top:368.29px" class="cls_113"><span class="cls_113">(copied earlier)</span></div>
<div style="position:absolute;left:130.34px;top:371.55px" class="cls_112"><span class="cls_112">RClass</span></div>
<div style="position:absolute;left:286.65px;top:371.55px" class="cls_112"><span class="cls_112">RClass</span></div>
<div style="position:absolute;left:142.06px;top:383.26px" class="cls_114"><span class="cls_114">super</span></div>
<div style="position:absolute;left:298.37px;top:384.90px" class="cls_114"><span class="cls_114">super</span></div>
<div style="position:absolute;left:125.04px;top:407.60px" class="cls_113"><span class="cls_113">Included class</span></div>
<div style="position:absolute;left:125.32px;top:418.18px" class="cls_113"><span class="cls_113">for </span><span class="cls_122">Professor</span></div>
<div style="position:absolute;left:287.32px;top:427.91px" class="cls_112"><span class="cls_112">RClass</span></div>
<div style="position:absolute;left:395.07px;top:427.91px" class="cls_112"><span class="cls_112">RClass</span></div>
<div style="position:absolute;left:298.37px;top:439.62px" class="cls_114"><span class="cls_114">super</span></div>
<div style="position:absolute;left:406.79px;top:439.62px" class="cls_114"><span class="cls_114">super</span></div>
<div style="position:absolute;left:353.26px;top:443.61px" class="cls_113"><span class="cls_113">copy</span></div>
<div style="position:absolute;left:282.03px;top:464.99px" class="cls_113"><span class="cls_113">Included class</span></div>
<div style="position:absolute;left:398.87px;top:465.37px" class="cls_122"><span class="cls_122">Employee</span></div>
<div style="position:absolute;left:284.53px;top:475.57px" class="cls_113"><span class="cls_113">for </span><span class="cls_122">Employee</span></div>
<div style="position:absolute;left:123.00px;top:495.09px" class="cls_038"><span class="cls_038">Figure 6-18: The </span><span class="cls_014">Employee</span><span class="cls_038"> module is included into the original </span><span class="cls_014">Professor</span><span class="cls_038"> module,</span></div>
<div style="position:absolute;left:123.00px;top:505.59px" class="cls_038"><span class="cls_038">not the included copy used by </span><span class="cls_014">Mathematician</span><span class="cls_038">.</span></div>
<div style="position:absolute;left:123.00px;top:532.09px" class="cls_055"><span class="cls_055">Included Classes Share the Method Table with the Original Module</span></div>
<div style="position:absolute;left:123.00px;top:550.09px" class="cls_007"><span class="cls_007">But what about the </span><span class="cls_030">primary_classroom</span><span class="cls_007"> method we added in Listing 6-15? How</span></div>
<div style="position:absolute;left:123.00px;top:562.09px" class="cls_007"><span class="cls_007">was Ruby able to include the </span><span class="cls_030">primary_classroom</span><span class="cls_007"> method into </span><span class="cls_030">Mathematician</span></div>
<div style="position:absolute;left:123.00px;top:574.09px" class="cls_007"><span class="cls_007">even though we added it to </span><span class="cls_030">Professor</span><span class="cls_007"> after we included </span><span class="cls_030">Professor</span><span class="cls_007"> into</span></div>
<div style="position:absolute;left:123.00px;top:586.09px" class="cls_030"><span class="cls_030">Mathematician</span><span class="cls_007">? Figure 6-18 shows that Ruby created a copy of the </span><span class="cls_030">Professor</span></div>
<div style="position:absolute;left:123.00px;top:598.09px" class="cls_007"><span class="cls_007">module before we added the new method to it. But how does the </span><span class="cls_030">fermat</span></div>
<div style="position:absolute;left:123.00px;top:610.09px" class="cls_007"><span class="cls_007">object get the new method?</span></div>
<div style="position:absolute;left:330.67px;top:636.00px" class="cls_021"><span class="cls_021">Method Lookup and Constant Lookup</span></div>
<div style="position:absolute;left:442.93px;top:633.00px" class="cls_020"><span class="cls_020">153</span></div>
</div>
<div style="position:absolute;left:50%;margin-left:-252px;top:117624px;width:504px;height:666px;border-style:outset;overflow:hidden">
<div style="position:absolute;left:0px;top:0px">
<img src="e698b76e-46bd-11eb-8b25-0cc47a792c0a_id_e698b76e-46bd-11eb-8b25-0cc47a792c0a_files/background178.jpg" width=504 height=666></div>
<div style="position:absolute;left:138.00px;top:42.28px" class="cls_007"><span class="cls_007">As it turns out, when you include a module, Ruby copies the </span><span class="cls_030">RClass</span></div>
<div style="position:absolute;left:120.00px;top:54.28px" class="cls_007"><span class="cls_007">structure, not the underlying method table, as shown in Figure 6-19.</span></div>
<div style="position:absolute;left:185.96px;top:79.81px" class="cls_123"><span class="cls_123">RClass</span></div>
<div style="position:absolute;left:120.00px;top:86.79px" class="cls_124"><span class="cls_124">Mathematician</span></div>
<div style="position:absolute;left:197.01px;top:91.06px" class="cls_125"><span class="cls_125">super</span></div>
<div style="position:absolute;left:258.38px;top:88.56px" class="cls_126"><span class="cls_126">Included</span></div>
<div style="position:absolute;left:366.31px;top:93.64px" class="cls_124"><span class="cls_124">Professor</span></div>
<div style="position:absolute;left:265.27px;top:98.72px" class="cls_126"><span class="cls_126">class</span></div>
<div style="position:absolute;left:253.59px;top:118.63px" class="cls_123"><span class="cls_123">RClass</span></div>
<div style="position:absolute;left:365.20px;top:118.63px" class="cls_123"><span class="cls_123">RClass</span></div>
<div style="position:absolute;left:264.63px;top:131.12px" class="cls_125"><span class="cls_125">super</span></div>
<div style="position:absolute;left:376.24px;top:131.12px" class="cls_125"><span class="cls_125">super</span></div>
<div style="position:absolute;left:319.81px;top:138.21px" class="cls_126"><span class="cls_126">copy</span></div>
<div style="position:absolute;left:264.63px;top:141.68px" class="cls_125"><span class="cls_125">m_tbl</span></div>
<div style="position:absolute;left:376.24px;top:141.68px" class="cls_125"><span class="cls_125">m_tbl</span></div>
<div style="position:absolute;left:185.96px;top:170.81px" class="cls_123"><span class="cls_123">RClass</span></div>
<div style="position:absolute;left:128.38px;top:177.80px" class="cls_126"><span class="cls_126">Superclass</span></div>
<div style="position:absolute;left:197.01px;top:181.92px" class="cls_125"><span class="cls_125">super</span></div>
<div style="position:absolute;left:371.43px;top:189.97px" class="cls_127"><span class="cls_127">lectures</span></div>
<div style="position:absolute;left:353.46px;top:208.84px" class="cls_127"><span class="cls_127">primary_classroom</span></div>
<div style="position:absolute;left:362.21px;top:237.14px" class="cls_126"><span class="cls_126">Method table</span></div>
<div style="position:absolute;left:364.76px;top:246.82px" class="cls_126"><span class="cls_126">(not copied)</span></div>
<div style="position:absolute;left:120.00px;top:266.10px" class="cls_038"><span class="cls_038">Figure 6-19: Ruby doesn’t copy the method table when you include a module.</span></div>
<div style="position:absolute;left:138.00px;top:288.60px" class="cls_007"><span class="cls_007">Ruby doesn’t copy the method table for </span><span class="cls_030">Professor</span><span class="cls_007">. Instead, it simply sets</span></div>
<div style="position:absolute;left:120.00px;top:300.60px" class="cls_030"><span class="cls_030">m_tbl</span><span class="cls_007"> in the new copy of </span><span class="cls_030">Professor</span><span class="cls_007">, the “included class,” to point to the same</span></div>
<div style="position:absolute;left:120.00px;top:312.60px" class="cls_007"><span class="cls_007">method table. This means that modifying the method table by reopening</span></div>
<div style="position:absolute;left:120.00px;top:324.60px" class="cls_007"><span class="cls_007">the module and adding new methods will change both the module and any</span></div>
<div style="position:absolute;left:120.00px;top:336.60px" class="cls_007"><span class="cls_007">classes into which it was already included.</span></div>
<div style="position:absolute;left:161.25px;top:379.31px" class="cls_020"><span class="cls_020">A Close Look at How Ruby Copies Modules</span></div>
<div style="position:absolute;left:120.50px;top:397.81px" class="cls_039"><span class="cls_039">By looking at Ruby’s C source code directly, you’ll gain a precise understanding</span></div>
<div style="position:absolute;left:120.50px;top:409.82px" class="cls_039"><span class="cls_039">of how Ruby copies modules when you include them and why Ruby behaves as</span></div>
<div style="position:absolute;left:120.50px;top:421.82px" class="cls_039"><span class="cls_039">you’ll see in this experiment. You’ll find the C function that Ruby uses to make a</span></div>
<div style="position:absolute;left:120.50px;top:433.81px" class="cls_039"><span class="cls_039">copy of a module in the </span><span class="cls_044">class.c</span><span class="cls_039"> file. Listing 6-17 shows a portion of the function</span></div>
<div style="position:absolute;left:120.50px;top:445.81px" class="cls_009"><span class="cls_009">rb_include_class_new</span><span class="cls_039">.</span></div>
<div style="position:absolute;left:120.50px;top:468.31px" class="cls_009"><span class="cls_009">VALUE</span></div>
<div style="position:absolute;left:110.00px;top:477.82px" class="cls_045"><span class="cls_045">u</span><span class="cls_009"> rb_include_class_new(VALUE module, VALUE super)</span></div>
<div style="position:absolute;left:120.50px;top:487.32px" class="cls_009"><span class="cls_009">{</span></div>
<div style="position:absolute;left:110.00px;top:496.82px" class="cls_045"><span class="cls_045">v</span><span class="cls_009">     VALUE klass = class_alloc(T_ICLASS, rb_cClass);</span></div>
<div style="position:absolute;left:135.50px;top:506.32px" class="cls_009"><span class="cls_009">--snip--</span></div>
<div style="position:absolute;left:110.00px;top:515.83px" class="cls_045"><span class="cls_045">w</span><span class="cls_009">     RCLASS_IV_TBL(klass) = RCLASS_IV_TBL(module);</span></div>
<div style="position:absolute;left:135.50px;top:525.33px" class="cls_009"><span class="cls_009">RCLASS_CONST_TBL(klass) = RCLASS_CONST_TBL(module);</span></div>
<div style="position:absolute;left:110.00px;top:534.83px" class="cls_045"><span class="cls_045">x</span><span class="cls_009">     RCLASS_M_TBL(klass) = RCLASS_M_TBL(RCLASS_ORIGIN(module));</span></div>
<div style="position:absolute;left:110.00px;top:544.33px" class="cls_045"><span class="cls_045">y</span><span class="cls_009">     RCLASS_SUPER(klass) = super;</span></div>
<div style="position:absolute;left:135.50px;top:553.84px" class="cls_009"><span class="cls_009">--snip--</span></div>
<div style="position:absolute;left:135.50px;top:563.34px" class="cls_009"><span class="cls_009">return (VALUE)klass;</span></div>
<div style="position:absolute;left:120.50px;top:572.84px" class="cls_009"><span class="cls_009">}</span></div>
<div style="position:absolute;left:120.50px;top:595.31px" class="cls_043"><span class="cls_043">Listing 6-17: A portion of the </span><span class="cls_015">rb_include_class_new</span><span class="cls_043"> C function, from </span><span class="cls_065">class.c</span></div>
<div style="position:absolute;left:48.00px;top:633.00px" class="cls_020"><span class="cls_020">154</span></div>
<div style="position:absolute;left:74.08px;top:636.00px" class="cls_021"><span class="cls_021">Chapter 6</span></div>
</div>
<div style="position:absolute;left:50%;margin-left:-252px;top:118300px;width:504px;height:666px;border-style:outset;overflow:hidden">
<div style="position:absolute;left:0px;top:0px">
<img src="e698b76e-46bd-11eb-8b25-0cc47a792c0a_id_e698b76e-46bd-11eb-8b25-0cc47a792c0a_files/background179.jpg" width=504 height=666></div>
<div style="position:absolute;left:141.50px;top:61.15px" class="cls_039"><span class="cls_039">At </span><span class="cls_046">u</span><span class="cls_039"> Ruby passes in </span><span class="cls_009">module</span><span class="cls_039"> (the target module to copy) and </span><span class="cls_009">super</span><span class="cls_039"> (the super-</span></div>
<div style="position:absolute;left:123.50px;top:73.15px" class="cls_039"><span class="cls_039">class to use for the new copy of </span><span class="cls_009">module</span><span class="cls_039">). By specifying a particular superclass, Ruby</span></div>
<div style="position:absolute;left:123.50px;top:85.16px" class="cls_039"><span class="cls_039">inserts the new copy into the superclass chain at a particular place. If you search</span></div>
<div style="position:absolute;left:123.50px;top:97.15px" class="cls_044"><span class="cls_044">class.c</span><span class="cls_039"> for </span><span class="cls_009">rb_include_class_new</span><span class="cls_039">, you’ll find that Ruby calls it from another C function,</span></div>
<div style="position:absolute;left:123.50px;top:109.15px" class="cls_009"><span class="cls_009">include_modules_at</span><span class="cls_039">, which handles the complex internal logic that Ruby uses to</span></div>
<div style="position:absolute;left:123.50px;top:121.16px" class="cls_039"><span class="cls_039">include modules.</span></div>
<div style="position:absolute;left:141.50px;top:133.15px" class="cls_039"><span class="cls_039">At </span><span class="cls_046">v</span><span class="cls_039"> Ruby calls </span><span class="cls_009">class_alloc</span><span class="cls_039"> to create a new </span><span class="cls_009">RClass</span><span class="cls_039"> structure and saves a refer-</span></div>
<div style="position:absolute;left:123.50px;top:145.15px" class="cls_039"><span class="cls_039">ence to it in </span><span class="cls_009">klass</span><span class="cls_039">. Notice the first parameter to </span><span class="cls_009">class_alloc</span><span class="cls_039"> is the value </span><span class="cls_009">T_ICLASS</span><span class="cls_039">,</span></div>
<div style="position:absolute;left:123.50px;top:157.15px" class="cls_039"><span class="cls_039">which identifies the new class as an included class. Ruby uses </span><span class="cls_009">T_ICLASS</span><span class="cls_039"> throughout its</span></div>
<div style="position:absolute;left:123.50px;top:169.16px" class="cls_039"><span class="cls_039">C source code when dealing with included classes.</span></div>
<div style="position:absolute;left:141.49px;top:181.15px" class="cls_039"><span class="cls_039">At </span><span class="cls_046">w</span><span class="cls_039"> Ruby copies a series of pointers from the original module’s </span><span class="cls_009">RClass</span><span class="cls_039"> structure</span></div>
<div style="position:absolute;left:123.50px;top:193.15px" class="cls_039"><span class="cls_039">over to the new copy using three C macros that operate on </span><span class="cls_009">RClass</span><span class="cls_039">.</span></div>
<div style="position:absolute;left:123.50px;top:211.15px" class="cls_039"><span class="cls_039">•</span><span class="cls_009">   RCLASS_IV_TBL</span><span class="cls_039"> gets or sets a pointer to the instance variable table.</span></div>
<div style="position:absolute;left:123.50px;top:226.15px" class="cls_039"><span class="cls_039">•</span><span class="cls_009">   RCLASS_CONST_TBL</span><span class="cls_039"> gets or sets a pointer to the constant variable table.</span></div>
<div style="position:absolute;left:123.50px;top:241.15px" class="cls_039"><span class="cls_039">•</span><span class="cls_009">   RCLASS_M_TBL</span><span class="cls_039"> gets or sets a pointer to the method table.</span></div>
<div style="position:absolute;left:141.50px;top:259.15px" class="cls_039"><span class="cls_039">For example, </span><span class="cls_009">RCLASS_IV_TBL(klass) = RCLASS_IV_TBL(module)</span><span class="cls_039"> sets the instance</span></div>
<div style="position:absolute;left:123.50px;top:271.15px" class="cls_039"><span class="cls_039">variable table pointer in </span><span class="cls_009">klass</span><span class="cls_039"> (the new copy) to the instance variable pointer from</span></div>
<div style="position:absolute;left:123.50px;top:283.15px" class="cls_009"><span class="cls_009">module</span><span class="cls_039"> (the target module to copy). Now </span><span class="cls_009">klass</span><span class="cls_039"> and </span><span class="cls_009">module</span><span class="cls_039"> use the same instance</span></div>
<div style="position:absolute;left:123.50px;top:295.15px" class="cls_039"><span class="cls_039">variables. In the same way, </span><span class="cls_009">klass</span><span class="cls_039"> shares constant and method tables with </span><span class="cls_009">module</span><span class="cls_039">.</span></div>
<div style="position:absolute;left:123.50px;top:307.15px" class="cls_039"><span class="cls_039">Because they share the same method table, adding a new method to </span><span class="cls_009">module</span><span class="cls_039"> also</span></div>
<div style="position:absolute;left:123.50px;top:319.15px" class="cls_039"><span class="cls_039">adds it to </span><span class="cls_009">klass</span><span class="cls_039">. This explains the behavior we saw in Experiment 6-1: Adding a</span></div>
<div style="position:absolute;left:123.50px;top:331.16px" class="cls_039"><span class="cls_039">method to a module also adds it to each class that includes that module.</span></div>
<div style="position:absolute;left:141.50px;top:343.15px" class="cls_039"><span class="cls_039">Also note at </span><span class="cls_046">x</span><span class="cls_039"> Ruby uses </span><span class="cls_009">RCLASS_ORIGIN(module)</span><span class="cls_039">, not </span><span class="cls_009">module</span><span class="cls_039">. Normally</span></div>
<div style="position:absolute;left:123.50px;top:355.15px" class="cls_009"><span class="cls_009">RCLASS_ORIGIN(module)</span><span class="cls_039"> is the same as </span><span class="cls_009">module</span><span class="cls_039">; however, if you have earlier used</span></div>
<div style="position:absolute;left:123.50px;top:367.15px" class="cls_009"><span class="cls_009">prepend</span><span class="cls_039"> in </span><span class="cls_009">module</span><span class="cls_039">, then </span><span class="cls_009">RCLASS_ORIGIN(module)</span><span class="cls_039"> instead returns the origin class for</span></div>
<div style="position:absolute;left:123.50px;top:379.15px" class="cls_009"><span class="cls_009">module</span><span class="cls_039">. Recall that when you call </span><span class="cls_009">Module#prepend</span><span class="cls_039">, Ruby makes a copy (the origin</span></div>
<div style="position:absolute;left:123.50px;top:391.16px" class="cls_039"><span class="cls_039">class) of the target module and inserts the copy into the superclass chain. By using</span></div>
<div style="position:absolute;left:123.50px;top:403.15px" class="cls_009"><span class="cls_009">RCLASS_ORIGIN(module)</span><span class="cls_039">, Ruby gets the original module’s method table, even if you</span></div>
<div style="position:absolute;left:123.50px;top:415.16px" class="cls_039"><span class="cls_039">prepended it with a different module.</span></div>
<div style="position:absolute;left:141.50px;top:427.15px" class="cls_039"><span class="cls_039">Finally, at </span><span class="cls_046">y</span><span class="cls_039"> Ruby sets the superclass pointer of </span><span class="cls_009">klass</span><span class="cls_039"> to the specified superclass</span></div>
<div style="position:absolute;left:123.50px;top:439.16px" class="cls_039"><span class="cls_039">and returns it.</span></div>
<div style="position:absolute;left:69.00px;top:498.63px" class="cls_031"><span class="cls_031">Constant Lookup</span></div>
<div style="position:absolute;left:123.00px;top:518.63px" class="cls_007"><span class="cls_007">We’ve learned about Ruby’s method lookup algorithm and how it searches</span></div>
<div style="position:absolute;left:123.00px;top:530.63px" class="cls_007"><span class="cls_007">through the superclass chain to find the right method to call. Now we’ll</span></div>
<div style="position:absolute;left:123.00px;top:542.63px" class="cls_007"><span class="cls_007">turn our attention to a related process: Ruby’s constant lookup algorithm,</span></div>
<div style="position:absolute;left:123.00px;top:554.63px" class="cls_007"><span class="cls_007">or the process Ruby uses to find a constant value that you refer to in your code.</span></div>
<div style="position:absolute;left:141.00px;top:566.63px" class="cls_007"><span class="cls_007">Clearly method lookup is central to the language, but why study con-</span></div>
<div style="position:absolute;left:123.00px;top:578.63px" class="cls_007"><span class="cls_007">stant lookup? As Ruby developers, we don’t use constants very often in our</span></div>
<div style="position:absolute;left:123.00px;top:590.63px" class="cls_007"><span class="cls_007">code—certainly not as often as we use classes, modules, variables, and blocks.</span></div>
<div style="position:absolute;left:330.86px;top:636.00px" class="cls_021"><span class="cls_021">Method Lookup and Constant Lookup</span></div>
<div style="position:absolute;left:443.13px;top:633.00px" class="cls_020"><span class="cls_020">155</span></div>
</div>
<div style="position:absolute;left:50%;margin-left:-252px;top:118976px;width:504px;height:666px;border-style:outset;overflow:hidden">
<div style="position:absolute;left:0px;top:0px">
<img src="e698b76e-46bd-11eb-8b25-0cc47a792c0a_id_e698b76e-46bd-11eb-8b25-0cc47a792c0a_files/background180.jpg" width=504 height=666></div>
<div style="position:absolute;left:138.00px;top:42.28px" class="cls_007"><span class="cls_007">One reason is that constants, like modules and classes, are central to</span></div>
<div style="position:absolute;left:120.00px;top:54.28px" class="cls_007"><span class="cls_007">the way Ruby works internally and to the way we use Ruby. Whenever you</span></div>
<div style="position:absolute;left:120.00px;top:66.28px" class="cls_007"><span class="cls_007">define a module or class, you also define a constant. And whenever you refer</span></div>
<div style="position:absolute;left:120.00px;top:78.28px" class="cls_007"><span class="cls_007">to or use a module or class, Ruby has to look up the corresponding constant.</span></div>
<div style="position:absolute;left:138.00px;top:90.28px" class="cls_007"><span class="cls_007">The second reason has to do with the way Ruby finds a constant that</span></div>
<div style="position:absolute;left:120.00px;top:102.28px" class="cls_007"><span class="cls_007">you refer to in your code. As you may know, Ruby finds constants defined</span></div>
<div style="position:absolute;left:120.00px;top:114.28px" class="cls_007"><span class="cls_007">in a superclass, but it also finds constants in the surrounding namespace</span></div>
<div style="position:absolute;left:120.00px;top:126.28px" class="cls_007"><span class="cls_007">or syntactical scope of your program. Studying how Ruby handles syntacti-</span></div>
<div style="position:absolute;left:120.00px;top:138.28px" class="cls_007"><span class="cls_007">cal scope leads us to some important discoveries about how Ruby works</span></div>
<div style="position:absolute;left:120.00px;top:150.28px" class="cls_007"><span class="cls_007">internally.</span></div>
<div style="position:absolute;left:138.00px;top:162.28px" class="cls_007"><span class="cls_007">Let’s begin by reviewing how constants work in Ruby.</span></div>
<div style="position:absolute;left:120.00px;top:187.28px" class="cls_055"><span class="cls_055">Finding a Constant in a Superclass</span></div>
<div style="position:absolute;left:120.00px;top:205.28px" class="cls_007"><span class="cls_007">One way that Ruby searches for the definition of a constant you refer to</span></div>
<div style="position:absolute;left:120.00px;top:217.28px" class="cls_007"><span class="cls_007">is by using the superclass chain just as it would look for a method defini-</span></div>
<div style="position:absolute;left:120.00px;top:229.28px" class="cls_007"><span class="cls_007">tion. Listing 6-18 shows an example of one class finding a constant in its</span></div>
<div style="position:absolute;left:120.00px;top:241.28px" class="cls_007"><span class="cls_007">superclass.</span></div>
<div style="position:absolute;left:120.00px;top:265.28px" class="cls_030"><span class="cls_030">class MyClass</span></div>
<div style="position:absolute;left:108.15px;top:275.78px" class="cls_046"><span class="cls_046">u</span><span class="cls_030">   SOME_CONSTANT = "Some value..."</span></div>
<div style="position:absolute;left:120.00px;top:286.27px" class="cls_030"><span class="cls_030">end</span></div>
<div style="position:absolute;left:108.15px;top:307.28px" class="cls_046"><span class="cls_046">v</span><span class="cls_030"> class Subclass &lt; MyClass</span></div>
<div style="position:absolute;left:128.50px;top:317.78px" class="cls_030"><span class="cls_030">p SOME_CONSTANT</span></div>
<div style="position:absolute;left:120.00px;top:328.27px" class="cls_030"><span class="cls_030">end</span></div>
<div style="position:absolute;left:120.00px;top:350.77px" class="cls_038"><span class="cls_038">Listing 6-18: Ruby finds constants you define in a superclass.</span></div>
<div style="position:absolute;left:138.00px;top:371.28px" class="cls_007"><span class="cls_007">In Listing 6-18 we define </span><span class="cls_030">MyClass</span><span class="cls_007"> with a single constant, </span><span class="cls_030">SOME_CONSTANT</span></div>
<div style="position:absolute;left:120.00px;top:383.28px" class="cls_007"><span class="cls_007">at </span><span class="cls_050">u</span><span class="cls_007">. Then we create </span><span class="cls_030">Subclass</span><span class="cls_007"> and set </span><span class="cls_030">MyClass</span><span class="cls_007"> as a superclass at </span><span class="cls_050">v</span><span class="cls_007">. When we</span></div>
<div style="position:absolute;left:120.01px;top:395.28px" class="cls_007"><span class="cls_007">print the value of </span><span class="cls_030">SOME_CONSTANT</span><span class="cls_007">, Ruby uses the same algorithm it uses to find</span></div>
<div style="position:absolute;left:120.00px;top:407.28px" class="cls_007"><span class="cls_007">a method, as shown in Figure 6-20.</span></div>
<div style="position:absolute;left:140.61px;top:433.87px" class="cls_112"><span class="cls_112">RClass: MyClass</span></div>
<div style="position:absolute;left:177.36px;top:449.47px" class="cls_128"><span class="cls_128">constants:</span></div>
<div style="position:absolute;left:271.89px;top:459.19px" class="cls_114"><span class="cls_114">class </span><span class="cls_129">MyClass</span></div>
<div style="position:absolute;left:168.47px;top:462.62px" class="cls_114"><span class="cls_114">SOME_CONSTANT</span></div>
<div style="position:absolute;left:279.81px;top:469.33px" class="cls_129"><span class="cls_129">SOME_CONSTANT</span><span class="cls_114"> = "Some value..."</span></div>
<div style="position:absolute;left:182.33px;top:476.67px" class="cls_114"><span class="cls_114">etc...</span></div>
<div style="position:absolute;left:271.89px;top:479.74px" class="cls_114"><span class="cls_114">end</span></div>
<div style="position:absolute;left:152.05px;top:537.66px" class="cls_112"><span class="cls_112">RClass: Subclass</span></div>
<div style="position:absolute;left:271.89px;top:548.12px" class="cls_114"><span class="cls_114">class </span><span class="cls_129">Subclass</span><span class="cls_114"> &lt; </span><span class="cls_129">MyClass</span></div>
<div style="position:absolute;left:175.49px;top:552.53px" class="cls_128"><span class="cls_128">superclass:</span></div>
<div style="position:absolute;left:279.81px;top:558.39px" class="cls_114"><span class="cls_114">p </span><span class="cls_129">SOME_CONSTANT</span></div>
<div style="position:absolute;left:180.35px;top:565.69px" class="cls_114"><span class="cls_114">MyClass</span></div>
<div style="position:absolute;left:271.89px;top:568.66px" class="cls_114"><span class="cls_114">end</span></div>
<div style="position:absolute;left:120.00px;top:601.20px" class="cls_038"><span class="cls_038">Figure 6-20: Ruby searches for constants using the superclass chain,</span></div>
<div style="position:absolute;left:120.00px;top:611.70px" class="cls_038"><span class="cls_038">just as it does with methods.</span></div>
<div style="position:absolute;left:48.00px;top:633.00px" class="cls_020"><span class="cls_020">156</span></div>
<div style="position:absolute;left:74.04px;top:636.00px" class="cls_021"><span class="cls_021">Chapter 6</span></div>
</div>
<div style="position:absolute;left:50%;margin-left:-252px;top:119652px;width:504px;height:666px;border-style:outset;overflow:hidden">
<div style="position:absolute;left:0px;top:0px">
<img src="e698b76e-46bd-11eb-8b25-0cc47a792c0a_id_e698b76e-46bd-11eb-8b25-0cc47a792c0a_files/background181.jpg" width=504 height=666></div>
<div style="position:absolute;left:141.00px;top:41.60px" class="cls_007"><span class="cls_007">Here, on the right, you see the code from Listing 6-18 and, on the left,</span></div>
<div style="position:absolute;left:123.00px;top:53.60px" class="cls_007"><span class="cls_007">the </span><span class="cls_030">RClass</span><span class="cls_007"> structures that correspond to each of the two classes we created.</span></div>
<div style="position:absolute;left:123.00px;top:65.60px" class="cls_007"><span class="cls_007">At the top left of the figure, you see </span><span class="cls_030">MyClass</span><span class="cls_007">, which contains the value of</span></div>
<div style="position:absolute;left:123.00px;top:77.60px" class="cls_030"><span class="cls_030">SOME_CONSTANT</span><span class="cls_007"> in its constants table. Below that is </span><span class="cls_030">Subclass</span><span class="cls_007">. When we refer</span></div>
<div style="position:absolute;left:123.00px;top:89.60px" class="cls_007"><span class="cls_007">to </span><span class="cls_030">SOME_CONSTANT</span><span class="cls_007"> from inside </span><span class="cls_030">Subclass</span><span class="cls_007">, Ruby uses the </span><span class="cls_030">super</span><span class="cls_007"> pointer to find</span></div>
<div style="position:absolute;left:123.00px;top:101.60px" class="cls_030"><span class="cls_030">MyClass</span><span class="cls_007"> and the value of </span><span class="cls_030">SOME_CONSTANT</span><span class="cls_007">.</span></div>
<div style="position:absolute;left:123.00px;top:126.60px" class="cls_055"><span class="cls_055">How Does Ruby Find a Constant in the Parent Namespace?</span></div>
<div style="position:absolute;left:123.00px;top:144.60px" class="cls_007"><span class="cls_007">Listing 6-19 shows another way to define a constant.</span></div>
<div style="position:absolute;left:111.15px;top:168.60px" class="cls_046"><span class="cls_046">u</span><span class="cls_030"> module Namespace</span></div>
<div style="position:absolute;left:111.15px;top:179.10px" class="cls_046"><span class="cls_046">v</span><span class="cls_030">   SOME_CONSTANT = "Some value..."</span></div>
<div style="position:absolute;left:111.15px;top:189.60px" class="cls_046"><span class="cls_046">w</span><span class="cls_030">   class Subclass</span></div>
<div style="position:absolute;left:111.15px;top:200.09px" class="cls_046"><span class="cls_046">x</span><span class="cls_030">     p SOME_CONSTANT</span></div>
<div style="position:absolute;left:131.50px;top:210.59px" class="cls_030"><span class="cls_030">end</span></div>
<div style="position:absolute;left:123.00px;top:221.09px" class="cls_030"><span class="cls_030">end</span></div>
<div style="position:absolute;left:123.00px;top:243.59px" class="cls_038"><span class="cls_038">Listing 6-19: Using a constant defined in the surrounding namespace</span></div>
<div style="position:absolute;left:141.00px;top:266.10px" class="cls_007"><span class="cls_007">Using idiomatic Ruby style, we create a module called </span><span class="cls_030">Namespace</span><span class="cls_007"> at </span><span class="cls_050">u</span><span class="cls_007">.</span></div>
<div style="position:absolute;left:123.01px;top:278.10px" class="cls_007"><span class="cls_007">Then, inside this module, we declare the same </span><span class="cls_030">SOME_CONSTANT</span><span class="cls_007"> value at </span><span class="cls_050">v</span><span class="cls_007">.</span></div>
<div style="position:absolute;left:123.00px;top:290.10px" class="cls_007"><span class="cls_007">Next, we declare </span><span class="cls_030">Subclass</span><span class="cls_007"> inside </span><span class="cls_030">Namespace</span><span class="cls_007"> at </span><span class="cls_050">w</span><span class="cls_007">, and we’re able to refer to</span></div>
<div style="position:absolute;left:123.00px;top:302.10px" class="cls_007"><span class="cls_007">and print the value of </span><span class="cls_030">SOME_CONSTANT</span><span class="cls_007">, just as in Listing 6-18.</span></div>
<div style="position:absolute;left:141.00px;top:314.10px" class="cls_007"><span class="cls_007">But how does Ruby find </span><span class="cls_030">SOME_CONSTANT</span><span class="cls_007"> in Listing 6-19 when we display it</span></div>
<div style="position:absolute;left:123.00px;top:326.10px" class="cls_007"><span class="cls_007">at </span><span class="cls_050">x</span><span class="cls_007">? Figure 6-21 shows the problem.</span></div>
<div style="position:absolute;left:130.35px;top:352.74px" class="cls_042"><span class="cls_042">RClass: Namespace module</span></div>
<div style="position:absolute;left:171.51px;top:368.49px" class="cls_054"><span class="cls_054">constants:</span></div>
<div style="position:absolute;left:162.54px;top:381.77px" class="cls_014"><span class="cls_014">SOME_CONSTANT</span></div>
<div style="position:absolute;left:176.54px;top:395.97px" class="cls_014"><span class="cls_014">etc...</span></div>
<div style="position:absolute;left:275.24px;top:408.62px" class="cls_014"><span class="cls_014">module Namespace</span></div>
<div style="position:absolute;left:283.24px;top:424.73px" class="cls_014"><span class="cls_014">SOME_CONSTANT = "Some value..."</span></div>
<div style="position:absolute;left:283.24px;top:443.11px" class="cls_014"><span class="cls_014">class Subclass</span></div>
<div style="position:absolute;left:184.43px;top:446.61px" class="cls_131"><span class="cls_131">?</span></div>
<div style="position:absolute;left:291.24px;top:453.49px" class="cls_014"><span class="cls_014">p SOME_CONSTANT</span></div>
<div style="position:absolute;left:283.24px;top:463.86px" class="cls_014"><span class="cls_014">end</span></div>
<div style="position:absolute;left:275.24px;top:482.62px" class="cls_014"><span class="cls_014">end</span></div>
<div style="position:absolute;left:144.91px;top:491.98px" class="cls_042"><span class="cls_042">RClass: Subclass</span></div>
<div style="position:absolute;left:169.63px;top:506.99px" class="cls_054"><span class="cls_054">superclass:</span></div>
<div style="position:absolute;left:176.54px;top:520.28px" class="cls_014"><span class="cls_014">Object</span></div>
<div style="position:absolute;left:123.00px;top:556.07px" class="cls_038"><span class="cls_038">Figure 6-21: How does Ruby find constants in the surrounding namespace?</span></div>
<div style="position:absolute;left:330.92px;top:636.00px" class="cls_021"><span class="cls_021">Method Lookup and Constant Lookup</span></div>
<div style="position:absolute;left:443.18px;top:633.00px" class="cls_020"><span class="cls_020">157</span></div>
</div>
<div style="position:absolute;left:50%;margin-left:-252px;top:120328px;width:504px;height:666px;border-style:outset;overflow:hidden">
<div style="position:absolute;left:0px;top:0px">
<img src="e698b76e-46bd-11eb-8b25-0cc47a792c0a_id_e698b76e-46bd-11eb-8b25-0cc47a792c0a_files/background182.jpg" width=504 height=666></div>
<div style="position:absolute;left:138.00px;top:42.28px" class="cls_007"><span class="cls_007">On the left side of this figure are two </span><span class="cls_030">RClass</span><span class="cls_007"> structures, one for the</span></div>
<div style="position:absolute;left:120.00px;top:54.28px" class="cls_030"><span class="cls_030">Namespace</span><span class="cls_007"> module and one for </span><span class="cls_030">Subclass</span><span class="cls_007">. Notice that </span><span class="cls_030">Namespace</span><span class="cls_007"> is not a super-</span></div>
<div style="position:absolute;left:120.00px;top:66.28px" class="cls_007"><span class="cls_007">class of </span><span class="cls_030">Subclass</span><span class="cls_007">; the </span><span class="cls_030">super</span><span class="cls_007"> pointer in </span><span class="cls_030">Subclass</span><span class="cls_007"> refers to the </span><span class="cls_030">Object</span><span class="cls_007"> class, Ruby’s</span></div>
<div style="position:absolute;left:120.00px;top:78.28px" class="cls_007"><span class="cls_007">default superclass. Then how does Ruby find </span><span class="cls_030">SOME_CONSTANT</span><span class="cls_007"> when we refer to</span></div>
<div style="position:absolute;left:120.00px;top:90.28px" class="cls_007"><span class="cls_007">it inside of </span><span class="cls_030">Subclass</span><span class="cls_007">? Somehow Ruby allows you to search up the “namespace</span></div>
<div style="position:absolute;left:120.00px;top:102.28px" class="cls_007"><span class="cls_007">chain” to find constants. This behavior is called using lexical scope to find</span></div>
<div style="position:absolute;left:120.00px;top:114.28px" class="cls_007"><span class="cls_007">a constant.</span></div>
<div style="position:absolute;left:66.00px;top:148.28px" class="cls_031"><span class="cls_031">Lexical Scope in Ruby</span></div>
<div style="position:absolute;left:120.00px;top:168.28px" class="cls_008"><span class="cls_008">Lexical scope</span><span class="cls_007"> refers to a section of code within the syntactical structure of</span></div>
<div style="position:absolute;left:120.00px;top:180.28px" class="cls_007"><span class="cls_007">your program, rather than within the superclass hierarchy or some other</span></div>
<div style="position:absolute;left:120.00px;top:192.28px" class="cls_007"><span class="cls_007">scheme. For example, suppose we use the </span><span class="cls_030">class</span><span class="cls_007"> keyword to define </span><span class="cls_030">MyClass</span><span class="cls_007">,</span></div>
<div style="position:absolute;left:120.00px;top:204.28px" class="cls_007"><span class="cls_007">as shown in Listing 6-20.</span></div>
<div style="position:absolute;left:120.00px;top:228.28px" class="cls_030"><span class="cls_030">class MyClass</span></div>
<div style="position:absolute;left:128.50px;top:238.78px" class="cls_030"><span class="cls_030">SOME_CONSTANT = "Some value..."</span></div>
<div style="position:absolute;left:120.00px;top:249.27px" class="cls_030"><span class="cls_030">end</span></div>
<div style="position:absolute;left:120.00px;top:271.77px" class="cls_038"><span class="cls_038">Listing 6-20: Defining a class with the </span><span class="cls_014">class</span><span class="cls_038"> keyword</span></div>
<div style="position:absolute;left:138.00px;top:294.28px" class="cls_007"><span class="cls_007">This code tells Ruby to create a new copy of the </span><span class="cls_030">RClass</span><span class="cls_007"> structure, but</span></div>
<div style="position:absolute;left:120.00px;top:306.28px" class="cls_007"><span class="cls_007">it also defines a new scope or syntactical section of your program. This</span></div>
<div style="position:absolute;left:120.00px;top:318.28px" class="cls_007"><span class="cls_007">is the area between the </span><span class="cls_030">class</span><span class="cls_007"> and </span><span class="cls_030">end</span><span class="cls_007"> keywords, as shown with shading in</span></div>
<div style="position:absolute;left:120.00px;top:330.28px" class="cls_007"><span class="cls_007">Figure 6-22.</span></div>
<div style="position:absolute;left:120.00px;top:351.38px" class="cls_014"><span class="cls_014">class MyClass</span></div>
<div style="position:absolute;left:129.75px;top:380.31px" class="cls_014"><span class="cls_014">SOME_CONSTANT = "Some value..."</span></div>
<div style="position:absolute;left:120.00px;top:409.24px" class="cls_014"><span class="cls_014">end</span></div>
<div style="position:absolute;left:120.00px;top:427.30px" class="cls_038"><span class="cls_038">Figure 6-22: The </span><span class="cls_014">class</span><span class="cls_038"> keyword creates</span></div>
<div style="position:absolute;left:120.00px;top:437.79px" class="cls_038"><span class="cls_038">a class and a new lexical scope.</span></div>
<div style="position:absolute;left:138.00px;top:460.30px" class="cls_007"><span class="cls_007">Think of your Ruby program as a series of scopes, one for each module</span></div>
<div style="position:absolute;left:120.00px;top:472.30px" class="cls_007"><span class="cls_007">or class that you create and another for the default, top-level lexical scope.</span></div>
<div style="position:absolute;left:120.00px;top:484.30px" class="cls_007"><span class="cls_007">To keep track of where this new scope lies inside your program’s lexical</span></div>
<div style="position:absolute;left:120.00px;top:496.30px" class="cls_007"><span class="cls_007">structure, Ruby attaches a couple of pointers to the YARV instruction snip-</span></div>
<div style="position:absolute;left:120.00px;top:508.30px" class="cls_007"><span class="cls_007">pet corresponding to the code it compiles inside this new scope, as shown</span></div>
<div style="position:absolute;left:120.00px;top:520.30px" class="cls_007"><span class="cls_007">in Figure 6-23.</span></div>
<div style="position:absolute;left:48.00px;top:633.00px" class="cls_020"><span class="cls_020">158</span></div>
<div style="position:absolute;left:74.08px;top:636.00px" class="cls_021"><span class="cls_021">Chapter 6</span></div>
</div>
<div style="position:absolute;left:50%;margin-left:-252px;top:121004px;width:504px;height:666px;border-style:outset;overflow:hidden">
<div style="position:absolute;left:0px;top:0px">
<img src="e698b76e-46bd-11eb-8b25-0cc47a792c0a_id_e698b76e-46bd-11eb-8b25-0cc47a792c0a_files/background183.jpg" width=504 height=666></div>
<div style="position:absolute;left:228.11px;top:43.89px" class="cls_017"><span class="cls_017">Lexical Scope:</span></div>
<div style="position:absolute;left:239.82px;top:66.42px" class="cls_017"><span class="cls_017">top level</span></div>
<div style="position:absolute;left:123.00px;top:73.39px" class="cls_014"><span class="cls_014">class MyClass</span></div>
<div style="position:absolute;left:313.14px;top:86.59px" class="cls_042"><span class="cls_042">RClass: MyClass</span></div>
<div style="position:absolute;left:242.20px;top:95.05px" class="cls_014"><span class="cls_014">nd_next</span></div>
<div style="position:absolute;left:131.00px;top:98.22px" class="cls_014"><span class="cls_014">SOME_CONSTANT =</span></div>
<div style="position:absolute;left:341.46px;top:102.63px" class="cls_054"><span class="cls_054">constants:</span></div>
<div style="position:absolute;left:139.00px;top:110.50px" class="cls_014"><span class="cls_014">"Some value..."</span></div>
<div style="position:absolute;left:242.20px;top:114.33px" class="cls_014"><span class="cls_014">nd_clss</span></div>
<div style="position:absolute;left:333.95px;top:118.36px" class="cls_014"><span class="cls_014">SOME_CONSTANT</span></div>
<div style="position:absolute;left:123.00px;top:137.33px" class="cls_014"><span class="cls_014">end</span></div>
<div style="position:absolute;left:346.40px;top:135.16px" class="cls_014"><span class="cls_014">etc...</span></div>
<div style="position:absolute;left:123.00px;top:164.61px" class="cls_038"><span class="cls_038">Figure 6-23: For each snippet of compiled code, Ruby uses pointers to track</span></div>
<div style="position:absolute;left:123.00px;top:175.11px" class="cls_038"><span class="cls_038">the parent lexical scope and the current class or module.</span></div>
<div style="position:absolute;left:141.00px;top:197.61px" class="cls_007"><span class="cls_007">This figure shows the lexical scope information attached to the right</span></div>
<div style="position:absolute;left:123.00px;top:209.61px" class="cls_007"><span class="cls_007">side of the Ruby code. There are two important values here:</span></div>
<div style="position:absolute;left:123.00px;top:230.61px" class="cls_050"><span class="cls_050">•</span><span class="cls_007">   First, the </span><span class="cls_030">nd_next</span><span class="cls_007"> pointer is set to the parent or surrounding lexical</span></div>
<div style="position:absolute;left:141.00px;top:242.61px" class="cls_007"><span class="cls_007">scope—the default or top-level scope in this case.</span></div>
<div style="position:absolute;left:123.00px;top:257.61px" class="cls_050"><span class="cls_050">•</span><span class="cls_007">   Next, the </span><span class="cls_030">nd_clss</span><span class="cls_007"> pointer indicates which Ruby class or module corre-</span></div>
<div style="position:absolute;left:141.00px;top:269.61px" class="cls_007"><span class="cls_007">sponds to this scope. In this example, because we just defined </span><span class="cls_030">MyClass</span></div>
<div style="position:absolute;left:141.00px;top:281.61px" class="cls_007"><span class="cls_007">using the </span><span class="cls_030">class</span><span class="cls_007"> keyword, Ruby sets the </span><span class="cls_030">nd_clss</span><span class="cls_007"> pointer to the </span><span class="cls_030">RClass</span></div>
<div style="position:absolute;left:141.00px;top:293.61px" class="cls_007"><span class="cls_007">structure corresponding to </span><span class="cls_030">MyClass</span><span class="cls_007">.</span></div>
<div style="position:absolute;left:123.00px;top:318.61px" class="cls_055"><span class="cls_055">Creating a Constant for a New Class or Module</span></div>
<div style="position:absolute;left:123.00px;top:336.61px" class="cls_007"><span class="cls_007">Whenever you create a class or module, Ruby automatically creates a corre-</span></div>
<div style="position:absolute;left:123.00px;top:348.61px" class="cls_007"><span class="cls_007">sponding constant and saves it in the class or module for the parent lexical</span></div>
<div style="position:absolute;left:123.00px;top:360.61px" class="cls_007"><span class="cls_007">scope.</span></div>
<div style="position:absolute;left:141.00px;top:372.61px" class="cls_007"><span class="cls_007">Let’s return to the “namespace” example from Listing 6-19. Figure 6-24</span></div>
<div style="position:absolute;left:123.00px;top:384.61px" class="cls_007"><span class="cls_007">shows what Ruby does internally when you create </span><span class="cls_030">MyClass</span><span class="cls_007"> inside </span><span class="cls_030">Namespace</span><span class="cls_007">.</span></div>
<div style="position:absolute;left:228.78px;top:405.91px" class="cls_017"><span class="cls_017">Lexical Scope:</span></div>
<div style="position:absolute;left:240.48px;top:425.62px" class="cls_017"><span class="cls_017">top level</span></div>
<div style="position:absolute;left:123.00px;top:432.77px" class="cls_014"><span class="cls_014">module Namespace</span></div>
<div style="position:absolute;left:312.25px;top:445.04px" class="cls_042"><span class="cls_042">RClass: Namespace</span></div>
<div style="position:absolute;left:131.00px;top:455.61px" class="cls_014"><span class="cls_014">SOME_CONSTANT =</span></div>
<div style="position:absolute;left:242.20px;top:454.44px" class="cls_014"><span class="cls_014">nd_next</span></div>
<div style="position:absolute;left:312.25px;top:454.08px" class="cls_042"><span class="cls_042">module</span></div>
<div style="position:absolute;left:139.00px;top:467.89px" class="cls_014"><span class="cls_014">"Some value..."</span></div>
<div style="position:absolute;left:342.13px;top:468.30px" class="cls_054"><span class="cls_054">constants:</span></div>
<div style="position:absolute;left:242.20px;top:473.72px" class="cls_014"><span class="cls_014">nd_clss</span></div>
<div style="position:absolute;left:131.00px;top:483.82px" class="cls_014"><span class="cls_014">class MyClass</span></div>
<div style="position:absolute;left:333.07px;top:484.03px" class="cls_014"><span class="cls_014">SOME_CONSTANT</span></div>
<div style="position:absolute;left:131.00px;top:493.56px" class="cls_014"><span class="cls_014">end</span></div>
<div style="position:absolute;left:345.07px;top:500.83px" class="cls_014"><span class="cls_014">MyClass</span></div>
<div style="position:absolute;left:123.00px;top:512.72px" class="cls_014"><span class="cls_014">end</span></div>
<div style="position:absolute;left:325.06px;top:553.71px" class="cls_042"><span class="cls_042">RClass: MyClass</span></div>
<div style="position:absolute;left:123.00px;top:582.20px" class="cls_038"><span class="cls_038">Figure 6-24: When you declare a new class, Ruby creates a new </span><span class="cls_014">RClass</span></div>
<div style="position:absolute;left:123.00px;top:592.69px" class="cls_038"><span class="cls_038">structure and defines a new constant set to the new class’s name.</span></div>
<div style="position:absolute;left:330.81px;top:636.00px" class="cls_021"><span class="cls_021">Method Lookup and Constant Lookup</span></div>
<div style="position:absolute;left:443.07px;top:633.00px" class="cls_020"><span class="cls_020">159</span></div>
</div>
<div style="position:absolute;left:50%;margin-left:-252px;top:121680px;width:504px;height:666px;border-style:outset;overflow:hidden">
<div style="position:absolute;left:0px;top:0px">
<img src="e698b76e-46bd-11eb-8b25-0cc47a792c0a_id_e698b76e-46bd-11eb-8b25-0cc47a792c0a_files/background184.jpg" width=504 height=666></div>
<div style="position:absolute;left:138.00px;top:42.28px" class="cls_007"><span class="cls_007">The dashed arrows in this figure show what actions Ruby takes when</span></div>
<div style="position:absolute;left:120.00px;top:54.28px" class="cls_007"><span class="cls_007">you create a new class or module:</span></div>
<div style="position:absolute;left:120.00px;top:75.28px" class="cls_050"><span class="cls_050">•</span><span class="cls_007">   First, Ruby creates a new </span><span class="cls_030">RClass</span><span class="cls_007"> structure for the new module or class,</span></div>
<div style="position:absolute;left:138.00px;top:87.28px" class="cls_007"><span class="cls_007">as shown at the bottom.</span></div>
<div style="position:absolute;left:120.00px;top:102.28px" class="cls_050"><span class="cls_050">•</span><span class="cls_007">   Then, Ruby creates a new constant using the new module or class name</span></div>
<div style="position:absolute;left:138.00px;top:114.28px" class="cls_007"><span class="cls_007">and saves it inside the class corresponding to the parent lexical scope.</span></div>
<div style="position:absolute;left:138.00px;top:126.28px" class="cls_007"><span class="cls_007">Ruby sets the value of the new constant to be a reference or pointer to</span></div>
<div style="position:absolute;left:138.00px;top:138.28px" class="cls_007"><span class="cls_007">the new </span><span class="cls_030">RClass</span><span class="cls_007"> structure. In Figure 6-24 you can see that the </span><span class="cls_030">MyClass</span></div>
<div style="position:absolute;left:138.00px;top:150.28px" class="cls_007"><span class="cls_007">constant appears in the constants table for the </span><span class="cls_030">Namespace</span><span class="cls_007"> module.</span></div>
<div style="position:absolute;left:138.00px;top:171.28px" class="cls_007"><span class="cls_007">The new class also gets its own new lexical scope, as shown in Figure 6-25.</span></div>
<div style="position:absolute;left:232.02px;top:192.57px" class="cls_017"><span class="cls_017">Lexical Scope:</span></div>
<div style="position:absolute;left:243.72px;top:207.45px" class="cls_017"><span class="cls_017">top level</span></div>
<div style="position:absolute;left:120.00px;top:213.94px" class="cls_014"><span class="cls_014">module Namespace</span></div>
<div style="position:absolute;left:315.58px;top:222.64px" class="cls_042"><span class="cls_042">RClass: Namespace</span></div>
<div style="position:absolute;left:315.58px;top:231.69px" class="cls_042"><span class="cls_042">module</span></div>
<div style="position:absolute;left:246.20px;top:235.60px" class="cls_014"><span class="cls_014">nd_next</span></div>
<div style="position:absolute;left:128.00px;top:238.77px" class="cls_014"><span class="cls_014">SOME_CONSTANT =</span></div>
<div style="position:absolute;left:345.37px;top:245.91px" class="cls_054"><span class="cls_054">constants:</span></div>
<div style="position:absolute;left:136.00px;top:251.05px" class="cls_014"><span class="cls_014">"Some value..."</span></div>
<div style="position:absolute;left:246.20px;top:254.88px" class="cls_014"><span class="cls_014">nd_clss</span></div>
<div style="position:absolute;left:336.31px;top:261.63px" class="cls_014"><span class="cls_014">SOME_CONSTANT</span></div>
<div style="position:absolute;left:348.31px;top:278.43px" class="cls_014"><span class="cls_014">MyClass</span></div>
<div style="position:absolute;left:128.00px;top:301.67px" class="cls_014"><span class="cls_014">class MyClass</span></div>
<div style="position:absolute;left:246.20px;top:323.33px" class="cls_014"><span class="cls_014">nd_next</span></div>
<div style="position:absolute;left:246.20px;top:342.61px" class="cls_014"><span class="cls_014">nd_clss</span></div>
<div style="position:absolute;left:328.38px;top:343.04px" class="cls_042"><span class="cls_042">RClass: MyClass</span></div>
<div style="position:absolute;left:128.00px;top:364.46px" class="cls_014"><span class="cls_014">end</span></div>
<div style="position:absolute;left:120.00px;top:376.46px" class="cls_014"><span class="cls_014">end</span></div>
<div style="position:absolute;left:120.00px;top:394.52px" class="cls_038"><span class="cls_038">Figure 6-25: A new class also gets its own lexical scope, shown here as the second</span></div>
<div style="position:absolute;left:120.00px;top:405.02px" class="cls_038"><span class="cls_038">shaded rectangle.</span></div>
<div style="position:absolute;left:138.00px;top:427.52px" class="cls_007"><span class="cls_007">This figure shows a new shaded rectangle for the new scope. Its </span><span class="cls_030">nd_clss</span></div>
<div style="position:absolute;left:120.00px;top:439.52px" class="cls_007"><span class="cls_007">pointer is set to the new </span><span class="cls_030">RClass</span><span class="cls_007"> structure for </span><span class="cls_030">MyClass</span><span class="cls_007">, and its </span><span class="cls_030">nd_next</span><span class="cls_007"> pointer</span></div>
<div style="position:absolute;left:120.00px;top:451.52px" class="cls_007"><span class="cls_007">is set to the parent scope that corresponds to the </span><span class="cls_030">Namespace</span><span class="cls_007"> module.</span></div>
<div style="position:absolute;left:120.00px;top:476.52px" class="cls_055"><span class="cls_055">Finding a Constant in the Parent Namespace Using Lexical Scope</span></div>
<div style="position:absolute;left:120.00px;top:494.52px" class="cls_007"><span class="cls_007">In Listing 6-21 let’s return to the example from Listing 6-19, which prints</span></div>
<div style="position:absolute;left:120.00px;top:506.52px" class="cls_007"><span class="cls_007">the value of </span><span class="cls_030">SOME_CONSTANT</span><span class="cls_007">.</span></div>
<div style="position:absolute;left:120.00px;top:530.52px" class="cls_030"><span class="cls_030">module Namespace</span></div>
<div style="position:absolute;left:128.50px;top:541.02px" class="cls_030"><span class="cls_030">SOME_CONSTANT = "Some value..."</span></div>
<div style="position:absolute;left:128.50px;top:551.52px" class="cls_030"><span class="cls_030">class Subclass</span></div>
<div style="position:absolute;left:108.15px;top:562.02px" class="cls_046"><span class="cls_046">u</span><span class="cls_030">     p SOME_CONSTANT</span></div>
<div style="position:absolute;left:128.50px;top:572.51px" class="cls_030"><span class="cls_030">end</span></div>
<div style="position:absolute;left:120.00px;top:583.01px" class="cls_030"><span class="cls_030">end</span></div>
<div style="position:absolute;left:120.00px;top:607.01px" class="cls_038"><span class="cls_038">Listing 6-21: Finding a constant in the parent lexical scope (repeated from Listing 6-19)</span></div>
<div style="position:absolute;left:48.00px;top:633.00px" class="cls_020"><span class="cls_020">160</span></div>
<div style="position:absolute;left:74.20px;top:636.00px" class="cls_021"><span class="cls_021">Chapter 6</span></div>
</div>
<div style="position:absolute;left:50%;margin-left:-252px;top:122356px;width:504px;height:666px;border-style:outset;overflow:hidden">
<div style="position:absolute;left:0px;top:0px">
<img src="e698b76e-46bd-11eb-8b25-0cc47a792c0a_id_e698b76e-46bd-11eb-8b25-0cc47a792c0a_files/background185.jpg" width=504 height=666></div>
<div style="position:absolute;left:141.00px;top:41.60px" class="cls_007"><span class="cls_007">In Figure 6-20 we saw how Ruby iterates over </span><span class="cls_030">super</span><span class="cls_007"> pointers to find a</span></div>
<div style="position:absolute;left:123.00px;top:53.60px" class="cls_007"><span class="cls_007">constant from a superclass. But in Figure 6-21 we saw that Ruby couldn’t use</span></div>
<div style="position:absolute;left:123.00px;top:65.60px" class="cls_030"><span class="cls_030">super</span><span class="cls_007"> pointers to find </span><span class="cls_030">SOME_CONSTANT</span><span class="cls_007"> in this example because </span><span class="cls_030">Namespace</span><span class="cls_007"> is not a</span></div>
<div style="position:absolute;left:123.00px;top:77.60px" class="cls_007"><span class="cls_007">superclass of </span><span class="cls_030">MyClass</span><span class="cls_007">. Instead, as Figure 6-26 shows, Ruby can use the </span><span class="cls_030">nd_next</span></div>
<div style="position:absolute;left:123.00px;top:89.60px" class="cls_007"><span class="cls_007">pointers to iterate up through your program’s lexical scopes in search of</span></div>
<div style="position:absolute;left:123.00px;top:101.60px" class="cls_007"><span class="cls_007">constant values.</span></div>
<div style="position:absolute;left:236.16px;top:128.89px" class="cls_017"><span class="cls_017">Lexical Scope:</span></div>
<div style="position:absolute;left:247.87px;top:147.43px" class="cls_017"><span class="cls_017">top level</span></div>
<div style="position:absolute;left:124.73px;top:155.04px" class="cls_014"><span class="cls_014">module Namespace</span></div>
<div style="position:absolute;left:319.63px;top:166.62px" class="cls_042"><span class="cls_042">RClass: Namespace</span></div>
<div style="position:absolute;left:250.93px;top:176.71px" class="cls_014"><span class="cls_014">nd_next</span></div>
<div style="position:absolute;left:319.63px;top:175.67px" class="cls_042"><span class="cls_042">module</span></div>
<div style="position:absolute;left:132.73px;top:179.88px" class="cls_014"><span class="cls_014">SOME_CONSTANT =</span></div>
<div style="position:absolute;left:349.42px;top:189.89px" class="cls_054"><span class="cls_054">constants:</span></div>
<div style="position:absolute;left:140.73px;top:192.16px" class="cls_014"><span class="cls_014">"Some value..."</span></div>
<div style="position:absolute;left:250.93px;top:195.99px" class="cls_014"><span class="cls_014">nd_clss</span></div>
<div style="position:absolute;left:340.36px;top:205.61px" class="cls_014"><span class="cls_014">SOME_CONSTANT</span></div>
<div style="position:absolute;left:352.36px;top:222.41px" class="cls_014"><span class="cls_014">MyClass</span></div>
<div style="position:absolute;left:131.73px;top:252.78px" class="cls_014"><span class="cls_014">class MyClass</span></div>
<div style="position:absolute;left:250.93px;top:274.44px" class="cls_014"><span class="cls_014">nd_next</span></div>
<div style="position:absolute;left:139.73px;top:286.43px" class="cls_014"><span class="cls_014">p SOME_CONSTANT</span></div>
<div style="position:absolute;left:250.93px;top:293.72px" class="cls_014"><span class="cls_014">nd_clss</span></div>
<div style="position:absolute;left:332.43px;top:295.02px" class="cls_042"><span class="cls_042">RClass: MyClass</span></div>
<div style="position:absolute;left:131.73px;top:315.57px" class="cls_014"><span class="cls_014">end</span></div>
<div style="position:absolute;left:124.73px;top:327.57px" class="cls_014"><span class="cls_014">end</span></div>
<div style="position:absolute;left:123.00px;top:345.63px" class="cls_038"><span class="cls_038">Figure 6-26: Ruby can find </span><span class="cls_014">SOME_CONSTANT</span><span class="cls_038"> in the parent lexical scope using the</span></div>
<div style="position:absolute;left:123.00px;top:356.13px" class="cls_014"><span class="cls_014">nd_next</span><span class="cls_038"> and </span><span class="cls_014">nd_clss</span><span class="cls_038"> pointers.</span></div>
<div style="position:absolute;left:141.00px;top:384.63px" class="cls_007"><span class="cls_007">By following the arrows in this figure, you can see how the </span><span class="cls_030">p SOME_CONSTANT</span></div>
<div style="position:absolute;left:123.00px;top:396.63px" class="cls_007"><span class="cls_007">command at </span><span class="cls_050">u</span><span class="cls_007"> in Listing 6-21 works:</span></div>
<div style="position:absolute;left:123.00px;top:417.63px" class="cls_050"><span class="cls_050">•</span><span class="cls_007">   First, Ruby looks for the value of </span><span class="cls_030">SOME_CONSTANT</span><span class="cls_007"> in the current</span></div>
<div style="position:absolute;left:141.00px;top:429.63px" class="cls_007"><span class="cls_007">scope’s class, </span><span class="cls_030">MyClass</span><span class="cls_007">. In Figure 6-26 the current scope contains the</span></div>
<div style="position:absolute;left:141.00px;top:441.63px" class="cls_030"><span class="cls_030">p SOME_CONSTANT</span><span class="cls_007"> code. You can see how Ruby finds the current scope’s</span></div>
<div style="position:absolute;left:141.01px;top:453.63px" class="cls_007"><span class="cls_007">class on the right using the </span><span class="cls_030">nd_clss</span><span class="cls_007"> pointer. Here, </span><span class="cls_030">MyClass</span><span class="cls_007"> has no con-</span></div>
<div style="position:absolute;left:141.00px;top:465.63px" class="cls_007"><span class="cls_007">stants table.</span></div>
<div style="position:absolute;left:123.00px;top:480.63px" class="cls_050"><span class="cls_050">•</span><span class="cls_007">   Next, Ruby finds the parent lexical scope using the </span><span class="cls_030">nd_next</span><span class="cls_007"> pointer,</span></div>
<div style="position:absolute;left:141.00px;top:492.63px" class="cls_007"><span class="cls_007">moving up Figure 6-26.</span></div>
<div style="position:absolute;left:123.00px;top:507.63px" class="cls_050"><span class="cls_050">•</span><span class="cls_007">   Ruby repeats the process, searching the current scope’s class using</span></div>
<div style="position:absolute;left:141.00px;top:519.63px" class="cls_007"><span class="cls_007">the </span><span class="cls_030">nd_clss</span><span class="cls_007"> pointer. This time the current scope’s class is the </span><span class="cls_030">Namespace</span></div>
<div style="position:absolute;left:141.00px;top:531.63px" class="cls_007"><span class="cls_007">module, at the top right of Figure 6-26. Now Ruby finds </span><span class="cls_030">SOME_CONSTANT</span></div>
<div style="position:absolute;left:141.00px;top:543.63px" class="cls_007"><span class="cls_007">in </span><span class="cls_030">Namespace</span><span class="cls_007">’s constants table.</span></div>
<div style="position:absolute;left:331.15px;top:636.00px" class="cls_021"><span class="cls_021">Method Lookup and Constant Lookup</span></div>
<div style="position:absolute;left:443.41px;top:633.00px" class="cls_020"><span class="cls_020">161</span></div>
</div>
<div style="position:absolute;left:50%;margin-left:-252px;top:123032px;width:504px;height:666px;border-style:outset;overflow:hidden">
<div style="position:absolute;left:0px;top:0px">
<img src="e698b76e-46bd-11eb-8b25-0cc47a792c0a_id_e698b76e-46bd-11eb-8b25-0cc47a792c0a_files/background186.jpg" width=504 height=666></div>
<div style="position:absolute;left:120.00px;top:42.55px" class="cls_055"><span class="cls_055">Ruby’s Constant Lookup Algorithm</span></div>
<div style="position:absolute;left:120.00px;top:60.55px" class="cls_007"><span class="cls_007">The flowchart in Figure 6-27 summarizes how Ruby iterates over the lexical</span></div>
<div style="position:absolute;left:120.00px;top:72.55px" class="cls_007"><span class="cls_007">scope chain while looking for constants.</span></div>
<div style="position:absolute;left:156.65px;top:98.89px" class="cls_054"><span class="cls_054">set </span><span class="cls_067">cref</span><span class="cls_054"> to</span></div>
<div style="position:absolute;left:150.79px;top:109.33px" class="cls_054"><span class="cls_054">current lexical</span></div>
<div style="position:absolute;left:166.05px;top:119.78px" class="cls_054"><span class="cls_054">scope</span></div>
<div style="position:absolute;left:153.30px;top:162.01px" class="cls_054"><span class="cls_054">look through</span></div>
<div style="position:absolute;left:150.96px;top:172.46px" class="cls_054"><span class="cls_054">constant table</span></div>
<div style="position:absolute;left:149.98px;top:182.91px" class="cls_054"><span class="cls_054">for </span><span class="cls_067">cref</span><span class="cls_054">’s class</span></div>
<div style="position:absolute;left:245.90px;top:228.28px" class="cls_054"><span class="cls_054">not</span></div>
<div style="position:absolute;left:241.43px;top:235.96px" class="cls_054"><span class="cls_054">found</span></div>
<div style="position:absolute;left:160.75px;top:244.19px" class="cls_054"><span class="cls_054">constant</span></div>
<div style="position:absolute;left:292.06px;top:243.85px" class="cls_054"><span class="cls_054">set </span><span class="cls_067">cref</span><span class="cls_054"> parent</span></div>
<div style="position:absolute;left:164.42px;top:252.64px" class="cls_054"><span class="cls_054">found?</span></div>
<div style="position:absolute;left:296.98px;top:253.29px" class="cls_054"><span class="cls_054">lexical scope</span></div>
<div style="position:absolute;left:182.34px;top:290.35px" class="cls_054"><span class="cls_054">found</span></div>
<div style="position:absolute;left:167.44px;top:325.68px" class="cls_054"><span class="cls_054">done</span></div>
<div style="position:absolute;left:120.00px;top:358.70px" class="cls_038"><span class="cls_038">Figure 6-27: Part of Ruby’s constant lookup algorithm</span></div>
<div style="position:absolute;left:138.00px;top:381.20px" class="cls_007"><span class="cls_007">Notice that this figure is very similar to Figure 6-3. Ruby iterates over</span></div>
<div style="position:absolute;left:120.00px;top:393.20px" class="cls_007"><span class="cls_007">the linked list formed by the </span><span class="cls_030">nd_next</span><span class="cls_007"> pointers in each lexical scope while</span></div>
<div style="position:absolute;left:120.00px;top:405.20px" class="cls_007"><span class="cls_007">looking for a constant, just as it iterates over the </span><span class="cls_030">super</span><span class="cls_007"> pointers while look-</span></div>
<div style="position:absolute;left:120.00px;top:417.20px" class="cls_007"><span class="cls_007">ing for a method. Ruby uses superclasses to find methods and parent lexical</span></div>
<div style="position:absolute;left:120.00px;top:429.20px" class="cls_007"><span class="cls_007">scopes to find constants.</span></div>
<div style="position:absolute;left:138.00px;top:441.20px" class="cls_007"><span class="cls_007">However, this is just part of Ruby’s constant lookup algorithm. As we saw</span></div>
<div style="position:absolute;left:120.00px;top:453.20px" class="cls_007"><span class="cls_007">earlier in Figure 6-20, Ruby also looks through superclasses for constants.</span></div>
<div style="position:absolute;left:120.00px;top:487.20px" class="cls_031"><span class="cls_031">Experiment 6-2: Which Constant Will Ruby Find First?</span></div>
<div style="position:absolute;left:120.00px;top:507.20px" class="cls_007"><span class="cls_007">We’ve just learned that Ruby iterates over a linked list of lexical scopes in</span></div>
<div style="position:absolute;left:120.00px;top:519.20px" class="cls_007"><span class="cls_007">order to look up constant values. However, we saw earlier in Figure 6-20</span></div>
<div style="position:absolute;left:120.00px;top:531.20px" class="cls_007"><span class="cls_007">that Ruby also uses the superclass chain to look up constants. Let’s use</span></div>
<div style="position:absolute;left:120.00px;top:543.20px" class="cls_007"><span class="cls_007">Listing 6-22 to see how this works in more detail.</span></div>
<div style="position:absolute;left:120.00px;top:567.20px" class="cls_030"><span class="cls_030">class Superclass</span></div>
<div style="position:absolute;left:108.15px;top:577.69px" class="cls_046"><span class="cls_046">u</span><span class="cls_030">   FIND_ME = "Found in Superclass"</span></div>
<div style="position:absolute;left:120.00px;top:588.19px" class="cls_030"><span class="cls_030">end</span></div>
<div style="position:absolute;left:48.00px;top:633.00px" class="cls_020"><span class="cls_020">162</span></div>
<div style="position:absolute;left:73.85px;top:636.00px" class="cls_021"><span class="cls_021">Chapter 6</span></div>
</div>
<div style="position:absolute;left:50%;margin-left:-252px;top:123708px;width:504px;height:666px;border-style:outset;overflow:hidden">
<div style="position:absolute;left:0px;top:0px">
<img src="e698b76e-46bd-11eb-8b25-0cc47a792c0a_id_e698b76e-46bd-11eb-8b25-0cc47a792c0a_files/background187.jpg" width=504 height=666></div>
<div style="position:absolute;left:123.00px;top:42.24px" class="cls_030"><span class="cls_030">module ParentLexicalScope</span></div>
<div style="position:absolute;left:111.15px;top:52.74px" class="cls_046"><span class="cls_046">v</span><span class="cls_030">   FIND_ME = "Found in ParentLexicalScope"</span></div>
<div style="position:absolute;left:131.50px;top:73.74px" class="cls_030"><span class="cls_030">module ChildLexicalScope</span></div>
<div style="position:absolute;left:140.00px;top:94.74px" class="cls_030"><span class="cls_030">class Subclass &lt; Superclass</span></div>
<div style="position:absolute;left:148.50px;top:105.24px" class="cls_030"><span class="cls_030">p FIND_ME</span></div>
<div style="position:absolute;left:140.00px;top:115.74px" class="cls_030"><span class="cls_030">end</span></div>
<div style="position:absolute;left:131.50px;top:136.74px" class="cls_030"><span class="cls_030">end</span></div>
<div style="position:absolute;left:123.00px;top:147.24px" class="cls_030"><span class="cls_030">end</span></div>
<div style="position:absolute;left:123.00px;top:169.74px" class="cls_038"><span class="cls_038">Listing 6-22: Does Ruby search the lexical scope chain first? Or does it search the super-</span></div>
<div style="position:absolute;left:123.00px;top:180.24px" class="cls_038"><span class="cls_038">class chain first? </span><span class="cls_039">(find-constant.rb)</span></div>
<div style="position:absolute;left:141.00px;top:202.74px" class="cls_007"><span class="cls_007">Notice here that I’ve defined the constant </span><span class="cls_030">FIND_ME</span><span class="cls_007"> twice—at </span><span class="cls_050">u</span><span class="cls_007"> and at </span><span class="cls_050">v</span><span class="cls_007">.</span></div>
<div style="position:absolute;left:123.00px;top:214.74px" class="cls_007"><span class="cls_007">Which constant will Ruby find first? Will Ruby first iterate over the lexical</span></div>
<div style="position:absolute;left:123.00px;top:226.74px" class="cls_007"><span class="cls_007">scope chain and find the constant at </span><span class="cls_050">v</span><span class="cls_007">? Or will it iterate over the superclass</span></div>
<div style="position:absolute;left:123.00px;top:238.74px" class="cls_007"><span class="cls_007">chain and find the constant value at </span><span class="cls_050">u</span><span class="cls_007">?</span></div>
<div style="position:absolute;left:141.00px;top:250.74px" class="cls_007"><span class="cls_007">Let’s find out! When we run Listing 6-22, we get the following:</span></div>
<div style="position:absolute;left:123.00px;top:274.74px" class="cls_030"><span class="cls_030">$ </span><span class="cls_040">ruby find-constant.rb</span></div>
<div style="position:absolute;left:123.00px;top:285.23px" class="cls_030"><span class="cls_030">"Found in ParentLexicalScope"</span></div>
<div style="position:absolute;left:141.00px;top:307.74px" class="cls_007"><span class="cls_007">You can see that Ruby looks through the lexical scope chain first.</span></div>
<div style="position:absolute;left:141.00px;top:319.74px" class="cls_007"><span class="cls_007">Now let’s comment out the second definition at </span><span class="cls_050">v</span><span class="cls_007"> in Listing 6-22 and</span></div>
<div style="position:absolute;left:123.00px;top:331.74px" class="cls_007"><span class="cls_007">try the experiment again:</span></div>
<div style="position:absolute;left:123.00px;top:355.74px" class="cls_030"><span class="cls_030">module ParentLexicalScope</span></div>
<div style="position:absolute;left:111.15px;top:366.23px" class="cls_046"><span class="cls_046">v</span></div>
<div style="position:absolute;left:131.48px;top:366.23px" class="cls_030"><span class="cls_030">#FIND_ME = "Found in ParentLexicalScope"</span></div>
<div style="position:absolute;left:141.00px;top:388.74px" class="cls_007"><span class="cls_007">When we run the modified Listing 6-22, we get the following:</span></div>
<div style="position:absolute;left:123.00px;top:412.74px" class="cls_030"><span class="cls_030">$ </span><span class="cls_040">ruby find-constant.rb</span></div>
<div style="position:absolute;left:123.00px;top:423.23px" class="cls_030"><span class="cls_030">"Found in Superclass"</span></div>
<div style="position:absolute;left:141.00px;top:445.74px" class="cls_007"><span class="cls_007">Because now there is only one definition of </span><span class="cls_030">FIND_ME</span><span class="cls_007">, Ruby finds it by iter-</span></div>
<div style="position:absolute;left:123.00px;top:457.74px" class="cls_007"><span class="cls_007">ating over the superclass chain.</span></div>
<div style="position:absolute;left:123.00px;top:482.74px" class="cls_055"><span class="cls_055">Ruby’s Actual Constant Lookup Algorithm</span></div>
<div style="position:absolute;left:123.00px;top:500.74px" class="cls_007"><span class="cls_007">Unfortunately, things aren’t quite so simple; there are some other quirks in</span></div>
<div style="position:absolute;left:123.00px;top:512.74px" class="cls_007"><span class="cls_007">Ruby’s behavior with regard to constants. Figure 6-28 is a simplified flow-</span></div>
<div style="position:absolute;left:123.00px;top:524.74px" class="cls_007"><span class="cls_007">chart showing Ruby’s entire constant lookup algorithm.</span></div>
<div style="position:absolute;left:330.52px;top:636.00px" class="cls_021"><span class="cls_021">Method Lookup and Constant Lookup</span></div>
<div style="position:absolute;left:442.78px;top:633.00px" class="cls_020"><span class="cls_020">163</span></div>
</div>
<div style="position:absolute;left:50%;margin-left:-252px;top:124384px;width:504px;height:666px;border-style:outset;overflow:hidden">
<div style="position:absolute;left:0px;top:0px">
<img src="e698b76e-46bd-11eb-8b25-0cc47a792c0a_id_e698b76e-46bd-11eb-8b25-0cc47a792c0a_files/background188.jpg" width=504 height=666></div>
<div style="position:absolute;left:135.80px;top:54.24px" class="cls_054"><span class="cls_054">search through</span></div>
<div style="position:absolute;left:128.28px;top:63.84px" class="cls_054"><span class="cls_054">lexical scope chain</span></div>
<div style="position:absolute;left:199.68px;top:99.74px" class="cls_054"><span class="cls_054">for each scope’s</span></div>
<div style="position:absolute;left:201.54px;top:109.34px" class="cls_054"><span class="cls_054">class, check for</span></div>
<div style="position:absolute;left:213.34px;top:118.94px" class="cls_014"><span class="cls_014">autoload</span></div>
<div style="position:absolute;left:135.80px;top:154.56px" class="cls_054"><span class="cls_054">search through</span></div>
<div style="position:absolute;left:133.12px;top:164.16px" class="cls_054"><span class="cls_054">superclass chain</span></div>
<div style="position:absolute;left:194.88px;top:204.73px" class="cls_054"><span class="cls_054">for each superclass,</span></div>
<div style="position:absolute;left:196.32px;top:214.33px" class="cls_054"><span class="cls_054">check for </span><span class="cls_014">autoload</span></div>
<div style="position:absolute;left:155.48px;top:255.03px" class="cls_054"><span class="cls_054">call</span></div>
<div style="position:absolute;left:135.51px;top:264.63px" class="cls_014"><span class="cls_014">const_missing</span></div>
<div style="position:absolute;left:120.00px;top:293.05px" class="cls_038"><span class="cls_038">Figure 6-28: A high-level summary of Ruby’s</span></div>
<div style="position:absolute;left:120.00px;top:303.55px" class="cls_038"><span class="cls_038">constant lookup algorithm</span></div>
<div style="position:absolute;left:138.00px;top:326.05px" class="cls_007"><span class="cls_007">At the top, you can see that Ruby begins by iterating up the lexical</span></div>
<div style="position:absolute;left:120.00px;top:338.05px" class="cls_007"><span class="cls_007">scope chain, as we saw in Listing 6-22. Ruby always finds constants, includ-</span></div>
<div style="position:absolute;left:120.00px;top:350.05px" class="cls_007"><span class="cls_007">ing classes or modules, that are defined in a parent lexical scope. However,</span></div>
<div style="position:absolute;left:120.00px;top:362.05px" class="cls_007"><span class="cls_007">as Ruby iterates up the scope chain, it looks to see whether you used the</span></div>
<div style="position:absolute;left:120.00px;top:374.05px" class="cls_030"><span class="cls_030">autoload</span><span class="cls_007"> keyword, which instructs it to open and read in a new code file if</span></div>
<div style="position:absolute;left:120.00px;top:386.05px" class="cls_007"><span class="cls_007">a given constant is undefined. (The Rails framework uses </span><span class="cls_030">autoload</span><span class="cls_007"> to allow</span></div>
<div style="position:absolute;left:120.00px;top:398.05px" class="cls_007"><span class="cls_007">you to load models, controllers, and other Rails objects without having to</span></div>
<div style="position:absolute;left:120.00px;top:410.05px" class="cls_007"><span class="cls_007">use </span><span class="cls_030">require</span><span class="cls_007"> explicitly.)</span></div>
<div style="position:absolute;left:138.00px;top:422.05px" class="cls_007"><span class="cls_007">If Ruby loops through the entire lexical scope chain without finding</span></div>
<div style="position:absolute;left:120.00px;top:434.05px" class="cls_007"><span class="cls_007">the given constant or a corresponding </span><span class="cls_030">autoload</span><span class="cls_007"> keyword, it then iterates</span></div>
<div style="position:absolute;left:120.00px;top:446.05px" class="cls_007"><span class="cls_007">up the superclass chain, as we saw in Listing 6-18. This allows you to load</span></div>
<div style="position:absolute;left:120.00px;top:458.05px" class="cls_007"><span class="cls_007">constants defined in a superclass. Ruby once again honors any </span><span class="cls_030">autoload</span><span class="cls_007"> key-</span></div>
<div style="position:absolute;left:120.00px;top:470.05px" class="cls_007"><span class="cls_007">word that might exist in any of those superclasses, loading an additional file</span></div>
<div style="position:absolute;left:120.00px;top:482.05px" class="cls_007"><span class="cls_007">if necessary.</span></div>
<div style="position:absolute;left:138.00px;top:494.05px" class="cls_007"><span class="cls_007">Finally, if all else fails and the constant still isn’t found, Ruby calls the</span></div>
<div style="position:absolute;left:120.00px;top:506.05px" class="cls_030"><span class="cls_030">const_missing</span><span class="cls_007"> method on your module if you provided one.</span></div>
<div style="position:absolute;left:48.00px;top:633.00px" class="cls_020"><span class="cls_020">164</span></div>
<div style="position:absolute;left:74.23px;top:636.00px" class="cls_021"><span class="cls_021">Chapter 6</span></div>
</div>
<div style="position:absolute;left:50%;margin-left:-252px;top:125060px;width:504px;height:666px;border-style:outset;overflow:hidden">
<div style="position:absolute;left:0px;top:0px">
<img src="e698b76e-46bd-11eb-8b25-0cc47a792c0a_id_e698b76e-46bd-11eb-8b25-0cc47a792c0a_files/background189.jpg" width=504 height=666></div>
<div style="position:absolute;left:69.00px;top:42.05px" class="cls_031"><span class="cls_031">Summary</span></div>
<div style="position:absolute;left:123.00px;top:62.05px" class="cls_007"><span class="cls_007">In this chapter we’ve learned two very different ways to look at your Ruby</span></div>
<div style="position:absolute;left:123.00px;top:74.05px" class="cls_007"><span class="cls_007">program. On the one hand, you can organize your code by class and super-</span></div>
<div style="position:absolute;left:123.00px;top:86.05px" class="cls_007"><span class="cls_007">class, and on the other, you can organize it by lexical scope. We saw how</span></div>
<div style="position:absolute;left:123.00px;top:98.05px" class="cls_007"><span class="cls_007">internally Ruby uses different sets of C pointers to keep track of these two</span></div>
<div style="position:absolute;left:123.00px;top:110.05px" class="cls_007"><span class="cls_007">trees as it executes your program. The </span><span class="cls_030">super</span><span class="cls_007"> pointers found in the </span><span class="cls_030">RClass</span></div>
<div style="position:absolute;left:123.00px;top:122.05px" class="cls_007"><span class="cls_007">structures form the superclass tree, while the </span><span class="cls_030">nd_next</span><span class="cls_007"> pointers from the lexi-</span></div>
<div style="position:absolute;left:123.00px;top:134.05px" class="cls_007"><span class="cls_007">cal scope structures form the namespace or lexical scope tree.</span></div>
<div style="position:absolute;left:141.00px;top:146.05px" class="cls_007"><span class="cls_007">We studied two important algorithms that use these trees: how Ruby</span></div>
<div style="position:absolute;left:123.00px;top:158.05px" class="cls_007"><span class="cls_007">looks up methods and constants. Ruby uses the class tree to find the methods</span></div>
<div style="position:absolute;left:123.00px;top:170.05px" class="cls_007"><span class="cls_007">that your code (and Ruby’s own internal code) calls. Similarly, Ruby uses</span></div>
<div style="position:absolute;left:123.00px;top:182.05px" class="cls_007"><span class="cls_007">both the lexical scope tree and the superclass hierarchy to find constants</span></div>
<div style="position:absolute;left:123.00px;top:194.05px" class="cls_007"><span class="cls_007">that your code refers to. Understanding the method and constant lookup</span></div>
<div style="position:absolute;left:123.00px;top:206.05px" class="cls_007"><span class="cls_007">algorithms is essential. They allow you to design your program and organize</span></div>
<div style="position:absolute;left:123.00px;top:218.05px" class="cls_007"><span class="cls_007">your code using these two trees in a way that is appropriate for the problem</span></div>
<div style="position:absolute;left:123.00px;top:230.05px" class="cls_007"><span class="cls_007">you are trying to solve.</span></div>
<div style="position:absolute;left:141.00px;top:242.05px" class="cls_007"><span class="cls_007">At first glance, these two organizational schemes seem completely</span></div>
<div style="position:absolute;left:123.00px;top:254.05px" class="cls_007"><span class="cls_007">orthogonal, but in fact they are closely related by the way Ruby’s classes</span></div>
<div style="position:absolute;left:123.00px;top:266.05px" class="cls_007"><span class="cls_007">behave. When you create a class or module, you add both to the superclass</span></div>
<div style="position:absolute;left:123.00px;top:278.05px" class="cls_007"><span class="cls_007">and lexical scope hierarchy, and when you refer to a class or superclass, you</span></div>
<div style="position:absolute;left:123.00px;top:290.05px" class="cls_007"><span class="cls_007">instruct Ruby to look up a particular constant using the lexical scope tree.</span></div>
<div style="position:absolute;left:330.72px;top:636.00px" class="cls_021"><span class="cls_021">Method Lookup and Constant Lookup</span></div>
<div style="position:absolute;left:442.98px;top:633.00px" class="cls_020"><span class="cls_020">165</span></div>
</div>
<div style="position:absolute;left:50%;margin-left:-252px;top:125736px;width:504px;height:666px;border-style:outset;overflow:hidden">
<div style="position:absolute;left:0px;top:0px">
<img src="e698b76e-46bd-11eb-8b25-0cc47a792c0a_id_e698b76e-46bd-11eb-8b25-0cc47a792c0a_files/background190.jpg" width=504 height=666></div>
<div style="position:absolute;left:238.49px;top:294.91px" class="cls_024"><span class="cls_024">Ruby stores much of</span></div>
<div style="position:absolute;left:234.43px;top:312.92px" class="cls_024"><span class="cls_024">its own internal data</span></div>
<div style="position:absolute;left:252.85px;top:330.92px" class="cls_024"><span class="cls_024">in hash tables.</span></div>
</div>
<div style="position:absolute;left:50%;margin-left:-252px;top:126412px;width:504px;height:666px;border-style:outset;overflow:hidden">
<div style="position:absolute;left:0px;top:0px">
<img src="e698b76e-46bd-11eb-8b25-0cc47a792c0a_id_e698b76e-46bd-11eb-8b25-0cc47a792c0a_files/background191.jpg" width=504 height=666></div>
<div style="position:absolute;left:260.10px;top:101.45px" class="cls_035"><span class="cls_035">7</span></div>
<div style="position:absolute;left:204.65px;top:253.45px" class="cls_016"><span class="cls_016">The Hash Table:</span></div>
<div style="position:absolute;left:189.85px;top:271.45px" class="cls_016"><span class="cls_016">The Workhorse of</span></div>
<div style="position:absolute;left:205.61px;top:289.45px" class="cls_016"><span class="cls_016">Ruby Internals</span></div>
<div style="position:absolute;left:123.00px;top:387.45px" class="cls_023"><span class="cls_023">Experiment 5-1 showed us how in Ruby 1.9 and 2.0</span></div>
<div style="position:absolute;left:123.00px;top:405.45px" class="cls_023"><span class="cls_023">the </span><span class="cls_028">ivptr</span><span class="cls_023"> member of the </span><span class="cls_028">RObject</span><span class="cls_023"> structure pointed to a</span></div>
<div style="position:absolute;left:123.00px;top:423.46px" class="cls_023"><span class="cls_023">simple array of instance variable values. We learned</span></div>
<div style="position:absolute;left:123.00px;top:441.46px" class="cls_023"><span class="cls_023">that adding a new value was usually very fast but that</span></div>
<div style="position:absolute;left:123.00px;top:459.46px" class="cls_023"><span class="cls_023">Ruby was somewhat slower while saving every third or</span></div>
<div style="position:absolute;left:123.00px;top:477.47px" class="cls_023"><span class="cls_023">fourth instance variable because it had to allocate a</span></div>
<div style="position:absolute;left:123.00px;top:495.47px" class="cls_023"><span class="cls_023">larger array.</span></div>
<div style="position:absolute;left:141.00px;top:514.45px" class="cls_007"><span class="cls_007">Taking a broader look across Ruby’s C source code base, we find that</span></div>
<div style="position:absolute;left:123.00px;top:526.45px" class="cls_007"><span class="cls_007">this technique is unusual. Instead, Ruby often uses a data structure called</span></div>
<div style="position:absolute;left:123.00px;top:538.45px" class="cls_007"><span class="cls_007">a </span><span class="cls_008">hash table</span><span class="cls_007">. Unlike the simple array we saw in Experiment 5-1, hash tables</span></div>
</div>
<div style="position:absolute;left:50%;margin-left:-252px;top:127088px;width:504px;height:666px;border-style:outset;overflow:hidden">
<div style="position:absolute;left:0px;top:0px">
<img src="e698b76e-46bd-11eb-8b25-0cc47a792c0a_id_e698b76e-46bd-11eb-8b25-0cc47a792c0a_files/background192.jpg" width=504 height=666></div>
<div style="position:absolute;left:120.00px;top:41.60px" class="cls_007"><span class="cls_007">can automatically expand to accommodate more values; the client of a hash</span></div>
<div style="position:absolute;left:120.00px;top:53.60px" class="cls_007"><span class="cls_007">table doesn’t need to worry about how much space is available or about allo-</span></div>
<div style="position:absolute;left:120.00px;top:65.60px" class="cls_007"><span class="cls_007">cating more memory for it.</span></div>
<div style="position:absolute;left:138.00px;top:77.60px" class="cls_007"><span class="cls_007">Among other things, Ruby uses a hash table to hold the data you save in</span></div>
<div style="position:absolute;left:120.00px;top:89.60px" class="cls_007"><span class="cls_007">the hash objects you create in your Ruby script. Ruby also saves much of its</span></div>
<div style="position:absolute;left:120.00px;top:101.60px" class="cls_007"><span class="cls_007">internal data in hash tables. Every time you create a method or a constant,</span></div>
<div style="position:absolute;left:120.00px;top:113.60px" class="cls_007"><span class="cls_007">Ruby inserts a new value in a hash table, and Ruby saves many of the special</span></div>
<div style="position:absolute;left:120.00px;top:125.60px" class="cls_007"><span class="cls_007">variables we saw in Experiment 3-2 in hash tables. Additionally, Ruby saves</span></div>
<div style="position:absolute;left:120.00px;top:137.60px" class="cls_007"><span class="cls_007">instance variables for generic objects, such as integers or symbols, in hash</span></div>
<div style="position:absolute;left:120.00px;top:149.60px" class="cls_007"><span class="cls_007">tables. Thus, the hash table is the workhorse of Ruby internals.</span></div>
<div style="position:absolute;left:138.00px;top:161.60px" class="cls_007"><span class="cls_007">In this chapter I’ll begin by explaining how hash tables work: what</span></div>
<div style="position:absolute;left:120.00px;top:173.60px" class="cls_007"><span class="cls_007">happens inside the table when you save a new value with a key and what</span></div>
<div style="position:absolute;left:120.00px;top:185.60px" class="cls_007"><span class="cls_007">happens when you later retrieve that value using the same key. I’ll also</span></div>
<div style="position:absolute;left:120.00px;top:197.60px" class="cls_007"><span class="cls_007">explain how hash tables automatically expand to accommodate more val-</span></div>
<div style="position:absolute;left:120.00px;top:209.60px" class="cls_007"><span class="cls_007">ues. Finally, we’ll look at how hash functions work in Ruby.</span></div>
<div style="position:absolute;left:261.47px;top:253.31px" class="cls_020"><span class="cls_020">Roadmap</span></div>
<div style="position:absolute;left:132.00px;top:270.31px" class="cls_017"><span class="cls_017">Hash Tables in Ruby</span></div>
<div style="position:absolute;left:415.36px;top:270.31px" class="cls_017"><span class="cls_017">169</span></div>
<div style="position:absolute;left:150.00px;top:287.32px" class="cls_017"><span class="cls_017">Saving a Value in a Hash Table</span></div>
<div style="position:absolute;left:415.36px;top:287.32px" class="cls_017"><span class="cls_017">169</span></div>
<div style="position:absolute;left:150.00px;top:304.32px" class="cls_017"><span class="cls_017">Retrieving a Value from a Hash Table</span></div>
<div style="position:absolute;left:415.36px;top:304.32px" class="cls_017"><span class="cls_017">171</span></div>
<div style="position:absolute;left:132.00px;top:321.32px" class="cls_019"><span class="cls_019">Experiment 7-1: Retrieving a Value from Hashes of Varying Sizes</span></div>
<div style="position:absolute;left:416.39px;top:321.32px" class="cls_019"><span class="cls_019">172</span></div>
<div style="position:absolute;left:132.00px;top:338.32px" class="cls_017"><span class="cls_017">How Hash Tables Expand to Accommodate More Values</span></div>
<div style="position:absolute;left:415.36px;top:338.32px" class="cls_017"><span class="cls_017">174</span></div>
<div style="position:absolute;left:150.00px;top:355.32px" class="cls_017"><span class="cls_017">Hash Collisions</span></div>
<div style="position:absolute;left:415.36px;top:355.32px" class="cls_017"><span class="cls_017">174</span></div>
<div style="position:absolute;left:150.00px;top:372.32px" class="cls_017"><span class="cls_017">Rehashing Entries</span></div>
<div style="position:absolute;left:415.36px;top:372.32px" class="cls_017"><span class="cls_017">175</span></div>
<div style="position:absolute;left:150.00px;top:389.32px" class="cls_017"><span class="cls_017">How Does Ruby Rehash Entries in a Hash Table?</span></div>
<div style="position:absolute;left:415.36px;top:389.32px" class="cls_017"><span class="cls_017">176</span></div>
<div style="position:absolute;left:132.00px;top:406.32px" class="cls_019"><span class="cls_019">Experiment 7-2: Inserting One New Element into Hashes of</span></div>
<div style="position:absolute;left:150.00px;top:417.32px" class="cls_019"><span class="cls_019">Varying Sizes</span></div>
<div style="position:absolute;left:416.39px;top:417.32px" class="cls_019"><span class="cls_019">177</span></div>
<div style="position:absolute;left:150.00px;top:434.32px" class="cls_017"><span class="cls_017">Where Do the Magic Numbers 67 and 57 Come From?</span></div>
<div style="position:absolute;left:415.36px;top:434.32px" class="cls_017"><span class="cls_017">180</span></div>
<div style="position:absolute;left:132.00px;top:451.32px" class="cls_017"><span class="cls_017">How Ruby Implements Hash Functions</span></div>
<div style="position:absolute;left:415.36px;top:451.32px" class="cls_017"><span class="cls_017">181</span></div>
<div style="position:absolute;left:132.00px;top:468.32px" class="cls_019"><span class="cls_019">Experiment 7-3: Using Objects as Keys in a Hash</span></div>
<div style="position:absolute;left:416.39px;top:468.32px" class="cls_019"><span class="cls_019">183</span></div>
<div style="position:absolute;left:150.00px;top:485.32px" class="cls_017"><span class="cls_017">Hash Optimization in Ruby 2.x</span></div>
<div style="position:absolute;left:415.36px;top:485.32px" class="cls_017"><span class="cls_017">187</span></div>
<div style="position:absolute;left:132.00px;top:502.33px" class="cls_017"><span class="cls_017">Summary</span></div>
<div style="position:absolute;left:415.36px;top:502.33px" class="cls_017"><span class="cls_017">189</span></div>
<div style="position:absolute;left:48.00px;top:633.00px" class="cls_020"><span class="cls_020">168</span></div>
<div style="position:absolute;left:74.22px;top:636.00px" class="cls_021"><span class="cls_021">Chapter 7</span></div>
</div>
<div style="position:absolute;left:50%;margin-left:-252px;top:127764px;width:504px;height:666px;border-style:outset;overflow:hidden">
<div style="position:absolute;left:0px;top:0px">
<img src="e698b76e-46bd-11eb-8b25-0cc47a792c0a_id_e698b76e-46bd-11eb-8b25-0cc47a792c0a_files/background193.jpg" width=504 height=666></div>
<div style="position:absolute;left:69.00px;top:42.63px" class="cls_031"><span class="cls_031">Hash Tables in Ruby</span></div>
<div style="position:absolute;left:123.00px;top:62.63px" class="cls_008"><span class="cls_008">Hash tables</span><span class="cls_007"> are a commonly used, well-</span></div>
<div style="position:absolute;left:123.00px;top:74.63px" class="cls_007"><span class="cls_007">known, age-old concept in computer</span></div>
<div style="position:absolute;left:123.00px;top:86.63px" class="cls_007"><span class="cls_007">science. They organize values into</span></div>
<div style="position:absolute;left:123.00px;top:98.63px" class="cls_007"><span class="cls_007">groups, or </span><span class="cls_008">bins</span><span class="cls_007">, based on an integer</span></div>
<div style="position:absolute;left:123.00px;top:110.63px" class="cls_007"><span class="cls_007">value calculated from each value—a</span></div>
<div style="position:absolute;left:123.00px;top:122.63px" class="cls_008"><span class="cls_008">hash</span><span class="cls_007">. When you need to find a value,</span></div>
<div style="position:absolute;left:123.00px;top:134.63px" class="cls_007"><span class="cls_007">you can figure out which bin it’s in by</span></div>
<div style="position:absolute;left:123.00px;top:146.63px" class="cls_007"><span class="cls_007">recalculating its hash value, thus speed-</span></div>
<div style="position:absolute;left:321.00px;top:157.15px" class="cls_038"><span class="cls_038">Every time you write a method, Ruby</span></div>
<div style="position:absolute;left:123.00px;top:158.63px" class="cls_007"><span class="cls_007">ing up the search.</span></div>
<div style="position:absolute;left:321.00px;top:167.65px" class="cls_038"><span class="cls_038">creates an entry in a hash table.</span></div>
<div style="position:absolute;left:123.00px;top:183.63px" class="cls_055"><span class="cls_055">Saving a Value in a Hash Table</span></div>
<div style="position:absolute;left:123.00px;top:201.63px" class="cls_007"><span class="cls_007">Figure 7-1 shows a single hash object and its hash table.</span></div>
<div style="position:absolute;left:240.18px;top:227.61px" class="cls_042"><span class="cls_042">st_table</span></div>
<div style="position:absolute;left:260.16px;top:245.77px" class="cls_014"><span class="cls_014">type</span></div>
<div style="position:absolute;left:129.65px;top:260.43px" class="cls_042"><span class="cls_042">RHash</span></div>
<div style="position:absolute;left:252.16px;top:267.10px" class="cls_014"><span class="cls_014">num_bins</span></div>
<div style="position:absolute;left:150.96px;top:274.83px" class="cls_133"><span class="cls_133">tbl</span></div>
<div style="position:absolute;left:246.16px;top:288.41px" class="cls_014"><span class="cls_014">num_entries</span></div>
<div style="position:absolute;left:260.16px;top:309.08px" class="cls_014"><span class="cls_014">bins</span></div>
<div style="position:absolute;left:266.79px;top:358.69px" class="cls_014"><span class="cls_014">0</span></div>
<div style="position:absolute;left:283.17px;top:358.69px" class="cls_014"><span class="cls_014">1</span></div>
<div style="position:absolute;left:300.18px;top:358.69px" class="cls_014"><span class="cls_014">2</span></div>
<div style="position:absolute;left:317.20px;top:358.69px" class="cls_014"><span class="cls_014">3</span></div>
<div style="position:absolute;left:334.21px;top:358.69px" class="cls_014"><span class="cls_014">4</span></div>
<div style="position:absolute;left:351.22px;top:358.69px" class="cls_014"><span class="cls_014">5</span></div>
<div style="position:absolute;left:368.23px;top:358.69px" class="cls_014"><span class="cls_014">6</span></div>
<div style="position:absolute;left:385.25px;top:358.69px" class="cls_014"><span class="cls_014">7</span></div>
<div style="position:absolute;left:402.26px;top:358.69px" class="cls_014"><span class="cls_014">8</span></div>
<div style="position:absolute;left:419.27px;top:358.69px" class="cls_014"><span class="cls_014">9</span></div>
<div style="position:absolute;left:434.28px;top:358.69px" class="cls_014"><span class="cls_014">10</span></div>
<div style="position:absolute;left:123.00px;top:380.86px" class="cls_038"><span class="cls_038">Figure 7-1: A Ruby hash object with an empty hash table</span></div>
<div style="position:absolute;left:141.00px;top:403.36px" class="cls_007"><span class="cls_007">On the left is the </span><span class="cls_030">RHash</span><span class="cls_007"> (short for </span><span class="cls_008">Ruby hash</span><span class="cls_007">) structure. On the right,</span></div>
<div style="position:absolute;left:123.00px;top:415.36px" class="cls_007"><span class="cls_007">you see the hash table used by this hash, represented by the </span><span class="cls_030">st_table</span><span class="cls_007"> struc-</span></div>
<div style="position:absolute;left:123.00px;top:427.36px" class="cls_007"><span class="cls_007">ture. This C structure contains the basic information about the hash table,</span></div>
<div style="position:absolute;left:123.00px;top:439.36px" class="cls_007"><span class="cls_007">including the number of entries saved in the table, the number of bins,</span></div>
<div style="position:absolute;left:123.00px;top:451.36px" class="cls_007"><span class="cls_007">and a pointer to the bins. Each </span><span class="cls_030">RHash</span><span class="cls_007"> structure contains a pointer to a cor-</span></div>
<div style="position:absolute;left:123.00px;top:463.36px" class="cls_007"><span class="cls_007">responding </span><span class="cls_030">st_table</span><span class="cls_007"> structure. The empty bins on the lower right are there</span></div>
<div style="position:absolute;left:123.00px;top:475.36px" class="cls_007"><span class="cls_007">because Ruby 1.8 and 1.9 initially create 11 bins for a new, empty hash.</span></div>
<div style="position:absolute;left:123.00px;top:487.36px" class="cls_007"><span class="cls_007">(Ruby 2.0 and later work somewhat differently; see “Hash Optimization in</span></div>
<div style="position:absolute;left:123.00px;top:499.36px" class="cls_007"><span class="cls_007">Ruby 2.x” on page 187.)</span></div>
<div style="position:absolute;left:141.00px;top:511.36px" class="cls_007"><span class="cls_007">The best way to understand how a hash table works is by stepping</span></div>
<div style="position:absolute;left:123.00px;top:523.36px" class="cls_007"><span class="cls_007">through an example. Suppose I add a new key/value to a hash called </span><span class="cls_030">my_hash</span><span class="cls_007">:</span></div>
<div style="position:absolute;left:123.00px;top:547.36px" class="cls_030"><span class="cls_030">my_hash[:key] = "value"</span></div>
<div style="position:absolute;left:141.00px;top:569.86px" class="cls_007"><span class="cls_007">While executing this line of code, Ruby creates a new structure called</span></div>
<div style="position:absolute;left:123.00px;top:581.86px" class="cls_007"><span class="cls_007">an </span><span class="cls_030">st_table_entry</span><span class="cls_007"> that it will save into the hash table for </span><span class="cls_030">my_hash</span><span class="cls_007">, as shown in</span></div>
<div style="position:absolute;left:123.00px;top:593.86px" class="cls_007"><span class="cls_007">Figure 7-2.</span></div>
<div style="position:absolute;left:298.56px;top:636.00px" class="cls_021"><span class="cls_021">The Hash Table: The Workhorse of Ruby Internals</span></div>
<div style="position:absolute;left:442.91px;top:633.00px" class="cls_020"><span class="cls_020">169</span></div>
</div>
<div style="position:absolute;left:50%;margin-left:-252px;top:128440px;width:504px;height:666px;border-style:outset;overflow:hidden">
<div style="position:absolute;left:0px;top:0px">
<img src="e698b76e-46bd-11eb-8b25-0cc47a792c0a_id_e698b76e-46bd-11eb-8b25-0cc47a792c0a_files/background194.jpg" width=504 height=666></div>
<div style="position:absolute;left:237.51px;top:49.58px" class="cls_042"><span class="cls_042">st_table</span></div>
<div style="position:absolute;left:257.16px;top:66.74px" class="cls_014"><span class="cls_014">type</span></div>
<div style="position:absolute;left:125.65px;top:80.40px" class="cls_042"><span class="cls_042">RHash</span></div>
<div style="position:absolute;left:249.16px;top:88.07px" class="cls_014"><span class="cls_014">num_bins</span></div>
<div style="position:absolute;left:146.81px;top:95.37px" class="cls_014"><span class="cls_014">tbl</span></div>
<div style="position:absolute;left:243.16px;top:109.39px" class="cls_014"><span class="cls_014">num_entries</span></div>
<div style="position:absolute;left:257.16px;top:130.06px" class="cls_014"><span class="cls_014">bins</span></div>
<div style="position:absolute;left:262.93px;top:178.03px" class="cls_014"><span class="cls_014">0</span></div>
<div style="position:absolute;left:279.31px;top:178.03px" class="cls_014"><span class="cls_014">1</span></div>
<div style="position:absolute;left:296.33px;top:178.03px" class="cls_014"><span class="cls_014">2</span></div>
<div style="position:absolute;left:313.34px;top:178.03px" class="cls_014"><span class="cls_014">3</span></div>
<div style="position:absolute;left:330.35px;top:178.03px" class="cls_014"><span class="cls_014">4</span></div>
<div style="position:absolute;left:347.36px;top:178.03px" class="cls_014"><span class="cls_014">5</span></div>
<div style="position:absolute;left:364.38px;top:178.03px" class="cls_014"><span class="cls_014">6</span></div>
<div style="position:absolute;left:381.39px;top:178.03px" class="cls_014"><span class="cls_014">7</span></div>
<div style="position:absolute;left:398.40px;top:178.03px" class="cls_014"><span class="cls_014">8</span></div>
<div style="position:absolute;left:415.41px;top:178.03px" class="cls_014"><span class="cls_014">9</span></div>
<div style="position:absolute;left:430.42px;top:178.03px" class="cls_014"><span class="cls_014">10</span></div>
<div style="position:absolute;left:263.38px;top:214.59px" class="cls_042"><span class="cls_042">st_table_entry</span></div>
<div style="position:absolute;left:268.29px;top:229.50px" class="cls_014"><span class="cls_014">:key => "value"</span></div>
<div style="position:absolute;left:120.00px;top:261.70px" class="cls_038"><span class="cls_038">Figure 7-2: A Ruby hash object containing a single value</span></div>
<div style="position:absolute;left:138.00px;top:284.20px" class="cls_007"><span class="cls_007">Here you can see Ruby saved the new key/value pair under the third</span></div>
<div style="position:absolute;left:120.00px;top:296.20px" class="cls_007"><span class="cls_007">bucket, number 2. Ruby did this by taking the given key—in this example,</span></div>
<div style="position:absolute;left:120.00px;top:308.20px" class="cls_007"><span class="cls_007">the symbol </span><span class="cls_030">:key</span><span class="cls_007">—and passing it to an internal hash function that returns a</span></div>
<div style="position:absolute;left:120.00px;top:320.20px" class="cls_007"><span class="cls_007">pseudorandom integer:</span></div>
<div style="position:absolute;left:120.00px;top:344.20px" class="cls_030"><span class="cls_030">some_value = internal_hash_function(:key)</span></div>
<div style="position:absolute;left:138.00px;top:366.70px" class="cls_007"><span class="cls_007">Next, Ruby takes the hash value—in this example, </span><span class="cls_030">some_value</span><span class="cls_007">—and</span></div>
<div style="position:absolute;left:120.00px;top:378.70px" class="cls_007"><span class="cls_007">calculates the modulus by the number of bins, which is the remainder after</span></div>
<div style="position:absolute;left:120.00px;top:390.70px" class="cls_007"><span class="cls_007">dividing by the number of bins.</span></div>
<div style="position:absolute;left:120.00px;top:416.20px" class="cls_030"><span class="cls_030">some_value % 11 = 2</span></div>
<div style="position:absolute;left:78.00px;top:441.20px" class="cls_032"><span class="cls_032">NOTE</span></div>
<div style="position:absolute;left:120.00px;top:438.70px" class="cls_008"><span class="cls_008">In Figure 7-2, I assume that the actual hash value for </span><span class="cls_030">:key</span><span class="cls_008"> divided by 11 leaves a</span></div>
<div style="position:absolute;left:120.00px;top:450.70px" class="cls_008"><span class="cls_008">remainder of 2. Later in this chapter, I’ll explore in more detail the hash functions</span></div>
<div style="position:absolute;left:120.00px;top:462.70px" class="cls_008"><span class="cls_008">that Ruby actually uses.</span></div>
<div style="position:absolute;left:138.00px;top:486.70px" class="cls_007"><span class="cls_007">Now let’s add a second element to the hash:</span></div>
<div style="position:absolute;left:120.00px;top:510.70px" class="cls_030"><span class="cls_030">my_hash[:key2] = "value2"</span></div>
<div style="position:absolute;left:138.00px;top:533.20px" class="cls_007"><span class="cls_007">This time let’s imagine that the hash value of </span><span class="cls_030">:key2</span><span class="cls_007"> divided by 11 yields</span></div>
<div style="position:absolute;left:120.00px;top:545.20px" class="cls_007"><span class="cls_007">a remainder of 5.</span></div>
<div style="position:absolute;left:120.00px;top:569.20px" class="cls_030"><span class="cls_030">internal_hash_function(:key2) % 11 = 5</span></div>
<div style="position:absolute;left:138.00px;top:591.70px" class="cls_007"><span class="cls_007">Figure 7-3 shows that Ruby places a second </span><span class="cls_030">st_table_entry</span><span class="cls_007"> structure</span></div>
<div style="position:absolute;left:120.00px;top:603.70px" class="cls_007"><span class="cls_007">under bin number 5, the sixth bin.</span></div>
<div style="position:absolute;left:48.00px;top:633.00px" class="cls_020"><span class="cls_020">170</span></div>
<div style="position:absolute;left:73.89px;top:636.00px" class="cls_021"><span class="cls_021">Chapter 7</span></div>
</div>
<div style="position:absolute;left:50%;margin-left:-252px;top:129116px;width:504px;height:666px;border-style:outset;overflow:hidden">
<div style="position:absolute;left:0px;top:0px">
<img src="e698b76e-46bd-11eb-8b25-0cc47a792c0a_id_e698b76e-46bd-11eb-8b25-0cc47a792c0a_files/background195.jpg" width=504 height=666></div>
<div style="position:absolute;left:240.18px;top:48.58px" class="cls_042"><span class="cls_042">st_table</span></div>
<div style="position:absolute;left:259.97px;top:66.74px" class="cls_014"><span class="cls_014">type</span></div>
<div style="position:absolute;left:128.65px;top:81.40px" class="cls_042"><span class="cls_042">RHash</span></div>
<div style="position:absolute;left:251.97px;top:88.07px" class="cls_014"><span class="cls_014">num_bins</span></div>
<div style="position:absolute;left:150.63px;top:96.36px" class="cls_014"><span class="cls_014">tbl</span></div>
<div style="position:absolute;left:245.97px;top:109.38px" class="cls_014"><span class="cls_014">num_entries</span></div>
<div style="position:absolute;left:259.97px;top:130.05px" class="cls_014"><span class="cls_014">bins</span></div>
<div style="position:absolute;left:264.93px;top:185.84px" class="cls_014"><span class="cls_014">0</span></div>
<div style="position:absolute;left:281.31px;top:185.84px" class="cls_014"><span class="cls_014">1</span></div>
<div style="position:absolute;left:298.33px;top:185.84px" class="cls_014"><span class="cls_014">2</span></div>
<div style="position:absolute;left:315.34px;top:185.84px" class="cls_014"><span class="cls_014">3</span></div>
<div style="position:absolute;left:332.35px;top:185.84px" class="cls_014"><span class="cls_014">4</span></div>
<div style="position:absolute;left:349.36px;top:185.84px" class="cls_014"><span class="cls_014">5</span></div>
<div style="position:absolute;left:366.38px;top:185.84px" class="cls_014"><span class="cls_014">6</span></div>
<div style="position:absolute;left:383.39px;top:185.84px" class="cls_014"><span class="cls_014">7</span></div>
<div style="position:absolute;left:400.40px;top:185.84px" class="cls_014"><span class="cls_014">8</span></div>
<div style="position:absolute;left:417.41px;top:185.84px" class="cls_014"><span class="cls_014">9</span></div>
<div style="position:absolute;left:432.42px;top:185.84px" class="cls_014"><span class="cls_014">10</span></div>
<div style="position:absolute;left:265.38px;top:221.59px" class="cls_042"><span class="cls_042">st_table_entry</span></div>
<div style="position:absolute;left:270.29px;top:236.50px" class="cls_014"><span class="cls_014">:key => "value"</span></div>
<div style="position:absolute;left:313.30px;top:285.36px" class="cls_042"><span class="cls_042">st_table_entry</span></div>
<div style="position:absolute;left:317.36px;top:300.27px" class="cls_014"><span class="cls_014">:key2 => "value2"</span></div>
<div style="position:absolute;left:123.00px;top:332.47px" class="cls_038"><span class="cls_038">Figure 7-3: A Ruby hash object containing two values</span></div>
<div style="position:absolute;left:123.00px;top:367.97px" class="cls_055"><span class="cls_055">Retrieving a Value from a Hash Table</span></div>
<div style="position:absolute;left:123.00px;top:385.97px" class="cls_007"><span class="cls_007">The benefit of using a hash table becomes clear when you ask Ruby to</span></div>
<div style="position:absolute;left:123.00px;top:397.97px" class="cls_007"><span class="cls_007">retrieve the value for a given key. For example:</span></div>
<div style="position:absolute;left:123.00px;top:421.97px" class="cls_030"><span class="cls_030">p my_hash[:key]</span></div>
<div style="position:absolute;left:127.25px;top:432.47px" class="cls_030"><span class="cls_030">=> "value"</span></div>
<div style="position:absolute;left:141.00px;top:454.97px" class="cls_007"><span class="cls_007">If Ruby had saved all of the keys and values in an array or linked list, it</span></div>
<div style="position:absolute;left:123.00px;top:466.97px" class="cls_007"><span class="cls_007">would have to iterate over all the elements in that array or list, looking for</span></div>
<div style="position:absolute;left:123.00px;top:478.97px" class="cls_030"><span class="cls_030">:key</span><span class="cls_007">. This might take a very long time, depending on the number of elements.</span></div>
<div style="position:absolute;left:123.00px;top:490.97px" class="cls_007"><span class="cls_007">But using a hash table, Ruby can jump straight to the key it needs to find by</span></div>
<div style="position:absolute;left:123.00px;top:502.97px" class="cls_007"><span class="cls_007">recalculating the hash value for that key.</span></div>
<div style="position:absolute;left:141.00px;top:514.97px" class="cls_007"><span class="cls_007">To recalculate the hash value for a particular key, Ruby simply calls the</span></div>
<div style="position:absolute;left:123.00px;top:526.97px" class="cls_007"><span class="cls_007">hash function again:</span></div>
<div style="position:absolute;left:123.00px;top:550.97px" class="cls_030"><span class="cls_030">some_value = internal_hash_function(:key)</span></div>
<div style="position:absolute;left:141.00px;top:573.47px" class="cls_007"><span class="cls_007">Then, it redivides the hash value by the number of bins to get the</span></div>
<div style="position:absolute;left:123.00px;top:585.47px" class="cls_007"><span class="cls_007">remainder, or the modulus.</span></div>
<div style="position:absolute;left:123.00px;top:609.47px" class="cls_030"><span class="cls_030">some_value % 11 = 2</span></div>
<div style="position:absolute;left:298.74px;top:636.00px" class="cls_021"><span class="cls_021">The Hash Table: The Workhorse of Ruby Internals</span></div>
<div style="position:absolute;left:443.10px;top:633.00px" class="cls_020"><span class="cls_020">171</span></div>
</div>
<div style="position:absolute;left:50%;margin-left:-252px;top:129792px;width:504px;height:666px;border-style:outset;overflow:hidden">
<div style="position:absolute;left:0px;top:0px">
<img src="e698b76e-46bd-11eb-8b25-0cc47a792c0a_id_e698b76e-46bd-11eb-8b25-0cc47a792c0a_files/background196.jpg" width=504 height=666></div>
<div style="position:absolute;left:138.00px;top:42.28px" class="cls_007"><span class="cls_007">At this point, Ruby knows to look in bin number 2 for the entry with</span></div>
<div style="position:absolute;left:120.00px;top:54.28px" class="cls_007"><span class="cls_007">the key of </span><span class="cls_030">:key</span><span class="cls_007">. Ruby can later find the value for </span><span class="cls_030">:key2</span><span class="cls_007"> by repeating the same</span></div>
<div style="position:absolute;left:120.00px;top:66.28px" class="cls_007"><span class="cls_007">hash calculation.</span></div>
<div style="position:absolute;left:120.00px;top:90.28px" class="cls_030"><span class="cls_030">internal_hash_function(:key2) % 11 = 5</span></div>
<div style="position:absolute;left:78.00px;top:127.28px" class="cls_032"><span class="cls_032">NOTE</span></div>
<div style="position:absolute;left:120.00px;top:124.78px" class="cls_008"><span class="cls_008">The C library used by Ruby to implement hash tables was written in the 1980s by</span></div>
<div style="position:absolute;left:120.00px;top:136.78px" class="cls_008"><span class="cls_008">Peter Moore from the University of California, Berkeley. Later, it was modified by</span></div>
<div style="position:absolute;left:120.00px;top:148.78px" class="cls_008"><span class="cls_008">the Ruby core team. You can find Moore’s hash table code in the C code files </span><span class="cls_007">st.c</span><span class="cls_008"> and</span></div>
<div style="position:absolute;left:120.00px;top:160.78px" class="cls_007"><span class="cls_007">include/ruby/st.h</span><span class="cls_008">. All of the function and structure names in that code use the</span></div>
<div style="position:absolute;left:120.00px;top:172.78px" class="cls_008"><span class="cls_008">naming convention </span><span class="cls_030">st_</span><span class="cls_008">. The definition of the </span><span class="cls_030">RHash</span><span class="cls_008"> structure that represents every</span></div>
<div style="position:absolute;left:120.00px;top:184.78px" class="cls_008"><span class="cls_008">Ruby Hash object is in the </span><span class="cls_007">include/ruby/ruby.h</span><span class="cls_008"> file. Along with </span><span class="cls_030">RHash</span><span class="cls_008">, this file con-</span></div>
<div style="position:absolute;left:120.00px;top:196.78px" class="cls_008"><span class="cls_008">tains all of the other primary object structures used in the Ruby source code: </span><span class="cls_030">RString</span><span class="cls_008">,</span></div>
<div style="position:absolute;left:120.00px;top:208.78px" class="cls_030"><span class="cls_030">RArray</span><span class="cls_008">, and so on.</span></div>
<div style="position:absolute;left:120.00px;top:254.78px" class="cls_031"><span class="cls_031">Experiment 7-1: Retrieving a Value from Hashes of</span></div>
<div style="position:absolute;left:120.00px;top:269.78px" class="cls_031"><span class="cls_031">Varying Sizes</span></div>
<div style="position:absolute;left:120.00px;top:289.78px" class="cls_007"><span class="cls_007">This experiment will create hashes of wildly different sizes, from 1 to</span></div>
<div style="position:absolute;left:120.00px;top:301.78px" class="cls_007"><span class="cls_007">1 million elements, and then measure how long it takes to find and return</span></div>
<div style="position:absolute;left:120.00px;top:313.78px" class="cls_007"><span class="cls_007">a value from each of these hashes. Listing 7-1 shows the experiment code.</span></div>
<div style="position:absolute;left:120.00px;top:337.78px" class="cls_030"><span class="cls_030">require 'benchmark'</span></div>
<div style="position:absolute;left:108.15px;top:358.78px" class="cls_046"><span class="cls_046">u</span><span class="cls_030"> 21.times do |exponent|</span></div>
<div style="position:absolute;left:128.50px;top:379.79px" class="cls_030"><span class="cls_030">target_key = nil</span></div>
<div style="position:absolute;left:108.15px;top:400.79px" class="cls_046"><span class="cls_046">v</span><span class="cls_030">   size = 2**exponent</span></div>
<div style="position:absolute;left:128.50px;top:411.29px" class="cls_030"><span class="cls_030">hash = {}</span></div>
<div style="position:absolute;left:108.15px;top:421.79px" class="cls_046"><span class="cls_046">w</span></div>
<div style="position:absolute;left:128.48px;top:421.79px" class="cls_030"><span class="cls_030">(1..size).each do |n|</span></div>
<div style="position:absolute;left:137.00px;top:432.28px" class="cls_030"><span class="cls_030">index = rand</span></div>
<div style="position:absolute;left:108.15px;top:442.78px" class="cls_046"><span class="cls_046">x</span><span class="cls_030">     target_key = index if n > size/2 && target_key.nil?</span></div>
<div style="position:absolute;left:108.15px;top:453.28px" class="cls_046"><span class="cls_046">y</span><span class="cls_030">     hash[index] = rand</span></div>
<div style="position:absolute;left:128.50px;top:463.78px" class="cls_030"><span class="cls_030">end</span></div>
<div style="position:absolute;left:128.50px;top:484.78px" class="cls_030"><span class="cls_030">GC.disable</span></div>
<div style="position:absolute;left:128.50px;top:505.78px" class="cls_030"><span class="cls_030">Benchmark.bm do |bench|</span></div>
<div style="position:absolute;left:137.00px;top:516.28px" class="cls_030"><span class="cls_030">bench.report("retrieving an element</span></div>
<div style="position:absolute;left:196.50px;top:526.78px" class="cls_030"><span class="cls_030">from a hash with #{size} elements 10000 times") do</span></div>
<div style="position:absolute;left:145.50px;top:537.28px" class="cls_030"><span class="cls_030">10000.times do</span></div>
<div style="position:absolute;left:108.15px;top:547.77px" class="cls_046"><span class="cls_046">z</span></div>
<div style="position:absolute;left:153.98px;top:547.77px" class="cls_030"><span class="cls_030">val = hash[target_key]</span></div>
<div style="position:absolute;left:145.50px;top:558.27px" class="cls_030"><span class="cls_030">end</span></div>
<div style="position:absolute;left:137.00px;top:568.77px" class="cls_030"><span class="cls_030">end</span></div>
<div style="position:absolute;left:128.50px;top:579.27px" class="cls_030"><span class="cls_030">end</span></div>
<div style="position:absolute;left:48.00px;top:633.00px" class="cls_020"><span class="cls_020">172</span></div>
<div style="position:absolute;left:73.97px;top:636.00px" class="cls_021"><span class="cls_021">Chapter 7</span></div>
</div>
<div style="position:absolute;left:50%;margin-left:-252px;top:130468px;width:504px;height:666px;border-style:outset;overflow:hidden">
<div style="position:absolute;left:0px;top:0px">
<img src="e698b76e-46bd-11eb-8b25-0cc47a792c0a_id_e698b76e-46bd-11eb-8b25-0cc47a792c0a_files/background197.jpg" width=504 height=666></div>
<div style="position:absolute;left:131.50px;top:42.82px" class="cls_030"><span class="cls_030">GC.enable</span></div>
<div style="position:absolute;left:123.00px;top:53.31px" class="cls_030"><span class="cls_030">end</span></div>
<div style="position:absolute;left:123.00px;top:75.81px" class="cls_038"><span class="cls_038">Listing 7-1: Measuring how long it takes to retrieve an element from hashes of wildly</span></div>
<div style="position:absolute;left:123.00px;top:86.31px" class="cls_038"><span class="cls_038">different sizes</span></div>
<div style="position:absolute;left:141.00px;top:108.82px" class="cls_007"><span class="cls_007">At </span><span class="cls_050">u</span><span class="cls_007"> the outer loop iterates over powers of two, calculating different</span></div>
<div style="position:absolute;left:123.00px;top:120.82px" class="cls_007"><span class="cls_007">values for </span><span class="cls_030">size</span><span class="cls_007"> at </span><span class="cls_050">v</span><span class="cls_007">. These sizes will vary from 1 to about 1 million. Next,</span></div>
<div style="position:absolute;left:123.00px;top:132.82px" class="cls_007"><span class="cls_007">the inner loop at </span><span class="cls_050">w</span><span class="cls_007"> inserts that number of elements into a new empty</span></div>
<div style="position:absolute;left:123.00px;top:144.82px" class="cls_007"><span class="cls_007">hash at </span><span class="cls_050"></span><span class="cls_007">.</span></div>
<div style="position:absolute;left:141.00px;top:156.82px" class="cls_007"><span class="cls_007">After disabling garbage collection to avoid skewing the results,</span></div>
<div style="position:absolute;left:123.00px;top:168.82px" class="cls_007"><span class="cls_007">Experiment 7-1 uses the benchmark library to measure how long it takes</span></div>
<div style="position:absolute;left:123.00px;top:180.82px" class="cls_007"><span class="cls_007">to retrieve a value 10,000 times from each hash at </span><span class="cls_050">z</span><span class="cls_007">. The line of code at </span><span class="cls_050">x</span></div>
<div style="position:absolute;left:123.00px;top:192.82px" class="cls_007"><span class="cls_007">saves one of the random key values to use below at </span><span class="cls_050">z</span><span class="cls_007"> as </span><span class="cls_030">target_key</span><span class="cls_007">.</span></div>
<div style="position:absolute;left:141.00px;top:204.82px" class="cls_007"><span class="cls_007">The results in Figure 7-4 show that Ruby can find and return a value</span></div>
<div style="position:absolute;left:123.00px;top:216.82px" class="cls_007"><span class="cls_007">from a hash containing over 1 million elements just as fast as it can return</span></div>
<div style="position:absolute;left:123.00px;top:228.82px" class="cls_007"><span class="cls_007">one from a small hash.</span></div>
<div style="position:absolute;left:139.43px;top:250.62px" class="cls_134"><span class="cls_134">1.4</span></div>
<div style="position:absolute;left:139.43px;top:284.37px" class="cls_134"><span class="cls_134">1.2</span></div>
<div style="position:absolute;left:144.59px;top:317.82px" class="cls_134"><span class="cls_134">1</span></div>
<div style="position:absolute;left:139.43px;top:351.59px" class="cls_134"><span class="cls_134">0.8</span></div>
<div style="position:absolute;left:139.43px;top:385.04px" class="cls_134"><span class="cls_134">0.6</span></div>
<div style="position:absolute;left:139.43px;top:418.80px" class="cls_134"><span class="cls_134">0.4</span></div>
<div style="position:absolute;left:139.43px;top:452.25px" class="cls_134"><span class="cls_134">0.2</span></div>
<div style="position:absolute;left:144.59px;top:485.70px" class="cls_134"><span class="cls_134">0</span></div>
<div style="position:absolute;left:196.15px;top:492.75px" class="cls_134"><span class="cls_134">10</span></div>
<div style="position:absolute;left:243.17px;top:492.75px" class="cls_134"><span class="cls_134">100</span></div>
<div style="position:absolute;left:290.06px;top:492.75px" class="cls_134"><span class="cls_134">1,000</span></div>
<div style="position:absolute;left:337.69px;top:492.75px" class="cls_134"><span class="cls_134">10,000</span></div>
<div style="position:absolute;left:385.20px;top:492.75px" class="cls_134"><span class="cls_134">100,000</span></div>
<div style="position:absolute;left:435.07px;top:492.75px" class="cls_134"><span class="cls_134">1 million</span></div>
<div style="position:absolute;left:282.71px;top:507.57px" class="cls_135"><span class="cls_135">Hash Size</span></div>
<div style="position:absolute;left:123.00px;top:524.35px" class="cls_038"><span class="cls_038">Figure 7-4: Time to retrieve 10,000 values (ms) vs. hash size for Ruby 2.0</span></div>
<div style="position:absolute;left:141.00px;top:546.85px" class="cls_007"><span class="cls_007">Clearly Ruby’s hash function is very fast, and once Ruby identifies the</span></div>
<div style="position:absolute;left:123.00px;top:558.85px" class="cls_007"><span class="cls_007">bin containing the target key, it can very quickly find the corresponding value</span></div>
<div style="position:absolute;left:123.00px;top:570.85px" class="cls_007"><span class="cls_007">and return it. What’s remarkable here is that the chart is more or less flat.</span></div>
<div style="position:absolute;left:298.70px;top:636.00px" class="cls_021"><span class="cls_021">The Hash Table: The Workhorse of Ruby Internals</span></div>
<div style="position:absolute;left:443.05px;top:633.00px" class="cls_020"><span class="cls_020">173</span></div>
</div>
<div style="position:absolute;left:50%;margin-left:-252px;top:131144px;width:504px;height:666px;border-style:outset;overflow:hidden">
<div style="position:absolute;left:0px;top:0px">
<img src="e698b76e-46bd-11eb-8b25-0cc47a792c0a_id_e698b76e-46bd-11eb-8b25-0cc47a792c0a_files/background198.jpg" width=504 height=666></div>
<div style="position:absolute;left:66.00px;top:42.63px" class="cls_031"><span class="cls_031">How Hash Tables Expand to Accommodate More Values</span></div>
<div style="position:absolute;left:120.00px;top:62.63px" class="cls_007"><span class="cls_007">If there are millions of </span><span class="cls_030">st_table_entry</span><span class="cls_007"> structures, why does distributing</span></div>
<div style="position:absolute;left:120.00px;top:74.63px" class="cls_007"><span class="cls_007">them among 11 bins help Ruby search quickly? Because even if the hash</span></div>
<div style="position:absolute;left:120.00px;top:86.63px" class="cls_007"><span class="cls_007">function is fast, and even if Ruby distributes the values evenly among the</span></div>
<div style="position:absolute;left:120.00px;top:98.63px" class="cls_007"><span class="cls_007">11 bins in the hash table, Ruby still has to search among almost 100,000</span></div>
<div style="position:absolute;left:120.00px;top:110.63px" class="cls_007"><span class="cls_007">elements in each bin to find the target key if there are 1 million elements</span></div>
<div style="position:absolute;left:120.00px;top:122.63px" class="cls_007"><span class="cls_007">overall.</span></div>
<div style="position:absolute;left:138.00px;top:134.63px" class="cls_007"><span class="cls_007">Something else must be going on here. It seems that Ruby must add</span></div>
<div style="position:absolute;left:120.00px;top:146.63px" class="cls_007"><span class="cls_007">more bins to the hash table as more and more elements are added. Let’s</span></div>
<div style="position:absolute;left:120.00px;top:158.63px" class="cls_007"><span class="cls_007">look again at how Ruby’s internal hash table code works. Continuing with</span></div>
<div style="position:absolute;left:120.00px;top:170.63px" class="cls_007"><span class="cls_007">the example from Figures 7-1 through 7-3, suppose I keep adding more and</span></div>
<div style="position:absolute;left:120.00px;top:182.63px" class="cls_007"><span class="cls_007">more elements to my hash.</span></div>
<div style="position:absolute;left:120.00px;top:206.63px" class="cls_030"><span class="cls_030">my_hash[:key3] = "value3"</span></div>
<div style="position:absolute;left:120.00px;top:217.12px" class="cls_030"><span class="cls_030">my_hash[:key4] = "value4"</span></div>
<div style="position:absolute;left:120.00px;top:227.62px" class="cls_030"><span class="cls_030">my_hash[:key5] = "value5"</span></div>
<div style="position:absolute;left:120.00px;top:238.12px" class="cls_030"><span class="cls_030">my_hash[:key6] = "value6"</span></div>
<div style="position:absolute;left:138.00px;top:260.63px" class="cls_007"><span class="cls_007">As we add more elements, Ruby continues to create more </span><span class="cls_030">st_table_entry</span></div>
<div style="position:absolute;left:120.00px;top:272.63px" class="cls_007"><span class="cls_007">structures and add them to different bins.</span></div>
<div style="position:absolute;left:120.00px;top:303.63px" class="cls_055"><span class="cls_055">Hash Collisions</span></div>
<div style="position:absolute;left:120.00px;top:321.63px" class="cls_007"><span class="cls_007">Eventually two or more elements might be saved into the same bin.</span></div>
<div style="position:absolute;left:120.00px;top:333.63px" class="cls_007"><span class="cls_007">When this happens, we have a </span><span class="cls_008">hash collision</span><span class="cls_007">. This means that Ruby is no</span></div>
<div style="position:absolute;left:120.00px;top:345.63px" class="cls_007"><span class="cls_007">longer able to uniquely identify and retrieve a key based solely on the</span></div>
<div style="position:absolute;left:120.00px;top:357.63px" class="cls_007"><span class="cls_007">hash function.</span></div>
<div style="position:absolute;left:138.00px;top:369.63px" class="cls_007"><span class="cls_007">Figure 7-5 shows the linked list Ruby uses to track the entries in each</span></div>
<div style="position:absolute;left:120.00px;top:381.63px" class="cls_007"><span class="cls_007">bin. Each </span><span class="cls_030">st_table_entry</span><span class="cls_007"> structure contains a pointer to the next entry in the</span></div>
<div style="position:absolute;left:120.00px;top:393.63px" class="cls_007"><span class="cls_007">same bin. As you add more entries to the hash, the linked lists get longer</span></div>
<div style="position:absolute;left:120.00px;top:405.63px" class="cls_007"><span class="cls_007">and longer.</span></div>
<div style="position:absolute;left:128.90px;top:432.28px" class="cls_067"><span class="cls_067">0</span></div>
<div style="position:absolute;left:149.54px;top:432.28px" class="cls_067"><span class="cls_067">1</span></div>
<div style="position:absolute;left:170.18px;top:432.28px" class="cls_067"><span class="cls_067">2</span></div>
<div style="position:absolute;left:190.81px;top:432.28px" class="cls_067"><span class="cls_067">3</span></div>
<div style="position:absolute;left:211.36px;top:432.28px" class="cls_067"><span class="cls_067">4</span></div>
<div style="position:absolute;left:232.00px;top:432.28px" class="cls_067"><span class="cls_067">5</span></div>
<div style="position:absolute;left:252.64px;top:432.28px" class="cls_067"><span class="cls_067">6</span></div>
<div style="position:absolute;left:273.27px;top:432.28px" class="cls_067"><span class="cls_067">7</span></div>
<div style="position:absolute;left:293.96px;top:432.28px" class="cls_067"><span class="cls_067">8</span></div>
<div style="position:absolute;left:315.25px;top:432.28px" class="cls_067"><span class="cls_067">9</span></div>
<div style="position:absolute;left:335.12px;top:432.28px" class="cls_067"><span class="cls_067">10</span></div>
<div style="position:absolute;left:124.65px;top:460.82px" class="cls_136"><span class="cls_136">entry</span></div>
<div style="position:absolute;left:145.29px;top:460.82px" class="cls_136"><span class="cls_136">entry</span></div>
<div style="position:absolute;left:165.93px;top:460.82px" class="cls_136"><span class="cls_136">entry</span></div>
<div style="position:absolute;left:186.56px;top:460.82px" class="cls_136"><span class="cls_136">entry</span></div>
<div style="position:absolute;left:207.11px;top:460.82px" class="cls_136"><span class="cls_136">entry</span></div>
<div style="position:absolute;left:227.75px;top:460.82px" class="cls_136"><span class="cls_136">entry</span></div>
<div style="position:absolute;left:248.39px;top:460.82px" class="cls_136"><span class="cls_136">entry</span></div>
<div style="position:absolute;left:269.02px;top:460.82px" class="cls_136"><span class="cls_136">entry</span></div>
<div style="position:absolute;left:289.71px;top:460.82px" class="cls_136"><span class="cls_136">entry</span></div>
<div style="position:absolute;left:311.00px;top:460.82px" class="cls_136"><span class="cls_136">entry</span></div>
<div style="position:absolute;left:332.87px;top:460.82px" class="cls_136"><span class="cls_136">entry</span></div>
<div style="position:absolute;left:124.65px;top:483.36px" class="cls_136"><span class="cls_136">entry</span></div>
<div style="position:absolute;left:145.29px;top:483.36px" class="cls_136"><span class="cls_136">entry</span></div>
<div style="position:absolute;left:165.93px;top:483.36px" class="cls_136"><span class="cls_136">entry</span></div>
<div style="position:absolute;left:186.56px;top:483.36px" class="cls_136"><span class="cls_136">entry</span></div>
<div style="position:absolute;left:207.11px;top:483.36px" class="cls_136"><span class="cls_136">entry</span></div>
<div style="position:absolute;left:227.75px;top:483.36px" class="cls_136"><span class="cls_136">entry</span></div>
<div style="position:absolute;left:248.39px;top:483.36px" class="cls_136"><span class="cls_136">entry</span></div>
<div style="position:absolute;left:269.02px;top:483.36px" class="cls_136"><span class="cls_136">entry</span></div>
<div style="position:absolute;left:289.71px;top:483.36px" class="cls_136"><span class="cls_136">entry</span></div>
<div style="position:absolute;left:311.00px;top:483.36px" class="cls_136"><span class="cls_136">entry</span></div>
<div style="position:absolute;left:332.87px;top:483.36px" class="cls_136"><span class="cls_136">entry</span></div>
<div style="position:absolute;left:124.65px;top:505.89px" class="cls_136"><span class="cls_136">entry</span></div>
<div style="position:absolute;left:145.29px;top:505.89px" class="cls_136"><span class="cls_136">entry    entry</span></div>
<div style="position:absolute;left:186.56px;top:505.89px" class="cls_136"><span class="cls_136">entry</span></div>
<div style="position:absolute;left:207.11px;top:505.89px" class="cls_136"><span class="cls_136">entry</span></div>
<div style="position:absolute;left:227.75px;top:505.89px" class="cls_136"><span class="cls_136">entry    entry</span></div>
<div style="position:absolute;left:269.02px;top:505.89px" class="cls_136"><span class="cls_136">entry</span></div>
<div style="position:absolute;left:289.71px;top:505.89px" class="cls_136"><span class="cls_136">entry</span></div>
<div style="position:absolute;left:311.00px;top:505.89px" class="cls_136"><span class="cls_136">entry</span></div>
<div style="position:absolute;left:332.87px;top:505.89px" class="cls_136"><span class="cls_136">entry</span></div>
<div style="position:absolute;left:124.65px;top:528.42px" class="cls_136"><span class="cls_136">entry</span></div>
<div style="position:absolute;left:165.93px;top:528.42px" class="cls_136"><span class="cls_136">entry    entry    entry</span></div>
<div style="position:absolute;left:248.39px;top:528.42px" class="cls_136"><span class="cls_136">entry    entry    entry</span></div>
<div style="position:absolute;left:332.87px;top:528.42px" class="cls_136"><span class="cls_136">entry</span></div>
<div style="position:absolute;left:124.65px;top:548.43px" class="cls_136"><span class="cls_136">entry</span></div>
<div style="position:absolute;left:207.11px;top:548.43px" class="cls_136"><span class="cls_136">entry</span></div>
<div style="position:absolute;left:289.71px;top:548.43px" class="cls_136"><span class="cls_136">entry</span></div>
<div style="position:absolute;left:120.00px;top:565.07px" class="cls_038"><span class="cls_038">Figure 7-5: A hash table containing 44 values</span></div>
<div style="position:absolute;left:48.00px;top:633.00px" class="cls_020"><span class="cls_020">174</span></div>
<div style="position:absolute;left:73.55px;top:636.00px" class="cls_021"><span class="cls_021">Chapter 7</span></div>
</div>
<div style="position:absolute;left:50%;margin-left:-252px;top:131820px;width:504px;height:666px;border-style:outset;overflow:hidden">
<div style="position:absolute;left:0px;top:0px">
<img src="e698b76e-46bd-11eb-8b25-0cc47a792c0a_id_e698b76e-46bd-11eb-8b25-0cc47a792c0a_files/background199.jpg" width=504 height=666></div>
<div style="position:absolute;left:141.00px;top:41.60px" class="cls_007"><span class="cls_007">To retrieve a value, Ruby needs to iterate over the linked list and com-</span></div>
<div style="position:absolute;left:123.00px;top:53.60px" class="cls_007"><span class="cls_007">pare each key with the target. This isn’t a serious problem as long as the</span></div>
<div style="position:absolute;left:123.00px;top:65.60px" class="cls_007"><span class="cls_007">number of entries in a single bin doesn’t grow too large. For integers or</span></div>
<div style="position:absolute;left:123.00px;top:77.60px" class="cls_007"><span class="cls_007">symbols, which are typically used as hash keys, this is a simple numerical</span></div>
<div style="position:absolute;left:123.00px;top:89.60px" class="cls_007"><span class="cls_007">comparison. However, if you use a more complex data type, such as a cus-</span></div>
<div style="position:absolute;left:123.00px;top:101.60px" class="cls_007"><span class="cls_007">tom object, Ruby calls the </span><span class="cls_030">eql?</span><span class="cls_007"> method on the keys to check whether each</span></div>
<div style="position:absolute;left:123.00px;top:113.60px" class="cls_007"><span class="cls_007">key in the list is the target. As you might guess, </span><span class="cls_030">eql?</span><span class="cls_007"> returns </span><span class="cls_008">true</span><span class="cls_007"> if two values</span></div>
<div style="position:absolute;left:123.00px;top:125.60px" class="cls_007"><span class="cls_007">are equal and </span><span class="cls_008">false</span><span class="cls_007"> if they are not.</span></div>
<div style="position:absolute;left:123.00px;top:156.60px" class="cls_055"><span class="cls_055">Rehashing Entries</span></div>
<div style="position:absolute;left:123.00px;top:174.60px" class="cls_007"><span class="cls_007">To keep these linked lists from growing out of control, Ruby measures the</span></div>
<div style="position:absolute;left:123.00px;top:186.60px" class="cls_008"><span class="cls_008">density</span><span class="cls_007">, or average number of entries per bin. In Figure 7-5 you can see that</span></div>
<div style="position:absolute;left:123.00px;top:198.60px" class="cls_007"><span class="cls_007">the average number of entries per bin is about 4. This means that the hash</span></div>
<div style="position:absolute;left:123.00px;top:210.60px" class="cls_007"><span class="cls_007">value modulus 11 has started to return repeated values for different keys</span></div>
<div style="position:absolute;left:123.00px;top:222.60px" class="cls_007"><span class="cls_007">and hash values; thus, there have been some hash collisions.</span></div>
<div style="position:absolute;left:141.00px;top:234.60px" class="cls_007"><span class="cls_007">Once the density exceeds 5, a constant value in Ruby’s C source code,</span></div>
<div style="position:absolute;left:123.00px;top:246.60px" class="cls_007"><span class="cls_007">Ruby allocates more bins and then </span><span class="cls_008">rehashes</span><span class="cls_007">, or redistributes, the existing</span></div>
<div style="position:absolute;left:123.00px;top:258.60px" class="cls_007"><span class="cls_007">entries across the new bin set. If we keep adding more key/value pairs, for</span></div>
<div style="position:absolute;left:123.00px;top:270.60px" class="cls_007"><span class="cls_007">example, Ruby eventually discards the array of 11 bins and allocates an</span></div>
<div style="position:absolute;left:123.00px;top:282.60px" class="cls_007"><span class="cls_007">array of 19 bins, as shown in Figure 7-6.</span></div>
<div style="position:absolute;left:59.82px;top:322.46px" class="cls_067"><span class="cls_067">0</span></div>
<div style="position:absolute;left:80.46px;top:322.46px" class="cls_067"><span class="cls_067">1</span></div>
<div style="position:absolute;left:101.09px;top:322.46px" class="cls_067"><span class="cls_067">2</span></div>
<div style="position:absolute;left:121.73px;top:322.46px" class="cls_067"><span class="cls_067">3</span></div>
<div style="position:absolute;left:142.36px;top:322.46px" class="cls_067"><span class="cls_067">4</span></div>
<div style="position:absolute;left:163.00px;top:322.46px" class="cls_067"><span class="cls_067">5</span></div>
<div style="position:absolute;left:183.46px;top:322.46px" class="cls_067"><span class="cls_067">6</span></div>
<div style="position:absolute;left:204.27px;top:322.46px" class="cls_067"><span class="cls_067">7</span></div>
<div style="position:absolute;left:224.91px;top:322.46px" class="cls_067"><span class="cls_067">8</span></div>
<div style="position:absolute;left:246.19px;top:322.46px" class="cls_067"><span class="cls_067">9</span></div>
<div style="position:absolute;left:266.12px;top:322.46px" class="cls_067"><span class="cls_067">10</span></div>
<div style="position:absolute;left:288.05px;top:322.46px" class="cls_067"><span class="cls_067">11</span></div>
<div style="position:absolute;left:309.97px;top:322.46px" class="cls_067"><span class="cls_067">12</span></div>
<div style="position:absolute;left:331.90px;top:322.46px" class="cls_067"><span class="cls_067">13</span></div>
<div style="position:absolute;left:353.83px;top:322.46px" class="cls_067"><span class="cls_067">14</span></div>
<div style="position:absolute;left:375.76px;top:322.46px" class="cls_067"><span class="cls_067">15</span></div>
<div style="position:absolute;left:397.68px;top:322.46px" class="cls_067"><span class="cls_067">16</span></div>
<div style="position:absolute;left:419.61px;top:322.46px" class="cls_067"><span class="cls_067">17</span></div>
<div style="position:absolute;left:441.54px;top:322.46px" class="cls_067"><span class="cls_067">18</span></div>
<div style="position:absolute;left:55.57px;top:350.12px" class="cls_136"><span class="cls_136">entry</span></div>
<div style="position:absolute;left:76.21px;top:350.12px" class="cls_136"><span class="cls_136">entry</span></div>
<div style="position:absolute;left:96.84px;top:350.12px" class="cls_136"><span class="cls_136">entry</span></div>
<div style="position:absolute;left:117.48px;top:350.12px" class="cls_136"><span class="cls_136">entry</span></div>
<div style="position:absolute;left:138.12px;top:350.12px" class="cls_136"><span class="cls_136">entry</span></div>
<div style="position:absolute;left:158.75px;top:350.12px" class="cls_136"><span class="cls_136">entry</span></div>
<div style="position:absolute;left:179.21px;top:350.12px" class="cls_136"><span class="cls_136">entry</span></div>
<div style="position:absolute;left:200.02px;top:350.12px" class="cls_136"><span class="cls_136">entry</span></div>
<div style="position:absolute;left:220.66px;top:350.12px" class="cls_136"><span class="cls_136">entry</span></div>
<div style="position:absolute;left:241.94px;top:350.12px" class="cls_136"><span class="cls_136">entry</span></div>
<div style="position:absolute;left:263.87px;top:350.12px" class="cls_136"><span class="cls_136">entry</span></div>
<div style="position:absolute;left:285.80px;top:350.12px" class="cls_136"><span class="cls_136">entry</span></div>
<div style="position:absolute;left:307.72px;top:350.12px" class="cls_136"><span class="cls_136">entry</span></div>
<div style="position:absolute;left:329.65px;top:350.12px" class="cls_136"><span class="cls_136">entry</span></div>
<div style="position:absolute;left:351.58px;top:350.12px" class="cls_136"><span class="cls_136">entry</span></div>
<div style="position:absolute;left:373.50px;top:350.12px" class="cls_136"><span class="cls_136">entry</span></div>
<div style="position:absolute;left:395.43px;top:350.12px" class="cls_136"><span class="cls_136">entry</span></div>
<div style="position:absolute;left:417.36px;top:350.12px" class="cls_136"><span class="cls_136">entry</span></div>
<div style="position:absolute;left:439.29px;top:350.12px" class="cls_136"><span class="cls_136">entry</span></div>
<div style="position:absolute;left:55.57px;top:372.66px" class="cls_136"><span class="cls_136">entry</span></div>
<div style="position:absolute;left:76.21px;top:372.66px" class="cls_136"><span class="cls_136">entry</span></div>
<div style="position:absolute;left:96.84px;top:372.66px" class="cls_136"><span class="cls_136">entry</span></div>
<div style="position:absolute;left:117.48px;top:372.66px" class="cls_136"><span class="cls_136">entry</span></div>
<div style="position:absolute;left:138.12px;top:372.66px" class="cls_136"><span class="cls_136">entry</span></div>
<div style="position:absolute;left:158.75px;top:372.66px" class="cls_136"><span class="cls_136">entry</span></div>
<div style="position:absolute;left:179.21px;top:372.66px" class="cls_136"><span class="cls_136">entry</span></div>
<div style="position:absolute;left:200.02px;top:372.66px" class="cls_136"><span class="cls_136">entry</span></div>
<div style="position:absolute;left:220.66px;top:372.66px" class="cls_136"><span class="cls_136">entry</span></div>
<div style="position:absolute;left:241.94px;top:372.66px" class="cls_136"><span class="cls_136">entry</span></div>
<div style="position:absolute;left:263.87px;top:372.66px" class="cls_136"><span class="cls_136">entry</span></div>
<div style="position:absolute;left:285.80px;top:372.66px" class="cls_136"><span class="cls_136">entry</span></div>
<div style="position:absolute;left:307.72px;top:372.66px" class="cls_136"><span class="cls_136">entry</span></div>
<div style="position:absolute;left:329.65px;top:372.66px" class="cls_136"><span class="cls_136">entry</span></div>
<div style="position:absolute;left:351.58px;top:372.66px" class="cls_136"><span class="cls_136">entry</span></div>
<div style="position:absolute;left:373.50px;top:372.66px" class="cls_136"><span class="cls_136">entry</span></div>
<div style="position:absolute;left:395.43px;top:372.66px" class="cls_136"><span class="cls_136">entry</span></div>
<div style="position:absolute;left:417.36px;top:372.66px" class="cls_136"><span class="cls_136">entry</span></div>
<div style="position:absolute;left:439.29px;top:372.66px" class="cls_136"><span class="cls_136">entry</span></div>
<div style="position:absolute;left:55.57px;top:395.19px" class="cls_136"><span class="cls_136">entry</span></div>
<div style="position:absolute;left:76.21px;top:395.19px" class="cls_136"><span class="cls_136">entry</span></div>
<div style="position:absolute;left:96.84px;top:395.19px" class="cls_136"><span class="cls_136">entry</span></div>
<div style="position:absolute;left:117.48px;top:395.19px" class="cls_136"><span class="cls_136">entry</span></div>
<div style="position:absolute;left:138.12px;top:395.19px" class="cls_136"><span class="cls_136">entry</span></div>
<div style="position:absolute;left:158.75px;top:395.19px" class="cls_136"><span class="cls_136">entry</span></div>
<div style="position:absolute;left:179.21px;top:395.19px" class="cls_136"><span class="cls_136">entry</span></div>
<div style="position:absolute;left:200.02px;top:395.19px" class="cls_136"><span class="cls_136">entry</span></div>
<div style="position:absolute;left:220.66px;top:395.19px" class="cls_136"><span class="cls_136">entry</span></div>
<div style="position:absolute;left:241.94px;top:395.19px" class="cls_136"><span class="cls_136">entry</span></div>
<div style="position:absolute;left:263.87px;top:395.19px" class="cls_136"><span class="cls_136">entry</span></div>
<div style="position:absolute;left:285.80px;top:395.19px" class="cls_136"><span class="cls_136">entry</span></div>
<div style="position:absolute;left:307.72px;top:395.19px" class="cls_136"><span class="cls_136">entry</span></div>
<div style="position:absolute;left:329.65px;top:395.19px" class="cls_136"><span class="cls_136">entry</span></div>
<div style="position:absolute;left:351.58px;top:395.19px" class="cls_136"><span class="cls_136">entry</span></div>
<div style="position:absolute;left:373.50px;top:395.19px" class="cls_136"><span class="cls_136">entry</span></div>
<div style="position:absolute;left:395.43px;top:395.19px" class="cls_136"><span class="cls_136">entry</span></div>
<div style="position:absolute;left:417.36px;top:395.19px" class="cls_136"><span class="cls_136">entry</span></div>
<div style="position:absolute;left:439.29px;top:395.19px" class="cls_136"><span class="cls_136">entry</span></div>
<div style="position:absolute;left:55.57px;top:417.73px" class="cls_136"><span class="cls_136">entry</span></div>
<div style="position:absolute;left:96.84px;top:417.73px" class="cls_136"><span class="cls_136">entry    entry    entry</span></div>
<div style="position:absolute;left:200.02px;top:417.73px" class="cls_136"><span class="cls_136">entry    entry</span></div>
<div style="position:absolute;left:263.87px;top:417.73px" class="cls_136"><span class="cls_136">entry</span></div>
<div style="position:absolute;left:329.65px;top:417.73px" class="cls_136"><span class="cls_136">entry</span></div>
<div style="position:absolute;left:51.00px;top:434.36px" class="cls_038"><span class="cls_038">Figure 7-6: A hash table containing 65 values</span></div>
<div style="position:absolute;left:141.00px;top:468.86px" class="cls_007"><span class="cls_007">In this figure the bin density has dropped to about 3.</span></div>
<div style="position:absolute;left:141.00px;top:480.86px" class="cls_007"><span class="cls_007">By monitoring bin density, Ruby guarantees that the linked lists remain</span></div>
<div style="position:absolute;left:123.00px;top:492.86px" class="cls_007"><span class="cls_007">short and that retrieving a hash element is always fast. After calculating the</span></div>
<div style="position:absolute;left:123.00px;top:504.86px" class="cls_007"><span class="cls_007">hash value, Ruby just needs to step through one or two elements to find the</span></div>
<div style="position:absolute;left:123.00px;top:516.86px" class="cls_007"><span class="cls_007">target key.</span></div>
<div style="position:absolute;left:298.82px;top:636.00px" class="cls_021"><span class="cls_021">The Hash Table: The Workhorse of Ruby Internals</span></div>
<div style="position:absolute;left:443.17px;top:633.00px" class="cls_020"><span class="cls_020">175</span></div>
</div>
<div style="position:absolute;left:50%;margin-left:-252px;top:132496px;width:504px;height:666px;border-style:outset;overflow:hidden">
<div style="position:absolute;left:0px;top:0px">
<img src="e698b76e-46bd-11eb-8b25-0cc47a792c0a_id_e698b76e-46bd-11eb-8b25-0cc47a792c0a_files/background200.jpg" width=504 height=666></div>
<div style="position:absolute;left:145.21px;top:61.31px" class="cls_020"><span class="cls_020">How Does Ruby Rehash Entries in a Hash Table?</span></div>
<div style="position:absolute;left:120.50px;top:79.81px" class="cls_039"><span class="cls_039">You can find the </span><span class="cls_009">rehash</span><span class="cls_039"> function (the code that loops through the </span><span class="cls_009">st_table_entry</span></div>
<div style="position:absolute;left:120.50px;top:91.81px" class="cls_039"><span class="cls_039">structures and recalculates which bin to put the entry into) in the </span><span class="cls_044">st.c</span><span class="cls_039"> source file. To</span></div>
<div style="position:absolute;left:120.50px;top:103.81px" class="cls_039"><span class="cls_039">keep things simple, Listing 7-2 shows the version of </span><span class="cls_009">rehash</span><span class="cls_039"> from Ruby 1.8.7. While</span></div>
<div style="position:absolute;left:120.50px;top:115.82px" class="cls_039"><span class="cls_039">Ruby 1.9 and 2.0 work largely the same way, their C rehash code is somewhat more</span></div>
<div style="position:absolute;left:120.51px;top:127.82px" class="cls_039"><span class="cls_039">complex.</span></div>
<div style="position:absolute;left:120.50px;top:150.31px" class="cls_009"><span class="cls_009">static void</span></div>
<div style="position:absolute;left:120.50px;top:159.82px" class="cls_009"><span class="cls_009">rehash(table)</span></div>
<div style="position:absolute;left:135.50px;top:169.32px" class="cls_009"><span class="cls_009">register st_table *table;</span></div>
<div style="position:absolute;left:120.50px;top:178.82px" class="cls_009"><span class="cls_009">{</span></div>
<div style="position:absolute;left:135.50px;top:188.32px" class="cls_009"><span class="cls_009">register st_table_entry *ptr, *next, **new_bins;</span></div>
<div style="position:absolute;left:135.50px;top:197.83px" class="cls_009"><span class="cls_009">int i, old_num_bins = table->num_bins, new_num_bins;</span></div>
<div style="position:absolute;left:135.50px;top:207.33px" class="cls_009"><span class="cls_009">unsigned int hash_val;</span></div>
<div style="position:absolute;left:110.00px;top:216.83px" class="cls_045"><span class="cls_045">u</span><span class="cls_009">     new_num_bins = new_size(old_num_bins+1);</span></div>
<div style="position:absolute;left:135.50px;top:226.33px" class="cls_009"><span class="cls_009">new_bins = (st_table_entry**)Calloc(new_num_bins,</span></div>
<div style="position:absolute;left:270.50px;top:235.84px" class="cls_009"><span class="cls_009">sizeof(st_table_entry*));</span></div>
<div style="position:absolute;left:110.00px;top:245.34px" class="cls_045"><span class="cls_045">v</span><span class="cls_009">     for(i = 0; i &lt; old_num_bins; i++) {</span></div>
<div style="position:absolute;left:150.50px;top:254.84px" class="cls_009"><span class="cls_009">ptr = table->bins[i];</span></div>
<div style="position:absolute;left:150.50px;top:264.34px" class="cls_009"><span class="cls_009">while (ptr != 0) {</span></div>
<div style="position:absolute;left:165.50px;top:273.85px" class="cls_009"><span class="cls_009">next = ptr->next;</span></div>
<div style="position:absolute;left:110.00px;top:283.35px" class="cls_045"><span class="cls_045">w</span></div>
<div style="position:absolute;left:165.44px;top:283.35px" class="cls_009"><span class="cls_009">hash_val = ptr->hash % new_num_bins;</span></div>
<div style="position:absolute;left:110.00px;top:292.85px" class="cls_045"><span class="cls_045">x</span></div>
<div style="position:absolute;left:165.44px;top:292.85px" class="cls_009"><span class="cls_009">ptr->next = new_bins[hash_val];</span></div>
<div style="position:absolute;left:165.50px;top:302.35px" class="cls_009"><span class="cls_009">new_bins[hash_val] = ptr;</span></div>
<div style="position:absolute;left:165.50px;top:311.86px" class="cls_009"><span class="cls_009">ptr = next;</span></div>
<div style="position:absolute;left:150.50px;top:321.36px" class="cls_009"><span class="cls_009">}</span></div>
<div style="position:absolute;left:135.50px;top:330.86px" class="cls_009"><span class="cls_009">}</span></div>
<div style="position:absolute;left:110.00px;top:340.36px" class="cls_045"><span class="cls_045">y</span><span class="cls_009">     free(table->bins);</span></div>
<div style="position:absolute;left:135.50px;top:349.87px" class="cls_009"><span class="cls_009">table->num_bins = new_num_bins;</span></div>
<div style="position:absolute;left:135.50px;top:359.37px" class="cls_009"><span class="cls_009">table->bins = new_bins;</span></div>
<div style="position:absolute;left:120.50px;top:368.87px" class="cls_009"><span class="cls_009">}</span></div>
<div style="position:absolute;left:120.50px;top:391.37px" class="cls_043"><span class="cls_043">Listing 7-2: The C code inside Ruby 1.8.7 that rehashes a hash table</span></div>
<div style="position:absolute;left:138.50px;top:414.31px" class="cls_039"><span class="cls_039">In this listing, the </span><span class="cls_009">new_size</span><span class="cls_039"> method call at </span><span class="cls_046">u</span><span class="cls_039"> returns the new bin count. Once</span></div>
<div style="position:absolute;left:120.50px;top:426.32px" class="cls_039"><span class="cls_039">Ruby has the new bin count, it allocates the new bins and then iterates over all the</span></div>
<div style="position:absolute;left:120.50px;top:438.31px" class="cls_039"><span class="cls_039">existing </span><span class="cls_009">st_table_entry</span><span class="cls_039"> structures (all the key/value pairs in the hash) beginning at </span><span class="cls_046">v</span><span class="cls_039">.</span></div>
<div style="position:absolute;left:120.50px;top:450.31px" class="cls_039"><span class="cls_039">For each </span><span class="cls_009">st_table_entry</span><span class="cls_039"> Ruby recalculates the bin position using the same modulus</span></div>
<div style="position:absolute;left:120.50px;top:462.31px" class="cls_039"><span class="cls_039">formula at </span><span class="cls_046">w</span><span class="cls_039">: </span><span class="cls_009">hash_val = ptr->hash % new_num_bins</span><span class="cls_039">. Then, Ruby saves each entry in</span></div>
<div style="position:absolute;left:120.50px;top:474.31px" class="cls_039"><span class="cls_039">the linked list for that new bin at </span><span class="cls_046">x</span><span class="cls_039">. Finally, Ruby updates the </span><span class="cls_009">st_table</span><span class="cls_039"> structure and</span></div>
<div style="position:absolute;left:120.50px;top:486.32px" class="cls_039"><span class="cls_039">frees the old bins at </span><span class="cls_046">y</span><span class="cls_039">.</span></div>
<div style="position:absolute;left:48.00px;top:633.00px" class="cls_020"><span class="cls_020">176</span></div>
<div style="position:absolute;left:73.62px;top:636.00px" class="cls_021"><span class="cls_021">Chapter 7</span></div>
</div>
<div style="position:absolute;left:50%;margin-left:-252px;top:133172px;width:504px;height:666px;border-style:outset;overflow:hidden">
<div style="position:absolute;left:0px;top:0px">
<img src="e698b76e-46bd-11eb-8b25-0cc47a792c0a_id_e698b76e-46bd-11eb-8b25-0cc47a792c0a_files/background201.jpg" width=504 height=666></div>
<div style="position:absolute;left:123.00px;top:42.63px" class="cls_031"><span class="cls_031">Experiment 7-2: Inserting One New Element into</span></div>
<div style="position:absolute;left:123.00px;top:57.63px" class="cls_031"><span class="cls_031">Hashes of Varying Sizes</span></div>
<div style="position:absolute;left:123.00px;top:77.63px" class="cls_007"><span class="cls_007">One way to test whether this rehashing, or redistribution, of entries really</span></div>
<div style="position:absolute;left:123.00px;top:89.63px" class="cls_007"><span class="cls_007">occurs is to measure the amount of time Ruby takes to save one new element</span></div>
<div style="position:absolute;left:123.00px;top:101.63px" class="cls_007"><span class="cls_007">into existing hashes of different sizes. As we add more elements to the same</span></div>
<div style="position:absolute;left:123.00px;top:113.63px" class="cls_007"><span class="cls_007">hash, we should eventually see evidence that Ruby is taking extra time to</span></div>
<div style="position:absolute;left:123.00px;top:125.63px" class="cls_007"><span class="cls_007">rehash the elements.</span></div>
<div style="position:absolute;left:141.00px;top:137.63px" class="cls_007"><span class="cls_007">The code for this experiment is shown in Listing 7-3.</span></div>
<div style="position:absolute;left:123.00px;top:161.63px" class="cls_030"><span class="cls_030">require 'benchmark'</span></div>
<div style="position:absolute;left:111.15px;top:182.63px" class="cls_046"><span class="cls_046">u</span><span class="cls_030"> 100.times do |size|</span></div>
<div style="position:absolute;left:131.50px;top:203.63px" class="cls_030"><span class="cls_030">hashes = []</span></div>
<div style="position:absolute;left:111.15px;top:214.13px" class="cls_046"><span class="cls_046">v</span></div>
<div style="position:absolute;left:131.48px;top:214.13px" class="cls_030"><span class="cls_030">10000.times do</span></div>
<div style="position:absolute;left:140.00px;top:224.63px" class="cls_030"><span class="cls_030">hash = {}</span></div>
<div style="position:absolute;left:140.00px;top:235.12px" class="cls_030"><span class="cls_030">(1..size).each do</span></div>
<div style="position:absolute;left:148.50px;top:245.62px" class="cls_030"><span class="cls_030">hash[rand] = rand</span></div>
<div style="position:absolute;left:140.00px;top:256.12px" class="cls_030"><span class="cls_030">end</span></div>
<div style="position:absolute;left:140.00px;top:266.62px" class="cls_030"><span class="cls_030">hashes &lt;&lt; hash</span></div>
<div style="position:absolute;left:131.50px;top:277.11px" class="cls_030"><span class="cls_030">end</span></div>
<div style="position:absolute;left:131.50px;top:298.12px" class="cls_030"><span class="cls_030">GC.disable</span></div>
<div style="position:absolute;left:131.50px;top:319.12px" class="cls_030"><span class="cls_030">Benchmark.bm do |bench|</span></div>
<div style="position:absolute;left:140.00px;top:329.62px" class="cls_030"><span class="cls_030">bench.report("adding element number #{size+1}") do</span></div>
<div style="position:absolute;left:148.50px;top:340.12px" class="cls_030"><span class="cls_030">10000.times do |n|</span></div>
<div style="position:absolute;left:111.15px;top:350.61px" class="cls_046"><span class="cls_046">w</span></div>
<div style="position:absolute;left:156.98px;top:350.61px" class="cls_030"><span class="cls_030">hashes[n][size] = rand</span></div>
<div style="position:absolute;left:148.50px;top:361.11px" class="cls_030"><span class="cls_030">end</span></div>
<div style="position:absolute;left:140.00px;top:371.61px" class="cls_030"><span class="cls_030">end</span></div>
<div style="position:absolute;left:131.50px;top:382.11px" class="cls_030"><span class="cls_030">end</span></div>
<div style="position:absolute;left:131.50px;top:403.11px" class="cls_030"><span class="cls_030">GC.enable</span></div>
<div style="position:absolute;left:123.00px;top:413.61px" class="cls_030"><span class="cls_030">end</span></div>
<div style="position:absolute;left:123.00px;top:436.11px" class="cls_038"><span class="cls_038">Listing 7-3: Adding one more element to hashes of different sizes</span></div>
<div style="position:absolute;left:141.00px;top:458.63px" class="cls_007"><span class="cls_007">At </span><span class="cls_050">u</span><span class="cls_007"> the outer loop iterates over hash sizes from 0 to 100, and at </span><span class="cls_050">v</span><span class="cls_007"> the</span></div>
<div style="position:absolute;left:123.00px;top:470.63px" class="cls_007"><span class="cls_007">inner loop creates 10,000 hashes of the given size. After disabling garbage</span></div>
<div style="position:absolute;left:123.00px;top:482.63px" class="cls_007"><span class="cls_007">collection, this experiment uses the benchmark library to measure how</span></div>
<div style="position:absolute;left:123.00px;top:494.63px" class="cls_007"><span class="cls_007">long it takes Ruby to insert a single new value at </span><span class="cls_050">w</span><span class="cls_007"> into all 10,000 hashes of</span></div>
<div style="position:absolute;left:123.00px;top:506.63px" class="cls_007"><span class="cls_007">the given size.</span></div>
<div style="position:absolute;left:141.00px;top:518.63px" class="cls_007"><span class="cls_007">The results are surprising! Figure 7-7 shows the results for Ruby 1.8.</span></div>
<div style="position:absolute;left:298.59px;top:636.00px" class="cls_021"><span class="cls_021">The Hash Table: The Workhorse of Ruby Internals</span></div>
<div style="position:absolute;left:442.94px;top:633.00px" class="cls_020"><span class="cls_020">177</span></div>
</div>
<div style="position:absolute;left:50%;margin-left:-252px;top:133848px;width:504px;height:666px;border-style:outset;overflow:hidden">
<div style="position:absolute;left:0px;top:0px">
<img src="e698b76e-46bd-11eb-8b25-0cc47a792c0a_id_e698b76e-46bd-11eb-8b25-0cc47a792c0a_files/background202.jpg" width=504 height=666></div>
<div style="position:absolute;left:132.49px;top:44.29px" class="cls_081"><span class="cls_081">30</span></div>
<div style="position:absolute;left:132.49px;top:52.03px" class="cls_081"><span class="cls_081">29</span></div>
<div style="position:absolute;left:132.49px;top:59.80px" class="cls_081"><span class="cls_081">28</span></div>
<div style="position:absolute;left:132.49px;top:67.27px" class="cls_081"><span class="cls_081">27</span></div>
<div style="position:absolute;left:132.49px;top:75.05px" class="cls_081"><span class="cls_081">26</span></div>
<div style="position:absolute;left:132.49px;top:82.82px" class="cls_081"><span class="cls_081">25</span></div>
<div style="position:absolute;left:132.49px;top:90.29px" class="cls_081"><span class="cls_081">24</span></div>
<div style="position:absolute;left:132.49px;top:98.06px" class="cls_081"><span class="cls_081">23</span></div>
<div style="position:absolute;left:132.49px;top:105.84px" class="cls_081"><span class="cls_081">22</span></div>
<div style="position:absolute;left:132.49px;top:113.30px" class="cls_081"><span class="cls_081">21</span></div>
<div style="position:absolute;left:132.49px;top:121.08px" class="cls_081"><span class="cls_081">20</span></div>
<div style="position:absolute;left:132.49px;top:128.86px" class="cls_081"><span class="cls_081">19</span></div>
<div style="position:absolute;left:132.49px;top:136.32px" class="cls_081"><span class="cls_081">18</span></div>
<div style="position:absolute;left:132.49px;top:144.10px" class="cls_081"><span class="cls_081">17</span></div>
<div style="position:absolute;left:132.49px;top:151.87px" class="cls_081"><span class="cls_081">16</span></div>
<div style="position:absolute;left:132.49px;top:159.34px" class="cls_081"><span class="cls_081">15</span></div>
<div style="position:absolute;left:132.49px;top:167.11px" class="cls_081"><span class="cls_081">14</span></div>
<div style="position:absolute;left:132.49px;top:174.89px" class="cls_081"><span class="cls_081">13</span></div>
<div style="position:absolute;left:132.49px;top:182.35px" class="cls_081"><span class="cls_081">12</span></div>
<div style="position:absolute;left:132.49px;top:190.13px" class="cls_081"><span class="cls_081">11</span></div>
<div style="position:absolute;left:132.49px;top:197.91px" class="cls_081"><span class="cls_081">10</span></div>
<div style="position:absolute;left:136.04px;top:205.37px" class="cls_081"><span class="cls_081">9</span></div>
<div style="position:absolute;left:136.04px;top:213.15px" class="cls_081"><span class="cls_081">8</span></div>
<div style="position:absolute;left:136.04px;top:220.92px" class="cls_081"><span class="cls_081">7</span></div>
<div style="position:absolute;left:136.04px;top:228.39px" class="cls_081"><span class="cls_081">6</span></div>
<div style="position:absolute;left:136.04px;top:236.16px" class="cls_081"><span class="cls_081">5</span></div>
<div style="position:absolute;left:136.04px;top:243.93px" class="cls_081"><span class="cls_081">4</span></div>
<div style="position:absolute;left:136.04px;top:251.40px" class="cls_081"><span class="cls_081">3</span></div>
<div style="position:absolute;left:136.04px;top:259.17px" class="cls_081"><span class="cls_081">2</span></div>
<div style="position:absolute;left:136.04px;top:266.95px" class="cls_081"><span class="cls_081">1</span></div>
<div style="position:absolute;left:136.04px;top:274.41px" class="cls_081"><span class="cls_081">0</span></div>
<div style="position:absolute;left:140.87px;top:279.10px" class="cls_081"><span class="cls_081">0</span></div>
<div style="position:absolute;left:168.33px;top:279.10px" class="cls_081"><span class="cls_081">10</span></div>
<div style="position:absolute;left:199.11px;top:279.10px" class="cls_081"><span class="cls_081">20</span></div>
<div style="position:absolute;left:230.22px;top:279.10px" class="cls_081"><span class="cls_081">30</span></div>
<div style="position:absolute;left:260.80px;top:279.10px" class="cls_081"><span class="cls_081">40</span></div>
<div style="position:absolute;left:291.39px;top:279.10px" class="cls_081"><span class="cls_081">50</span></div>
<div style="position:absolute;left:321.97px;top:279.10px" class="cls_081"><span class="cls_081">60</span></div>
<div style="position:absolute;left:352.55px;top:279.10px" class="cls_081"><span class="cls_081">70</span></div>
<div style="position:absolute;left:383.13px;top:279.10px" class="cls_081"><span class="cls_081">80</span></div>
<div style="position:absolute;left:413.72px;top:279.10px" class="cls_081"><span class="cls_081">90</span></div>
<div style="position:absolute;left:442.53px;top:279.10px" class="cls_081"><span class="cls_081">100</span></div>
<div style="position:absolute;left:278.25px;top:288.46px" class="cls_082"><span class="cls_082">Hash Size</span></div>
<div style="position:absolute;left:120.00px;top:305.15px" class="cls_038"><span class="cls_038">Figure 7-7: Time to add 10,000 key/value pairs vs. hash size (Ruby 1.8)</span></div>
<div style="position:absolute;left:138.00px;top:333.65px" class="cls_007"><span class="cls_007">Interpreting these data values from left to right, we see the following:</span></div>
<div style="position:absolute;left:120.00px;top:354.65px" class="cls_050"><span class="cls_050">•</span><span class="cls_007">   It takes about 7 ms to insert the first element into an empty hash</span></div>
<div style="position:absolute;left:138.00px;top:366.65px" class="cls_007"><span class="cls_007">(10,000 times).</span></div>
<div style="position:absolute;left:120.00px;top:381.65px" class="cls_050"><span class="cls_050">•</span><span class="cls_007">   As the hash size increases from 2 to 3 and then up to about 60 or 65,</span></div>
<div style="position:absolute;left:138.00px;top:393.65px" class="cls_007"><span class="cls_007">the amount of time required to insert a new element slowly increases.</span></div>
<div style="position:absolute;left:120.00px;top:408.65px" class="cls_050"><span class="cls_050">•</span><span class="cls_007">   It takes around 11 to 12 ms to insert each new key/value pair into a</span></div>
<div style="position:absolute;left:138.00px;top:420.65px" class="cls_007"><span class="cls_007">hash that contains 64, 65, or 66 elements (10,000 times).</span></div>
<div style="position:absolute;left:120.00px;top:435.65px" class="cls_050"><span class="cls_050">•</span><span class="cls_007">   A huge spike! Inserting the 67th key/value pair takes over twice as</span></div>
<div style="position:absolute;left:138.00px;top:447.65px" class="cls_007"><span class="cls_007">much time: about 26 ms instead of 11 ms for 10,000 hashes!</span></div>
<div style="position:absolute;left:120.00px;top:462.65px" class="cls_050"><span class="cls_050">•</span><span class="cls_007">   After inserting the 67th element, the time required to insert additional</span></div>
<div style="position:absolute;left:138.00px;top:474.65px" class="cls_007"><span class="cls_007">elements drops to about 10 ms or 11 ms and then slowly increases again</span></div>
<div style="position:absolute;left:138.00px;top:486.65px" class="cls_007"><span class="cls_007">from there.</span></div>
<div style="position:absolute;left:48.00px;top:633.00px" class="cls_020"><span class="cls_020">178</span></div>
<div style="position:absolute;left:73.93px;top:636.00px" class="cls_021"><span class="cls_021">Chapter 7</span></div>
</div>
<div style="position:absolute;left:50%;margin-left:-252px;top:134524px;width:504px;height:666px;border-style:outset;overflow:hidden">
<div style="position:absolute;left:0px;top:0px">
<img src="e698b76e-46bd-11eb-8b25-0cc47a792c0a_id_e698b76e-46bd-11eb-8b25-0cc47a792c0a_files/background203.jpg" width=504 height=666></div>
<div style="position:absolute;left:141.00px;top:42.28px" class="cls_007"><span class="cls_007">What’s going on here? Well, Ruby spends the extra time required</span></div>
<div style="position:absolute;left:123.00px;top:54.28px" class="cls_007"><span class="cls_007">to insert that 67th key/value pair reallocating the bin array from 11 to</span></div>
<div style="position:absolute;left:123.00px;top:66.28px" class="cls_007"><span class="cls_007">19 bins and then reassigning the </span><span class="cls_030">st_table_entry</span><span class="cls_007"> structures to the new</span></div>
<div style="position:absolute;left:123.00px;top:78.28px" class="cls_007"><span class="cls_007">bin array.</span></div>
<div style="position:absolute;left:141.00px;top:90.28px" class="cls_007"><span class="cls_007">Figure 7-8 shows the same graph for Ruby 2.0. This time the bin density</span></div>
<div style="position:absolute;left:123.00px;top:102.28px" class="cls_007"><span class="cls_007">threshold is different. Instead of taking extra time to reallocate the elements</span></div>
<div style="position:absolute;left:123.00px;top:114.28px" class="cls_007"><span class="cls_007">into bins on the 67th insert, Ruby 2.0 does it when the 57th element is</span></div>
<div style="position:absolute;left:123.00px;top:126.28px" class="cls_007"><span class="cls_007">inserted. Later Ruby 2.0 performs another reallocation after the 97th ele-</span></div>
<div style="position:absolute;left:123.00px;top:138.28px" class="cls_007"><span class="cls_007">ment is inserted.</span></div>
<div style="position:absolute;left:135.16px;top:165.97px" class="cls_081"><span class="cls_081">30</span></div>
<div style="position:absolute;left:135.16px;top:173.71px" class="cls_081"><span class="cls_081">29</span></div>
<div style="position:absolute;left:135.16px;top:181.48px" class="cls_081"><span class="cls_081">28</span></div>
<div style="position:absolute;left:135.16px;top:188.95px" class="cls_081"><span class="cls_081">27</span></div>
<div style="position:absolute;left:135.16px;top:196.73px" class="cls_081"><span class="cls_081">26</span></div>
<div style="position:absolute;left:135.16px;top:204.50px" class="cls_081"><span class="cls_081">25</span></div>
<div style="position:absolute;left:135.16px;top:211.97px" class="cls_081"><span class="cls_081">24</span></div>
<div style="position:absolute;left:135.16px;top:219.74px" class="cls_081"><span class="cls_081">23</span></div>
<div style="position:absolute;left:135.16px;top:227.52px" class="cls_081"><span class="cls_081">22</span></div>
<div style="position:absolute;left:135.16px;top:234.98px" class="cls_081"><span class="cls_081">21</span></div>
<div style="position:absolute;left:135.16px;top:242.76px" class="cls_081"><span class="cls_081">20</span></div>
<div style="position:absolute;left:135.16px;top:250.54px" class="cls_081"><span class="cls_081">19</span></div>
<div style="position:absolute;left:135.16px;top:258.00px" class="cls_081"><span class="cls_081">18</span></div>
<div style="position:absolute;left:135.16px;top:265.78px" class="cls_081"><span class="cls_081">17</span></div>
<div style="position:absolute;left:135.16px;top:273.55px" class="cls_081"><span class="cls_081">16</span></div>
<div style="position:absolute;left:135.16px;top:281.02px" class="cls_081"><span class="cls_081">15</span></div>
<div style="position:absolute;left:135.16px;top:288.79px" class="cls_081"><span class="cls_081">14</span></div>
<div style="position:absolute;left:135.16px;top:296.57px" class="cls_081"><span class="cls_081">13</span></div>
<div style="position:absolute;left:135.16px;top:304.03px" class="cls_081"><span class="cls_081">12</span></div>
<div style="position:absolute;left:135.16px;top:311.81px" class="cls_081"><span class="cls_081">11</span></div>
<div style="position:absolute;left:135.16px;top:319.59px" class="cls_081"><span class="cls_081">10</span></div>
<div style="position:absolute;left:138.71px;top:327.05px" class="cls_081"><span class="cls_081">9</span></div>
<div style="position:absolute;left:138.71px;top:334.83px" class="cls_081"><span class="cls_081">8</span></div>
<div style="position:absolute;left:138.71px;top:342.60px" class="cls_081"><span class="cls_081">7</span></div>
<div style="position:absolute;left:138.71px;top:350.07px" class="cls_081"><span class="cls_081">6</span></div>
<div style="position:absolute;left:138.71px;top:357.84px" class="cls_081"><span class="cls_081">5</span></div>
<div style="position:absolute;left:138.71px;top:365.61px" class="cls_081"><span class="cls_081">4</span></div>
<div style="position:absolute;left:138.71px;top:373.08px" class="cls_081"><span class="cls_081">3</span></div>
<div style="position:absolute;left:138.71px;top:380.85px" class="cls_081"><span class="cls_081">2</span></div>
<div style="position:absolute;left:138.71px;top:388.63px" class="cls_081"><span class="cls_081">1</span></div>
<div style="position:absolute;left:138.71px;top:396.09px" class="cls_081"><span class="cls_081">0</span></div>
<div style="position:absolute;left:143.55px;top:401.81px" class="cls_081"><span class="cls_081">0</span></div>
<div style="position:absolute;left:171.96px;top:401.81px" class="cls_081"><span class="cls_081">10</span></div>
<div style="position:absolute;left:202.63px;top:401.81px" class="cls_081"><span class="cls_081">20</span></div>
<div style="position:absolute;left:233.21px;top:401.81px" class="cls_081"><span class="cls_081">30</span></div>
<div style="position:absolute;left:263.79px;top:401.81px" class="cls_081"><span class="cls_081">40</span></div>
<div style="position:absolute;left:294.37px;top:401.81px" class="cls_081"><span class="cls_081">50</span></div>
<div style="position:absolute;left:324.95px;top:401.81px" class="cls_081"><span class="cls_081">60</span></div>
<div style="position:absolute;left:355.54px;top:401.81px" class="cls_081"><span class="cls_081">70</span></div>
<div style="position:absolute;left:386.11px;top:401.81px" class="cls_081"><span class="cls_081">80</span></div>
<div style="position:absolute;left:416.70px;top:401.81px" class="cls_081"><span class="cls_081">90</span></div>
<div style="position:absolute;left:445.20px;top:401.81px" class="cls_081"><span class="cls_081">100</span></div>
<div style="position:absolute;left:280.92px;top:412.06px" class="cls_082"><span class="cls_082">Hash Size</span></div>
<div style="position:absolute;left:123.00px;top:428.75px" class="cls_038"><span class="cls_038">Figure 7-8: Time required to add 10,000 key/value pairs vs. hash size (Ruby 2.0)</span></div>
<div style="position:absolute;left:141.00px;top:457.25px" class="cls_007"><span class="cls_007">The two smaller spikes on the 1st and 7th insert in this figure are curi-</span></div>
<div style="position:absolute;left:123.00px;top:469.25px" class="cls_007"><span class="cls_007">ous. While not as pronounced as the spikes at the 57th and 97th elements,</span></div>
<div style="position:absolute;left:123.00px;top:481.25px" class="cls_007"><span class="cls_007">these smaller spikes are nonetheless noticeable. As it turns out, Ruby 2.0</span></div>
<div style="position:absolute;left:123.00px;top:493.25px" class="cls_007"><span class="cls_007">contains another optimization that speeds up hash access even more for</span></div>
<div style="position:absolute;left:123.00px;top:505.25px" class="cls_007"><span class="cls_007">small hashes that contain less than 7 elements. I’ll discuss this further in</span></div>
<div style="position:absolute;left:123.00px;top:517.25px" class="cls_007"><span class="cls_007">“Hash Optimization in Ruby 2.x” on page 187.</span></div>
<div style="position:absolute;left:298.67px;top:636.00px" class="cls_021"><span class="cls_021">The Hash Table: The Workhorse of Ruby Internals</span></div>
<div style="position:absolute;left:443.02px;top:633.00px" class="cls_020"><span class="cls_020">179</span></div>
</div>
<div style="position:absolute;left:50%;margin-left:-252px;top:135200px;width:504px;height:666px;border-style:outset;overflow:hidden">
<div style="position:absolute;left:0px;top:0px">
<img src="e698b76e-46bd-11eb-8b25-0cc47a792c0a_id_e698b76e-46bd-11eb-8b25-0cc47a792c0a_files/background204.jpg" width=504 height=666></div>
<div style="position:absolute;left:135.32px;top:61.31px" class="cls_020"><span class="cls_020">Where Do the Magic Numbers 57 and 67 Come From?</span></div>
<div style="position:absolute;left:120.50px;top:79.81px" class="cls_039"><span class="cls_039">To see where these magic numbers come from (57, 67, and so on), look at the top</span></div>
<div style="position:absolute;left:120.50px;top:91.81px" class="cls_039"><span class="cls_039">of the </span><span class="cls_044">st.c</span><span class="cls_039"> code file for your version of Ruby. You should find a list of prime numbers</span></div>
<div style="position:absolute;left:120.50px;top:103.82px" class="cls_039"><span class="cls_039">like the ones shown in Listing 7-4.</span></div>
<div style="position:absolute;left:120.50px;top:126.31px" class="cls_009"><span class="cls_009">/*</span></div>
<div style="position:absolute;left:120.50px;top:135.82px" class="cls_009"><span class="cls_009">Table of prime numbers 2^n+a, 2&lt;=n&lt;=30.</span></div>
<div style="position:absolute;left:120.50px;top:145.32px" class="cls_009"><span class="cls_009">*/</span></div>
<div style="position:absolute;left:120.50px;top:154.82px" class="cls_009"><span class="cls_009">static const unsigned int primes[] = {</span></div>
<div style="position:absolute;left:110.00px;top:163.31px" class="cls_046"><span class="cls_046">u</span></div>
<div style="position:absolute;left:128.83px;top:164.31px" class="cls_009"><span class="cls_009">8 + 3,</span></div>
<div style="position:absolute;left:110.00px;top:172.81px" class="cls_046"><span class="cls_046">v</span></div>
<div style="position:absolute;left:128.83px;top:173.81px" class="cls_009"><span class="cls_009">16 + 3,</span></div>
<div style="position:absolute;left:110.00px;top:182.31px" class="cls_046"><span class="cls_046">w</span></div>
<div style="position:absolute;left:128.83px;top:183.31px" class="cls_009"><span class="cls_009">32 + 5,</span></div>
<div style="position:absolute;left:128.00px;top:192.82px" class="cls_009"><span class="cls_009">64 + 3,</span></div>
<div style="position:absolute;left:128.00px;top:202.32px" class="cls_009"><span class="cls_009">128 + 3,</span></div>
<div style="position:absolute;left:128.00px;top:211.82px" class="cls_009"><span class="cls_009">256 + 27,</span></div>
<div style="position:absolute;left:128.00px;top:221.32px" class="cls_009"><span class="cls_009">512 + 9,</span></div>
<div style="position:absolute;left:120.50px;top:230.83px" class="cls_009"><span class="cls_009">--snip--</span></div>
<div style="position:absolute;left:120.50px;top:253.33px" class="cls_043"><span class="cls_043">Listing 7-4: Ruby uses an algorithm based on prime numbers to determine the number of buckets</span></div>
<div style="position:absolute;left:120.50px;top:263.83px" class="cls_043"><span class="cls_043">required in each hash table.</span></div>
<div style="position:absolute;left:138.50px;top:286.81px" class="cls_039"><span class="cls_039">This C array lists some prime numbers that occur near powers of 2. Peter Moore’s</span></div>
<div style="position:absolute;left:120.50px;top:298.82px" class="cls_039"><span class="cls_039">hash table code uses this table to decide how many bins to use in the hash table. For</span></div>
<div style="position:absolute;left:120.50px;top:310.82px" class="cls_039"><span class="cls_039">example, the first prime number in the list above is 11 at </span><span class="cls_046">u</span><span class="cls_039">, which is why Ruby hash</span></div>
<div style="position:absolute;left:120.50px;top:322.82px" class="cls_039"><span class="cls_039">tables start with 11 bins. Later, as the number of elements increases, the number of</span></div>
<div style="position:absolute;left:120.50px;top:334.82px" class="cls_039"><span class="cls_039">bins increases to 19 at </span><span class="cls_046">v</span><span class="cls_039">, then to 37 at </span><span class="cls_046">w</span><span class="cls_039">, and so on.</span></div>
<div style="position:absolute;left:138.50px;top:346.82px" class="cls_039"><span class="cls_039">Ruby always sets the number of hash table bins to a prime number in order to</span></div>
<div style="position:absolute;left:120.50px;top:358.83px" class="cls_039"><span class="cls_039">make it more likely that the hash values will be evenly distributed among the bins.</span></div>
<div style="position:absolute;left:120.50px;top:370.83px" class="cls_039"><span class="cls_039">Mathematically, prime numbers help here because they are less likely to share a</span></div>
<div style="position:absolute;left:120.50px;top:382.83px" class="cls_039"><span class="cls_039">common factor with the hash values, should a poor hash function return not entirely</span></div>
<div style="position:absolute;left:120.50px;top:394.83px" class="cls_039"><span class="cls_039">random values. Remember Ruby divides the hash values by the number of bins</span></div>
<div style="position:absolute;left:120.50px;top:406.83px" class="cls_039"><span class="cls_039">while calculating which bin to place the value into. If the hash values and bin count</span></div>
<div style="position:absolute;left:120.50px;top:418.84px" class="cls_039"><span class="cls_039">shared a factor, or even worse if the hash values were multiples of the bin count, the</span></div>
<div style="position:absolute;left:120.50px;top:430.84px" class="cls_039"><span class="cls_039">bin number (modulus) might always be the same. This would lead to the table entries</span></div>
<div style="position:absolute;left:120.50px;top:442.84px" class="cls_039"><span class="cls_039">being unevenly distributed among the bins.</span></div>
<div style="position:absolute;left:138.50px;top:454.81px" class="cls_039"><span class="cls_039">Elsewhere in the </span><span class="cls_044">st.c</span><span class="cls_039"> file, you should see this C constant:</span></div>
<div style="position:absolute;left:120.50px;top:477.31px" class="cls_009"><span class="cls_009">#define ST_DEFAULT_MAX_DENSITY 5</span></div>
<div style="position:absolute;left:138.50px;top:500.31px" class="cls_039"><span class="cls_039">This constant defines the maximum allowed density, or the average number of</span></div>
<div style="position:absolute;left:120.50px;top:512.32px" class="cls_039"><span class="cls_039">elements per bin.</span></div>
<div style="position:absolute;left:138.50px;top:524.32px" class="cls_039"><span class="cls_039">Finally, you should see the code that decides when to perform a bin realloca-</span></div>
<div style="position:absolute;left:120.50px;top:536.31px" class="cls_039"><span class="cls_039">tion by finding where the constant </span><span class="cls_009">ST_DEFAULT_MAX_DENSITY</span><span class="cls_039"> is used in </span><span class="cls_044">st.c</span><span class="cls_039">. For Ruby 1.8,</span></div>
<div style="position:absolute;left:120.50px;top:548.32px" class="cls_039"><span class="cls_039">you’ll find this code:</span></div>
<div style="position:absolute;left:120.50px;top:570.81px" class="cls_009"><span class="cls_009">if (table->num_entries/(table->num_bins) > ST_DEFAULT_MAX_DENSITY) {</span></div>
<div style="position:absolute;left:128.00px;top:580.32px" class="cls_009"><span class="cls_009">rehash(table);</span></div>
<div style="position:absolute;left:48.00px;top:633.00px" class="cls_020"><span class="cls_020">180</span></div>
<div style="position:absolute;left:74.24px;top:636.00px" class="cls_021"><span class="cls_021">Chapter 7</span></div>
</div>
<div style="position:absolute;left:50%;margin-left:-252px;top:135876px;width:504px;height:666px;border-style:outset;overflow:hidden">
<div style="position:absolute;left:0px;top:0px">
<img src="e698b76e-46bd-11eb-8b25-0cc47a792c0a_id_e698b76e-46bd-11eb-8b25-0cc47a792c0a_files/background205.jpg" width=504 height=666></div>
<div style="position:absolute;left:141.50px;top:61.15px" class="cls_039"><span class="cls_039">Ruby 1.8 rehashes from 11 to 19 bins when the value </span><span class="cls_009">num_entries/11</span><span class="cls_039"> is greater</span></div>
<div style="position:absolute;left:123.50px;top:73.16px" class="cls_039"><span class="cls_039">than 5—that is, when it equals 66. As this check is performed before a new ele-</span></div>
<div style="position:absolute;left:123.50px;top:85.16px" class="cls_039"><span class="cls_039">ment is added, the condition becomes true when you add the 67th element because</span></div>
<div style="position:absolute;left:123.50px;top:97.15px" class="cls_009"><span class="cls_009">num_entries</span><span class="cls_039"> would then be 66.</span></div>
<div style="position:absolute;left:141.50px;top:109.16px" class="cls_039"><span class="cls_039">For Ruby 1.9 and Ruby 2.0, you’ll find this code instead:</span></div>
<div style="position:absolute;left:123.50px;top:131.65px" class="cls_009"><span class="cls_009">if ((table)->num_entries ></span></div>
<div style="position:absolute;left:138.50px;top:141.16px" class="cls_009"><span class="cls_009">ST_DEFAULT_MAX_DENSITY * (table)->num_bins) {</span></div>
<div style="position:absolute;left:131.00px;top:150.66px" class="cls_009"><span class="cls_009">rehash(table);</span></div>
<div style="position:absolute;left:141.50px;top:173.65px" class="cls_039"><span class="cls_039">You can see that Ruby 2.0 rehashes for the first time when </span><span class="cls_009">num_entries</span><span class="cls_039"> is greater</span></div>
<div style="position:absolute;left:123.50px;top:185.66px" class="cls_039"><span class="cls_039">than 5*11, or when you insert the 57th element.</span></div>
<div style="position:absolute;left:69.00px;top:240.63px" class="cls_031"><span class="cls_031">How Ruby Implements Hash Functions</span></div>
<div style="position:absolute;left:123.00px;top:260.63px" class="cls_007"><span class="cls_007">Now for a closer look at the actual</span></div>
<div style="position:absolute;left:123.00px;top:272.63px" class="cls_007"><span class="cls_007">hash function Ruby uses to assign</span></div>
<div style="position:absolute;left:123.00px;top:284.63px" class="cls_007"><span class="cls_007">keys and values to bins in hash tables.</span></div>
<div style="position:absolute;left:123.00px;top:296.63px" class="cls_007"><span class="cls_007">This function is central to the way</span></div>
<div style="position:absolute;left:123.00px;top:308.63px" class="cls_007"><span class="cls_007">the hash object is implemented—if</span></div>
<div style="position:absolute;left:123.00px;top:320.63px" class="cls_007"><span class="cls_007">it works well, Ruby hashes are fast,</span></div>
<div style="position:absolute;left:123.00px;top:332.63px" class="cls_007"><span class="cls_007">but a poor hash function can cause</span></div>
<div style="position:absolute;left:123.00px;top:344.63px" class="cls_007"><span class="cls_007">severe performance problems.</span></div>
<div style="position:absolute;left:123.00px;top:356.63px" class="cls_007"><span class="cls_007">Furthermore, Ruby uses hash tables</span></div>
<div style="position:absolute;left:123.00px;top:368.63px" class="cls_007"><span class="cls_007">internally to store its own informa-</span></div>
<div style="position:absolute;left:123.00px;top:380.63px" class="cls_007"><span class="cls_007">tion, in addition to the data values</span></div>
<div style="position:absolute;left:123.00px;top:392.63px" class="cls_007"><span class="cls_007">you save in hash objects. Clearly</span></div>
<div style="position:absolute;left:308.00px;top:394.15px" class="cls_038"><span class="cls_038">Hash functions allow Ruby to find which</span></div>
<div style="position:absolute;left:123.00px;top:404.63px" class="cls_007"><span class="cls_007">having a good hash function is very</span></div>
<div style="position:absolute;left:308.00px;top:404.65px" class="cls_038"><span class="cls_038">bin contains a given key and value.</span></div>
<div style="position:absolute;left:123.00px;top:416.63px" class="cls_007"><span class="cls_007">important!</span></div>
<div style="position:absolute;left:141.00px;top:428.63px" class="cls_007"><span class="cls_007">Let’s review how Ruby uses hash values. Remember that when you save</span></div>
<div style="position:absolute;left:123.00px;top:440.63px" class="cls_007"><span class="cls_007">a new element in a hash—a new key/value pair—Ruby assigns that element</span></div>
<div style="position:absolute;left:123.00px;top:452.63px" class="cls_007"><span class="cls_007">to a bin inside the internal hash table used by that hash object, as shown in</span></div>
<div style="position:absolute;left:123.00px;top:464.63px" class="cls_007"><span class="cls_007">Figure 7-9.</span></div>
<div style="position:absolute;left:141.00px;top:476.63px" class="cls_007"><span class="cls_007">Ruby calculates the modulus of the key’s hash value based on the num-</span></div>
<div style="position:absolute;left:123.00px;top:488.63px" class="cls_007"><span class="cls_007">ber of bins.</span></div>
<div style="position:absolute;left:123.00px;top:512.63px" class="cls_030"><span class="cls_030">bin_index = internal_hash_function(key) % bin_count</span></div>
<div style="position:absolute;left:141.00px;top:535.13px" class="cls_007"><span class="cls_007">Using the same example values we used earlier, this formula becomes:</span></div>
<div style="position:absolute;left:123.00px;top:560.63px" class="cls_030"><span class="cls_030">2 = hash(:key) % 11</span></div>
<div style="position:absolute;left:298.81px;top:636.00px" class="cls_021"><span class="cls_021">The Hash Table: The Workhorse of Ruby Internals</span></div>
<div style="position:absolute;left:443.16px;top:633.00px" class="cls_020"><span class="cls_020">181</span></div>
</div>
<div style="position:absolute;left:50%;margin-left:-252px;top:136552px;width:504px;height:666px;border-style:outset;overflow:hidden">
<div style="position:absolute;left:0px;top:0px">
<img src="e698b76e-46bd-11eb-8b25-0cc47a792c0a_id_e698b76e-46bd-11eb-8b25-0cc47a792c0a_files/background206.jpg" width=504 height=666></div>
<div style="position:absolute;left:238.12px;top:48.64px" class="cls_042"><span class="cls_042">st_table</span></div>
<div style="position:absolute;left:258.38px;top:66.98px" class="cls_014"><span class="cls_014">type</span></div>
<div style="position:absolute;left:125.65px;top:80.73px" class="cls_042"><span class="cls_042">RHash</span></div>
<div style="position:absolute;left:250.38px;top:88.49px" class="cls_014"><span class="cls_014">num_bins</span></div>
<div style="position:absolute;left:147.91px;top:95.85px" class="cls_014"><span class="cls_014">tbl</span></div>
<div style="position:absolute;left:244.38px;top:109.98px" class="cls_014"><span class="cls_014">num_entries</span></div>
<div style="position:absolute;left:258.38px;top:130.82px" class="cls_014"><span class="cls_014">bins</span></div>
<div style="position:absolute;left:264.12px;top:179.36px" class="cls_014"><span class="cls_014">0</span></div>
<div style="position:absolute;left:280.50px;top:179.36px" class="cls_014"><span class="cls_014">1</span></div>
<div style="position:absolute;left:297.52px;top:179.36px" class="cls_014"><span class="cls_014">2</span></div>
<div style="position:absolute;left:314.53px;top:179.36px" class="cls_014"><span class="cls_014">3</span></div>
<div style="position:absolute;left:331.54px;top:179.36px" class="cls_014"><span class="cls_014">4</span></div>
<div style="position:absolute;left:348.55px;top:179.36px" class="cls_014"><span class="cls_014">5</span></div>
<div style="position:absolute;left:365.57px;top:179.36px" class="cls_014"><span class="cls_014">6</span></div>
<div style="position:absolute;left:382.58px;top:179.36px" class="cls_014"><span class="cls_014">7</span></div>
<div style="position:absolute;left:399.59px;top:179.36px" class="cls_014"><span class="cls_014">8</span></div>
<div style="position:absolute;left:416.60px;top:179.36px" class="cls_014"><span class="cls_014">9</span></div>
<div style="position:absolute;left:431.61px;top:179.36px" class="cls_014"><span class="cls_014">10</span></div>
<div style="position:absolute;left:264.73px;top:216.97px" class="cls_042"><span class="cls_042">st_table_entry</span></div>
<div style="position:absolute;left:269.55px;top:232.38px" class="cls_014"><span class="cls_014">:key => "value"</span></div>
<div style="position:absolute;left:120.00px;top:265.07px" class="cls_038"><span class="cls_038">Figure 7-9: A Ruby hash object containing a single value (repeated from Figure 7-2)</span></div>
<div style="position:absolute;left:138.00px;top:293.57px" class="cls_007"><span class="cls_007">This formula works well because Ruby’s hash values are basically ran-</span></div>
<div style="position:absolute;left:120.00px;top:305.57px" class="cls_007"><span class="cls_007">dom integers for any given input data. To get a feel for how Ruby’s hash</span></div>
<div style="position:absolute;left:120.00px;top:317.57px" class="cls_007"><span class="cls_007">function works, call the </span><span class="cls_030">hash</span><span class="cls_007"> method, as shown in Listing 7-5.</span></div>
<div style="position:absolute;left:120.00px;top:341.57px" class="cls_030"><span class="cls_030">$ </span><span class="cls_040">irb</span></div>
<div style="position:absolute;left:120.00px;top:352.07px" class="cls_030"><span class="cls_030">> </span><span class="cls_040">"abc".hash</span></div>
<div style="position:absolute;left:124.25px;top:362.56px" class="cls_030"><span class="cls_030">=> 3277525029751053763</span></div>
<div style="position:absolute;left:120.00px;top:373.06px" class="cls_030"><span class="cls_030">> </span><span class="cls_040">"abd".hash</span></div>
<div style="position:absolute;left:124.25px;top:383.56px" class="cls_030"><span class="cls_030">=> 234577060685640459</span></div>
<div style="position:absolute;left:120.00px;top:394.06px" class="cls_030"><span class="cls_030">> </span><span class="cls_040">1.hash</span></div>
<div style="position:absolute;left:124.25px;top:404.55px" class="cls_030"><span class="cls_030">=> -3466223919964109258</span></div>
<div style="position:absolute;left:120.00px;top:415.05px" class="cls_030"><span class="cls_030">> </span><span class="cls_040">2.hash</span></div>
<div style="position:absolute;left:124.25px;top:425.55px" class="cls_030"><span class="cls_030">=> -2297524640777648528</span></div>
<div style="position:absolute;left:120.00px;top:448.05px" class="cls_038"><span class="cls_038">Listing 7-5: Displaying the hash value for different Ruby objects</span></div>
<div style="position:absolute;left:138.00px;top:470.57px" class="cls_007"><span class="cls_007">Here, even similar values have very different hash values. And if we call</span></div>
<div style="position:absolute;left:120.00px;top:482.57px" class="cls_030"><span class="cls_030">hash</span><span class="cls_007"> again, we always get the same integer value for the same input data.</span></div>
<div style="position:absolute;left:120.00px;top:506.57px" class="cls_030"><span class="cls_030">> </span><span class="cls_040">"abc".hash</span></div>
<div style="position:absolute;left:124.25px;top:517.07px" class="cls_030"><span class="cls_030">=> 3277525029751053763</span></div>
<div style="position:absolute;left:120.00px;top:527.56px" class="cls_030"><span class="cls_030">> </span><span class="cls_040">"abd".hash</span></div>
<div style="position:absolute;left:124.25px;top:538.06px" class="cls_030"><span class="cls_030">=> 234577060685640459</span></div>
<div style="position:absolute;left:48.00px;top:633.00px" class="cls_020"><span class="cls_020">182</span></div>
<div style="position:absolute;left:74.08px;top:636.00px" class="cls_021"><span class="cls_021">Chapter 7</span></div>
</div>
<div style="position:absolute;left:50%;margin-left:-252px;top:137228px;width:504px;height:666px;border-style:outset;overflow:hidden">
<div style="position:absolute;left:0px;top:0px">
<img src="e698b76e-46bd-11eb-8b25-0cc47a792c0a_id_e698b76e-46bd-11eb-8b25-0cc47a792c0a_files/background207.jpg" width=504 height=666></div>
<div style="position:absolute;left:141.00px;top:42.28px" class="cls_007"><span class="cls_007">Here’s how Ruby’s hash function actually works for most Ruby objects:</span></div>
<div style="position:absolute;left:123.00px;top:63.28px" class="cls_050"><span class="cls_050">•</span><span class="cls_007">   When you call </span><span class="cls_030">hash</span><span class="cls_007">, Ruby finds the default implementation in the </span><span class="cls_030">Object</span></div>
<div style="position:absolute;left:141.00px;top:75.28px" class="cls_007"><span class="cls_007">class. You can override this if you want to.</span></div>
<div style="position:absolute;left:123.00px;top:90.28px" class="cls_050"><span class="cls_050">•</span><span class="cls_007">   The C code used by the </span><span class="cls_030">Object</span><span class="cls_007"> class’s implementation of the </span><span class="cls_030">hash</span></div>
<div style="position:absolute;left:141.00px;top:102.28px" class="cls_007"><span class="cls_007">method gets the C pointer value for the target object—that is, the</span></div>
<div style="position:absolute;left:141.00px;top:114.28px" class="cls_007"><span class="cls_007">actual memory address of that object’s </span><span class="cls_030">RValue</span><span class="cls_007"> structure. This is essen-</span></div>
<div style="position:absolute;left:141.00px;top:126.28px" class="cls_007"><span class="cls_007">tially a unique ID for that object.</span></div>
<div style="position:absolute;left:123.00px;top:141.28px" class="cls_050"><span class="cls_050">•</span><span class="cls_007">   Ruby passes the pointer value through a complex C function (the hash</span></div>
<div style="position:absolute;left:141.00px;top:153.28px" class="cls_007"><span class="cls_007">function), which scrambles the bits in the value, producing a pseudo­</span></div>
<div style="position:absolute;left:141.00px;top:165.28px" class="cls_007"><span class="cls_007">random integer in a repeatable way.</span></div>
<div style="position:absolute;left:141.00px;top:186.28px" class="cls_007"><span class="cls_007">In the case of strings and arrays, Ruby actually iterates through all of</span></div>
<div style="position:absolute;left:123.00px;top:198.28px" class="cls_007"><span class="cls_007">the characters in the string or the elements in the array and calculates a</span></div>
<div style="position:absolute;left:123.00px;top:210.28px" class="cls_007"><span class="cls_007">cumulative hash value. This guarantees that the hash will always be the</span></div>
<div style="position:absolute;left:123.00px;top:222.28px" class="cls_007"><span class="cls_007">same for any instance of a string or array and that it will change if any of</span></div>
<div style="position:absolute;left:123.00px;top:234.28px" class="cls_007"><span class="cls_007">the values in the string or array change. Integers and symbols are another</span></div>
<div style="position:absolute;left:123.00px;top:246.28px" class="cls_007"><span class="cls_007">special case. Ruby just passes their values right to the hash function.</span></div>
<div style="position:absolute;left:141.00px;top:258.28px" class="cls_007"><span class="cls_007">To calculate hashes from values, Ruby 1.9 and 2.0 use a hash function</span></div>
<div style="position:absolute;left:123.00px;top:270.28px" class="cls_007"><span class="cls_007">called </span><span class="cls_008">MurmurHash</span><span class="cls_007">, which was invented by Austin Appleby in 2008. The</span></div>
<div style="position:absolute;left:123.00px;top:282.28px" class="cls_007"><span class="cls_007">name </span><span class="cls_008">Murmur</span><span class="cls_007"> comes from the machine language operations used in the</span></div>
<div style="position:absolute;left:123.00px;top:294.28px" class="cls_007"><span class="cls_007">algorithm: </span><span class="cls_008">multiply</span><span class="cls_007"> and </span><span class="cls_008">rotate</span><span class="cls_007">. (To learn how the Murmur algorithm actually</span></div>
<div style="position:absolute;left:123.00px;top:306.28px" class="cls_007"><span class="cls_007">works, read its C code in the </span><span class="cls_008">st.c</span><span class="cls_007"> Ruby source code file. Or read Austin’s web</span></div>
<div style="position:absolute;left:123.00px;top:318.28px" class="cls_007"><span class="cls_007">page on Murmur: </span><A HREF="http://sites.google.com/site/murmurhash/">http://sites.google.com/site/murmurhash/</A> </span><span class="cls_007">.)</span></div>
<div style="position:absolute;left:141.00px;top:330.28px" class="cls_007"><span class="cls_007">Ruby 1.9 and 2.0 initialize MurmurHash using a random seed value</span></div>
<div style="position:absolute;left:123.00px;top:342.28px" class="cls_007"><span class="cls_007">that is reinitialized each time you restart Ruby. This means that if you stop</span></div>
<div style="position:absolute;left:123.00px;top:354.28px" class="cls_007"><span class="cls_007">and restart Ruby, you’ll get different hash values for the same input data. It</span></div>
<div style="position:absolute;left:123.00px;top:366.28px" class="cls_007"><span class="cls_007">also means that if you try this yourself, you’ll get different values than those</span></div>
<div style="position:absolute;left:123.00px;top:378.28px" class="cls_007"><span class="cls_007">above, but the hash values will always be the same within the same Ruby</span></div>
<div style="position:absolute;left:123.00px;top:390.28px" class="cls_007"><span class="cls_007">process.</span></div>
<div style="position:absolute;left:123.00px;top:424.28px" class="cls_031"><span class="cls_031">Experiment 7-3: Using Objects as Keys in a Hash</span></div>
<div style="position:absolute;left:123.00px;top:444.28px" class="cls_007"><span class="cls_007">Because hash values are evenly distributed, once Ruby divides them by the</span></div>
<div style="position:absolute;left:123.00px;top:456.28px" class="cls_007"><span class="cls_007">bin count, say 11, the remaining values (the modulus values) are random</span></div>
<div style="position:absolute;left:123.00px;top:468.28px" class="cls_007"><span class="cls_007">numbers between 0 and 10. This means that the </span><span class="cls_030">st_table_entry</span><span class="cls_007"> structures</span></div>
<div style="position:absolute;left:123.00px;top:480.28px" class="cls_007"><span class="cls_007">are evenly distributed over the available bins as they are saved in the hash</span></div>
<div style="position:absolute;left:123.00px;top:492.28px" class="cls_007"><span class="cls_007">table, which ensures that Ruby will be able to quickly find any given key.</span></div>
<div style="position:absolute;left:123.00px;top:504.28px" class="cls_007"><span class="cls_007">The number of entries per bin will always be small.</span></div>
<div style="position:absolute;left:141.00px;top:516.28px" class="cls_007"><span class="cls_007">But what if Ruby’s hash function didn’t return random integers but</span></div>
<div style="position:absolute;left:123.00px;top:528.28px" class="cls_007"><span class="cls_007">rather returned the same integer for every input data value? What would</span></div>
<div style="position:absolute;left:123.00px;top:540.28px" class="cls_007"><span class="cls_007">happen?</span></div>
<div style="position:absolute;left:141.00px;top:552.28px" class="cls_007"><span class="cls_007">In that case, every time you added a key/value to a hash, it would always</span></div>
<div style="position:absolute;left:123.00px;top:564.28px" class="cls_007"><span class="cls_007">be assigned to the same bin. Ruby would end up with all of the entries in</span></div>
<div style="position:absolute;left:123.00px;top:576.28px" class="cls_007"><span class="cls_007">a single long list under that one bin, with no entries in any other bin, as</span></div>
<div style="position:absolute;left:123.00px;top:588.28px" class="cls_007"><span class="cls_007">shown in Figure 7-10.</span></div>
<div style="position:absolute;left:298.35px;top:636.00px" class="cls_021"><span class="cls_021">The Hash Table: The Workhorse of Ruby Internals</span></div>
<div style="position:absolute;left:442.70px;top:633.00px" class="cls_020"><span class="cls_020">183</span></div>
</div>
<div style="position:absolute;left:50%;margin-left:-252px;top:137904px;width:504px;height:666px;border-style:outset;overflow:hidden">
<div style="position:absolute;left:0px;top:0px">
<img src="e698b76e-46bd-11eb-8b25-0cc47a792c0a_id_e698b76e-46bd-11eb-8b25-0cc47a792c0a_files/background208.jpg" width=504 height=666></div>
<div style="position:absolute;left:128.90px;top:49.25px" class="cls_067"><span class="cls_067">0</span></div>
<div style="position:absolute;left:149.54px;top:49.25px" class="cls_067"><span class="cls_067">1</span></div>
<div style="position:absolute;left:170.18px;top:49.25px" class="cls_067"><span class="cls_067">2</span></div>
<div style="position:absolute;left:190.81px;top:49.25px" class="cls_067"><span class="cls_067">3</span></div>
<div style="position:absolute;left:211.36px;top:49.25px" class="cls_067"><span class="cls_067">4</span></div>
<div style="position:absolute;left:232.00px;top:49.25px" class="cls_067"><span class="cls_067">5</span></div>
<div style="position:absolute;left:252.64px;top:49.25px" class="cls_067"><span class="cls_067">6</span></div>
<div style="position:absolute;left:273.27px;top:49.25px" class="cls_067"><span class="cls_067">7</span></div>
<div style="position:absolute;left:293.96px;top:49.25px" class="cls_067"><span class="cls_067">8</span></div>
<div style="position:absolute;left:315.25px;top:49.25px" class="cls_067"><span class="cls_067">9</span></div>
<div style="position:absolute;left:335.12px;top:49.25px" class="cls_067"><span class="cls_067">10</span></div>
<div style="position:absolute;left:207.11px;top:80.25px" class="cls_136"><span class="cls_136">entry</span></div>
<div style="position:absolute;left:207.11px;top:102.08px" class="cls_136"><span class="cls_136">entry</span></div>
<div style="position:absolute;left:207.11px;top:123.91px" class="cls_136"><span class="cls_136">entry</span></div>
<div style="position:absolute;left:207.11px;top:145.74px" class="cls_136"><span class="cls_136">entry</span></div>
<div style="position:absolute;left:207.11px;top:167.57px" class="cls_136"><span class="cls_136">entry</span></div>
<div style="position:absolute;left:207.11px;top:189.40px" class="cls_136"><span class="cls_136">entry</span></div>
<div style="position:absolute;left:207.11px;top:211.23px" class="cls_136"><span class="cls_136">entry</span></div>
<div style="position:absolute;left:207.11px;top:233.06px" class="cls_136"><span class="cls_136">entry</span></div>
<div style="position:absolute;left:207.11px;top:254.89px" class="cls_136"><span class="cls_136">entry</span></div>
<div style="position:absolute;left:207.11px;top:276.72px" class="cls_136"><span class="cls_136">entry</span></div>
<div style="position:absolute;left:204.73px;top:292.25px" class="cls_054"><span class="cls_054">etc...</span></div>
<div style="position:absolute;left:120.00px;top:310.60px" class="cls_038"><span class="cls_038">Figure 7-10: A hash table created with a very poor hash function</span></div>
<div style="position:absolute;left:138.00px;top:333.10px" class="cls_007"><span class="cls_007">If you tried to retrieve a value from this hash, Ruby would have to look</span></div>
<div style="position:absolute;left:120.00px;top:345.10px" class="cls_007"><span class="cls_007">through this long list, one element at a time, to find the requested key. In</span></div>
<div style="position:absolute;left:120.00px;top:357.10px" class="cls_007"><span class="cls_007">this scenario, loading a value from the hash would be very, very slow.</span></div>
<div style="position:absolute;left:138.00px;top:369.10px" class="cls_007"><span class="cls_007">To prove this is the case—and to illustrate just how important Ruby’s</span></div>
<div style="position:absolute;left:120.00px;top:381.10px" class="cls_007"><span class="cls_007">hash function really is—we’ll use objects with poor hash functions as keys</span></div>
<div style="position:absolute;left:120.00px;top:393.10px" class="cls_007"><span class="cls_007">in a hash. We’ll repeat Experiment 7-1 here, but we’ll use instances of a</span></div>
<div style="position:absolute;left:120.00px;top:405.10px" class="cls_007"><span class="cls_007">class I defined as the key values instead of random numbers. Listing 7-6</span></div>
<div style="position:absolute;left:120.00px;top:417.10px" class="cls_007"><span class="cls_007">shows the code from Experiment 7-1, updated in two places.</span></div>
<div style="position:absolute;left:120.00px;top:441.10px" class="cls_030"><span class="cls_030">require 'benchmark'</span></div>
<div style="position:absolute;left:108.15px;top:462.10px" class="cls_046"><span class="cls_046">u</span><span class="cls_030"> class KeyObject</span></div>
<div style="position:absolute;left:128.50px;top:472.60px" class="cls_030"><span class="cls_030">def eql?(other)</span></div>
<div style="position:absolute;left:137.00px;top:483.09px" class="cls_030"><span class="cls_030">super</span></div>
<div style="position:absolute;left:128.50px;top:493.59px" class="cls_030"><span class="cls_030">end</span></div>
<div style="position:absolute;left:120.00px;top:504.09px" class="cls_030"><span class="cls_030">end</span></div>
<div style="position:absolute;left:120.00px;top:525.09px" class="cls_030"><span class="cls_030">21.times do |exponent|</span></div>
<div style="position:absolute;left:128.50px;top:546.10px" class="cls_030"><span class="cls_030">target_key = nil</span></div>
<div style="position:absolute;left:128.50px;top:567.10px" class="cls_030"><span class="cls_030">size = 2**exponent</span></div>
<div style="position:absolute;left:128.50px;top:577.60px" class="cls_030"><span class="cls_030">hash = {}</span></div>
<div style="position:absolute;left:128.50px;top:588.09px" class="cls_030"><span class="cls_030">(1..size).each do |n|</span></div>
<div style="position:absolute;left:108.15px;top:598.59px" class="cls_046"><span class="cls_046">v</span><span class="cls_030">     index = KeyObject.new</span></div>
<div style="position:absolute;left:137.00px;top:609.09px" class="cls_030"><span class="cls_030">target_key = index if n > size/2 && target_key.nil?</span></div>
<div style="position:absolute;left:48.00px;top:633.00px" class="cls_020"><span class="cls_020">184</span></div>
<div style="position:absolute;left:74.30px;top:636.00px" class="cls_021"><span class="cls_021">Chapter 7</span></div>
</div>
<div style="position:absolute;left:50%;margin-left:-252px;top:138580px;width:504px;height:666px;border-style:outset;overflow:hidden">
<div style="position:absolute;left:0px;top:0px">
<img src="e698b76e-46bd-11eb-8b25-0cc47a792c0a_id_e698b76e-46bd-11eb-8b25-0cc47a792c0a_files/background209.jpg" width=504 height=666></div>
<div style="position:absolute;left:140.00px;top:42.24px" class="cls_030"><span class="cls_030">hash[index] = rand</span></div>
<div style="position:absolute;left:131.50px;top:52.74px" class="cls_030"><span class="cls_030">end</span></div>
<div style="position:absolute;left:131.50px;top:73.74px" class="cls_030"><span class="cls_030">GC.disable</span></div>
<div style="position:absolute;left:131.50px;top:94.74px" class="cls_030"><span class="cls_030">Benchmark.bm do |bench|</span></div>
<div style="position:absolute;left:140.00px;top:105.24px" class="cls_030"><span class="cls_030">bench.report("retrieving an element</span></div>
<div style="position:absolute;left:203.75px;top:115.74px" class="cls_030"><span class="cls_030">from a hash with #{size} elements 10000 times") do</span></div>
<div style="position:absolute;left:148.50px;top:126.23px" class="cls_030"><span class="cls_030">10000.times do</span></div>
<div style="position:absolute;left:157.00px;top:136.73px" class="cls_030"><span class="cls_030">val = hash[target_key]</span></div>
<div style="position:absolute;left:148.50px;top:147.23px" class="cls_030"><span class="cls_030">end</span></div>
<div style="position:absolute;left:140.00px;top:157.73px" class="cls_030"><span class="cls_030">end</span></div>
<div style="position:absolute;left:131.50px;top:168.22px" class="cls_030"><span class="cls_030">end</span></div>
<div style="position:absolute;left:131.50px;top:189.23px" class="cls_030"><span class="cls_030">GC.enable</span></div>
<div style="position:absolute;left:123.00px;top:210.23px" class="cls_030"><span class="cls_030">end</span></div>
<div style="position:absolute;left:123.00px;top:232.73px" class="cls_038"><span class="cls_038">Listing 7-6: Measuring how long it takes to retrieve an element from hashes of wildly</span></div>
<div style="position:absolute;left:123.00px;top:243.23px" class="cls_038"><span class="cls_038">different sizes. This is the same as Listing 7-1, but using instances of </span><span class="cls_014">KeyObject</span><span class="cls_038"> as keys.</span></div>
<div style="position:absolute;left:141.00px;top:262.74px" class="cls_007"><span class="cls_007">At </span><span class="cls_050">u</span><span class="cls_007"> we define an empty class called </span><span class="cls_030">KeyObject</span><span class="cls_007">. Note that I implemented</span></div>
<div style="position:absolute;left:123.00px;top:274.74px" class="cls_007"><span class="cls_007">the </span><span class="cls_030">eql?</span><span class="cls_007"> method; this allows Ruby to search for the target key properly when</span></div>
<div style="position:absolute;left:123.00px;top:286.74px" class="cls_007"><span class="cls_007">I retrieve a value. However, in this example, I don’t have any interesting</span></div>
<div style="position:absolute;left:123.00px;top:298.74px" class="cls_007"><span class="cls_007">data in </span><span class="cls_030">KeyObject</span><span class="cls_007">, so I simply call </span><span class="cls_030">super</span><span class="cls_007"> and use the default implementation</span></div>
<div style="position:absolute;left:123.00px;top:310.74px" class="cls_007"><span class="cls_007">of </span><span class="cls_030">eql?</span><span class="cls_007"> in the </span><span class="cls_030">Object</span><span class="cls_007"> class.</span></div>
<div style="position:absolute;left:141.00px;top:322.74px" class="cls_007"><span class="cls_007">Then, at </span><span class="cls_050">v</span><span class="cls_007"> we use new instances of </span><span class="cls_030">KeyObject</span><span class="cls_007"> as the keys for my hash</span></div>
<div style="position:absolute;left:123.00px;top:334.74px" class="cls_007"><span class="cls_007">values. Figure 7-11 shows the results of this test.</span></div>
<div style="position:absolute;left:138.95px;top:356.57px" class="cls_137"><span class="cls_137">1.6</span></div>
<div style="position:absolute;left:138.95px;top:383.94px" class="cls_137"><span class="cls_137">1.4</span></div>
<div style="position:absolute;left:138.95px;top:411.37px" class="cls_137"><span class="cls_137">1.2</span></div>
<div style="position:absolute;left:143.85px;top:439.41px" class="cls_137"><span class="cls_137">1</span></div>
<div style="position:absolute;left:138.95px;top:466.83px" class="cls_137"><span class="cls_137">0.8</span></div>
<div style="position:absolute;left:138.95px;top:493.95px" class="cls_137"><span class="cls_137">0.6</span></div>
<div style="position:absolute;left:138.95px;top:521.38px" class="cls_137"><span class="cls_137">0.4</span></div>
<div style="position:absolute;left:138.95px;top:549.42px" class="cls_137"><span class="cls_137">0.2</span></div>
<div style="position:absolute;left:143.85px;top:577.46px" class="cls_137"><span class="cls_137">0</span></div>
<div style="position:absolute;left:194.89px;top:582.35px" class="cls_137"><span class="cls_137">10</span></div>
<div style="position:absolute;left:239.71px;top:582.35px" class="cls_137"><span class="cls_137">100</span></div>
<div style="position:absolute;left:285.80px;top:582.35px" class="cls_137"><span class="cls_137">1,000</span></div>
<div style="position:absolute;left:333.27px;top:582.35px" class="cls_137"><span class="cls_137">10,000</span></div>
<div style="position:absolute;left:380.08px;top:582.35px" class="cls_137"><span class="cls_137">100,000</span></div>
<div style="position:absolute;left:427.83px;top:582.35px" class="cls_137"><span class="cls_137">1 million</span></div>
<div style="position:absolute;left:277.51px;top:596.04px" class="cls_138"><span class="cls_138">Hash Size</span></div>
<div style="position:absolute;left:123.00px;top:612.37px" class="cls_038"><span class="cls_038">Figure 7-11: Time to retrieve 10,000 values vs. hash size, using objects as keys (Ruby 2.0)</span></div>
<div style="position:absolute;left:298.53px;top:636.00px" class="cls_021"><span class="cls_021">The Hash Table: The Workhorse of Ruby Internals</span></div>
<div style="position:absolute;left:442.88px;top:633.00px" class="cls_020"><span class="cls_020">185</span></div>
</div>
<div style="position:absolute;left:50%;margin-left:-252px;top:139256px;width:504px;height:666px;border-style:outset;overflow:hidden">
<div style="position:absolute;left:0px;top:0px">
<img src="e698b76e-46bd-11eb-8b25-0cc47a792c0a_id_e698b76e-46bd-11eb-8b25-0cc47a792c0a_files/background210.jpg" width=504 height=666></div>
<div style="position:absolute;left:138.00px;top:42.28px" class="cls_007"><span class="cls_007">As you can see, the results are very similar to those in Figure 7-4. The</span></div>
<div style="position:absolute;left:120.00px;top:54.28px" class="cls_007"><span class="cls_007">chart is more or less flat. It takes about the same amount of time to retrieve</span></div>
<div style="position:absolute;left:120.00px;top:66.28px" class="cls_007"><span class="cls_007">a value from a hash with 1 million elements as it does for a hash with just 1</span></div>
<div style="position:absolute;left:120.00px;top:78.28px" class="cls_007"><span class="cls_007">element. No surprise there; using objects as keys hasn’t slowed down Ruby</span></div>
<div style="position:absolute;left:120.00px;top:90.28px" class="cls_007"><span class="cls_007">at all.</span></div>
<div style="position:absolute;left:138.00px;top:102.28px" class="cls_007"><span class="cls_007">Now let’s change the </span><span class="cls_030">KeyObject</span><span class="cls_007"> class and try again. Listing 7-7 shows the</span></div>
<div style="position:absolute;left:120.00px;top:114.28px" class="cls_007"><span class="cls_007">same code with a new hash function added at </span><span class="cls_050">u</span><span class="cls_007">.</span></div>
<div style="position:absolute;left:120.00px;top:138.28px" class="cls_030"><span class="cls_030">require 'benchmark'</span></div>
<div style="position:absolute;left:120.00px;top:159.28px" class="cls_030"><span class="cls_030">class KeyObject</span></div>
<div style="position:absolute;left:128.50px;top:169.78px" class="cls_030"><span class="cls_030">def hash</span></div>
<div style="position:absolute;left:108.15px;top:180.28px" class="cls_046"><span class="cls_046">u</span></div>
<div style="position:absolute;left:136.98px;top:180.28px" class="cls_030"><span class="cls_030">4</span></div>
<div style="position:absolute;left:128.50px;top:190.78px" class="cls_030"><span class="cls_030">end</span></div>
<div style="position:absolute;left:128.50px;top:201.27px" class="cls_030"><span class="cls_030">def eql?(other)</span></div>
<div style="position:absolute;left:137.00px;top:211.77px" class="cls_030"><span class="cls_030">super</span></div>
<div style="position:absolute;left:128.50px;top:222.27px" class="cls_030"><span class="cls_030">end</span></div>
<div style="position:absolute;left:120.00px;top:232.77px" class="cls_030"><span class="cls_030">end</span></div>
<div style="position:absolute;left:120.00px;top:253.77px" class="cls_030"><span class="cls_030">21.times do |exponent|</span></div>
<div style="position:absolute;left:128.50px;top:274.77px" class="cls_030"><span class="cls_030">target_key = nil</span></div>
<div style="position:absolute;left:128.50px;top:295.78px" class="cls_030"><span class="cls_030">size = 2**exponent</span></div>
<div style="position:absolute;left:128.50px;top:306.27px" class="cls_030"><span class="cls_030">hash = {}</span></div>
<div style="position:absolute;left:128.50px;top:316.77px" class="cls_030"><span class="cls_030">(1..size).each do |n|</span></div>
<div style="position:absolute;left:137.00px;top:327.27px" class="cls_030"><span class="cls_030">index = KeyObject.new</span></div>
<div style="position:absolute;left:137.00px;top:337.77px" class="cls_030"><span class="cls_030">target_key = index if n > size/2 && target_key.nil?</span></div>
<div style="position:absolute;left:137.00px;top:348.26px" class="cls_030"><span class="cls_030">hash[index] = rand</span></div>
<div style="position:absolute;left:128.50px;top:358.76px" class="cls_030"><span class="cls_030">end</span></div>
<div style="position:absolute;left:128.50px;top:379.77px" class="cls_030"><span class="cls_030">GC.disable</span></div>
<div style="position:absolute;left:128.50px;top:400.77px" class="cls_030"><span class="cls_030">Benchmark.bm do |bench|</span></div>
<div style="position:absolute;left:137.00px;top:411.27px" class="cls_030"><span class="cls_030">bench.report("retrieving an element</span></div>
<div style="position:absolute;left:196.50px;top:421.76px" class="cls_030"><span class="cls_030">from a hash with #{size} elements 10000 times") do</span></div>
<div style="position:absolute;left:145.50px;top:432.26px" class="cls_030"><span class="cls_030">10000.times do</span></div>
<div style="position:absolute;left:154.00px;top:442.76px" class="cls_030"><span class="cls_030">val = hash[target_key]</span></div>
<div style="position:absolute;left:145.50px;top:453.26px" class="cls_030"><span class="cls_030">end</span></div>
<div style="position:absolute;left:137.00px;top:463.75px" class="cls_030"><span class="cls_030">end</span></div>
<div style="position:absolute;left:128.50px;top:474.25px" class="cls_030"><span class="cls_030">end</span></div>
<div style="position:absolute;left:128.50px;top:495.25px" class="cls_030"><span class="cls_030">GC.enable</span></div>
<div style="position:absolute;left:120.00px;top:505.75px" class="cls_030"><span class="cls_030">end</span></div>
<div style="position:absolute;left:120.00px;top:528.25px" class="cls_038"><span class="cls_038">Listing 7-7: </span><span class="cls_014">KeyObject</span><span class="cls_038"> now has a very poor hash function.</span></div>
<div style="position:absolute;left:138.00px;top:550.78px" class="cls_007"><span class="cls_007">I’ve purposefully written a very poor hash function. Instead of return-</span></div>
<div style="position:absolute;left:120.00px;top:562.78px" class="cls_007"><span class="cls_007">ing a pseudorandom integer, the hash function in Listing 7-7 always returns</span></div>
<div style="position:absolute;left:120.00px;top:574.78px" class="cls_007"><span class="cls_007">the integer 4 at </span><span class="cls_050">u</span><span class="cls_007">, regardless of which </span><span class="cls_030">KeyObject</span><span class="cls_007"> object instance you call</span></div>
<div style="position:absolute;left:120.00px;top:586.78px" class="cls_007"><span class="cls_007">it on. Now Ruby will always get 4 when it calculates the hash value. It will</span></div>
<div style="position:absolute;left:120.00px;top:598.78px" class="cls_007"><span class="cls_007">have to assign all of the hash elements to bin number 4 in the internal hash</span></div>
<div style="position:absolute;left:120.00px;top:610.78px" class="cls_007"><span class="cls_007">table, as in Figure 7-10.</span></div>
<div style="position:absolute;left:48.00px;top:633.00px" class="cls_020"><span class="cls_020">186</span></div>
<div style="position:absolute;left:74.26px;top:636.00px" class="cls_021"><span class="cls_021">Chapter 7</span></div>
</div>
<div style="position:absolute;left:50%;margin-left:-252px;top:139932px;width:504px;height:666px;border-style:outset;overflow:hidden">
<div style="position:absolute;left:0px;top:0px">
<img src="e698b76e-46bd-11eb-8b25-0cc47a792c0a_id_e698b76e-46bd-11eb-8b25-0cc47a792c0a_files/background211.jpg" width=504 height=666></div>
<div style="position:absolute;left:141.00px;top:41.60px" class="cls_007"><span class="cls_007">Let’s try this to see what happens! Figure 7-12 shows the results of run-</span></div>
<div style="position:absolute;left:123.00px;top:53.60px" class="cls_007"><span class="cls_007">ning the code from Listing 7-7.</span></div>
<div style="position:absolute;left:136.90px;top:75.31px" class="cls_139"><span class="cls_139">20,000</span></div>
<div style="position:absolute;left:136.90px;top:98.78px" class="cls_139"><span class="cls_139">18,000</span></div>
<div style="position:absolute;left:136.90px;top:121.31px" class="cls_139"><span class="cls_139">16,000</span></div>
<div style="position:absolute;left:136.90px;top:143.84px" class="cls_139"><span class="cls_139">14,000</span></div>
<div style="position:absolute;left:136.90px;top:166.37px" class="cls_139"><span class="cls_139">12,000</span></div>
<div style="position:absolute;left:136.90px;top:188.90px" class="cls_139"><span class="cls_139">10,000</span></div>
<div style="position:absolute;left:142.11px;top:211.44px" class="cls_139"><span class="cls_139">8000</span></div>
<div style="position:absolute;left:142.11px;top:233.03px" class="cls_139"><span class="cls_139">6000</span></div>
<div style="position:absolute;left:142.11px;top:256.50px" class="cls_139"><span class="cls_139">4000</span></div>
<div style="position:absolute;left:142.11px;top:279.04px" class="cls_139"><span class="cls_139">2000</span></div>
<div style="position:absolute;left:152.54px;top:300.63px" class="cls_139"><span class="cls_139">0</span></div>
<div style="position:absolute;left:212.48px;top:306.09px" class="cls_139"><span class="cls_139">10</span></div>
<div style="position:absolute;left:268.01px;top:306.09px" class="cls_139"><span class="cls_139">100</span></div>
<div style="position:absolute;left:323.54px;top:306.09px" class="cls_139"><span class="cls_139">1000</span></div>
<div style="position:absolute;left:378.53px;top:306.09px" class="cls_139"><span class="cls_139">10,000</span></div>
<div style="position:absolute;left:434.12px;top:306.09px" class="cls_139"><span class="cls_139">100,000</span></div>
<div style="position:absolute;left:283.03px;top:319.73px" class="cls_140"><span class="cls_140">Hash Size</span></div>
<div style="position:absolute;left:123.00px;top:336.24px" class="cls_038"><span class="cls_038">Figure 7-12: Time to retrieve 10,000 values vs. hash size, using a poor hash function</span></div>
<div style="position:absolute;left:123.00px;top:346.74px" class="cls_038"><span class="cls_038">(Ruby 2.0)</span></div>
<div style="position:absolute;left:141.00px;top:369.24px" class="cls_007"><span class="cls_007">Figure 7-12 is very different from Figure 7-11! Notice the scale of the</span></div>
<div style="position:absolute;left:123.00px;top:381.24px" class="cls_007"><span class="cls_007">graph. The y-axis shows milliseconds, and the x-axis shows the number of</span></div>
<div style="position:absolute;left:123.00px;top:393.24px" class="cls_007"><span class="cls_007">elements in the hash on a logarithmic scale. But this time, notice that we</span></div>
<div style="position:absolute;left:123.00px;top:405.24px" class="cls_007"><span class="cls_007">have thousands of milliseconds—which means actual seconds—on the</span></div>
<div style="position:absolute;left:123.00px;top:417.24px" class="cls_007"><span class="cls_007">y-axis!</span></div>
<div style="position:absolute;left:141.00px;top:429.24px" class="cls_007"><span class="cls_007">With one or a few elements, we can retrieve the 10,000 values very</span></div>
<div style="position:absolute;left:123.00px;top:441.24px" class="cls_007"><span class="cls_007">quickly—so quickly that the time is too small to appear on this graph. In</span></div>
<div style="position:absolute;left:123.00px;top:453.24px" class="cls_007"><span class="cls_007">fact, it takes about the same 1.5 ms. However, when the number of ele-</span></div>
<div style="position:absolute;left:123.00px;top:465.24px" class="cls_007"><span class="cls_007">ments increases past 100 and especially 1,000, the time required to load</span></div>
<div style="position:absolute;left:123.00px;top:477.24px" class="cls_007"><span class="cls_007">the 10,000 values increases linearly with the hash size. For a hash contain-</span></div>
<div style="position:absolute;left:123.00px;top:489.24px" class="cls_007"><span class="cls_007">ing about 10,000 elements, it takes over 1.6 full seconds to load the 10,000</span></div>
<div style="position:absolute;left:123.00px;top:501.24px" class="cls_007"><span class="cls_007">values. If we continued the test with larger hashes, it would take minutes or</span></div>
<div style="position:absolute;left:123.00px;top:513.24px" class="cls_007"><span class="cls_007">even hours to load the values.</span></div>
<div style="position:absolute;left:141.00px;top:525.24px" class="cls_007"><span class="cls_007">What’s happening here is that all of the hash elements are saved into</span></div>
<div style="position:absolute;left:123.00px;top:537.24px" class="cls_007"><span class="cls_007">the same bin, forcing Ruby to search through the list one key at a time.</span></div>
<div style="position:absolute;left:123.00px;top:562.24px" class="cls_055"><span class="cls_055">Hash Optimization in Ruby 2.x</span></div>
<div style="position:absolute;left:123.00px;top:580.24px" class="cls_007"><span class="cls_007">Starting with version 2.0, Ruby introduced a new optimization to make</span></div>
<div style="position:absolute;left:123.00px;top:592.24px" class="cls_007"><span class="cls_007">hashes work even faster. For hashes that contain 6 or fewer elements, Ruby</span></div>
<div style="position:absolute;left:298.61px;top:636.00px" class="cls_021"><span class="cls_021">The Hash Table: The Workhorse of Ruby Internals</span></div>
<div style="position:absolute;left:442.96px;top:633.00px" class="cls_020"><span class="cls_020">187</span></div>
</div>
<div style="position:absolute;left:50%;margin-left:-252px;top:140608px;width:504px;height:666px;border-style:outset;overflow:hidden">
<div style="position:absolute;left:0px;top:0px">
<img src="e698b76e-46bd-11eb-8b25-0cc47a792c0a_id_e698b76e-46bd-11eb-8b25-0cc47a792c0a_files/background212.jpg" width=504 height=666></div>
<div style="position:absolute;left:120.00px;top:42.28px" class="cls_007"><span class="cls_007">now avoids calculating the hash value entirely and simply saves the hash</span></div>
<div style="position:absolute;left:120.00px;top:54.28px" class="cls_007"><span class="cls_007">data in an array. These are known as </span><span class="cls_008">packed hashes</span><span class="cls_007">. Figure 7-13 shows a</span></div>
<div style="position:absolute;left:120.00px;top:66.28px" class="cls_007"><span class="cls_007">packed hash.</span></div>
<div style="position:absolute;left:237.14px;top:92.26px" class="cls_042"><span class="cls_042">st_table</span></div>
<div style="position:absolute;left:125.65px;top:110.68px" class="cls_042"><span class="cls_042">RHash</span></div>
<div style="position:absolute;left:257.12px;top:110.41px" class="cls_014"><span class="cls_014">type</span></div>
<div style="position:absolute;left:147.63px;top:125.64px" class="cls_014"><span class="cls_014">tbl</span></div>
<div style="position:absolute;left:241.12px;top:131.73px" class="cls_014"><span class="cls_014">real_entries</span></div>
<div style="position:absolute;left:251.12px;top:152.38px" class="cls_014"><span class="cls_014">entries</span></div>
<div style="position:absolute;left:239.12px;top:189.74px" class="cls_014"><span class="cls_014">:key => value</span></div>
<div style="position:absolute;left:235.12px;top:206.12px" class="cls_014"><span class="cls_014">:key2 => value2</span></div>
<div style="position:absolute;left:235.12px;top:222.50px" class="cls_014"><span class="cls_014">:key3 => value3</span></div>
<div style="position:absolute;left:235.12px;top:238.87px" class="cls_014"><span class="cls_014">:key4 => value4</span></div>
<div style="position:absolute;left:235.12px;top:255.25px" class="cls_014"><span class="cls_014">:key5 => value5</span></div>
<div style="position:absolute;left:235.12px;top:271.63px" class="cls_014"><span class="cls_014">:key6 => value6</span></div>
<div style="position:absolute;left:120.00px;top:293.80px" class="cls_038"><span class="cls_038">Figure 7-13: Internally, Ruby 2.x saves small hashes</span></div>
<div style="position:absolute;left:120.00px;top:304.30px" class="cls_038"><span class="cls_038">with 6 or fewer elements as arrays.</span></div>
<div style="position:absolute;left:138.00px;top:326.80px" class="cls_007"><span class="cls_007">Ruby 2.x doesn’t use the </span><span class="cls_030">st_table_entry</span><span class="cls_007"> structure for small hashes, nor</span></div>
<div style="position:absolute;left:120.00px;top:338.80px" class="cls_007"><span class="cls_007">does it create a table of bins. Instead, it creates an array and saves the key/value</span></div>
<div style="position:absolute;left:120.00px;top:350.80px" class="cls_007"><span class="cls_007">pairs directly into this array. The array is large enough to fit 6 key/value pairs;</span></div>
<div style="position:absolute;left:120.00px;top:362.80px" class="cls_007"><span class="cls_007">once you insert a 7th key and value, Ruby discards the array, creates the bin</span></div>
<div style="position:absolute;left:120.00px;top:374.80px" class="cls_007"><span class="cls_007">array, and moves all 7 elements into </span><span class="cls_030">st_table_entry</span><span class="cls_007"> structures as usual by cal-</span></div>
<div style="position:absolute;left:120.00px;top:386.80px" class="cls_007"><span class="cls_007">culating hash values. This explains the small spike we saw inserting the 7th</span></div>
<div style="position:absolute;left:120.00px;top:398.80px" class="cls_007"><span class="cls_007">element in Figure 7-8 (page 179). </span><span class="cls_030">real_entries</span><span class="cls_007"> saves the number of values</span></div>
<div style="position:absolute;left:120.00px;top:410.80px" class="cls_007"><span class="cls_007">saved in the array between 0 and 6.</span></div>
<div style="position:absolute;left:138.00px;top:422.80px" class="cls_007"><span class="cls_007">In a packed hash, there are only 6 or fewer elements; thus, it’s faster for</span></div>
<div style="position:absolute;left:120.00px;top:434.80px" class="cls_007"><span class="cls_007">Ruby to iterate over the key values looking for a target value than it would</span></div>
<div style="position:absolute;left:120.00px;top:446.80px" class="cls_007"><span class="cls_007">be to calculate a hash value and use a bin array. Figure 7-14 shows how Ruby</span></div>
<div style="position:absolute;left:120.00px;top:458.80px" class="cls_007"><span class="cls_007">2.x retrieves an element from a packed hash.</span></div>
<div style="position:absolute;left:138.00px;top:470.80px" class="cls_007"><span class="cls_007">To find the value for a given key of </span><span class="cls_030">target</span><span class="cls_007">, Ruby iterates through the</span></div>
<div style="position:absolute;left:120.00px;top:482.80px" class="cls_007"><span class="cls_007">array and calls the </span><span class="cls_030">eql?</span><span class="cls_007"> method on each key value if the values are objects.</span></div>
<div style="position:absolute;left:120.00px;top:494.80px" class="cls_007"><span class="cls_007">For simple values, such as integers or symbols, Ruby just uses a numerical</span></div>
<div style="position:absolute;left:120.00px;top:506.80px" class="cls_007"><span class="cls_007">comparison. Ruby 2.x never calls the hash function at all for packed hashes.</span></div>
<div style="position:absolute;left:48.00px;top:633.00px" class="cls_020"><span class="cls_020">188</span></div>
<div style="position:absolute;left:74.29px;top:636.00px" class="cls_021"><span class="cls_021">Chapter 7</span></div>
</div>
<div style="position:absolute;left:50%;margin-left:-252px;top:141284px;width:504px;height:666px;border-style:outset;overflow:hidden">
<div style="position:absolute;left:0px;top:0px">
<img src="e698b76e-46bd-11eb-8b25-0cc47a792c0a_id_e698b76e-46bd-11eb-8b25-0cc47a792c0a_files/background213.jpg" width=504 height=666></div>
<div style="position:absolute;left:240.60px;top:48.59px" class="cls_141"><span class="cls_141">st_table</span></div>
<div style="position:absolute;left:128.67px;top:67.09px" class="cls_141"><span class="cls_141">RHash</span></div>
<div style="position:absolute;left:260.65px;top:66.82px" class="cls_142"><span class="cls_142">type</span></div>
<div style="position:absolute;left:150.73px;top:82.10px" class="cls_142"><span class="cls_142">tbl</span></div>
<div style="position:absolute;left:244.59px;top:88.22px" class="cls_142"><span class="cls_142">real_entries</span></div>
<div style="position:absolute;left:254.63px;top:108.95px" class="cls_142"><span class="cls_142">entries</span></div>
<div style="position:absolute;left:242.58px;top:146.45px" class="cls_142"><span class="cls_142">:key => value</span></div>
<div style="position:absolute;left:313.09px;top:146.45px" class="cls_142"><span class="cls_142">:key.eql?(target)</span></div>
<div style="position:absolute;left:238.57px;top:162.89px" class="cls_142"><span class="cls_142">:key2 => value2</span></div>
<div style="position:absolute;left:309.07px;top:163.21px" class="cls_142"><span class="cls_142">:key2.eql?(target)</span></div>
<div style="position:absolute;left:238.57px;top:179.33px" class="cls_142"><span class="cls_142">:key3 => value3</span></div>
<div style="position:absolute;left:309.07px;top:179.65px" class="cls_142"><span class="cls_142">:key3.eql?(target)</span></div>
<div style="position:absolute;left:238.57px;top:195.78px" class="cls_142"><span class="cls_142">:key4 => value4</span></div>
<div style="position:absolute;left:357.26px;top:195.77px" class="cls_142"><span class="cls_142">etc...</span></div>
<div style="position:absolute;left:238.57px;top:212.22px" class="cls_142"><span class="cls_142">:key5 => value5</span></div>
<div style="position:absolute;left:238.57px;top:228.66px" class="cls_142"><span class="cls_142">:key6 => value6</span></div>
<div style="position:absolute;left:123.00px;top:250.88px" class="cls_038"><span class="cls_038">Figure 7-14: For small hashes, Ruby 2.x iterates over the array to find</span></div>
<div style="position:absolute;left:123.00px;top:261.38px" class="cls_038"><span class="cls_038">a given key.</span></div>
<div style="position:absolute;left:69.00px;top:305.88px" class="cls_031"><span class="cls_031">Summary</span></div>
<div style="position:absolute;left:123.00px;top:325.88px" class="cls_007"><span class="cls_007">Understanding hash tables is key to understanding how Ruby works inter-</span></div>
<div style="position:absolute;left:123.00px;top:337.88px" class="cls_007"><span class="cls_007">nally because the speed and flexibility of hash tables allow Ruby to use</span></div>
<div style="position:absolute;left:123.00px;top:349.88px" class="cls_007"><span class="cls_007">them in many ways.</span></div>
<div style="position:absolute;left:141.00px;top:361.88px" class="cls_007"><span class="cls_007">At the beginning of this chapter, we learned how hash tables are able</span></div>
<div style="position:absolute;left:123.00px;top:373.88px" class="cls_007"><span class="cls_007">to return values quickly, regardless of how many elements are in the table.</span></div>
<div style="position:absolute;left:123.00px;top:385.88px" class="cls_007"><span class="cls_007">Next, we learned how Ruby automatically increases the size of a hash table</span></div>
<div style="position:absolute;left:123.00px;top:397.88px" class="cls_007"><span class="cls_007">as you add more and more elements to it. The user of the hash table doesn’t</span></div>
<div style="position:absolute;left:123.00px;top:409.88px" class="cls_007"><span class="cls_007">need to worry about how fast or large the table is. Hash tables will always be</span></div>
<div style="position:absolute;left:123.00px;top:421.88px" class="cls_007"><span class="cls_007">fast and will automatically expand as necessary.</span></div>
<div style="position:absolute;left:141.00px;top:433.88px" class="cls_007"><span class="cls_007">Finally, we looked at the importance of Ruby’s hash function. The hash</span></div>
<div style="position:absolute;left:123.00px;top:445.88px" class="cls_007"><span class="cls_007">table’s algorithm depends on the underlying hash function. With an effec-</span></div>
<div style="position:absolute;left:123.00px;top:457.88px" class="cls_007"><span class="cls_007">tive hash function, values are evenly distributed across the bins in the hash</span></div>
<div style="position:absolute;left:123.00px;top:469.88px" class="cls_007"><span class="cls_007">table with few collisions, allowing them to be saved and retrieved quickly.</span></div>
<div style="position:absolute;left:123.00px;top:481.88px" class="cls_007"><span class="cls_007">However, with a poor hash function, values would be saved in the same bin,</span></div>
<div style="position:absolute;left:123.00px;top:493.88px" class="cls_007"><span class="cls_007">leading to poor performance.</span></div>
<div style="position:absolute;left:298.49px;top:636.00px" class="cls_021"><span class="cls_021">The Hash Table: The Workhorse of Ruby Internals</span></div>
<div style="position:absolute;left:442.84px;top:633.00px" class="cls_020"><span class="cls_020">189</span></div>
</div>
<div style="position:absolute;left:50%;margin-left:-252px;top:141960px;width:504px;height:666px;border-style:outset;overflow:hidden">
<div style="position:absolute;left:0px;top:0px">
<img src="e698b76e-46bd-11eb-8b25-0cc47a792c0a_id_e698b76e-46bd-11eb-8b25-0cc47a792c0a_files/background214.jpg" width=504 height=666></div>
<div style="position:absolute;left:242.72px;top:295.91px" class="cls_024"><span class="cls_024">Blocks are Ruby’s</span></div>
<div style="position:absolute;left:240.32px;top:313.92px" class="cls_024"><span class="cls_024">implementation of</span></div>
<div style="position:absolute;left:266.87px;top:331.92px" class="cls_024"><span class="cls_024">closures.</span></div>
</div>
<div style="position:absolute;left:50%;margin-left:-252px;top:142636px;width:504px;height:666px;border-style:outset;overflow:hidden">
<div style="position:absolute;left:0px;top:0px">
<img src="e698b76e-46bd-11eb-8b25-0cc47a792c0a_id_e698b76e-46bd-11eb-8b25-0cc47a792c0a_files/background215.jpg" width=504 height=666></div>
<div style="position:absolute;left:260.10px;top:101.45px" class="cls_035"><span class="cls_035">8</span></div>
<div style="position:absolute;left:167.83px;top:253.45px" class="cls_016"><span class="cls_016">How Ruby Borrowed a</span></div>
<div style="position:absolute;left:137.89px;top:271.45px" class="cls_016"><span class="cls_016">Decades-Old Idea from Lisp</span></div>
<div style="position:absolute;left:123.00px;top:387.45px" class="cls_023"><span class="cls_023">Blocks are one of the most commonly used and pow-</span></div>
<div style="position:absolute;left:123.00px;top:405.46px" class="cls_023"><span class="cls_023">erful features of Ruby because they allow you to pass</span></div>
<div style="position:absolute;left:123.00px;top:423.45px" class="cls_023"><span class="cls_023">a code snippet to </span><span class="cls_028">Enumerable</span><span class="cls_023"> methods, such as </span><span class="cls_028">each</span><span class="cls_023">,</span></div>
<div style="position:absolute;left:123.00px;top:441.45px" class="cls_028"><span class="cls_028">detect</span><span class="cls_023">, or </span><span class="cls_028">inject</span><span class="cls_023">. Using the </span><span class="cls_028">yield</span><span class="cls_023"> keyword, you can also</span></div>
<div style="position:absolute;left:122.99px;top:459.46px" class="cls_023"><span class="cls_023">write your own custom iterators or functions that call</span></div>
<div style="position:absolute;left:122.99px;top:477.46px" class="cls_023"><span class="cls_023">blocks for other reasons. Ruby code containing blocks</span></div>
<div style="position:absolute;left:122.99px;top:495.46px" class="cls_023"><span class="cls_023">is often more succinct, elegant, and expressive than</span></div>
<div style="position:absolute;left:122.99px;top:513.47px" class="cls_023"><span class="cls_023">equivalent code in older languages, such as C.</span></div>
<div style="position:absolute;left:141.00px;top:532.45px" class="cls_007"><span class="cls_007">But don’t jump to the conclusion that blocks are a new idea! In fact,</span></div>
<div style="position:absolute;left:123.00px;top:544.45px" class="cls_007"><span class="cls_007">blocks are not new to Ruby at all. The computer science concept behind</span></div>
<div style="position:absolute;left:123.00px;top:556.45px" class="cls_007"><span class="cls_007">blocks, called </span><span class="cls_008">closures</span><span class="cls_007">, was first invented by Peter J. Landin in 1964, a few</span></div>
<div style="position:absolute;left:123.00px;top:568.45px" class="cls_007"><span class="cls_007">years after the original version of Lisp was created by John McCarthy in</span></div>
<div style="position:absolute;left:123.00px;top:580.45px" class="cls_007"><span class="cls_007">1958. Closures were later adopted by Lisp, or—more precisely—a dialect</span></div>
</div>
<div style="position:absolute;left:50%;margin-left:-252px;top:143312px;width:504px;height:666px;border-style:outset;overflow:hidden">
<div style="position:absolute;left:0px;top:0px">
<img src="e698b76e-46bd-11eb-8b25-0cc47a792c0a_id_e698b76e-46bd-11eb-8b25-0cc47a792c0a_files/background216.jpg" width=504 height=666></div>
<div style="position:absolute;left:120.00px;top:41.60px" class="cls_007"><span class="cls_007">of Lisp called </span><span class="cls_008">Scheme</span><span class="cls_007">, which was invented by Gerald Sussman and Guy Steele</span></div>
<div style="position:absolute;left:120.00px;top:53.60px" class="cls_007"><span class="cls_007">in 1975. Sussman and Steele’s use of closures in Scheme brought the idea to</span></div>
<div style="position:absolute;left:120.00px;top:65.60px" class="cls_007"><span class="cls_007">many programmers for the first time.</span></div>
<div style="position:absolute;left:138.00px;top:77.60px" class="cls_007"><span class="cls_007">But what does the word </span><span class="cls_008">closure</span><span class="cls_007"> actually mean in this context? In other</span></div>
<div style="position:absolute;left:120.00px;top:89.60px" class="cls_007"><span class="cls_007">words, exactly what are Ruby blocks? Are they just the snippet of Ruby code</span></div>
<div style="position:absolute;left:120.00px;top:101.60px" class="cls_007"><span class="cls_007">that appears between the </span><span class="cls_030">do</span><span class="cls_007"> and </span><span class="cls_030">end</span><span class="cls_007"> keywords? In this chapter I’ll review</span></div>
<div style="position:absolute;left:120.00px;top:113.60px" class="cls_007"><span class="cls_007">how Ruby implements blocks internally and demonstrate how they meet the</span></div>
<div style="position:absolute;left:120.00px;top:125.60px" class="cls_007"><span class="cls_007">definition of </span><span class="cls_008">closure</span><span class="cls_007"> used by Sussman and Steele back in 1975. I’ll also show</span></div>
<div style="position:absolute;left:120.00px;top:137.60px" class="cls_007"><span class="cls_007">how blocks, lambdas, and procs are all different ways of looking at closures.</span></div>
<div style="position:absolute;left:261.47px;top:181.31px" class="cls_020"><span class="cls_020">Roadmap</span></div>
<div style="position:absolute;left:132.00px;top:198.31px" class="cls_017"><span class="cls_017">Blocks: Closures in Ruby</span></div>
<div style="position:absolute;left:415.36px;top:198.31px" class="cls_017"><span class="cls_017">192</span></div>
<div style="position:absolute;left:150.00px;top:215.32px" class="cls_017"><span class="cls_017">Stepping Through How Ruby Calls a Block</span></div>
<div style="position:absolute;left:415.36px;top:215.32px" class="cls_017"><span class="cls_017">194</span></div>
<div style="position:absolute;left:150.00px;top:232.32px" class="cls_017"><span class="cls_017">Borrowing an Idea from 1975</span></div>
<div style="position:absolute;left:415.36px;top:232.32px" class="cls_017"><span class="cls_017">196</span></div>
<div style="position:absolute;left:150.00px;top:249.31px" class="cls_017"><span class="cls_017">The </span><span class="cls_030">rb_block_t</span><span class="cls_017"> and </span><span class="cls_030">rb_control_frame_t</span><span class="cls_017"> Structures</span></div>
<div style="position:absolute;left:415.37px;top:249.31px" class="cls_017"><span class="cls_017">198</span></div>
<div style="position:absolute;left:132.00px;top:266.31px" class="cls_019"><span class="cls_019">Experiment 8-1: Which Is Faster: A </span><span class="cls_040">while</span><span class="cls_019"> Loop or Passing a</span></div>
<div style="position:absolute;left:150.00px;top:277.31px" class="cls_019"><span class="cls_019">Block to </span><span class="cls_040">each</span><span class="cls_019">?</span></div>
<div style="position:absolute;left:416.40px;top:277.31px" class="cls_019"><span class="cls_019">200</span></div>
<div style="position:absolute;left:132.01px;top:294.31px" class="cls_017"><span class="cls_017">Lambdas and Procs: Treating a Function as a First-Class Citizen</span></div>
<div style="position:absolute;left:415.37px;top:294.31px" class="cls_017"><span class="cls_017">203</span></div>
<div style="position:absolute;left:150.01px;top:311.32px" class="cls_017"><span class="cls_017">Stack vs. Heap Memory</span></div>
<div style="position:absolute;left:415.37px;top:311.32px" class="cls_017"><span class="cls_017">204</span></div>
<div style="position:absolute;left:150.01px;top:328.32px" class="cls_017"><span class="cls_017">A Closer Look at How Ruby Saves a String Value</span></div>
<div style="position:absolute;left:415.37px;top:328.32px" class="cls_017"><span class="cls_017">204</span></div>
<div style="position:absolute;left:150.01px;top:345.32px" class="cls_017"><span class="cls_017">How Ruby Creates a Lambda</span></div>
<div style="position:absolute;left:415.37px;top:345.32px" class="cls_017"><span class="cls_017">207</span></div>
<div style="position:absolute;left:150.01px;top:362.32px" class="cls_017"><span class="cls_017">How Ruby Calls a Lambda</span></div>
<div style="position:absolute;left:415.37px;top:362.32px" class="cls_017"><span class="cls_017">209</span></div>
<div style="position:absolute;left:150.01px;top:379.32px" class="cls_017"><span class="cls_017">The Proc Object</span></div>
<div style="position:absolute;left:415.37px;top:379.32px" class="cls_017"><span class="cls_017">211</span></div>
<div style="position:absolute;left:132.01px;top:396.31px" class="cls_019"><span class="cls_019">Experiment 8-2: Changing Local Variables After Calling </span><span class="cls_040">lambda</span></div>
<div style="position:absolute;left:416.40px;top:396.31px" class="cls_019"><span class="cls_019">214</span></div>
<div style="position:absolute;left:150.01px;top:413.31px" class="cls_017"><span class="cls_017">Calling </span><span class="cls_030">lambda</span><span class="cls_017"> More Than Once in the Same Scope</span></div>
<div style="position:absolute;left:415.37px;top:413.31px" class="cls_017"><span class="cls_017">216</span></div>
<div style="position:absolute;left:132.00px;top:430.31px" class="cls_017"><span class="cls_017">Summary</span></div>
<div style="position:absolute;left:415.37px;top:430.31px" class="cls_017"><span class="cls_017">217</span></div>
<div style="position:absolute;left:66.00px;top:486.60px" class="cls_031"><span class="cls_031">Blocks: Closures in Ruby</span></div>
<div style="position:absolute;left:379.65px;top:499.18px" class="cls_042"><span class="cls_042">rb_block_t</span></div>
<div style="position:absolute;left:120.00px;top:506.60px" class="cls_007"><span class="cls_007">Internally, Ruby represents each block using a C</span></div>
<div style="position:absolute;left:402.63px;top:513.15px" class="cls_067"><span class="cls_067">??</span></div>
<div style="position:absolute;left:120.00px;top:518.60px" class="cls_007"><span class="cls_007">structure called </span><span class="cls_030">rb_block_t</span><span class="cls_007">, shown in Figure 8-1.</span></div>
<div style="position:absolute;left:120.00px;top:530.60px" class="cls_007"><span class="cls_007">By learning what Ruby stores in </span><span class="cls_030">rb_block_t</span><span class="cls_007">, we can</span></div>
<div style="position:absolute;left:120.00px;top:542.60px" class="cls_007"><span class="cls_007">find out exactly what a block is.</span></div>
<div style="position:absolute;left:373.00px;top:547.86px" class="cls_038"><span class="cls_038">Figure 8-1: What’s</span></div>
<div style="position:absolute;left:373.00px;top:558.35px" class="cls_038"><span class="cls_038">inside the </span><span class="cls_014">rb_block_t</span></div>
<div style="position:absolute;left:373.00px;top:568.85px" class="cls_038"><span class="cls_038">C structure?</span></div>
<div style="position:absolute;left:48.00px;top:633.00px" class="cls_020"><span class="cls_020">192</span></div>
<div style="position:absolute;left:74.07px;top:636.00px" class="cls_021"><span class="cls_021">Chapter 8</span></div>
</div>
<div style="position:absolute;left:50%;margin-left:-252px;top:143988px;width:504px;height:666px;border-style:outset;overflow:hidden">
<div style="position:absolute;left:0px;top:0px">
<img src="e698b76e-46bd-11eb-8b25-0cc47a792c0a_id_e698b76e-46bd-11eb-8b25-0cc47a792c0a_files/background217.jpg" width=504 height=666></div>
<div style="position:absolute;left:141.00px;top:42.28px" class="cls_007"><span class="cls_007">As we did in Chapter 5 with the </span><span class="cls_030">RClass</span><span class="cls_007"> structure, let’s deduce the con-</span></div>
<div style="position:absolute;left:123.00px;top:54.28px" class="cls_007"><span class="cls_007">tents of the </span><span class="cls_030">rb_block_t</span><span class="cls_007"> structure based on what we know blocks can do in</span></div>
<div style="position:absolute;left:123.00px;top:66.28px" class="cls_007"><span class="cls_007">Ruby. We’ll begin with the most obvious attribute of blocks. We know that</span></div>
<div style="position:absolute;left:123.00px;top:78.28px" class="cls_007"><span class="cls_007">each block must consist of a piece of Ruby code, or internally a set of com-</span></div>
<div style="position:absolute;left:123.00px;top:90.28px" class="cls_007"><span class="cls_007">piled YARV bytecode instructions. For example, suppose we call a method</span></div>
<div style="position:absolute;left:123.00px;top:102.28px" class="cls_007"><span class="cls_007">and pass a block as a parameter, as shown in Listing 8-1.</span></div>
<div style="position:absolute;left:123.00px;top:126.28px" class="cls_030"><span class="cls_030">10.times do</span></div>
<div style="position:absolute;left:131.50px;top:136.78px" class="cls_030"><span class="cls_030">str = "The quick brown fox jumps over the lazy dog."</span></div>
<div style="position:absolute;left:131.50px;top:147.27px" class="cls_030"><span class="cls_030">puts str</span></div>
<div style="position:absolute;left:123.00px;top:157.77px" class="cls_030"><span class="cls_030">end</span></div>
<div style="position:absolute;left:123.00px;top:180.27px" class="cls_038"><span class="cls_038">Listing 8-1: Superficially, a block is just a snippet of Ruby code.</span></div>
<div style="position:absolute;left:141.00px;top:202.78px" class="cls_007"><span class="cls_007">When executing the </span><span class="cls_030">10.times</span><span class="cls_007"> call, Ruby needs to know what code to iter-</span></div>
<div style="position:absolute;left:123.00px;top:214.78px" class="cls_007"><span class="cls_007">ate over. Therefore, the </span><span class="cls_030">rb_block_t</span><span class="cls_007"> structure must contain a pointer to that</span></div>
<div style="position:absolute;left:123.00px;top:226.78px" class="cls_007"><span class="cls_007">code, as shown in Figure 8-2.</span></div>
<div style="position:absolute;left:134.00px;top:255.50px" class="cls_014"><span class="cls_014">putstring</span></div>
<div style="position:absolute;left:194.00px;top:256.16px" class="cls_014"><span class="cls_014">"The quick brown fox..."</span></div>
<div style="position:absolute;left:134.00px;top:265.10px" class="cls_014"><span class="cls_014">setlocal</span></div>
<div style="position:absolute;left:194.00px;top:265.16px" class="cls_014"><span class="cls_014">2, 0</span></div>
<div style="position:absolute;left:378.29px;top:265.54px" class="cls_042"><span class="cls_042">rb_block_t</span></div>
<div style="position:absolute;left:134.00px;top:274.70px" class="cls_014"><span class="cls_014">putself</span></div>
<div style="position:absolute;left:397.28px;top:279.50px" class="cls_014"><span class="cls_014">iseq</span></div>
<div style="position:absolute;left:134.00px;top:284.30px" class="cls_014"><span class="cls_014">getlocal</span></div>
<div style="position:absolute;left:194.00px;top:283.16px" class="cls_014"><span class="cls_014">2, 0</span></div>
<div style="position:absolute;left:134.00px;top:293.90px" class="cls_014"><span class="cls_014">send</span></div>
<div style="position:absolute;left:194.00px;top:292.76px" class="cls_014"><span class="cls_014">&lt;callinfo!mid:puts, argc:1...</span></div>
<div style="position:absolute;left:134.00px;top:303.50px" class="cls_014"><span class="cls_014">leave</span></div>
<div style="position:absolute;left:123.00px;top:329.18px" class="cls_038"><span class="cls_038">Figure 8-2: The </span><span class="cls_014">rb_block_t</span><span class="cls_038"> structure contains a pointer to a snippet of YARV instructions.</span></div>
<div style="position:absolute;left:141.00px;top:351.68px" class="cls_007"><span class="cls_007">The value </span><span class="cls_030">iseq</span><span class="cls_007"> is a pointer to the YARV instructions for the Ruby code</span></div>
<div style="position:absolute;left:123.00px;top:363.68px" class="cls_007"><span class="cls_007">in the block.</span></div>
<div style="position:absolute;left:141.00px;top:375.68px" class="cls_007"><span class="cls_007">Another obvious but often overlooked behavior of blocks is that they</span></div>
<div style="position:absolute;left:123.00px;top:387.68px" class="cls_007"><span class="cls_007">can access variables in the surrounding or parent Ruby scope, as shown in</span></div>
<div style="position:absolute;left:123.00px;top:399.68px" class="cls_007"><span class="cls_007">Listing 8-2.</span></div>
<div style="position:absolute;left:111.15px;top:423.68px" class="cls_046"><span class="cls_046">u</span><span class="cls_030"> str = "The quick brown fox"</span></div>
<div style="position:absolute;left:111.15px;top:434.18px" class="cls_046"><span class="cls_046">v</span><span class="cls_030"> 10.times do</span></div>
<div style="position:absolute;left:111.15px;top:444.67px" class="cls_046"><span class="cls_046">w</span><span class="cls_030">   str2 = "jumps over the lazy dog."</span></div>
<div style="position:absolute;left:111.15px;top:455.17px" class="cls_046"><span class="cls_046">x</span><span class="cls_030">   puts "#{str} #{str2}"</span></div>
<div style="position:absolute;left:123.00px;top:465.67px" class="cls_030"><span class="cls_030">end</span></div>
<div style="position:absolute;left:123.00px;top:488.17px" class="cls_038"><span class="cls_038">Listing 8-2: The code inside the block accesses the variable </span><span class="cls_014">str</span><span class="cls_038"> from the surrounding code.</span></div>
<div style="position:absolute;left:141.00px;top:510.68px" class="cls_007"><span class="cls_007">Here the </span><span class="cls_030">puts</span><span class="cls_007"> function call at </span><span class="cls_050">x</span><span class="cls_007"> refers equally to the </span><span class="cls_030">str2</span><span class="cls_007"> variable</span></div>
<div style="position:absolute;left:123.00px;top:522.68px" class="cls_007"><span class="cls_007">inside the block and the </span><span class="cls_030">str</span><span class="cls_007"> variable defined in the surrounding code at </span><span class="cls_050">u</span><span class="cls_007">.</span></div>
<div style="position:absolute;left:123.00px;top:534.68px" class="cls_007"><span class="cls_007">Obviously blocks can access values from the code surrounding them. This</span></div>
<div style="position:absolute;left:123.00px;top:546.68px" class="cls_007"><span class="cls_007">ability is one of the things that makes blocks useful.</span></div>
<div style="position:absolute;left:290.51px;top:636.00px" class="cls_021"><span class="cls_021">How Ruby Borrowed a Decades-Old Idea from Lisp</span></div>
<div style="position:absolute;left:442.97px;top:633.00px" class="cls_020"><span class="cls_020">193</span></div>
</div>
<div style="position:absolute;left:50%;margin-left:-252px;top:144664px;width:504px;height:666px;border-style:outset;overflow:hidden">
<div style="position:absolute;left:0px;top:0px">
<img src="e698b76e-46bd-11eb-8b25-0cc47a792c0a_id_e698b76e-46bd-11eb-8b25-0cc47a792c0a_files/background218.jpg" width=504 height=666></div>
<div style="position:absolute;left:138.00px;top:41.60px" class="cls_007"><span class="cls_007">Blocks have in some sense a dual personality. On the one hand, they</span></div>
<div style="position:absolute;left:120.00px;top:53.60px" class="cls_007"><span class="cls_007">behave like separate methods: You can call them and pass them arguments</span></div>
<div style="position:absolute;left:120.00px;top:65.60px" class="cls_007"><span class="cls_007">just as you would any method. On the other hand, they’re part of the sur-</span></div>
<div style="position:absolute;left:120.00px;top:77.60px" class="cls_007"><span class="cls_007">rounding function or method.</span></div>
<div style="position:absolute;left:120.00px;top:108.60px" class="cls_055"><span class="cls_055">Stepping Through How Ruby Calls a Block</span></div>
<div style="position:absolute;left:120.00px;top:126.60px" class="cls_007"><span class="cls_007">How does this work internally? Does Ruby implement blocks as separate</span></div>
<div style="position:absolute;left:120.00px;top:138.60px" class="cls_007"><span class="cls_007">methods or as part of the surrounding method? Let’s step through Listing 8-2</span></div>
<div style="position:absolute;left:120.00px;top:150.60px" class="cls_007"><span class="cls_007">to see what happens inside Ruby when you call a block.</span></div>
<div style="position:absolute;left:138.00px;top:162.60px" class="cls_007"><span class="cls_007">When Ruby executes the first line of code from Listing 8-2 at </span><span class="cls_050">u</span><span class="cls_007">,</span></div>
<div style="position:absolute;left:120.00px;top:174.60px" class="cls_030"><span class="cls_030">str = "The quick brown fox"</span><span class="cls_007">, YARV stores the local variable </span><span class="cls_030">str</span><span class="cls_007"> on its inter-</span></div>
<div style="position:absolute;left:120.00px;top:186.60px" class="cls_007"><span class="cls_007">nal stack. YARV tracks the location of </span><span class="cls_030">str</span><span class="cls_007"> using the </span><span class="cls_030">EP</span><span class="cls_007">, or environment</span></div>
<div style="position:absolute;left:120.00px;top:198.60px" class="cls_007"><span class="cls_007">pointer, located in the current </span><span class="cls_030">rb_control_frame_t</span><span class="cls_007"> structure, as shown in</span></div>
<div style="position:absolute;left:120.00px;top:209.00px" class="cls_007"><span class="cls_007">Figure 8-3.</span><span class="cls_027"><sup>1</sup></span></div>
<div style="position:absolute;left:140.69px;top:247.52px" class="cls_054"><span class="cls_054">YARV internal stack</span></div>
<div style="position:absolute;left:290.00px;top:253.52px" class="cls_054"><span class="cls_054">Stack frame for</span></div>
<div style="position:absolute;left:290.00px;top:263.12px" class="cls_054"><span class="cls_054">top-level scope</span></div>
<div style="position:absolute;left:275.83px;top:282.64px" class="cls_042"><span class="cls_042">rb_control_frame_t</span></div>
<div style="position:absolute;left:156.83px;top:296.60px" class="cls_014"><span class="cls_014">locals: str</span></div>
<div style="position:absolute;left:312.34px;top:296.60px" class="cls_014"><span class="cls_014">EP</span></div>
<div style="position:absolute;left:120.00px;top:338.00px" class="cls_038"><span class="cls_038">Figure 8-3: Ruby saves the local variable </span><span class="cls_014">str</span><span class="cls_038"> on the stack.</span></div>
<div style="position:absolute;left:138.00px;top:366.50px" class="cls_007"><span class="cls_007">Next, Ruby reaches the </span><span class="cls_030">10.times do</span><span class="cls_007"> call at </span><span class="cls_050">v</span><span class="cls_007"> in Listing 8-2. Before</span></div>
<div style="position:absolute;left:120.00px;top:378.50px" class="cls_007"><span class="cls_007">executing the actual iteration—that is, before calling the </span><span class="cls_030">times</span><span class="cls_007"> method—</span></div>
<div style="position:absolute;left:120.00px;top:390.50px" class="cls_007"><span class="cls_007">Ruby creates and initializes a new </span><span class="cls_030">rb_block_t</span><span class="cls_007"> structure to represent the</span></div>
<div style="position:absolute;left:120.00px;top:402.50px" class="cls_007"><span class="cls_007">block. Ruby needs to create the block structure now because the block is</span></div>
<div style="position:absolute;left:120.00px;top:414.50px" class="cls_007"><span class="cls_007">really just another argument to the </span><span class="cls_030">times</span><span class="cls_007"> method. Figure 8-4 shows this</span></div>
<div style="position:absolute;left:120.00px;top:426.50px" class="cls_007"><span class="cls_007">new </span><span class="cls_030">rb_block_t</span><span class="cls_007"> structure.</span></div>
<div style="position:absolute;left:138.00px;top:438.50px" class="cls_007"><span class="cls_007">When creating the new block structure, Ruby copies the current value</span></div>
<div style="position:absolute;left:120.00px;top:450.50px" class="cls_007"><span class="cls_007">of the </span><span class="cls_030">EP</span><span class="cls_007"> into the new block. In other words, Ruby saves the location of the</span></div>
<div style="position:absolute;left:120.00px;top:462.50px" class="cls_007"><span class="cls_007">current stack frame in the new block.</span></div>
<div style="position:absolute;left:120.00px;top:583.00px" class="cls_014"><span class="cls_014">1. If the outer code was located inside a function or method, then the </span><span class="cls_015">EP</span><span class="cls_014"> would point to the</span></div>
<div style="position:absolute;left:120.00px;top:593.00px" class="cls_014"><span class="cls_014">stack frame as shown. But if the outer code was located in the top-level scope of your Ruby</span></div>
<div style="position:absolute;left:120.00px;top:603.00px" class="cls_014"><span class="cls_014">program, then Ruby would use dynamic access to save the variable in the </span><span class="cls_015">TOPLEVEL_BINDING</span></div>
<div style="position:absolute;left:120.00px;top:613.00px" class="cls_014"><span class="cls_014">environment instead. Regardless, the </span><span class="cls_015">EP</span><span class="cls_014"> will always indicate the location of the </span><span class="cls_015">str</span><span class="cls_014"> variable.</span></div>
<div style="position:absolute;left:48.00px;top:633.00px" class="cls_020"><span class="cls_020">194</span></div>
<div style="position:absolute;left:74.03px;top:636.00px" class="cls_021"><span class="cls_021">Chapter 8</span></div>
</div>
<div style="position:absolute;left:50%;margin-left:-252px;top:145340px;width:504px;height:666px;border-style:outset;overflow:hidden">
<div style="position:absolute;left:0px;top:0px">
<img src="e698b76e-46bd-11eb-8b25-0cc47a792c0a_id_e698b76e-46bd-11eb-8b25-0cc47a792c0a_files/background219.jpg" width=504 height=666></div>
<div style="position:absolute;left:278.83px;top:49.58px" class="cls_042"><span class="cls_042">rb_block_t</span></div>
<div style="position:absolute;left:311.34px;top:63.54px" class="cls_014"><span class="cls_014">iseq</span></div>
<div style="position:absolute;left:315.33px;top:94.49px" class="cls_014"><span class="cls_014">EP</span></div>
<div style="position:absolute;left:143.69px;top:128.16px" class="cls_054"><span class="cls_054">YARV internal stack</span></div>
<div style="position:absolute;left:278.83px;top:164.28px" class="cls_042"><span class="cls_042">rb_control_frame_t</span></div>
<div style="position:absolute;left:159.83px;top:177.24px" class="cls_014"><span class="cls_014">locals: str</span></div>
<div style="position:absolute;left:315.34px;top:178.24px" class="cls_014"><span class="cls_014">EP</span></div>
<div style="position:absolute;left:293.00px;top:207.91px" class="cls_054"><span class="cls_054">Stack frame for</span></div>
<div style="position:absolute;left:293.80px;top:217.51px" class="cls_054"><span class="cls_054">top-level scope</span></div>
<div style="position:absolute;left:123.00px;top:235.85px" class="cls_038"><span class="cls_038">Figure 8-4: Ruby creates a new </span><span class="cls_014">rb_block_t</span><span class="cls_038"> structure before calling</span></div>
<div style="position:absolute;left:123.00px;top:246.35px" class="cls_038"><span class="cls_038">the method and passing the block to it.</span></div>
<div style="position:absolute;left:141.00px;top:268.85px" class="cls_007"><span class="cls_007">Next, Ruby calls the </span><span class="cls_030">times</span><span class="cls_007"> method on the object </span><span class="cls_030">10</span><span class="cls_007">, an instance of the</span></div>
<div style="position:absolute;left:123.00px;top:280.85px" class="cls_030"><span class="cls_030">Fixnum</span><span class="cls_007"> class. While doing this, YARV creates a new frame on its internal</span></div>
<div style="position:absolute;left:123.00px;top:292.85px" class="cls_007"><span class="cls_007">stack. Now we have two stack frames: above, a new stack frame for the</span></div>
<div style="position:absolute;left:123.00px;top:304.85px" class="cls_030"><span class="cls_030">Fixnum.times</span><span class="cls_007"> method, and below, the original stack frame used by the top-</span></div>
<div style="position:absolute;left:123.00px;top:316.85px" class="cls_007"><span class="cls_007">level function (see Figure 8-5).</span></div>
<div style="position:absolute;left:143.69px;top:347.77px" class="cls_054"><span class="cls_054">YARV internal stack</span></div>
<div style="position:absolute;left:262.83px;top:374.89px" class="cls_042"><span class="cls_042">rb_control_frame_t</span></div>
<div style="position:absolute;left:262.91px;top:419.66px" class="cls_054"><span class="cls_054">Stack frame for internal</span></div>
<div style="position:absolute;left:265.46px;top:429.26px" class="cls_014"><span class="cls_014">Fixnum.times</span><span class="cls_054"> C code</span></div>
<div style="position:absolute;left:159.83px;top:436.85px" class="cls_014"><span class="cls_014">locals: str</span></div>
<div style="position:absolute;left:123.00px;top:492.25px" class="cls_038"><span class="cls_038">Figure 8-5: Ruby creates a new stack frame when it executes</span></div>
<div style="position:absolute;left:123.00px;top:502.75px" class="cls_038"><span class="cls_038">the </span><span class="cls_014">10.times</span><span class="cls_038"> call.</span></div>
<div style="position:absolute;left:141.00px;top:525.25px" class="cls_007"><span class="cls_007">Ruby implements the </span><span class="cls_030">times</span><span class="cls_007"> method internally using its own C code.</span></div>
<div style="position:absolute;left:123.00px;top:537.25px" class="cls_007"><span class="cls_007">Although this is a built-in method, Ruby implements it just as you probably</span></div>
<div style="position:absolute;left:123.00px;top:549.25px" class="cls_007"><span class="cls_007">would. Ruby starts to iterate over the numbers 0, 1, 2, and so on, up to 9,</span></div>
<div style="position:absolute;left:123.00px;top:561.25px" class="cls_007"><span class="cls_007">and then it calls </span><span class="cls_030">yield</span><span class="cls_007">, calling the block once for each of these integers.</span></div>
<div style="position:absolute;left:123.00px;top:573.25px" class="cls_007"><span class="cls_007">Finally, the code that implements </span><span class="cls_030">yield</span><span class="cls_007"> internally calls the block each time</span></div>
<div style="position:absolute;left:123.00px;top:585.25px" class="cls_007"><span class="cls_007">it moves through the loop, pushing a third frame onto the top of the stack</span></div>
<div style="position:absolute;left:123.00px;top:597.25px" class="cls_007"><span class="cls_007">for the code inside the block to use. Figure 8-6 shows this third stack frame.</span></div>
<div style="position:absolute;left:290.58px;top:636.00px" class="cls_021"><span class="cls_021">How Ruby Borrowed a Decades-Old Idea from Lisp</span></div>
<div style="position:absolute;left:443.04px;top:633.00px" class="cls_020"><span class="cls_020">195</span></div>
</div>
<div style="position:absolute;left:50%;margin-left:-252px;top:146016px;width:504px;height:666px;border-style:outset;overflow:hidden">
<div style="position:absolute;left:0px;top:0px">
<img src="e698b76e-46bd-11eb-8b25-0cc47a792c0a_id_e698b76e-46bd-11eb-8b25-0cc47a792c0a_files/background220.jpg" width=504 height=666></div>
<div style="position:absolute;left:140.69px;top:54.02px" class="cls_054"><span class="cls_054">YARV internal stack</span></div>
<div style="position:absolute;left:265.76px;top:60.90px" class="cls_054"><span class="cls_054">Stack frame for block code</span></div>
<div style="position:absolute;left:271.83px;top:81.14px" class="cls_042"><span class="cls_042">rb_control_frame_t</span></div>
<div style="position:absolute;left:156.83px;top:95.10px" class="cls_014"><span class="cls_014">locals: str2</span></div>
<div style="position:absolute;left:176.83px;top:109.82px" class="cls_014"><span class="cls_014">EP</span></div>
<div style="position:absolute;left:271.83px;top:166.47px" class="cls_042"><span class="cls_042">rb_block_t</span></div>
<div style="position:absolute;left:304.33px;top:180.43px" class="cls_014"><span class="cls_014">iseq</span></div>
<div style="position:absolute;left:156.83px;top:196.60px" class="cls_014"><span class="cls_014">locals: str</span></div>
<div style="position:absolute;left:308.33px;top:211.38px" class="cls_014"><span class="cls_014">EP</span></div>
<div style="position:absolute;left:120.00px;top:244.80px" class="cls_038"><span class="cls_038">Figure 8-6: Ruby creates a third stack frame when the </span><span class="cls_014">10.times</span></div>
<div style="position:absolute;left:120.00px;top:255.30px" class="cls_038"><span class="cls_038">method yields to the block.</span></div>
<div style="position:absolute;left:138.00px;top:277.80px" class="cls_007"><span class="cls_007">On the left side of the figure, we now have three stack frames:</span></div>
<div style="position:absolute;left:120.00px;top:298.80px" class="cls_050"><span class="cls_050">•</span><span class="cls_007">   On the top is the new stack frame for the block, containing the </span><span class="cls_030">str2</span></div>
<div style="position:absolute;left:138.01px;top:310.80px" class="cls_007"><span class="cls_007">variable defined at </span><span class="cls_050">w</span><span class="cls_007"> in Listing 8-2.</span></div>
<div style="position:absolute;left:120.00px;top:325.80px" class="cls_050"><span class="cls_050">•</span><span class="cls_007">   In the middle is the stack frame used by the internal C code that imple-</span></div>
<div style="position:absolute;left:138.01px;top:337.80px" class="cls_007"><span class="cls_007">ments the </span><span class="cls_030">Fixnum#times</span><span class="cls_007"> method.</span></div>
<div style="position:absolute;left:120.00px;top:352.80px" class="cls_050"><span class="cls_050">•</span><span class="cls_007">   And at the bottom is the original function’s stack frame, containing the</span></div>
<div style="position:absolute;left:138.00px;top:364.80px" class="cls_030"><span class="cls_030">str</span><span class="cls_007"> variable defined at </span><span class="cls_050">u</span><span class="cls_007"> in Listing 8-2.</span></div>
<div style="position:absolute;left:138.00px;top:385.80px" class="cls_007"><span class="cls_007">While creating the new stack frame, Ruby’s internal </span><span class="cls_030">yield</span><span class="cls_007"> code copies the</span></div>
<div style="position:absolute;left:120.00px;top:397.80px" class="cls_030"><span class="cls_030">EP</span><span class="cls_007"> from the block into the new stack frame. Now the code inside the block</span></div>
<div style="position:absolute;left:120.00px;top:409.80px" class="cls_007"><span class="cls_007">can access both its local variables, directly via the </span><span class="cls_030">rb_control_frame_t</span><span class="cls_007"> structure,</span></div>
<div style="position:absolute;left:120.00px;top:421.80px" class="cls_007"><span class="cls_007">and the variables from the parent scope, indirectly via the </span><span class="cls_030">EP</span><span class="cls_007"> pointer using</span></div>
<div style="position:absolute;left:120.00px;top:433.80px" class="cls_007"><span class="cls_007">dynamic variable access. Specifically, this allows the </span><span class="cls_030">puts</span><span class="cls_007"> statement at </span><span class="cls_050">x</span><span class="cls_007"> in</span></div>
<div style="position:absolute;left:120.00px;top:445.80px" class="cls_007"><span class="cls_007">Listing 8-2 to access the </span><span class="cls_030">str2</span><span class="cls_007"> variable from the parent scope.</span></div>
<div style="position:absolute;left:120.00px;top:470.80px" class="cls_055"><span class="cls_055">Borrowing an Idea from 1975</span></div>
<div style="position:absolute;left:120.00px;top:488.80px" class="cls_007"><span class="cls_007">So far we’ve seen that Ruby’s </span><span class="cls_030">rb_block_t</span><span class="cls_007"> structure contains two important</span></div>
<div style="position:absolute;left:120.00px;top:500.80px" class="cls_007"><span class="cls_007">values:</span></div>
<div style="position:absolute;left:120.00px;top:521.80px" class="cls_050"><span class="cls_050">•</span><span class="cls_007">   A pointer to a snippet of YARV code instructions—the </span><span class="cls_030">iseq</span><span class="cls_007"> pointer</span></div>
<div style="position:absolute;left:120.00px;top:536.80px" class="cls_050"><span class="cls_050">•</span><span class="cls_007">   A pointer to a location on YARV’s internal stack, the location that was</span></div>
<div style="position:absolute;left:138.00px;top:548.80px" class="cls_007"><span class="cls_007">at the top of the stack when the block was created—the </span><span class="cls_030">EP</span><span class="cls_007"> pointer</span></div>
<div style="position:absolute;left:138.00px;top:569.80px" class="cls_007"><span class="cls_007">Figure 8-7 shows these two values in the </span><span class="cls_030">rb_block_t</span><span class="cls_007"> structure.</span></div>
<div style="position:absolute;left:48.00px;top:633.00px" class="cls_020"><span class="cls_020">196</span></div>
<div style="position:absolute;left:74.03px;top:636.00px" class="cls_021"><span class="cls_021">Chapter 8</span></div>
</div>
<div style="position:absolute;left:50%;margin-left:-252px;top:146692px;width:504px;height:666px;border-style:outset;overflow:hidden">
<div style="position:absolute;left:0px;top:0px">
<img src="e698b76e-46bd-11eb-8b25-0cc47a792c0a_id_e698b76e-46bd-11eb-8b25-0cc47a792c0a_files/background221.jpg" width=504 height=666></div>
<div style="position:absolute;left:134.00px;top:51.32px" class="cls_014"><span class="cls_014">putstring</span></div>
<div style="position:absolute;left:194.00px;top:51.98px" class="cls_014"><span class="cls_014">"jumps over the lazy dog."</span></div>
<div style="position:absolute;left:134.00px;top:60.92px" class="cls_014"><span class="cls_014">setlocal</span></div>
<div style="position:absolute;left:194.00px;top:60.98px" class="cls_014"><span class="cls_014">2, 0</span></div>
<div style="position:absolute;left:134.00px;top:70.52px" class="cls_014"><span class="cls_014">putself</span></div>
<div style="position:absolute;left:134.00px;top:80.12px" class="cls_014"><span class="cls_014">getlocal</span></div>
<div style="position:absolute;left:194.00px;top:78.98px" class="cls_014"><span class="cls_014">2, 1</span></div>
<div style="position:absolute;left:368.33px;top:82.27px" class="cls_042"><span class="cls_042">rb_block_t</span></div>
<div style="position:absolute;left:134.00px;top:89.72px" class="cls_014"><span class="cls_014">tostring</span></div>
<div style="position:absolute;left:400.83px;top:96.23px" class="cls_014"><span class="cls_014">iseq</span></div>
<div style="position:absolute;left:134.00px;top:99.32px" class="cls_014"><span class="cls_014">etc...</span></div>
<div style="position:absolute;left:404.83px;top:127.18px" class="cls_014"><span class="cls_014">EP</span></div>
<div style="position:absolute;left:233.19px;top:148.77px" class="cls_054"><span class="cls_054">YARV internal stack</span></div>
<div style="position:absolute;left:249.33px;top:197.85px" class="cls_014"><span class="cls_014">locals: str</span></div>
<div style="position:absolute;left:123.00px;top:239.25px" class="cls_038"><span class="cls_038">Figure 8-7: So far we’ve seen that Ruby blocks contain a pointer to a YARV instruction</span></div>
<div style="position:absolute;left:123.00px;top:249.75px" class="cls_038"><span class="cls_038">snippet and a location on the YARV stack.</span></div>
<div style="position:absolute;left:141.00px;top:272.25px" class="cls_007"><span class="cls_007">We also saw that Ruby uses the </span><span class="cls_030">EP</span></div>
<div style="position:absolute;left:123.00px;top:284.25px" class="cls_007"><span class="cls_007">when a block accesses values from the sur-</span></div>
<div style="position:absolute;left:123.00px;top:296.25px" class="cls_007"><span class="cls_007">rounding code. At first, this seems like a</span></div>
<div style="position:absolute;left:123.00px;top:308.25px" class="cls_007"><span class="cls_007">very technical, unimportant detail. This</span></div>
<div style="position:absolute;left:123.00px;top:320.25px" class="cls_007"><span class="cls_007">is obviously a behavior we expect Ruby</span></div>
<div style="position:absolute;left:123.00px;top:332.25px" class="cls_007"><span class="cls_007">blocks to exhibit, and the </span><span class="cls_030">EP</span><span class="cls_007"> seems to be a</span></div>
<div style="position:absolute;left:123.00px;top:344.25px" class="cls_007"><span class="cls_007">minor, uninteresting part of Ruby’s inter-</span></div>
<div style="position:absolute;left:123.00px;top:356.25px" class="cls_007"><span class="cls_007">nal implementation of blocks. Or is it?</span></div>
<div style="position:absolute;left:141.00px;top:368.25px" class="cls_007"><span class="cls_007">The </span><span class="cls_030">EP</span><span class="cls_007"> is actually a profoundly impor-</span></div>
<div style="position:absolute;left:123.00px;top:380.25px" class="cls_007"><span class="cls_007">tant part of Ruby internals. It’s the basis</span></div>
<div style="position:absolute;left:330.70px;top:384.65px" class="cls_038"><span class="cls_038">The IBM 704, above, was the first</span></div>
<div style="position:absolute;left:123.00px;top:392.25px" class="cls_007"><span class="cls_007">for Ruby’s implementation of </span><span class="cls_008">closures</span><span class="cls_007">, the</span></div>
<div style="position:absolute;left:330.70px;top:395.15px" class="cls_038"><span class="cls_038">computer to run Lisp, in the early</span></div>
<div style="position:absolute;left:123.00px;top:404.25px" class="cls_007"><span class="cls_007">computer science concept introduced in</span></div>
<div style="position:absolute;left:330.70px;top:405.65px" class="cls_038"><span class="cls_038">1960s. </span><span class="cls_043">(Credit: NASA)</span></div>
<div style="position:absolute;left:123.00px;top:416.25px" class="cls_007"><span class="cls_007">Lisp long before Ruby was created in the</span></div>
<div style="position:absolute;left:123.00px;top:428.25px" class="cls_007"><span class="cls_007">1990s. Here’s how Sussman and Steele</span></div>
<div style="position:absolute;left:123.00px;top:440.25px" class="cls_007"><span class="cls_007">defined the term </span><span class="cls_008">closure</span><span class="cls_007"> in 1975:</span></div>
<div style="position:absolute;left:159.00px;top:459.25px" class="cls_033"><span class="cls_033">In order to solve this problem we introduce the notion of a closure</span></div>
<div style="position:absolute;left:159.00px;top:471.25px" class="cls_033"><span class="cls_033">[11, 14] which is a data structure containing a lambda expression,</span></div>
<div style="position:absolute;left:159.00px;top:483.24px" class="cls_033"><span class="cls_033">and an environment to be used when that lambda expression is</span></div>
<div style="position:absolute;left:159.00px;top:493.81px" class="cls_033"><span class="cls_033">applied to arguments.</span><span class="cls_143"><sup>2</sup></span></div>
<div style="position:absolute;left:141.00px;top:512.25px" class="cls_007"><span class="cls_007">They define a closure to be the combination of the following:</span></div>
<div style="position:absolute;left:123.00px;top:533.25px" class="cls_050"><span class="cls_050">•</span><span class="cls_007">   A “lambda expression”—that is, a function that takes a set of arguments</span></div>
<div style="position:absolute;left:123.00px;top:548.25px" class="cls_050"><span class="cls_050">•</span><span class="cls_007">   An environment to be used when calling that lambda or function</span></div>
<div style="position:absolute;left:123.00px;top:603.00px" class="cls_014"><span class="cls_014">2. Gerald J. Sussman and Guy L. Steele, Jr., “Scheme: An Interpreter for Extended Lambda</span></div>
<div style="position:absolute;left:123.00px;top:613.00px" class="cls_014"><span class="cls_014">Calculus” (MIT Artificial Intelligence Laboratory, AI Memo No. 349, December 1975).</span></div>
<div style="position:absolute;left:290.59px;top:636.00px" class="cls_021"><span class="cls_021">How Ruby Borrowed a Decades-Old Idea from Lisp</span></div>
<div style="position:absolute;left:443.06px;top:633.00px" class="cls_020"><span class="cls_020">197</span></div>
</div>
<div style="position:absolute;left:50%;margin-left:-252px;top:147368px;width:504px;height:666px;border-style:outset;overflow:hidden">
<div style="position:absolute;left:0px;top:0px">
<img src="e698b76e-46bd-11eb-8b25-0cc47a792c0a_id_e698b76e-46bd-11eb-8b25-0cc47a792c0a_files/background222.jpg" width=504 height=666></div>
<div style="position:absolute;left:138.00px;top:42.28px" class="cls_007"><span class="cls_007">Let’s take another look at the internal </span><span class="cls_030">rb_block_t</span><span class="cls_007"> structure, repeated for</span></div>
<div style="position:absolute;left:120.00px;top:54.28px" class="cls_007"><span class="cls_007">convenience in Figure 8-8.</span></div>
<div style="position:absolute;left:131.00px;top:83.00px" class="cls_014"><span class="cls_014">putstring</span></div>
<div style="position:absolute;left:191.00px;top:83.66px" class="cls_014"><span class="cls_014">"jumps over the lazy dog."</span></div>
<div style="position:absolute;left:131.00px;top:92.60px" class="cls_014"><span class="cls_014">setlocal</span></div>
<div style="position:absolute;left:191.00px;top:92.66px" class="cls_014"><span class="cls_014">2, 0</span></div>
<div style="position:absolute;left:131.00px;top:102.20px" class="cls_014"><span class="cls_014">putself</span></div>
<div style="position:absolute;left:131.00px;top:111.80px" class="cls_014"><span class="cls_014">getlocal</span></div>
<div style="position:absolute;left:191.00px;top:110.66px" class="cls_014"><span class="cls_014">2, 1</span></div>
<div style="position:absolute;left:365.33px;top:113.95px" class="cls_042"><span class="cls_042">rb_block_t</span></div>
<div style="position:absolute;left:131.00px;top:121.40px" class="cls_014"><span class="cls_014">tostring</span></div>
<div style="position:absolute;left:397.83px;top:127.91px" class="cls_014"><span class="cls_014">iseq</span></div>
<div style="position:absolute;left:131.00px;top:131.00px" class="cls_014"><span class="cls_014">etc...</span></div>
<div style="position:absolute;left:401.83px;top:158.86px" class="cls_014"><span class="cls_014">EP</span></div>
<div style="position:absolute;left:230.19px;top:180.45px" class="cls_054"><span class="cls_054">YARV internal stack</span></div>
<div style="position:absolute;left:246.33px;top:229.53px" class="cls_014"><span class="cls_014">locals: str</span></div>
<div style="position:absolute;left:120.00px;top:270.93px" class="cls_038"><span class="cls_038">Figure 8-8: Blocks are the combination of a function and the environment to use when</span></div>
<div style="position:absolute;left:120.00px;top:281.43px" class="cls_038"><span class="cls_038">calling that function.</span></div>
<div style="position:absolute;left:138.00px;top:303.93px" class="cls_007"><span class="cls_007">This structure meets Sussman and Steele’s definition of a closure:</span></div>
<div style="position:absolute;left:120.00px;top:324.93px" class="cls_050"><span class="cls_050">•</span><span class="cls_030">   iseq</span><span class="cls_007"> is a pointer to a lambda expression—a function or code snippet.</span></div>
<div style="position:absolute;left:120.00px;top:339.93px" class="cls_050"><span class="cls_050">•</span><span class="cls_030">   EP</span><span class="cls_007"> is a pointer to the environment to be used when calling that lambda</span></div>
<div style="position:absolute;left:138.00px;top:351.93px" class="cls_007"><span class="cls_007">or function—that is, a pointer to the surrounding stack frame.</span></div>
<div style="position:absolute;left:138.00px;top:372.93px" class="cls_007"><span class="cls_007">Following this train of thought, we can see that blocks are Ruby’s imple-</span></div>
<div style="position:absolute;left:120.00px;top:384.93px" class="cls_007"><span class="cls_007">mentation of closures. Ironically, blocks—one of the features that makes</span></div>
<div style="position:absolute;left:120.00px;top:396.93px" class="cls_007"><span class="cls_007">Ruby so elegant and modern—are based on research and work done at least</span></div>
<div style="position:absolute;left:120.00px;top:408.93px" class="cls_007"><span class="cls_007">20 years before the birth of Ruby!</span></div>
<div style="position:absolute;left:125.52px;top:455.83px" class="cls_020"><span class="cls_020">The rb_block_t and rb_control_frame_t Structures</span></div>
<div style="position:absolute;left:120.50px;top:474.33px" class="cls_039"><span class="cls_039">In Ruby 1.9 and later, you’ll find the definition of the </span><span class="cls_030">rb_block_t</span><span class="cls_039"> structure in the</span></div>
<div style="position:absolute;left:120.50px;top:486.33px" class="cls_044"><span class="cls_044">vm_core.h</span><span class="cls_039"> file, as shown in Listing 8-3.</span></div>
<div style="position:absolute;left:120.50px;top:508.83px" class="cls_009"><span class="cls_009">typedef struct rb_block_struct {</span></div>
<div style="position:absolute;left:110.00px;top:517.33px" class="cls_046"><span class="cls_046">u</span><span class="cls_009">     VALUE self;</span></div>
<div style="position:absolute;left:110.00px;top:526.83px" class="cls_046"><span class="cls_046">v</span><span class="cls_009">     VALUE klass;</span></div>
<div style="position:absolute;left:110.00px;top:536.33px" class="cls_046"><span class="cls_046">w</span><span class="cls_009">     VALUE *ep;</span></div>
<div style="position:absolute;left:110.00px;top:545.83px" class="cls_046"><span class="cls_046">x</span><span class="cls_009">     rb_iseq_t *iseq;</span></div>
<div style="position:absolute;left:110.00px;top:555.33px" class="cls_046"><span class="cls_046">y</span><span class="cls_009">     VALUE proc;</span></div>
<div style="position:absolute;left:120.50px;top:565.83px" class="cls_009"><span class="cls_009">} rb_block_t;</span></div>
<div style="position:absolute;left:120.50px;top:588.33px" class="cls_043"><span class="cls_043">Listing 8-3: The definition of </span><span class="cls_015">rb_block_t</span><span class="cls_043"> from </span><span class="cls_065">vm_core.h</span></div>
<div style="position:absolute;left:48.00px;top:633.00px" class="cls_020"><span class="cls_020">198</span></div>
<div style="position:absolute;left:74.03px;top:636.00px" class="cls_021"><span class="cls_021">Chapter 8</span></div>
</div>
<div style="position:absolute;left:50%;margin-left:-252px;top:148044px;width:504px;height:666px;border-style:outset;overflow:hidden">
<div style="position:absolute;left:0px;top:0px">
<img src="e698b76e-46bd-11eb-8b25-0cc47a792c0a_id_e698b76e-46bd-11eb-8b25-0cc47a792c0a_files/background223.jpg" width=504 height=666></div>
<div style="position:absolute;left:141.50px;top:61.15px" class="cls_039"><span class="cls_039">You can see the </span><span class="cls_009">iseq</span><span class="cls_039"> </span><span class="cls_046">x</span><span class="cls_039"> and </span><span class="cls_009">ep</span><span class="cls_039"> </span><span class="cls_046">w</span><span class="cls_039"> values described above, along with a few</span></div>
<div style="position:absolute;left:123.50px;top:73.16px" class="cls_039"><span class="cls_039">other values:</span></div>
<div style="position:absolute;left:123.50px;top:91.15px" class="cls_039"><span class="cls_039">•</span><span class="cls_009">   self</span><span class="cls_039"> </span><span class="cls_046">u</span><span class="cls_039">: The value the </span><span class="cls_009">self</span><span class="cls_039"> pointer had when the block was first referred to is</span></div>
<div style="position:absolute;left:141.50px;top:103.16px" class="cls_039"><span class="cls_039">also an important part of the closure’s environment. Ruby executes block code</span></div>
<div style="position:absolute;left:141.50px;top:115.16px" class="cls_039"><span class="cls_039">inside the same object context that the code had outside the block.</span></div>
<div style="position:absolute;left:123.50px;top:130.15px" class="cls_039"><span class="cls_039">•</span><span class="cls_009">   klass</span><span class="cls_039"> </span><span class="cls_046">v</span><span class="cls_039">: Along with </span><span class="cls_009">self</span><span class="cls_039">, Ruby also keeps track of the class of the current</span></div>
<div style="position:absolute;left:141.50px;top:142.16px" class="cls_039"><span class="cls_039">object using this pointer.</span></div>
<div style="position:absolute;left:123.50px;top:157.15px" class="cls_039"><span class="cls_039">•</span><span class="cls_009">   proc</span><span class="cls_039"> </span><span class="cls_046">y</span><span class="cls_039">: Ruby uses this value when it creates a proc object from a block. As</span></div>
<div style="position:absolute;left:141.50px;top:169.16px" class="cls_039"><span class="cls_039">we’ll see in the next section, procs and blocks are closely related.</span></div>
<div style="position:absolute;left:141.50px;top:187.15px" class="cls_039"><span class="cls_039">Right above the definition of </span><span class="cls_009">rb_block_t</span><span class="cls_039"> in </span><span class="cls_044">vm_core.h</span><span class="cls_039">, we see the definition of the</span></div>
<div style="position:absolute;left:123.50px;top:199.15px" class="cls_009"><span class="cls_009">rb_control_frame_t</span><span class="cls_039"> structure, as shown in Listing 8-4.</span></div>
<div style="position:absolute;left:123.50px;top:221.65px" class="cls_009"><span class="cls_009">typedef struct rb_control_frame_struct {</span></div>
<div style="position:absolute;left:138.50px;top:231.16px" class="cls_009"><span class="cls_009">VALUE *pc;</span></div>
<div style="position:absolute;left:243.50px;top:231.16px" class="cls_009"><span class="cls_009">/* cfp[0] */</span></div>
<div style="position:absolute;left:138.50px;top:240.66px" class="cls_009"><span class="cls_009">VALUE *sp;</span></div>
<div style="position:absolute;left:243.50px;top:240.66px" class="cls_009"><span class="cls_009">/* cfp[1] */</span></div>
<div style="position:absolute;left:138.50px;top:250.16px" class="cls_009"><span class="cls_009">rb_iseq_t *iseq;</span></div>
<div style="position:absolute;left:243.50px;top:250.16px" class="cls_009"><span class="cls_009">/* cfp[2] */</span></div>
<div style="position:absolute;left:138.50px;top:259.66px" class="cls_009"><span class="cls_009">VALUE flag;</span></div>
<div style="position:absolute;left:243.50px;top:259.66px" class="cls_009"><span class="cls_009">/* cfp[3] */</span></div>
<div style="position:absolute;left:113.00px;top:268.15px" class="cls_046"><span class="cls_046">u</span><span class="cls_009">     VALUE self;</span></div>
<div style="position:absolute;left:244.33px;top:269.15px" class="cls_009"><span class="cls_009">/* cfp[4] / block[0] */</span></div>
<div style="position:absolute;left:138.50px;top:278.66px" class="cls_009"><span class="cls_009">VALUE klass;</span></div>
<div style="position:absolute;left:243.50px;top:278.66px" class="cls_009"><span class="cls_009">/* cfp[5] / block[1] */</span></div>
<div style="position:absolute;left:138.50px;top:288.16px" class="cls_009"><span class="cls_009">VALUE *ep;</span></div>
<div style="position:absolute;left:243.50px;top:288.16px" class="cls_009"><span class="cls_009">/* cfp[6] / block[2] */</span></div>
<div style="position:absolute;left:138.50px;top:297.66px" class="cls_009"><span class="cls_009">rb_iseq_t *block_iseq;</span></div>
<div style="position:absolute;left:243.50px;top:297.66px" class="cls_009"><span class="cls_009">/* cfp[7] / block[3] */</span></div>
<div style="position:absolute;left:113.00px;top:306.15px" class="cls_046"><span class="cls_046">v</span><span class="cls_009">     VALUE proc;</span></div>
<div style="position:absolute;left:244.33px;top:307.15px" class="cls_009"><span class="cls_009">/* cfp[8] / block[4] */</span></div>
<div style="position:absolute;left:138.50px;top:316.66px" class="cls_009"><span class="cls_009">const rb_method_entry_t *me;/* cfp[9] */</span></div>
<div style="position:absolute;left:123.50px;top:335.65px" class="cls_009"><span class="cls_009">#if VM_DEBUG_BP_CHECK</span></div>
<div style="position:absolute;left:138.50px;top:345.16px" class="cls_009"><span class="cls_009">VALUE *bp_check;</span></div>
<div style="position:absolute;left:243.50px;top:345.16px" class="cls_009"><span class="cls_009">/* cfp[10] */</span></div>
<div style="position:absolute;left:123.50px;top:354.66px" class="cls_009"><span class="cls_009">#endif</span></div>
<div style="position:absolute;left:123.50px;top:364.16px" class="cls_009"><span class="cls_009">} rb_control_frame_t;</span></div>
<div style="position:absolute;left:123.50px;top:386.65px" class="cls_043"><span class="cls_043">Listing 8-4: The definition of </span><span class="cls_015">rb_control_frame_t</span><span class="cls_043"> from </span><span class="cls_065">vm_core.h</span></div>
<div style="position:absolute;left:141.50px;top:409.65px" class="cls_039"><span class="cls_039">Notice that this C structure also contains the same values as the </span><span class="cls_009">rb_block_t</span><span class="cls_039"> struc-</span></div>
<div style="position:absolute;left:123.50px;top:421.65px" class="cls_039"><span class="cls_039">ture: everything from </span><span class="cls_009">self</span><span class="cls_039"> at </span><span class="cls_046">u</span><span class="cls_039"> to </span><span class="cls_009">proc</span><span class="cls_039"> at </span><span class="cls_046">v</span><span class="cls_039">. The fact that these two structures share</span></div>
<div style="position:absolute;left:123.50px;top:433.66px" class="cls_039"><span class="cls_039">the same values is one of the interesting, but confusing, optimizations Ruby uses</span></div>
<div style="position:absolute;left:123.50px;top:445.66px" class="cls_039"><span class="cls_039">internally to speed things up. Whenever you first refer to a block by passing it into a</span></div>
<div style="position:absolute;left:123.50px;top:457.65px" class="cls_039"><span class="cls_039">method call, Ruby needs to create a new </span><span class="cls_009">rb_block_t</span><span class="cls_039"> structure and copy values such as</span></div>
<div style="position:absolute;left:123.50px;top:469.65px" class="cls_039"><span class="cls_039">the </span><span class="cls_009">EP</span><span class="cls_039"> from the current </span><span class="cls_009">rb_control_frame_t</span><span class="cls_039"> structure into it. However, because these</span></div>
<div style="position:absolute;left:123.50px;top:481.65px" class="cls_039"><span class="cls_039">two structures contain the same values in the same order (</span><span class="cls_009">rb_block_t</span><span class="cls_039"> is a subset of</span></div>
<div style="position:absolute;left:123.50px;top:493.65px" class="cls_009"><span class="cls_009">rb_control_frame_t</span><span class="cls_039">), Ruby can avoid creating a new </span><span class="cls_009">rb_block_t</span><span class="cls_039"> structure and instead</span></div>
<div style="position:absolute;left:123.50px;top:505.65px" class="cls_039"><span class="cls_039">set the new block pointer to the common portion of the </span><span class="cls_009">rb_control_frame_t</span><span class="cls_039"> structure.</span></div>
<div style="position:absolute;left:123.50px;top:517.65px" class="cls_039"><span class="cls_039">In other words, instead of allocating new memory to hold the new </span><span class="cls_009">rb_block_t</span><span class="cls_039"> struc-</span></div>
<div style="position:absolute;left:123.50px;top:529.65px" class="cls_039"><span class="cls_039">ture, Ruby simply passes a pointer to the middle of the </span><span class="cls_009">rb_control_frame_t</span><span class="cls_039"> structure.</span></div>
<div style="position:absolute;left:123.50px;top:541.65px" class="cls_039"><span class="cls_039">By doing so, Ruby avoids unnecessary calls to </span><span class="cls_009">malloc</span><span class="cls_039"> and speeds up the process of</span></div>
<div style="position:absolute;left:123.50px;top:553.66px" class="cls_039"><span class="cls_039">creating blocks.</span></div>
<div style="position:absolute;left:290.38px;top:636.00px" class="cls_021"><span class="cls_021">How Ruby Borrowed a Decades-Old Idea from Lisp</span></div>
<div style="position:absolute;left:442.85px;top:633.00px" class="cls_020"><span class="cls_020">199</span></div>
</div>
<div style="position:absolute;left:50%;margin-left:-252px;top:148720px;width:504px;height:666px;border-style:outset;overflow:hidden">
<div style="position:absolute;left:0px;top:0px">
<img src="e698b76e-46bd-11eb-8b25-0cc47a792c0a_id_e698b76e-46bd-11eb-8b25-0cc47a792c0a_files/background224.jpg" width=504 height=666></div>
<div style="position:absolute;left:120.00px;top:42.63px" class="cls_031"><span class="cls_031">Experiment 8-1: Which Is Faster: A while Loop or</span></div>
<div style="position:absolute;left:120.00px;top:57.63px" class="cls_031"><span class="cls_031">Passing a Block to each?</span></div>
<div style="position:absolute;left:120.00px;top:77.63px" class="cls_007"><span class="cls_007">Ruby code containing blocks is often more elegant and succinct than the</span></div>
<div style="position:absolute;left:120.00px;top:89.63px" class="cls_007"><span class="cls_007">equivalent code in older languages, such as C. For example, in C we would</span></div>
<div style="position:absolute;left:120.00px;top:101.63px" class="cls_007"><span class="cls_007">write the simple </span><span class="cls_030">while</span><span class="cls_007"> loop shown in Listing 8-5 to add up the numbers 1</span></div>
<div style="position:absolute;left:120.00px;top:113.63px" class="cls_007"><span class="cls_007">through 10.</span></div>
<div style="position:absolute;left:120.00px;top:137.63px" class="cls_030"><span class="cls_030">#include &lt;stdio.h></span></div>
<div style="position:absolute;left:120.00px;top:148.12px" class="cls_030"><span class="cls_030">main()</span></div>
<div style="position:absolute;left:120.00px;top:158.62px" class="cls_030"><span class="cls_030">{</span></div>
<div style="position:absolute;left:128.50px;top:169.12px" class="cls_030"><span class="cls_030">int i, sum;</span></div>
<div style="position:absolute;left:128.50px;top:179.62px" class="cls_030"><span class="cls_030">i = 1;</span></div>
<div style="position:absolute;left:128.50px;top:190.11px" class="cls_030"><span class="cls_030">sum = 0;</span></div>
<div style="position:absolute;left:128.50px;top:200.61px" class="cls_030"><span class="cls_030">while (i &lt;= 10) {</span></div>
<div style="position:absolute;left:137.00px;top:211.11px" class="cls_030"><span class="cls_030">sum = sum + i;</span></div>
<div style="position:absolute;left:137.00px;top:221.61px" class="cls_030"><span class="cls_030">i++;</span></div>
<div style="position:absolute;left:128.50px;top:232.10px" class="cls_030"><span class="cls_030">}</span></div>
<div style="position:absolute;left:128.50px;top:242.60px" class="cls_030"><span class="cls_030">printf("Sum: %d\n", sum);</span></div>
<div style="position:absolute;left:120.00px;top:253.10px" class="cls_030"><span class="cls_030">}</span></div>
<div style="position:absolute;left:120.00px;top:275.60px" class="cls_038"><span class="cls_038">Listing 8-5: Adding up 1 through 10 in C using a </span><span class="cls_014">while</span><span class="cls_038"> loop</span></div>
<div style="position:absolute;left:138.00px;top:298.13px" class="cls_007"><span class="cls_007">Listing 8-6 shows the same </span><span class="cls_030">while</span><span class="cls_007"> loop in Ruby.</span></div>
<div style="position:absolute;left:120.00px;top:322.13px" class="cls_030"><span class="cls_030">sum = 0</span></div>
<div style="position:absolute;left:120.00px;top:332.62px" class="cls_030"><span class="cls_030">i = 1</span></div>
<div style="position:absolute;left:120.00px;top:343.12px" class="cls_030"><span class="cls_030">while i &lt;= 10</span></div>
<div style="position:absolute;left:128.50px;top:353.62px" class="cls_030"><span class="cls_030">sum += i</span></div>
<div style="position:absolute;left:128.50px;top:364.12px" class="cls_030"><span class="cls_030">i += 1</span></div>
<div style="position:absolute;left:120.00px;top:374.61px" class="cls_030"><span class="cls_030">end</span></div>
<div style="position:absolute;left:120.00px;top:385.11px" class="cls_030"><span class="cls_030">puts "Sum: #{sum}"</span></div>
<div style="position:absolute;left:120.00px;top:407.61px" class="cls_038"><span class="cls_038">Listing 8-6: Adding up 1 through 10 in Ruby using a </span><span class="cls_014">while</span><span class="cls_038"> loop</span></div>
<div style="position:absolute;left:138.00px;top:430.13px" class="cls_007"><span class="cls_007">However, most Rubyists would write this code using a range object with</span></div>
<div style="position:absolute;left:120.00px;top:442.13px" class="cls_007"><span class="cls_007">a block, as shown in Listing 8-7.</span></div>
<div style="position:absolute;left:120.00px;top:466.13px" class="cls_030"><span class="cls_030">sum = 0</span></div>
<div style="position:absolute;left:120.00px;top:476.62px" class="cls_030"><span class="cls_030">(1..10).each do |i|</span></div>
<div style="position:absolute;left:128.50px;top:487.12px" class="cls_030"><span class="cls_030">sum += i</span></div>
<div style="position:absolute;left:120.00px;top:497.62px" class="cls_030"><span class="cls_030">end</span></div>
<div style="position:absolute;left:120.00px;top:508.12px" class="cls_030"><span class="cls_030">puts "Sum: #{sum}"</span></div>
<div style="position:absolute;left:120.00px;top:530.61px" class="cls_038"><span class="cls_038">Listing 8-7: Adding up 1 through 10 in Ruby using a range object and a block</span></div>
<div style="position:absolute;left:138.00px;top:553.13px" class="cls_007"><span class="cls_007">Aesthetics aside, is there any performance penalty for using a block</span></div>
<div style="position:absolute;left:120.00px;top:565.13px" class="cls_007"><span class="cls_007">here? Does Ruby slow down significantly in order to create the new</span></div>
<div style="position:absolute;left:120.00px;top:577.13px" class="cls_030"><span class="cls_030">rb_block_t</span><span class="cls_007"> structure, copy the </span><span class="cls_030">EP</span><span class="cls_007"> value, and create new stack frames?</span></div>
<div style="position:absolute;left:48.00px;top:633.00px" class="cls_020"><span class="cls_020">200</span></div>
<div style="position:absolute;left:74.67px;top:636.00px" class="cls_021"><span class="cls_021">Chapter 8</span></div>
</div>
<div style="position:absolute;left:50%;margin-left:-252px;top:149396px;width:504px;height:666px;border-style:outset;overflow:hidden">
<div style="position:absolute;left:0px;top:0px">
<img src="e698b76e-46bd-11eb-8b25-0cc47a792c0a_id_e698b76e-46bd-11eb-8b25-0cc47a792c0a_files/background225.jpg" width=504 height=666></div>
<div style="position:absolute;left:141.00px;top:42.28px" class="cls_007"><span class="cls_007">Well, I won’t benchmark the C code because clearly it will be faster than</span></div>
<div style="position:absolute;left:123.00px;top:54.28px" class="cls_007"><span class="cls_007">either option using Ruby. Instead, let’s measure how long it takes Ruby,</span></div>
<div style="position:absolute;left:123.00px;top:66.28px" class="cls_007"><span class="cls_007">using a simple </span><span class="cls_030">while</span><span class="cls_007"> loop, to add up the integers 1 through 10 to obtain 55,</span></div>
<div style="position:absolute;left:123.00px;top:78.28px" class="cls_007"><span class="cls_007">as shown in Listing 8-8.</span></div>
<div style="position:absolute;left:123.00px;top:102.28px" class="cls_030"><span class="cls_030">require 'benchmark'</span></div>
<div style="position:absolute;left:123.00px;top:112.78px" class="cls_030"><span class="cls_030">ITERATIONS = 1000000</span></div>
<div style="position:absolute;left:123.00px;top:123.27px" class="cls_030"><span class="cls_030">Benchmark.bm do |bench|</span></div>
<div style="position:absolute;left:131.50px;top:133.77px" class="cls_030"><span class="cls_030">bench.report("iterating from 1 to 10, one million times") do</span></div>
<div style="position:absolute;left:140.00px;top:144.27px" class="cls_030"><span class="cls_030">ITERATIONS.times do</span></div>
<div style="position:absolute;left:148.50px;top:154.77px" class="cls_030"><span class="cls_030">sum = 0</span></div>
<div style="position:absolute;left:148.50px;top:165.26px" class="cls_030"><span class="cls_030">i = 1</span></div>
<div style="position:absolute;left:148.50px;top:175.76px" class="cls_030"><span class="cls_030">while i &lt;= 10</span></div>
<div style="position:absolute;left:157.00px;top:186.26px" class="cls_030"><span class="cls_030">sum += i</span></div>
<div style="position:absolute;left:157.00px;top:196.76px" class="cls_030"><span class="cls_030">i += 1</span></div>
<div style="position:absolute;left:148.50px;top:207.26px" class="cls_030"><span class="cls_030">end</span></div>
<div style="position:absolute;left:140.00px;top:217.75px" class="cls_030"><span class="cls_030">end</span></div>
<div style="position:absolute;left:131.50px;top:228.25px" class="cls_030"><span class="cls_030">end</span></div>
<div style="position:absolute;left:123.00px;top:238.75px" class="cls_030"><span class="cls_030">end</span></div>
<div style="position:absolute;left:123.00px;top:261.25px" class="cls_038"><span class="cls_038">Listing 8-8: Benchmarking the </span><span class="cls_014">while</span><span class="cls_038"> loop </span><span class="cls_039">(while.rb)</span></div>
<div style="position:absolute;left:141.00px;top:283.78px" class="cls_007"><span class="cls_007">Here, I’m using the benchmark library to measure the time required to</span></div>
<div style="position:absolute;left:123.00px;top:295.78px" class="cls_007"><span class="cls_007">run the </span><span class="cls_030">while</span><span class="cls_007"> loop one million times. Admittedly, I’m using a block to con-</span></div>
<div style="position:absolute;left:123.00px;top:307.78px" class="cls_007"><span class="cls_007">trol the million iterations (</span><span class="cls_030">ITERATIONS.times do</span><span class="cls_007">), but I’ll use the same block</span></div>
<div style="position:absolute;left:123.00px;top:319.78px" class="cls_007"><span class="cls_007">in the next test as well. Using Ruby 2.0 on my laptop, I can run through this</span></div>
<div style="position:absolute;left:123.00px;top:331.78px" class="cls_007"><span class="cls_007">code in just under a half second:</span></div>
<div style="position:absolute;left:123.00px;top:355.78px" class="cls_030"><span class="cls_030">$ </span><span class="cls_040">ruby while.rb</span></div>
<div style="position:absolute;left:148.50px;top:366.28px" class="cls_030"><span class="cls_030">user</span></div>
<div style="position:absolute;left:186.75px;top:366.28px" class="cls_030"><span class="cls_030">system</span></div>
<div style="position:absolute;left:237.75px;top:366.28px" class="cls_030"><span class="cls_030">total</span></div>
<div style="position:absolute;left:293.00px;top:366.28px" class="cls_030"><span class="cls_030">real</span></div>
<div style="position:absolute;left:148.50px;top:376.77px" class="cls_030"><span class="cls_030">iterating from 1 to 10, one million times</span></div>
<div style="position:absolute;left:331.25px;top:376.77px" class="cls_030"><span class="cls_030">0.440000</span></div>
<div style="position:absolute;left:378.00px;top:376.77px" class="cls_030"><span class="cls_030">0.000000</span></div>
<div style="position:absolute;left:331.25px;top:387.27px" class="cls_030"><span class="cls_030">0.440000 (</span></div>
<div style="position:absolute;left:382.25px;top:387.27px" class="cls_030"><span class="cls_030">0.445757)</span></div>
<div style="position:absolute;left:141.00px;top:409.78px" class="cls_007"><span class="cls_007">Now let’s measure the time required to run the code shown in Listing 8-9,</span></div>
<div style="position:absolute;left:123.00px;top:421.78px" class="cls_007"><span class="cls_007">which uses </span><span class="cls_030">each</span><span class="cls_007"> with a block.</span></div>
<div style="position:absolute;left:123.00px;top:445.78px" class="cls_030"><span class="cls_030">require 'benchmark'</span></div>
<div style="position:absolute;left:123.00px;top:456.28px" class="cls_030"><span class="cls_030">ITERATIONS = 1000000</span></div>
<div style="position:absolute;left:123.00px;top:466.77px" class="cls_030"><span class="cls_030">Benchmark.bm do |bench|</span></div>
<div style="position:absolute;left:131.50px;top:477.27px" class="cls_030"><span class="cls_030">bench.report("iterating from 1 to 10, one million times") do</span></div>
<div style="position:absolute;left:140.00px;top:487.77px" class="cls_030"><span class="cls_030">ITERATIONS.times do</span></div>
<div style="position:absolute;left:148.50px;top:498.27px" class="cls_030"><span class="cls_030">sum = 0</span></div>
<div style="position:absolute;left:148.50px;top:508.77px" class="cls_030"><span class="cls_030">(1..10).each do |i|</span></div>
<div style="position:absolute;left:157.00px;top:519.26px" class="cls_030"><span class="cls_030">sum += i</span></div>
<div style="position:absolute;left:148.50px;top:529.76px" class="cls_030"><span class="cls_030">end</span></div>
<div style="position:absolute;left:140.00px;top:540.26px" class="cls_030"><span class="cls_030">end</span></div>
<div style="position:absolute;left:131.50px;top:550.76px" class="cls_030"><span class="cls_030">end</span></div>
<div style="position:absolute;left:123.00px;top:561.25px" class="cls_030"><span class="cls_030">end</span></div>
<div style="position:absolute;left:123.00px;top:583.75px" class="cls_038"><span class="cls_038">Listing 8-9: Benchmarking a call to a block </span><span class="cls_039">(each.rb)</span></div>
<div style="position:absolute;left:290.33px;top:636.00px" class="cls_021"><span class="cls_021">How Ruby Borrowed a Decades-Old Idea from Lisp</span></div>
<div style="position:absolute;left:442.80px;top:633.00px" class="cls_020"><span class="cls_020">201</span></div>
</div>
<div style="position:absolute;left:50%;margin-left:-252px;top:150072px;width:504px;height:666px;border-style:outset;overflow:hidden">
<div style="position:absolute;left:0px;top:0px">
<img src="e698b76e-46bd-11eb-8b25-0cc47a792c0a_id_e698b76e-46bd-11eb-8b25-0cc47a792c0a_files/background226.jpg" width=504 height=666></div>
<div style="position:absolute;left:138.00px;top:42.28px" class="cls_007"><span class="cls_007">This time it takes somewhat longer to run through the loop a million</span></div>
<div style="position:absolute;left:120.00px;top:54.28px" class="cls_007"><span class="cls_007">times, about 0.75 seconds:</span></div>
<div style="position:absolute;left:120.00px;top:78.28px" class="cls_030"><span class="cls_030">$ </span><span class="cls_040">ruby each.rb</span></div>
<div style="position:absolute;left:145.50px;top:88.78px" class="cls_030"><span class="cls_030">user</span></div>
<div style="position:absolute;left:183.75px;top:88.78px" class="cls_030"><span class="cls_030">system</span></div>
<div style="position:absolute;left:234.75px;top:88.78px" class="cls_030"><span class="cls_030">total</span></div>
<div style="position:absolute;left:290.00px;top:88.78px" class="cls_030"><span class="cls_030">real</span></div>
<div style="position:absolute;left:145.50px;top:99.28px" class="cls_030"><span class="cls_030">iterating from 1 to 10, one million times</span></div>
<div style="position:absolute;left:328.25px;top:99.28px" class="cls_030"><span class="cls_030">0.760000</span></div>
<div style="position:absolute;left:375.00px;top:99.28px" class="cls_030"><span class="cls_030">0.000000</span></div>
<div style="position:absolute;left:328.25px;top:109.77px" class="cls_030"><span class="cls_030">0.760000 (</span></div>
<div style="position:absolute;left:379.25px;top:109.77px" class="cls_030"><span class="cls_030">0.765740)</span></div>
<div style="position:absolute;left:138.00px;top:132.28px" class="cls_007"><span class="cls_007">Ruby requires about 71 percent more time to call the block 10 times, com-</span></div>
<div style="position:absolute;left:120.00px;top:144.28px" class="cls_007"><span class="cls_007">pared to iterating through the simple </span><span class="cls_030">while</span><span class="cls_007"> loop 10 times (see Figure 8-9).</span></div>
<div style="position:absolute;left:141.77px;top:165.97px" class="cls_081"><span class="cls_081">1</span></div>
<div style="position:absolute;left:136.45px;top:187.72px" class="cls_081"><span class="cls_081">0.9</span></div>
<div style="position:absolute;left:213.48px;top:204.18px" class="cls_144"><span class="cls_144">1 million iterations</span></div>
<div style="position:absolute;left:136.45px;top:209.14px" class="cls_081"><span class="cls_081">0.8</span></div>
<div style="position:absolute;left:221.95px;top:213.39px" class="cls_144"><span class="cls_144">using a block</span></div>
<div style="position:absolute;left:136.45px;top:230.55px" class="cls_081"><span class="cls_081">0.7</span></div>
<div style="position:absolute;left:136.45px;top:251.65px" class="cls_081"><span class="cls_081">0.6</span></div>
<div style="position:absolute;left:331.21px;top:268.01px" class="cls_144"><span class="cls_144">1 million iterations</span></div>
<div style="position:absolute;left:136.45px;top:273.06px" class="cls_081"><span class="cls_081">0.5</span></div>
<div style="position:absolute;left:331.21px;top:277.23px" class="cls_144"><span class="cls_144">using a </span><span class="cls_145">while</span><span class="cls_144"> loop</span></div>
<div style="position:absolute;left:136.45px;top:294.48px" class="cls_081"><span class="cls_081">0.4</span></div>
<div style="position:absolute;left:136.45px;top:315.89px" class="cls_081"><span class="cls_081">0.3</span></div>
<div style="position:absolute;left:136.45px;top:336.99px" class="cls_081"><span class="cls_081">0.2</span></div>
<div style="position:absolute;left:136.45px;top:358.40px" class="cls_081"><span class="cls_081">0.1</span></div>
<div style="position:absolute;left:120.00px;top:391.78px" class="cls_038"><span class="cls_038">Figure 8-9: Ruby 2.0 uses 71 percent more time calling a block vs. a simple </span><span class="cls_014">while</span><span class="cls_038"> loop.</span></div>
<div style="position:absolute;left:120.00px;top:402.28px" class="cls_038"><span class="cls_038">The graph shows the time for one million iterations (in seconds).</span></div>
<div style="position:absolute;left:138.00px;top:424.78px" class="cls_007"><span class="cls_007">Using </span><span class="cls_030">each</span><span class="cls_007"> is slower because internally the </span><span class="cls_030">Range#each</span><span class="cls_007"> method has to call</span></div>
<div style="position:absolute;left:120.00px;top:436.78px" class="cls_007"><span class="cls_007">or yield to the block each time around the loop. This involves a fairly large</span></div>
<div style="position:absolute;left:120.00px;top:448.78px" class="cls_007"><span class="cls_007">amount of work. In order to yield to a block, Ruby first has to create a new</span></div>
<div style="position:absolute;left:120.00px;top:460.78px" class="cls_030"><span class="cls_030">rb_block_t</span><span class="cls_007"> structure for that block, setting the </span><span class="cls_030">EP</span><span class="cls_007"> in the new block to the</span></div>
<div style="position:absolute;left:120.00px;top:472.78px" class="cls_007"><span class="cls_007">referencing environment and passing the block into the call to </span><span class="cls_030">each</span><span class="cls_007">. Then</span></div>
<div style="position:absolute;left:120.00px;top:484.78px" class="cls_007"><span class="cls_007">each time around the loop Ruby has to create a new stack frame on YARV’s</span></div>
<div style="position:absolute;left:120.00px;top:496.78px" class="cls_007"><span class="cls_007">internal stack, call the block’s code, and finally copy the </span><span class="cls_030">EP</span><span class="cls_007"> from the block</span></div>
<div style="position:absolute;left:120.00px;top:508.78px" class="cls_007"><span class="cls_007">to the new stack frame. Running a simple </span><span class="cls_030">while</span><span class="cls_007"> loop is faster because Ruby</span></div>
<div style="position:absolute;left:120.00px;top:520.78px" class="cls_007"><span class="cls_007">needs only to reset the </span><span class="cls_030">PC</span><span class="cls_007">, or program counter, each time around the loop.</span></div>
<div style="position:absolute;left:120.00px;top:532.78px" class="cls_007"><span class="cls_007">It never calls a method or creates a new stack frame or a new </span><span class="cls_030">rb_block_t</span></div>
<div style="position:absolute;left:120.00px;top:544.78px" class="cls_007"><span class="cls_007">structure.</span></div>
<div style="position:absolute;left:138.00px;top:556.78px" class="cls_007"><span class="cls_007">Seventy-one percent more time seems like a large performance pen-</span></div>
<div style="position:absolute;left:120.00px;top:568.78px" class="cls_007"><span class="cls_007">alty, and, depending on your work and the context of this </span><span class="cls_030">while</span><span class="cls_007"> loop, it may</span></div>
<div style="position:absolute;left:120.00px;top:580.78px" class="cls_007"><span class="cls_007">or may not be important. If this loop were part of a time-sensitive, critical</span></div>
<div style="position:absolute;left:120.00px;top:592.78px" class="cls_007"><span class="cls_007">operation that your end users were waiting for, and if there weren’t other</span></div>
<div style="position:absolute;left:120.00px;top:604.78px" class="cls_007"><span class="cls_007">expensive operations inside the loop, it might be worth writing the iteration</span></div>
<div style="position:absolute;left:48.00px;top:633.00px" class="cls_020"><span class="cls_020">202</span></div>
<div style="position:absolute;left:74.54px;top:636.00px" class="cls_021"><span class="cls_021">Chapter 8</span></div>
</div>
<div style="position:absolute;left:50%;margin-left:-252px;top:150748px;width:504px;height:666px;border-style:outset;overflow:hidden">
<div style="position:absolute;left:0px;top:0px">
<img src="e698b76e-46bd-11eb-8b25-0cc47a792c0a_id_e698b76e-46bd-11eb-8b25-0cc47a792c0a_files/background227.jpg" width=504 height=666></div>
<div style="position:absolute;left:123.00px;top:42.28px" class="cls_007"><span class="cls_007">using an old-fashioned C-style </span><span class="cls_030">while</span><span class="cls_007"> loop. However, the performance of</span></div>
<div style="position:absolute;left:123.00px;top:54.28px" class="cls_007"><span class="cls_007">most Ruby applications, and certainly Ruby on Rails websites, is usually</span></div>
<div style="position:absolute;left:123.00px;top:66.28px" class="cls_007"><span class="cls_007">limited by database queries, network connections, and other factors, not by</span></div>
<div style="position:absolute;left:123.00px;top:78.28px" class="cls_007"><span class="cls_007">Ruby execution speed. It’s rare that Ruby’s execution speed has an immedi-</span></div>
<div style="position:absolute;left:123.00px;top:90.28px" class="cls_007"><span class="cls_007">ate, direct impact on your application’s overall performance. (Of course, if</span></div>
<div style="position:absolute;left:123.00px;top:102.28px" class="cls_007"><span class="cls_007">you’re using a large framework, such as Ruby on Rails, then your Ruby code</span></div>
<div style="position:absolute;left:123.00px;top:114.28px" class="cls_007"><span class="cls_007">is a very small piece of a very large system. I imagine that Rails uses blocks</span></div>
<div style="position:absolute;left:123.00px;top:126.28px" class="cls_007"><span class="cls_007">and iterators many, many times while processing a simple HTTP request,</span></div>
<div style="position:absolute;left:123.00px;top:138.28px" class="cls_007"><span class="cls_007">apart from the Ruby code you write yourself.)</span></div>
<div style="position:absolute;left:69.00px;top:172.28px" class="cls_031"><span class="cls_031">Lambdas and Procs: Treating a Function as a First-Class Citizen</span></div>
<div style="position:absolute;left:123.00px;top:192.28px" class="cls_007"><span class="cls_007">Now to look at a more convoluted way of printing the “quick brown fox” string</span></div>
<div style="position:absolute;left:123.00px;top:204.28px" class="cls_007"><span class="cls_007">to the console. Listing 8-10 shows an example of using </span><span class="cls_030">lambda</span><span class="cls_007">.</span></div>
<div style="position:absolute;left:111.15px;top:228.28px" class="cls_046"><span class="cls_046">u</span><span class="cls_030"> def message_function</span></div>
<div style="position:absolute;left:111.15px;top:238.78px" class="cls_046"><span class="cls_046">v</span><span class="cls_030">   str = "The quick brown fox"</span></div>
<div style="position:absolute;left:111.15px;top:249.27px" class="cls_046"><span class="cls_046">w</span><span class="cls_030">   lambda do |animal|</span></div>
<div style="position:absolute;left:111.15px;top:259.77px" class="cls_046"><span class="cls_046">x</span><span class="cls_030">     puts "#{str} jumps over the lazy #{animal}."</span></div>
<div style="position:absolute;left:131.50px;top:270.27px" class="cls_030"><span class="cls_030">end</span></div>
<div style="position:absolute;left:123.00px;top:280.77px" class="cls_030"><span class="cls_030">end</span></div>
<div style="position:absolute;left:111.15px;top:291.27px" class="cls_046"><span class="cls_046">y</span><span class="cls_030"> function_value = message_function</span></div>
<div style="position:absolute;left:111.15px;top:301.76px" class="cls_046"><span class="cls_046">z</span><span class="cls_030"> function_value.call('dog')</span></div>
<div style="position:absolute;left:123.00px;top:324.26px" class="cls_038"><span class="cls_038">Listing 8-10: Using </span><span class="cls_014">lambda</span><span class="cls_038"> in Ruby</span></div>
<div style="position:absolute;left:141.00px;top:346.78px" class="cls_007"><span class="cls_007">Let’s step through this code carefully. First, at </span><span class="cls_050">u</span><span class="cls_007"> we define a method</span></div>
<div style="position:absolute;left:123.00px;top:358.78px" class="cls_007"><span class="cls_007">called </span><span class="cls_030">message_function</span><span class="cls_007">. Inside </span><span class="cls_030">message_function</span><span class="cls_007">, we create a local vari-</span></div>
<div style="position:absolute;left:123.00px;top:370.78px" class="cls_007"><span class="cls_007">able at </span><span class="cls_050">v</span><span class="cls_007"> called </span><span class="cls_030">str</span><span class="cls_007">. Next, at </span><span class="cls_050">w</span><span class="cls_007"> we call </span><span class="cls_030">lambda</span><span class="cls_007">, and pass it a block. Inside</span></div>
<div style="position:absolute;left:123.00px;top:382.78px" class="cls_007"><span class="cls_007">this block, at </span><span class="cls_050">x</span><span class="cls_007">, we print the “quick brown fox” string again. However,</span></div>
<div style="position:absolute;left:123.00px;top:394.78px" class="cls_030"><span class="cls_030">message_function</span><span class="cls_007"> won’t immediately display the string because it doesn’t</span></div>
<div style="position:absolute;left:123.00px;top:406.78px" class="cls_007"><span class="cls_007">actually call the block at </span><span class="cls_050">w</span><span class="cls_007">. Instead, </span><span class="cls_030">lambda</span><span class="cls_007"> returns the block we give it as</span></div>
<div style="position:absolute;left:123.00px;top:418.78px" class="cls_007"><span class="cls_007">a data value, which in turn is returned by </span><span class="cls_030">message_function</span><span class="cls_007">.</span></div>
<div style="position:absolute;left:141.00px;top:430.78px" class="cls_007"><span class="cls_007">This is an example of “treating a function as a first-class citizen,” to para-</span></div>
<div style="position:absolute;left:123.00px;top:442.78px" class="cls_007"><span class="cls_007">phrase a commonly used computer science expression. Once the block is</span></div>
<div style="position:absolute;left:123.00px;top:454.78px" class="cls_007"><span class="cls_007">returned from </span><span class="cls_030">message_function</span><span class="cls_007">, we save it in the local variable </span><span class="cls_030">function_value</span></div>
<div style="position:absolute;left:123.00px;top:466.78px" class="cls_007"><span class="cls_007">at </span><span class="cls_050">y</span><span class="cls_007"> and then call it explicitly, using the </span><span class="cls_030">call</span><span class="cls_007"> method at </span><span class="cls_050">z</span><span class="cls_007">. With the </span><span class="cls_030">lambda</span></div>
<div style="position:absolute;left:123.00px;top:478.78px" class="cls_007"><span class="cls_007">keyword—or the equivalent </span><span class="cls_030">proc</span><span class="cls_007"> keyword—Ruby allows you to convert a</span></div>
<div style="position:absolute;left:123.00px;top:490.78px" class="cls_007"><span class="cls_007">block into a data value in this way.</span></div>
<div style="position:absolute;left:141.00px;top:502.78px" class="cls_007"><span class="cls_007">I have lots of questions about Listing 8-10.</span></div>
<div style="position:absolute;left:382.65px;top:510.58px" class="cls_042"><span class="cls_042">rb_lambda_t</span></div>
<div style="position:absolute;left:123.00px;top:514.78px" class="cls_007"><span class="cls_007">What happens when we call </span><span class="cls_030">lambda</span><span class="cls_007">? How does Ruby</span></div>
<div style="position:absolute;left:405.63px;top:524.54px" class="cls_067"><span class="cls_067">??</span></div>
<div style="position:absolute;left:123.00px;top:526.78px" class="cls_007"><span class="cls_007">convert the block into a data value, and what does</span></div>
<div style="position:absolute;left:123.00px;top:538.78px" class="cls_007"><span class="cls_007">it mean to treat this block as a first-class citizen?</span></div>
<div style="position:absolute;left:123.00px;top:550.78px" class="cls_007"><span class="cls_007">Does </span><span class="cls_030">message_function</span><span class="cls_007"> return an </span><span class="cls_030">rb_block_t</span><span class="cls_007"> structure</span></div>
<div style="position:absolute;left:376.00px;top:559.26px" class="cls_038"><span class="cls_038">Figure 8-10:</span></div>
<div style="position:absolute;left:123.00px;top:562.78px" class="cls_007"><span class="cls_007">directly, or does it return an </span><span class="cls_030">rb_lambda_t</span><span class="cls_007"> structure?</span></div>
<div style="position:absolute;left:376.00px;top:569.75px" class="cls_038"><span class="cls_038">Does Ruby use</span></div>
<div style="position:absolute;left:123.00px;top:574.78px" class="cls_007"><span class="cls_007">And what information would </span><span class="cls_030">rb_lambda_t</span><span class="cls_007"> contain</span></div>
<div style="position:absolute;left:376.00px;top:580.25px" class="cls_038"><span class="cls_038">an </span><span class="cls_014">rb_lambda_t</span></div>
<div style="position:absolute;left:123.00px;top:586.78px" class="cls_007"><span class="cls_007">(see Figure 8-10)?</span></div>
<div style="position:absolute;left:376.00px;top:590.75px" class="cls_038"><span class="cls_038">C structure?</span></div>
<div style="position:absolute;left:376.00px;top:601.25px" class="cls_038"><span class="cls_038">And if so, what</span></div>
<div style="position:absolute;left:376.00px;top:611.75px" class="cls_038"><span class="cls_038">would it contain?</span></div>
<div style="position:absolute;left:289.94px;top:636.00px" class="cls_021"><span class="cls_021">How Ruby Borrowed a Decades-Old Idea from Lisp</span></div>
<div style="position:absolute;left:442.40px;top:633.00px" class="cls_020"><span class="cls_020">203</span></div>
</div>
<div style="position:absolute;left:50%;margin-left:-252px;top:151424px;width:504px;height:666px;border-style:outset;overflow:hidden">
<div style="position:absolute;left:0px;top:0px">
<img src="e698b76e-46bd-11eb-8b25-0cc47a792c0a_id_e698b76e-46bd-11eb-8b25-0cc47a792c0a_files/background228.jpg" width=504 height=666></div>
<div style="position:absolute;left:120.00px;top:42.55px" class="cls_055"><span class="cls_055">Stack vs. Heap Memory</span></div>
<div style="position:absolute;left:120.00px;top:60.55px" class="cls_007"><span class="cls_007">Before we can answer these questions, we need to take a closer look at how</span></div>
<div style="position:absolute;left:120.00px;top:72.55px" class="cls_007"><span class="cls_007">Ruby saves your data. Internally, Ruby saves your data in two places: on the</span></div>
<div style="position:absolute;left:120.00px;top:84.55px" class="cls_008"><span class="cls_008">stack</span><span class="cls_007"> or in the </span><span class="cls_008">heap</span><span class="cls_007">.</span></div>
<div style="position:absolute;left:138.00px;top:96.55px" class="cls_007"><span class="cls_007">We’ve seen the </span><span class="cls_008">stack</span><span class="cls_007"> before. This is where Ruby saves local variables,</span></div>
<div style="position:absolute;left:120.00px;top:108.55px" class="cls_007"><span class="cls_007">return values, and arguments for each of the methods in your program.</span></div>
<div style="position:absolute;left:120.00px;top:120.55px" class="cls_007"><span class="cls_007">Values on the stack are valid only for as long as that method is running.</span></div>
<div style="position:absolute;left:120.00px;top:132.55px" class="cls_007"><span class="cls_007">When a method returns, YARV deletes its stack frame and all the values</span></div>
<div style="position:absolute;left:120.00px;top:144.55px" class="cls_007"><span class="cls_007">inside it.</span></div>
<div style="position:absolute;left:138.00px;top:156.55px" class="cls_007"><span class="cls_007">Ruby uses the </span><span class="cls_008">heap</span><span class="cls_007"> to save information that you might need for a while,</span></div>
<div style="position:absolute;left:120.00px;top:168.55px" class="cls_007"><span class="cls_007">even after a particular method returns. Each value in the heap remains</span></div>
<div style="position:absolute;left:120.00px;top:180.55px" class="cls_007"><span class="cls_007">valid for as long as there is a reference to it. Once a value is no longer</span></div>
<div style="position:absolute;left:120.00px;top:192.55px" class="cls_007"><span class="cls_007">referred to by any variable or object in your program, Ruby’s garbage col-</span></div>
<div style="position:absolute;left:120.00px;top:204.55px" class="cls_007"><span class="cls_007">lection system deletes it, freeing its memory for other uses.</span></div>
<div style="position:absolute;left:138.00px;top:216.55px" class="cls_007"><span class="cls_007">This scheme is not unique to Ruby. In fact, it’s used by many other pro-</span></div>
<div style="position:absolute;left:120.00px;top:228.55px" class="cls_007"><span class="cls_007">gramming languages, including Lisp and C. And remember, Ruby itself is</span></div>
<div style="position:absolute;left:120.00px;top:240.55px" class="cls_007"><span class="cls_007">a C program. YARV’s stack design is based on the way C programs use the</span></div>
<div style="position:absolute;left:120.00px;top:252.55px" class="cls_007"><span class="cls_007">stack, and Ruby’s heap uses the underlying C heap implementation.</span></div>
<div style="position:absolute;left:138.00px;top:264.55px" class="cls_007"><span class="cls_007">The stack and heap differ in one other important aspect. Ruby saves</span></div>
<div style="position:absolute;left:120.00px;top:276.55px" class="cls_007"><span class="cls_007">only references to data on the stack—that is, the </span><span class="cls_030">VALUE</span><span class="cls_007"> pointers. For simple</span></div>
<div style="position:absolute;left:120.00px;top:288.55px" class="cls_007"><span class="cls_007">integer values, symbols, and constants such as </span><span class="cls_030">nil</span><span class="cls_007">, </span><span class="cls_030">true</span><span class="cls_007">, or </span><span class="cls_030">false</span><span class="cls_007">, the refer-</span></div>
<div style="position:absolute;left:120.00px;top:300.55px" class="cls_007"><span class="cls_007">ence is the actual value. However, for all other data types, the </span><span class="cls_030">VALUE</span><span class="cls_007"> is a</span></div>
<div style="position:absolute;left:120.00px;top:312.55px" class="cls_007"><span class="cls_007">pointer to a C structure containing the actual data, such as </span><span class="cls_030">RObject</span><span class="cls_007">. If only</span></div>
<div style="position:absolute;left:120.00px;top:324.55px" class="cls_007"><span class="cls_007">the </span><span class="cls_030">VALUE</span><span class="cls_007"> references go on the stack, where does Ruby save the structures?</span></div>
<div style="position:absolute;left:120.00px;top:336.55px" class="cls_007"><span class="cls_007">In the heap. Let’s look at an example to understand this better.</span></div>
<div style="position:absolute;left:120.00px;top:361.55px" class="cls_055"><span class="cls_055">A Closer Look at How Ruby Saves a String Value</span></div>
<div style="position:absolute;left:120.00px;top:379.55px" class="cls_007"><span class="cls_007">Let’s look in detail at how Ruby handles the string value </span><span class="cls_030">str</span><span class="cls_007"> from Listing 8-10.</span></div>
<div style="position:absolute;left:120.00px;top:391.55px" class="cls_007"><span class="cls_007">First, imagine YARV has a stack frame for the outer scope but has yet to call</span></div>
<div style="position:absolute;left:120.00px;top:403.55px" class="cls_030"><span class="cls_030">message_function</span><span class="cls_007">. Figure 8-11 shows this initial stack frame.</span></div>
<div style="position:absolute;left:140.69px;top:434.46px" class="cls_054"><span class="cls_054">YARV internal stack</span></div>
<div style="position:absolute;left:290.01px;top:440.46px" class="cls_054"><span class="cls_054">Stack frame for</span></div>
<div style="position:absolute;left:287.41px;top:450.06px" class="cls_054"><span class="cls_054">top-level function</span></div>
<div style="position:absolute;left:275.83px;top:469.58px" class="cls_042"><span class="cls_042">rb_control_frame_t</span></div>
<div style="position:absolute;left:120.00px;top:524.95px" class="cls_038"><span class="cls_038">Figure 8-11: To execute the code in Listing 8-11, Ruby starts with an</span></div>
<div style="position:absolute;left:120.00px;top:535.44px" class="cls_038"><span class="cls_038">initial stack frame.</span></div>
<div style="position:absolute;left:138.00px;top:557.95px" class="cls_007"><span class="cls_007">In this figure you can see YARV’s internal stack on the left and the</span></div>
<div style="position:absolute;left:120.00px;top:569.95px" class="cls_030"><span class="cls_030">rb_control_frame_t</span><span class="cls_007"> structure on the right. Now suppose Ruby executes the</span></div>
<div style="position:absolute;left:120.00px;top:581.95px" class="cls_030"><span class="cls_030">message_function</span><span class="cls_007"> function call shown at </span><span class="cls_050">y</span><span class="cls_007"> in Listing 8-10. Figure 8-12 shows</span></div>
<div style="position:absolute;left:120.00px;top:593.95px" class="cls_007"><span class="cls_007">what happens next.</span></div>
<div style="position:absolute;left:48.00px;top:633.00px" class="cls_020"><span class="cls_020">204</span></div>
<div style="position:absolute;left:74.66px;top:636.00px" class="cls_021"><span class="cls_021">Chapter 8</span></div>
</div>
<div style="position:absolute;left:50%;margin-left:-252px;top:152100px;width:504px;height:666px;border-style:outset;overflow:hidden">
<div style="position:absolute;left:0px;top:0px">
<img src="e698b76e-46bd-11eb-8b25-0cc47a792c0a_id_e698b76e-46bd-11eb-8b25-0cc47a792c0a_files/background229.jpg" width=504 height=666></div>
<div style="position:absolute;left:143.69px;top:53.52px" class="cls_054"><span class="cls_054">YARV internal stack</span></div>
<div style="position:absolute;left:262.83px;top:80.64px" class="cls_042"><span class="cls_042">rb_control_frame_t</span></div>
<div style="position:absolute;left:159.83px;top:94.68px" class="cls_014"><span class="cls_014">locals: str</span></div>
<div style="position:absolute;left:277.01px;top:125.40px" class="cls_054"><span class="cls_054">Stack frame for</span></div>
<div style="position:absolute;left:271.34px;top:135.00px" class="cls_014"><span class="cls_014">message_function</span></div>
<div style="position:absolute;left:123.00px;top:198.00px" class="cls_038"><span class="cls_038">Figure 8-12: Ruby creates a second stack frame when calling</span></div>
<div style="position:absolute;left:123.00px;top:208.50px" class="cls_014"><span class="cls_014">message_function</span><span class="cls_038">.</span></div>
<div style="position:absolute;left:141.00px;top:231.00px" class="cls_007"><span class="cls_007">Ruby saves the </span><span class="cls_030">str</span><span class="cls_007"> local variable in the new stack frame used by</span></div>
<div style="position:absolute;left:123.00px;top:243.00px" class="cls_030"><span class="cls_030">message_function</span><span class="cls_007">. Let’s take a closer look at that </span><span class="cls_030">str</span><span class="cls_007"> variable and how</span></div>
<div style="position:absolute;left:123.00px;top:255.00px" class="cls_007"><span class="cls_007">Ruby stores the “quick brown fox” string into it. Ruby stores each of your</span></div>
<div style="position:absolute;left:123.00px;top:267.00px" class="cls_007"><span class="cls_007">objects in a C structure called </span><span class="cls_030">RObject</span><span class="cls_007">, each of your arrays in a structure</span></div>
<div style="position:absolute;left:123.00px;top:279.00px" class="cls_007"><span class="cls_007">called </span><span class="cls_030">RArray</span><span class="cls_007">, each of your strings in a structure called </span><span class="cls_030">RString</span><span class="cls_007">, and so on.</span></div>
<div style="position:absolute;left:123.00px;top:291.00px" class="cls_007"><span class="cls_007">Figure 8-13 shows the “quick brown fox” string saved with </span><span class="cls_030">RString</span><span class="cls_007">.</span></div>
<div style="position:absolute;left:231.17px;top:317.98px" class="cls_020"><span class="cls_020">RString</span></div>
<div style="position:absolute;left:144.50px;top:331.94px" class="cls_067"><span class="cls_067">str</span></div>
<div style="position:absolute;left:231.17px;top:331.94px" class="cls_067"><span class="cls_067">"The quick brown fox"</span></div>
<div style="position:absolute;left:123.00px;top:364.09px" class="cls_038"><span class="cls_038">Figure 8-13: Ruby uses the </span><span class="cls_014">RString</span><span class="cls_038"> C structure to save</span></div>
<div style="position:absolute;left:123.00px;top:374.59px" class="cls_038"><span class="cls_038">string values.</span></div>
<div style="position:absolute;left:141.00px;top:397.09px" class="cls_007"><span class="cls_007">The actual string structure is shown on the right side of the figure, and</span></div>
<div style="position:absolute;left:123.00px;top:409.09px" class="cls_007"><span class="cls_007">a reference, or pointer, to the string is shown on the left. When Ruby saves a</span></div>
<div style="position:absolute;left:123.00px;top:421.09px" class="cls_007"><span class="cls_007">string value (or any object) onto the YARV stack, it actually places only the</span></div>
<div style="position:absolute;left:123.00px;top:433.09px" class="cls_007"><span class="cls_007">reference to the string on the stack. The actual string structure is saved in</span></div>
<div style="position:absolute;left:123.00px;top:445.09px" class="cls_007"><span class="cls_007">the heap instead, as shown in Figure 8-14 on the next page.</span></div>
<div style="position:absolute;left:141.00px;top:457.09px" class="cls_007"><span class="cls_007">Once there are no longer any pointers referencing a particular object</span></div>
<div style="position:absolute;left:123.00px;top:469.09px" class="cls_007"><span class="cls_007">or value in the heap, Ruby frees that object or value during the next run of</span></div>
<div style="position:absolute;left:123.00px;top:481.09px" class="cls_007"><span class="cls_007">the garbage collection system. To demonstrate, suppose that my example</span></div>
<div style="position:absolute;left:123.00px;top:493.09px" class="cls_007"><span class="cls_007">code didn’t call </span><span class="cls_030">lambda</span><span class="cls_007"> at all but rather immediately returned </span><span class="cls_030">nil</span><span class="cls_007"> after sav-</span></div>
<div style="position:absolute;left:123.00px;top:505.09px" class="cls_007"><span class="cls_007">ing the </span><span class="cls_030">str</span><span class="cls_007"> variable, as shown in Listing 8-11.</span></div>
<div style="position:absolute;left:123.00px;top:529.09px" class="cls_030"><span class="cls_030">def message_function</span></div>
<div style="position:absolute;left:131.50px;top:539.59px" class="cls_030"><span class="cls_030">str = "The quick brown fox"</span></div>
<div style="position:absolute;left:131.50px;top:550.09px" class="cls_030"><span class="cls_030">nil</span></div>
<div style="position:absolute;left:123.00px;top:560.59px" class="cls_030"><span class="cls_030">end</span></div>
<div style="position:absolute;left:123.00px;top:584.59px" class="cls_038"><span class="cls_038">Listing 8-11: This code doesn’t call </span><span class="cls_014">lambda</span><span class="cls_038">.</span></div>
<div style="position:absolute;left:290.04px;top:636.00px" class="cls_021"><span class="cls_021">How Ruby Borrowed a Decades-Old Idea from Lisp</span></div>
<div style="position:absolute;left:442.50px;top:633.00px" class="cls_020"><span class="cls_020">205</span></div>
</div>
<div style="position:absolute;left:50%;margin-left:-252px;top:152776px;width:504px;height:666px;border-style:outset;overflow:hidden">
<div style="position:absolute;left:0px;top:0px">
<img src="e698b76e-46bd-11eb-8b25-0cc47a792c0a_id_e698b76e-46bd-11eb-8b25-0cc47a792c0a_files/background230.jpg" width=504 height=666></div>
<div style="position:absolute;left:221.69px;top:53.52px" class="cls_054"><span class="cls_054">YARV internal stack</span></div>
<div style="position:absolute;left:340.83px;top:80.64px" class="cls_042"><span class="cls_042">rb_control_frame_t</span></div>
<div style="position:absolute;left:237.83px;top:94.68px" class="cls_014"><span class="cls_014">locals: str</span></div>
<div style="position:absolute;left:355.01px;top:125.40px" class="cls_054"><span class="cls_054">Stack frame for</span></div>
<div style="position:absolute;left:349.34px;top:135.00px" class="cls_014"><span class="cls_014">message_function</span></div>
<div style="position:absolute;left:120.50px;top:181.19px" class="cls_054"><span class="cls_054">Stack</span></div>
<div style="position:absolute;left:120.50px;top:210.19px" class="cls_054"><span class="cls_054">Heap</span></div>
<div style="position:absolute;left:226.58px;top:234.82px" class="cls_042"><span class="cls_042">RString</span></div>
<div style="position:absolute;left:226.58px;top:248.78px" class="cls_014"><span class="cls_014">"The quick brown fox"</span></div>
<div style="position:absolute;left:120.00px;top:280.93px" class="cls_038"><span class="cls_038">Figure 8-14: The </span><span class="cls_014">str</span><span class="cls_038"> value on the stack is a reference to the </span><span class="cls_014">RString</span><span class="cls_038"> structure saved in</span></div>
<div style="position:absolute;left:120.00px;top:291.43px" class="cls_038"><span class="cls_038">the heap.</span></div>
<div style="position:absolute;left:138.00px;top:313.93px" class="cls_007"><span class="cls_007">Once this call to </span><span class="cls_030">message_function</span><span class="cls_007"> finishes, YARV simply pops the </span><span class="cls_030">str</span></div>
<div style="position:absolute;left:120.00px;top:325.93px" class="cls_007"><span class="cls_007">value off the stack (as well as any other temporary values saved there) and</span></div>
<div style="position:absolute;left:120.00px;top:337.93px" class="cls_007"><span class="cls_007">returns to the original stack frame, as shown in Figure 8-15.</span></div>
<div style="position:absolute;left:221.69px;top:368.84px" class="cls_054"><span class="cls_054">YARV internal stack</span></div>
<div style="position:absolute;left:340.83px;top:395.97px" class="cls_042"><span class="cls_042">rb_control_frame_t</span></div>
<div style="position:absolute;left:361.70px;top:440.73px" class="cls_054"><span class="cls_054">Outer code</span></div>
<div style="position:absolute;left:120.50px;top:443.34px" class="cls_054"><span class="cls_054">Stack</span></div>
<div style="position:absolute;left:361.56px;top:450.33px" class="cls_054"><span class="cls_054">stack frame</span></div>
<div style="position:absolute;left:120.50px;top:492.34px" class="cls_054"><span class="cls_054">Heap</span></div>
<div style="position:absolute;left:272.76px;top:487.74px" class="cls_131"><span class="cls_131">?</span></div>
<div style="position:absolute;left:226.58px;top:539.97px" class="cls_042"><span class="cls_042">RString</span></div>
<div style="position:absolute;left:226.58px;top:553.93px" class="cls_067"><span class="cls_067">"The quick brown fox"</span></div>
<div style="position:absolute;left:345.13px;top:553.93px" class="cls_054"><span class="cls_054">Will later be freed by GC</span></div>
<div style="position:absolute;left:120.00px;top:586.08px" class="cls_038"><span class="cls_038">Figure 8-15: Now there is no longer a reference to the </span><span class="cls_014">RString</span><span class="cls_038"> structure.</span></div>
<div style="position:absolute;left:48.00px;top:633.00px" class="cls_020"><span class="cls_020">206</span></div>
<div style="position:absolute;left:74.61px;top:636.00px" class="cls_021"><span class="cls_021">Chapter 8</span></div>
</div>
<div style="position:absolute;left:50%;margin-left:-252px;top:153452px;width:504px;height:666px;border-style:outset;overflow:hidden">
<div style="position:absolute;left:0px;top:0px">
<img src="e698b76e-46bd-11eb-8b25-0cc47a792c0a_id_e698b76e-46bd-11eb-8b25-0cc47a792c0a_files/background231.jpg" width=504 height=666></div>
<div style="position:absolute;left:141.00px;top:42.28px" class="cls_007"><span class="cls_007">As you can see in the figure, there is no longer a reference to the </span><span class="cls_030">RString</span></div>
<div style="position:absolute;left:123.00px;top:54.28px" class="cls_007"><span class="cls_007">structure containing the “quick brown fox” string. Ruby’s garbage collec-</span></div>
<div style="position:absolute;left:123.00px;top:66.28px" class="cls_007"><span class="cls_007">tion system is designed to identify values in the heap that don’t have any</span></div>
<div style="position:absolute;left:123.00px;top:78.28px" class="cls_007"><span class="cls_007">references to them, like the “quick brown fox” string here. After it identifies</span></div>
<div style="position:absolute;left:123.00px;top:90.28px" class="cls_007"><span class="cls_007">them, the GC system will free those orphaned values, returning that mem-</span></div>
<div style="position:absolute;left:123.00px;top:102.28px" class="cls_007"><span class="cls_007">ory to the heap.</span></div>
<div style="position:absolute;left:123.00px;top:127.28px" class="cls_055"><span class="cls_055">How Ruby Creates a Lambda</span></div>
<div style="position:absolute;left:123.00px;top:145.28px" class="cls_007"><span class="cls_007">Now that we understand a bit more about the heap and how Ruby uses it,</span></div>
<div style="position:absolute;left:123.00px;top:157.28px" class="cls_007"><span class="cls_007">we’re ready to learn more about lambdas. Earlier when I used the phrase</span></div>
<div style="position:absolute;left:123.00px;top:169.28px" class="cls_007"><span class="cls_007">“treating a function as a first-class citizen,” I meant that Ruby allows you to</span></div>
<div style="position:absolute;left:123.00px;top:181.28px" class="cls_007"><span class="cls_007">treat functions or code as a data value, saving them into variables, passing</span></div>
<div style="position:absolute;left:123.00px;top:193.28px" class="cls_007"><span class="cls_007">them as arguments, and so on. Ruby implements this idea using blocks.</span></div>
<div style="position:absolute;left:141.00px;top:205.28px" class="cls_007"><span class="cls_007">The </span><span class="cls_030">lambda</span><span class="cls_007"> (or </span><span class="cls_030">proc</span><span class="cls_007">) keyword converts a block into a data value. But</span></div>
<div style="position:absolute;left:123.00px;top:217.28px" class="cls_007"><span class="cls_007">remember, blocks are Ruby’s implementation of closures. This means the</span></div>
<div style="position:absolute;left:123.00px;top:229.28px" class="cls_007"><span class="cls_007">new data value must somehow contain both the block’s code and referenc-</span></div>
<div style="position:absolute;left:123.00px;top:241.28px" class="cls_007"><span class="cls_007">ing environment.</span></div>
<div style="position:absolute;left:141.00px;top:253.28px" class="cls_007"><span class="cls_007">To see what I mean, let’s return to Listing 8-10, repeated here in</span></div>
<div style="position:absolute;left:123.00px;top:265.28px" class="cls_007"><span class="cls_007">Listing 8-12 with an eye toward its use of </span><span class="cls_030">lambda</span><span class="cls_007">.</span></div>
<div style="position:absolute;left:123.00px;top:289.28px" class="cls_030"><span class="cls_030">def message_function</span></div>
<div style="position:absolute;left:111.15px;top:299.78px" class="cls_046"><span class="cls_046">u</span><span class="cls_030">   str = "The quick brown fox"</span></div>
<div style="position:absolute;left:111.15px;top:310.27px" class="cls_046"><span class="cls_046">v</span><span class="cls_030">   lambda do |animal|</span></div>
<div style="position:absolute;left:111.15px;top:320.77px" class="cls_046"><span class="cls_046">w</span><span class="cls_030">     puts "#{str} jumps over the lazy #{animal}."</span></div>
<div style="position:absolute;left:131.50px;top:331.27px" class="cls_030"><span class="cls_030">end</span></div>
<div style="position:absolute;left:123.00px;top:341.77px" class="cls_030"><span class="cls_030">end</span></div>
<div style="position:absolute;left:123.00px;top:352.27px" class="cls_030"><span class="cls_030">function_value = message_function</span></div>
<div style="position:absolute;left:111.15px;top:362.76px" class="cls_046"><span class="cls_046">x</span><span class="cls_030"> function_value.call('dog')</span></div>
<div style="position:absolute;left:123.00px;top:385.26px" class="cls_038"><span class="cls_038">Listing 8-12: Using </span><span class="cls_014">lambda</span><span class="cls_038"> in Ruby (repeated from Listing 8-10)</span></div>
<div style="position:absolute;left:141.00px;top:407.78px" class="cls_007"><span class="cls_007">Notice at </span><span class="cls_050">x</span><span class="cls_007"> that when we call the lambda (the block), the </span><span class="cls_030">puts</span><span class="cls_007"> state-</span></div>
<div style="position:absolute;left:123.00px;top:419.78px" class="cls_007"><span class="cls_007">ment inside the block at </span><span class="cls_050">w</span><span class="cls_007"> can access the </span><span class="cls_030">str</span><span class="cls_007"> string variable defined at </span><span class="cls_050">u</span></div>
<div style="position:absolute;left:123.00px;top:431.78px" class="cls_007"><span class="cls_007">inside </span><span class="cls_030">message_function</span><span class="cls_007">. How can this be? We’ve just seen how the </span><span class="cls_030">str</span><span class="cls_007"> refer-</span></div>
<div style="position:absolute;left:123.01px;top:443.78px" class="cls_007"><span class="cls_007">ence to the </span><span class="cls_030">RString</span><span class="cls_007"> structure is popped off the stack when </span><span class="cls_030">message_function</span></div>
<div style="position:absolute;left:123.00px;top:455.78px" class="cls_007"><span class="cls_007">returns! Obviously, after calling </span><span class="cls_030">lambda</span><span class="cls_007">, the value of </span><span class="cls_030">str</span><span class="cls_007"> lives on so that the</span></div>
<div style="position:absolute;left:123.00px;top:467.78px" class="cls_007"><span class="cls_007">block can access it later.</span></div>
<div style="position:absolute;left:141.00px;top:479.78px" class="cls_007"><span class="cls_007">When you call </span><span class="cls_030">lambda</span><span class="cls_007">, Ruby copies the entire contents of the current</span></div>
<div style="position:absolute;left:123.00px;top:491.78px" class="cls_007"><span class="cls_007">YARV stack frame into the heap, where the </span><span class="cls_030">RString</span><span class="cls_007"> structure is located.</span></div>
<div style="position:absolute;left:123.00px;top:503.78px" class="cls_007"><span class="cls_007">For example, Figure 8-16 shows how the YARV stack looks just after the</span></div>
<div style="position:absolute;left:123.00px;top:515.78px" class="cls_030"><span class="cls_030">message_function</span><span class="cls_007"> starts at </span><span class="cls_050">u</span><span class="cls_007"> in Listing 8-12. (To keep things simple, I’m not</span></div>
<div style="position:absolute;left:123.00px;top:527.78px" class="cls_007"><span class="cls_007">showing the </span><span class="cls_030">RString</span><span class="cls_007"> structure, but remember that the </span><span class="cls_030">RString</span><span class="cls_007"> structure will</span></div>
<div style="position:absolute;left:123.00px;top:539.78px" class="cls_007"><span class="cls_007">also be saved in the heap.)</span></div>
<div style="position:absolute;left:290.18px;top:636.00px" class="cls_021"><span class="cls_021">How Ruby Borrowed a Decades-Old Idea from Lisp</span></div>
<div style="position:absolute;left:442.64px;top:633.00px" class="cls_020"><span class="cls_020">207</span></div>
</div>
<div style="position:absolute;left:50%;margin-left:-252px;top:154128px;width:504px;height:666px;border-style:outset;overflow:hidden">
<div style="position:absolute;left:0px;top:0px">
<img src="e698b76e-46bd-11eb-8b25-0cc47a792c0a_id_e698b76e-46bd-11eb-8b25-0cc47a792c0a_files/background232.jpg" width=504 height=666></div>
<div style="position:absolute;left:140.69px;top:53.52px" class="cls_054"><span class="cls_054">YARV internal stack</span></div>
<div style="position:absolute;left:259.83px;top:80.64px" class="cls_042"><span class="cls_042">rb_control_frame_t</span></div>
<div style="position:absolute;left:156.83px;top:94.68px" class="cls_014"><span class="cls_014">locals: str</span></div>
<div style="position:absolute;left:274.01px;top:125.40px" class="cls_054"><span class="cls_054">Stack frame for</span></div>
<div style="position:absolute;left:268.34px;top:135.00px" class="cls_014"><span class="cls_014">message_function</span></div>
<div style="position:absolute;left:120.00px;top:198.00px" class="cls_038"><span class="cls_038">Figure 8-16: Ruby creates a second stack frame when calling</span></div>
<div style="position:absolute;left:120.00px;top:208.50px" class="cls_014"><span class="cls_014">message_function</span><span class="cls_038">.</span></div>
<div style="position:absolute;left:138.00px;top:231.00px" class="cls_007"><span class="cls_007">Next, Listing 8-12 calls </span><span class="cls_030">lambda</span><span class="cls_007"> at </span><span class="cls_050">v</span><span class="cls_007">. Figure 8-17 shows what happens in</span></div>
<div style="position:absolute;left:120.00px;top:243.00px" class="cls_007"><span class="cls_007">Ruby when you call </span><span class="cls_030">lambda</span><span class="cls_007">.</span></div>
<div style="position:absolute;left:138.00px;top:255.00px" class="cls_007"><span class="cls_007">The horizontal stack icon below the dotted line shows that Ruby creates</span></div>
<div style="position:absolute;left:120.00px;top:267.00px" class="cls_007"><span class="cls_007">a new copy of the stack frame for </span><span class="cls_030">message_function</span><span class="cls_007"> in the heap. Now there</span></div>
<div style="position:absolute;left:120.00px;top:279.00px" class="cls_007"><span class="cls_007">is a second reference to the </span><span class="cls_030">str RString</span><span class="cls_007"> structure, which means that Ruby</span></div>
<div style="position:absolute;left:120.00px;top:291.00px" class="cls_007"><span class="cls_007">won’t free it when </span><span class="cls_030">message_function</span><span class="cls_007"> returns.</span></div>
<div style="position:absolute;left:138.00px;top:303.00px" class="cls_007"><span class="cls_007">In fact, along with the copy of the stack frame, Ruby creates two other</span></div>
<div style="position:absolute;left:120.00px;top:315.00px" class="cls_007"><span class="cls_007">new objects in the heap:</span></div>
<div style="position:absolute;left:120.00px;top:336.00px" class="cls_050"><span class="cls_050">•</span><span class="cls_007">   An internal environment object, represented by the </span><span class="cls_030">rb_env_t</span><span class="cls_007"> C structure</span></div>
<div style="position:absolute;left:138.00px;top:348.00px" class="cls_007"><span class="cls_007">at the lower left of the figure. It’s essentially a wrapper for the heap copy</span></div>
<div style="position:absolute;left:138.00px;top:360.00px" class="cls_007"><span class="cls_007">of the stack. As we’ll see in Chapter 9, you can access this environment</span></div>
<div style="position:absolute;left:138.00px;top:372.00px" class="cls_007"><span class="cls_007">object indirectly in your programs using the </span><span class="cls_030">Binding</span><span class="cls_007"> class.</span></div>
<div style="position:absolute;left:120.00px;top:387.00px" class="cls_050"><span class="cls_050">•</span><span class="cls_007">   A Ruby proc object, represented by the </span><span class="cls_030">rb_proc_t</span><span class="cls_007"> structure. This</span></div>
<div style="position:absolute;left:138.00px;top:399.00px" class="cls_007"><span class="cls_007">is the actual return value from the </span><span class="cls_030">lambda</span><span class="cls_007"> keyword; it’s what the</span></div>
<div style="position:absolute;left:138.00px;top:411.00px" class="cls_030"><span class="cls_030">message_function</span><span class="cls_007"> function returns.</span></div>
<div style="position:absolute;left:138.00px;top:432.00px" class="cls_007"><span class="cls_007">Note that the new proc object, the </span><span class="cls_030">rb_proc_t</span><span class="cls_007"> structure, contains an</span></div>
<div style="position:absolute;left:120.00px;top:444.00px" class="cls_030"><span class="cls_030">rb_block_t</span><span class="cls_007"> structure, including the </span><span class="cls_030">iseq</span><span class="cls_007"> and </span><span class="cls_030">EP</span><span class="cls_007"> pointers. Think of a proc as</span></div>
<div style="position:absolute;left:120.00px;top:456.00px" class="cls_007"><span class="cls_007">a kind of Ruby object that wraps up a block. As with a normal block, these</span></div>
<div style="position:absolute;left:120.00px;top:468.00px" class="cls_007"><span class="cls_007">keep track of the block’s code and the referencing environment for its</span></div>
<div style="position:absolute;left:120.00px;top:480.00px" class="cls_007"><span class="cls_007">closure. Ruby sets the </span><span class="cls_030">EP</span><span class="cls_007"> in this block to point to the new heap copy of the</span></div>
<div style="position:absolute;left:120.00px;top:492.00px" class="cls_007"><span class="cls_007">stack frame.</span></div>
<div style="position:absolute;left:138.00px;top:504.00px" class="cls_007"><span class="cls_007">Also, notice that the proc object contains an internal value called</span></div>
<div style="position:absolute;left:120.00px;top:516.00px" class="cls_030"><span class="cls_030">is_lambda</span><span class="cls_007">. This is set to </span><span class="cls_030">true</span><span class="cls_007"> for this example because we used the </span><span class="cls_030">lambda</span></div>
<div style="position:absolute;left:120.00px;top:528.00px" class="cls_007"><span class="cls_007">keyword to create the proc. If I had instead created the proc using the</span></div>
<div style="position:absolute;left:120.00px;top:540.00px" class="cls_030"><span class="cls_030">proc</span><span class="cls_007"> keyword, or simply by calling </span><span class="cls_030">Proc.new</span><span class="cls_007">, then </span><span class="cls_030">is_lambda</span><span class="cls_007"> would have been</span></div>
<div style="position:absolute;left:120.00px;top:552.00px" class="cls_007"><span class="cls_007">set to </span><span class="cls_030">false</span><span class="cls_007">. Ruby uses this flag to produce the slight behavior differences</span></div>
<div style="position:absolute;left:120.00px;top:564.00px" class="cls_007"><span class="cls_007">between procs and lambdas, though it’s best to think of procs and lambdas</span></div>
<div style="position:absolute;left:120.00px;top:576.00px" class="cls_007"><span class="cls_007">as essentially the same.</span></div>
<div style="position:absolute;left:48.00px;top:633.00px" class="cls_020"><span class="cls_020">208</span></div>
<div style="position:absolute;left:74.63px;top:636.00px" class="cls_021"><span class="cls_021">Chapter 8</span></div>
</div>
<div style="position:absolute;left:50%;margin-left:-252px;top:154804px;width:504px;height:666px;border-style:outset;overflow:hidden">
<div style="position:absolute;left:0px;top:0px">
<img src="e698b76e-46bd-11eb-8b25-0cc47a792c0a_id_e698b76e-46bd-11eb-8b25-0cc47a792c0a_files/background233.jpg" width=504 height=666></div>
<div style="position:absolute;left:378.48px;top:49.40px" class="cls_054"><span class="cls_054">Stack frame for</span></div>
<div style="position:absolute;left:224.69px;top:53.52px" class="cls_054"><span class="cls_054">YARV internal stack</span></div>
<div style="position:absolute;left:372.80px;top:59.00px" class="cls_014"><span class="cls_014">message_function</span></div>
<div style="position:absolute;left:364.30px;top:80.64px" class="cls_042"><span class="cls_042">rb_control_frame_t</span></div>
<div style="position:absolute;left:240.83px;top:94.68px" class="cls_014"><span class="cls_014">locals: str</span></div>
<div style="position:absolute;left:123.50px;top:181.20px" class="cls_054"><span class="cls_054">Stack</span></div>
<div style="position:absolute;left:123.50px;top:210.20px" class="cls_054"><span class="cls_054">Heap</span></div>
<div style="position:absolute;left:303.67px;top:229.46px" class="cls_014"><span class="cls_014">str</span></div>
<div style="position:absolute;left:364.30px;top:229.22px" class="cls_042"><span class="cls_042">rb_proc_t</span></div>
<div style="position:absolute;left:377.82px;top:253.26px" class="cls_042"><span class="cls_042">rb_block_t</span></div>
<div style="position:absolute;left:396.80px;top:267.23px" class="cls_014"><span class="cls_014">iseq</span></div>
<div style="position:absolute;left:400.80px;top:289.30px" class="cls_014"><span class="cls_014">EP</span></div>
<div style="position:absolute;left:229.60px;top:306.01px" class="cls_042"><span class="cls_042">rb_env_t</span></div>
<div style="position:absolute;left:264.17px;top:319.97px" class="cls_014"><span class="cls_014">env</span></div>
<div style="position:absolute;left:392.80px;top:317.10px" class="cls_014"><span class="cls_014">envval</span></div>
<div style="position:absolute;left:386.80px;top:348.97px" class="cls_014"><span class="cls_014">is_lambda</span></div>
<div style="position:absolute;left:123.00px;top:380.53px" class="cls_038"><span class="cls_038">Figure 8-17: When you call </span><span class="cls_014">lambda</span><span class="cls_038">, Ruby copies the current stack frame to the heap.</span></div>
<div style="position:absolute;left:123.00px;top:416.03px" class="cls_055"><span class="cls_055">How Ruby Calls a Lambda</span></div>
<div style="position:absolute;left:123.00px;top:434.03px" class="cls_007"><span class="cls_007">Let’s go back to our lambda example in Listing 8-13.</span></div>
<div style="position:absolute;left:123.00px;top:458.03px" class="cls_030"><span class="cls_030">def message_function</span></div>
<div style="position:absolute;left:131.50px;top:468.53px" class="cls_030"><span class="cls_030">str = "The quick brown fox"</span></div>
<div style="position:absolute;left:131.50px;top:479.02px" class="cls_030"><span class="cls_030">lambda do |animal|</span></div>
<div style="position:absolute;left:140.00px;top:489.52px" class="cls_030"><span class="cls_030">puts "#{str} jumps over the lazy #{animal}."</span></div>
<div style="position:absolute;left:131.50px;top:500.02px" class="cls_030"><span class="cls_030">end</span></div>
<div style="position:absolute;left:123.00px;top:510.52px" class="cls_030"><span class="cls_030">end</span></div>
<div style="position:absolute;left:111.15px;top:521.01px" class="cls_046"><span class="cls_046">u</span><span class="cls_030"> function_value = message_function</span></div>
<div style="position:absolute;left:111.15px;top:531.51px" class="cls_046"><span class="cls_046">v</span><span class="cls_030"> function_value.call('dog')</span></div>
<div style="position:absolute;left:123.00px;top:554.01px" class="cls_038"><span class="cls_038">Listing 8-13: Using </span><span class="cls_014">lambda</span><span class="cls_038"> in Ruby (repeated again from Listing 8-10)</span></div>
<div style="position:absolute;left:289.89px;top:636.00px" class="cls_021"><span class="cls_021">How Ruby Borrowed a Decades-Old Idea from Lisp</span></div>
<div style="position:absolute;left:442.36px;top:633.00px" class="cls_020"><span class="cls_020">209</span></div>
</div>
<div style="position:absolute;left:50%;margin-left:-252px;top:155480px;width:504px;height:666px;border-style:outset;overflow:hidden">
<div style="position:absolute;left:0px;top:0px">
<img src="e698b76e-46bd-11eb-8b25-0cc47a792c0a_id_e698b76e-46bd-11eb-8b25-0cc47a792c0a_files/background234.jpg" width=504 height=666></div>
<div style="position:absolute;left:138.00px;top:42.71px" class="cls_007"><span class="cls_007">What happens when </span><span class="cls_030">message_function</span><span class="cls_007"> returns at </span><span class="cls_050">u</span><span class="cls_007">? Because the lambda</span></div>
<div style="position:absolute;left:119.99px;top:54.71px" class="cls_007"><span class="cls_007">or proc object is its return value, a reference to the lambda is saved in the</span></div>
<div style="position:absolute;left:119.99px;top:66.71px" class="cls_007"><span class="cls_007">stack frame for the outer scope in the </span><span class="cls_030">function_value</span><span class="cls_007"> local variable. This pre-</span></div>
<div style="position:absolute;left:120.00px;top:78.71px" class="cls_007"><span class="cls_007">vents Ruby from freeing the proc, the internal environment object, and the</span></div>
<div style="position:absolute;left:120.00px;top:90.71px" class="cls_030"><span class="cls_030">str</span><span class="cls_007"> variable, and there are now pointers referring to all of these values in</span></div>
<div style="position:absolute;left:120.00px;top:102.71px" class="cls_007"><span class="cls_007">the heap (see Figure 8-18).</span></div>
<div style="position:absolute;left:196.19px;top:133.68px" class="cls_054"><span class="cls_054">YARV internal stack</span></div>
<div style="position:absolute;left:346.33px;top:160.80px" class="cls_042"><span class="cls_042">rb_control_frame_t</span></div>
<div style="position:absolute;left:212.33px;top:173.85px" class="cls_014"><span class="cls_014">locals: function_value</span></div>
<div style="position:absolute;left:367.20px;top:205.57px" class="cls_054"><span class="cls_054">Outer code</span></div>
<div style="position:absolute;left:120.50px;top:208.18px" class="cls_054"><span class="cls_054">Stack</span></div>
<div style="position:absolute;left:367.06px;top:215.17px" class="cls_054"><span class="cls_054">stack frame</span></div>
<div style="position:absolute;left:120.50px;top:257.18px" class="cls_054"><span class="cls_054">Heap</span></div>
<div style="position:absolute;left:215.22px;top:275.80px" class="cls_042"><span class="cls_042">rb_proc_t</span></div>
<div style="position:absolute;left:215.22px;top:340.80px" class="cls_042"><span class="cls_042">rb_env_t</span></div>
<div style="position:absolute;left:373.84px;top:351.89px" class="cls_014"><span class="cls_014">str</span></div>
<div style="position:absolute;left:120.00px;top:386.91px" class="cls_038"><span class="cls_038">Figure 8-18: Once </span><span class="cls_014">message_function</span><span class="cls_038"> returns, the surrounding code holds a reference to</span></div>
<div style="position:absolute;left:120.00px;top:397.41px" class="cls_038"><span class="cls_038">the proc object.</span></div>
<div style="position:absolute;left:138.00px;top:419.91px" class="cls_007"><span class="cls_007">When Ruby executes the </span><span class="cls_030">call</span><span class="cls_007"> method on the proc object at </span><span class="cls_050">v</span><span class="cls_007">, it exe-</span></div>
<div style="position:absolute;left:120.01px;top:431.91px" class="cls_007"><span class="cls_007">cutes its block as well. Figure 8-19 shows what happens in Ruby when you</span></div>
<div style="position:absolute;left:120.01px;top:443.91px" class="cls_007"><span class="cls_007">use the </span><span class="cls_030">call</span><span class="cls_007"> method on a lambda or proc.</span></div>
<div style="position:absolute;left:138.00px;top:455.91px" class="cls_007"><span class="cls_007">As with any block, when Ruby calls the block inside a proc object it</span></div>
<div style="position:absolute;left:120.00px;top:467.91px" class="cls_007"><span class="cls_007">creates a new stack frame and sets the </span><span class="cls_030">EP</span><span class="cls_007"> to the block’s referencing envi-</span></div>
<div style="position:absolute;left:120.00px;top:479.91px" class="cls_007"><span class="cls_007">ronment. However, that environment is a copy of a stack frame previously</span></div>
<div style="position:absolute;left:120.00px;top:491.91px" class="cls_007"><span class="cls_007">copied into the heap; the new stack frame contains an </span><span class="cls_030">EP</span><span class="cls_007"> that points to</span></div>
<div style="position:absolute;left:120.00px;top:503.91px" class="cls_007"><span class="cls_007">the heap. This </span><span class="cls_030">EP</span><span class="cls_007"> allows the block’s call to </span><span class="cls_030">puts</span><span class="cls_007"> to access the </span><span class="cls_030">str</span><span class="cls_007"> value</span></div>
<div style="position:absolute;left:120.00px;top:515.91px" class="cls_007"><span class="cls_007">defined in </span><span class="cls_030">message_function</span><span class="cls_007">. Figure 8-19 shows the argument to the proc,</span></div>
<div style="position:absolute;left:120.00px;top:527.91px" class="cls_030"><span class="cls_030">animal</span><span class="cls_007">, saved in the new stack frame, like any other method or block</span></div>
<div style="position:absolute;left:120.00px;top:539.91px" class="cls_007"><span class="cls_007">argument.</span></div>
<div style="position:absolute;left:48.00px;top:633.00px" class="cls_020"><span class="cls_020">210</span></div>
<div style="position:absolute;left:73.92px;top:636.00px" class="cls_021"><span class="cls_021">Chapter 8</span></div>
</div>
<div style="position:absolute;left:50%;margin-left:-252px;top:156156px;width:504px;height:666px;border-style:outset;overflow:hidden">
<div style="position:absolute;left:0px;top:0px">
<img src="e698b76e-46bd-11eb-8b25-0cc47a792c0a_id_e698b76e-46bd-11eb-8b25-0cc47a792c0a_files/background235.jpg" width=504 height=666></div>
<div style="position:absolute;left:224.69px;top:53.52px" class="cls_054"><span class="cls_054">YARV internal stack</span></div>
<div style="position:absolute;left:364.30px;top:80.64px" class="cls_042"><span class="cls_042">rb_control_frame_t</span></div>
<div style="position:absolute;left:240.83px;top:94.68px" class="cls_014"><span class="cls_014">argument:</span></div>
<div style="position:absolute;left:240.83px;top:104.28px" class="cls_014"><span class="cls_014">animal</span></div>
<div style="position:absolute;left:266.17px;top:125.99px" class="cls_014"><span class="cls_014">EP</span></div>
<div style="position:absolute;left:384.39px;top:125.40px" class="cls_054"><span class="cls_054">Stack frame</span></div>
<div style="position:absolute;left:380.88px;top:135.00px" class="cls_054"><span class="cls_054">for </span><span class="cls_014">Proc.call</span></div>
<div style="position:absolute;left:123.50px;top:181.20px" class="cls_054"><span class="cls_054">Stack</span></div>
<div style="position:absolute;left:123.50px;top:210.20px" class="cls_054"><span class="cls_054">Heap</span></div>
<div style="position:absolute;left:303.67px;top:229.46px" class="cls_014"><span class="cls_014">str</span></div>
<div style="position:absolute;left:364.30px;top:229.22px" class="cls_042"><span class="cls_042">rb_proc_t</span></div>
<div style="position:absolute;left:377.82px;top:253.26px" class="cls_042"><span class="cls_042">rb_block_t</span></div>
<div style="position:absolute;left:396.80px;top:267.23px" class="cls_014"><span class="cls_014">iseq</span></div>
<div style="position:absolute;left:400.80px;top:289.30px" class="cls_014"><span class="cls_014">EP</span></div>
<div style="position:absolute;left:229.60px;top:306.01px" class="cls_042"><span class="cls_042">rb_env_t</span></div>
<div style="position:absolute;left:264.17px;top:319.97px" class="cls_014"><span class="cls_014">env</span></div>
<div style="position:absolute;left:392.80px;top:317.10px" class="cls_014"><span class="cls_014">envval</span></div>
<div style="position:absolute;left:386.80px;top:348.97px" class="cls_014"><span class="cls_014">is_lambda</span></div>
<div style="position:absolute;left:123.00px;top:380.53px" class="cls_038"><span class="cls_038">Figure 8-19: Calling a proc object creates a new stack frame as usual and sets the </span><span class="cls_014">EP</span><span class="cls_038"> to</span></div>
<div style="position:absolute;left:123.00px;top:391.03px" class="cls_038"><span class="cls_038">point to the heap’s referencing environment.</span></div>
<div style="position:absolute;left:123.00px;top:426.53px" class="cls_055"><span class="cls_055">The Proc Object</span></div>
<div style="position:absolute;left:123.00px;top:444.53px" class="cls_007"><span class="cls_007">We’ve seen that Ruby really has no structure called </span><span class="cls_030">rb_lambda_t</span><span class="cls_007">. In other</span></div>
<div style="position:absolute;left:123.00px;top:456.53px" class="cls_007"><span class="cls_007">words, the structure shown in Figure 8-20 doesn’t actually exist.</span></div>
<div style="position:absolute;left:129.65px;top:483.51px" class="cls_042"><span class="cls_042">rb_lambda_t</span></div>
<div style="position:absolute;left:152.63px;top:497.47px" class="cls_067"><span class="cls_067">??</span></div>
<div style="position:absolute;left:123.00px;top:529.62px" class="cls_038"><span class="cls_038">Figure 8-20: Ruby doesn’t actually</span></div>
<div style="position:absolute;left:123.00px;top:540.12px" class="cls_038"><span class="cls_038">use a structure called </span><span class="cls_014">rb_lambda_t</span><span class="cls_038">.</span></div>
<div style="position:absolute;left:291.03px;top:636.00px" class="cls_021"><span class="cls_021">How Ruby Borrowed a Decades-Old Idea from Lisp</span></div>
<div style="position:absolute;left:443.50px;top:633.00px" class="cls_020"><span class="cls_020">211</span></div>
</div>
<div style="position:absolute;left:50%;margin-left:-252px;top:156832px;width:504px;height:666px;border-style:outset;overflow:hidden">
<div style="position:absolute;left:0px;top:0px">
<img src="e698b76e-46bd-11eb-8b25-0cc47a792c0a_id_e698b76e-46bd-11eb-8b25-0cc47a792c0a_files/background236.jpg" width=504 height=666></div>
<div style="position:absolute;left:138.00px;top:42.28px" class="cls_007"><span class="cls_007">Instead, in this example, Ruby’s </span><span class="cls_030">lambda</span><span class="cls_007"> keyword created a proc object—</span></div>
<div style="position:absolute;left:120.00px;top:54.28px" class="cls_007"><span class="cls_007">really, a wrapper for the block we passed to the </span><span class="cls_030">lambda</span><span class="cls_007"> or </span><span class="cls_030">proc</span><span class="cls_007"> keyword.</span></div>
<div style="position:absolute;left:120.00px;top:66.28px" class="cls_007"><span class="cls_007">Ruby represents procs using an </span><span class="cls_030">rb_proc_t</span><span class="cls_007"> C structure, as you can see in</span></div>
<div style="position:absolute;left:120.00px;top:78.28px" class="cls_007"><span class="cls_007">Figure 8-21.</span></div>
<div style="position:absolute;left:270.60px;top:110.00px" class="cls_014"><span class="cls_014">putself</span></div>
<div style="position:absolute;left:270.60px;top:119.00px" class="cls_014"><span class="cls_014">getlocal</span></div>
<div style="position:absolute;left:348.60px;top:119.00px" class="cls_014"><span class="cls_014">2, 1</span></div>
<div style="position:absolute;left:270.60px;top:128.00px" class="cls_014"><span class="cls_014">tostring</span></div>
<div style="position:absolute;left:270.60px;top:137.00px" class="cls_014"><span class="cls_014">putobject</span></div>
<div style="position:absolute;left:348.60px;top:137.00px" class="cls_014"><span class="cls_014">"jumps over the lazy"</span></div>
<div style="position:absolute;left:270.60px;top:146.00px" class="cls_014"><span class="cls_014">getlocal</span></div>
<div style="position:absolute;left:348.60px;top:146.00px" class="cls_014"><span class="cls_014">2, 0</span></div>
<div style="position:absolute;left:270.60px;top:155.00px" class="cls_014"><span class="cls_014">tostring</span></div>
<div style="position:absolute;left:128.70px;top:157.25px" class="cls_042"><span class="cls_042">rb_proc_t</span></div>
<div style="position:absolute;left:270.60px;top:164.00px" class="cls_014"><span class="cls_014">putobject</span></div>
<div style="position:absolute;left:348.60px;top:164.00px" class="cls_014"><span class="cls_014">"."</span></div>
<div style="position:absolute;left:270.60px;top:173.00px" class="cls_014"><span class="cls_014">concatstrings</span></div>
<div style="position:absolute;left:348.60px;top:173.00px" class="cls_014"><span class="cls_014">4</span></div>
<div style="position:absolute;left:142.22px;top:181.30px" class="cls_042"><span class="cls_042">rb_block_t</span></div>
<div style="position:absolute;left:270.60px;top:182.00px" class="cls_014"><span class="cls_014">opt_send_simple</span></div>
<div style="position:absolute;left:348.60px;top:182.00px" class="cls_014"><span class="cls_014">&lt;callinfo!mid:puts, ...</span></div>
<div style="position:absolute;left:270.60px;top:191.00px" class="cls_014"><span class="cls_014">leave</span></div>
<div style="position:absolute;left:161.20px;top:195.26px" class="cls_014"><span class="cls_014">iseq</span></div>
<div style="position:absolute;left:165.20px;top:217.34px" class="cls_014"><span class="cls_014">EP</span></div>
<div style="position:absolute;left:157.20px;top:245.14px" class="cls_014"><span class="cls_014">envval</span></div>
<div style="position:absolute;left:295.62px;top:249.48px" class="cls_054"><span class="cls_054">Heap copy of stack frame</span></div>
<div style="position:absolute;left:340.44px;top:270.74px" class="cls_014"><span class="cls_014">locals: str</span></div>
<div style="position:absolute;left:151.20px;top:277.01px" class="cls_014"><span class="cls_014">is_lambda</span></div>
<div style="position:absolute;left:120.00px;top:308.57px" class="cls_038"><span class="cls_038">Figure 8-21: Ruby procs are closures; they contain pointers to a function and a referencing</span></div>
<div style="position:absolute;left:120.00px;top:319.06px" class="cls_038"><span class="cls_038">environment.</span></div>
<div style="position:absolute;left:138.00px;top:347.57px" class="cls_007"><span class="cls_007">This is a closure: It contains a function along with the environment that</span></div>
<div style="position:absolute;left:120.00px;top:359.57px" class="cls_007"><span class="cls_007">function was referred to or created in. The environment is a persistent copy</span></div>
<div style="position:absolute;left:120.00px;top:371.57px" class="cls_007"><span class="cls_007">of the stack frame saved in the heap.</span></div>
<div style="position:absolute;left:138.00px;top:383.57px" class="cls_007"><span class="cls_007">A proc is a Ruby object. It contains the same information as other</span></div>
<div style="position:absolute;left:120.00px;top:395.57px" class="cls_007"><span class="cls_007">objects, including the </span><span class="cls_030">RBasic</span><span class="cls_007"> structure. To save its object-related informa-</span></div>
<div style="position:absolute;left:120.00px;top:407.57px" class="cls_007"><span class="cls_007">tion, Ruby uses a structure called </span><span class="cls_030">RTypedData</span><span class="cls_007">, along with </span><span class="cls_030">rb_proc_t</span><span class="cls_007">, to repre-</span></div>
<div style="position:absolute;left:119.99px;top:419.57px" class="cls_007"><span class="cls_007">sent instances of the proc object. Figure 8-22 shows how these structures</span></div>
<div style="position:absolute;left:119.99px;top:431.57px" class="cls_007"><span class="cls_007">work together.</span></div>
<div style="position:absolute;left:137.99px;top:443.57px" class="cls_007"><span class="cls_007">You might think of </span><span class="cls_030">RTypedData</span><span class="cls_007"> as a kind of trick that Ruby’s C code uses</span></div>
<div style="position:absolute;left:120.00px;top:455.57px" class="cls_007"><span class="cls_007">to create a Ruby object wrapper around a C data structure. In this case, Ruby</span></div>
<div style="position:absolute;left:120.00px;top:467.57px" class="cls_007"><span class="cls_007">uses </span><span class="cls_030">RTypedData</span><span class="cls_007"> to create an instance of the </span><span class="cls_030">Proc</span><span class="cls_007"> Ruby class that represents</span></div>
<div style="position:absolute;left:120.00px;top:479.57px" class="cls_007"><span class="cls_007">a single copy of the </span><span class="cls_030">rb_proc_t</span><span class="cls_007"> structure. The </span><span class="cls_030">RTypedData</span><span class="cls_007"> structure contains</span></div>
<div style="position:absolute;left:120.00px;top:491.57px" class="cls_007"><span class="cls_007">the same </span><span class="cls_030">RBasic</span><span class="cls_007"> information as all Ruby objects:</span></div>
<div style="position:absolute;left:138.00px;top:509.57px" class="cls_040"><span class="cls_040">flags</span><span class="cls_007">   Certain internal technical information Ruby needs to track</span></div>
<div style="position:absolute;left:138.00px;top:524.57px" class="cls_040"><span class="cls_040">klass</span><span class="cls_007">   A pointer to the Ruby class that the object is an instance of;</span></div>
<div style="position:absolute;left:138.00px;top:536.57px" class="cls_007"><span class="cls_007">the </span><span class="cls_030">Proc</span><span class="cls_007"> class in this example</span></div>
<div style="position:absolute;left:48.00px;top:633.00px" class="cls_020"><span class="cls_020">212</span></div>
<div style="position:absolute;left:73.77px;top:636.00px" class="cls_021"><span class="cls_021">Chapter 8</span></div>
</div>
<div style="position:absolute;left:50%;margin-left:-252px;top:157508px;width:504px;height:666px;border-style:outset;overflow:hidden">
<div style="position:absolute;left:0px;top:0px">
<img src="e698b76e-46bd-11eb-8b25-0cc47a792c0a_id_e698b76e-46bd-11eb-8b25-0cc47a792c0a_files/background237.jpg" width=504 height=666></div>
<div style="position:absolute;left:161.42px;top:48.10px" class="cls_094"><span class="cls_094">VALUE</span></div>
<div style="position:absolute;left:131.53px;top:81.20px" class="cls_146"><span class="cls_146">RTypedData</span></div>
<div style="position:absolute;left:144.78px;top:104.77px" class="cls_146"><span class="cls_146">RBasic</span></div>
<div style="position:absolute;left:161.42px;top:118.45px" class="cls_094"><span class="cls_094">flags</span></div>
<div style="position:absolute;left:267.66px;top:128.30px" class="cls_146"><span class="cls_146">RClass</span></div>
<div style="position:absolute;left:161.42px;top:140.08px" class="cls_094"><span class="cls_094">klass</span></div>
<div style="position:absolute;left:277.46px;top:141.98px" class="cls_094"><span class="cls_094">[Proc class]</span></div>
<div style="position:absolute;left:163.38px;top:164.39px" class="cls_094"><span class="cls_094">data</span></div>
<div style="position:absolute;left:131.53px;top:207.52px" class="cls_146"><span class="cls_146">rb_proc_t</span></div>
<div style="position:absolute;left:144.78px;top:231.08px" class="cls_146"><span class="cls_146">rb_block_t</span></div>
<div style="position:absolute;left:163.38px;top:244.77px" class="cls_094"><span class="cls_094">iseq</span></div>
<div style="position:absolute;left:167.30px;top:266.40px" class="cls_094"><span class="cls_094">EP</span></div>
<div style="position:absolute;left:159.46px;top:290.71px" class="cls_094"><span class="cls_094">envval</span></div>
<div style="position:absolute;left:153.58px;top:316.06px" class="cls_094"><span class="cls_094">is_lambda</span></div>
<div style="position:absolute;left:123.00px;top:344.20px" class="cls_038"><span class="cls_038">Figure 8-22: Ruby saves the object-related information about</span></div>
<div style="position:absolute;left:123.00px;top:354.70px" class="cls_038"><span class="cls_038">proc objects in the </span><span class="cls_014">RTypedData</span><span class="cls_038"> structure.</span></div>
<div style="position:absolute;left:141.00px;top:377.20px" class="cls_007"><span class="cls_007">Figure 8-23 takes another look at how Ruby represents a proc object.</span></div>
<div style="position:absolute;left:123.00px;top:389.20px" class="cls_007"><span class="cls_007">The proc object is on the right next to an </span><span class="cls_030">RString</span><span class="cls_007"> structure.</span></div>
<div style="position:absolute;left:141.00px;top:401.20px" class="cls_007"><span class="cls_007">Notice that Ruby handles the string value and the proc similarly. As</span></div>
<div style="position:absolute;left:123.00px;top:413.20px" class="cls_007"><span class="cls_007">with strings, procs can be saved into variables or passed as arguments to a</span></div>
<div style="position:absolute;left:123.00px;top:425.20px" class="cls_007"><span class="cls_007">function call. Ruby uses the </span><span class="cls_030">VALUE</span><span class="cls_007"> pointer to the proc whenever you refer to</span></div>
<div style="position:absolute;left:123.00px;top:437.20px" class="cls_007"><span class="cls_007">one or save one into a variable.</span></div>
<div style="position:absolute;left:161.42px;top:462.70px" class="cls_094"><span class="cls_094">VALUE</span></div>
<div style="position:absolute;left:269.22px;top:462.70px" class="cls_094"><span class="cls_094">VALUE</span></div>
<div style="position:absolute;left:131.53px;top:495.80px" class="cls_147"><span class="cls_147">RString</span></div>
<div style="position:absolute;left:239.32px;top:495.80px" class="cls_147"><span class="cls_147">RTypedData</span></div>
<div style="position:absolute;left:144.78px;top:519.37px" class="cls_147"><span class="cls_147">RBasic</span></div>
<div style="position:absolute;left:252.58px;top:519.37px" class="cls_147"><span class="cls_147">RBasic</span></div>
<div style="position:absolute;left:161.42px;top:533.05px" class="cls_094"><span class="cls_094">flags</span></div>
<div style="position:absolute;left:269.22px;top:533.05px" class="cls_094"><span class="cls_094">flags</span></div>
<div style="position:absolute;left:161.42px;top:554.69px" class="cls_094"><span class="cls_094">klass</span></div>
<div style="position:absolute;left:269.22px;top:554.69px" class="cls_094"><span class="cls_094">klass</span></div>
<div style="position:absolute;left:354.39px;top:561.94px" class="cls_147"><span class="cls_147">rb_proc_t</span></div>
<div style="position:absolute;left:150.20px;top:578.99px" class="cls_096"><span class="cls_096">String info...</span></div>
<div style="position:absolute;left:271.18px;top:578.99px" class="cls_094"><span class="cls_094">data</span></div>
<div style="position:absolute;left:123.00px;top:607.29px" class="cls_038"><span class="cls_038">Figure 8-23: Comparing a Ruby string with a proc</span></div>
<div style="position:absolute;left:290.70px;top:636.00px" class="cls_021"><span class="cls_021">How Ruby Borrowed a Decades-Old Idea from Lisp</span></div>
<div style="position:absolute;left:443.17px;top:633.00px" class="cls_020"><span class="cls_020">213</span></div>
</div>
<div style="position:absolute;left:50%;margin-left:-252px;top:158184px;width:504px;height:666px;border-style:outset;overflow:hidden">
<div style="position:absolute;left:0px;top:0px">
<img src="e698b76e-46bd-11eb-8b25-0cc47a792c0a_id_e698b76e-46bd-11eb-8b25-0cc47a792c0a_files/background238.jpg" width=504 height=666></div>
<div style="position:absolute;left:120.00px;top:42.63px" class="cls_031"><span class="cls_031">Experiment 8-2: Changing Local Variables After</span></div>
<div style="position:absolute;left:120.00px;top:57.63px" class="cls_031"><span class="cls_031">Calling lambda</span></div>
<div style="position:absolute;left:120.00px;top:77.63px" class="cls_007"><span class="cls_007">Listings 8-10 through 8-13 show how calling </span><span class="cls_030">lambda</span><span class="cls_007"> copies the current stack</span></div>
<div style="position:absolute;left:120.00px;top:89.63px" class="cls_007"><span class="cls_007">frame in the heap. Now for a slightly different example. Listing 8-14 is basi-</span></div>
<div style="position:absolute;left:120.00px;top:101.63px" class="cls_007"><span class="cls_007">cally the same, except that the line at </span><span class="cls_050">v</span><span class="cls_007"> changes </span><span class="cls_030">str</span><span class="cls_007"> after calling </span><span class="cls_030">lambda</span><span class="cls_007">.</span></div>
<div style="position:absolute;left:120.00px;top:125.63px" class="cls_030"><span class="cls_030">def message_function</span></div>
<div style="position:absolute;left:128.50px;top:136.12px" class="cls_030"><span class="cls_030">str = "The quick brown fox"</span></div>
<div style="position:absolute;left:108.15px;top:146.62px" class="cls_046"><span class="cls_046">u</span><span class="cls_030">   func = lambda do |animal|</span></div>
<div style="position:absolute;left:137.00px;top:157.12px" class="cls_030"><span class="cls_030">puts "#{str} jumps over the lazy #{animal}."</span></div>
<div style="position:absolute;left:128.50px;top:167.62px" class="cls_030"><span class="cls_030">end</span></div>
<div style="position:absolute;left:108.15px;top:178.11px" class="cls_046"><span class="cls_046">v</span><span class="cls_030">   str = "The sly brown fox"</span></div>
<div style="position:absolute;left:128.50px;top:188.61px" class="cls_030"><span class="cls_030">func</span></div>
<div style="position:absolute;left:120.00px;top:199.11px" class="cls_030"><span class="cls_030">end</span></div>
<div style="position:absolute;left:120.00px;top:209.61px" class="cls_030"><span class="cls_030">function_value = message_function</span></div>
<div style="position:absolute;left:108.15px;top:220.10px" class="cls_046"><span class="cls_046">w</span><span class="cls_030"> function_value.call('dog')</span></div>
<div style="position:absolute;left:120.00px;top:242.60px" class="cls_038"><span class="cls_038">Listing 8-14: Which version of </span><span class="cls_014">str</span><span class="cls_038"> will </span><span class="cls_014">lambda</span><span class="cls_038"> copy to the heap </span><span class="cls_039">(modify_after_lambda.rb)</span><span class="cls_038">?</span></div>
<div style="position:absolute;left:138.00px;top:259.13px" class="cls_007"><span class="cls_007">Because we call </span><span class="cls_030">lambda</span><span class="cls_007"> at </span><span class="cls_050">u</span><span class="cls_007"> before changing </span><span class="cls_030">str</span><span class="cls_007"> to </span><span class="cls_030">The sly brown fox</span></div>
<div style="position:absolute;left:120.00px;top:271.13px" class="cls_007"><span class="cls_007">at </span><span class="cls_050">v</span><span class="cls_007">, Ruby should have copied the stack frame to the heap, including the</span></div>
<div style="position:absolute;left:120.00px;top:283.13px" class="cls_007"><span class="cls_007">original value of </span><span class="cls_030">str</span><span class="cls_007">. That means that when we call the lambda at </span><span class="cls_050">w</span><span class="cls_007">, we</span></div>
<div style="position:absolute;left:120.00px;top:295.13px" class="cls_007"><span class="cls_007">should see the original “quick brown fox” string. However, running the</span></div>
<div style="position:absolute;left:120.00px;top:307.13px" class="cls_007"><span class="cls_007">code, we get the following:</span></div>
<div style="position:absolute;left:120.00px;top:331.13px" class="cls_030"><span class="cls_030">$ </span><span class="cls_040">ruby modify_after_lambda.rb</span></div>
<div style="position:absolute;left:120.00px;top:341.62px" class="cls_030"><span class="cls_030">The sly brown fox jumps over the lazy dog.</span></div>
<div style="position:absolute;left:138.00px;top:364.13px" class="cls_007"><span class="cls_007">What happened? Ruby somehow copied the new value of </span><span class="cls_030">str</span><span class="cls_007">, </span><span class="cls_030">The sly</span></div>
<div style="position:absolute;left:120.00px;top:376.13px" class="cls_030"><span class="cls_030">brown fox</span><span class="cls_007">, to the heap so we could access it when we called the lambda at </span><span class="cls_050">w</span><span class="cls_007">.</span></div>
<div style="position:absolute;left:138.00px;top:388.13px" class="cls_007"><span class="cls_007">To find out how Ruby did this, let’s look more closely at what happens</span></div>
<div style="position:absolute;left:120.00px;top:400.13px" class="cls_007"><span class="cls_007">when you call </span><span class="cls_030">lambda</span><span class="cls_007">. Figure 8-24 shows how Ruby copies the stack frame to</span></div>
<div style="position:absolute;left:120.00px;top:412.13px" class="cls_007"><span class="cls_007">the heap, including the value </span><span class="cls_030">str</span><span class="cls_007"> from Listing 8-14.</span></div>
<div style="position:absolute;left:338.95px;top:433.59px" class="cls_148"><span class="cls_148">Stack frame for</span></div>
<div style="position:absolute;left:167.01px;top:443.20px" class="cls_148"><span class="cls_148">YARV internal stack</span></div>
<div style="position:absolute;left:333.56px;top:442.71px" class="cls_149"><span class="cls_149">message_function</span></div>
<div style="position:absolute;left:325.48px;top:460.41px" class="cls_150"><span class="cls_150">rb_control_frame_t</span></div>
<div style="position:absolute;left:154.99px;top:473.75px" class="cls_149"><span class="cls_149">str = "The quick brown fox"</span></div>
<div style="position:absolute;left:360.16px;top:473.68px" class="cls_149"><span class="cls_149">EP</span></div>
<div style="position:absolute;left:337.95px;top:555.94px" class="cls_148"><span class="cls_148">Stack</span></div>
<div style="position:absolute;left:337.46px;top:575.89px" class="cls_148"><span class="cls_148">Heap</span></div>
<div style="position:absolute;left:214.68px;top:590.39px" class="cls_149"><span class="cls_149">str = "The quick brown fox"</span></div>
<div style="position:absolute;left:120.00px;top:612.33px" class="cls_038"><span class="cls_038">Figure 8-24: When you call </span><span class="cls_014">lambda</span><span class="cls_038">, Ruby copies the stack frame to the heap.</span></div>
<div style="position:absolute;left:48.00px;top:633.00px" class="cls_020"><span class="cls_020">214</span></div>
<div style="position:absolute;left:73.83px;top:636.00px" class="cls_021"><span class="cls_021">Chapter 8</span></div>
</div>
<div style="position:absolute;left:50%;margin-left:-252px;top:158860px;width:504px;height:666px;border-style:outset;overflow:hidden">
<div style="position:absolute;left:0px;top:0px">
<img src="e698b76e-46bd-11eb-8b25-0cc47a792c0a_id_e698b76e-46bd-11eb-8b25-0cc47a792c0a_files/background239.jpg" width=504 height=666></div>
<div style="position:absolute;left:141.00px;top:41.60px" class="cls_007"><span class="cls_007">Once this copy is made, the code at </span><span class="cls_050">v</span><span class="cls_007"> in Listing 8-14 changes </span><span class="cls_030">str</span><span class="cls_007"> to the</span></div>
<div style="position:absolute;left:123.00px;top:53.60px" class="cls_007"><span class="cls_007">“sly fox” string:</span></div>
<div style="position:absolute;left:123.00px;top:77.60px" class="cls_030"><span class="cls_030">str = "The sly brown fox"</span></div>
<div style="position:absolute;left:141.00px;top:100.10px" class="cls_007"><span class="cls_007">Because Ruby copied the stack frame when we called </span><span class="cls_030">lambda</span><span class="cls_007">, we should be</span></div>
<div style="position:absolute;left:123.00px;top:112.10px" class="cls_007"><span class="cls_007">modifying the original copy of </span><span class="cls_030">str</span><span class="cls_007">, not the new lambda copy (see Figure 8-25).</span></div>
<div style="position:absolute;left:341.95px;top:133.56px" class="cls_148"><span class="cls_148">Stack frame for</span></div>
<div style="position:absolute;left:170.01px;top:143.17px" class="cls_148"><span class="cls_148">YARV internal stack</span></div>
<div style="position:absolute;left:336.56px;top:142.68px" class="cls_151"><span class="cls_151">message_function</span></div>
<div style="position:absolute;left:328.48px;top:159.44px" class="cls_150"><span class="cls_150">rb_control_frame_t</span></div>
<div style="position:absolute;left:164.01px;top:172.78px" class="cls_151"><span class="cls_151">str = "The sly brown fox"</span></div>
<div style="position:absolute;left:363.16px;top:172.70px" class="cls_151"><span class="cls_151">EP</span></div>
<div style="position:absolute;left:340.95px;top:251.17px" class="cls_148"><span class="cls_148">Stack</span></div>
<div style="position:absolute;left:340.46px;top:271.12px" class="cls_148"><span class="cls_148">Heap</span></div>
<div style="position:absolute;left:217.68px;top:285.61px" class="cls_151"><span class="cls_151">str = "The quick brown fox"</span></div>
<div style="position:absolute;left:123.00px;top:307.56px" class="cls_038"><span class="cls_038">Figure 8-25: Does Ruby continue to use the original stack frame after making a heap copy?</span></div>
<div style="position:absolute;left:141.00px;top:330.06px" class="cls_007"><span class="cls_007">The new heap copy of the string should have remained unmodified,</span></div>
<div style="position:absolute;left:123.00px;top:342.06px" class="cls_007"><span class="cls_007">and calling the lambda later should have given the original “quick fox”</span></div>
<div style="position:absolute;left:123.00px;top:354.06px" class="cls_007"><span class="cls_007">string, not the modified “sly fox” one. How does Ruby allow us to modify</span></div>
<div style="position:absolute;left:123.00px;top:366.06px" class="cls_007"><span class="cls_007">the new persistent copy of the stack once it’s been created by </span><span class="cls_030">lambda</span><span class="cls_007">?</span></div>
<div style="position:absolute;left:141.00px;top:378.06px" class="cls_007"><span class="cls_007">As it turns out, once Ruby creates the new heap copy of the stack (the</span></div>
<div style="position:absolute;left:123.00px;top:390.06px" class="cls_007"><span class="cls_007">new </span><span class="cls_030">rb_env_t</span><span class="cls_007"> structure or internal environment object), it resets the </span><span class="cls_030">EP</span><span class="cls_007"> in</span></div>
<div style="position:absolute;left:123.00px;top:402.06px" class="cls_007"><span class="cls_007">the </span><span class="cls_030">rb_control_frame_t</span><span class="cls_007"> structure to point to the copy. Figure 8-26 shows how</span></div>
<div style="position:absolute;left:123.00px;top:414.06px" class="cls_007"><span class="cls_007">Ruby resets the </span><span class="cls_030">EP</span><span class="cls_007"> after creating a persistent heap copy of a stack frame.</span></div>
<div style="position:absolute;left:341.95px;top:435.52px" class="cls_148"><span class="cls_148">Stack frame for</span></div>
<div style="position:absolute;left:170.01px;top:445.13px" class="cls_148"><span class="cls_148">YARV internal stack</span></div>
<div style="position:absolute;left:336.56px;top:444.64px" class="cls_151"><span class="cls_151">message_function</span></div>
<div style="position:absolute;left:328.48px;top:461.40px" class="cls_150"><span class="cls_150">rb_control_frame_t</span></div>
<div style="position:absolute;left:157.99px;top:474.74px" class="cls_151"><span class="cls_151">str = "The quick brown fox"</span></div>
<div style="position:absolute;left:363.16px;top:474.66px" class="cls_151"><span class="cls_151">EP</span></div>
<div style="position:absolute;left:340.95px;top:553.13px" class="cls_148"><span class="cls_148">Stack</span></div>
<div style="position:absolute;left:340.46px;top:573.08px" class="cls_148"><span class="cls_148">Heap</span></div>
<div style="position:absolute;left:223.70px;top:587.57px" class="cls_151"><span class="cls_151">str = "The sly brown fox"</span></div>
<div style="position:absolute;left:123.00px;top:609.52px" class="cls_038"><span class="cls_038">Figure 8-26: Ruby resets the </span><span class="cls_014">EP</span><span class="cls_038"> after creating a persistent heap copy of a stack frame.</span></div>
<div style="position:absolute;left:290.76px;top:636.00px" class="cls_021"><span class="cls_021">How Ruby Borrowed a Decades-Old Idea from Lisp</span></div>
<div style="position:absolute;left:443.22px;top:633.00px" class="cls_020"><span class="cls_020">215</span></div>
</div>
<div style="position:absolute;left:50%;margin-left:-252px;top:159536px;width:504px;height:666px;border-style:outset;overflow:hidden">
<div style="position:absolute;left:0px;top:0px">
<img src="e698b76e-46bd-11eb-8b25-0cc47a792c0a_id_e698b76e-46bd-11eb-8b25-0cc47a792c0a_files/background240.jpg" width=504 height=666></div>
<div style="position:absolute;left:138.00px;top:42.28px" class="cls_007"><span class="cls_007">The difference here is that the </span><span class="cls_030">EP</span><span class="cls_007"> now points down to the heap.</span></div>
<div style="position:absolute;left:120.00px;top:54.28px" class="cls_007"><span class="cls_007">Now when we call </span><span class="cls_030">str = "The sly brown fox"</span><span class="cls_007"> at </span><span class="cls_050"></span><span class="cls_007"> in Listing 8-14, Ruby will</span></div>
<div style="position:absolute;left:120.01px;top:66.28px" class="cls_007"><span class="cls_007">use the new </span><span class="cls_030">EP</span><span class="cls_007"> and access the value in the heap, not the original value on</span></div>
<div style="position:absolute;left:120.00px;top:78.28px" class="cls_007"><span class="cls_007">the stack. Notice </span><span class="cls_030">The sly brown fox</span><span class="cls_007"> appears in the heap at the bottom of</span></div>
<div style="position:absolute;left:120.00px;top:90.28px" class="cls_007"><span class="cls_007">Figure 8-26.</span></div>
<div style="position:absolute;left:120.00px;top:115.28px" class="cls_055"><span class="cls_055">Calling lambda More Than Once in the Same Scope</span></div>
<div style="position:absolute;left:120.00px;top:133.28px" class="cls_007"><span class="cls_007">Another interesting behavior of the </span><span class="cls_030">lambda</span><span class="cls_007"> keyword is that Ruby avoids mak-</span></div>
<div style="position:absolute;left:120.00px;top:145.28px" class="cls_007"><span class="cls_007">ing copies of the stack frame more than once, as you can see in Listing 8-15.</span></div>
<div style="position:absolute;left:120.00px;top:169.28px" class="cls_030"><span class="cls_030">i = 0</span></div>
<div style="position:absolute;left:120.00px;top:179.78px" class="cls_030"><span class="cls_030">increment_function = lambda do</span></div>
<div style="position:absolute;left:128.50px;top:190.27px" class="cls_030"><span class="cls_030">puts "Incrementing from #{i} to #{i+1}"</span></div>
<div style="position:absolute;left:128.50px;top:200.77px" class="cls_030"><span class="cls_030">i += 1</span></div>
<div style="position:absolute;left:120.00px;top:211.27px" class="cls_030"><span class="cls_030">end</span></div>
<div style="position:absolute;left:120.00px;top:221.77px" class="cls_030"><span class="cls_030">decrement_function = lambda do</span></div>
<div style="position:absolute;left:128.50px;top:232.26px" class="cls_030"><span class="cls_030">i -= 1</span></div>
<div style="position:absolute;left:128.50px;top:242.76px" class="cls_030"><span class="cls_030">puts "Decrementing from #{i+1} to #{i}"</span></div>
<div style="position:absolute;left:120.00px;top:253.26px" class="cls_030"><span class="cls_030">end</span></div>
<div style="position:absolute;left:120.00px;top:275.76px" class="cls_038"><span class="cls_038">Listing 8-15: Calling </span><span class="cls_014">lambda</span><span class="cls_038"> twice in the same scope</span></div>
<div style="position:absolute;left:138.00px;top:298.28px" class="cls_007"><span class="cls_007">This code expects both lambda functions to operate on the local vari-</span></div>
<div style="position:absolute;left:120.00px;top:310.28px" class="cls_007"><span class="cls_007">able </span><span class="cls_030">i</span><span class="cls_007"> in the main scope.</span></div>
<div style="position:absolute;left:138.00px;top:322.28px" class="cls_007"><span class="cls_007">But if Ruby made a separate copy of the stack frame for each call to</span></div>
<div style="position:absolute;left:120.00px;top:334.28px" class="cls_030"><span class="cls_030">lambda</span><span class="cls_007">, each function would operate on a separate copy of </span><span class="cls_030">i</span><span class="cls_007">. Look at the</span></div>
<div style="position:absolute;left:120.00px;top:346.28px" class="cls_007"><span class="cls_007">following example in Listing 8-16.</span></div>
<div style="position:absolute;left:120.00px;top:370.28px" class="cls_030"><span class="cls_030">increment_function.call</span></div>
<div style="position:absolute;left:120.00px;top:380.78px" class="cls_030"><span class="cls_030">decrement_function.call</span></div>
<div style="position:absolute;left:120.00px;top:391.27px" class="cls_030"><span class="cls_030">increment_function.call</span></div>
<div style="position:absolute;left:120.00px;top:401.77px" class="cls_030"><span class="cls_030">increment_function.call</span></div>
<div style="position:absolute;left:120.00px;top:412.27px" class="cls_030"><span class="cls_030">decrement_function.call</span></div>
<div style="position:absolute;left:120.00px;top:434.77px" class="cls_038"><span class="cls_038">Listing 8-16: Calling the lambdas created in Listing 8-15</span></div>
<div style="position:absolute;left:138.00px;top:457.28px" class="cls_007"><span class="cls_007">If Ruby used a separate copy of </span><span class="cls_030">i</span><span class="cls_007"> for each lambda function, the previ-</span></div>
<div style="position:absolute;left:120.00px;top:469.28px" class="cls_007"><span class="cls_007">ous listing would generate the output shown in Listing 8-17.</span></div>
<div style="position:absolute;left:120.00px;top:493.28px" class="cls_030"><span class="cls_030">Incrementing from 0 to 1</span></div>
<div style="position:absolute;left:120.00px;top:503.78px" class="cls_030"><span class="cls_030">Decrementing from 0 to -1</span></div>
<div style="position:absolute;left:120.00px;top:514.28px" class="cls_030"><span class="cls_030">Incrementing from 1 to 2</span></div>
<div style="position:absolute;left:120.00px;top:524.77px" class="cls_030"><span class="cls_030">Incrementing from 2 to 3</span></div>
<div style="position:absolute;left:120.00px;top:535.27px" class="cls_030"><span class="cls_030">Decrementing from -1 to -2</span></div>
<div style="position:absolute;left:120.00px;top:557.77px" class="cls_038"><span class="cls_038">Listing 8-17: The output we would expect if each call to </span><span class="cls_014">lambda</span><span class="cls_038"> created its own copy of the</span></div>
<div style="position:absolute;left:120.00px;top:568.28px" class="cls_038"><span class="cls_038">stack frame</span></div>
<div style="position:absolute;left:48.00px;top:633.00px" class="cls_020"><span class="cls_020">216</span></div>
<div style="position:absolute;left:73.85px;top:636.00px" class="cls_021"><span class="cls_021">Chapter 8</span></div>
</div>
<div style="position:absolute;left:50%;margin-left:-252px;top:160212px;width:504px;height:666px;border-style:outset;overflow:hidden">
<div style="position:absolute;left:0px;top:0px">
<img src="e698b76e-46bd-11eb-8b25-0cc47a792c0a_id_e698b76e-46bd-11eb-8b25-0cc47a792c0a_files/background241.jpg" width=504 height=666></div>
<div style="position:absolute;left:141.00px;top:41.60px" class="cls_007"><span class="cls_007">But we actually see the output shown in Listing 8-18.</span></div>
<div style="position:absolute;left:123.00px;top:65.60px" class="cls_030"><span class="cls_030">Incrementing from 0 to 1</span></div>
<div style="position:absolute;left:123.00px;top:76.10px" class="cls_030"><span class="cls_030">Decrementing from 1 to 0</span></div>
<div style="position:absolute;left:123.00px;top:86.60px" class="cls_030"><span class="cls_030">Incrementing from 0 to 1</span></div>
<div style="position:absolute;left:123.00px;top:97.09px" class="cls_030"><span class="cls_030">Incrementing from 1 to 2</span></div>
<div style="position:absolute;left:123.00px;top:107.59px" class="cls_030"><span class="cls_030">Decrementing from 2 to 1</span></div>
<div style="position:absolute;left:123.00px;top:130.09px" class="cls_038"><span class="cls_038">Listing 8-18: Because the lambda functions share the same heap copy of the stack,</span></div>
<div style="position:absolute;left:123.00px;top:140.59px" class="cls_038"><span class="cls_038">running Listing 8-16 generates this output.</span></div>
<div style="position:absolute;left:141.00px;top:163.10px" class="cls_007"><span class="cls_007">Usually this is what you expect: Each block you pass to the lambdas</span></div>
<div style="position:absolute;left:123.00px;top:175.10px" class="cls_007"><span class="cls_007">accesses the same variable in the parent scope. Ruby achieves this by</span></div>
<div style="position:absolute;left:123.00px;top:187.10px" class="cls_007"><span class="cls_007">checking whether the </span><span class="cls_030">EP</span><span class="cls_007"> already points to the heap. If so, as with the sec-</span></div>
<div style="position:absolute;left:123.00px;top:199.10px" class="cls_007"><span class="cls_007">ond call to </span><span class="cls_030">lambda</span><span class="cls_007"> in Listing 8-15, Ruby won’t create a second copy; it will</span></div>
<div style="position:absolute;left:123.00px;top:211.10px" class="cls_007"><span class="cls_007">simply reuse the same </span><span class="cls_030">rb_env_t</span><span class="cls_007"> structure in the second </span><span class="cls_030">rb_proc_t</span><span class="cls_007"> structure.</span></div>
<div style="position:absolute;left:123.00px;top:223.10px" class="cls_007"><span class="cls_007">Ultimately, both lambdas use the same heap copy of the stack.</span></div>
<div style="position:absolute;left:69.00px;top:257.10px" class="cls_031"><span class="cls_031">Summary</span></div>
<div style="position:absolute;left:123.00px;top:277.10px" class="cls_007"><span class="cls_007">In Chapter 3 we saw how YARV creates a new stack frame whenever you call</span></div>
<div style="position:absolute;left:123.00px;top:289.10px" class="cls_007"><span class="cls_007">a block, just as it does when you call a method. At first glance, Ruby blocks</span></div>
<div style="position:absolute;left:123.00px;top:301.10px" class="cls_007"><span class="cls_007">appear to be a special kind of method that you can call and pass arguments</span></div>
<div style="position:absolute;left:123.00px;top:313.10px" class="cls_007"><span class="cls_007">to. However, as we’ve seen in this chapter, there’s more to blocks than meets</span></div>
<div style="position:absolute;left:123.00px;top:325.10px" class="cls_007"><span class="cls_007">the eye.</span></div>
<div style="position:absolute;left:141.00px;top:337.10px" class="cls_007"><span class="cls_007">Looking closely at the </span><span class="cls_030">rb_block_t</span><span class="cls_007"> structure, we saw how blocks implement</span></div>
<div style="position:absolute;left:123.00px;top:349.10px" class="cls_007"><span class="cls_007">the computer science concept of </span><span class="cls_008">closure</span><span class="cls_007"> in Ruby. Blocks are the combina-</span></div>
<div style="position:absolute;left:123.00px;top:361.10px" class="cls_007"><span class="cls_007">tion of a function and an environment to use when calling that function.</span></div>
<div style="position:absolute;left:123.00px;top:373.10px" class="cls_007"><span class="cls_007">We learned that blocks have a curious dual personality in Ruby: They are</span></div>
<div style="position:absolute;left:123.00px;top:385.10px" class="cls_007"><span class="cls_007">similar to methods, but they also become part of the method that you call</span></div>
<div style="position:absolute;left:123.00px;top:397.10px" class="cls_007"><span class="cls_007">them from. The simplicity with which Ruby’s syntax allows for this dual role</span></div>
<div style="position:absolute;left:123.00px;top:409.10px" class="cls_007"><span class="cls_007">is one of the language’s most beautiful and elegant features.</span></div>
<div style="position:absolute;left:141.00px;top:421.10px" class="cls_007"><span class="cls_007">Later we saw how Ruby allows you to treat functions or code as first-</span></div>
<div style="position:absolute;left:123.00px;top:433.10px" class="cls_007"><span class="cls_007">class citizens using the </span><span class="cls_030">lambda</span><span class="cls_007"> keyword, which converts a block into a data</span></div>
<div style="position:absolute;left:123.00px;top:445.10px" class="cls_007"><span class="cls_007">value that you can pass, save, and reuse. After reviewing the differences</span></div>
<div style="position:absolute;left:123.00px;top:457.10px" class="cls_007"><span class="cls_007">between stack and heap memory, we explored the way that Ruby imple-</span></div>
<div style="position:absolute;left:123.00px;top:469.10px" class="cls_007"><span class="cls_007">ments lambdas and procs, and we saw that Ruby copies the stack frame</span></div>
<div style="position:absolute;left:123.00px;top:481.10px" class="cls_007"><span class="cls_007">to the heap when you call </span><span class="cls_030">lambda</span><span class="cls_007"> or </span><span class="cls_030">proc</span><span class="cls_007"> and reuses it when you call the</span></div>
<div style="position:absolute;left:123.00px;top:493.10px" class="cls_007"><span class="cls_007">lambda’s block. Finally, we saw how the proc object represents code as a</span></div>
<div style="position:absolute;left:123.00px;top:505.10px" class="cls_007"><span class="cls_007">data object in Ruby.</span></div>
<div style="position:absolute;left:290.74px;top:636.00px" class="cls_021"><span class="cls_021">How Ruby Borrowed a Decades-Old Idea from Lisp</span></div>
<div style="position:absolute;left:443.20px;top:633.00px" class="cls_020"><span class="cls_020">217</span></div>
</div>
<div style="position:absolute;left:50%;margin-left:-252px;top:160888px;width:504px;height:666px;border-style:outset;overflow:hidden">
<div style="position:absolute;left:0px;top:0px">
<img src="e698b76e-46bd-11eb-8b25-0cc47a792c0a_id_e698b76e-46bd-11eb-8b25-0cc47a792c0a_files/background242.jpg" width=504 height=666></div>
<div style="position:absolute;left:229.05px;top:287.71px" class="cls_024"><span class="cls_024">Metaprogramming becomes</span></div>
<div style="position:absolute;left:230.28px;top:305.72px" class="cls_024"><span class="cls_024">much easier to understand</span></div>
<div style="position:absolute;left:234.16px;top:323.72px" class="cls_024"><span class="cls_024">once you learn how Ruby</span></div>
<div style="position:absolute;left:235.84px;top:341.73px" class="cls_024"><span class="cls_024">implements it internally.</span></div>
</div>
<div style="position:absolute;left:50%;margin-left:-252px;top:161564px;width:504px;height:666px;border-style:outset;overflow:hidden">
<div style="position:absolute;left:0px;top:0px">
<img src="e698b76e-46bd-11eb-8b25-0cc47a792c0a_id_e698b76e-46bd-11eb-8b25-0cc47a792c0a_files/background243.jpg" width=504 height=666></div>
<div style="position:absolute;left:260.10px;top:101.45px" class="cls_035"><span class="cls_035">9</span></div>
<div style="position:absolute;left:188.55px;top:253.45px" class="cls_016"><span class="cls_016">Metaprogramming</span></div>
<div style="position:absolute;left:123.00px;top:369.45px" class="cls_023"><span class="cls_023">One of the most confusing and daunting subjects Ruby</span></div>
<div style="position:absolute;left:123.00px;top:387.46px" class="cls_023"><span class="cls_023">developers face is </span><span class="cls_024">metaprogramming</span><span class="cls_023">. Metaprogramming,</span></div>
<div style="position:absolute;left:123.00px;top:405.46px" class="cls_023"><span class="cls_023">as indicated by the prefix </span><span class="cls_024">meta</span><span class="cls_023">, literally means to pro-</span></div>
<div style="position:absolute;left:123.00px;top:423.46px" class="cls_023"><span class="cls_023">gram at a different or higher level of abstraction. Ruby</span></div>
<div style="position:absolute;left:123.00px;top:441.47px" class="cls_023"><span class="cls_023">provides many different ways for you to do this, allow-</span></div>
<div style="position:absolute;left:123.00px;top:459.47px" class="cls_023"><span class="cls_023">ing your program to inspect and change itself dynam-</span></div>
<div style="position:absolute;left:123.00px;top:477.48px" class="cls_023"><span class="cls_023">ically. In Ruby, your program can change itself!</span></div>
<div style="position:absolute;left:141.00px;top:496.45px" class="cls_007"><span class="cls_007">Some of Ruby’s metaprogramming features allow your program to</span></div>
<div style="position:absolute;left:123.00px;top:508.45px" class="cls_007"><span class="cls_007">query for information about itself—for example, information about meth-</span></div>
<div style="position:absolute;left:123.00px;top:520.45px" class="cls_007"><span class="cls_007">ods, instance variables, and superclasses. Other metaprogramming features</span></div>
<div style="position:absolute;left:123.00px;top:532.45px" class="cls_007"><span class="cls_007">allow you to perform normal tasks, such as defining a method or a constant,</span></div>
<div style="position:absolute;left:123.00px;top:544.45px" class="cls_007"><span class="cls_007">in an alternative and more flexible manner. Finally, methods such as </span><span class="cls_030">eval</span></div>
<div style="position:absolute;left:123.00px;top:556.45px" class="cls_007"><span class="cls_007">allow your program to write new Ruby code from scratch, calling the parser</span></div>
<div style="position:absolute;left:123.00px;top:568.45px" class="cls_007"><span class="cls_007">and compiler at run time.</span></div>
</div>
<div style="position:absolute;left:50%;margin-left:-252px;top:162240px;width:504px;height:666px;border-style:outset;overflow:hidden">
<div style="position:absolute;left:0px;top:0px">
<img src="e698b76e-46bd-11eb-8b25-0cc47a792c0a_id_e698b76e-46bd-11eb-8b25-0cc47a792c0a_files/background244.jpg" width=504 height=666></div>
<div style="position:absolute;left:138.00px;top:41.60px" class="cls_007"><span class="cls_007">In this chapter, we’ll focus on two important aspects of metaprogram-</span></div>
<div style="position:absolute;left:120.00px;top:53.60px" class="cls_007"><span class="cls_007">ming. First, we’ll look at how you can alter the standard method definition</span></div>
<div style="position:absolute;left:120.00px;top:65.60px" class="cls_007"><span class="cls_007">process, the most common and practical use for metaprogramming. We’ll</span></div>
<div style="position:absolute;left:120.00px;top:77.60px" class="cls_007"><span class="cls_007">learn what Ruby normally does to assign a method to a class and how this</span></div>
<div style="position:absolute;left:120.00px;top:89.60px" class="cls_007"><span class="cls_007">is related to lexical scope. Then, we’ll look at alternative ways to define</span></div>
<div style="position:absolute;left:120.00px;top:101.60px" class="cls_007"><span class="cls_007">methods using metaclasses and singleton classes. We’ll also learn how Ruby</span></div>
<div style="position:absolute;left:120.00px;top:113.60px" class="cls_007"><span class="cls_007">implements the new, experimental refinements feature, allowing you to</span></div>
<div style="position:absolute;left:120.00px;top:125.60px" class="cls_007"><span class="cls_007">define methods and activate them later if you wish.</span></div>
<div style="position:absolute;left:261.47px;top:165.11px" class="cls_020"><span class="cls_020">Roadma p</span></div>
<div style="position:absolute;left:132.00px;top:182.11px" class="cls_017"><span class="cls_017">Alternative Ways to Define Methods</span></div>
<div style="position:absolute;left:415.36px;top:182.11px" class="cls_017"><span class="cls_017">221</span></div>
<div style="position:absolute;left:150.00px;top:199.12px" class="cls_017"><span class="cls_017">Ruby’s Normal Method Definition Process</span></div>
<div style="position:absolute;left:415.36px;top:199.12px" class="cls_017"><span class="cls_017">221</span></div>
<div style="position:absolute;left:150.00px;top:216.12px" class="cls_017"><span class="cls_017">Defining Class Methods Using an Object Prefix</span></div>
<div style="position:absolute;left:415.36px;top:216.12px" class="cls_017"><span class="cls_017">223</span></div>
<div style="position:absolute;left:150.00px;top:233.12px" class="cls_017"><span class="cls_017">Defining Class Methods Using a New Lexical Scope</span></div>
<div style="position:absolute;left:415.36px;top:233.12px" class="cls_017"><span class="cls_017">224</span></div>
<div style="position:absolute;left:150.00px;top:250.12px" class="cls_017"><span class="cls_017">Defining Methods Using Singleton Classes</span></div>
<div style="position:absolute;left:415.36px;top:250.12px" class="cls_017"><span class="cls_017">226</span></div>
<div style="position:absolute;left:150.00px;top:267.12px" class="cls_017"><span class="cls_017">Defining Methods Using Singleton Classes in a Lexical Scope</span></div>
<div style="position:absolute;left:415.36px;top:267.12px" class="cls_017"><span class="cls_017">227</span></div>
<div style="position:absolute;left:150.00px;top:284.12px" class="cls_017"><span class="cls_017">Creating Refinements</span></div>
<div style="position:absolute;left:415.36px;top:284.12px" class="cls_017"><span class="cls_017">228</span></div>
<div style="position:absolute;left:150.00px;top:301.12px" class="cls_017"><span class="cls_017">Using Refinements</span></div>
<div style="position:absolute;left:415.36px;top:301.12px" class="cls_017"><span class="cls_017">229</span></div>
<div style="position:absolute;left:132.00px;top:318.11px" class="cls_019"><span class="cls_019">Experiment 9-1: Who Am I? How </span><span class="cls_040">self</span><span class="cls_019"> Changes with Lexical Scope</span></div>
<div style="position:absolute;left:416.40px;top:318.11px" class="cls_019"><span class="cls_019">231</span></div>
<div style="position:absolute;left:150.00px;top:335.11px" class="cls_030"><span class="cls_030">self</span><span class="cls_017"> in the Top Scope</span></div>
<div style="position:absolute;left:415.36px;top:335.11px" class="cls_017"><span class="cls_017">231</span></div>
<div style="position:absolute;left:150.00px;top:352.11px" class="cls_030"><span class="cls_030">self</span><span class="cls_017"> in a Class Scope</span></div>
<div style="position:absolute;left:415.36px;top:352.11px" class="cls_017"><span class="cls_017">232</span></div>
<div style="position:absolute;left:150.00px;top:369.11px" class="cls_030"><span class="cls_030">self</span><span class="cls_017"> in a Metaclass Scope</span></div>
<div style="position:absolute;left:415.36px;top:369.11px" class="cls_017"><span class="cls_017">233</span></div>
<div style="position:absolute;left:150.00px;top:386.11px" class="cls_030"><span class="cls_030">self</span><span class="cls_017"> Inside a Class Method</span></div>
<div style="position:absolute;left:415.36px;top:386.11px" class="cls_017"><span class="cls_017">234</span></div>
<div style="position:absolute;left:132.00px;top:403.11px" class="cls_017"><span class="cls_017">Metaprogramming and Closures: </span><span class="cls_030">eval</span><span class="cls_017">, </span><span class="cls_030">instance_eval</span><span class="cls_017">, and </span><span class="cls_030">binding</span></div>
<div style="position:absolute;left:415.36px;top:403.11px" class="cls_017"><span class="cls_017">236</span></div>
<div style="position:absolute;left:150.00px;top:420.11px" class="cls_017"><span class="cls_017">Code That Writes Code</span></div>
<div style="position:absolute;left:415.36px;top:420.11px" class="cls_017"><span class="cls_017">236</span></div>
<div style="position:absolute;left:150.00px;top:437.11px" class="cls_017"><span class="cls_017">Calling </span><span class="cls_030">eval</span><span class="cls_017"> with </span><span class="cls_030">binding</span></div>
<div style="position:absolute;left:415.36px;top:437.11px" class="cls_017"><span class="cls_017">238</span></div>
<div style="position:absolute;left:150.00px;top:454.11px" class="cls_017"><span class="cls_017">An </span><span class="cls_030">instance_eval</span><span class="cls_017"> Example</span></div>
<div style="position:absolute;left:415.36px;top:454.11px" class="cls_017"><span class="cls_017">240</span></div>
<div style="position:absolute;left:150.00px;top:471.11px" class="cls_017"><span class="cls_017">Another Important Part of Ruby Closures</span></div>
<div style="position:absolute;left:415.36px;top:471.11px" class="cls_017"><span class="cls_017">241</span></div>
<div style="position:absolute;left:150.00px;top:488.11px" class="cls_030"><span class="cls_030">instance_eval</span><span class="cls_017"> Changes </span><span class="cls_030">self</span><span class="cls_017"> to the Receiver</span></div>
<div style="position:absolute;left:415.36px;top:488.11px" class="cls_017"><span class="cls_017">242</span></div>
<div style="position:absolute;left:150.00px;top:505.11px" class="cls_030"><span class="cls_030">instance_eval</span><span class="cls_017"> Creates a Singleton Class for a New Lexical Scope</span></div>
<div style="position:absolute;left:415.36px;top:505.11px" class="cls_017"><span class="cls_017">243</span></div>
<div style="position:absolute;left:150.00px;top:522.11px" class="cls_017"><span class="cls_017">How Ruby Keeps Track of Lexical Scope for Blocks</span></div>
<div style="position:absolute;left:415.36px;top:522.11px" class="cls_017"><span class="cls_017">244</span></div>
<div style="position:absolute;left:132.00px;top:539.12px" class="cls_019"><span class="cls_019">Experiment 9-2: Using a Closure to Define a Method</span></div>
<div style="position:absolute;left:416.39px;top:539.12px" class="cls_019"><span class="cls_019">246</span></div>
<div style="position:absolute;left:150.00px;top:556.11px" class="cls_017"><span class="cls_017">Using </span><span class="cls_030">define_method</span></div>
<div style="position:absolute;left:415.36px;top:556.11px" class="cls_017"><span class="cls_017">246</span></div>
<div style="position:absolute;left:150.00px;top:573.11px" class="cls_017"><span class="cls_017">Methods Acting as Closures</span></div>
<div style="position:absolute;left:415.36px;top:573.11px" class="cls_017"><span class="cls_017">247</span></div>
<div style="position:absolute;left:132.00px;top:590.12px" class="cls_017"><span class="cls_017">Summary</span></div>
<div style="position:absolute;left:415.36px;top:590.12px" class="cls_017"><span class="cls_017">248</span></div>
<div style="position:absolute;left:48.00px;top:633.00px" class="cls_020"><span class="cls_020">220</span></div>
<div style="position:absolute;left:74.55px;top:636.00px" class="cls_021"><span class="cls_021">Chapter 9</span></div>
</div>
<div style="position:absolute;left:50%;margin-left:-252px;top:162916px;width:504px;height:666px;border-style:outset;overflow:hidden">
<div style="position:absolute;left:0px;top:0px">
<img src="e698b76e-46bd-11eb-8b25-0cc47a792c0a_id_e698b76e-46bd-11eb-8b25-0cc47a792c0a_files/background245.jpg" width=504 height=666></div>
<div style="position:absolute;left:141.00px;top:42.28px" class="cls_007"><span class="cls_007">In the second half of this chapter, we’ll see how you can write code that</span></div>
<div style="position:absolute;left:123.00px;top:54.28px" class="cls_007"><span class="cls_007">writes code with the </span><span class="cls_030">eval</span><span class="cls_007"> method: metaprogramming in its purest form.</span></div>
<div style="position:absolute;left:123.00px;top:66.28px" class="cls_007"><span class="cls_007">We’ll also see how metaprogramming and closures are related. Like blocks,</span></div>
<div style="position:absolute;left:123.00px;top:78.28px" class="cls_007"><span class="cls_007">lambdas, and procs, </span><span class="cls_030">eval</span><span class="cls_007"> and its related metaprogramming methods create</span></div>
<div style="position:absolute;left:123.00px;top:90.28px" class="cls_007"><span class="cls_007">a closure when you call them. In fact, we’ll learn how you can use the same</span></div>
<div style="position:absolute;left:123.00px;top:102.28px" class="cls_007"><span class="cls_007">mental model we developed in Chapter 8 for blocks to understand many of</span></div>
<div style="position:absolute;left:123.00px;top:114.28px" class="cls_007"><span class="cls_007">Ruby’s metaprogramming features.</span></div>
<div style="position:absolute;left:69.00px;top:148.28px" class="cls_031"><span class="cls_031">Alternative Ways to Define Methods</span></div>
<div style="position:absolute;left:123.00px;top:168.28px" class="cls_007"><span class="cls_007">Normally we define methods in Ruby using the </span><span class="cls_030">def</span><span class="cls_007"> keyword. After </span><span class="cls_030">def</span><span class="cls_007">, we</span></div>
<div style="position:absolute;left:123.00px;top:180.28px" class="cls_007"><span class="cls_007">specify a name for the new method followed by the method body. By using</span></div>
<div style="position:absolute;left:123.00px;top:192.28px" class="cls_007"><span class="cls_007">some of Ruby’s metaprogramming features, however, we can define methods</span></div>
<div style="position:absolute;left:123.00px;top:204.28px" class="cls_007"><span class="cls_007">in alternative ways. We can create class methods instead of normal meth-</span></div>
<div style="position:absolute;left:123.00px;top:216.28px" class="cls_007"><span class="cls_007">ods; we can create methods for a single object instance; and, as we’ll see in</span></div>
<div style="position:absolute;left:123.00px;top:228.28px" class="cls_007"><span class="cls_007">Experiment 9-2, we can create methods that can access the surrounding</span></div>
<div style="position:absolute;left:123.00px;top:240.28px" class="cls_007"><span class="cls_007">environment using a closure.</span></div>
<div style="position:absolute;left:141.00px;top:252.28px" class="cls_007"><span class="cls_007">Next, we’ll look at what happens inside Ruby when you define a method</span></div>
<div style="position:absolute;left:123.00px;top:264.28px" class="cls_007"><span class="cls_007">in each of these ways using metaprogramming. In each case, studying what</span></div>
<div style="position:absolute;left:123.00px;top:276.28px" class="cls_007"><span class="cls_007">Ruby does internally will make Ruby’s metaprogramming syntax easier to</span></div>
<div style="position:absolute;left:123.00px;top:288.28px" class="cls_007"><span class="cls_007">understand. But before we tackle metaprogramming, let’s learn more about</span></div>
<div style="position:absolute;left:123.00px;top:300.28px" class="cls_007"><span class="cls_007">how Ruby normally defines a method. This knowledge will serve as a foun-</span></div>
<div style="position:absolute;left:123.00px;top:312.28px" class="cls_007"><span class="cls_007">dation when we learn alternative ways to define a method.</span></div>
<div style="position:absolute;left:123.00px;top:337.28px" class="cls_055"><span class="cls_055">Ruby’s Normal Method Definition Process</span></div>
<div style="position:absolute;left:123.00px;top:355.28px" class="cls_007"><span class="cls_007">Listing 9-1 shows a very simple Ruby class containing a single method.</span></div>
<div style="position:absolute;left:123.00px;top:379.28px" class="cls_030"><span class="cls_030">class Quote</span></div>
<div style="position:absolute;left:131.50px;top:389.78px" class="cls_030"><span class="cls_030">def display</span></div>
<div style="position:absolute;left:140.00px;top:400.27px" class="cls_030"><span class="cls_030">puts "The quick brown fox jumped over the lazy dog."</span></div>
<div style="position:absolute;left:131.50px;top:410.77px" class="cls_030"><span class="cls_030">end</span></div>
<div style="position:absolute;left:123.00px;top:421.27px" class="cls_030"><span class="cls_030">end</span></div>
<div style="position:absolute;left:123.00px;top:443.77px" class="cls_038"><span class="cls_038">Listing 9-1: Adding a method to a class using the </span><span class="cls_014">def</span><span class="cls_038"> keyword</span></div>
<div style="position:absolute;left:141.00px;top:466.28px" class="cls_007"><span class="cls_007">How does Ruby execute this small program? And how does it know to</span></div>
<div style="position:absolute;left:123.00px;top:478.28px" class="cls_007"><span class="cls_007">assign the </span><span class="cls_030">display</span><span class="cls_007"> method to the </span><span class="cls_030">Quote</span><span class="cls_007"> class?</span></div>
<div style="position:absolute;left:141.00px;top:490.28px" class="cls_007"><span class="cls_007">When Ruby executes the </span><span class="cls_030">class</span><span class="cls_007"> keyword, it creates a new lexical scope</span></div>
<div style="position:absolute;left:123.00px;top:502.28px" class="cls_007"><span class="cls_007">for the new </span><span class="cls_030">Quote</span><span class="cls_007"> class (see Figure 9-1). Ruby sets the </span><span class="cls_030">nd_clss</span><span class="cls_007"> pointer in the</span></div>
<div style="position:absolute;left:123.00px;top:514.28px" class="cls_007"><span class="cls_007">lexical scope to point to an </span><span class="cls_030">RClass</span><span class="cls_007"> structure for the new </span><span class="cls_030">Quote</span><span class="cls_007"> class. Because</span></div>
<div style="position:absolute;left:123.00px;top:526.28px" class="cls_007"><span class="cls_007">it’s a new class, the </span><span class="cls_030">RClass</span><span class="cls_007"> structure initially has an empty method table, as</span></div>
<div style="position:absolute;left:123.00px;top:538.28px" class="cls_007"><span class="cls_007">shown on the right side of the figure.</span></div>
<div style="position:absolute;left:141.00px;top:550.28px" class="cls_007"><span class="cls_007">Next, Ruby executes the </span><span class="cls_030">def</span><span class="cls_007"> keyword, which is used to define the </span><span class="cls_030">display</span></div>
<div style="position:absolute;left:123.00px;top:562.28px" class="cls_007"><span class="cls_007">method. But how does Ruby create normal methods? What happens inter-</span></div>
<div style="position:absolute;left:123.00px;top:574.28px" class="cls_007"><span class="cls_007">nally when you call </span><span class="cls_030">def</span><span class="cls_007">?</span></div>
<div style="position:absolute;left:380.66px;top:636.00px" class="cls_021"><span class="cls_021">Metaprogramming</span></div>
<div style="position:absolute;left:442.71px;top:633.00px" class="cls_020"><span class="cls_020">221</span></div>
</div>
<div style="position:absolute;left:50%;margin-left:-252px;top:163592px;width:504px;height:666px;border-style:outset;overflow:hidden">
<div style="position:absolute;left:0px;top:0px">
<img src="e698b76e-46bd-11eb-8b25-0cc47a792c0a_id_e698b76e-46bd-11eb-8b25-0cc47a792c0a_files/background246.jpg" width=504 height=666></div>
<div style="position:absolute;left:285.00px;top:43.89px" class="cls_017"><span class="cls_017">Lexical</span></div>
<div style="position:absolute;left:284.70px;top:54.23px" class="cls_017"><span class="cls_017">Scope:</span></div>
<div style="position:absolute;left:120.00px;top:65.36px" class="cls_063"><span class="cls_063">class Quote</span></div>
<div style="position:absolute;left:292.03px;top:72.77px" class="cls_054"><span class="cls_054">etc.</span></div>
<div style="position:absolute;left:355.13px;top:96.59px" class="cls_042"><span class="cls_042">RClass: Quote</span></div>
<div style="position:absolute;left:130.00px;top:102.20px" class="cls_063"><span class="cls_063">def display</span></div>
<div style="position:absolute;left:284.20px;top:105.05px" class="cls_014"><span class="cls_014">nd_next</span></div>
<div style="position:absolute;left:378.15px;top:112.63px" class="cls_054"><span class="cls_054">method table:</span></div>
<div style="position:absolute;left:139.50px;top:114.47px" class="cls_063"><span class="cls_063">puts</span></div>
<div style="position:absolute;left:177.50px;top:114.47px" class="cls_063"><span class="cls_063">"The quick..."</span></div>
<div style="position:absolute;left:284.20px;top:124.33px" class="cls_014"><span class="cls_014">nd_clss</span></div>
<div style="position:absolute;left:130.00px;top:126.74px" class="cls_063"><span class="cls_063">end</span></div>
<div style="position:absolute;left:120.00px;top:151.30px" class="cls_063"><span class="cls_063">end</span></div>
<div style="position:absolute;left:120.00px;top:174.61px" class="cls_038"><span class="cls_038">Figure 9-1: Ruby creates a new lexical scope when you define a class.</span></div>
<div style="position:absolute;left:138.00px;top:197.11px" class="cls_007"><span class="cls_007">By default, when you use </span><span class="cls_030">def</span><span class="cls_007">, you provide just the name of the new</span></div>
<div style="position:absolute;left:120.00px;top:209.11px" class="cls_007"><span class="cls_007">method. (We’ll see in the next section that you can also specify an object</span></div>
<div style="position:absolute;left:120.00px;top:221.11px" class="cls_007"><span class="cls_007">prefix along with the new method name.) Providing just the name of the</span></div>
<div style="position:absolute;left:120.00px;top:233.11px" class="cls_007"><span class="cls_007">new method with </span><span class="cls_030">def</span><span class="cls_007"> instructs Ruby to use the current lexical scope to find</span></div>
<div style="position:absolute;left:120.00px;top:245.11px" class="cls_007"><span class="cls_007">the target class, as shown in Figure 9-2.</span></div>
<div style="position:absolute;left:231.42px;top:271.35px" class="cls_042"><span class="cls_042">RClass: Quote</span></div>
<div style="position:absolute;left:154.76px;top:279.64px" class="cls_014"><span class="cls_014">nd_next</span></div>
<div style="position:absolute;left:254.44px;top:287.40px" class="cls_054"><span class="cls_054">method table:</span></div>
<div style="position:absolute;left:155.43px;top:299.63px" class="cls_014"><span class="cls_014">nd_clss</span></div>
<div style="position:absolute;left:120.00px;top:338.42px" class="cls_054"><span class="cls_054">(no object</span></div>
<div style="position:absolute;left:120.70px;top:347.80px" class="cls_054"><span class="cls_054">specified)</span></div>
<div style="position:absolute;left:143.52px;top:367.43px" class="cls_063"><span class="cls_063">def display</span></div>
<div style="position:absolute;left:153.02px;top:380.17px" class="cls_063"><span class="cls_063">--</span><span class="cls_064">snip</span><span class="cls_063">--</span></div>
<div style="position:absolute;left:143.52px;top:392.90px" class="cls_063"><span class="cls_063">end</span></div>
<div style="position:absolute;left:120.00px;top:412.84px" class="cls_038"><span class="cls_038">Figure 9-2: By default, Ruby uses the current lexical scope</span></div>
<div style="position:absolute;left:120.00px;top:423.34px" class="cls_038"><span class="cls_038">to find the target class for a new method.</span></div>
<div style="position:absolute;left:138.00px;top:445.84px" class="cls_007"><span class="cls_007">When Ruby initially compiles Listing 9-1, it creates a separate snippet of</span></div>
<div style="position:absolute;left:120.00px;top:457.84px" class="cls_007"><span class="cls_007">YARV code for the </span><span class="cls_030">display</span><span class="cls_007"> method. Later, when executing the </span><span class="cls_030">def</span><span class="cls_007"> keyword,</span></div>
<div style="position:absolute;left:120.00px;top:469.84px" class="cls_007"><span class="cls_007">Ruby assigns this code to the target class, </span><span class="cls_030">Quote</span><span class="cls_007">, saving the given method</span></div>
<div style="position:absolute;left:120.00px;top:481.84px" class="cls_007"><span class="cls_007">name in the method table (see Figure 9-3).</span></div>
<div style="position:absolute;left:348.92px;top:508.60px" class="cls_154"><span class="cls_154">RClass: Quote</span></div>
<div style="position:absolute;left:374.33px;top:525.41px" class="cls_155"><span class="cls_155">method table:</span></div>
<div style="position:absolute;left:260.36px;top:530.13px" class="cls_156"><span class="cls_156">def display</span></div>
<div style="position:absolute;left:128.46px;top:541.75px" class="cls_156"><span class="cls_156">puts "The quick..."</span></div>
<div style="position:absolute;left:384.08px;top:541.89px" class="cls_158"><span class="cls_158">display</span></div>
<div style="position:absolute;left:120.00px;top:589.47px" class="cls_038"><span class="cls_038">Figure 9-3: Ruby adds new methods to the method table for the target class.</span></div>
<div style="position:absolute;left:48.00px;top:633.00px" class="cls_020"><span class="cls_020">222</span></div>
<div style="position:absolute;left:74.53px;top:636.00px" class="cls_021"><span class="cls_021">Chapter 9</span></div>
</div>
<div style="position:absolute;left:50%;margin-left:-252px;top:164268px;width:504px;height:666px;border-style:outset;overflow:hidden">
<div style="position:absolute;left:0px;top:0px">
<img src="e698b76e-46bd-11eb-8b25-0cc47a792c0a_id_e698b76e-46bd-11eb-8b25-0cc47a792c0a_files/background247.jpg" width=504 height=666></div>
<div style="position:absolute;left:141.00px;top:41.60px" class="cls_007"><span class="cls_007">When we execute this method, Ruby looks up the method as described</span></div>
<div style="position:absolute;left:123.00px;top:53.60px" class="cls_007"><span class="cls_007">in “Ruby’s Method Lookup Algorithm” on page 138. Because </span><span class="cls_030">display</span><span class="cls_007"> now</span></div>
<div style="position:absolute;left:123.00px;top:65.60px" class="cls_007"><span class="cls_007">appears in the method table for </span><span class="cls_030">Quote</span><span class="cls_007">, Ruby can find the method and</span></div>
<div style="position:absolute;left:123.00px;top:77.60px" class="cls_007"><span class="cls_007">execute it.</span></div>
<div style="position:absolute;left:141.00px;top:89.60px" class="cls_007"><span class="cls_007">In sum, to define new methods in your program using the </span><span class="cls_030">def</span><span class="cls_007"> keyword,</span></div>
<div style="position:absolute;left:123.00px;top:101.60px" class="cls_007"><span class="cls_007">Ruby follows this three-step process:</span></div>
<div style="position:absolute;left:123.00px;top:122.60px" class="cls_007"><span class="cls_007">1.   It compiles each method’s body into a distinct snippet of YARV instruc-</span></div>
<div style="position:absolute;left:141.00px;top:134.60px" class="cls_007"><span class="cls_007">tions. (This occurs when Ruby parses and compiles your program.)</span></div>
<div style="position:absolute;left:123.00px;top:149.60px" class="cls_007"><span class="cls_007">2.  It uses the current lexical scope to obtain a pointer to a class or module.</span></div>
<div style="position:absolute;left:141.00px;top:161.60px" class="cls_007"><span class="cls_007">(This occurs when Ruby encounters a </span><span class="cls_030">def</span><span class="cls_007"> keyword while executing your</span></div>
<div style="position:absolute;left:141.00px;top:173.60px" class="cls_007"><span class="cls_007">program.)</span></div>
<div style="position:absolute;left:123.00px;top:188.60px" class="cls_007"><span class="cls_007">3.  It saves the new method’s name—actually, an integer ID value that</span></div>
<div style="position:absolute;left:141.00px;top:200.60px" class="cls_007"><span class="cls_007">maps to the name—in the method table for that class.</span></div>
<div style="position:absolute;left:123.00px;top:234.60px" class="cls_055"><span class="cls_055">Defining Class Methods Using an Object Prefix</span></div>
<div style="position:absolute;left:123.00px;top:252.60px" class="cls_007"><span class="cls_007">Now that we understand how Ruby’s method definition process normally</span></div>
<div style="position:absolute;left:123.00px;top:264.60px" class="cls_007"><span class="cls_007">works, let’s learn alternative ways to define methods using metaprogram-</span></div>
<div style="position:absolute;left:123.00px;top:276.60px" class="cls_007"><span class="cls_007">ming. As we saw in Figure 9-2, Ruby normally assigns new methods to the</span></div>
<div style="position:absolute;left:123.00px;top:288.60px" class="cls_007"><span class="cls_007">class that corresponds to the current lexical scope. However, sometimes</span></div>
<div style="position:absolute;left:123.00px;top:300.60px" class="cls_007"><span class="cls_007">you’ll decide to add a method to a different class—for example, when you</span></div>
<div style="position:absolute;left:123.00px;top:312.60px" class="cls_007"><span class="cls_007">define a class method. (Remember that Ruby saves class methods in a class’s</span></div>
<div style="position:absolute;left:123.00px;top:324.60px" class="cls_007"><span class="cls_007">metaclass.) Listing 9-2 shows an example of creating a class method.</span></div>
<div style="position:absolute;left:123.00px;top:348.60px" class="cls_030"><span class="cls_030">class Quote</span></div>
<div style="position:absolute;left:111.15px;top:359.10px" class="cls_046"><span class="cls_046">u</span><span class="cls_030">   def self.display</span></div>
<div style="position:absolute;left:140.00px;top:369.60px" class="cls_030"><span class="cls_030">puts "The quick brown fox jumped over the lazy dog."</span></div>
<div style="position:absolute;left:131.50px;top:380.09px" class="cls_030"><span class="cls_030">end</span></div>
<div style="position:absolute;left:123.00px;top:390.59px" class="cls_030"><span class="cls_030">end</span></div>
<div style="position:absolute;left:123.00px;top:413.09px" class="cls_038"><span class="cls_038">Listing 9-2: Adding a class method using </span><span class="cls_014">def self</span></div>
<div style="position:absolute;left:141.00px;top:435.60px" class="cls_007"><span class="cls_007">At </span><span class="cls_050">u</span><span class="cls_007"> we use </span><span class="cls_030">def</span><span class="cls_007"> to define the new method, but this time we use a </span><span class="cls_030">self</span></div>
<div style="position:absolute;left:123.00px;top:447.60px" class="cls_007"><span class="cls_007">prefix. This prefix tells Ruby to add the method to the class of the object you</span></div>
<div style="position:absolute;left:123.00px;top:459.60px" class="cls_007"><span class="cls_007">specify in the prefix rather than using the current lexical scope. Figure 9-4</span></div>
<div style="position:absolute;left:123.00px;top:471.60px" class="cls_007"><span class="cls_007">shows how Ruby does this internally.</span></div>
<div style="position:absolute;left:141.00px;top:483.60px" class="cls_007"><span class="cls_007">This behavior is very different from the standard method definition</span></div>
<div style="position:absolute;left:123.00px;top:495.60px" class="cls_007"><span class="cls_007">process! When you provide an object prefix to </span><span class="cls_030">def</span><span class="cls_007">, Ruby uses the following</span></div>
<div style="position:absolute;left:123.00px;top:507.60px" class="cls_007"><span class="cls_007">algorithm to decide where to put the new method:</span></div>
<div style="position:absolute;left:123.00px;top:528.60px" class="cls_007"><span class="cls_007">1.   Ruby evaluates the prefix expression. In Listing 9-2 we use the </span><span class="cls_030">self</span><span class="cls_007"> key-</span></div>
<div style="position:absolute;left:141.00px;top:540.60px" class="cls_007"><span class="cls_007">word. While Ruby is executing code inside the </span><span class="cls_030">class Quote</span><span class="cls_007"> scope, </span><span class="cls_030">self</span></div>
<div style="position:absolute;left:141.00px;top:552.60px" class="cls_007"><span class="cls_007">is set to the </span><span class="cls_030">Quote</span><span class="cls_007"> class. (We could have provided any Ruby expression</span></div>
<div style="position:absolute;left:141.00px;top:564.60px" class="cls_007"><span class="cls_007">here instead of </span><span class="cls_030">self</span><span class="cls_007">.) In Figure 9-4, the arrow extending up from </span><span class="cls_030">self</span></div>
<div style="position:absolute;left:141.00px;top:576.60px" class="cls_007"><span class="cls_007">to the </span><span class="cls_030">RClass</span><span class="cls_007"> structure indicates the value of </span><span class="cls_030">self</span><span class="cls_007"> is </span><span class="cls_030">Quote</span><span class="cls_007">.</span></div>
<div style="position:absolute;left:380.39px;top:636.00px" class="cls_021"><span class="cls_021">Metaprogramming</span></div>
<div style="position:absolute;left:442.44px;top:633.00px" class="cls_020"><span class="cls_020">223</span></div>
</div>
<div style="position:absolute;left:50%;margin-left:-252px;top:164944px;width:504px;height:666px;border-style:outset;overflow:hidden">
<div style="position:absolute;left:0px;top:0px">
<img src="e698b76e-46bd-11eb-8b25-0cc47a792c0a_id_e698b76e-46bd-11eb-8b25-0cc47a792c0a_files/background248.jpg" width=504 height=666></div>
<div style="position:absolute;left:277.64px;top:49.26px" class="cls_042"><span class="cls_042">RClass: metaclass</span></div>
<div style="position:absolute;left:277.64px;top:58.67px" class="cls_042"><span class="cls_042">for Quote</span></div>
<div style="position:absolute;left:143.86px;top:61.92px" class="cls_042"><span class="cls_042">RClass: Quote</span></div>
<div style="position:absolute;left:302.59px;top:75.36px" class="cls_054"><span class="cls_054">method table:</span></div>
<div style="position:absolute;left:171.35px;top:81.75px" class="cls_014"><span class="cls_014">klass</span></div>
<div style="position:absolute;left:312.38px;top:91.72px" class="cls_014"><span class="cls_014">display</span></div>
<div style="position:absolute;left:152.62px;top:151.17px" class="cls_063"><span class="cls_063">def self.display</span></div>
<div style="position:absolute;left:162.12px;top:163.95px" class="cls_063"><span class="cls_063">--</span><span class="cls_064">snip</span><span class="cls_063">--</span></div>
<div style="position:absolute;left:152.62px;top:176.73px" class="cls_063"><span class="cls_063">end</span></div>
<div style="position:absolute;left:138.00px;top:196.66px" class="cls_038"><span class="cls_038">Figure 9-4: Providing an object prefix to </span><span class="cls_014">def</span><span class="cls_038"> instructs Ruby to add</span></div>
<div style="position:absolute;left:138.00px;top:207.16px" class="cls_038"><span class="cls_038">the new method to the object’s class.</span></div>
<div style="position:absolute;left:120.00px;top:232.66px" class="cls_007"><span class="cls_007">2.  Ruby finds the class of this object. In Listing 9-2, because </span><span class="cls_030">self</span><span class="cls_007"> is a class</span></div>
<div style="position:absolute;left:138.00px;top:244.66px" class="cls_007"><span class="cls_007">itself (</span><span class="cls_030">Quote</span><span class="cls_007">), the class of the object is actually the metaclass for </span><span class="cls_030">Quote</span><span class="cls_007">.</span></div>
<div style="position:absolute;left:138.00px;top:256.66px" class="cls_007"><span class="cls_007">Figure 9-4 indicates this with the arrow extending to the right from the</span></div>
<div style="position:absolute;left:138.00px;top:268.66px" class="cls_030"><span class="cls_030">RClass</span><span class="cls_007"> structure for </span><span class="cls_030">Quote</span><span class="cls_007">.</span></div>
<div style="position:absolute;left:120.00px;top:283.66px" class="cls_007"><span class="cls_007">3.  Ruby saves the new method in that class’s method table. In this</span></div>
<div style="position:absolute;left:138.00px;top:295.66px" class="cls_007"><span class="cls_007">case, Ruby places the </span><span class="cls_030">display</span><span class="cls_007"> method in the metaclass for </span><span class="cls_030">Quote</span><span class="cls_007">,</span></div>
<div style="position:absolute;left:138.00px;top:307.66px" class="cls_007"><span class="cls_007">making </span><span class="cls_030">display</span><span class="cls_007"> a new class method.</span></div>
<div style="position:absolute;left:78.00px;top:343.16px" class="cls_032"><span class="cls_032">NOTE</span></div>
<div style="position:absolute;left:120.00px;top:340.66px" class="cls_008"><span class="cls_008">If you call </span><span class="cls_030">Quote.class</span><span class="cls_008">, Ruby will return </span><span class="cls_030">Class</span><span class="cls_008">. All classes are officially instances of</span></div>
<div style="position:absolute;left:120.00px;top:352.66px" class="cls_008"><span class="cls_008">the </span><span class="cls_030">Class</span><span class="cls_008"> class. Metaclasses are an internal concept, normally hidden from your Ruby</span></div>
<div style="position:absolute;left:120.00px;top:364.66px" class="cls_008"><span class="cls_008">program. To see the metaclass for </span><span class="cls_030">Quote</span><span class="cls_008">, you can call </span><span class="cls_030">Quote.singleton_class</span><span class="cls_008"> instead,</span></div>
<div style="position:absolute;left:120.00px;top:376.66px" class="cls_008"><span class="cls_008">which will return </span><span class="cls_030">#&lt;Class:Quote></span><span class="cls_008">.</span></div>
<div style="position:absolute;left:120.00px;top:413.66px" class="cls_055"><span class="cls_055">Defining Class Methods Using a New Lexical Scope</span></div>
<div style="position:absolute;left:120.00px;top:431.66px" class="cls_007"><span class="cls_007">Listing 9-3 shows a different way to assign </span><span class="cls_030">display</span><span class="cls_007"> as a class method of </span><span class="cls_030">Quote</span><span class="cls_007">.</span></div>
<div style="position:absolute;left:108.15px;top:455.66px" class="cls_046"><span class="cls_046">u</span><span class="cls_030"> class Quote</span></div>
<div style="position:absolute;left:108.15px;top:466.16px" class="cls_046"><span class="cls_046">v</span><span class="cls_030">   class &lt;&lt; self</span></div>
<div style="position:absolute;left:137.00px;top:476.66px" class="cls_030"><span class="cls_030">def display</span></div>
<div style="position:absolute;left:145.50px;top:487.15px" class="cls_030"><span class="cls_030">puts "The quick brown fox jumped over the lazy dog."</span></div>
<div style="position:absolute;left:137.00px;top:497.65px" class="cls_030"><span class="cls_030">end</span></div>
<div style="position:absolute;left:128.50px;top:508.15px" class="cls_030"><span class="cls_030">end</span></div>
<div style="position:absolute;left:120.00px;top:518.65px" class="cls_030"><span class="cls_030">end</span></div>
<div style="position:absolute;left:120.00px;top:541.15px" class="cls_038"><span class="cls_038">Listing 9-3: Defining a class method using </span><span class="cls_014">class &lt;&lt; self</span></div>
<div style="position:absolute;left:138.00px;top:563.66px" class="cls_007"><span class="cls_007">At </span><span class="cls_050">v</span><span class="cls_007"> </span><span class="cls_030">class &lt;&lt; self</span><span class="cls_007"> declares a new lexical scope, just as </span><span class="cls_030">class Quote</span><span class="cls_007"> does</span></div>
<div style="position:absolute;left:120.00px;top:575.66px" class="cls_007"><span class="cls_007">at </span><span class="cls_050">u</span><span class="cls_007">. In “Ruby’s Normal Method Definition Process” on page 221, we saw</span></div>
<div style="position:absolute;left:120.00px;top:587.66px" class="cls_007"><span class="cls_007">that using </span><span class="cls_030">def</span><span class="cls_007"> in the scope created by </span><span class="cls_030">class Quote</span><span class="cls_007"> assigns new methods to</span></div>
<div style="position:absolute;left:48.00px;top:633.00px" class="cls_020"><span class="cls_020">224</span></div>
<div style="position:absolute;left:74.41px;top:636.00px" class="cls_021"><span class="cls_021">Chapter 9</span></div>
</div>
<div style="position:absolute;left:50%;margin-left:-252px;top:165620px;width:504px;height:666px;border-style:outset;overflow:hidden">
<div style="position:absolute;left:0px;top:0px">
<img src="e698b76e-46bd-11eb-8b25-0cc47a792c0a_id_e698b76e-46bd-11eb-8b25-0cc47a792c0a_files/background249.jpg" width=504 height=666></div>
<div style="position:absolute;left:123.00px;top:41.60px" class="cls_030"><span class="cls_030">Quote</span><span class="cls_007">. But what class does Ruby assign methods to inside the scope created</span></div>
<div style="position:absolute;left:123.00px;top:53.60px" class="cls_007"><span class="cls_007">by </span><span class="cls_030">class &lt;&lt; self</span><span class="cls_007">? The answer is </span><span class="cls_030">self</span><span class="cls_007">’s class. Because at </span><span class="cls_050">v</span><span class="cls_007"> </span><span class="cls_030">self</span><span class="cls_007"> is set to </span><span class="cls_030">Quote</span><span class="cls_007">,</span></div>
<div style="position:absolute;left:123.00px;top:65.60px" class="cls_030"><span class="cls_030">self</span><span class="cls_007">’s class is the metaclass of </span><span class="cls_030">Quote</span><span class="cls_007">.</span></div>
<div style="position:absolute;left:141.00px;top:77.60px" class="cls_007"><span class="cls_007">Figure 9-5 shows how </span><span class="cls_030">class &lt;&lt; self</span><span class="cls_007"> creates a new lexical scope for the</span></div>
<div style="position:absolute;left:123.00px;top:89.60px" class="cls_007"><span class="cls_007">metaclass of </span><span class="cls_030">Quote</span><span class="cls_007">.</span></div>
<div style="position:absolute;left:278.89px;top:110.89px" class="cls_017"><span class="cls_017">Lexical</span></div>
<div style="position:absolute;left:362.73px;top:117.05px" class="cls_042"><span class="cls_042">RClass: Quote</span></div>
<div style="position:absolute;left:278.58px;top:121.07px" class="cls_017"><span class="cls_017">Scope:</span></div>
<div style="position:absolute;left:123.42px;top:124.46px" class="cls_063"><span class="cls_063">class Quote</span></div>
<div style="position:absolute;left:388.16px;top:135.82px" class="cls_014"><span class="cls_014">klass</span></div>
<div style="position:absolute;left:132.92px;top:148.64px" class="cls_063"><span class="cls_063">class &lt;&lt; self</span></div>
<div style="position:absolute;left:285.92px;top:158.38px" class="cls_054"><span class="cls_054">etc.</span></div>
<div style="position:absolute;left:142.42px;top:184.90px" class="cls_063"><span class="cls_063">def display</span></div>
<div style="position:absolute;left:278.09px;top:188.21px" class="cls_014"><span class="cls_014">nd_next</span></div>
<div style="position:absolute;left:151.92px;top:196.98px" class="cls_063"><span class="cls_063">puts "The quick..."</span></div>
<div style="position:absolute;left:352.08px;top:203.05px" class="cls_042"><span class="cls_042">RClass: metaclass</span></div>
<div style="position:absolute;left:278.09px;top:207.20px" class="cls_014"><span class="cls_014">nd_clss</span></div>
<div style="position:absolute;left:142.42px;top:209.07px" class="cls_063"><span class="cls_063">end</span></div>
<div style="position:absolute;left:352.08px;top:211.96px" class="cls_042"><span class="cls_042">for Quote</span></div>
<div style="position:absolute;left:374.36px;top:227.75px" class="cls_054"><span class="cls_054">method table:</span></div>
<div style="position:absolute;left:132.92px;top:233.24px" class="cls_063"><span class="cls_063">end</span></div>
<div style="position:absolute;left:384.15px;top:243.23px" class="cls_014"><span class="cls_014">display</span></div>
<div style="position:absolute;left:123.42px;top:245.33px" class="cls_063"><span class="cls_063">end</span></div>
<div style="position:absolute;left:123.00px;top:289.04px" class="cls_038"><span class="cls_038">Figure 9-5: Ruby creates a new lexical scope for a class’s metaclass when you use</span></div>
<div style="position:absolute;left:123.00px;top:299.54px" class="cls_014"><span class="cls_014">class &lt;&lt; self</span><span class="cls_038">.</span></div>
<div style="position:absolute;left:141.00px;top:322.04px" class="cls_007"><span class="cls_007">In this figure, Ruby’s </span><span class="cls_030">class &lt;&lt;</span><span class="cls_007"> metaprogramming syntax functions as</span></div>
<div style="position:absolute;left:123.00px;top:334.04px" class="cls_007"><span class="cls_007">follows:</span></div>
<div style="position:absolute;left:123.00px;top:355.04px" class="cls_007"><span class="cls_007">1.   Ruby first evaluates the expression that appears after </span><span class="cls_030">class &lt;&lt;</span><span class="cls_007">. In</span></div>
<div style="position:absolute;left:141.00px;top:367.04px" class="cls_007"><span class="cls_007">Listing 9-3 this is the expression </span><span class="cls_030">self</span><span class="cls_007">, which evaluates to the </span><span class="cls_030">Quote</span><span class="cls_007"> class,</span></div>
<div style="position:absolute;left:141.00px;top:379.04px" class="cls_007"><span class="cls_007">just as it did using the object prefix syntax in Listing 9-2. The long arrow</span></div>
<div style="position:absolute;left:141.00px;top:391.04px" class="cls_007"><span class="cls_007">extending to the right from </span><span class="cls_030">self</span><span class="cls_007"> to the </span><span class="cls_030">RClass</span><span class="cls_007"> structure indicates the</span></div>
<div style="position:absolute;left:141.00px;top:403.04px" class="cls_007"><span class="cls_007">value of </span><span class="cls_030">self</span><span class="cls_007"> is the </span><span class="cls_030">Quote</span><span class="cls_007"> class.</span></div>
<div style="position:absolute;left:123.00px;top:418.04px" class="cls_007"><span class="cls_007">2.  Ruby finds the class for the object the expression evaluates to. In</span></div>
<div style="position:absolute;left:141.00px;top:430.04px" class="cls_007"><span class="cls_007">Listing 9-3 this will be the class of </span><span class="cls_030">Quote</span><span class="cls_007">, or </span><span class="cls_030">Quote</span><span class="cls_007">’s metaclass, indicated</span></div>
<div style="position:absolute;left:141.00px;top:442.04px" class="cls_007"><span class="cls_007">by the arrow extending down from </span><span class="cls_030">Quote</span><span class="cls_007"> to the metaclass for </span><span class="cls_030">Quote</span><span class="cls_007"> on</span></div>
<div style="position:absolute;left:141.00px;top:454.04px" class="cls_007"><span class="cls_007">the right side of the figure.</span></div>
<div style="position:absolute;left:123.00px;top:469.04px" class="cls_007"><span class="cls_007">3.  Ruby creates a new lexical scope for this class. In this example, the lexi-</span></div>
<div style="position:absolute;left:141.00px;top:481.04px" class="cls_007"><span class="cls_007">cal scope uses the metaclass of </span><span class="cls_030">Quote</span><span class="cls_007">, indicated by the arrow extending</span></div>
<div style="position:absolute;left:141.00px;top:493.04px" class="cls_007"><span class="cls_007">to the right from </span><span class="cls_030">nd_clss</span><span class="cls_007"> in the new scope.</span></div>
<div style="position:absolute;left:141.00px;top:514.04px" class="cls_007"><span class="cls_007">Now we can use the new lexical scope to define a series of class methods</span></div>
<div style="position:absolute;left:123.00px;top:526.04px" class="cls_007"><span class="cls_007">using </span><span class="cls_030">def</span><span class="cls_007"> as usual. In Listing 9-3 Ruby will assign the </span><span class="cls_030">display</span><span class="cls_007"> method directly</span></div>
<div style="position:absolute;left:123.00px;top:538.04px" class="cls_007"><span class="cls_007">to the metaclass of </span><span class="cls_030">Quote</span><span class="cls_007">. This is a different way of defining a class method</span></div>
<div style="position:absolute;left:123.00px;top:550.04px" class="cls_007"><span class="cls_007">for </span><span class="cls_030">Quote</span><span class="cls_007">. You might find </span><span class="cls_030">class &lt;&lt; self</span><span class="cls_007"> a bit more confusing than </span><span class="cls_030">def self</span><span class="cls_007">,</span></div>
<div style="position:absolute;left:123.00px;top:562.04px" class="cls_007"><span class="cls_007">but it is a convenient way to create a series of class methods by declaring</span></div>
<div style="position:absolute;left:123.00px;top:574.04px" class="cls_007"><span class="cls_007">them all inside the inner, metaclass lexical scope.</span></div>
<div style="position:absolute;left:380.45px;top:636.00px" class="cls_021"><span class="cls_021">Metaprogramming</span></div>
<div style="position:absolute;left:442.50px;top:633.00px" class="cls_020"><span class="cls_020">225</span></div>
</div>
<div style="position:absolute;left:50%;margin-left:-252px;top:166296px;width:504px;height:666px;border-style:outset;overflow:hidden">
<div style="position:absolute;left:0px;top:0px">
<img src="e698b76e-46bd-11eb-8b25-0cc47a792c0a_id_e698b76e-46bd-11eb-8b25-0cc47a792c0a_files/background250.jpg" width=504 height=666></div>
<div style="position:absolute;left:120.00px;top:42.55px" class="cls_055"><span class="cls_055">Defining Methods Using Singleton Classes</span></div>
<div style="position:absolute;left:120.00px;top:60.55px" class="cls_007"><span class="cls_007">We’ve seen how metaprogramming allows you to declare class methods by</span></div>
<div style="position:absolute;left:120.00px;top:72.55px" class="cls_007"><span class="cls_007">adding methods to the class’s class or metaclass. Ruby also allows you to add</span></div>
<div style="position:absolute;left:120.00px;top:84.55px" class="cls_007"><span class="cls_007">methods to a single object instance, as shown in Listing 9-4.</span></div>
<div style="position:absolute;left:108.15px;top:108.55px" class="cls_046"><span class="cls_046">u</span><span class="cls_030"> class Quote</span></div>
<div style="position:absolute;left:120.00px;top:119.04px" class="cls_030"><span class="cls_030">end</span></div>
<div style="position:absolute;left:108.15px;top:140.05px" class="cls_046"><span class="cls_046">v</span><span class="cls_030"> some_quote = Quote.new</span></div>
<div style="position:absolute;left:108.15px;top:150.54px" class="cls_046"><span class="cls_046">w</span><span class="cls_030"> def some_quote.display</span></div>
<div style="position:absolute;left:128.50px;top:161.04px" class="cls_030"><span class="cls_030">puts "The quick brown fox jumped over the lazy dog."</span></div>
<div style="position:absolute;left:120.00px;top:171.54px" class="cls_030"><span class="cls_030">end</span></div>
<div style="position:absolute;left:120.00px;top:194.04px" class="cls_038"><span class="cls_038">Listing 9-4: Adding a method to a single object instance</span></div>
<div style="position:absolute;left:138.00px;top:216.55px" class="cls_007"><span class="cls_007">At </span><span class="cls_050">u</span><span class="cls_007"> we declare the </span><span class="cls_030">Quote</span><span class="cls_007"> class; then, at </span><span class="cls_050">v</span><span class="cls_007"> we create an instance of</span></div>
<div style="position:absolute;left:120.00px;top:228.55px" class="cls_030"><span class="cls_030">Quote</span><span class="cls_007">: </span><span class="cls_030">some_quote</span><span class="cls_007">. At </span><span class="cls_050">w</span><span class="cls_007"> this time, however, we create a new method for the</span></div>
<div style="position:absolute;left:120.00px;top:240.55px" class="cls_030"><span class="cls_030">some_quote</span><span class="cls_007"> instance, not the </span><span class="cls_030">Quote</span><span class="cls_007"> class. As a result, only </span><span class="cls_030">some_quote</span><span class="cls_007"> will have</span></div>
<div style="position:absolute;left:120.00px;top:252.55px" class="cls_007"><span class="cls_007">the </span><span class="cls_030">display</span><span class="cls_007"> method; no other instances of </span><span class="cls_030">Quote</span><span class="cls_007"> will have it.</span></div>
<div style="position:absolute;left:138.00px;top:264.55px" class="cls_007"><span class="cls_007">Internally, Ruby implements this behavior using a hidden class called</span></div>
<div style="position:absolute;left:120.00px;top:276.55px" class="cls_007"><span class="cls_007">the </span><span class="cls_008">singleton class</span><span class="cls_007">, which is like a metaclass for a single object. Here’s the</span></div>
<div style="position:absolute;left:120.00px;top:288.55px" class="cls_007"><span class="cls_007">difference:</span></div>
<div style="position:absolute;left:120.00px;top:309.55px" class="cls_050"><span class="cls_050">•</span><span class="cls_007">   A </span><span class="cls_008">singleton class</span><span class="cls_007"> is a special hidden class that Ruby creates internally to</span></div>
<div style="position:absolute;left:138.00px;top:321.55px" class="cls_007"><span class="cls_007">hold methods defined only for a particular object.</span></div>
<div style="position:absolute;left:120.00px;top:336.55px" class="cls_050"><span class="cls_050">•</span><span class="cls_007">   A </span><span class="cls_008">metaclass</span><span class="cls_007"> is a singleton class in the case when that object is itself a class.</span></div>
<div style="position:absolute;left:138.00px;top:357.55px" class="cls_007"><span class="cls_007">All metaclasses are singleton classes, but not all singleton classes are</span></div>
<div style="position:absolute;left:120.00px;top:369.55px" class="cls_007"><span class="cls_007">metaclasses. Ruby automatically creates a metaclass for every class you create</span></div>
<div style="position:absolute;left:120.00px;top:381.55px" class="cls_007"><span class="cls_007">and uses it to hold class methods that you might declare later. On the other</span></div>
<div style="position:absolute;left:120.00px;top:393.55px" class="cls_007"><span class="cls_007">hand, Ruby creates a singleton class only when you define a method on a</span></div>
<div style="position:absolute;left:120.00px;top:405.55px" class="cls_007"><span class="cls_007">single object, as shown in Listing 9-4. Ruby also creates a singleton class</span></div>
<div style="position:absolute;left:120.00px;top:417.55px" class="cls_007"><span class="cls_007">when you use </span><span class="cls_030">instance_eval</span><span class="cls_007"> or related methods.</span></div>
<div style="position:absolute;left:78.00px;top:444.05px" class="cls_032"><span class="cls_032">NOTE</span></div>
<div style="position:absolute;left:120.00px;top:441.55px" class="cls_008"><span class="cls_008">Most Ruby developers use the terms </span><span class="cls_007">singleton class</span><span class="cls_008"> and </span><span class="cls_007">metaclass</span><span class="cls_008"> interchangeably,</span></div>
<div style="position:absolute;left:120.00px;top:453.55px" class="cls_008"><span class="cls_008">and when you call the </span><span class="cls_030">singleton_class</span><span class="cls_008"> method, Ruby will return either a singleton</span></div>
<div style="position:absolute;left:120.00px;top:465.55px" class="cls_008"><span class="cls_008">class or a metaclass. However, internally Ruby’s C source code does make a distinc-</span></div>
<div style="position:absolute;left:120.00px;top:477.55px" class="cls_008"><span class="cls_008">tion between singleton classes and metaclasses.</span></div>
<div style="position:absolute;left:138.00px;top:501.55px" class="cls_007"><span class="cls_007">Figure 9-6 shows how Ruby creates a singleton class when execut-</span></div>
<div style="position:absolute;left:120.00px;top:513.55px" class="cls_007"><span class="cls_007">ing Listing 9-4. Ruby evaluates the expression provided as a prefix to</span></div>
<div style="position:absolute;left:120.00px;top:525.55px" class="cls_030"><span class="cls_030">def</span><span class="cls_007">: </span><span class="cls_030">some_quote</span><span class="cls_007">. Because </span><span class="cls_030">some_quote</span><span class="cls_007"> is an object instance, Ruby creates a</span></div>
<div style="position:absolute;left:120.00px;top:537.55px" class="cls_007"><span class="cls_007">new singleton class for </span><span class="cls_030">some_quote</span><span class="cls_007"> and then assigns the new method to this</span></div>
<div style="position:absolute;left:120.00px;top:549.55px" class="cls_007"><span class="cls_007">singleton class. Using the </span><span class="cls_030">def</span><span class="cls_007"> keyword with an object prefix instructs Ruby</span></div>
<div style="position:absolute;left:120.00px;top:561.55px" class="cls_007"><span class="cls_007">either to use a metaclass (if the prefix is a class) or to create a singleton</span></div>
<div style="position:absolute;left:120.00px;top:573.55px" class="cls_007"><span class="cls_007">class (if the prefix is some other object).</span></div>
<div style="position:absolute;left:48.00px;top:633.00px" class="cls_020"><span class="cls_020">226</span></div>
<div style="position:absolute;left:74.47px;top:636.00px" class="cls_021"><span class="cls_021">Chapter 9</span></div>
</div>
<div style="position:absolute;left:50%;margin-left:-252px;top:166972px;width:504px;height:666px;border-style:outset;overflow:hidden">
<div style="position:absolute;left:0px;top:0px">
<img src="e698b76e-46bd-11eb-8b25-0cc47a792c0a_id_e698b76e-46bd-11eb-8b25-0cc47a792c0a_files/background251.jpg" width=504 height=666></div>
<div style="position:absolute;left:271.59px;top:49.22px" class="cls_042"><span class="cls_042">RClass: </span><span class="cls_019">singleton</span></div>
<div style="position:absolute;left:271.59px;top:58.60px" class="cls_019"><span class="cls_019">class for </span><span class="cls_042">some_quote</span></div>
<div style="position:absolute;left:128.85px;top:61.84px" class="cls_042"><span class="cls_042">RObject: some_quote</span></div>
<div style="position:absolute;left:296.38px;top:75.24px" class="cls_054"><span class="cls_054">method table:</span></div>
<div style="position:absolute;left:163.92px;top:81.61px" class="cls_014"><span class="cls_014">klass</span></div>
<div style="position:absolute;left:306.17px;top:91.55px" class="cls_014"><span class="cls_014">display</span></div>
<div style="position:absolute;left:126.12px;top:150.92px" class="cls_063"><span class="cls_063">def some_quote.display</span></div>
<div style="position:absolute;left:135.62px;top:163.65px" class="cls_063"><span class="cls_063">--</span><span class="cls_064">snip</span><span class="cls_063">--</span></div>
<div style="position:absolute;left:126.12px;top:176.38px" class="cls_063"><span class="cls_063">end</span></div>
<div style="position:absolute;left:123.00px;top:196.33px" class="cls_038"><span class="cls_038">Figure 9-6: Providing an object prefix to </span><span class="cls_014">def</span><span class="cls_038"> instructs Ruby to add the</span></div>
<div style="position:absolute;left:123.00px;top:206.83px" class="cls_038"><span class="cls_038">new method to the object’s singleton class.</span></div>
<div style="position:absolute;left:123.00px;top:242.33px" class="cls_055"><span class="cls_055">Defining Methods Using Singleton Classes in a Lexical Scope</span></div>
<div style="position:absolute;left:123.00px;top:260.33px" class="cls_007"><span class="cls_007">You can also declare a new lexical scope for adding methods to a single</span></div>
<div style="position:absolute;left:123.00px;top:272.33px" class="cls_007"><span class="cls_007">object instance using the </span><span class="cls_030">class &lt;&lt;</span><span class="cls_007"> syntax, as shown in Listing 9-5.</span></div>
<div style="position:absolute;left:123.00px;top:296.33px" class="cls_030"><span class="cls_030">class Quote</span></div>
<div style="position:absolute;left:123.00px;top:306.83px" class="cls_030"><span class="cls_030">end</span></div>
<div style="position:absolute;left:123.00px;top:327.83px" class="cls_030"><span class="cls_030">some_quote = Quote.new</span></div>
<div style="position:absolute;left:111.15px;top:338.33px" class="cls_046"><span class="cls_046">u</span><span class="cls_030"> class &lt;&lt; some_quote</span></div>
<div style="position:absolute;left:131.50px;top:348.82px" class="cls_030"><span class="cls_030">def display</span></div>
<div style="position:absolute;left:140.00px;top:359.32px" class="cls_030"><span class="cls_030">puts "The quick brown fox jumped over the lazy dog."</span></div>
<div style="position:absolute;left:131.50px;top:369.82px" class="cls_030"><span class="cls_030">end</span></div>
<div style="position:absolute;left:123.00px;top:380.32px" class="cls_030"><span class="cls_030">end</span></div>
<div style="position:absolute;left:123.00px;top:402.82px" class="cls_038"><span class="cls_038">Listing 9-5: Adding a singleton method using </span><span class="cls_014">class &lt;&lt;</span></div>
<div style="position:absolute;left:141.00px;top:425.33px" class="cls_007"><span class="cls_007">The difference between this code and that in Listing 9-4 appears at </span><span class="cls_050">u</span><span class="cls_007">,</span></div>
<div style="position:absolute;left:123.00px;top:437.33px" class="cls_007"><span class="cls_007">when we use the </span><span class="cls_030">class &lt;&lt;</span><span class="cls_007"> syntax with the expression </span><span class="cls_030">some_quote</span><span class="cls_007">, which evalu-</span></div>
<div style="position:absolute;left:122.99px;top:449.33px" class="cls_007"><span class="cls_007">ates to a single object instance. As shown in Figure 9-7, </span><span class="cls_030">class &lt;&lt; some_quote</span></div>
<div style="position:absolute;left:123.00px;top:461.33px" class="cls_007"><span class="cls_007">instructs Ruby to create a new singleton class along with a new lexical scope.</span></div>
<div style="position:absolute;left:141.00px;top:473.33px" class="cls_007"><span class="cls_007">On the left side of Figure 9-7, you can see some of the code from</span></div>
<div style="position:absolute;left:123.00px;top:485.33px" class="cls_007"><span class="cls_007">Listing 9-5. Ruby first evaluates the expression </span><span class="cls_030">some_quote</span><span class="cls_007"> and finds it is an</span></div>
<div style="position:absolute;left:123.00px;top:497.33px" class="cls_007"><span class="cls_007">object, not a class. Figure 9-7 indicates this with the long arrow pointing to</span></div>
<div style="position:absolute;left:123.00px;top:509.33px" class="cls_007"><span class="cls_007">the </span><span class="cls_030">RObject</span><span class="cls_007"> structure for </span><span class="cls_030">some_quote</span><span class="cls_007">. Because it is not a class, Ruby creates a</span></div>
<div style="position:absolute;left:123.00px;top:521.33px" class="cls_007"><span class="cls_007">new singleton class for </span><span class="cls_030">some_quote</span><span class="cls_007"> and also creates a new lexical scope. Next,</span></div>
<div style="position:absolute;left:123.00px;top:533.33px" class="cls_007"><span class="cls_007">it sets the class for the new scope to be the new singleton class. If a singleton</span></div>
<div style="position:absolute;left:123.00px;top:545.33px" class="cls_007"><span class="cls_007">class for </span><span class="cls_030">some_quote</span><span class="cls_007"> already exists, Ruby will reuse it.</span></div>
<div style="position:absolute;left:380.41px;top:636.00px" class="cls_021"><span class="cls_021">Metaprogramming</span></div>
<div style="position:absolute;left:442.46px;top:633.00px" class="cls_020"><span class="cls_020">227</span></div>
</div>
<div style="position:absolute;left:50%;margin-left:-252px;top:167648px;width:504px;height:666px;border-style:outset;overflow:hidden">
<div style="position:absolute;left:0px;top:0px">
<img src="e698b76e-46bd-11eb-8b25-0cc47a792c0a_id_e698b76e-46bd-11eb-8b25-0cc47a792c0a_files/background252.jpg" width=504 height=666></div>
<div style="position:absolute;left:273.03px;top:51.83px" class="cls_017"><span class="cls_017">Lexical</span></div>
<div style="position:absolute;left:345.23px;top:49.39px" class="cls_042"><span class="cls_042">RObject: some_quote</span></div>
<div style="position:absolute;left:272.74px;top:61.84px" class="cls_017"><span class="cls_017">Scope:</span></div>
<div style="position:absolute;left:380.87px;top:67.84px" class="cls_014"><span class="cls_014">klass</span></div>
<div style="position:absolute;left:280.45px;top:98.49px" class="cls_159"><span class="cls_159">etc.</span></div>
<div style="position:absolute;left:120.55px;top:99.00px" class="cls_063"><span class="cls_063">class &lt;&lt; some_quote</span></div>
<div style="position:absolute;left:130.05px;top:122.77px" class="cls_063"><span class="cls_063">def display</span></div>
<div style="position:absolute;left:272.24px;top:125.36px" class="cls_014"><span class="cls_014">nd_next</span></div>
<div style="position:absolute;left:139.55px;top:134.65px" class="cls_063"><span class="cls_063">puts "The quick..."</span></div>
<div style="position:absolute;left:345.23px;top:139.95px" class="cls_042"><span class="cls_042">RClass:</span><span class="cls_019"> singleton</span></div>
<div style="position:absolute;left:272.24px;top:144.03px" class="cls_014"><span class="cls_014">nd_clss</span></div>
<div style="position:absolute;left:130.05px;top:146.54px" class="cls_063"><span class="cls_063">end</span></div>
<div style="position:absolute;left:345.23px;top:148.70px" class="cls_019"><span class="cls_019">class for </span><span class="cls_042">some_quote</span></div>
<div style="position:absolute;left:367.07px;top:164.24px" class="cls_054"><span class="cls_054">method table:</span></div>
<div style="position:absolute;left:120.55px;top:170.30px" class="cls_063"><span class="cls_063">end</span></div>
<div style="position:absolute;left:376.86px;top:179.45px" class="cls_014"><span class="cls_014">display</span></div>
<div style="position:absolute;left:120.00px;top:223.58px" class="cls_038"><span class="cls_038">Figure 9-7: Ruby creates a new singleton class and lexical scope for </span><span class="cls_014">some_quote</span><span class="cls_038">.</span></div>
<div style="position:absolute;left:120.00px;top:259.08px" class="cls_055"><span class="cls_055">Creating Refinements</span></div>
<div style="position:absolute;left:120.00px;top:277.08px" class="cls_007"><span class="cls_007">Ruby 2.0’s </span><span class="cls_008">refinements</span><span class="cls_007"> feature gave us the ability to define methods and add</span></div>
<div style="position:absolute;left:120.00px;top:289.08px" class="cls_007"><span class="cls_007">them to a class later if we wish. To see how this works, we’ll use the same</span></div>
<div style="position:absolute;left:120.00px;top:301.08px" class="cls_030"><span class="cls_030">Quote</span><span class="cls_007"> class and </span><span class="cls_030">display</span><span class="cls_007"> method we used in Listing 9-1, repeated here for</span></div>
<div style="position:absolute;left:120.00px;top:313.08px" class="cls_007"><span class="cls_007">convenience.</span></div>
<div style="position:absolute;left:120.00px;top:337.08px" class="cls_030"><span class="cls_030">class Quote</span></div>
<div style="position:absolute;left:128.50px;top:347.58px" class="cls_030"><span class="cls_030">def display</span></div>
<div style="position:absolute;left:137.00px;top:358.08px" class="cls_030"><span class="cls_030">puts "The quick brown fox jumped over the lazy dog."</span></div>
<div style="position:absolute;left:128.50px;top:368.57px" class="cls_030"><span class="cls_030">end</span></div>
<div style="position:absolute;left:120.00px;top:379.07px" class="cls_030"><span class="cls_030">end</span></div>
<div style="position:absolute;left:138.00px;top:401.58px" class="cls_007"><span class="cls_007">Now suppose elsewhere in our Ruby application we want to override or</span></div>
<div style="position:absolute;left:120.00px;top:413.58px" class="cls_007"><span class="cls_007">change what </span><span class="cls_030">display</span><span class="cls_007"> does without changing the </span><span class="cls_030">Quote</span><span class="cls_007"> class everywhere. Ruby</span></div>
<div style="position:absolute;left:120.00px;top:425.58px" class="cls_007"><span class="cls_007">provides an elegant way to do this, as shown in Listing 9-6.</span></div>
<div style="position:absolute;left:120.00px;top:449.58px" class="cls_030"><span class="cls_030">module AllCaps</span></div>
<div style="position:absolute;left:128.50px;top:460.08px" class="cls_030"><span class="cls_030">refine Quote do</span></div>
<div style="position:absolute;left:137.00px;top:470.58px" class="cls_030"><span class="cls_030">def display</span></div>
<div style="position:absolute;left:145.50px;top:481.07px" class="cls_030"><span class="cls_030">puts "THE QUICK BROWN FOX JUMPED OVER THE LAZY DOG."</span></div>
<div style="position:absolute;left:137.00px;top:491.57px" class="cls_030"><span class="cls_030">end</span></div>
<div style="position:absolute;left:128.50px;top:502.07px" class="cls_030"><span class="cls_030">end</span></div>
<div style="position:absolute;left:120.00px;top:512.57px" class="cls_030"><span class="cls_030">end</span></div>
<div style="position:absolute;left:120.00px;top:535.07px" class="cls_038"><span class="cls_038">Listing 9-6: Refining a class inside a module</span></div>
<div style="position:absolute;left:138.00px;top:557.58px" class="cls_007"><span class="cls_007">In </span><span class="cls_030">refine Quote do</span><span class="cls_007">, we use the </span><span class="cls_030">refine</span><span class="cls_007"> method and pass the </span><span class="cls_030">Quote</span><span class="cls_007"> class as</span></div>
<div style="position:absolute;left:120.00px;top:569.58px" class="cls_007"><span class="cls_007">a parameter. This defines new behavior for </span><span class="cls_030">Quote</span><span class="cls_007"> that we can activate later.</span></div>
<div style="position:absolute;left:120.00px;top:581.58px" class="cls_007"><span class="cls_007">Figure 9-8 shows what happens internally when we call </span><span class="cls_030">refine</span><span class="cls_007">.</span></div>
<div style="position:absolute;left:48.00px;top:633.00px" class="cls_020"><span class="cls_020">228</span></div>
<div style="position:absolute;left:74.53px;top:636.00px" class="cls_021"><span class="cls_021">Chapter 9</span></div>
</div>
<div style="position:absolute;left:50%;margin-left:-252px;top:168324px;width:504px;height:666px;border-style:outset;overflow:hidden">
<div style="position:absolute;left:0px;top:0px">
<img src="e698b76e-46bd-11eb-8b25-0cc47a792c0a_id_e698b76e-46bd-11eb-8b25-0cc47a792c0a_files/background253.jpg" width=504 height=666></div>
<div style="position:absolute;left:276.04px;top:43.89px" class="cls_017"><span class="cls_017">Lexical</span></div>
<div style="position:absolute;left:275.73px;top:53.90px" class="cls_017"><span class="cls_017">Scope:</span></div>
<div style="position:absolute;left:123.59px;top:64.41px" class="cls_063"><span class="cls_063">module </span><span class="cls_160">AllCaps</span></div>
<div style="position:absolute;left:133.05px;top:76.29px" class="cls_063"><span class="cls_063">refine </span><span class="cls_160">Quote</span><span class="cls_063"> do</span></div>
<div style="position:absolute;left:142.55px;top:100.06px" class="cls_063"><span class="cls_063">def display</span></div>
<div style="position:absolute;left:275.24px;top:102.87px" class="cls_014"><span class="cls_014">nd_next</span></div>
<div style="position:absolute;left:353.85px;top:100.58px" class="cls_042"><span class="cls_042">RClass:</span></div>
<div style="position:absolute;left:353.85px;top:109.33px" class="cls_042"><span class="cls_042">refinement-module</span></div>
<div style="position:absolute;left:152.05px;top:111.94px" class="cls_063"><span class="cls_063">puts "THE QUICK..."</span></div>
<div style="position:absolute;left:275.24px;top:121.53px" class="cls_014"><span class="cls_014">nd_clss</span></div>
<div style="position:absolute;left:142.55px;top:123.83px" class="cls_063"><span class="cls_063">end</span></div>
<div style="position:absolute;left:373.13px;top:132.16px" class="cls_014"><span class="cls_014">refined_class</span></div>
<div style="position:absolute;left:133.05px;top:147.60px" class="cls_063"><span class="cls_063">end</span></div>
<div style="position:absolute;left:123.55px;top:159.48px" class="cls_063"><span class="cls_063">end</span></div>
<div style="position:absolute;left:353.85px;top:179.97px" class="cls_042"><span class="cls_042">RClass: Quote</span></div>
<div style="position:absolute;left:375.33px;top:203.63px" class="cls_054"><span class="cls_054">method table:</span></div>
<div style="position:absolute;left:212.27px;top:218.29px" class="cls_063"><span class="cls_063">VM_METHOD_TYPE_REFINED</span></div>
<div style="position:absolute;left:385.13px;top:218.85px" class="cls_014"><span class="cls_014">display</span></div>
<div style="position:absolute;left:123.00px;top:264.18px" class="cls_038"><span class="cls_038">Figure 9-8: Ruby creates a special module when you call </span><span class="cls_014">refine</span><span class="cls_038"> and updates the type of</span></div>
<div style="position:absolute;left:123.00px;top:274.68px" class="cls_038"><span class="cls_038">the target class’s methods.</span></div>
<div style="position:absolute;left:141.00px;top:297.18px" class="cls_007"><span class="cls_007">Working our way through Figure 9-8 from the top-left corner down, we</span></div>
<div style="position:absolute;left:123.00px;top:309.18px" class="cls_007"><span class="cls_007">see the following:</span></div>
<div style="position:absolute;left:123.00px;top:330.18px" class="cls_050"><span class="cls_050">•</span><span class="cls_007">   The </span><span class="cls_030">refine</span><span class="cls_007"> method creates a new lexical scope (the shaded rectangle).</span></div>
<div style="position:absolute;left:123.00px;top:345.18px" class="cls_050"><span class="cls_050">•</span><span class="cls_007">   Ruby creates a new “refinement” module and uses that as the class for</span></div>
<div style="position:absolute;left:141.00px;top:357.18px" class="cls_007"><span class="cls_007">this new scope.</span></div>
<div style="position:absolute;left:123.00px;top:372.18px" class="cls_050"><span class="cls_050">•</span><span class="cls_007">   Ruby saves a pointer to the </span><span class="cls_030">Quote</span><span class="cls_007"> class in </span><span class="cls_030">refined_class</span><span class="cls_007"> inside the new</span></div>
<div style="position:absolute;left:141.00px;top:384.18px" class="cls_007"><span class="cls_007">refinement module.</span></div>
<div style="position:absolute;left:141.00px;top:405.18px" class="cls_007"><span class="cls_007">As you define new methods in the refine block, Ruby saves them in</span></div>
<div style="position:absolute;left:123.00px;top:417.18px" class="cls_007"><span class="cls_007">the refinement module. But it also follows the </span><span class="cls_030">refined_class</span><span class="cls_007"> pointer and</span></div>
<div style="position:absolute;left:123.00px;top:429.18px" class="cls_007"><span class="cls_007">updates the same methods in the target class to use the method type</span></div>
<div style="position:absolute;left:123.00px;top:441.18px" class="cls_030"><span class="cls_030">VM_METHOD_TYPE_REFINED</span><span class="cls_007">.</span></div>
<div style="position:absolute;left:123.00px;top:466.18px" class="cls_055"><span class="cls_055">Using Refinements</span></div>
<div style="position:absolute;left:123.00px;top:484.18px" class="cls_007"><span class="cls_007">You can decide to activate these “refined” methods in a specific part of your</span></div>
<div style="position:absolute;left:123.00px;top:496.18px" class="cls_007"><span class="cls_007">program with the </span><span class="cls_030">using</span><span class="cls_007"> method, as shown in Listing 9-7.</span></div>
<div style="position:absolute;left:111.15px;top:520.18px" class="cls_046"><span class="cls_046">u</span><span class="cls_030"> Quote.new.display</span></div>
<div style="position:absolute;left:127.25px;top:530.68px" class="cls_030"><span class="cls_030">=> The quick brown...</span></div>
<div style="position:absolute;left:111.15px;top:551.68px" class="cls_046"><span class="cls_046">v</span><span class="cls_030"> using AllCaps</span></div>
<div style="position:absolute;left:111.15px;top:572.69px" class="cls_046"><span class="cls_046">w</span><span class="cls_030"> Quote.new.display</span></div>
<div style="position:absolute;left:127.25px;top:583.19px" class="cls_030"><span class="cls_030">=> THE QUICK BROWN...</span></div>
<div style="position:absolute;left:123.00px;top:605.69px" class="cls_038"><span class="cls_038">Listing 9-7: Activating a refined method</span></div>
<div style="position:absolute;left:380.35px;top:636.00px" class="cls_021"><span class="cls_021">Metaprogramming</span></div>
<div style="position:absolute;left:442.40px;top:633.00px" class="cls_020"><span class="cls_020">229</span></div>
</div>
<div style="position:absolute;left:50%;margin-left:-252px;top:169000px;width:504px;height:666px;border-style:outset;overflow:hidden">
<div style="position:absolute;left:0px;top:0px">
<img src="e698b76e-46bd-11eb-8b25-0cc47a792c0a_id_e698b76e-46bd-11eb-8b25-0cc47a792c0a_files/background254.jpg" width=504 height=666></div>
<div style="position:absolute;left:138.00px;top:42.71px" class="cls_007"><span class="cls_007">When we first call display at </span><span class="cls_050">u</span><span class="cls_007">, Ruby uses the original method. Then,</span></div>
<div style="position:absolute;left:120.00px;top:54.71px" class="cls_007"><span class="cls_007">at </span><span class="cls_050">v</span><span class="cls_007"> we activate the refinement with </span><span class="cls_030">using</span><span class="cls_007">, which causes Ruby to use the</span></div>
<div style="position:absolute;left:120.00px;top:66.71px" class="cls_007"><span class="cls_007">updated method when we call display again at </span><span class="cls_050">w</span><span class="cls_007">.</span></div>
<div style="position:absolute;left:138.00px;top:78.71px" class="cls_007"><span class="cls_007">The </span><span class="cls_030">using</span><span class="cls_007"> method attaches the refinements from the specified module</span></div>
<div style="position:absolute;left:120.00px;top:90.71px" class="cls_007"><span class="cls_007">to the current lexical scope. As I write this, the current version of Ruby, 2.0,</span></div>
<div style="position:absolute;left:120.00px;top:102.71px" class="cls_007"><span class="cls_007">allows you to use refinements only in the top-level scope, as in this example;</span></div>
<div style="position:absolute;left:120.00px;top:114.71px" class="cls_030"><span class="cls_030">using</span><span class="cls_007"> is a method of the top-level </span><span class="cls_030">main</span><span class="cls_007"> object. (Future versions may allow</span></div>
<div style="position:absolute;left:120.00px;top:126.71px" class="cls_007"><span class="cls_007">you to use refinements in any lexical scope in your program.) Figure 9-9</span></div>
<div style="position:absolute;left:120.00px;top:138.71px" class="cls_007"><span class="cls_007">shows how Ruby internally associates the refinement with the top-level</span></div>
<div style="position:absolute;left:120.00px;top:150.71px" class="cls_007"><span class="cls_007">lexical scope.</span></div>
<div style="position:absolute;left:145.54px;top:172.00px" class="cls_017"><span class="cls_017">Top-Level</span></div>
<div style="position:absolute;left:135.09px;top:181.86px" class="cls_017"><span class="cls_017">Lexical Scope:</span></div>
<div style="position:absolute;left:158.61px;top:199.00px" class="cls_017"><span class="cls_017">nil</span></div>
<div style="position:absolute;left:150.25px;top:230.94px" class="cls_164"><span class="cls_164">nd_next</span></div>
<div style="position:absolute;left:150.25px;top:249.31px" class="cls_164"><span class="cls_164">nd_clss</span></div>
<div style="position:absolute;left:210.76px;top:249.21px" class="cls_054"><span class="cls_054">[</span><span class="cls_014">main</span><span class="cls_054"> object]</span></div>
<div style="position:absolute;left:137.32px;top:267.68px" class="cls_164"><span class="cls_164">nd_refinements</span></div>
<div style="position:absolute;left:170.90px;top:296.72px" class="cls_063"><span class="cls_063">using </span><span class="cls_160">AllCaps</span></div>
<div style="position:absolute;left:153.18px;top:334.75px" class="cls_014"><span class="cls_014">Quote</span></div>
<div style="position:absolute;left:275.04px;top:339.99px" class="cls_053"><span class="cls_053">RClass:</span></div>
<div style="position:absolute;left:259.47px;top:348.61px" class="cls_053"><span class="cls_053">AllCaps</span><span class="cls_067"> module</span></div>
<div style="position:absolute;left:151.18px;top:353.84px" class="cls_014"><span class="cls_014">etc...</span></div>
<div style="position:absolute;left:120.00px;top:379.96px" class="cls_038"><span class="cls_038">Figure 9-9: The </span><span class="cls_014">using</span><span class="cls_038"> method associates a module’s</span></div>
<div style="position:absolute;left:120.00px;top:390.46px" class="cls_038"><span class="cls_038">refinements with the top-level lexical scope.</span></div>
<div style="position:absolute;left:138.00px;top:412.96px" class="cls_007"><span class="cls_007">Notice how each lexical scope contains an </span><span class="cls_030">nd_refinements</span><span class="cls_007"> pointer,</span></div>
<div style="position:absolute;left:120.00px;top:424.96px" class="cls_007"><span class="cls_007">which tracks the refinements active in that scope. The </span><span class="cls_030">using</span><span class="cls_007"> method sets</span></div>
<div style="position:absolute;left:120.00px;top:436.96px" class="cls_030"><span class="cls_030">nd_refinements</span><span class="cls_007">, which would otherwise be </span><span class="cls_030">nil</span><span class="cls_007">.</span></div>
<div style="position:absolute;left:138.00px;top:448.96px" class="cls_007"><span class="cls_007">And finally, Figure 9-10 shows how Ruby’s method dispatch algorithm</span></div>
<div style="position:absolute;left:120.00px;top:460.96px" class="cls_007"><span class="cls_007">finds the updated method when I call it.</span></div>
<div style="position:absolute;left:138.00px;top:472.96px" class="cls_007"><span class="cls_007">Ruby uses a complex method dispatch process when you call methods.</span></div>
<div style="position:absolute;left:120.00px;top:484.96px" class="cls_007"><span class="cls_007">One portion of this algorithm looks for </span><span class="cls_030">VM_METHOD_TYPE_REFINED</span><span class="cls_007"> methods.</span></div>
<div style="position:absolute;left:120.00px;top:496.96px" class="cls_007"><span class="cls_007">When it encounters a refined method, Ruby looks in the current lexical</span></div>
<div style="position:absolute;left:120.00px;top:508.96px" class="cls_007"><span class="cls_007">scope for any active refinements. If it finds an active refinement, Ruby calls</span></div>
<div style="position:absolute;left:120.00px;top:520.96px" class="cls_007"><span class="cls_007">the refined method; otherwise, it calls the original method.</span></div>
<div style="position:absolute;left:48.00px;top:633.00px" class="cls_020"><span class="cls_020">230</span></div>
<div style="position:absolute;left:74.59px;top:636.00px" class="cls_021"><span class="cls_021">Chapter 9</span></div>
</div>
<div style="position:absolute;left:50%;margin-left:-252px;top:169676px;width:504px;height:666px;border-style:outset;overflow:hidden">
<div style="position:absolute;left:0px;top:0px">
<img src="e698b76e-46bd-11eb-8b25-0cc47a792c0a_id_e698b76e-46bd-11eb-8b25-0cc47a792c0a_files/background255.jpg" width=504 height=666></div>
<div style="position:absolute;left:156.99px;top:45.05px" class="cls_160"><span class="cls_160">Quote</span><span class="cls_063">.new.display</span></div>
<div style="position:absolute;left:345.51px;top:54.17px" class="cls_014"><span class="cls_014">nd_next</span></div>
<div style="position:absolute;left:345.51px;top:70.79px" class="cls_014"><span class="cls_014">nd_clss</span></div>
<div style="position:absolute;left:128.29px;top:86.66px" class="cls_042"><span class="cls_042">RClass: Quote</span></div>
<div style="position:absolute;left:331.51px;top:87.42px" class="cls_014"><span class="cls_014">nd_refinements</span></div>
<div style="position:absolute;left:144.73px;top:106.74px" class="cls_054"><span class="cls_054">method table:</span></div>
<div style="position:absolute;left:154.52px;top:120.30px" class="cls_014"><span class="cls_014">display</span></div>
<div style="position:absolute;left:238.33px;top:119.60px" class="cls_063"><span class="cls_063">VM_METHOD_TYPE_REFINED</span></div>
<div style="position:absolute;left:303.62px;top:137.41px" class="cls_063"><span class="cls_063">module </span><span class="cls_160">AllCaps</span></div>
<div style="position:absolute;left:313.12px;top:148.00px" class="cls_063"><span class="cls_063">refine </span><span class="cls_160">Quote</span><span class="cls_063"> do</span></div>
<div style="position:absolute;left:322.62px;top:158.59px" class="cls_063"><span class="cls_063">def display</span></div>
<div style="position:absolute;left:332.12px;top:169.19px" class="cls_063"><span class="cls_063">puts "THE QUICK BROWN..."</span></div>
<div style="position:absolute;left:322.62px;top:179.78px" class="cls_063"><span class="cls_063">end</span></div>
<div style="position:absolute;left:313.12px;top:190.37px" class="cls_063"><span class="cls_063">end</span></div>
<div style="position:absolute;left:303.62px;top:200.96px" class="cls_063"><span class="cls_063">end</span></div>
<div style="position:absolute;left:123.00px;top:220.88px" class="cls_038"><span class="cls_038">Figure 9-10: Ruby looks for a method in the refine block when the original method is</span></div>
<div style="position:absolute;left:123.00px;top:231.38px" class="cls_038"><span class="cls_038">marked with </span><span class="cls_014">VM_METHOD_TYPE_REFINED</span><span class="cls_038">.</span></div>
<div style="position:absolute;left:123.00px;top:263.88px" class="cls_031"><span class="cls_031">Experiment 9-1: Who Am I? How self Changes with</span></div>
<div style="position:absolute;left:123.00px;top:278.88px" class="cls_031"><span class="cls_031">Lexical Scope</span></div>
<div style="position:absolute;left:123.00px;top:298.88px" class="cls_007"><span class="cls_007">We’ve seen various ways to define methods in Ruby. We created methods in</span></div>
<div style="position:absolute;left:123.00px;top:310.88px" class="cls_007"><span class="cls_007">the usual way using the </span><span class="cls_030">def</span><span class="cls_007"> keyword. Then, we looked at how to create meth-</span></div>
<div style="position:absolute;left:123.00px;top:322.88px" class="cls_007"><span class="cls_007">ods on a metaclass and on a singleton class and how to use refinements.</span></div>
<div style="position:absolute;left:141.00px;top:334.88px" class="cls_007"><span class="cls_007">While each technique adds the method to a different class, each also</span></div>
<div style="position:absolute;left:123.00px;top:346.88px" class="cls_007"><span class="cls_007">follows a simple rule: Ruby adds the new method to the class corresponding</span></div>
<div style="position:absolute;left:123.00px;top:358.88px" class="cls_007"><span class="cls_007">to the current lexical scope for each technique. (The </span><span class="cls_030">def</span><span class="cls_007"> keyword, however,</span></div>
<div style="position:absolute;left:123.00px;top:370.88px" class="cls_007"><span class="cls_007">assigns the method to a different class when you use a prefix.) With refine-</span></div>
<div style="position:absolute;left:123.00px;top:382.88px" class="cls_007"><span class="cls_007">ments, the current scope’s class is actually the special module created to</span></div>
<div style="position:absolute;left:123.00px;top:394.88px" class="cls_007"><span class="cls_007">hold the refined methods. In fact, this is one of the important roles lexical</span></div>
<div style="position:absolute;left:123.00px;top:406.88px" class="cls_007"><span class="cls_007">scope plays in Ruby: It identifies which class or module we are currently</span></div>
<div style="position:absolute;left:123.00px;top:418.88px" class="cls_007"><span class="cls_007">adding methods to.</span></div>
<div style="position:absolute;left:141.00px;top:430.88px" class="cls_007"><span class="cls_007">We also know that the </span><span class="cls_030">self</span><span class="cls_007"> keyword returns the current object—the</span></div>
<div style="position:absolute;left:123.00px;top:442.88px" class="cls_007"><span class="cls_007">receiver of the method currently being executed by Ruby. Recall that YARV</span></div>
<div style="position:absolute;left:123.00px;top:454.88px" class="cls_007"><span class="cls_007">saves the current value of </span><span class="cls_030">self</span><span class="cls_007"> for each level of your Ruby call stack in the</span></div>
<div style="position:absolute;left:123.00px;top:466.88px" class="cls_030"><span class="cls_030">rb_control_frame_t</span><span class="cls_007"> structure. Is this object the same as the class for the cur-</span></div>
<div style="position:absolute;left:123.00px;top:478.88px" class="cls_007"><span class="cls_007">rent lexical scope?</span></div>
<div style="position:absolute;left:123.00px;top:500.88px" class="cls_055"><span class="cls_055">self in the Top Scope</span></div>
<div style="position:absolute;left:123.00px;top:518.88px" class="cls_007"><span class="cls_007">Let’s see how the value of </span><span class="cls_030">self</span><span class="cls_007"> changes as we run a simple program begin-</span></div>
<div style="position:absolute;left:123.00px;top:530.88px" class="cls_007"><span class="cls_007">ning with Listing 9-8.</span></div>
<div style="position:absolute;left:123.00px;top:554.88px" class="cls_030"><span class="cls_030">p self</span></div>
<div style="position:absolute;left:127.25px;top:565.38px" class="cls_030"><span class="cls_030">=> main</span></div>
<div style="position:absolute;left:123.00px;top:575.87px" class="cls_030"><span class="cls_030">p Module.nesting</span></div>
<div style="position:absolute;left:127.25px;top:586.37px" class="cls_030"><span class="cls_030">=> []</span></div>
<div style="position:absolute;left:123.00px;top:608.87px" class="cls_038"><span class="cls_038">Listing 9-8: A simple Ruby program with only one lexical scope</span></div>
<div style="position:absolute;left:380.74px;top:636.00px" class="cls_021"><span class="cls_021">Metaprogramming</span></div>
<div style="position:absolute;left:442.79px;top:633.00px" class="cls_020"><span class="cls_020">231</span></div>
</div>
<div style="position:absolute;left:50%;margin-left:-252px;top:170352px;width:504px;height:666px;border-style:outset;overflow:hidden">
<div style="position:absolute;left:0px;top:0px">
<img src="e698b76e-46bd-11eb-8b25-0cc47a792c0a_id_e698b76e-46bd-11eb-8b25-0cc47a792c0a_files/background256.jpg" width=504 height=666></div>
<div style="position:absolute;left:138.00px;top:42.28px" class="cls_007"><span class="cls_007">To keep things simple, I’ve shown the output from the console inline.</span></div>
<div style="position:absolute;left:120.00px;top:54.28px" class="cls_007"><span class="cls_007">You can see that Ruby creates a </span><span class="cls_030">top self</span><span class="cls_007"> object before it starts to execute</span></div>
<div style="position:absolute;left:120.00px;top:66.28px" class="cls_007"><span class="cls_007">your code. This object serves as the receiver for method calls in the top-</span></div>
<div style="position:absolute;left:120.00px;top:78.28px" class="cls_007"><span class="cls_007">level scope. Ruby represents this object with the string </span><span class="cls_030">main</span><span class="cls_007">.</span></div>
<div style="position:absolute;left:138.00px;top:90.28px" class="cls_007"><span class="cls_007">The </span><span class="cls_030">Module.nesting</span><span class="cls_007"> call returns an array showing the lexical scope stack—</span></div>
<div style="position:absolute;left:120.00px;top:102.28px" class="cls_007"><span class="cls_007">that is, which modules are “nested” until that point in the code. This array</span></div>
<div style="position:absolute;left:120.00px;top:114.28px" class="cls_007"><span class="cls_007">will contain an element for each lexical scope in the lexical scope stack.</span></div>
<div style="position:absolute;left:120.00px;top:126.28px" class="cls_007"><span class="cls_007">Because we’re at the top level of the script, Ruby returns an empty array.</span></div>
<div style="position:absolute;left:138.00px;top:138.28px" class="cls_007"><span class="cls_007">Figure 9-11 shows the lexical scope stack and the value </span><span class="cls_030">self</span><span class="cls_007"> for this</span></div>
<div style="position:absolute;left:120.00px;top:150.28px" class="cls_007"><span class="cls_007">simple program.</span></div>
<div style="position:absolute;left:208.24px;top:181.06px" class="cls_017"><span class="cls_017">Lexical</span></div>
<div style="position:absolute;left:372.04px;top:181.06px" class="cls_017"><span class="cls_017">Value of </span><span class="cls_033">self</span></div>
<div style="position:absolute;left:196.11px;top:191.86px" class="cls_017"><span class="cls_017">Scope Stack:</span></div>
<div style="position:absolute;left:367.61px;top:191.86px" class="cls_017"><span class="cls_017">for Each Scope:</span></div>
<div style="position:absolute;left:150.94px;top:216.03px" class="cls_054"><span class="cls_054">nil</span></div>
<div style="position:absolute;left:141.00px;top:244.90px" class="cls_014"><span class="cls_014">nd_next</span></div>
<div style="position:absolute;left:141.00px;top:265.04px" class="cls_014"><span class="cls_014">nd_clss</span></div>
<div style="position:absolute;left:228.71px;top:264.04px" class="cls_042"><span class="cls_042">RClass: Object</span></div>
<div style="position:absolute;left:368.75px;top:264.04px" class="cls_042"><span class="cls_042">RObject: main</span></div>
<div style="position:absolute;left:120.00px;top:314.67px" class="cls_038"><span class="cls_038">Figure 9-11: At the top level, Ruby sets </span><span class="cls_014">self</span><span class="cls_038"> to the </span><span class="cls_014">main</span><span class="cls_038"> object and has a single entry in</span></div>
<div style="position:absolute;left:120.00px;top:325.17px" class="cls_038"><span class="cls_038">the lexical scope stack.</span></div>
<div style="position:absolute;left:138.00px;top:347.67px" class="cls_007"><span class="cls_007">On the right of this figure, you see the </span><span class="cls_030">main</span><span class="cls_007"> object: the current value of</span></div>
<div style="position:absolute;left:120.00px;top:359.67px" class="cls_030"><span class="cls_030">self</span><span class="cls_007">. On the left side is the lexical scope stack, which contains just a single</span></div>
<div style="position:absolute;left:120.00px;top:371.67px" class="cls_007"><span class="cls_007">entry for the top-level scope. Ruby sets the class of the top scope to the class</span></div>
<div style="position:absolute;left:120.00px;top:383.67px" class="cls_007"><span class="cls_007">of the </span><span class="cls_030">main</span><span class="cls_007"> object, which is the </span><span class="cls_030">Object</span><span class="cls_007"> class.</span></div>
<div style="position:absolute;left:78.00px;top:410.17px" class="cls_032"><span class="cls_032">NOTE</span></div>
<div style="position:absolute;left:120.00px;top:407.67px" class="cls_008"><span class="cls_008">Recall when you declare a new method using the </span><span class="cls_030">def</span><span class="cls_008"> keyword, Ruby adds the method</span></div>
<div style="position:absolute;left:120.00px;top:419.67px" class="cls_008"><span class="cls_008">to the class for the current lexical scope. We’ve just seen the class for the top-level lexical</span></div>
<div style="position:absolute;left:120.00px;top:431.67px" class="cls_008"><span class="cls_008">scope is </span><span class="cls_030">Object</span><span class="cls_008">. Therefore, we can conclude that when you define a method at the top</span></div>
<div style="position:absolute;left:120.00px;top:443.67px" class="cls_008"><span class="cls_008">level of your script, outside of any class or module, Ruby adds the method to the </span><span class="cls_030">Object</span></div>
<div style="position:absolute;left:120.00px;top:455.67px" class="cls_008"><span class="cls_008">class. You can call methods you define at the top level from anywhere because </span><span class="cls_030">Object</span><span class="cls_008"> is</span></div>
<div style="position:absolute;left:120.00px;top:467.67px" class="cls_008"><span class="cls_008">a superclass of every other class.</span></div>
<div style="position:absolute;left:120.00px;top:504.67px" class="cls_055"><span class="cls_055">self in a Class Scope</span></div>
<div style="position:absolute;left:120.00px;top:522.67px" class="cls_007"><span class="cls_007">Now let’s define a new class and see what happens to the value of </span><span class="cls_030">self</span><span class="cls_007"> and</span></div>
<div style="position:absolute;left:120.00px;top:534.67px" class="cls_007"><span class="cls_007">the lexical scope stack, as shown in Listing 9-9.</span></div>
<div style="position:absolute;left:120.00px;top:558.67px" class="cls_030"><span class="cls_030">p self</span></div>
<div style="position:absolute;left:120.00px;top:569.17px" class="cls_030"><span class="cls_030">p Module.nesting</span></div>
<div style="position:absolute;left:120.00px;top:590.17px" class="cls_030"><span class="cls_030">class Quote</span></div>
<div style="position:absolute;left:128.50px;top:600.67px" class="cls_030"><span class="cls_030">p self</span></div>
<div style="position:absolute;left:108.15px;top:611.17px" class="cls_046"><span class="cls_046">u</span></div>
<div style="position:absolute;left:132.73px;top:611.17px" class="cls_030"><span class="cls_030">=> Quote</span></div>
<div style="position:absolute;left:48.00px;top:633.00px" class="cls_020"><span class="cls_020">232</span></div>
<div style="position:absolute;left:74.46px;top:636.00px" class="cls_021"><span class="cls_021">Chapter 9</span></div>
</div>
<div style="position:absolute;left:50%;margin-left:-252px;top:171028px;width:504px;height:666px;border-style:outset;overflow:hidden">
<div style="position:absolute;left:0px;top:0px">
<img src="e698b76e-46bd-11eb-8b25-0cc47a792c0a_id_e698b76e-46bd-11eb-8b25-0cc47a792c0a_files/background257.jpg" width=504 height=666></div>
<div style="position:absolute;left:131.50px;top:42.24px" class="cls_030"><span class="cls_030">p Module.nesting</span></div>
<div style="position:absolute;left:111.15px;top:52.74px" class="cls_046"><span class="cls_046">v</span></div>
<div style="position:absolute;left:135.73px;top:52.74px" class="cls_030"><span class="cls_030">=> [Quote]</span></div>
<div style="position:absolute;left:123.00px;top:63.23px" class="cls_030"><span class="cls_030">end</span></div>
<div style="position:absolute;left:123.00px;top:85.73px" class="cls_038"><span class="cls_038">Listing 9-9: Declaring a new class changes </span><span class="cls_014">self</span><span class="cls_038"> and creates a new entry in the lexical</span></div>
<div style="position:absolute;left:123.00px;top:96.24px" class="cls_038"><span class="cls_038">scope stack.</span></div>
<div style="position:absolute;left:141.00px;top:118.74px" class="cls_007"><span class="cls_007">The output from the print statements is shown inline. We see at </span><span class="cls_050">u</span></div>
<div style="position:absolute;left:123.00px;top:130.74px" class="cls_007"><span class="cls_007">that Ruby has changed </span><span class="cls_030">self</span><span class="cls_007"> to </span><span class="cls_030">Quote</span><span class="cls_007">—the new class—and we see at </span><span class="cls_050">v</span><span class="cls_007"> that</span></div>
<div style="position:absolute;left:123.00px;top:142.74px" class="cls_007"><span class="cls_007">there’s a new level added to the lexical scope stack. Figure 9-12 shows a</span></div>
<div style="position:absolute;left:123.00px;top:154.74px" class="cls_007"><span class="cls_007">summary.</span></div>
<div style="position:absolute;left:211.92px;top:184.84px" class="cls_017"><span class="cls_017">Lexical</span></div>
<div style="position:absolute;left:375.72px;top:184.84px" class="cls_017"><span class="cls_017">Value of </span><span class="cls_033">self</span></div>
<div style="position:absolute;left:199.78px;top:195.64px" class="cls_017"><span class="cls_017">Scope Stack:</span></div>
<div style="position:absolute;left:371.29px;top:195.64px" class="cls_017"><span class="cls_017">for Each Scope:</span></div>
<div style="position:absolute;left:154.62px;top:219.81px" class="cls_054"><span class="cls_054">nil</span></div>
<div style="position:absolute;left:144.68px;top:248.68px" class="cls_014"><span class="cls_014">nd_next</span></div>
<div style="position:absolute;left:144.68px;top:268.83px" class="cls_014"><span class="cls_014">nd_clss</span></div>
<div style="position:absolute;left:232.38px;top:267.83px" class="cls_042"><span class="cls_042">RClass: Object</span></div>
<div style="position:absolute;left:372.42px;top:267.83px" class="cls_042"><span class="cls_042">RObject: main</span></div>
<div style="position:absolute;left:144.68px;top:326.22px" class="cls_014"><span class="cls_014">nd_next</span></div>
<div style="position:absolute;left:144.68px;top:346.37px" class="cls_014"><span class="cls_014">nd_clss</span></div>
<div style="position:absolute;left:372.42px;top:345.37px" class="cls_042"><span class="cls_042">RClass: Quote</span></div>
<div style="position:absolute;left:123.00px;top:390.01px" class="cls_038"><span class="cls_038">Figure 9-12: Now </span><span class="cls_014">self</span><span class="cls_038"> is the same as the class for the current lexical scope.</span></div>
<div style="position:absolute;left:141.00px;top:412.51px" class="cls_007"><span class="cls_007">On the left side of this figure, we see the lexical scope stack. The top</span></div>
<div style="position:absolute;left:123.00px;top:424.51px" class="cls_007"><span class="cls_007">scope is on the top left, and under it we see the new lexical scope created by</span></div>
<div style="position:absolute;left:123.00px;top:436.51px" class="cls_007"><span class="cls_007">the </span><span class="cls_030">class</span><span class="cls_007"> keyword. Meanwhile, on the right side of the figure, we see how the</span></div>
<div style="position:absolute;left:123.00px;top:448.51px" class="cls_007"><span class="cls_007">value of </span><span class="cls_030">self</span><span class="cls_007"> changes when we call </span><span class="cls_030">class</span><span class="cls_007">. On the top level, </span><span class="cls_030">self</span><span class="cls_007"> was set to the</span></div>
<div style="position:absolute;left:123.00px;top:460.51px" class="cls_030"><span class="cls_030">main</span><span class="cls_007"> object, but when we call </span><span class="cls_030">class</span><span class="cls_007">, Ruby changes </span><span class="cls_030">self</span><span class="cls_007"> to the new class.</span></div>
<div style="position:absolute;left:123.00px;top:485.51px" class="cls_055"><span class="cls_055">self in a Metaclass Scope</span></div>
<div style="position:absolute;left:123.00px;top:503.51px" class="cls_007"><span class="cls_007">Let’s use the </span><span class="cls_030">class &lt;&lt; self</span><span class="cls_007"> syntax to create a new metaclass scope. Listing 9-10</span></div>
<div style="position:absolute;left:123.00px;top:515.51px" class="cls_007"><span class="cls_007">shows the same program with a few more lines of code.</span></div>
<div style="position:absolute;left:123.00px;top:539.51px" class="cls_030"><span class="cls_030">p self</span></div>
<div style="position:absolute;left:123.00px;top:550.01px" class="cls_030"><span class="cls_030">p Module.nesting</span></div>
<div style="position:absolute;left:123.00px;top:571.01px" class="cls_030"><span class="cls_030">class Quote</span></div>
<div style="position:absolute;left:131.50px;top:581.51px" class="cls_030"><span class="cls_030">p self</span></div>
<div style="position:absolute;left:131.50px;top:592.01px" class="cls_030"><span class="cls_030">p Module.nesting</span></div>
<div style="position:absolute;left:380.30px;top:636.00px" class="cls_021"><span class="cls_021">Metaprogramming</span></div>
<div style="position:absolute;left:442.35px;top:633.00px" class="cls_020"><span class="cls_020">233</span></div>
</div>
<div style="position:absolute;left:50%;margin-left:-252px;top:171704px;width:504px;height:666px;border-style:outset;overflow:hidden">
<div style="position:absolute;left:0px;top:0px">
<img src="e698b76e-46bd-11eb-8b25-0cc47a792c0a_id_e698b76e-46bd-11eb-8b25-0cc47a792c0a_files/background258.jpg" width=504 height=666></div>
<div style="position:absolute;left:128.50px;top:42.82px" class="cls_030"><span class="cls_030">class &lt;&lt; self</span></div>
<div style="position:absolute;left:137.00px;top:53.31px" class="cls_030"><span class="cls_030">p self</span></div>
<div style="position:absolute;left:108.15px;top:63.81px" class="cls_046"><span class="cls_046">u</span></div>
<div style="position:absolute;left:141.23px;top:63.81px" class="cls_030"><span class="cls_030">=> #&lt;Class:Quote></span></div>
<div style="position:absolute;left:137.00px;top:74.31px" class="cls_030"><span class="cls_030">p Module.nesting</span></div>
<div style="position:absolute;left:108.15px;top:84.81px" class="cls_046"><span class="cls_046">v</span></div>
<div style="position:absolute;left:141.23px;top:84.81px" class="cls_030"><span class="cls_030">=> [#&lt;Class:Quote>, Quote]</span></div>
<div style="position:absolute;left:128.50px;top:95.30px" class="cls_030"><span class="cls_030">end</span></div>
<div style="position:absolute;left:120.00px;top:105.80px" class="cls_030"><span class="cls_030">end</span></div>
<div style="position:absolute;left:120.00px;top:128.30px" class="cls_038"><span class="cls_038">Listing 9-10: Declaring a metaclass scope</span></div>
<div style="position:absolute;left:138.00px;top:150.82px" class="cls_007"><span class="cls_007">At </span><span class="cls_050">u</span><span class="cls_007"> we see that Ruby has changed the value of </span><span class="cls_030">self</span><span class="cls_007"> again. The syntax</span></div>
<div style="position:absolute;left:120.00px;top:162.82px" class="cls_030"><span class="cls_030">#&lt;Class:Quote></span><span class="cls_007"> indicates that </span><span class="cls_030">self</span><span class="cls_007"> was set to </span><span class="cls_030">Quote</span><span class="cls_007">’s metaclass. At </span><span class="cls_050">v</span><span class="cls_007"> we see</span></div>
<div style="position:absolute;left:120.00px;top:174.82px" class="cls_007"><span class="cls_007">that Ruby has also added another level to the lexical scope stack. Figure 9-13</span></div>
<div style="position:absolute;left:120.00px;top:186.82px" class="cls_007"><span class="cls_007">shows the next level in the stack.</span></div>
<div style="position:absolute;left:208.92px;top:211.92px" class="cls_017"><span class="cls_017">Lexical</span></div>
<div style="position:absolute;left:372.72px;top:211.92px" class="cls_017"><span class="cls_017">Value of </span><span class="cls_033">self</span></div>
<div style="position:absolute;left:196.78px;top:222.72px" class="cls_017"><span class="cls_017">Scope Stack:</span></div>
<div style="position:absolute;left:368.29px;top:222.72px" class="cls_017"><span class="cls_017">for Each Scope:</span></div>
<div style="position:absolute;left:141.68px;top:267.92px" class="cls_014"><span class="cls_014">nd_next</span></div>
<div style="position:absolute;left:141.68px;top:288.07px" class="cls_014"><span class="cls_014">nd_clss</span></div>
<div style="position:absolute;left:369.42px;top:287.07px" class="cls_042"><span class="cls_042">RClass: Quote</span></div>
<div style="position:absolute;left:141.68px;top:346.87px" class="cls_014"><span class="cls_014">nd_next</span></div>
<div style="position:absolute;left:380.67px;top:361.54px" class="cls_042"><span class="cls_042">RClass:</span></div>
<div style="position:absolute;left:141.68px;top:367.01px" class="cls_014"><span class="cls_014">nd_clss</span></div>
<div style="position:absolute;left:367.17px;top:370.99px" class="cls_042"><span class="cls_042">#&lt;Class:Quote></span></div>
<div style="position:absolute;left:120.00px;top:407.09px" class="cls_038"><span class="cls_038">Figure 9-13: A new lexical scope is created for the metaclass.</span></div>
<div style="position:absolute;left:138.00px;top:429.59px" class="cls_007"><span class="cls_007">On the left, we can see that Ruby created a new scope when it executed</span></div>
<div style="position:absolute;left:120.00px;top:441.59px" class="cls_030"><span class="cls_030">class &lt;&lt; self</span><span class="cls_007">. The right side of the figure shows the value of </span><span class="cls_030">self</span><span class="cls_007"> in the new</span></div>
<div style="position:absolute;left:120.00px;top:453.59px" class="cls_007"><span class="cls_007">scope, the metaclass for </span><span class="cls_030">Quote</span><span class="cls_007">.</span></div>
<div style="position:absolute;left:120.00px;top:478.59px" class="cls_055"><span class="cls_055">self Inside a Class Method</span></div>
<div style="position:absolute;left:120.00px;top:496.59px" class="cls_007"><span class="cls_007">Now for one more test. Suppose we add a class method to the </span><span class="cls_030">Quote</span><span class="cls_007"> class</span></div>
<div style="position:absolute;left:120.00px;top:508.59px" class="cls_007"><span class="cls_007">and then call it as shown in Listing 9-11. (The output is at the bottom</span></div>
<div style="position:absolute;left:120.00px;top:520.59px" class="cls_007"><span class="cls_007">because the </span><span class="cls_030">p</span><span class="cls_007"> statements aren’t called until we call </span><span class="cls_030">class_method</span><span class="cls_007">.)</span></div>
<div style="position:absolute;left:120.00px;top:544.59px" class="cls_030"><span class="cls_030">p self</span></div>
<div style="position:absolute;left:120.00px;top:555.09px" class="cls_030"><span class="cls_030">p Module.nesting</span></div>
<div style="position:absolute;left:120.00px;top:576.09px" class="cls_030"><span class="cls_030">class Quote</span></div>
<div style="position:absolute;left:128.50px;top:586.59px" class="cls_030"><span class="cls_030">p self</span></div>
<div style="position:absolute;left:128.50px;top:597.09px" class="cls_030"><span class="cls_030">p Module.nesting</span></div>
<div style="position:absolute;left:48.00px;top:633.00px" class="cls_020"><span class="cls_020">234</span></div>
<div style="position:absolute;left:74.65px;top:636.00px" class="cls_021"><span class="cls_021">Chapter 9</span></div>
</div>
<div style="position:absolute;left:50%;margin-left:-252px;top:172380px;width:504px;height:666px;border-style:outset;overflow:hidden">
<div style="position:absolute;left:0px;top:0px">
<img src="e698b76e-46bd-11eb-8b25-0cc47a792c0a_id_e698b76e-46bd-11eb-8b25-0cc47a792c0a_files/background259.jpg" width=504 height=666></div>
<div style="position:absolute;left:131.50px;top:42.24px" class="cls_030"><span class="cls_030">class &lt;&lt; self</span></div>
<div style="position:absolute;left:140.00px;top:52.74px" class="cls_030"><span class="cls_030">p self</span></div>
<div style="position:absolute;left:140.00px;top:63.23px" class="cls_030"><span class="cls_030">p Module.nesting</span></div>
<div style="position:absolute;left:140.00px;top:84.24px" class="cls_030"><span class="cls_030">def class_method</span></div>
<div style="position:absolute;left:148.50px;top:94.73px" class="cls_030"><span class="cls_030">p self</span></div>
<div style="position:absolute;left:148.50px;top:105.23px" class="cls_030"><span class="cls_030">p Module.nesting</span></div>
<div style="position:absolute;left:140.00px;top:115.73px" class="cls_030"><span class="cls_030">end</span></div>
<div style="position:absolute;left:131.50px;top:126.23px" class="cls_030"><span class="cls_030">end</span></div>
<div style="position:absolute;left:123.00px;top:136.72px" class="cls_030"><span class="cls_030">end</span></div>
<div style="position:absolute;left:123.00px;top:157.73px" class="cls_030"><span class="cls_030">Quote.class_method</span></div>
<div style="position:absolute;left:111.15px;top:168.22px" class="cls_046"><span class="cls_046">u</span><span class="cls_030">  => Quote</span></div>
<div style="position:absolute;left:111.15px;top:178.72px" class="cls_046"><span class="cls_046">v</span><span class="cls_030">  => [#&lt;Class:Quote>, Quote]</span></div>
<div style="position:absolute;left:123.00px;top:201.22px" class="cls_038"><span class="cls_038">Listing 9-11: Declaring and calling a class method</span></div>
<div style="position:absolute;left:141.00px;top:223.74px" class="cls_007"><span class="cls_007">At </span><span class="cls_050">u</span><span class="cls_007"> we see that Ruby sets </span><span class="cls_030">self</span><span class="cls_007"> back to the </span><span class="cls_030">Quote</span><span class="cls_007"> class when we call</span></div>
<div style="position:absolute;left:123.00px;top:235.74px" class="cls_030"><span class="cls_030">class_method</span><span class="cls_007">. This makes sense: When we call a method on a receiver, Ruby</span></div>
<div style="position:absolute;left:123.00px;top:247.74px" class="cls_007"><span class="cls_007">always sets </span><span class="cls_030">self</span><span class="cls_007"> to be the receiver. Because we call a class method in this</span></div>
<div style="position:absolute;left:123.00px;top:259.74px" class="cls_007"><span class="cls_007">case, Ruby sets the receiver to that class.</span></div>
<div style="position:absolute;left:141.00px;top:271.74px" class="cls_007"><span class="cls_007">At </span><span class="cls_050">v</span><span class="cls_007"> we see that Ruby hasn’t changed the lexical scope stack. It’s still</span></div>
<div style="position:absolute;left:123.00px;top:283.74px" class="cls_007"><span class="cls_007">set to </span><span class="cls_030">[#&lt;Class:Quote>, Quote]</span><span class="cls_007">, as shown in Figure 9-14.</span></div>
<div style="position:absolute;left:211.92px;top:313.84px" class="cls_017"><span class="cls_017">Lexical</span></div>
<div style="position:absolute;left:375.72px;top:313.84px" class="cls_017"><span class="cls_017">Value of </span><span class="cls_033">self</span></div>
<div style="position:absolute;left:199.78px;top:324.64px" class="cls_017"><span class="cls_017">Scope Stack:</span></div>
<div style="position:absolute;left:371.29px;top:324.64px" class="cls_017"><span class="cls_017">for Each Scope:</span></div>
<div style="position:absolute;left:144.68px;top:369.85px" class="cls_014"><span class="cls_014">nd_next</span></div>
<div style="position:absolute;left:144.68px;top:389.99px" class="cls_014"><span class="cls_014">nd_clss</span></div>
<div style="position:absolute;left:372.42px;top:388.99px" class="cls_042"><span class="cls_042">RClass: Quote</span></div>
<div style="position:absolute;left:144.68px;top:448.79px" class="cls_014"><span class="cls_014">nd_next</span></div>
<div style="position:absolute;left:245.88px;top:463.49px" class="cls_042"><span class="cls_042">RClass:</span></div>
<div style="position:absolute;left:144.68px;top:468.94px" class="cls_014"><span class="cls_014">nd_clss</span></div>
<div style="position:absolute;left:372.42px;top:467.65px" class="cls_042"><span class="cls_042">RClass: Quote</span></div>
<div style="position:absolute;left:232.38px;top:472.94px" class="cls_042"><span class="cls_042">#&lt;Class:Quote></span></div>
<div style="position:absolute;left:123.00px;top:519.01px" class="cls_038"><span class="cls_038">Figure 9-14: When you call a method, Ruby changes </span><span class="cls_014">self</span><span class="cls_038"> but doesn’t create a new scope.</span></div>
<div style="position:absolute;left:141.00px;top:541.51px" class="cls_007"><span class="cls_007">Notice that the lexical scope hasn’t changed but </span><span class="cls_030">self</span><span class="cls_007"> has been changed</span></div>
<div style="position:absolute;left:123.00px;top:553.51px" class="cls_007"><span class="cls_007">to </span><span class="cls_030">Quote</span><span class="cls_007">, the receiver of the method call.</span></div>
<div style="position:absolute;left:380.48px;top:636.00px" class="cls_021"><span class="cls_021">Metaprogramming</span></div>
<div style="position:absolute;left:442.53px;top:633.00px" class="cls_020"><span class="cls_020">235</span></div>
</div>
<div style="position:absolute;left:50%;margin-left:-252px;top:173056px;width:504px;height:666px;border-style:outset;overflow:hidden">
<div style="position:absolute;left:0px;top:0px">
<img src="e698b76e-46bd-11eb-8b25-0cc47a792c0a_id_e698b76e-46bd-11eb-8b25-0cc47a792c0a_files/background260.jpg" width=504 height=666></div>
<div style="position:absolute;left:138.00px;top:42.28px" class="cls_007"><span class="cls_007">You can use these general rules to keep track of </span><span class="cls_030">self</span><span class="cls_007"> and lexical scope:</span></div>
<div style="position:absolute;left:120.00px;top:63.28px" class="cls_050"><span class="cls_050">•</span><span class="cls_007">   Inside a class or module scope, </span><span class="cls_030">self</span><span class="cls_007"> will always be set to that class or mod-</span></div>
<div style="position:absolute;left:138.00px;top:75.28px" class="cls_007"><span class="cls_007">ule. Ruby creates a new lexical scope when you use the </span><span class="cls_030">class</span><span class="cls_007"> or </span><span class="cls_030">module</span><span class="cls_007"> key-</span></div>
<div style="position:absolute;left:138.01px;top:87.28px" class="cls_007"><span class="cls_007">words and sets the class for that scope to the new class or module.</span></div>
<div style="position:absolute;left:120.01px;top:102.28px" class="cls_050"><span class="cls_050">•</span><span class="cls_007">   Inside a method (including a class method), Ruby will set </span><span class="cls_030">self</span><span class="cls_007"> to the</span></div>
<div style="position:absolute;left:138.00px;top:114.28px" class="cls_007"><span class="cls_007">receiver of that method call.</span></div>
<div style="position:absolute;left:66.00px;top:148.28px" class="cls_031"><span class="cls_031">Metaprogramming and Closures: eval, instance_eval,</span></div>
<div style="position:absolute;left:66.00px;top:163.28px" class="cls_031"><span class="cls_031">and binding</span></div>
<div style="position:absolute;left:120.00px;top:183.28px" class="cls_007"><span class="cls_007">In Chapter 8 we learned that blocks are Ruby’s implementation of closures,</span></div>
<div style="position:absolute;left:120.00px;top:195.28px" class="cls_007"><span class="cls_007">and we saw how blocks bring together a function with the environment</span></div>
<div style="position:absolute;left:120.00px;top:207.28px" class="cls_007"><span class="cls_007">where that function was referenced. In Ruby, metaprogramming and closures</span></div>
<div style="position:absolute;left:120.00px;top:219.28px" class="cls_007"><span class="cls_007">are closely related. Many of Ruby’s metaprogramming constructs also act</span></div>
<div style="position:absolute;left:120.00px;top:231.28px" class="cls_007"><span class="cls_007">as closures, giving the code inside them access to the referencing environ-</span></div>
<div style="position:absolute;left:120.00px;top:243.28px" class="cls_007"><span class="cls_007">ment. We’ll learn about three important metaprogramming features and</span></div>
<div style="position:absolute;left:120.00px;top:255.28px" class="cls_007"><span class="cls_007">how each gives you access to the referencing environment by acting as a</span></div>
<div style="position:absolute;left:120.00px;top:267.28px" class="cls_007"><span class="cls_007">closure in just the way blocks do.</span></div>
<div style="position:absolute;left:120.00px;top:292.28px" class="cls_055"><span class="cls_055">Code That Writes Code</span></div>
<div style="position:absolute;left:120.00px;top:310.28px" class="cls_007"><span class="cls_007">In Ruby, the </span><span class="cls_030">eval</span><span class="cls_007"> method is metaprogramming in its purest form: You pass</span></div>
<div style="position:absolute;left:120.00px;top:322.28px" class="cls_007"><span class="cls_007">a string to </span><span class="cls_030">eval</span><span class="cls_007">, and Ruby immediately parses, compiles, and executes the</span></div>
<div style="position:absolute;left:120.00px;top:334.28px" class="cls_007"><span class="cls_007">code, as shown in Listing 9-12.</span></div>
<div style="position:absolute;left:120.00px;top:358.28px" class="cls_030"><span class="cls_030">str = "puts"</span></div>
<div style="position:absolute;left:120.00px;top:368.78px" class="cls_030"><span class="cls_030">str += " 2"</span></div>
<div style="position:absolute;left:120.00px;top:379.27px" class="cls_030"><span class="cls_030">str += " +"</span></div>
<div style="position:absolute;left:120.00px;top:389.77px" class="cls_030"><span class="cls_030">str += " 2"</span></div>
<div style="position:absolute;left:120.00px;top:400.27px" class="cls_030"><span class="cls_030">eval(str)</span></div>
<div style="position:absolute;left:120.00px;top:422.77px" class="cls_038"><span class="cls_038">Listing 9-12: Parsing and compiling code using </span><span class="cls_014">eval</span></div>
<div style="position:absolute;left:138.00px;top:445.28px" class="cls_007"><span class="cls_007">We dynamically construct the string </span><span class="cls_030">puts 2+2</span><span class="cls_007"> and pass it to </span><span class="cls_030">eval</span><span class="cls_007">. Ruby</span></div>
<div style="position:absolute;left:120.00px;top:457.28px" class="cls_007"><span class="cls_007">then evaluates the string. That is, it tokenizes, parses, and compiles it using</span></div>
<div style="position:absolute;left:120.00px;top:469.28px" class="cls_007"><span class="cls_007">the same Bison grammar rules and parse engine that it did when it first</span></div>
<div style="position:absolute;left:120.00px;top:481.28px" class="cls_007"><span class="cls_007">processed the primary Ruby script. Once this process is finished and Ruby</span></div>
<div style="position:absolute;left:120.00px;top:493.28px" class="cls_007"><span class="cls_007">has another new set of YARV bytecode instructions, it executes the new code.</span></div>
<div style="position:absolute;left:138.00px;top:505.28px" class="cls_007"><span class="cls_007">But one very important detail about </span><span class="cls_030">eval</span><span class="cls_007"> isn’t obvious in Listing 9-12.</span></div>
<div style="position:absolute;left:120.00px;top:517.28px" class="cls_007"><span class="cls_007">Specifically, Ruby evaluates the new code string in the same context from</span></div>
<div style="position:absolute;left:120.00px;top:529.28px" class="cls_007"><span class="cls_007">where you called </span><span class="cls_030">eval</span><span class="cls_007">. To see what I mean, look at Listing 9-13.</span></div>
<div style="position:absolute;left:120.00px;top:553.28px" class="cls_030"><span class="cls_030">a = 2</span></div>
<div style="position:absolute;left:120.00px;top:563.78px" class="cls_030"><span class="cls_030">b = 3</span></div>
<div style="position:absolute;left:120.00px;top:574.28px" class="cls_030"><span class="cls_030">str = "puts"</span></div>
<div style="position:absolute;left:120.00px;top:584.77px" class="cls_030"><span class="cls_030">str += " a"</span></div>
<div style="position:absolute;left:120.00px;top:595.27px" class="cls_030"><span class="cls_030">str += " +"</span></div>
<div style="position:absolute;left:48.00px;top:633.00px" class="cls_020"><span class="cls_020">236</span></div>
<div style="position:absolute;left:74.61px;top:636.00px" class="cls_021"><span class="cls_021">Chapter 9</span></div>
</div>
<div style="position:absolute;left:50%;margin-left:-252px;top:173732px;width:504px;height:666px;border-style:outset;overflow:hidden">
<div style="position:absolute;left:0px;top:0px">
<img src="e698b76e-46bd-11eb-8b25-0cc47a792c0a_id_e698b76e-46bd-11eb-8b25-0cc47a792c0a_files/background261.jpg" width=504 height=666></div>
<div style="position:absolute;left:123.00px;top:42.24px" class="cls_030"><span class="cls_030">str += " b"</span></div>
<div style="position:absolute;left:111.15px;top:52.74px" class="cls_046"><span class="cls_046">u</span><span class="cls_030"> eval(str)</span></div>
<div style="position:absolute;left:123.00px;top:75.23px" class="cls_038"><span class="cls_038">Listing 9-13: It isn’t obvious here, but </span><span class="cls_014">eval</span><span class="cls_038"> accesses the surrounding scope via a closure, too.</span></div>
<div style="position:absolute;left:141.00px;top:97.74px" class="cls_007"><span class="cls_007">You would expect the result from running this code to be 5, but notice</span></div>
<div style="position:absolute;left:123.00px;top:109.74px" class="cls_007"><span class="cls_007">the difference between Listings 9-12 and 9-13. Listing 9-13 refers to the</span></div>
<div style="position:absolute;left:123.00px;top:121.74px" class="cls_007"><span class="cls_007">local variables </span><span class="cls_030">a</span><span class="cls_007"> and </span><span class="cls_030">b</span><span class="cls_007"> from the surrounding scope, and Ruby can access</span></div>
<div style="position:absolute;left:123.00px;top:133.74px" class="cls_007"><span class="cls_007">their values. Figure 9-15 shows how YARV’s internal stack looks just before</span></div>
<div style="position:absolute;left:123.00px;top:145.74px" class="cls_007"><span class="cls_007">calling </span><span class="cls_030">eval</span><span class="cls_007"> at </span><span class="cls_050">u</span><span class="cls_007">.</span></div>
<div style="position:absolute;left:127.21px;top:173.83px" class="cls_113"><span class="cls_113">YARV internal stack</span></div>
<div style="position:absolute;left:327.56px;top:206.40px" class="cls_112"><span class="cls_112">rb_control_frame_t</span></div>
<div style="position:absolute;left:170.27px;top:210.70px" class="cls_114"><span class="cls_114">locals:</span></div>
<div style="position:absolute;left:170.27px;top:218.12px" class="cls_114"><span class="cls_114">a, b, str</span></div>
<div style="position:absolute;left:123.00px;top:261.81px" class="cls_038"><span class="cls_038">Figure 9-15: Ruby saves the local variables </span><span class="cls_014">a</span><span class="cls_038">, </span><span class="cls_014">b</span><span class="cls_038">, and </span><span class="cls_014">str</span><span class="cls_038"> on YARV’s internal stack as usual.</span></div>
<div style="position:absolute;left:141.00px;top:284.31px" class="cls_007"><span class="cls_007">As expected, we see that Ruby has saved the values of </span><span class="cls_030">a</span><span class="cls_007">, </span><span class="cls_030">b</span><span class="cls_007">, and </span><span class="cls_030">str</span><span class="cls_007"> on</span></div>
<div style="position:absolute;left:123.00px;top:296.31px" class="cls_007"><span class="cls_007">the stack to the left. On the right, we have the </span><span class="cls_030">rb_control_frame_t</span><span class="cls_007"> structure,</span></div>
<div style="position:absolute;left:123.00px;top:308.31px" class="cls_007"><span class="cls_007">which represents the outer, or main, scope of this script.</span></div>
<div style="position:absolute;left:141.00px;top:320.31px" class="cls_007"><span class="cls_007">Figure 9-16 shows what happens when we call the </span><span class="cls_030">eval</span><span class="cls_007"> method.</span></div>
<div style="position:absolute;left:302.54px;top:341.62px" class="cls_113"><span class="cls_113">Stack frame for</span></div>
<div style="position:absolute;left:313.03px;top:352.01px" class="cls_113"><span class="cls_113">eval code</span></div>
<div style="position:absolute;left:285.71px;top:379.29px" class="cls_112"><span class="cls_112">rb_control_frame_t</span></div>
<div style="position:absolute;left:127.21px;top:388.15px" class="cls_113"><span class="cls_113">YARV internal stack</span></div>
<div style="position:absolute;left:186.91px;top:446.72px" class="cls_114"><span class="cls_114">EP</span></div>
<div style="position:absolute;left:300.92px;top:462.99px" class="cls_112"><span class="cls_112">Tokenize</span><span class="cls_113">, </span><span class="cls_112">Parse</span><span class="cls_113">,</span></div>
<div style="position:absolute;left:318.40px;top:474.87px" class="cls_112"><span class="cls_112">Compile</span></div>
<div style="position:absolute;left:172.35px;top:495.90px" class="cls_114"><span class="cls_114">locals:</span></div>
<div style="position:absolute;left:172.35px;top:503.32px" class="cls_114"><span class="cls_114">a, b, str</span></div>
<div style="position:absolute;left:285.71px;top:544.32px" class="cls_112"><span class="cls_112">rb_control_frame_t</span></div>
<div style="position:absolute;left:302.55px;top:581.20px" class="cls_113"><span class="cls_113">Stack frame for</span></div>
<div style="position:absolute;left:300.59px;top:591.60px" class="cls_113"><span class="cls_113">original function</span></div>
<div style="position:absolute;left:123.00px;top:611.11px" class="cls_038"><span class="cls_038">Figure 9-16: Calling </span><span class="cls_014">eval</span><span class="cls_038"> and accessing values from the parent scope</span></div>
<div style="position:absolute;left:380.56px;top:636.00px" class="cls_021"><span class="cls_021">Metaprogramming</span></div>
<div style="position:absolute;left:442.60px;top:633.00px" class="cls_020"><span class="cls_020">237</span></div>
</div>
<div style="position:absolute;left:50%;margin-left:-252px;top:174408px;width:504px;height:666px;border-style:outset;overflow:hidden">
<div style="position:absolute;left:0px;top:0px">
<img src="e698b76e-46bd-11eb-8b25-0cc47a792c0a_id_e698b76e-46bd-11eb-8b25-0cc47a792c0a_files/background262.jpg" width=504 height=666></div>
<div style="position:absolute;left:138.00px;top:42.28px" class="cls_007"><span class="cls_007">Calling </span><span class="cls_030">eval</span><span class="cls_007"> invokes the parser and compiler on the text we pass it. When</span></div>
<div style="position:absolute;left:120.00px;top:54.28px" class="cls_007"><span class="cls_007">the compiler finishes, Ruby creates a new stack frame (</span><span class="cls_030">rb_control_frame_t</span><span class="cls_007">) for</span></div>
<div style="position:absolute;left:120.00px;top:66.28px" class="cls_007"><span class="cls_007">use in running the new compiled code (as shown at the top). Notice, how-</span></div>
<div style="position:absolute;left:120.00px;top:78.28px" class="cls_007"><span class="cls_007">ever, that Ruby sets the </span><span class="cls_030">EP</span><span class="cls_007"> in this new stack frame to point to the lower stack</span></div>
<div style="position:absolute;left:120.00px;top:90.28px" class="cls_007"><span class="cls_007">frame where the variables </span><span class="cls_030">a</span><span class="cls_007"> and </span><span class="cls_030">b</span><span class="cls_007"> are. This pointer allows the code passed to</span></div>
<div style="position:absolute;left:120.00px;top:102.28px" class="cls_030"><span class="cls_030">eval</span><span class="cls_007"> to access these values.</span></div>
<div style="position:absolute;left:138.00px;top:114.28px" class="cls_007"><span class="cls_007">Ruby’s use of </span><span class="cls_030">EP</span><span class="cls_007"> here should look familiar. Aside from parsing and com-</span></div>
<div style="position:absolute;left:120.00px;top:126.28px" class="cls_007"><span class="cls_007">piling the code dynamically, </span><span class="cls_030">eval</span><span class="cls_007"> works the same way as if we had passed a</span></div>
<div style="position:absolute;left:120.00px;top:138.28px" class="cls_007"><span class="cls_007">block to some function, as in Listing 9-14.</span></div>
<div style="position:absolute;left:120.00px;top:162.28px" class="cls_030"><span class="cls_030">a = 2</span></div>
<div style="position:absolute;left:120.00px;top:172.78px" class="cls_030"><span class="cls_030">b = 3</span></div>
<div style="position:absolute;left:120.00px;top:183.27px" class="cls_030"><span class="cls_030">10.times do</span></div>
<div style="position:absolute;left:128.50px;top:193.77px" class="cls_030"><span class="cls_030">puts a+b</span></div>
<div style="position:absolute;left:120.00px;top:204.27px" class="cls_030"><span class="cls_030">end</span></div>
<div style="position:absolute;left:120.00px;top:226.77px" class="cls_038"><span class="cls_038">Listing 9-14: Code inside a block can access variables from the surrounding scope.</span></div>
<div style="position:absolute;left:138.00px;top:249.28px" class="cls_007"><span class="cls_007">In other words, the </span><span class="cls_030">eval</span><span class="cls_007"> method creates a closure: the combination of</span></div>
<div style="position:absolute;left:120.00px;top:261.28px" class="cls_007"><span class="cls_007">a function and the environment where that function was referenced. In</span></div>
<div style="position:absolute;left:120.00px;top:273.28px" class="cls_007"><span class="cls_007">this case, the function is the newly compiled code, and the environment is</span></div>
<div style="position:absolute;left:120.00px;top:285.28px" class="cls_007"><span class="cls_007">where we call </span><span class="cls_030">eval</span><span class="cls_007"> from.</span></div>
<div style="position:absolute;left:120.00px;top:310.28px" class="cls_055"><span class="cls_055">Calling eval with binding</span></div>
<div style="position:absolute;left:120.00px;top:328.28px" class="cls_007"><span class="cls_007">The </span><span class="cls_030">eval</span><span class="cls_007"> method can take a second parameter: a </span><span class="cls_008">binding</span><span class="cls_007">. A binding is a</span></div>
<div style="position:absolute;left:120.00px;top:340.28px" class="cls_007"><span class="cls_007">closure without a function—that is, it’s just the referencing environment.</span></div>
<div style="position:absolute;left:120.00px;top:352.28px" class="cls_007"><span class="cls_007">Think of bindings as a pointer to a YARV stack frame. Passing a binding</span></div>
<div style="position:absolute;left:120.00px;top:364.28px" class="cls_007"><span class="cls_007">value to Ruby indicates that you don’t want to use the current context as the</span></div>
<div style="position:absolute;left:120.00px;top:376.28px" class="cls_007"><span class="cls_007">closure’s environment but instead want to use some other referencing envi-</span></div>
<div style="position:absolute;left:120.00px;top:388.28px" class="cls_007"><span class="cls_007">ronment. Listing 9-15 shows an example.</span></div>
<div style="position:absolute;left:120.00px;top:412.28px" class="cls_030"><span class="cls_030">def get_binding</span></div>
<div style="position:absolute;left:128.50px;top:422.78px" class="cls_030"><span class="cls_030">a = 2</span></div>
<div style="position:absolute;left:128.50px;top:433.27px" class="cls_030"><span class="cls_030">b = 3</span></div>
<div style="position:absolute;left:108.15px;top:443.77px" class="cls_046"><span class="cls_046">u</span><span class="cls_030">   binding</span></div>
<div style="position:absolute;left:120.00px;top:454.27px" class="cls_030"><span class="cls_030">end</span></div>
<div style="position:absolute;left:108.15px;top:464.77px" class="cls_046"><span class="cls_046">v</span><span class="cls_030"> eval("puts a+b", get_binding)</span></div>
<div style="position:absolute;left:120.00px;top:487.27px" class="cls_038"><span class="cls_038">Listing 9-15: Using </span><span class="cls_014">binding</span><span class="cls_038"> to access variables from some other environment</span></div>
<div style="position:absolute;left:138.00px;top:509.78px" class="cls_007"><span class="cls_007">The function </span><span class="cls_030">get_binding</span><span class="cls_007"> contains the local variables </span><span class="cls_030">a</span><span class="cls_007"> and </span><span class="cls_030">b</span><span class="cls_007">, but it also</span></div>
<div style="position:absolute;left:120.00px;top:521.78px" class="cls_007"><span class="cls_007">returns a binding at </span><span class="cls_050">u</span><span class="cls_007">. At the bottom of the listing, we again want Ruby to</span></div>
<div style="position:absolute;left:120.00px;top:533.78px" class="cls_007"><span class="cls_007">dynamically compile and execute the code string and print out the result.</span></div>
<div style="position:absolute;left:120.00px;top:545.78px" class="cls_007"><span class="cls_007">By passing the binding returned by </span><span class="cls_030">get_binding</span><span class="cls_007"> to </span><span class="cls_030">eval</span><span class="cls_007">, we tell Ruby to evalu-</span></div>
<div style="position:absolute;left:120.00px;top:557.78px" class="cls_007"><span class="cls_007">ate </span><span class="cls_030">puts a+b</span><span class="cls_007"> in the context of the </span><span class="cls_030">get_binding</span><span class="cls_007"> function. If we had called </span><span class="cls_030">eval</span></div>
<div style="position:absolute;left:120.00px;top:569.78px" class="cls_007"><span class="cls_007">without the binding, it would have created new, empty local variables </span><span class="cls_030">a</span><span class="cls_007"> and </span><span class="cls_030">b</span><span class="cls_007">.</span></div>
<div style="position:absolute;left:138.00px;top:581.78px" class="cls_007"><span class="cls_007">Ruby makes a persistent copy of this environment in the heap because</span></div>
<div style="position:absolute;left:120.00px;top:593.78px" class="cls_007"><span class="cls_007">you might call </span><span class="cls_030">eval</span><span class="cls_007"> long after the current frame has been popped off the</span></div>
<div style="position:absolute;left:48.00px;top:633.00px" class="cls_020"><span class="cls_020">238</span></div>
<div style="position:absolute;left:74.64px;top:636.00px" class="cls_021"><span class="cls_021">Chapter 9</span></div>
</div>
<div style="position:absolute;left:50%;margin-left:-252px;top:175084px;width:504px;height:666px;border-style:outset;overflow:hidden">
<div style="position:absolute;left:0px;top:0px">
<img src="e698b76e-46bd-11eb-8b25-0cc47a792c0a_id_e698b76e-46bd-11eb-8b25-0cc47a792c0a_files/background263.jpg" width=504 height=666></div>
<div style="position:absolute;left:123.00px;top:41.60px" class="cls_007"><span class="cls_007">stack. Even though </span><span class="cls_030">get_binding</span><span class="cls_007"> has already returned in this example, Ruby</span></div>
<div style="position:absolute;left:123.00px;top:53.60px" class="cls_007"><span class="cls_007">can still access the values of </span><span class="cls_030">a</span><span class="cls_007"> and </span><span class="cls_030">b</span><span class="cls_007"> when it executes the code parsed and</span></div>
<div style="position:absolute;left:123.00px;top:65.60px" class="cls_007"><span class="cls_007">compiled by </span><span class="cls_030">eval</span><span class="cls_007"> at </span><span class="cls_050">v</span><span class="cls_007">.</span></div>
<div style="position:absolute;left:141.01px;top:77.60px" class="cls_007"><span class="cls_007">Figure 9-17 shows what happens internally when we call </span><span class="cls_030">binding</span><span class="cls_007">.</span></div>
<div style="position:absolute;left:373.60px;top:98.54px" class="cls_033"><span class="cls_033">get_binding</span></div>
<div style="position:absolute;left:196.30px;top:106.08px" class="cls_017"><span class="cls_017">YARV internal stack</span></div>
<div style="position:absolute;left:376.11px;top:110.23px" class="cls_017"><span class="cls_017">stack frame</span></div>
<div style="position:absolute;left:353.66px;top:131.61px" class="cls_042"><span class="cls_042">rb_control_frame_t</span></div>
<div style="position:absolute;left:246.65px;top:142.32px" class="cls_014"><span class="cls_014">a, b</span></div>
<div style="position:absolute;left:124.97px;top:234.53px" class="cls_017"><span class="cls_017">Stack</span></div>
<div style="position:absolute;left:126.42px;top:275.36px" class="cls_017"><span class="cls_017">Heap</span></div>
<div style="position:absolute;left:287.90px;top:295.91px" class="cls_014"><span class="cls_014">a, b</span></div>
<div style="position:absolute;left:357.63px;top:293.17px" class="cls_042"><span class="cls_042">rb_binding_t</span></div>
<div style="position:absolute;left:386.32px;top:314.33px" class="cls_014"><span class="cls_014">filename</span></div>
<div style="position:absolute;left:388.32px;top:343.01px" class="cls_014"><span class="cls_014">line_no</span></div>
<div style="position:absolute;left:219.05px;top:355.14px" class="cls_042"><span class="cls_042">rb_env_t</span></div>
<div style="position:absolute;left:251.99px;top:371.03px" class="cls_014"><span class="cls_014">env</span></div>
<div style="position:absolute;left:396.32px;top:369.10px" class="cls_014"><span class="cls_014">env</span></div>
<div style="position:absolute;left:123.00px;top:406.79px" class="cls_038"><span class="cls_038">Figure 9-17: Calling </span><span class="cls_014">binding</span><span class="cls_038"> saves a copy of the current stack frame in the heap.</span></div>
<div style="position:absolute;left:141.00px;top:429.29px" class="cls_007"><span class="cls_007">This figure resembles what Ruby does when you call </span><span class="cls_030">lambda</span><span class="cls_007"> (see Figure 8-18</span></div>
<div style="position:absolute;left:123.00px;top:441.29px" class="cls_007"><span class="cls_007">on page 210), except that Ruby creates an </span><span class="cls_030">rb_binding_t</span><span class="cls_007"> C structure instead</span></div>
<div style="position:absolute;left:123.00px;top:453.29px" class="cls_007"><span class="cls_007">of an </span><span class="cls_030">rb_proc_t</span><span class="cls_007"> structure. The binding structure is simply a wrapper around</span></div>
<div style="position:absolute;left:123.00px;top:465.29px" class="cls_007"><span class="cls_007">the internal environment structure—the heap copy of the stack frame. The</span></div>
<div style="position:absolute;left:123.00px;top:477.29px" class="cls_007"><span class="cls_007">binding structure also contains the file name and line number of the loca-</span></div>
<div style="position:absolute;left:123.00px;top:489.29px" class="cls_007"><span class="cls_007">tion from where you called </span><span class="cls_030">binding</span><span class="cls_007">.</span></div>
<div style="position:absolute;left:141.00px;top:501.29px" class="cls_007"><span class="cls_007">As with the proc object, Ruby uses the </span><span class="cls_030">RTypedData</span><span class="cls_007"> structure to wrap a</span></div>
<div style="position:absolute;left:123.00px;top:513.29px" class="cls_007"><span class="cls_007">Ruby object around the </span><span class="cls_030">rb_binding_t</span><span class="cls_007"> C structure (see Figure 9-18).</span></div>
<div style="position:absolute;left:141.00px;top:525.29px" class="cls_007"><span class="cls_007">The binding object allows you to create a closure and then obtain and</span></div>
<div style="position:absolute;left:123.00px;top:537.29px" class="cls_007"><span class="cls_007">treat its environment as a data value. However, the closure created by the</span></div>
<div style="position:absolute;left:123.00px;top:549.29px" class="cls_007"><span class="cls_007">binding doesn’t contain any code; it has no function. You might think of</span></div>
<div style="position:absolute;left:123.00px;top:561.29px" class="cls_007"><span class="cls_007">the binding object as an indirect way to access, save, and pass around Ruby’s</span></div>
<div style="position:absolute;left:123.00px;top:573.29px" class="cls_007"><span class="cls_007">internal </span><span class="cls_030">rb_env_t</span><span class="cls_007"> structure.</span></div>
<div style="position:absolute;left:380.42px;top:636.00px" class="cls_021"><span class="cls_021">Metaprogramming</span></div>
<div style="position:absolute;left:442.47px;top:633.00px" class="cls_020"><span class="cls_020">239</span></div>
</div>
<div style="position:absolute;left:50%;margin-left:-252px;top:175760px;width:504px;height:666px;border-style:outset;overflow:hidden">
<div style="position:absolute;left:0px;top:0px">
<img src="e698b76e-46bd-11eb-8b25-0cc47a792c0a_id_e698b76e-46bd-11eb-8b25-0cc47a792c0a_files/background264.jpg" width=504 height=666></div>
<div style="position:absolute;left:152.83px;top:46.50px" class="cls_017"><span class="cls_017">VALUE</span></div>
<div style="position:absolute;left:131.78px;top:89.56px" class="cls_042"><span class="cls_042">RTypedData</span></div>
<div style="position:absolute;left:138.96px;top:107.64px" class="cls_042"><span class="cls_042">RBasic</span></div>
<div style="position:absolute;left:155.96px;top:122.70px" class="cls_014"><span class="cls_014">flags</span></div>
<div style="position:absolute;left:252.11px;top:135.88px" class="cls_042"><span class="cls_042">RClass</span></div>
<div style="position:absolute;left:155.96px;top:143.85px" class="cls_014"><span class="cls_014">klass</span></div>
<div style="position:absolute;left:252.45px;top:147.70px" class="cls_014"><span class="cls_014">[Binding class]</span></div>
<div style="position:absolute;left:157.96px;top:171.20px" class="cls_014"><span class="cls_014">data</span></div>
<div style="position:absolute;left:126.46px;top:231.69px" class="cls_042"><span class="cls_042">rb_binding_t</span></div>
<div style="position:absolute;left:149.96px;top:249.94px" class="cls_014"><span class="cls_014">filename</span></div>
<div style="position:absolute;left:151.96px;top:275.80px" class="cls_014"><span class="cls_014">line_no</span></div>
<div style="position:absolute;left:159.96px;top:299.33px" class="cls_014"><span class="cls_014">env</span></div>
<div style="position:absolute;left:120.00px;top:327.21px" class="cls_038"><span class="cls_038">Figure 9-18: Ruby uses </span><span class="cls_014">RTypedData</span><span class="cls_038"> to wrap a Ruby object</span></div>
<div style="position:absolute;left:120.00px;top:337.71px" class="cls_038"><span class="cls_038">around the </span><span class="cls_014">rb_binding_t</span><span class="cls_038"> structure.</span></div>
<div style="position:absolute;left:120.00px;top:373.21px" class="cls_055"><span class="cls_055">An instance_eval Example</span></div>
<div style="position:absolute;left:120.00px;top:391.21px" class="cls_007"><span class="cls_007">Now for a variation on the </span><span class="cls_030">eval</span><span class="cls_007"> method: </span><span class="cls_030">instance_eval</span><span class="cls_007"> is shown in action in</span></div>
<div style="position:absolute;left:120.00px;top:403.21px" class="cls_007"><span class="cls_007">Listing 9-16.</span></div>
<div style="position:absolute;left:108.15px;top:427.21px" class="cls_046"><span class="cls_046">u</span><span class="cls_030"> class Quote</span></div>
<div style="position:absolute;left:128.50px;top:437.71px" class="cls_030"><span class="cls_030">def initialize</span></div>
<div style="position:absolute;left:108.15px;top:448.20px" class="cls_046"><span class="cls_046">v</span></div>
<div style="position:absolute;left:136.98px;top:448.20px" class="cls_030"><span class="cls_030">@str = "The quick brown fox"</span></div>
<div style="position:absolute;left:128.50px;top:458.70px" class="cls_030"><span class="cls_030">end</span></div>
<div style="position:absolute;left:120.00px;top:469.20px" class="cls_030"><span class="cls_030">end</span></div>
<div style="position:absolute;left:120.00px;top:479.70px" class="cls_030"><span class="cls_030">str2 = "jumps over the lazy dog."</span></div>
<div style="position:absolute;left:108.15px;top:490.19px" class="cls_046"><span class="cls_046">w</span><span class="cls_030"> obj = Quote.new</span></div>
<div style="position:absolute;left:108.15px;top:500.69px" class="cls_046"><span class="cls_046">x</span><span class="cls_030"> obj.instance_eval do</span></div>
<div style="position:absolute;left:108.15px;top:511.19px" class="cls_046"><span class="cls_046">y</span><span class="cls_030">   puts "#{@str} #{str2}"</span></div>
<div style="position:absolute;left:120.00px;top:521.69px" class="cls_030"><span class="cls_030">end</span></div>
<div style="position:absolute;left:120.00px;top:544.19px" class="cls_038"><span class="cls_038">Listing 9-16: The code inside </span><span class="cls_014">instance_eval</span><span class="cls_038"> has access to </span><span class="cls_014">obj</span><span class="cls_038">’s instance variable.</span></div>
<div style="position:absolute;left:138.00px;top:566.71px" class="cls_007"><span class="cls_007">Here’s what’s going on:</span></div>
<div style="position:absolute;left:120.00px;top:587.71px" class="cls_050"><span class="cls_050">•</span><span class="cls_007">   At </span><span class="cls_050">u</span><span class="cls_007"> we create a Ruby class called </span><span class="cls_030">Quote</span><span class="cls_007"> that saves the first half of the</span></div>
<div style="position:absolute;left:138.00px;top:599.71px" class="cls_007"><span class="cls_007">string in an instance variable in </span><span class="cls_030">initialize</span><span class="cls_007"> at </span><span class="cls_050">v</span><span class="cls_007">.</span></div>
<div style="position:absolute;left:48.00px;top:633.00px" class="cls_020"><span class="cls_020">240</span></div>
<div style="position:absolute;left:74.49px;top:636.00px" class="cls_021"><span class="cls_021">Chapter 9</span></div>
</div>
<div style="position:absolute;left:50%;margin-left:-252px;top:176436px;width:504px;height:666px;border-style:outset;overflow:hidden">
<div style="position:absolute;left:0px;top:0px">
<img src="e698b76e-46bd-11eb-8b25-0cc47a792c0a_id_e698b76e-46bd-11eb-8b25-0cc47a792c0a_files/background265.jpg" width=504 height=666></div>
<div style="position:absolute;left:123.00px;top:42.23px" class="cls_050"><span class="cls_050">•</span><span class="cls_007">   At </span><span class="cls_050">w</span><span class="cls_007"> we create an instance of the </span><span class="cls_030">Quote</span><span class="cls_007"> class and then call </span><span class="cls_030">instance_eval</span></div>
<div style="position:absolute;left:141.00px;top:54.23px" class="cls_007"><span class="cls_007">at </span><span class="cls_050">x</span><span class="cls_007">, passing a block. The </span><span class="cls_030">instance_eval</span><span class="cls_007"> method is similar to </span><span class="cls_030">eval</span><span class="cls_007">, except</span></div>
<div style="position:absolute;left:141.00px;top:66.23px" class="cls_007"><span class="cls_007">that it evaluates the given string in the context of the receiver, or the</span></div>
<div style="position:absolute;left:141.00px;top:78.23px" class="cls_007"><span class="cls_007">object we call it on. As shown here, we can pass a block to </span><span class="cls_030">instance_eval</span></div>
<div style="position:absolute;left:141.00px;top:90.23px" class="cls_007"><span class="cls_007">instead of a string if we don’t want to dynamically parse and compile code.</span></div>
<div style="position:absolute;left:123.00px;top:105.23px" class="cls_050"><span class="cls_050">•</span><span class="cls_007">   The block we pass to </span><span class="cls_030">instance_eval</span><span class="cls_007"> prints out the string at </span><span class="cls_050">y</span><span class="cls_007">, accessing</span></div>
<div style="position:absolute;left:141.01px;top:117.23px" class="cls_007"><span class="cls_007">the first half of the string from the </span><span class="cls_030">obj</span><span class="cls_007">’s instance variable and the sec-</span></div>
<div style="position:absolute;left:141.00px;top:129.23px" class="cls_007"><span class="cls_007">ond half from the surrounding scope, or environment.</span></div>
<div style="position:absolute;left:141.00px;top:150.23px" class="cls_007"><span class="cls_007">How can this possibly work? It seems that the block passed to </span><span class="cls_030">instance_</span></div>
<div style="position:absolute;left:123.00px;top:162.23px" class="cls_030"><span class="cls_030">eval</span><span class="cls_007"> has two environments: the quote instance and the surrounding code</span></div>
<div style="position:absolute;left:123.00px;top:174.23px" class="cls_007"><span class="cls_007">environment. In other words, the </span><span class="cls_030">@str</span><span class="cls_007"> variable comes from one place and</span></div>
<div style="position:absolute;left:123.00px;top:186.23px" class="cls_030"><span class="cls_030">str2</span><span class="cls_007"> from another.</span></div>
<div style="position:absolute;left:123.00px;top:211.23px" class="cls_055"><span class="cls_055">Another Important Part of Ruby Closures</span></div>
<div style="position:absolute;left:123.00px;top:229.23px" class="cls_007"><span class="cls_007">This example highlights another important part of closure environments in</span></div>
<div style="position:absolute;left:123.00px;top:241.23px" class="cls_007"><span class="cls_007">Ruby: the current value of </span><span class="cls_030">self</span><span class="cls_007">. Recall that the </span><span class="cls_030">rb_control_frame_t</span><span class="cls_007"> structure</span></div>
<div style="position:absolute;left:123.00px;top:253.23px" class="cls_007"><span class="cls_007">for each stack frame, or level, in your Ruby call stack contains a </span><span class="cls_030">self</span><span class="cls_007"> pointer,</span></div>
<div style="position:absolute;left:123.00px;top:265.23px" class="cls_007"><span class="cls_007">along with the </span><span class="cls_030">PC</span><span class="cls_007">, </span><span class="cls_030">SP</span><span class="cls_007">, and </span><span class="cls_030">EP</span><span class="cls_007"> pointers and other values (see Figure 9-19).</span></div>
<div style="position:absolute;left:51.00px;top:286.54px" class="cls_165"><span class="cls_165">YARV internal stack</span></div>
<div style="position:absolute;left:275.78px;top:288.51px" class="cls_165"><span class="cls_165">YARV instructions</span></div>
<div style="position:absolute;left:145.02px;top:303.65px" class="cls_166"><span class="cls_166">rb_control_frame_t</span></div>
<div style="position:absolute;left:279.47px;top:308.95px" class="cls_168"><span class="cls_168">trace</span></div>
<div style="position:absolute;left:279.47px;top:319.29px" class="cls_168"><span class="cls_168">putself</span></div>
<div style="position:absolute;left:182.91px;top:323.85px" class="cls_167"><span class="cls_167">pc</span></div>
<div style="position:absolute;left:111.06px;top:326.20px" class="cls_169"><span class="cls_169">SP</span></div>
<div style="position:absolute;left:279.47px;top:329.63px" class="cls_168"><span class="cls_168">putobject</span></div>
<div style="position:absolute;left:354.32px;top:329.63px" class="cls_168"><span class="cls_168">2</span></div>
<div style="position:absolute;left:72.71px;top:340.41px" class="cls_167"><span class="cls_167">2</span></div>
<div style="position:absolute;left:279.47px;top:339.97px" class="cls_168"><span class="cls_168">putobject</span></div>
<div style="position:absolute;left:354.32px;top:339.97px" class="cls_168"><span class="cls_168">2</span></div>
<div style="position:absolute;left:279.47px;top:350.30px" class="cls_168"><span class="cls_168">opt_plus</span></div>
<div style="position:absolute;left:182.91px;top:354.43px" class="cls_167"><span class="cls_167">sp</span></div>
<div style="position:absolute;left:279.47px;top:360.64px" class="cls_168"><span class="cls_168">opt_send_simple &lt;callinfo!mid:puts...</span></div>
<div style="position:absolute;left:72.71px;top:366.81px" class="cls_167"><span class="cls_167">2</span></div>
<div style="position:absolute;left:248.58px;top:370.75px" class="cls_169"><span class="cls_169">PC</span></div>
<div style="position:absolute;left:279.47px;top:370.98px" class="cls_168"><span class="cls_168">leave</span></div>
<div style="position:absolute;left:178.97px;top:387.11px" class="cls_167"><span class="cls_167">self</span></div>
<div style="position:absolute;left:66.80px;top:392.04px" class="cls_167"><span class="cls_167">self</span></div>
<div style="position:absolute;left:178.97px;top:416.17px" class="cls_167"><span class="cls_167">type</span></div>
<div style="position:absolute;left:51.00px;top:446.07px" class="cls_038"><span class="cls_038">Figure 9-19: The </span><span class="cls_014">rb_control_frame_t</span><span class="cls_038"> structure</span></div>
<div style="position:absolute;left:141.00px;top:468.57px" class="cls_007"><span class="cls_007">The </span><span class="cls_030">self</span><span class="cls_007"> pointer records the current value of </span><span class="cls_030">self</span><span class="cls_007"> in your Ruby project; it</span></div>
<div style="position:absolute;left:123.00px;top:480.57px" class="cls_007"><span class="cls_007">indicates which object is the owner of the method Ruby is currently execut-</span></div>
<div style="position:absolute;left:123.00px;top:492.57px" class="cls_007"><span class="cls_007">ing at that time. Each level in your Ruby call stack can contain a different</span></div>
<div style="position:absolute;left:123.00px;top:504.57px" class="cls_007"><span class="cls_007">value for </span><span class="cls_030">self</span><span class="cls_007">.</span></div>
<div style="position:absolute;left:141.00px;top:516.57px" class="cls_007"><span class="cls_007">Recall that whenever you create a closure Ruby sets the </span><span class="cls_030">EP</span><span class="cls_007">, or environ-</span></div>
<div style="position:absolute;left:123.00px;top:528.57px" class="cls_007"><span class="cls_007">ment pointer, in the </span><span class="cls_030">rb_block_t</span><span class="cls_007"> structure to the referencing environment,</span></div>
<div style="position:absolute;left:123.00px;top:540.57px" class="cls_007"><span class="cls_007">giving the code inside the block access to the surrounding variables. And,</span></div>
<div style="position:absolute;left:123.00px;top:552.57px" class="cls_007"><span class="cls_007">as it turns out, Ruby also copies the value of </span><span class="cls_030">self</span><span class="cls_007"> into </span><span class="cls_030">rb_block_t</span><span class="cls_007">. This means</span></div>
<div style="position:absolute;left:123.00px;top:564.57px" class="cls_007"><span class="cls_007">that the current object is also a part of closures in Ruby. Figure 9-20 looks</span></div>
<div style="position:absolute;left:123.00px;top:576.57px" class="cls_007"><span class="cls_007">at what closures contain in Ruby.</span></div>
<div style="position:absolute;left:381.01px;top:636.00px" class="cls_021"><span class="cls_021">Metaprogramming</span></div>
<div style="position:absolute;left:443.05px;top:633.00px" class="cls_020"><span class="cls_020">241</span></div>
</div>
<div style="position:absolute;left:50%;margin-left:-252px;top:177112px;width:504px;height:666px;border-style:outset;overflow:hidden">
<div style="position:absolute;left:0px;top:0px">
<img src="e698b76e-46bd-11eb-8b25-0cc47a792c0a_id_e698b76e-46bd-11eb-8b25-0cc47a792c0a_files/background266.jpg" width=504 height=666></div>
<div style="position:absolute;left:123.72px;top:47.49px" class="cls_170"><span class="cls_170">putstring "The quick brown fox... "</span></div>
<div style="position:absolute;left:123.72px;top:59.49px" class="cls_170"><span class="cls_170">setdynamic str, 0</span></div>
<div style="position:absolute;left:363.49px;top:68.49px" class="cls_172"><span class="cls_172">rb_block_t</span></div>
<div style="position:absolute;left:123.72px;top:71.49px" class="cls_170"><span class="cls_170">putself</span></div>
<div style="position:absolute;left:123.72px;top:83.48px" class="cls_170"><span class="cls_170">getdynamic str, 0</span></div>
<div style="position:absolute;left:398.45px;top:84.47px" class="cls_171"><span class="cls_171">iseq</span></div>
<div style="position:absolute;left:123.72px;top:95.48px" class="cls_170"><span class="cls_170">send :puts, 1</span></div>
<div style="position:absolute;left:123.72px;top:107.48px" class="cls_170"><span class="cls_170">leave</span></div>
<div style="position:absolute;left:402.42px;top:110.90px" class="cls_171"><span class="cls_171">EP</span></div>
<div style="position:absolute;left:398.45px;top:137.32px" class="cls_171"><span class="cls_171">self</span></div>
<div style="position:absolute;left:129.67px;top:141.19px" class="cls_017"><span class="cls_017">YARV internal stack</span></div>
<div style="position:absolute;left:173.31px;top:181.91px" class="cls_171"><span class="cls_171">locals: str</span></div>
<div style="position:absolute;left:273.23px;top:214.91px" class="cls_172"><span class="cls_172">RObject</span></div>
<div style="position:absolute;left:306.21px;top:230.89px" class="cls_171"><span class="cls_171">klass</span></div>
<div style="position:absolute;left:306.21px;top:262.01px" class="cls_171"><span class="cls_171">ivptr</span></div>
<div style="position:absolute;left:120.00px;top:296.02px" class="cls_038"><span class="cls_038">Figure 9-20: In Ruby, closure environments include both the stack frame and the current</span></div>
<div style="position:absolute;left:120.00px;top:306.52px" class="cls_038"><span class="cls_038">object from the referencing code.</span></div>
<div style="position:absolute;left:138.00px;top:329.02px" class="cls_007"><span class="cls_007">Because the </span><span class="cls_030">rb_block_t</span><span class="cls_007"> structure contains the value of </span><span class="cls_030">self</span><span class="cls_007"> from the</span></div>
<div style="position:absolute;left:120.00px;top:341.02px" class="cls_007"><span class="cls_007">referencing environment, code inside a block can access the values and</span></div>
<div style="position:absolute;left:120.00px;top:353.02px" class="cls_007"><span class="cls_007">methods of the object that was active when the closure was created or refer-</span></div>
<div style="position:absolute;left:120.00px;top:365.02px" class="cls_007"><span class="cls_007">enced. This ability probably seems obvious for a block: The current object</span></div>
<div style="position:absolute;left:120.00px;top:377.02px" class="cls_007"><span class="cls_007">before and after you call a block doesn’t change. However, if you use a</span></div>
<div style="position:absolute;left:120.00px;top:389.02px" class="cls_007"><span class="cls_007">lambda, proc, or binding, Ruby will remember what the current object was</span></div>
<div style="position:absolute;left:120.00px;top:401.02px" class="cls_007"><span class="cls_007">when you created it. And, as we’ll see shortly with </span><span class="cls_030">instance_eval</span><span class="cls_007">, Ruby can</span></div>
<div style="position:absolute;left:120.00px;top:413.02px" class="cls_007"><span class="cls_007">sometimes change </span><span class="cls_030">self</span><span class="cls_007"> when you create a closure, giving your code access</span></div>
<div style="position:absolute;left:120.00px;top:425.02px" class="cls_007"><span class="cls_007">to a different object’s values and methods.</span></div>
<div style="position:absolute;left:120.00px;top:450.02px" class="cls_055"><span class="cls_055">instance_eval Changes self to the Receiver</span></div>
<div style="position:absolute;left:120.00px;top:468.02px" class="cls_007"><span class="cls_007">When you call </span><span class="cls_030">instance_eval</span><span class="cls_007"> at </span><span class="cls_050">x</span><span class="cls_007"> in Listing 9-16, Ruby creates both a closure</span></div>
<div style="position:absolute;left:120.01px;top:480.02px" class="cls_007"><span class="cls_007">and a new lexical scope. For example, as you can see in Figure 9-21, the new</span></div>
<div style="position:absolute;left:120.01px;top:492.02px" class="cls_007"><span class="cls_007">stack frame for the code inside </span><span class="cls_030">instance_eval</span><span class="cls_007"> uses new values for both </span><span class="cls_030">EP</span></div>
<div style="position:absolute;left:120.00px;top:504.02px" class="cls_007"><span class="cls_007">and </span><span class="cls_030">self</span><span class="cls_007">.</span></div>
<div style="position:absolute;left:138.00px;top:516.02px" class="cls_007"><span class="cls_007">On the left of the figure, we see that executing </span><span class="cls_030">instance_eval</span><span class="cls_007"> creates a</span></div>
<div style="position:absolute;left:120.00px;top:528.02px" class="cls_007"><span class="cls_007">closure. This result should be no surprise. Passing a block to </span><span class="cls_030">instance_eval</span></div>
<div style="position:absolute;left:120.00px;top:540.02px" class="cls_007"><span class="cls_007">at </span><span class="cls_050">x</span><span class="cls_007"> in Listing 9-16 creates a new level on the stack and sets </span><span class="cls_030">EP</span><span class="cls_007"> to the refer-</span></div>
<div style="position:absolute;left:120.00px;top:552.02px" class="cls_007"><span class="cls_007">encing environment, giving the code inside the block access to the variables</span></div>
<div style="position:absolute;left:120.00px;top:564.02px" class="cls_030"><span class="cls_030">str2</span><span class="cls_007"> and </span><span class="cls_030">obj</span><span class="cls_007">.</span></div>
<div style="position:absolute;left:48.00px;top:633.00px" class="cls_020"><span class="cls_020">242</span></div>
<div style="position:absolute;left:74.22px;top:636.00px" class="cls_021"><span class="cls_021">Chapter 9</span></div>
</div>
<div style="position:absolute;left:50%;margin-left:-252px;top:177788px;width:504px;height:666px;border-style:outset;overflow:hidden">
<div style="position:absolute;left:0px;top:0px">
<img src="e698b76e-46bd-11eb-8b25-0cc47a792c0a_id_e698b76e-46bd-11eb-8b25-0cc47a792c0a_files/background267.jpg" width=504 height=666></div>
<div style="position:absolute;left:374.61px;top:43.57px" class="cls_173"><span class="cls_173">instance_eval</span></div>
<div style="position:absolute;left:126.77px;top:55.61px" class="cls_174"><span class="cls_174">YARV internal stack</span></div>
<div style="position:absolute;left:382.33px;top:53.73px" class="cls_174"><span class="cls_174">resets </span><span class="cls_173">self</span></div>
<div style="position:absolute;left:360.99px;top:74.62px" class="cls_146"><span class="cls_146">rb_control_frame_t</span></div>
<div style="position:absolute;left:399.36px;top:92.12px" class="cls_094"><span class="cls_094">EP</span></div>
<div style="position:absolute;left:185.38px;top:101.47px" class="cls_094"><span class="cls_094">EP</span></div>
<div style="position:absolute;left:395.44px;top:117.97px" class="cls_094"><span class="cls_094">self</span></div>
<div style="position:absolute;left:272.92px;top:142.07px" class="cls_174"><span class="cls_174">New value</span></div>
<div style="position:absolute;left:279.84px;top:151.25px" class="cls_174"><span class="cls_174">of </span><span class="cls_173">self</span></div>
<div style="position:absolute;left:256.89px;top:172.08px" class="cls_146"><span class="cls_146">RObject</span></div>
<div style="position:absolute;left:283.93px;top:185.19px" class="cls_094"><span class="cls_094">klass</span></div>
<div style="position:absolute;left:171.37px;top:190.24px" class="cls_094"><span class="cls_094">locals:</span></div>
<div style="position:absolute;left:171.37px;top:197.79px" class="cls_094"><span class="cls_094">str2, obj</span></div>
<div style="position:absolute;left:283.93px;top:212.41px" class="cls_094"><span class="cls_094">ivptr</span></div>
<div style="position:absolute;left:123.00px;top:243.68px" class="cls_038"><span class="cls_038">Figure 9-21: The stack frame created by running </span><span class="cls_014">instance_eval</span><span class="cls_038"> has a new value for </span><span class="cls_014">self</span><span class="cls_038">.</span></div>
<div style="position:absolute;left:141.00px;top:266.18px" class="cls_007"><span class="cls_007">However, as you can see on the right of the figure, </span><span class="cls_030">instance_eval</span><span class="cls_007"> also</span></div>
<div style="position:absolute;left:123.00px;top:278.18px" class="cls_007"><span class="cls_007">changes the value of </span><span class="cls_030">self</span><span class="cls_007"> in the new closure. When the code inside the</span></div>
<div style="position:absolute;left:123.00px;top:290.18px" class="cls_030"><span class="cls_030">instance_eval</span><span class="cls_007"> block runs, </span><span class="cls_030">self</span><span class="cls_007"> points to the receiver of </span><span class="cls_030">instance_eval</span><span class="cls_007">, or </span><span class="cls_030">obj</span><span class="cls_007">,</span></div>
<div style="position:absolute;left:123.00px;top:302.18px" class="cls_007"><span class="cls_007">in Listing 9-16. This allows the code inside </span><span class="cls_030">instance_eval</span><span class="cls_007"> to access the val-</span></div>
<div style="position:absolute;left:123.00px;top:314.18px" class="cls_007"><span class="cls_007">ues inside the receiver. In Listing 9-16, the code at </span><span class="cls_050">y</span><span class="cls_007"> can access both </span><span class="cls_030">@str</span></div>
<div style="position:absolute;left:123.00px;top:326.18px" class="cls_007"><span class="cls_007">from inside </span><span class="cls_030">obj</span><span class="cls_007"> and </span><span class="cls_030">str2</span><span class="cls_007"> from the surrounding code.</span></div>
<div style="position:absolute;left:123.00px;top:349.18px" class="cls_055"><span class="cls_055">instance_eval Creates a Singleton Class for a New Lexical Scope</span></div>
<div style="position:absolute;left:123.00px;top:367.18px" class="cls_007"><span class="cls_007">The </span><span class="cls_030">instance_eval</span><span class="cls_007"> method also creates a new singleton class and sets it as the</span></div>
<div style="position:absolute;left:123.00px;top:379.18px" class="cls_007"><span class="cls_007">class for a new lexical scope, as shown in Figure 9-22.</span></div>
<div style="position:absolute;left:276.36px;top:400.49px" class="cls_174"><span class="cls_174">Lexical</span></div>
<div style="position:absolute;left:276.07px;top:410.49px" class="cls_174"><span class="cls_174">Scope:</span></div>
<div style="position:absolute;left:123.36px;top:420.05px" class="cls_175"><span class="cls_175">obj = </span><span class="cls_176">Quote</span><span class="cls_175">.new</span></div>
<div style="position:absolute;left:123.36px;top:431.92px" class="cls_175"><span class="cls_175">obj.instance_eval </span><span class="cls_176">do</span></div>
<div style="position:absolute;left:344.29px;top:455.79px" class="cls_146"><span class="cls_146">RClass:</span><span class="cls_177"> singleton</span></div>
<div style="position:absolute;left:132.67px;top:467.54px" class="cls_175"><span class="cls_175">puts "#{@str} #{str2}"</span></div>
<div style="position:absolute;left:275.58px;top:467.27px" class="cls_094"><span class="cls_094">nd_next</span></div>
<div style="position:absolute;left:344.29px;top:465.52px" class="cls_177"><span class="cls_177">class for </span><span class="cls_146">obj</span></div>
<div style="position:absolute;left:132.67px;top:479.42px" class="cls_175"><span class="cls_175">def new_method</span></div>
<div style="position:absolute;left:366.23px;top:478.30px" class="cls_096"><span class="cls_096">method table:</span></div>
<div style="position:absolute;left:275.58px;top:485.92px" class="cls_094"><span class="cls_094">nd_clss</span></div>
<div style="position:absolute;left:132.67px;top:491.29px" class="cls_175"><span class="cls_175">end</span></div>
<div style="position:absolute;left:369.96px;top:493.50px" class="cls_094"><span class="cls_094">new_method</span></div>
<div style="position:absolute;left:123.36px;top:526.91px" class="cls_175"><span class="cls_175">end</span></div>
<div style="position:absolute;left:123.00px;top:546.62px" class="cls_038"><span class="cls_038">Figure 9-22: </span><span class="cls_014">instance_eval</span><span class="cls_038"> creates a lexical scope for a new singleton class.</span></div>
<div style="position:absolute;left:141.00px;top:569.12px" class="cls_007"><span class="cls_007">While executing </span><span class="cls_030">instance_eval</span><span class="cls_007">, Ruby creates a new lexical scope, as</span></div>
<div style="position:absolute;left:123.00px;top:581.12px" class="cls_007"><span class="cls_007">shown by the shaded rectangle inside the </span><span class="cls_030">instance_eval</span><span class="cls_007"> block. If we had</span></div>
<div style="position:absolute;left:123.00px;top:593.12px" class="cls_007"><span class="cls_007">passed a string to </span><span class="cls_030">instance_eval</span><span class="cls_007">, Ruby would have parsed and compiled</span></div>
<div style="position:absolute;left:123.00px;top:605.12px" class="cls_007"><span class="cls_007">the string and then created a new lexical scope in the same way.</span></div>
<div style="position:absolute;left:380.43px;top:636.00px" class="cls_021"><span class="cls_021">Metaprogramming</span></div>
<div style="position:absolute;left:442.48px;top:633.00px" class="cls_020"><span class="cls_020">243</span></div>
</div>
<div style="position:absolute;left:50%;margin-left:-252px;top:178464px;width:504px;height:666px;border-style:outset;overflow:hidden">
<div style="position:absolute;left:0px;top:0px">
<img src="e698b76e-46bd-11eb-8b25-0cc47a792c0a_id_e698b76e-46bd-11eb-8b25-0cc47a792c0a_files/background268.jpg" width=504 height=666></div>
<div style="position:absolute;left:138.00px;top:42.28px" class="cls_007"><span class="cls_007">Along with the new lexical scope, Ruby creates a singleton class for the</span></div>
<div style="position:absolute;left:120.00px;top:54.28px" class="cls_007"><span class="cls_007">receiver, </span><span class="cls_030">obj</span><span class="cls_007">. The singleton class allows you to define new methods for</span></div>
<div style="position:absolute;left:120.00px;top:66.28px" class="cls_007"><span class="cls_007">the receiver object (see Figure 9-22): The </span><span class="cls_030">def new_method</span><span class="cls_007"> call inside the</span></div>
<div style="position:absolute;left:120.00px;top:78.28px" class="cls_030"><span class="cls_030">instance_eval</span><span class="cls_007"> block adds </span><span class="cls_030">new_method</span><span class="cls_007"> to the singleton class for </span><span class="cls_030">obj</span><span class="cls_007">. As a single-</span></div>
<div style="position:absolute;left:120.00px;top:90.28px" class="cls_007"><span class="cls_007">ton class, </span><span class="cls_030">obj</span><span class="cls_007"> will have the new method, but no other objects or classes</span></div>
<div style="position:absolute;left:120.00px;top:102.28px" class="cls_007"><span class="cls_007">in the program will have access to it. (The metaprogramming methods</span></div>
<div style="position:absolute;left:120.00px;top:114.28px" class="cls_030"><span class="cls_030">class_eval</span><span class="cls_007"> and </span><span class="cls_030">module_eval</span><span class="cls_007"> work in a similar way and also create a new lexical</span></div>
<div style="position:absolute;left:120.00px;top:126.28px" class="cls_007"><span class="cls_007">scope; however, they just use the target class or module for the new scope</span></div>
<div style="position:absolute;left:120.00px;top:138.28px" class="cls_007"><span class="cls_007">and don’t create a metaclass or singleton class.)</span></div>
<div style="position:absolute;left:132.53px;top:191.11px" class="cls_020"><span class="cls_020">How Ruby Keeps Track of Lexical Scope for Blocks</span></div>
<div style="position:absolute;left:121.00px;top:209.61px" class="cls_039"><span class="cls_039">Let’s take a closer look at how Ruby represents lexical scopes internally. Figure 9-23</span></div>
<div style="position:absolute;left:121.00px;top:221.61px" class="cls_039"><span class="cls_039">shows the lexical scope Ruby creates for the </span><span class="cls_009">Quote</span><span class="cls_039"> class.</span></div>
<div style="position:absolute;left:128.17px;top:243.88px" class="cls_180"><span class="cls_180">class </span><span class="cls_181">Quote</span></div>
<div style="position:absolute;left:313.19px;top:255.05px" class="cls_182"><span class="cls_182">etc.</span></div>
<div style="position:absolute;left:136.86px;top:279.53px" class="cls_180"><span class="cls_180">def display</span></div>
<div style="position:absolute;left:306.02px;top:282.43px" class="cls_184"><span class="cls_184">nd_next</span></div>
<div style="position:absolute;left:145.56px;top:291.42px" class="cls_180"><span class="cls_180">puts "The quick..."</span></div>
<div style="position:absolute;left:383.77px;top:295.79px" class="cls_185"><span class="cls_185">RClass:</span></div>
<div style="position:absolute;left:306.02px;top:301.09px" class="cls_184"><span class="cls_184">nd_clss</span></div>
<div style="position:absolute;left:136.86px;top:303.30px" class="cls_180"><span class="cls_180">end</span></div>
<div style="position:absolute;left:387.89px;top:304.55px" class="cls_185"><span class="cls_185">Quote</span></div>
<div style="position:absolute;left:128.17px;top:327.07px" class="cls_180"><span class="cls_180">end</span></div>
<div style="position:absolute;left:310.60px;top:327.41px" class="cls_186"><span class="cls_186">cref</span></div>
<div style="position:absolute;left:121.00px;top:348.39px" class="cls_043"><span class="cls_043">Figure 9-23: Ruby’s C source code internally uses a separate structure called</span><span class="cls_187"> </span><span class="cls_015">cref</span><span class="cls_043"> to track lexi-</span></div>
<div style="position:absolute;left:121.00px;top:357.39px" class="cls_043"><span class="cls_043">cal scopes.</span></div>
<div style="position:absolute;left:139.00px;top:377.39px" class="cls_039"><span class="cls_039">You can see the </span><span class="cls_009">display</span><span class="cls_039"> method’s code snippet represented as a rectangle on</span></div>
<div style="position:absolute;left:121.00px;top:389.39px" class="cls_039"><span class="cls_039">the left side of the figure, inside the class </span><span class="cls_009">Quote</span><span class="cls_039"> declaration. On the right side of the</span></div>
<div style="position:absolute;left:121.00px;top:401.39px" class="cls_039"><span class="cls_039">rectangle, you can see a small arrow pointing to a structure labeled </span><span class="cls_009">cref</span><span class="cls_039">, which is the</span></div>
<div style="position:absolute;left:121.00px;top:413.39px" class="cls_039"><span class="cls_039">actual lexical scope. This, in turn, contains a pointer to the </span><span class="cls_009">Quote</span><span class="cls_039"> class (</span><span class="cls_009">nd_clss</span><span class="cls_039">) and to</span></div>
<div style="position:absolute;left:121.00px;top:425.39px" class="cls_039"><span class="cls_039">the parent lexical scope (</span><span class="cls_009">nd_next</span><span class="cls_039">).</span></div>
<div style="position:absolute;left:139.00px;top:437.39px" class="cls_039"><span class="cls_039">As indicated by the figure, Ruby’s C source code internally represents lexical</span></div>
<div style="position:absolute;left:121.00px;top:449.39px" class="cls_039"><span class="cls_039">scopes using these </span><span class="cls_009">cref</span><span class="cls_039"> structures. The small arrow on the left shows that each piece</span></div>
<div style="position:absolute;left:120.99px;top:461.39px" class="cls_039"><span class="cls_039">of code in your program refers to a </span><span class="cls_009">cref</span><span class="cls_039"> structure with a pointer. This pointer keeps</span></div>
<div style="position:absolute;left:121.00px;top:473.39px" class="cls_039"><span class="cls_039">track of which lexical scope that piece of code belongs to.</span></div>
<div style="position:absolute;left:138.99px;top:485.39px" class="cls_039"><span class="cls_039">Notice one important detail about Figure 9-23: Both the code snippet and lexi-</span></div>
<div style="position:absolute;left:121.00px;top:497.39px" class="cls_039"><span class="cls_039">cal scope inside the </span><span class="cls_009">class Quote</span><span class="cls_039"> declaration refer to a single </span><span class="cls_009">RClass</span><span class="cls_039"> structure. There’s</span></div>
<div style="position:absolute;left:121.00px;top:509.39px" class="cls_039"><span class="cls_039">a one-to-one correspondence between code, lexical scope, and class. Every time</span></div>
<div style="position:absolute;left:121.00px;top:521.39px" class="cls_039"><span class="cls_039">Ruby executes the code inside the </span><span class="cls_009">class Quote</span><span class="cls_039"> declaration, it uses the same copy of</span></div>
<div style="position:absolute;left:121.00px;top:533.39px" class="cls_039"><span class="cls_039">the </span><span class="cls_009">RClass</span><span class="cls_039"> structure, the one for </span><span class="cls_009">Quote</span><span class="cls_039">. This behavior seems obvious; the code inside</span></div>
<div style="position:absolute;left:121.00px;top:545.39px" class="cls_039"><span class="cls_039">a class declaration always refers to the same class.</span></div>
<div style="position:absolute;left:139.01px;top:557.39px" class="cls_039"><span class="cls_039">For blocks, however, things aren’t so simple. Using metaprogramming methods</span></div>
<div style="position:absolute;left:121.00px;top:569.39px" class="cls_039"><span class="cls_039">such as </span><span class="cls_009">instance_eval</span><span class="cls_039">, you can specify a different lexical scope for the same piece</span></div>
<div style="position:absolute;left:121.00px;top:581.39px" class="cls_039"><span class="cls_039">of code—a block, for example—to use each time it is executed. Figure 9-24 shows</span></div>
<div style="position:absolute;left:121.00px;top:593.39px" class="cls_039"><span class="cls_039">the problem.</span></div>
<div style="position:absolute;left:48.00px;top:633.00px" class="cls_020"><span class="cls_020">244</span></div>
<div style="position:absolute;left:74.52px;top:636.00px" class="cls_021"><span class="cls_021">Chapter 9</span></div>
</div>
<div style="position:absolute;left:50%;margin-left:-252px;top:179140px;width:504px;height:666px;border-style:outset;overflow:hidden">
<div style="position:absolute;left:0px;top:0px">
<img src="e698b76e-46bd-11eb-8b25-0cc47a792c0a_id_e698b76e-46bd-11eb-8b25-0cc47a792c0a_files/background269.jpg" width=504 height=666></div>
<div style="position:absolute;left:286.67px;top:69.26px" class="cls_188"><span class="cls_188">etc.</span></div>
<div style="position:absolute;left:129.16px;top:76.06px" class="cls_189"><span class="cls_189">obj.instance_eval do</span></div>
<div style="position:absolute;left:280.32px;top:98.83px" class="cls_190"><span class="cls_190">nd_next</span></div>
<div style="position:absolute;left:137.73px;top:105.88px" class="cls_189"><span class="cls_189">def new_method</span></div>
<div style="position:absolute;left:377.46px;top:108.40px" class="cls_191"><span class="cls_191">RClass:</span></div>
<div style="position:absolute;left:137.73px;top:116.71px" class="cls_189"><span class="cls_189">end</span></div>
<div style="position:absolute;left:280.32px;top:119.01px" class="cls_190"><span class="cls_190">nd_clss</span></div>
<div style="position:absolute;left:375.98px;top:117.88px" class="cls_193"><span class="cls_193">singleton</span></div>
<div style="position:absolute;left:241.48px;top:118.38px" class="cls_192"><span class="cls_192">?</span></div>
<div style="position:absolute;left:370.01px;top:127.35px" class="cls_193"><span class="cls_193">class for </span><span class="cls_191">obj</span></div>
<div style="position:absolute;left:284.82px;top:142.46px" class="cls_194"><span class="cls_194">cref</span></div>
<div style="position:absolute;left:129.16px;top:151.85px" class="cls_189"><span class="cls_189">end</span></div>
<div style="position:absolute;left:124.00px;top:176.86px" class="cls_043"><span class="cls_043">Figure 9-24: The block’s code can’t refer to a single lexical scope because the scope’s class</span></div>
<div style="position:absolute;left:124.00px;top:185.86px" class="cls_043"><span class="cls_043">depends on the value of </span><span class="cls_015">obj</span><span class="cls_043">.</span></div>
<div style="position:absolute;left:142.00px;top:208.86px" class="cls_039"><span class="cls_039">We learned in the previous section that Ruby creates a singleton class for the</span></div>
<div style="position:absolute;left:124.00px;top:220.86px" class="cls_039"><span class="cls_039">lexical scope created by </span><span class="cls_009">instance_eval</span><span class="cls_039">. However, this code might be run many times</span></div>
<div style="position:absolute;left:124.00px;top:232.86px" class="cls_039"><span class="cls_039">for different values of </span><span class="cls_009">obj</span><span class="cls_039">. In fact, your program might execute this code at the same</span></div>
<div style="position:absolute;left:124.00px;top:244.86px" class="cls_039"><span class="cls_039">time in different threads. This requirement means that Ruby can’t keep a pointer to a</span></div>
<div style="position:absolute;left:124.00px;top:256.86px" class="cls_039"><span class="cls_039">single </span><span class="cls_009">cref</span><span class="cls_039"> structure for the block as it does for a class definition. This block scope</span></div>
<div style="position:absolute;left:123.99px;top:268.86px" class="cls_039"><span class="cls_039">will refer to different classes at different times.</span></div>
<div style="position:absolute;left:141.99px;top:280.86px" class="cls_039"><span class="cls_039">Ruby solves this problem by saving a pointer to the lexical scope used by</span></div>
<div style="position:absolute;left:123.99px;top:292.87px" class="cls_039"><span class="cls_039">blocks in a different place: as an entry on YARV’s internal stack (see Figure 9-25).</span></div>
<div style="position:absolute;left:282.10px;top:317.14px" class="cls_195"><span class="cls_195">etc.</span></div>
<div style="position:absolute;left:131.69px;top:322.78px" class="cls_189"><span class="cls_189">obj.instance_eval do</span></div>
<div style="position:absolute;left:417.41px;top:331.29px" class="cls_194"><span class="cls_194">SP</span></div>
<div style="position:absolute;left:275.05px;top:344.76px" class="cls_190"><span class="cls_190">nd_next</span></div>
<div style="position:absolute;left:352.02px;top:346.37px" class="cls_196"><span class="cls_196">special</span></div>
<div style="position:absolute;left:417.31px;top:344.59px" class="cls_194"><span class="cls_194">EP</span></div>
<div style="position:absolute;left:140.29px;top:351.50px" class="cls_189"><span class="cls_189">def new_method</span></div>
<div style="position:absolute;left:349.32px;top:360.72px" class="cls_196"><span class="cls_196">svar/cref</span></div>
<div style="position:absolute;left:140.29px;top:361.93px" class="cls_189"><span class="cls_189">end</span></div>
<div style="position:absolute;left:275.05px;top:364.21px" class="cls_190"><span class="cls_190">nd_clss</span></div>
<div style="position:absolute;left:279.55px;top:386.77px" class="cls_194"><span class="cls_194">cref</span></div>
<div style="position:absolute;left:131.69px;top:395.79px" class="cls_189"><span class="cls_189">end</span></div>
<div style="position:absolute;left:124.00px;top:426.56px" class="cls_043"><span class="cls_043">Figure 9-25: Ruby tracks lexical scope for blocks using the </span><span class="cls_015">svar/cref</span><span class="cls_043"> entry on the stack, not</span></div>
<div style="position:absolute;left:124.00px;top:435.56px" class="cls_043"><span class="cls_043">using the block’s code snippet.</span></div>
<div style="position:absolute;left:142.00px;top:458.56px" class="cls_039"><span class="cls_039">On the left side of the figure, you can see the call to </span><span class="cls_009">instance_eval</span><span class="cls_039"> and the</span></div>
<div style="position:absolute;left:124.00px;top:470.56px" class="cls_039"><span class="cls_039">code snippet for the block inside. In the center of the figure is the </span><span class="cls_009">cref</span><span class="cls_039"> structure for</span></div>
<div style="position:absolute;left:124.00px;top:482.56px" class="cls_039"><span class="cls_039">the lexical scope. On the right side, you can see YARV saves a pointer to the scope</span></div>
<div style="position:absolute;left:124.00px;top:494.56px" class="cls_039"><span class="cls_039">in the second entry on its stack, labeled </span><span class="cls_009">svar/cref</span><span class="cls_039">.</span></div>
<div style="position:absolute;left:142.00px;top:506.56px" class="cls_039"><span class="cls_039">Recall from Chapter 3 that the second entry on YARV’s internal stack con-</span></div>
<div style="position:absolute;left:124.00px;top:518.56px" class="cls_039"><span class="cls_039">tains one of two values: </span><span class="cls_009">svar</span><span class="cls_039"> or </span><span class="cls_009">cref</span><span class="cls_039">. As we saw in Experiment 3-2 on page 75,</span></div>
<div style="position:absolute;left:124.00px;top:530.56px" class="cls_009"><span class="cls_009">svar</span><span class="cls_039"> saves a pointer to a table of special variables, such as the result of the last</span></div>
<div style="position:absolute;left:124.00px;top:542.56px" class="cls_039"><span class="cls_039">regular expression match, while executing a method. But while executing a block,</span></div>
<div style="position:absolute;left:124.00px;top:554.56px" class="cls_039"><span class="cls_039">YARV saves the </span><span class="cls_009">cref</span><span class="cls_039"> value here instead. Usually this value isn’t important because</span></div>
<div style="position:absolute;left:124.01px;top:566.56px" class="cls_039"><span class="cls_039">blocks normally use the lexical scope of the surrounding code. But when executing</span></div>
<div style="position:absolute;left:124.00px;top:578.56px" class="cls_009"><span class="cls_009">instance_eval</span><span class="cls_039"> and a few other metaprogramming features, such as </span><span class="cls_009">module_eval</span><span class="cls_039"> and</span></div>
<div style="position:absolute;left:124.00px;top:590.56px" class="cls_009"><span class="cls_009">instance_exec</span><span class="cls_039">, Ruby sets </span><span class="cls_009">cref</span><span class="cls_039"> in this way to the current lexical scope.</span></div>
<div style="position:absolute;left:380.67px;top:636.00px" class="cls_021"><span class="cls_021">Metaprogramming</span></div>
<div style="position:absolute;left:442.72px;top:633.00px" class="cls_020"><span class="cls_020">245</span></div>
</div>
<div style="position:absolute;left:50%;margin-left:-252px;top:179816px;width:504px;height:666px;border-style:outset;overflow:hidden">
<div style="position:absolute;left:0px;top:0px">
<img src="e698b76e-46bd-11eb-8b25-0cc47a792c0a_id_e698b76e-46bd-11eb-8b25-0cc47a792c0a_files/background270.jpg" width=504 height=666></div>
<div style="position:absolute;left:120.00px;top:42.63px" class="cls_031"><span class="cls_031">Experiment 9-2: Using a Closure to Define a Method</span></div>
<div style="position:absolute;left:120.00px;top:62.63px" class="cls_007"><span class="cls_007">Another common metaprogramming pattern in Ruby is to dynamically</span></div>
<div style="position:absolute;left:120.00px;top:74.63px" class="cls_007"><span class="cls_007">define methods in a class using </span><span class="cls_030">define_method</span><span class="cls_007">. For example, Listing 9-17</span></div>
<div style="position:absolute;left:120.00px;top:86.63px" class="cls_007"><span class="cls_007">shows a simple Ruby class that prints out a string when you call </span><span class="cls_030">display</span><span class="cls_007">.</span></div>
<div style="position:absolute;left:120.00px;top:110.63px" class="cls_030"><span class="cls_030">class Quote</span></div>
<div style="position:absolute;left:128.50px;top:121.12px" class="cls_030"><span class="cls_030">def initialize</span></div>
<div style="position:absolute;left:137.00px;top:131.62px" class="cls_030"><span class="cls_030">@str = "The quick brown fox jumps over the lazy dog"</span></div>
<div style="position:absolute;left:128.50px;top:142.12px" class="cls_030"><span class="cls_030">end</span></div>
<div style="position:absolute;left:128.50px;top:152.62px" class="cls_030"><span class="cls_030">def display</span></div>
<div style="position:absolute;left:137.00px;top:163.11px" class="cls_030"><span class="cls_030">puts @str</span></div>
<div style="position:absolute;left:128.50px;top:173.61px" class="cls_030"><span class="cls_030">end</span></div>
<div style="position:absolute;left:120.00px;top:184.11px" class="cls_030"><span class="cls_030">end</span></div>
<div style="position:absolute;left:120.00px;top:194.61px" class="cls_030"><span class="cls_030">Quote.new.display</span></div>
<div style="position:absolute;left:124.25px;top:205.10px" class="cls_030"><span class="cls_030">=> The quick brown fox jumps over the lazy dog</span></div>
<div style="position:absolute;left:120.00px;top:227.60px" class="cls_038"><span class="cls_038">Listing 9-17: A Ruby class that displays a string from an instance variable</span></div>
<div style="position:absolute;left:138.00px;top:250.13px" class="cls_007"><span class="cls_007">This code is similar to that in Listing 9-1, except that we use an instance</span></div>
<div style="position:absolute;left:120.00px;top:262.13px" class="cls_007"><span class="cls_007">variable </span><span class="cls_030">@str</span><span class="cls_007"> to hold the string value.</span></div>
<div style="position:absolute;left:120.00px;top:287.13px" class="cls_055"><span class="cls_055">Using define_method</span></div>
<div style="position:absolute;left:120.00px;top:305.13px" class="cls_007"><span class="cls_007">We could have used metaprogramming to define </span><span class="cls_030">display</span><span class="cls_007"> in a more verbose</span></div>
<div style="position:absolute;left:120.00px;top:317.13px" class="cls_007"><span class="cls_007">but dynamic way, as shown in Listing 9-18.</span></div>
<div style="position:absolute;left:120.00px;top:341.13px" class="cls_030"><span class="cls_030">class Quote</span></div>
<div style="position:absolute;left:128.50px;top:351.62px" class="cls_030"><span class="cls_030">def initialize</span></div>
<div style="position:absolute;left:137.00px;top:362.12px" class="cls_030"><span class="cls_030">@str = "The quick brown fox jumps over the lazy dog"</span></div>
<div style="position:absolute;left:128.50px;top:372.62px" class="cls_030"><span class="cls_030">end</span></div>
<div style="position:absolute;left:108.15px;top:383.12px" class="cls_046"><span class="cls_046">u</span><span class="cls_030">   define_method :display do</span></div>
<div style="position:absolute;left:137.00px;top:393.61px" class="cls_030"><span class="cls_030">puts @str</span></div>
<div style="position:absolute;left:128.50px;top:404.11px" class="cls_030"><span class="cls_030">end</span></div>
<div style="position:absolute;left:120.00px;top:414.61px" class="cls_030"><span class="cls_030">end</span></div>
<div style="position:absolute;left:120.00px;top:437.11px" class="cls_038"><span class="cls_038">Listing 9-18: Using </span><span class="cls_014">define_method</span><span class="cls_038"> to create a method</span></div>
<div style="position:absolute;left:138.00px;top:459.63px" class="cls_007"><span class="cls_007">We call </span><span class="cls_030">define_method</span><span class="cls_007"> at </span><span class="cls_050">u</span><span class="cls_007"> instead of the normal </span><span class="cls_030">def</span><span class="cls_007"> keyword. Because</span></div>
<div style="position:absolute;left:120.00px;top:471.63px" class="cls_007"><span class="cls_007">the name of the new method is passed as the argument </span><span class="cls_030">:display</span><span class="cls_007">, we can</span></div>
<div style="position:absolute;left:120.00px;top:483.63px" class="cls_007"><span class="cls_007">dynamically construct the method name from some data values or iterate</span></div>
<div style="position:absolute;left:120.00px;top:495.63px" class="cls_007"><span class="cls_007">over an array of method names, calling </span><span class="cls_030">define_method</span><span class="cls_007"> for each one.</span></div>
<div style="position:absolute;left:138.00px;top:507.63px" class="cls_007"><span class="cls_007">But there is another subtle difference between </span><span class="cls_030">def</span><span class="cls_007"> and </span><span class="cls_030">define_method</span><span class="cls_007">. For</span></div>
<div style="position:absolute;left:120.00px;top:519.63px" class="cls_030"><span class="cls_030">define_method</span><span class="cls_007"> we provide the body of the method as a block; that is, we use a</span></div>
<div style="position:absolute;left:120.00px;top:531.63px" class="cls_030"><span class="cls_030">do</span><span class="cls_007"> keyword at </span><span class="cls_050">u</span><span class="cls_007">. This syntax difference may seem minor, but remember that</span></div>
<div style="position:absolute;left:120.00px;top:543.63px" class="cls_007"><span class="cls_007">blocks are actually closures. Adding </span><span class="cls_030">do</span><span class="cls_007"> introduces a closure, meaning that the</span></div>
<div style="position:absolute;left:120.00px;top:555.63px" class="cls_007"><span class="cls_007">code inside the new method has access to the environment outside. This is not</span></div>
<div style="position:absolute;left:120.00px;top:567.63px" class="cls_007"><span class="cls_007">the case with the </span><span class="cls_030">def</span><span class="cls_007"> keyword.</span></div>
<div style="position:absolute;left:138.00px;top:579.63px" class="cls_007"><span class="cls_007">There are no local variables present in Listing 9-18 when we call</span></div>
<div style="position:absolute;left:120.00px;top:591.63px" class="cls_030"><span class="cls_030">define_method</span><span class="cls_007">, but suppose that another place in our application did have</span></div>
<div style="position:absolute;left:48.00px;top:633.00px" class="cls_020"><span class="cls_020">246</span></div>
<div style="position:absolute;left:74.48px;top:636.00px" class="cls_021"><span class="cls_021">Chapter 9</span></div>
</div>
<div style="position:absolute;left:50%;margin-left:-252px;top:180492px;width:504px;height:666px;border-style:outset;overflow:hidden">
<div style="position:absolute;left:0px;top:0px">
<img src="e698b76e-46bd-11eb-8b25-0cc47a792c0a_id_e698b76e-46bd-11eb-8b25-0cc47a792c0a_files/background271.jpg" width=504 height=666></div>
<div style="position:absolute;left:123.00px;top:41.60px" class="cls_007"><span class="cls_007">values that we wanted to use inside our new method. By using a closure, Ruby</span></div>
<div style="position:absolute;left:123.00px;top:53.60px" class="cls_007"><span class="cls_007">makes an internal copy of the surrounding environment on the heap, which</span></div>
<div style="position:absolute;left:123.00px;top:65.60px" class="cls_007"><span class="cls_007">the new method will be able to access.</span></div>
<div style="position:absolute;left:123.00px;top:90.60px" class="cls_055"><span class="cls_055">Methods Acting as Closures</span></div>
<div style="position:absolute;left:123.00px;top:108.60px" class="cls_007"><span class="cls_007">Now for another test. Listing 9-19 stores only the first half of the string in</span></div>
<div style="position:absolute;left:123.00px;top:120.60px" class="cls_007"><span class="cls_007">the instance variable. In a moment, we’ll write a new method for the </span><span class="cls_030">Quote</span></div>
<div style="position:absolute;left:123.00px;top:132.60px" class="cls_007"><span class="cls_007">class to access this.</span></div>
<div style="position:absolute;left:123.00px;top:156.60px" class="cls_030"><span class="cls_030">class Quote</span></div>
<div style="position:absolute;left:131.50px;top:167.10px" class="cls_030"><span class="cls_030">def initialize</span></div>
<div style="position:absolute;left:140.00px;top:177.60px" class="cls_030"><span class="cls_030">@str = "The quick brown fox"</span></div>
<div style="position:absolute;left:131.50px;top:188.09px" class="cls_030"><span class="cls_030">end</span></div>
<div style="position:absolute;left:123.00px;top:198.59px" class="cls_030"><span class="cls_030">end</span></div>
<div style="position:absolute;left:123.00px;top:221.09px" class="cls_038"><span class="cls_038">Listing 9-19: Now </span><span class="cls_014">@str</span><span class="cls_038"> has only the first half of the string.</span></div>
<div style="position:absolute;left:141.00px;top:243.60px" class="cls_007"><span class="cls_007">Listing 9-20 shows how we can use a closure to access both the instance</span></div>
<div style="position:absolute;left:123.00px;top:255.60px" class="cls_007"><span class="cls_007">variable and the surrounding environment.</span></div>
<div style="position:absolute;left:123.00px;top:279.60px" class="cls_030"><span class="cls_030">def create_method_using_a_closure</span></div>
<div style="position:absolute;left:131.50px;top:290.10px" class="cls_030"><span class="cls_030">str2 = "jumps over the lazy dog."</span></div>
<div style="position:absolute;left:111.15px;top:300.60px" class="cls_046"><span class="cls_046">u</span><span class="cls_030">   Quote.send(:define_method, :display) do</span></div>
<div style="position:absolute;left:140.00px;top:311.09px" class="cls_030"><span class="cls_030">puts "#{@str} #{str2}"</span></div>
<div style="position:absolute;left:131.50px;top:321.59px" class="cls_030"><span class="cls_030">end</span></div>
<div style="position:absolute;left:123.00px;top:332.09px" class="cls_030"><span class="cls_030">end</span></div>
<div style="position:absolute;left:123.00px;top:354.59px" class="cls_038"><span class="cls_038">Listing 9-20: Using a closure with </span><span class="cls_014">define_method</span></div>
<div style="position:absolute;left:141.00px;top:377.10px" class="cls_007"><span class="cls_007">Because </span><span class="cls_030">define_method</span><span class="cls_007"> is a private method in the </span><span class="cls_030">Module</span><span class="cls_007"> class, we need</span></div>
<div style="position:absolute;left:123.00px;top:389.10px" class="cls_007"><span class="cls_007">to use the confusing </span><span class="cls_030">send</span><span class="cls_007"> syntax at </span><span class="cls_050">u</span><span class="cls_007">. Earlier, at </span><span class="cls_050">u</span><span class="cls_007"> in Listing 9-18, we</span></div>
<div style="position:absolute;left:123.01px;top:401.10px" class="cls_007"><span class="cls_007">were able to call </span><span class="cls_030">define_method</span><span class="cls_007"> directly because we used it inside the class’s</span></div>
<div style="position:absolute;left:123.00px;top:413.10px" class="cls_007"><span class="cls_007">scope. We can’t do that from other places in the application. By using </span><span class="cls_030">send</span><span class="cls_007">,</span></div>
<div style="position:absolute;left:123.00px;top:425.10px" class="cls_007"><span class="cls_007">the </span><span class="cls_030">create_method_using_a_closure</span><span class="cls_007"> method can call a private method that it</span></div>
<div style="position:absolute;left:123.00px;top:437.10px" class="cls_007"><span class="cls_007">wouldn’t normally have had access to.</span></div>
<div style="position:absolute;left:141.00px;top:449.10px" class="cls_007"><span class="cls_007">But more importantly, notice that the </span><span class="cls_030">str2</span><span class="cls_007"> variable is preserved in the</span></div>
<div style="position:absolute;left:123.00px;top:461.10px" class="cls_007"><span class="cls_007">heap for the new method to use even after </span><span class="cls_030">create_method_using_a_closure</span></div>
<div style="position:absolute;left:123.00px;top:473.10px" class="cls_007"><span class="cls_007">returns:</span></div>
<div style="position:absolute;left:123.00px;top:497.10px" class="cls_030"><span class="cls_030">create_method_using_a_closure</span></div>
<div style="position:absolute;left:123.00px;top:507.60px" class="cls_030"><span class="cls_030">Quote.new.display</span></div>
<div style="position:absolute;left:127.25px;top:518.09px" class="cls_030"><span class="cls_030">=> The quick brown fox jumps over the lazy dog.</span></div>
<div style="position:absolute;left:141.00px;top:540.60px" class="cls_007"><span class="cls_007">Internally, Ruby treats this as a call to </span><span class="cls_030">lambda</span><span class="cls_007">. That is, this code func-</span></div>
<div style="position:absolute;left:123.01px;top:552.60px" class="cls_007"><span class="cls_007">tions the same way as if I had written the code in Listing 9-21.</span></div>
<div style="position:absolute;left:123.00px;top:576.60px" class="cls_030"><span class="cls_030">class Quote</span></div>
<div style="position:absolute;left:131.50px;top:587.10px" class="cls_030"><span class="cls_030">def initialize</span></div>
<div style="position:absolute;left:140.00px;top:597.59px" class="cls_030"><span class="cls_030">@str = "The quick brown fox"</span></div>
<div style="position:absolute;left:131.50px;top:608.09px" class="cls_030"><span class="cls_030">end</span></div>
<div style="position:absolute;left:380.73px;top:636.00px" class="cls_021"><span class="cls_021">Metaprogramming</span></div>
<div style="position:absolute;left:442.77px;top:633.00px" class="cls_020"><span class="cls_020">247</span></div>
</div>
<div style="position:absolute;left:50%;margin-left:-252px;top:181168px;width:504px;height:666px;border-style:outset;overflow:hidden">
<div style="position:absolute;left:0px;top:0px">
<img src="e698b76e-46bd-11eb-8b25-0cc47a792c0a_id_e698b76e-46bd-11eb-8b25-0cc47a792c0a_files/background272.jpg" width=504 height=666></div>
<div style="position:absolute;left:120.00px;top:42.82px" class="cls_030"><span class="cls_030">end</span></div>
<div style="position:absolute;left:120.00px;top:53.31px" class="cls_030"><span class="cls_030">def create_method_using_a_closure</span></div>
<div style="position:absolute;left:128.50px;top:63.81px" class="cls_030"><span class="cls_030">str2 = "jumps over the lazy dog."</span></div>
<div style="position:absolute;left:128.50px;top:74.31px" class="cls_030"><span class="cls_030">lambda do</span></div>
<div style="position:absolute;left:137.00px;top:84.81px" class="cls_030"><span class="cls_030">puts "#{@str} #{str2}"</span></div>
<div style="position:absolute;left:128.50px;top:95.30px" class="cls_030"><span class="cls_030">end</span></div>
<div style="position:absolute;left:120.00px;top:105.80px" class="cls_030"><span class="cls_030">end</span></div>
<div style="position:absolute;left:108.15px;top:116.30px" class="cls_046"><span class="cls_046">u</span><span class="cls_030"> Quote.send(:define_method, :display, create_method_using_a_closure)</span></div>
<div style="position:absolute;left:108.15px;top:126.80px" class="cls_046"><span class="cls_046">v</span><span class="cls_030"> Quote.new.display</span></div>
<div style="position:absolute;left:120.00px;top:149.29px" class="cls_038"><span class="cls_038">Listing 9-21: Passing a proc to </span><span class="cls_014">define_method</span></div>
<div style="position:absolute;left:138.00px;top:171.82px" class="cls_007"><span class="cls_007">Listing 9-21 separates the code that creates the closure and defines</span></div>
<div style="position:absolute;left:120.00px;top:183.82px" class="cls_007"><span class="cls_007">the method. Because at </span><span class="cls_050">u</span><span class="cls_007"> we pass three arguments to </span><span class="cls_030">define_method</span><span class="cls_007">, Ruby</span></div>
<div style="position:absolute;left:120.00px;top:195.82px" class="cls_007"><span class="cls_007">expects the third to be a proc object. While this is an even more verbose</span></div>
<div style="position:absolute;left:120.00px;top:207.82px" class="cls_007"><span class="cls_007">way to write this code, it’s a bit less confusing because calling </span><span class="cls_030">lambda</span><span class="cls_007"> makes</span></div>
<div style="position:absolute;left:120.00px;top:219.82px" class="cls_007"><span class="cls_007">it clear that Ruby will create a closure.</span></div>
<div style="position:absolute;left:138.00px;top:231.82px" class="cls_007"><span class="cls_007">Finally, when we call the </span><span class="cls_030">new</span><span class="cls_007"> method at </span><span class="cls_050">v</span><span class="cls_007">, Ruby resets the </span><span class="cls_030">self</span><span class="cls_007"> pointer</span></div>
<div style="position:absolute;left:120.00px;top:243.82px" class="cls_007"><span class="cls_007">from the closure to receiver object, similar to the way that </span><span class="cls_030">instance_eval</span></div>
<div style="position:absolute;left:120.00px;top:255.82px" class="cls_007"><span class="cls_007">works. This allows the new method to access </span><span class="cls_030">@str</span><span class="cls_007"> as you would expect.</span></div>
<div style="position:absolute;left:66.00px;top:289.82px" class="cls_031"><span class="cls_031">Summary</span></div>
<div style="position:absolute;left:120.00px;top:309.82px" class="cls_007"><span class="cls_007">In this chapter we’ve seen how the concept of closures—the idea central to</span></div>
<div style="position:absolute;left:120.00px;top:321.82px" class="cls_007"><span class="cls_007">the way blocks, lambdas, and procs work in Ruby—also applies to methods</span></div>
<div style="position:absolute;left:120.00px;top:333.82px" class="cls_007"><span class="cls_007">such as </span><span class="cls_030">eval</span><span class="cls_007">, </span><span class="cls_030">instance_eval</span><span class="cls_007">, and </span><span class="cls_030">define_method</span><span class="cls_007">. The same underlying concept</span></div>
<div style="position:absolute;left:120.00px;top:345.82px" class="cls_007"><span class="cls_007">explains how these different Ruby methods work. In a similar way, the con-</span></div>
<div style="position:absolute;left:120.00px;top:357.82px" class="cls_007"><span class="cls_007">cept of lexical scope underpins all of the ways that Ruby allows you to cre-</span></div>
<div style="position:absolute;left:120.00px;top:369.82px" class="cls_007"><span class="cls_007">ate a method and assign it to a class. Understanding the concept of lexical</span></div>
<div style="position:absolute;left:120.00px;top:381.82px" class="cls_007"><span class="cls_007">scope should make the different uses of Ruby’s </span><span class="cls_030">def</span><span class="cls_007"> keyword and </span><span class="cls_030">class &lt;&lt;</span></div>
<div style="position:absolute;left:120.00px;top:393.82px" class="cls_007"><span class="cls_007">syntax easier to understand.</span></div>
<div style="position:absolute;left:138.00px;top:405.82px" class="cls_007"><span class="cls_007">While metaprogramming might seem complex at first, learning how</span></div>
<div style="position:absolute;left:120.00px;top:417.82px" class="cls_007"><span class="cls_007">Ruby works internally can help us understand what Ruby’s metaprogram-</span></div>
<div style="position:absolute;left:120.00px;top:429.82px" class="cls_007"><span class="cls_007">ming features actually do. What seems initially like a large set of different,</span></div>
<div style="position:absolute;left:120.00px;top:441.82px" class="cls_007"><span class="cls_007">unrelated methods in a confusing API turn out to be related by a few impor-</span></div>
<div style="position:absolute;left:120.00px;top:453.82px" class="cls_007"><span class="cls_007">tant ideas. Studying Ruby internals allows us to see these concepts and to</span></div>
<div style="position:absolute;left:120.00px;top:465.82px" class="cls_007"><span class="cls_007">understand what they mean.</span></div>
<div style="position:absolute;left:48.00px;top:633.00px" class="cls_020"><span class="cls_020">248</span></div>
<div style="position:absolute;left:74.52px;top:636.00px" class="cls_021"><span class="cls_021">Chapter 9</span></div>
</div>
<div style="position:absolute;left:50%;margin-left:-252px;top:181844px;width:504px;height:666px;border-style:outset;overflow:hidden">
<div style="position:absolute;left:0px;top:0px">
<img src="e698b76e-46bd-11eb-8b25-0cc47a792c0a_id_e698b76e-46bd-11eb-8b25-0cc47a792c0a_files/background273.jpg" width=504 height=666></div>
</div>
<div style="position:absolute;left:50%;margin-left:-252px;top:181844px;width:504px;height:666px;border-style:outset;overflow:hidden">
<div style="position:absolute;left:0px;top:0px">
<img src="e698b76e-46bd-11eb-8b25-0cc47a792c0a_id_e698b76e-46bd-11eb-8b25-0cc47a792c0a_files/background274.jpg" width=504 height=666></div>
<div style="position:absolute;left:249.03px;top:297.71px" class="cls_024"><span class="cls_024">JRuby is Ruby</span></div>
<div style="position:absolute;left:235.21px;top:315.72px" class="cls_024"><span class="cls_024">implemented on the</span></div>
<div style="position:absolute;left:248.30px;top:333.72px" class="cls_024"><span class="cls_024">Java platform.</span></div>
</div>
<div style="position:absolute;left:50%;margin-left:-252px;top:182520px;width:504px;height:666px;border-style:outset;overflow:hidden">
<div style="position:absolute;left:0px;top:0px">
<img src="e698b76e-46bd-11eb-8b25-0cc47a792c0a_id_e698b76e-46bd-11eb-8b25-0cc47a792c0a_files/background275.jpg" width=504 height=666></div>
<div style="position:absolute;left:235.48px;top:96.48px" class="cls_035"><span class="cls_035">10</span></div>
<div style="position:absolute;left:165.56px;top:248.48px" class="cls_016"><span class="cls_016">JRuby: Ruby on the JVM</span></div>
<div style="position:absolute;left:123.00px;top:357.48px" class="cls_023"><span class="cls_023">In Chapters 1 through 9 we learned how the standard</span></div>
<div style="position:absolute;left:123.00px;top:375.48px" class="cls_023"><span class="cls_023">version of Ruby works internally. Because Ruby is writ-</span></div>
<div style="position:absolute;left:123.00px;top:393.49px" class="cls_023"><span class="cls_023">ten in C, its standard implementation is often known</span></div>
<div style="position:absolute;left:123.00px;top:411.49px" class="cls_023"><span class="cls_023">as </span><span class="cls_024">CRuby</span><span class="cls_023">. It’s also often referred to as </span><span class="cls_024">Matz’s Ruby</span></div>
<div style="position:absolute;left:123.00px;top:429.50px" class="cls_024"><span class="cls_024">Interpreter (MRI)</span><span class="cls_023">, after Yukihiro Matsumoto, who cre-</span></div>
<div style="position:absolute;left:122.99px;top:447.50px" class="cls_023"><span class="cls_023">ated the language in the early 1990s.</span></div>
<div style="position:absolute;left:141.00px;top:466.48px" class="cls_007"><span class="cls_007">In this chapter we’ll see an alternative implementation of Ruby called</span></div>
<div style="position:absolute;left:123.00px;top:478.48px" class="cls_008"><span class="cls_008">JRuby</span><span class="cls_007">. JRuby is Ruby implemented in Java instead of C. The use of Java allows</span></div>
<div style="position:absolute;left:123.00px;top:490.48px" class="cls_007"><span class="cls_007">Ruby applications to run like any other Java program, using the Java Virtual</span></div>
<div style="position:absolute;left:123.00px;top:502.48px" class="cls_007"><span class="cls_007">Machine (JVM). It also allows your Ruby code to interoperate with thousands</span></div>
<div style="position:absolute;left:123.00px;top:514.48px" class="cls_007"><span class="cls_007">of libraries written in Java and other languages that run on the JVM. Thanks</span></div>
<div style="position:absolute;left:123.00px;top:526.48px" class="cls_007"><span class="cls_007">to the JVM’s sophisticated garbage collection (GC) algorithms, just-in-time</span></div>
<div style="position:absolute;left:123.00px;top:538.48px" class="cls_007"><span class="cls_007">( JIT) compiler, and many other technical innovations, using the JVM means</span></div>
<div style="position:absolute;left:123.00px;top:550.48px" class="cls_007"><span class="cls_007">that your Ruby code often runs faster and more reliably.</span></div>
<div style="position:absolute;left:141.00px;top:562.48px" class="cls_007"><span class="cls_007">In the first half of this chapter, we’ll contrast standard Ruby—that is,</span></div>
<div style="position:absolute;left:123.00px;top:574.48px" class="cls_007"><span class="cls_007">MRI—with JRuby. You’ll learn what happens when you run a Ruby program</span></div>
<div style="position:absolute;left:123.00px;top:586.48px" class="cls_007"><span class="cls_007">using JRuby and how JRuby parses and compiles your Ruby code. In the lat-</span></div>
<div style="position:absolute;left:123.00px;top:598.48px" class="cls_007"><span class="cls_007">ter half of the chapter, we’ll see how JRuby and MRI save your string data</span></div>
<div style="position:absolute;left:123.00px;top:610.48px" class="cls_007"><span class="cls_007">using the </span><span class="cls_030">String</span><span class="cls_007"> class.</span></div>
</div>
<div style="position:absolute;left:50%;margin-left:-252px;top:183196px;width:504px;height:666px;border-style:outset;overflow:hidden">
<div style="position:absolute;left:0px;top:0px">
<img src="e698b76e-46bd-11eb-8b25-0cc47a792c0a_id_e698b76e-46bd-11eb-8b25-0cc47a792c0a_files/background276.jpg" width=504 height=666></div>
<div style="position:absolute;left:261.47px;top:55.51px" class="cls_020"><span class="cls_020">Roadmap</span></div>
<div style="position:absolute;left:132.00px;top:72.51px" class="cls_017"><span class="cls_017">Running Programs with MRI and JRuby</span></div>
<div style="position:absolute;left:415.36px;top:72.51px" class="cls_017"><span class="cls_017">252</span></div>
<div style="position:absolute;left:150.00px;top:89.52px" class="cls_017"><span class="cls_017">How JRuby Parses and Compiles Your Code</span></div>
<div style="position:absolute;left:415.36px;top:89.52px" class="cls_017"><span class="cls_017">254</span></div>
<div style="position:absolute;left:150.00px;top:106.52px" class="cls_017"><span class="cls_017">How JRuby Executes Your Code</span></div>
<div style="position:absolute;left:415.36px;top:106.52px" class="cls_017"><span class="cls_017">255</span></div>
<div style="position:absolute;left:150.00px;top:123.52px" class="cls_017"><span class="cls_017">Implementing Ruby Classes with Java Classes</span></div>
<div style="position:absolute;left:415.36px;top:123.52px" class="cls_017"><span class="cls_017">257</span></div>
<div style="position:absolute;left:132.00px;top:140.52px" class="cls_019"><span class="cls_019">Experiment 10-1: Monitoring JRuby’s Just-in-Time Compiler</span></div>
<div style="position:absolute;left:416.40px;top:140.52px" class="cls_019"><span class="cls_019">260</span></div>
<div style="position:absolute;left:150.01px;top:157.52px" class="cls_017"><span class="cls_017">Experiment Code</span></div>
<div style="position:absolute;left:415.37px;top:157.52px" class="cls_017"><span class="cls_017">260</span></div>
<div style="position:absolute;left:150.01px;top:174.51px" class="cls_017"><span class="cls_017">Using the </span><span class="cls_030">-J-XX:+PrintCompilation</span><span class="cls_017"> Option</span></div>
<div style="position:absolute;left:415.37px;top:174.51px" class="cls_017"><span class="cls_017">261</span></div>
<div style="position:absolute;left:150.00px;top:191.51px" class="cls_017"><span class="cls_017">Does JIT Speed Up Your JRuby Program?</span></div>
<div style="position:absolute;left:415.37px;top:191.51px" class="cls_017"><span class="cls_017">262</span></div>
<div style="position:absolute;left:132.00px;top:208.52px" class="cls_017"><span class="cls_017">Strings in JRuby and MRI</span></div>
<div style="position:absolute;left:415.37px;top:208.52px" class="cls_017"><span class="cls_017">263</span></div>
<div style="position:absolute;left:150.00px;top:225.52px" class="cls_017"><span class="cls_017">How JRuby and MRI Save String Data</span></div>
<div style="position:absolute;left:415.37px;top:225.52px" class="cls_017"><span class="cls_017">264</span></div>
<div style="position:absolute;left:150.00px;top:242.52px" class="cls_017"><span class="cls_017">Copy-on-Write</span></div>
<div style="position:absolute;left:415.37px;top:242.52px" class="cls_017"><span class="cls_017">265</span></div>
<div style="position:absolute;left:132.00px;top:259.52px" class="cls_019"><span class="cls_019">Experiment 10-2: Measuring Copy-on-Write Performance</span></div>
<div style="position:absolute;left:416.39px;top:259.52px" class="cls_019"><span class="cls_019">267</span></div>
<div style="position:absolute;left:150.00px;top:276.52px" class="cls_017"><span class="cls_017">Creating a Unique, Nonshared String</span></div>
<div style="position:absolute;left:415.37px;top:276.52px" class="cls_017"><span class="cls_017">267</span></div>
<div style="position:absolute;left:150.00px;top:293.52px" class="cls_017"><span class="cls_017">Experiment Code</span></div>
<div style="position:absolute;left:415.37px;top:293.52px" class="cls_017"><span class="cls_017">268</span></div>
<div style="position:absolute;left:150.00px;top:310.52px" class="cls_017"><span class="cls_017">Visualizing Copy-on-Write</span></div>
<div style="position:absolute;left:415.37px;top:310.52px" class="cls_017"><span class="cls_017">269</span></div>
<div style="position:absolute;left:150.00px;top:327.52px" class="cls_017"><span class="cls_017">Modifying a Shared String Is Slower</span></div>
<div style="position:absolute;left:415.37px;top:327.52px" class="cls_017"><span class="cls_017">270</span></div>
<div style="position:absolute;left:132.00px;top:344.52px" class="cls_017"><span class="cls_017">Summary</span></div>
<div style="position:absolute;left:415.37px;top:344.52px" class="cls_017"><span class="cls_017">271</span></div>
<div style="position:absolute;left:66.00px;top:387.14px" class="cls_031"><span class="cls_031">Running Programs with MRI and JRuby</span></div>
<div style="position:absolute;left:120.00px;top:407.14px" class="cls_007"><span class="cls_007">The normal way to run a Ruby program using standard Ruby is to enter </span><span class="cls_030">ruby</span></div>
<div style="position:absolute;left:120.00px;top:419.14px" class="cls_007"><span class="cls_007">followed by the name of your Ruby script, as shown in Figure 10-1.</span></div>
<div style="position:absolute;left:137.25px;top:439.99px" class="cls_063"><span class="cls_063">$ ruby block.rb</span></div>
<div style="position:absolute;left:124.25px;top:480.24px" class="cls_063"><span class="cls_063">0101101110101</span></div>
<div style="position:absolute;left:227.75px;top:481.24px" class="cls_063"><span class="cls_063">10.times </span><span class="cls_197">do</span></div>
<div style="position:absolute;left:124.25px;top:490.74px" class="cls_063"><span class="cls_063">0100110101001</span></div>
<div style="position:absolute;left:237.25px;top:493.24px" class="cls_063"><span class="cls_063">puts n</span></div>
<div style="position:absolute;left:124.25px;top:501.24px" class="cls_063"><span class="cls_063">0101010101010</span></div>
<div style="position:absolute;left:227.75px;top:505.24px" class="cls_197"><span class="cls_197">end</span></div>
<div style="position:absolute;left:124.25px;top:511.74px" class="cls_063"><span class="cls_063">1100010100110</span></div>
<div style="position:absolute;left:124.25px;top:522.23px" class="cls_063"><span class="cls_063">0101010101011</span></div>
<div style="position:absolute;left:150.29px;top:546.24px" class="cls_017"><span class="cls_017">Ruby</span></div>
<div style="position:absolute;left:252.53px;top:546.24px" class="cls_017"><span class="cls_017">Ruby</span></div>
<div style="position:absolute;left:138.82px;top:556.75px" class="cls_017"><span class="cls_017">Executable</span></div>
<div style="position:absolute;left:251.09px;top:556.75px" class="cls_017"><span class="cls_017">Script</span></div>
<div style="position:absolute;left:120.00px;top:576.38px" class="cls_038"><span class="cls_038">Figure 10-1: Running a script at the command line using standard Ruby</span></div>
<div style="position:absolute;left:48.00px;top:633.00px" class="cls_020"><span class="cls_020">252</span></div>
<div style="position:absolute;left:74.33px;top:636.00px" class="cls_021"><span class="cls_021">Chapter 10</span></div>
</div>
<div style="position:absolute;left:50%;margin-left:-252px;top:183872px;width:504px;height:666px;border-style:outset;overflow:hidden">
<div style="position:absolute;left:0px;top:0px">
<img src="e698b76e-46bd-11eb-8b25-0cc47a792c0a_id_e698b76e-46bd-11eb-8b25-0cc47a792c0a_files/background277.jpg" width=504 height=666></div>
<div style="position:absolute;left:141.00px;top:42.28px" class="cls_007"><span class="cls_007">As you can see in the rectangle at the left, entering </span><span class="cls_030">ruby</span><span class="cls_007"> at a terminal</span></div>
<div style="position:absolute;left:123.00px;top:54.28px" class="cls_007"><span class="cls_007">prompt launches a binary executable, the product of compiling Ruby’s C</span></div>
<div style="position:absolute;left:123.00px;top:66.28px" class="cls_007"><span class="cls_007">source code during the Ruby build process. On the right, you see that the</span></div>
<div style="position:absolute;left:123.00px;top:78.28px" class="cls_007"><span class="cls_007">command line parameter to the </span><span class="cls_030">ruby</span><span class="cls_007"> command is a text file containing your</span></div>
<div style="position:absolute;left:123.00px;top:90.28px" class="cls_007"><span class="cls_007">Ruby code.</span></div>
<div style="position:absolute;left:141.00px;top:102.28px" class="cls_007"><span class="cls_007">To run your Ruby script using JRuby, you normally enter </span><span class="cls_030">jruby</span><span class="cls_007"> at your</span></div>
<div style="position:absolute;left:123.00px;top:114.28px" class="cls_007"><span class="cls_007">terminal prompt. (Depending on how you installed JRuby, the standard</span></div>
<div style="position:absolute;left:123.00px;top:126.28px" class="cls_030"><span class="cls_030">ruby</span><span class="cls_007"> command might be remapped to launch JRuby.) Figure 10-2 shows how</span></div>
<div style="position:absolute;left:123.00px;top:138.28px" class="cls_007"><span class="cls_007">this command works at a high level.</span></div>
<div style="position:absolute;left:139.06px;top:159.14px" class="cls_063"><span class="cls_063">$ jruby block.rb</span></div>
<div style="position:absolute;left:126.05px;top:196.36px" class="cls_064"><span class="cls_064">#!/usr/bin/env bash</span></div>
<div style="position:absolute;left:355.00px;top:197.45px" class="cls_063"><span class="cls_063">10.times </span><span class="cls_197">do</span></div>
<div style="position:absolute;left:126.05px;top:207.50px" class="cls_064"><span class="cls_064"># --------------------------------</span></div>
<div style="position:absolute;left:364.50px;top:208.59px" class="cls_063"><span class="cls_063">puts n</span></div>
<div style="position:absolute;left:126.05px;top:218.64px" class="cls_064"><span class="cls_064"># jruby.bash - Start Script</span></div>
<div style="position:absolute;left:355.00px;top:219.74px" class="cls_197"><span class="cls_197">end</span></div>
<div style="position:absolute;left:123.00px;top:259.80px" class="cls_038"><span class="cls_038">Figure 10-2: The </span><span class="cls_014">jruby</span><span class="cls_038"> command actually maps to a shell script.</span></div>
<div style="position:absolute;left:141.00px;top:282.30px" class="cls_007"><span class="cls_007">Unlike the </span><span class="cls_030">ruby</span><span class="cls_007"> command, the </span><span class="cls_030">jruby</span><span class="cls_007"> command doesn’t map to a</span></div>
<div style="position:absolute;left:123.00px;top:294.30px" class="cls_007"><span class="cls_007">binary executable. It refers to a shell script that executes the </span><span class="cls_030">java</span><span class="cls_007"> com-</span></div>
<div style="position:absolute;left:123.01px;top:306.30px" class="cls_007"><span class="cls_007">mand. Figure 10-3 shows a simplified view of the command JRuby uses to</span></div>
<div style="position:absolute;left:123.01px;top:318.30px" class="cls_007"><span class="cls_007">launch Java.</span></div>
<div style="position:absolute;left:123.12px;top:339.15px" class="cls_063"><span class="cls_063">$ java -Xbootclasspath/a:/path/to/jruby.jar org.jruby.Main block.rb</span></div>
<div style="position:absolute;left:127.22px;top:383.83px" class="cls_063"><span class="cls_063">0101101110101</span></div>
<div style="position:absolute;left:262.78px;top:382.84px" class="cls_063"><span class="cls_063">0101101110101</span></div>
<div style="position:absolute;left:377.30px;top:383.83px" class="cls_063"><span class="cls_063">10.times </span><span class="cls_197">do</span></div>
<div style="position:absolute;left:127.22px;top:394.25px" class="cls_063"><span class="cls_063">0100110101001</span></div>
<div style="position:absolute;left:262.78px;top:393.26px" class="cls_063"><span class="cls_063">0100110101001</span></div>
<div style="position:absolute;left:386.80px;top:395.75px" class="cls_063"><span class="cls_063">puts n</span></div>
<div style="position:absolute;left:127.22px;top:404.68px" class="cls_063"><span class="cls_063">0101010101010</span></div>
<div style="position:absolute;left:262.78px;top:403.68px" class="cls_063"><span class="cls_063">0101010101010</span></div>
<div style="position:absolute;left:377.30px;top:407.66px" class="cls_197"><span class="cls_197">end</span></div>
<div style="position:absolute;left:127.22px;top:415.10px" class="cls_063"><span class="cls_063">1100010100110</span></div>
<div style="position:absolute;left:262.78px;top:414.10px" class="cls_063"><span class="cls_063">1100010100110</span></div>
<div style="position:absolute;left:127.22px;top:425.52px" class="cls_063"><span class="cls_063">0101010101011</span></div>
<div style="position:absolute;left:262.78px;top:424.53px" class="cls_063"><span class="cls_063">0101010101011</span></div>
<div style="position:absolute;left:154.19px;top:447.36px" class="cls_017"><span class="cls_017">Java</span></div>
<div style="position:absolute;left:285.09px;top:446.37px" class="cls_017"><span class="cls_017">JRuby</span></div>
<div style="position:absolute;left:401.83px;top:446.37px" class="cls_017"><span class="cls_017">Ruby</span></div>
<div style="position:absolute;left:141.53px;top:457.78px" class="cls_017"><span class="cls_017">Executable</span></div>
<div style="position:absolute;left:273.35px;top:456.79px" class="cls_017"><span class="cls_017">Application</span></div>
<div style="position:absolute;left:400.38px;top:456.79px" class="cls_017"><span class="cls_017">Script</span></div>
<div style="position:absolute;left:123.00px;top:477.42px" class="cls_038"><span class="cls_038">Figure 10-3: A simplified version of the command JRuby uses to launch the JVM</span></div>
<div style="position:absolute;left:141.00px;top:499.92px" class="cls_007"><span class="cls_007">Notice in Figure 10-3 that JRuby executes your Ruby script using</span></div>
<div style="position:absolute;left:123.00px;top:511.92px" class="cls_007"><span class="cls_007">a binary executable known as the </span><span class="cls_008">Java Virtual Machine (JVM)</span><span class="cls_007">. Like the</span></div>
<div style="position:absolute;left:123.00px;top:523.92px" class="cls_007"><span class="cls_007">standard Ruby executable, the JVM is written in C and compiled into a</span></div>
<div style="position:absolute;left:123.00px;top:535.92px" class="cls_007"><span class="cls_007">binary executable. The JVM runs Java applications, while MRI runs Ruby</span></div>
<div style="position:absolute;left:123.00px;top:547.92px" class="cls_007"><span class="cls_007">applications.</span></div>
<div style="position:absolute;left:141.00px;top:559.92px" class="cls_007"><span class="cls_007">Notice, too, that in the center of Figure 10-3 one of the parameters to</span></div>
<div style="position:absolute;left:123.00px;top:571.92px" class="cls_007"><span class="cls_007">the </span><span class="cls_030">java</span><span class="cls_007"> program, </span><span class="cls_008">-Xbootclasspath</span><span class="cls_007">, specifies an additional library, or collec-</span></div>
<div style="position:absolute;left:122.99px;top:583.92px" class="cls_007"><span class="cls_007">tion, of compiled Java code to make available to the new program: </span><span class="cls_008">jruby.jar</span><span class="cls_007">.</span></div>
<div style="position:absolute;left:122.99px;top:595.92px" class="cls_007"><span class="cls_007">The JRuby Java application is contained inside </span><span class="cls_008">jruby.jar</span><span class="cls_007">. Finally, on the right,</span></div>
<div style="position:absolute;left:123.00px;top:607.92px" class="cls_007"><span class="cls_007">you see the text file containing your Ruby code again.</span></div>
<div style="position:absolute;left:367.92px;top:636.00px" class="cls_021"><span class="cls_021">JRuby: Ruby on the JVM</span></div>
<div style="position:absolute;left:442.47px;top:633.00px" class="cls_020"><span class="cls_020">253</span></div>
</div>
<div style="position:absolute;left:50%;margin-left:-252px;top:184548px;width:504px;height:666px;border-style:outset;overflow:hidden">
<div style="position:absolute;left:0px;top:0px">
<img src="e698b76e-46bd-11eb-8b25-0cc47a792c0a_id_e698b76e-46bd-11eb-8b25-0cc47a792c0a_files/background278.jpg" width=504 height=666></div>
<div style="position:absolute;left:138.00px;top:42.28px" class="cls_007"><span class="cls_007">In sum, here’s what happens when standard Ruby and JRuby launch</span></div>
<div style="position:absolute;left:120.00px;top:54.28px" class="cls_007"><span class="cls_007">your Ruby programs:</span></div>
<div style="position:absolute;left:120.00px;top:75.28px" class="cls_050"><span class="cls_050">•</span><span class="cls_007">   When you run a Ruby script using MRI, you launch a binary executable,</span></div>
<div style="position:absolute;left:138.00px;top:87.28px" class="cls_007"><span class="cls_007">originally written in C, that directly compiles and executes your Ruby</span></div>
<div style="position:absolute;left:138.00px;top:99.28px" class="cls_007"><span class="cls_007">script. This is the standard version of Ruby.</span></div>
<div style="position:absolute;left:120.00px;top:114.28px" class="cls_050"><span class="cls_050">•</span><span class="cls_007">   When you run a Ruby script using JRuby, you launch a binary execut-</span></div>
<div style="position:absolute;left:138.00px;top:126.28px" class="cls_007"><span class="cls_007">able, the JVM, which executes the JRuby Java application. This Java</span></div>
<div style="position:absolute;left:138.00px;top:138.28px" class="cls_007"><span class="cls_007">application, in turn, parses, compiles, and executes your Ruby script</span></div>
<div style="position:absolute;left:138.00px;top:150.28px" class="cls_007"><span class="cls_007">while running inside the JVM.</span></div>
<div style="position:absolute;left:120.00px;top:184.28px" class="cls_055"><span class="cls_055">How JRuby Parses and Compiles Your Code</span></div>
<div style="position:absolute;left:120.00px;top:202.28px" class="cls_007"><span class="cls_007">Once you launch JRuby, it needs to parse and compile your code. To do</span></div>
<div style="position:absolute;left:120.00px;top:214.28px" class="cls_007"><span class="cls_007">this, it uses a parser generator, just as MRI does. Figure 10-4 shows a high-</span></div>
<div style="position:absolute;left:120.00px;top:226.28px" class="cls_007"><span class="cls_007">level overview of the JRuby parsing and compiling process.</span></div>
<div style="position:absolute;left:250.70px;top:247.57px" class="cls_198"><span class="cls_198">JRuby Build Time</span></div>
<div style="position:absolute;left:130.37px;top:274.66px" class="cls_051"><span class="cls_051">Grammar</span></div>
<div style="position:absolute;left:195.13px;top:273.65px" class="cls_053"><span class="cls_053">Generate</span></div>
<div style="position:absolute;left:259.44px;top:274.66px" class="cls_051"><span class="cls_051">Parser Code</span></div>
<div style="position:absolute;left:136.22px;top:283.06px" class="cls_051"><span class="cls_051">Rules</span></div>
<div style="position:absolute;left:199.13px;top:283.25px" class="cls_053"><span class="cls_053">Parser</span></div>
<div style="position:absolute;left:262.94px;top:283.06px" class="cls_051"><span class="cls_051">(</span><span class="cls_052">.java</span><span class="cls_051"> file)</span></div>
<div style="position:absolute;left:134.61px;top:291.46px" class="cls_051"><span class="cls_051">(</span><span class="cls_052">.y</span><span class="cls_051"> file)</span></div>
<div style="position:absolute;left:203.28px;top:292.85px" class="cls_054"><span class="cls_054">(Jay)</span></div>
<div style="position:absolute;left:128.16px;top:365.82px" class="cls_051"><span class="cls_051">Ruby Code</span></div>
<div style="position:absolute;left:415.93px;top:365.82px" class="cls_051"><span class="cls_051">JVM</span></div>
<div style="position:absolute;left:131.76px;top:374.22px" class="cls_051"><span class="cls_051">(</span><span class="cls_052">.rb</span><span class="cls_051"> files)</span></div>
<div style="position:absolute;left:197.30px;top:372.52px" class="cls_053"><span class="cls_053">Tokenize</span></div>
<div style="position:absolute;left:274.40px;top:372.52px" class="cls_053"><span class="cls_053">Parse</span></div>
<div style="position:absolute;left:341.49px;top:372.52px" class="cls_053"><span class="cls_053">Compile</span></div>
<div style="position:absolute;left:409.57px;top:374.22px" class="cls_051"><span class="cls_051">Bytecode</span></div>
<div style="position:absolute;left:238.70px;top:391.31px" class="cls_051"><span class="cls_051">tokens</span></div>
<div style="position:absolute;left:312.97px;top:391.31px" class="cls_051"><span class="cls_051">AST</span></div>
<div style="position:absolute;left:309.96px;top:399.71px" class="cls_051"><span class="cls_051">nodes</span></div>
<div style="position:absolute;left:266.62px;top:414.86px" class="cls_198"><span class="cls_198">Run Time</span></div>
<div style="position:absolute;left:120.00px;top:434.49px" class="cls_038"><span class="cls_038">Figure 10-4: JRuby uses a parser generator called Jay.</span></div>
<div style="position:absolute;left:138.00px;top:456.99px" class="cls_007"><span class="cls_007">Just as MRI uses Bison, JRuby uses a parser generator called </span><span class="cls_008">Jay</span><span class="cls_007"> during</span></div>
<div style="position:absolute;left:120.00px;top:468.99px" class="cls_007"><span class="cls_007">the JRuby build process to create the code that will parse your Ruby code.</span></div>
<div style="position:absolute;left:120.00px;top:480.99px" class="cls_007"><span class="cls_007">Jay is very similar to Bison, except that it’s written in Java instead of C. At</span></div>
<div style="position:absolute;left:120.00px;top:492.99px" class="cls_007"><span class="cls_007">run time, JRuby tokenizes and parses your Ruby code using the generated</span></div>
<div style="position:absolute;left:120.00px;top:504.99px" class="cls_007"><span class="cls_007">parser. As with MRI, this process produces an abstract syntax tree (AST).</span></div>
<div style="position:absolute;left:138.00px;top:516.99px" class="cls_007"><span class="cls_007">Once JRuby parses your code and produces an AST, it compiles your</span></div>
<div style="position:absolute;left:120.00px;top:528.99px" class="cls_007"><span class="cls_007">code. However, instead of producing YARV instructions as MRI does, JRuby</span></div>
<div style="position:absolute;left:120.00px;top:540.99px" class="cls_007"><span class="cls_007">produces a series of instructions, known as </span><span class="cls_008">Java bytecode</span><span class="cls_007"> instructions, that</span></div>
<div style="position:absolute;left:120.00px;top:552.99px" class="cls_007"><span class="cls_007">the JVM can execute. Figure 10-5 shows a high-level comparison of how</span></div>
<div style="position:absolute;left:120.00px;top:564.99px" class="cls_007"><span class="cls_007">MRI and JRuby process your Ruby code.</span></div>
<div style="position:absolute;left:138.00px;top:576.99px" class="cls_007"><span class="cls_007">The left side of the figure shows how your Ruby code changes when you</span></div>
<div style="position:absolute;left:120.00px;top:588.99px" class="cls_007"><span class="cls_007">execute it with MRI. MRI converts your code into tokens, then into AST</span></div>
<div style="position:absolute;left:120.00px;top:600.99px" class="cls_007"><span class="cls_007">nodes, and finally into YARV instructions. The </span><span class="cls_008">Interpret</span><span class="cls_007"> arrow indicates that</span></div>
<div style="position:absolute;left:48.00px;top:633.00px" class="cls_020"><span class="cls_020">254</span></div>
<div style="position:absolute;left:74.54px;top:636.00px" class="cls_021"><span class="cls_021">Chapter 10</span></div>
</div>
<div style="position:absolute;left:50%;margin-left:-252px;top:185224px;width:504px;height:666px;border-style:outset;overflow:hidden">
<div style="position:absolute;left:0px;top:0px">
<img src="e698b76e-46bd-11eb-8b25-0cc47a792c0a_id_e698b76e-46bd-11eb-8b25-0cc47a792c0a_files/background279.jpg" width=504 height=666></div>
<div style="position:absolute;left:123.00px;top:42.28px" class="cls_007"><span class="cls_007">the MRI executable reads the YARV instructions and interprets, or executes,</span></div>
<div style="position:absolute;left:123.00px;top:54.28px" class="cls_007"><span class="cls_007">them. (You don’t write the C or machine language code; that work is done</span></div>
<div style="position:absolute;left:123.00px;top:66.28px" class="cls_007"><span class="cls_007">for you.)</span></div>
<div style="position:absolute;left:152.23px;top:87.45px" class="cls_199"><span class="cls_199">MRI</span></div>
<div style="position:absolute;left:237.18px;top:87.45px" class="cls_199"><span class="cls_199">JRuby</span></div>
<div style="position:absolute;left:151.82px;top:115.17px" class="cls_067"><span class="cls_067">Ruby</span></div>
<div style="position:absolute;left:240.60px;top:115.06px" class="cls_067"><span class="cls_067">Ruby</span></div>
<div style="position:absolute;left:148.71px;top:148.50px" class="cls_067"><span class="cls_067">Tokens</span></div>
<div style="position:absolute;left:237.49px;top:148.40px" class="cls_067"><span class="cls_067">Tokens</span></div>
<div style="position:absolute;left:141.75px;top:181.05px" class="cls_067"><span class="cls_067">AST Nodes</span></div>
<div style="position:absolute;left:230.53px;top:180.94px" class="cls_067"><span class="cls_067">AST Nodes</span></div>
<div style="position:absolute;left:150.78px;top:211.58px" class="cls_067"><span class="cls_067">YARV</span></div>
<div style="position:absolute;left:241.37px;top:211.58px" class="cls_067"><span class="cls_067">Java</span></div>
<div style="position:absolute;left:141.31px;top:221.18px" class="cls_067"><span class="cls_067">Instructions</span></div>
<div style="position:absolute;left:233.87px;top:221.18px" class="cls_067"><span class="cls_067">Bytecode</span></div>
<div style="position:absolute;left:234.77px;top:244.42px" class="cls_067"><span class="cls_067">Machine</span></div>
<div style="position:absolute;left:166.63px;top:248.76px" class="cls_054"><span class="cls_054">Interpret</span></div>
<div style="position:absolute;left:232.47px;top:254.02px" class="cls_067"><span class="cls_067">Language</span></div>
<div style="position:absolute;left:158.21px;top:283.69px" class="cls_067"><span class="cls_067">C</span></div>
<div style="position:absolute;left:145.99px;top:312.46px" class="cls_067"><span class="cls_067">Machine</span></div>
<div style="position:absolute;left:143.69px;top:322.06px" class="cls_067"><span class="cls_067">Language</span></div>
<div style="position:absolute;left:123.00px;top:348.61px" class="cls_038"><span class="cls_038">Figure 10-5: The different forms your Ruby code</span></div>
<div style="position:absolute;left:123.00px;top:359.11px" class="cls_038"><span class="cls_038">takes inside MRI (left) and JRuby (right)</span></div>
<div style="position:absolute;left:141.00px;top:381.61px" class="cls_007"><span class="cls_007">The high-level overview at the right side of the figure shows how JRuby</span></div>
<div style="position:absolute;left:123.00px;top:393.61px" class="cls_007"><span class="cls_007">handles your Ruby code internally. The boxes in the one large rectangle</span></div>
<div style="position:absolute;left:123.00px;top:405.61px" class="cls_007"><span class="cls_007">show the different forms your code takes as JRuby executes it. You can see</span></div>
<div style="position:absolute;left:123.00px;top:417.61px" class="cls_007"><span class="cls_007">that, like MRI, JRuby first converts your code into tokens and later into AST</span></div>
<div style="position:absolute;left:123.00px;top:429.61px" class="cls_007"><span class="cls_007">nodes. But then MRI and JRuby diverge: JRuby compiles the AST nodes</span></div>
<div style="position:absolute;left:123.00px;top:441.61px" class="cls_007"><span class="cls_007">into Java bytecode instructions, which the JVM can execute. In addition,</span></div>
<div style="position:absolute;left:123.00px;top:453.61px" class="cls_007"><span class="cls_007">the JVM can convert the Java bytecode into machine language using a JIT</span></div>
<div style="position:absolute;left:123.00px;top:465.61px" class="cls_007"><span class="cls_007">compiler, which speeds up your program even more because executing</span></div>
<div style="position:absolute;left:123.00px;top:477.61px" class="cls_007"><span class="cls_007">machine language is faster than executing Java bytecode. (We’ll look at the</span></div>
<div style="position:absolute;left:123.00px;top:489.61px" class="cls_007"><span class="cls_007">JIT compiler in more detail in Experiment 10-1.)</span></div>
<div style="position:absolute;left:123.00px;top:514.61px" class="cls_055"><span class="cls_055">How JRuby Executes Your Code</span></div>
<div style="position:absolute;left:123.00px;top:532.61px" class="cls_007"><span class="cls_007">We’ve seen that JRuby tokenizes and parses your code almost the same way</span></div>
<div style="position:absolute;left:123.00px;top:544.61px" class="cls_007"><span class="cls_007">that MRI does. And just as MRI Ruby 1.9 and 2.0 compile your code into</span></div>
<div style="position:absolute;left:123.00px;top:556.61px" class="cls_007"><span class="cls_007">YARV instructions, JRuby compiles it into Java bytecode instructions.</span></div>
<div style="position:absolute;left:141.00px;top:568.61px" class="cls_007"><span class="cls_007">But that’s where the similarity ends: MRI and JRuby use two very differ-</span></div>
<div style="position:absolute;left:123.00px;top:580.61px" class="cls_007"><span class="cls_007">ent virtual machines to execute your code. Standard Ruby uses YARV, but</span></div>
<div style="position:absolute;left:123.00px;top:592.61px" class="cls_007"><span class="cls_007">JRuby uses the JVM to execute your program.</span></div>
<div style="position:absolute;left:368.12px;top:636.00px" class="cls_021"><span class="cls_021">JRuby: Ruby on the JVM</span></div>
<div style="position:absolute;left:442.67px;top:633.00px" class="cls_020"><span class="cls_020">255</span></div>
</div>
<div style="position:absolute;left:50%;margin-left:-252px;top:185900px;width:504px;height:666px;border-style:outset;overflow:hidden">
<div style="position:absolute;left:0px;top:0px">
<img src="e698b76e-46bd-11eb-8b25-0cc47a792c0a_id_e698b76e-46bd-11eb-8b25-0cc47a792c0a_files/background280.jpg" width=504 height=666></div>
<div style="position:absolute;left:138.00px;top:42.28px" class="cls_007"><span class="cls_007">The whole point of building a Ruby interpreter with Java is to be able to</span></div>
<div style="position:absolute;left:120.00px;top:54.28px" class="cls_007"><span class="cls_007">execute Ruby programs using the JVM. The ability to use the JVM is impor-</span></div>
<div style="position:absolute;left:120.00px;top:66.28px" class="cls_007"><span class="cls_007">tant for two reasons:</span></div>
<div style="position:absolute;left:138.00px;top:87.28px" class="cls_034"><span class="cls_034">Environmental</span><span class="cls_007">   The JVM allows you to use Ruby on servers, in appli-</span></div>
<div style="position:absolute;left:138.00px;top:99.28px" class="cls_007"><span class="cls_007">cations, and in IT organizations where previously you could not run</span></div>
<div style="position:absolute;left:138.00px;top:111.28px" class="cls_007"><span class="cls_007">Ruby at all.</span></div>
<div style="position:absolute;left:138.00px;top:129.28px" class="cls_034"><span class="cls_034">Technical</span><span class="cls_007">   The JVM is the product of almost 20 years of intense</span></div>
<div style="position:absolute;left:138.00px;top:141.28px" class="cls_007"><span class="cls_007">research and development. It contains sophisticated solutions for</span></div>
<div style="position:absolute;left:138.00px;top:153.28px" class="cls_007"><span class="cls_007">many difficult computer science problems, like garbage collection</span></div>
<div style="position:absolute;left:138.00px;top:165.28px" class="cls_007"><span class="cls_007">and multithreading. Ruby can often run faster and more reliably on</span></div>
<div style="position:absolute;left:138.00px;top:177.28px" class="cls_007"><span class="cls_007">the JVM.</span></div>
<div style="position:absolute;left:138.00px;top:198.28px" class="cls_007"><span class="cls_007">To get a better sense of how this works, let’s see how JRuby executes the</span></div>
<div style="position:absolute;left:120.00px;top:210.28px" class="cls_007"><span class="cls_007">simple Ruby script </span><span class="cls_008">simple.rb</span><span class="cls_007"> in Listing 10-1.</span></div>
<div style="position:absolute;left:120.00px;top:234.28px" class="cls_030"><span class="cls_030">puts 2+2</span></div>
<div style="position:absolute;left:120.00px;top:256.78px" class="cls_038"><span class="cls_038">Listing 10-1: A one-line Ruby program </span><span class="cls_039">(simple.rb)</span></div>
<div style="position:absolute;left:138.00px;top:279.28px" class="cls_007"><span class="cls_007">First, JRuby tokenizes and parses this Ruby code into an AST node</span></div>
<div style="position:absolute;left:120.00px;top:291.28px" class="cls_007"><span class="cls_007">structure. Next, it iterates through the AST nodes and converts your Ruby</span></div>
<div style="position:absolute;left:120.00px;top:303.28px" class="cls_007"><span class="cls_007">into Java bytecode. Use the </span><span class="cls_030">--bytecode</span><span class="cls_007"> option, as shown in Listing 10-2, to</span></div>
<div style="position:absolute;left:120.00px;top:315.28px" class="cls_007"><span class="cls_007">see this bytecode for yourself.</span></div>
<div style="position:absolute;left:120.00px;top:339.28px" class="cls_030"><span class="cls_030">$ </span><span class="cls_040">jruby --bytecode simple.rb</span></div>
<div style="position:absolute;left:120.00px;top:361.78px" class="cls_038"><span class="cls_038">Listing 10-2: JRuby’s </span><span class="cls_014">--bytecode</span><span class="cls_038"> option displays the Java bytecode your Ruby code is com-</span></div>
<div style="position:absolute;left:120.00px;top:372.28px" class="cls_038"><span class="cls_038">piled into.</span></div>
<div style="position:absolute;left:138.00px;top:394.78px" class="cls_007"><span class="cls_007">As the output of this command is complex, I won’t dig into it here, but</span></div>
<div style="position:absolute;left:120.00px;top:406.78px" class="cls_007"><span class="cls_007">Figure 10-6 summarizes how JRuby compiles and executes this script.</span></div>
<div style="position:absolute;left:138.00px;top:418.78px" class="cls_007"><span class="cls_007">At the left of this figure, you see the code </span><span class="cls_030">puts 2+2</span><span class="cls_007">. The large down-</span></div>
<div style="position:absolute;left:119.99px;top:430.78px" class="cls_007"><span class="cls_007">ward pointing arrow indicates that JRuby converts this code into a series</span></div>
<div style="position:absolute;left:119.99px;top:442.78px" class="cls_007"><span class="cls_007">of Java bytecode instructions that implement a Java class called </span><span class="cls_030">simple</span></div>
<div style="position:absolute;left:120.00px;top:454.78px" class="cls_007"><span class="cls_007">(after the script’s filename). The </span><span class="cls_030">class simple extends AbstractScript</span><span class="cls_007"> nota-</span></div>
<div style="position:absolute;left:120.00px;top:466.78px" class="cls_007"><span class="cls_007">tion is Java code; here, it declares a new Java class called </span><span class="cls_030">simple</span><span class="cls_007">, which uses</span></div>
<div style="position:absolute;left:120.00px;top:478.78px" class="cls_030"><span class="cls_030">AbstractScript</span><span class="cls_007"> as a superclass.</span></div>
<div style="position:absolute;left:138.00px;top:490.78px" class="cls_007"><span class="cls_007">The </span><span class="cls_030">simple</span><span class="cls_007"> class is a Java version of our Ruby code that adds 2 + 2</span></div>
<div style="position:absolute;left:120.00px;top:502.78px" class="cls_007"><span class="cls_007">and prints the sum. The </span><span class="cls_030">simple</span><span class="cls_007"> Java class does the same thing using Java.</span></div>
<div style="position:absolute;left:120.00px;top:514.78px" class="cls_007"><span class="cls_007">Inside </span><span class="cls_030">simple</span><span class="cls_007">, JRuby creates a Java method called </span><span class="cls_030">__file__</span><span class="cls_007"> that executes</span></div>
<div style="position:absolute;left:120.00px;top:526.78px" class="cls_007"><span class="cls_007">the </span><span class="cls_030">2+2</span><span class="cls_007"> code as indicated with the inner </span><span class="cls_030">__file__</span><span class="cls_007"> rectangle at the bot-</span></div>
<div style="position:absolute;left:120.00px;top:538.78px" class="cls_007"><span class="cls_007">tom of the figure. The method rectangle </span><span class="cls_030">&lt;init></span><span class="cls_007"> is the constructor for</span></div>
<div style="position:absolute;left:120.00px;top:550.78px" class="cls_007"><span class="cls_007">the </span><span class="cls_030">simple</span><span class="cls_007"> class.</span></div>
<div style="position:absolute;left:48.00px;top:633.00px" class="cls_020"><span class="cls_020">256</span></div>
<div style="position:absolute;left:74.50px;top:636.00px" class="cls_021"><span class="cls_021">Chapter 10</span></div>
</div>
<div style="position:absolute;left:50%;margin-left:-252px;top:186576px;width:504px;height:666px;border-style:outset;overflow:hidden">
<div style="position:absolute;left:0px;top:0px">
<img src="e698b76e-46bd-11eb-8b25-0cc47a792c0a_id_e698b76e-46bd-11eb-8b25-0cc47a792c0a_files/background281.jpg" width=504 height=666></div>
<div style="position:absolute;left:224.08px;top:48.39px" class="cls_017"><span class="cls_017">Your Code</span></div>
<div style="position:absolute;left:363.38px;top:48.39px" class="cls_017"><span class="cls_017">JRuby Code</span></div>
<div style="position:absolute;left:123.00px;top:82.75px" class="cls_017"><span class="cls_017">Ruby (</span><span class="cls_200">simple.rb</span><span class="cls_017">)</span></div>
<div style="position:absolute;left:204.62px;top:82.45px" class="cls_063"><span class="cls_063">puts 2+2</span></div>
<div style="position:absolute;left:338.95px;top:122.18px" class="cls_014"><span class="cls_014">class RubyFixnum</span></div>
<div style="position:absolute;left:338.95px;top:131.27px" class="cls_014"><span class="cls_014">extends RubyInteger</span></div>
<div style="position:absolute;left:197.96px;top:141.58px" class="cls_014"><span class="cls_014">class simple extends</span></div>
<div style="position:absolute;left:197.96px;top:150.67px" class="cls_014"><span class="cls_014">AbstractScript</span></div>
<div style="position:absolute;left:370.35px;top:160.27px" class="cls_014"><span class="cls_014">op_plus</span></div>
<div style="position:absolute;left:227.46px;top:179.67px" class="cls_014"><span class="cls_014">&lt;init></span></div>
<div style="position:absolute;left:126.83px;top:185.71px" class="cls_017"><span class="cls_017">Java Bytecode</span></div>
<div style="position:absolute;left:338.95px;top:203.58px" class="cls_014"><span class="cls_014">class RubyIO extends</span></div>
<div style="position:absolute;left:223.46px;top:214.49px" class="cls_014"><span class="cls_014">__file__</span></div>
<div style="position:absolute;left:338.95px;top:212.68px" class="cls_014"><span class="cls_014">RubyObject</span></div>
<div style="position:absolute;left:376.35px;top:241.67px" class="cls_014"><span class="cls_014">puts</span></div>
<div style="position:absolute;left:123.00px;top:281.06px" class="cls_038"><span class="cls_038">Figure 10-6: JRuby converts your Ruby code into Java classes.</span></div>
<div style="position:absolute;left:141.00px;top:303.56px" class="cls_007"><span class="cls_007">At the right of Figure 10-6, you see a small part of JRuby’s library of</span></div>
<div style="position:absolute;left:123.00px;top:315.56px" class="cls_007"><span class="cls_007">Ruby classes. These are Ruby’s built-in classes, such as </span><span class="cls_030">Fixnum</span><span class="cls_007">, </span><span class="cls_030">String</span><span class="cls_007">, and</span></div>
<div style="position:absolute;left:123.00px;top:327.56px" class="cls_030"><span class="cls_030">Array</span><span class="cls_007">. MRI implements these classes using C. When your code calls a method</span></div>
<div style="position:absolute;left:123.00px;top:339.56px" class="cls_007"><span class="cls_007">from one of these classes, the method dispatch process uses the CFUNC</span></div>
<div style="position:absolute;left:123.00px;top:351.56px" class="cls_007"><span class="cls_007">method type. However, JRuby implements all of the built-in Ruby classes</span></div>
<div style="position:absolute;left:123.00px;top:363.56px" class="cls_007"><span class="cls_007">using Java code. On the right side of Figure 10-6, you see two built-in Ruby</span></div>
<div style="position:absolute;left:123.00px;top:375.56px" class="cls_007"><span class="cls_007">methods that our code calls.</span></div>
<div style="position:absolute;left:123.00px;top:396.56px" class="cls_050"><span class="cls_050">•</span><span class="cls_007">   First, your code adds 2 + 2, using the </span><span class="cls_030">+</span><span class="cls_007"> method of the Ruby </span><span class="cls_030">Fixnum</span></div>
<div style="position:absolute;left:141.00px;top:408.56px" class="cls_007"><span class="cls_007">class. JRuby implements the Ruby </span><span class="cls_030">Fixnum</span><span class="cls_007"> class using a Java class called</span></div>
<div style="position:absolute;left:141.00px;top:420.56px" class="cls_030"><span class="cls_030">RubyFixnum</span><span class="cls_007">. In this example, your code calls the </span><span class="cls_030">op_plus</span><span class="cls_007"> Java method in</span></div>
<div style="position:absolute;left:141.00px;top:432.56px" class="cls_007"><span class="cls_007">this </span><span class="cls_030">RubyFixnum</span><span class="cls_007"> class.</span></div>
<div style="position:absolute;left:123.00px;top:447.56px" class="cls_050"><span class="cls_050">•</span><span class="cls_007">   To print the sum, the code calls the </span><span class="cls_030">puts</span><span class="cls_007"> method of the built-in Ruby </span><span class="cls_030">IO</span></div>
<div style="position:absolute;left:141.00px;top:459.56px" class="cls_007"><span class="cls_007">class (actually via the </span><span class="cls_030">Kernel</span><span class="cls_007"> module). JRuby implements this in a simi-</span></div>
<div style="position:absolute;left:141.00px;top:471.56px" class="cls_007"><span class="cls_007">lar way, using a Java class called </span><span class="cls_030">RubyIO</span><span class="cls_007">.</span></div>
<div style="position:absolute;left:123.00px;top:505.56px" class="cls_055"><span class="cls_055">Implementing Ruby Classes with Java Classes</span></div>
<div style="position:absolute;left:123.00px;top:523.56px" class="cls_007"><span class="cls_007">As you know, standard Ruby is implemented internally using C, which</span></div>
<div style="position:absolute;left:123.00px;top:535.56px" class="cls_007"><span class="cls_007">doesn’t support the notion of object-oriented programming. C code can’t</span></div>
<div style="position:absolute;left:123.00px;top:547.56px" class="cls_007"><span class="cls_007">use objects, classes, methods, or inheritance the way that Ruby code does.</span></div>
<div style="position:absolute;left:141.00px;top:559.56px" class="cls_007"><span class="cls_007">However, JRuby is implemented in Java, an object-oriented program-</span></div>
<div style="position:absolute;left:123.00px;top:571.56px" class="cls_007"><span class="cls_007">ming language. While not as flexible and powerful as Ruby itself, Java</span></div>
<div style="position:absolute;left:368.17px;top:636.00px" class="cls_021"><span class="cls_021">JRuby: Ruby on the JVM</span></div>
<div style="position:absolute;left:442.72px;top:633.00px" class="cls_020"><span class="cls_020">257</span></div>
</div>
<div style="position:absolute;left:50%;margin-left:-252px;top:187252px;width:504px;height:666px;border-style:outset;overflow:hidden">
<div style="position:absolute;left:0px;top:0px">
<img src="e698b76e-46bd-11eb-8b25-0cc47a792c0a_id_e698b76e-46bd-11eb-8b25-0cc47a792c0a_files/background282.jpg" width=504 height=666></div>
<div style="position:absolute;left:120.00px;top:42.28px" class="cls_007"><span class="cls_007">does support writing classes, creating objects as instances of those classes,</span></div>
<div style="position:absolute;left:120.00px;top:54.28px" class="cls_007"><span class="cls_007">and relating one class to another through inheritance, which means that</span></div>
<div style="position:absolute;left:120.00px;top:66.28px" class="cls_007"><span class="cls_007">JRuby’s implementation of Ruby is also object oriented.</span></div>
<div style="position:absolute;left:138.00px;top:78.28px" class="cls_007"><span class="cls_007">JRuby implements Ruby objects with Java objects. To get a better idea</span></div>
<div style="position:absolute;left:120.00px;top:90.28px" class="cls_007"><span class="cls_007">of what this means, see Figure 10-7, which compares Ruby code with MRI</span></div>
<div style="position:absolute;left:120.00px;top:102.28px" class="cls_007"><span class="cls_007">C structures.</span></div>
<div style="position:absolute;left:181.66px;top:126.57px" class="cls_017"><span class="cls_017">Ruby</span></div>
<div style="position:absolute;left:343.47px;top:126.57px" class="cls_017"><span class="cls_017">C Structures</span></div>
<div style="position:absolute;left:120.00px;top:145.26px" class="cls_063"><span class="cls_063">class </span><span class="cls_160">Mathematician</span></div>
<div style="position:absolute;left:328.02px;top:153.24px" class="cls_042"><span class="cls_042">RClass</span></div>
<div style="position:absolute;left:129.50px;top:158.12px" class="cls_160"><span class="cls_160">attr_accessor</span><span class="cls_063"> :first_name</span></div>
<div style="position:absolute;left:340.65px;top:168.53px" class="cls_014"><span class="cls_014">Mathematician</span></div>
<div style="position:absolute;left:129.50px;top:170.97px" class="cls_160"><span class="cls_160">attr_accessor</span><span class="cls_063"> :last_name</span></div>
<div style="position:absolute;left:120.00px;top:183.82px" class="cls_063"><span class="cls_063">end</span></div>
<div style="position:absolute;left:377.99px;top:198.16px" class="cls_014"><span class="cls_014">klass</span></div>
<div style="position:absolute;left:328.02px;top:219.18px" class="cls_042"><span class="cls_042">RObject</span></div>
<div style="position:absolute;left:120.00px;top:230.48px" class="cls_063"><span class="cls_063">pythagoras = Mathematician.new</span></div>
<div style="position:absolute;left:346.65px;top:234.48px" class="cls_014"><span class="cls_014">pythagoras</span></div>
<div style="position:absolute;left:120.00px;top:265.67px" class="cls_038"><span class="cls_038">Figure 10-7: MRI implements objects and classes using C structures.</span></div>
<div style="position:absolute;left:138.00px;top:291.17px" class="cls_007"><span class="cls_007">Internally Ruby creates an </span><span class="cls_030">RClass</span><span class="cls_007"> C structure for each class and an</span></div>
<div style="position:absolute;left:120.00px;top:303.17px" class="cls_030"><span class="cls_030">RObject</span><span class="cls_007"> structure for each object. Ruby tracks the class for each object using</span></div>
<div style="position:absolute;left:120.00px;top:315.17px" class="cls_007"><span class="cls_007">the </span><span class="cls_030">klass</span><span class="cls_007"> pointer in the </span><span class="cls_030">RObject</span><span class="cls_007"> structure. Figure 10-7 shows one </span><span class="cls_030">RClass</span></div>
<div style="position:absolute;left:120.00px;top:327.17px" class="cls_007"><span class="cls_007">for the </span><span class="cls_030">Mathematician</span><span class="cls_007"> class and one </span><span class="cls_030">RObject</span><span class="cls_007"> for </span><span class="cls_030">pythagoras</span><span class="cls_007">, an instance of</span></div>
<div style="position:absolute;left:120.00px;top:339.17px" class="cls_030"><span class="cls_030">Mathematician</span><span class="cls_007">.</span></div>
<div style="position:absolute;left:138.00px;top:351.17px" class="cls_007"><span class="cls_007">Figure 10-8 shows that the situation is very similar in JRuby, at least at</span></div>
<div style="position:absolute;left:120.00px;top:363.17px" class="cls_007"><span class="cls_007">first glance.</span></div>
<div style="position:absolute;left:181.66px;top:387.46px" class="cls_017"><span class="cls_017">Ruby</span></div>
<div style="position:absolute;left:341.86px;top:387.46px" class="cls_017"><span class="cls_017">Java Objects</span></div>
<div style="position:absolute;left:120.00px;top:409.22px" class="cls_063"><span class="cls_063">class </span><span class="cls_160">Mathematician</span></div>
<div style="position:absolute;left:328.02px;top:413.58px" class="cls_042"><span class="cls_042">RubyClass</span></div>
<div style="position:absolute;left:129.50px;top:422.07px" class="cls_160"><span class="cls_160">attr_accessor</span><span class="cls_063"> :first_name</span></div>
<div style="position:absolute;left:129.50px;top:434.92px" class="cls_160"><span class="cls_160">attr_accessor</span><span class="cls_063"> :last_name</span></div>
<div style="position:absolute;left:340.65px;top:435.37px" class="cls_014"><span class="cls_014">Mathematician</span></div>
<div style="position:absolute;left:120.00px;top:447.77px" class="cls_063"><span class="cls_063">end</span></div>
<div style="position:absolute;left:377.99px;top:464.12px" class="cls_014"><span class="cls_014">metaClass</span></div>
<div style="position:absolute;left:328.02px;top:487.93px" class="cls_042"><span class="cls_042">RubyObject</span></div>
<div style="position:absolute;left:120.00px;top:494.44px" class="cls_063"><span class="cls_063">pythagoras = Mathematician.new</span></div>
<div style="position:absolute;left:346.65px;top:509.72px" class="cls_014"><span class="cls_014">pythagoras</span></div>
<div style="position:absolute;left:120.00px;top:536.56px" class="cls_038"><span class="cls_038">Figure 10-8: Internally, JRuby represents objects using the </span><span class="cls_014">RubyObject</span><span class="cls_038"> Java class</span></div>
<div style="position:absolute;left:120.00px;top:547.06px" class="cls_038"><span class="cls_038">and classes using the </span><span class="cls_014">RubyClass</span><span class="cls_038"> Java class.</span></div>
<div style="position:absolute;left:138.00px;top:572.56px" class="cls_007"><span class="cls_007">On the left side of the figure, we see the same Ruby code. On the</span></div>
<div style="position:absolute;left:120.00px;top:584.56px" class="cls_007"><span class="cls_007">right are two Java objects, one an instance of the </span><span class="cls_030">RubyObject</span><span class="cls_007"> Java class and</span></div>
<div style="position:absolute;left:120.00px;top:596.56px" class="cls_007"><span class="cls_007">the other an instance of the </span><span class="cls_030">RubyClass</span><span class="cls_007"> Java class. JRuby’s implementation</span></div>
<div style="position:absolute;left:48.00px;top:633.00px" class="cls_020"><span class="cls_020">258</span></div>
<div style="position:absolute;left:74.53px;top:636.00px" class="cls_021"><span class="cls_021">Chapter 10</span></div>
</div>
<div style="position:absolute;left:50%;margin-left:-252px;top:187928px;width:504px;height:666px;border-style:outset;overflow:hidden">
<div style="position:absolute;left:0px;top:0px">
<img src="e698b76e-46bd-11eb-8b25-0cc47a792c0a_id_e698b76e-46bd-11eb-8b25-0cc47a792c0a_files/background283.jpg" width=504 height=666></div>
<div style="position:absolute;left:123.00px;top:42.28px" class="cls_007"><span class="cls_007">of Ruby objects and classes closely resembles MRI’s, but JRuby uses Java</span></div>
<div style="position:absolute;left:123.00px;top:54.28px" class="cls_007"><span class="cls_007">objects instead of using C structures. JRuby uses the names </span><span class="cls_030">RubyObject</span><span class="cls_007"> and</span></div>
<div style="position:absolute;left:123.00px;top:66.28px" class="cls_030"><span class="cls_030">RubyClass</span><span class="cls_007"> because these Java objects represent your Ruby object and class.</span></div>
<div style="position:absolute;left:141.00px;top:78.28px" class="cls_007"><span class="cls_007">But when we look a bit closer, things aren’t so straightforward. Because</span></div>
<div style="position:absolute;left:123.00px;top:90.28px" class="cls_030"><span class="cls_030">RubyObject</span><span class="cls_007"> is a Java class, JRuby can use inheritance to simplify its internal</span></div>
<div style="position:absolute;left:123.00px;top:102.28px" class="cls_007"><span class="cls_007">implementation. In fact, the superclass of </span><span class="cls_030">RubyObject</span><span class="cls_007"> is </span><span class="cls_030">RubyBasicObject</span><span class="cls_007">. This</span></div>
<div style="position:absolute;left:123.00px;top:114.28px" class="cls_007"><span class="cls_007">reflects how the Ruby classes are related, as we can see by calling the </span><span class="cls_030">ancestors</span></div>
<div style="position:absolute;left:123.00px;top:126.28px" class="cls_007"><span class="cls_007">method on </span><span class="cls_030">Object</span><span class="cls_007">.</span></div>
<div style="position:absolute;left:123.00px;top:150.28px" class="cls_030"><span class="cls_030">p Object.ancestors</span></div>
<div style="position:absolute;left:127.25px;top:160.78px" class="cls_030"><span class="cls_030">=> [Object, Kernel, BasicObject]</span></div>
<div style="position:absolute;left:141.00px;top:183.28px" class="cls_007"><span class="cls_007">Calling </span><span class="cls_030">ancestors</span><span class="cls_007"> returns an array containing all the classes and modules</span></div>
<div style="position:absolute;left:123.00px;top:195.28px" class="cls_007"><span class="cls_007">in the superclass chain for the receiver. Here, we see that </span><span class="cls_030">Object</span><span class="cls_007">’s superclass</span></div>
<div style="position:absolute;left:123.00px;top:207.28px" class="cls_007"><span class="cls_007">is the </span><span class="cls_030">Kernel</span><span class="cls_007"> module and its superclass is </span><span class="cls_030">BasicObject</span><span class="cls_007">. JRuby uses the same</span></div>
<div style="position:absolute;left:123.00px;top:219.28px" class="cls_007"><span class="cls_007">pattern for its internal Java class hierarchy, as shown in Figure 10-9.</span></div>
<div style="position:absolute;left:130.57px;top:249.30px" class="cls_014"><span class="cls_014">public class RubyBasicObject</span></div>
<div style="position:absolute;left:130.57px;top:276.51px" class="cls_014"><span class="cls_014">public class RubyObject extends RubyBasicObject</span></div>
<div style="position:absolute;left:123.00px;top:304.64px" class="cls_038"><span class="cls_038">Figure 10-9: </span><span class="cls_014">RubyBasicObject</span><span class="cls_038"> is the superclass of the </span><span class="cls_014">RubyObject</span></div>
<div style="position:absolute;left:123.00px;top:315.14px" class="cls_038"><span class="cls_038">Java class.</span></div>
<div style="position:absolute;left:141.00px;top:337.64px" class="cls_007"><span class="cls_007">The </span><span class="cls_030">Kernel</span><span class="cls_007"> module aside, we can see that JRuby’s internal Java class</span></div>
<div style="position:absolute;left:123.00px;top:349.64px" class="cls_007"><span class="cls_007">hierarchy reflects the Ruby class hierarchy that it implements. This similar-</span></div>
<div style="position:absolute;left:123.00px;top:361.64px" class="cls_007"><span class="cls_007">ity is made possible by Java’s object-oriented design.</span></div>
<div style="position:absolute;left:141.00px;top:373.64px" class="cls_007"><span class="cls_007">Now for a second example. Let’s use </span><span class="cls_030">ancestors</span><span class="cls_007"> again to show the super-</span></div>
<div style="position:absolute;left:123.01px;top:385.64px" class="cls_007"><span class="cls_007">classes for the </span><span class="cls_030">Class</span><span class="cls_007"> Ruby class.</span></div>
<div style="position:absolute;left:123.00px;top:409.64px" class="cls_030"><span class="cls_030">p Class.ancestors</span></div>
<div style="position:absolute;left:127.25px;top:420.14px" class="cls_030"><span class="cls_030">=> [Class, Module, Object, Kernel, BasicObject]</span></div>
<div style="position:absolute;left:141.00px;top:442.64px" class="cls_007"><span class="cls_007">Here, we see that the superclass of </span><span class="cls_030">Class</span><span class="cls_007"> is </span><span class="cls_030">Module</span><span class="cls_007">, its superclass is </span><span class="cls_030">Object</span><span class="cls_007">,</span></div>
<div style="position:absolute;left:123.00px;top:454.64px" class="cls_007"><span class="cls_007">and so on. And as we would expect, JRuby’s Java code uses the same design</span></div>
<div style="position:absolute;left:123.00px;top:466.64px" class="cls_007"><span class="cls_007">internally (see Figure 10-10).</span></div>
<div style="position:absolute;left:130.57px;top:496.67px" class="cls_014"><span class="cls_014">public class RubyBasicObject</span></div>
<div style="position:absolute;left:130.57px;top:523.88px" class="cls_014"><span class="cls_014">public class RubyObject extends RubyBasicObject</span></div>
<div style="position:absolute;left:130.57px;top:551.08px" class="cls_014"><span class="cls_014">public class RubyModule extends RubyObject</span></div>
<div style="position:absolute;left:130.57px;top:578.29px" class="cls_014"><span class="cls_014">public class RubyClass extends RubyModule</span></div>
<div style="position:absolute;left:123.00px;top:606.05px" class="cls_038"><span class="cls_038">Figure 10-10: JRuby’s internal Java class hierarchy for </span><span class="cls_014">RubyClass</span></div>
<div style="position:absolute;left:368.07px;top:636.00px" class="cls_021"><span class="cls_021">JRuby: Ruby on the JVM</span></div>
<div style="position:absolute;left:442.62px;top:633.00px" class="cls_020"><span class="cls_020">259</span></div>
</div>
<div style="position:absolute;left:50%;margin-left:-252px;top:188604px;width:504px;height:666px;border-style:outset;overflow:hidden">
<div style="position:absolute;left:0px;top:0px">
<img src="e698b76e-46bd-11eb-8b25-0cc47a792c0a_id_e698b76e-46bd-11eb-8b25-0cc47a792c0a_files/background284.jpg" width=504 height=666></div>
<div style="position:absolute;left:120.00px;top:42.63px" class="cls_031"><span class="cls_031">Experiment 10-1: Monitoring JRuby’s Just-in-Time</span></div>
<div style="position:absolute;left:120.00px;top:57.63px" class="cls_031"><span class="cls_031">Compiler</span></div>
<div style="position:absolute;left:120.00px;top:77.63px" class="cls_007"><span class="cls_007">I mentioned earlier that JRuby can speed up your Ruby code by using a JIT</span></div>
<div style="position:absolute;left:120.00px;top:89.63px" class="cls_007"><span class="cls_007">compiler. JRuby always translates your Ruby program into Java bytecode</span></div>
<div style="position:absolute;left:120.00px;top:101.63px" class="cls_007"><span class="cls_007">instructions, which the JVM can compile into machine language that your</span></div>
<div style="position:absolute;left:120.00px;top:113.63px" class="cls_007"><span class="cls_007">computer’s microprocessor can execute directly. In this experiment we’ll</span></div>
<div style="position:absolute;left:120.00px;top:125.63px" class="cls_007"><span class="cls_007">see when this happens and measure how much it speeds up your code.</span></div>
<div style="position:absolute;left:120.00px;top:150.63px" class="cls_055"><span class="cls_055">Experiment Code</span></div>
<div style="position:absolute;left:120.00px;top:168.63px" class="cls_007"><span class="cls_007">Listing 10-3 shows a Ruby program that prints out 10 random numbers</span></div>
<div style="position:absolute;left:120.00px;top:180.63px" class="cls_007"><span class="cls_007">between 1 and 100.</span></div>
<div style="position:absolute;left:108.15px;top:204.63px" class="cls_046"><span class="cls_046">u</span><span class="cls_030"> array = (1..100).to_a</span></div>
<div style="position:absolute;left:108.15px;top:215.12px" class="cls_046"><span class="cls_046">v</span><span class="cls_030"> 10.times do</span></div>
<div style="position:absolute;left:108.15px;top:225.62px" class="cls_046"><span class="cls_046">w</span><span class="cls_030">   sample = array.sample</span></div>
<div style="position:absolute;left:128.50px;top:236.12px" class="cls_030"><span class="cls_030">puts sample</span></div>
<div style="position:absolute;left:120.00px;top:246.62px" class="cls_030"><span class="cls_030">end</span></div>
<div style="position:absolute;left:120.00px;top:269.11px" class="cls_038"><span class="cls_038">Listing 10-3: A sample program for testing JRuby’s JIT behavior </span><span class="cls_039">(jit.rb)</span></div>
<div style="position:absolute;left:138.00px;top:291.63px" class="cls_007"><span class="cls_007">At </span><span class="cls_050">u</span><span class="cls_007"> we create an array with 100 elements: 1 through 100. Then, at </span><span class="cls_050">v</span></div>
<div style="position:absolute;left:120.00px;top:303.63px" class="cls_007"><span class="cls_007">we iterate over the following block 10 times. Inside this block, we use the</span></div>
<div style="position:absolute;left:120.00px;top:315.63px" class="cls_030"><span class="cls_030">sample</span><span class="cls_007"> method at </span><span class="cls_050">w</span><span class="cls_007"> to pick a random value from the array and print it.</span></div>
<div style="position:absolute;left:120.00px;top:327.63px" class="cls_007"><span class="cls_007">When we run this code, we get the output shown in Listing 10-4.</span></div>
<div style="position:absolute;left:120.00px;top:351.63px" class="cls_030"><span class="cls_030">$ </span><span class="cls_040">jruby jit.rb</span></div>
<div style="position:absolute;left:120.00px;top:362.12px" class="cls_030"><span class="cls_030">87</span></div>
<div style="position:absolute;left:120.00px;top:372.62px" class="cls_030"><span class="cls_030">88</span></div>
<div style="position:absolute;left:120.00px;top:383.12px" class="cls_030"><span class="cls_030">69</span></div>
<div style="position:absolute;left:120.00px;top:393.62px" class="cls_030"><span class="cls_030">5</span></div>
<div style="position:absolute;left:120.00px;top:404.11px" class="cls_030"><span class="cls_030">38</span></div>
<div style="position:absolute;left:120.00px;top:414.61px" class="cls_030"><span class="cls_030">--snip--</span></div>
<div style="position:absolute;left:120.00px;top:437.11px" class="cls_038"><span class="cls_038">Listing 10-4: The output from Listing 10-3</span></div>
<div style="position:absolute;left:138.00px;top:459.63px" class="cls_007"><span class="cls_007">Now let’s remove the </span><span class="cls_030">puts</span><span class="cls_007"> statement and increase the number of itera-</span></div>
<div style="position:absolute;left:120.00px;top:471.63px" class="cls_007"><span class="cls_007">tions. (Removing the output will make the experiment more manageable.)</span></div>
<div style="position:absolute;left:120.00px;top:483.63px" class="cls_007"><span class="cls_007">Listing 10-5 shows the updated program.</span></div>
<div style="position:absolute;left:120.00px;top:507.63px" class="cls_030"><span class="cls_030">array = (1..100).to_a</span></div>
<div style="position:absolute;left:120.00px;top:518.12px" class="cls_030"><span class="cls_030">1000.times do</span></div>
<div style="position:absolute;left:108.15px;top:528.62px" class="cls_046"><span class="cls_046">u</span><span class="cls_030">   sample = array.sample</span></div>
<div style="position:absolute;left:120.00px;top:539.12px" class="cls_030"><span class="cls_030">end</span></div>
<div style="position:absolute;left:120.00px;top:561.62px" class="cls_038"><span class="cls_038">Listing 10-5: We remove </span><span class="cls_014">puts</span><span class="cls_038"> and increase the number of iterations to 1,000.</span></div>
<div style="position:absolute;left:48.00px;top:633.00px" class="cls_020"><span class="cls_020">260</span></div>
<div style="position:absolute;left:74.55px;top:636.00px" class="cls_021"><span class="cls_021">Chapter 10</span></div>
</div>
<div style="position:absolute;left:50%;margin-left:-252px;top:189280px;width:504px;height:666px;border-style:outset;overflow:hidden">
<div style="position:absolute;left:0px;top:0px">
<img src="e698b76e-46bd-11eb-8b25-0cc47a792c0a_id_e698b76e-46bd-11eb-8b25-0cc47a792c0a_files/background285.jpg" width=504 height=666></div>
<div style="position:absolute;left:123.00px;top:42.55px" class="cls_055"><span class="cls_055">Using the -J-XX:+PrintCompilation Option</span></div>
<div style="position:absolute;left:123.00px;top:60.55px" class="cls_007"><span class="cls_007">Of course, if we run the program now, we won’t see any output because</span></div>
<div style="position:absolute;left:123.00px;top:72.55px" class="cls_007"><span class="cls_007">we’ve removed </span><span class="cls_030">puts</span><span class="cls_007">. Let’s run the program again—this time using a debug</span></div>
<div style="position:absolute;left:123.00px;top:84.55px" class="cls_007"><span class="cls_007">flag (shown in Listing 10-6) to display information about what the JVM’s</span></div>
<div style="position:absolute;left:123.00px;top:96.55px" class="cls_007"><span class="cls_007">JIT compiler is doing.</span></div>
<div style="position:absolute;left:123.00px;top:120.55px" class="cls_030"><span class="cls_030">$ </span><span class="cls_040">jruby -J-XX:+PrintCompilation jit.rb</span></div>
<div style="position:absolute;left:140.00px;top:131.04px" class="cls_030"><span class="cls_030">101</span></div>
<div style="position:absolute;left:165.50px;top:131.04px" class="cls_030"><span class="cls_030">1</span></div>
<div style="position:absolute;left:199.50px;top:131.04px" class="cls_030"><span class="cls_030">java.lang.String::hashCode (64 bytes)</span></div>
<div style="position:absolute;left:140.00px;top:141.54px" class="cls_030"><span class="cls_030">144</span></div>
<div style="position:absolute;left:165.50px;top:141.54px" class="cls_030"><span class="cls_030">2</span></div>
<div style="position:absolute;left:199.50px;top:141.54px" class="cls_030"><span class="cls_030">java.util.Properties$LineReader::readLine (452 bytes)</span></div>
<div style="position:absolute;left:140.00px;top:152.04px" class="cls_030"><span class="cls_030">173</span></div>
<div style="position:absolute;left:165.50px;top:152.04px" class="cls_030"><span class="cls_030">3</span></div>
<div style="position:absolute;left:199.50px;top:152.04px" class="cls_030"><span class="cls_030">sun.nio.cs.UTF_8$Decoder::decodeArrayLoop (553 bytes)</span></div>
<div style="position:absolute;left:140.00px;top:162.54px" class="cls_030"><span class="cls_030">200</span></div>
<div style="position:absolute;left:165.50px;top:162.54px" class="cls_030"><span class="cls_030">4</span></div>
<div style="position:absolute;left:199.50px;top:162.54px" class="cls_030"><span class="cls_030">java.lang.String::charAt (33 bytes)</span></div>
<div style="position:absolute;left:123.00px;top:173.03px" class="cls_030"><span class="cls_030">--snip--</span></div>
<div style="position:absolute;left:123.00px;top:195.53px" class="cls_038"><span class="cls_038">Listing 10-6: The output generated by the </span><span class="cls_014">-J-XX:+PrintCompilation</span><span class="cls_038"> option</span></div>
<div style="position:absolute;left:141.00px;top:218.05px" class="cls_007"><span class="cls_007">Here, we use the </span><span class="cls_030">-J</span><span class="cls_007"> option for JRuby and pass the </span><span class="cls_030">XX:+PrintCompilation</span></div>
<div style="position:absolute;left:123.00px;top:230.05px" class="cls_007"><span class="cls_007">option to the underlying JVM application. </span><span class="cls_030">PrintCompilation</span><span class="cls_007"> causes the</span></div>
<div style="position:absolute;left:123.00px;top:242.05px" class="cls_007"><span class="cls_007">JVM to display the information you see in Listing 10-6. The line </span><span class="cls_030">java.lang</span></div>
<div style="position:absolute;left:123.00px;top:254.05px" class="cls_030"><span class="cls_030">.String::hashCode</span><span class="cls_007"> means that the JVM compiled the </span><span class="cls_030">hashCode</span><span class="cls_007"> method of the</span></div>
<div style="position:absolute;left:123.00px;top:266.05px" class="cls_030"><span class="cls_030">String</span><span class="cls_007"> Java class into machine language. The other values show technical</span></div>
<div style="position:absolute;left:123.00px;top:278.05px" class="cls_007"><span class="cls_007">information about the JIT process (</span><span class="cls_030">101</span><span class="cls_007"> is a time stamp, </span><span class="cls_030">1</span><span class="cls_007"> is a compilation</span></div>
<div style="position:absolute;left:123.00px;top:290.05px" class="cls_007"><span class="cls_007">ID, and </span><span class="cls_030">64 bytes</span><span class="cls_007"> is the size of the bytecode snippet that was compiled).</span></div>
<div style="position:absolute;left:141.00px;top:302.05px" class="cls_007"><span class="cls_007">The goal of this experiment is to validate the hypothesis that Listing 10-5</span></div>
<div style="position:absolute;left:123.00px;top:314.05px" class="cls_007"><span class="cls_007">should run faster once the JVM’s JIT compiler converts it into machine</span></div>
<div style="position:absolute;left:123.00px;top:326.05px" class="cls_007"><span class="cls_007">language. Notice that Listing 10-5 has just one line of Ruby code inside the</span></div>
<div style="position:absolute;left:123.00px;top:338.05px" class="cls_007"><span class="cls_007">loop at </span><span class="cls_050">u</span><span class="cls_007"> that calls </span><span class="cls_030">array.sample</span><span class="cls_007">. Therefore, we should expect our Ruby pro-</span></div>
<div style="position:absolute;left:123.00px;top:350.05px" class="cls_007"><span class="cls_007">gram to finish noticeably faster once the JIT compiles JRuby’s implementa-</span></div>
<div style="position:absolute;left:123.00px;top:362.05px" class="cls_007"><span class="cls_007">tion of </span><span class="cls_030">Array#sample</span><span class="cls_007"> into machine language because </span><span class="cls_030">Array#sample</span><span class="cls_007"> is called so</span></div>
<div style="position:absolute;left:123.00px;top:374.05px" class="cls_007"><span class="cls_007">many times.</span></div>
<div style="position:absolute;left:141.00px;top:386.05px" class="cls_007"><span class="cls_007">Because the output in Listing 10-6 is quite long and complex, we’ll use</span></div>
<div style="position:absolute;left:123.00px;top:398.05px" class="cls_030"><span class="cls_030">grep</span><span class="cls_007"> to search the output for occurrences of </span><span class="cls_030">org.jruby.RubyArray</span><span class="cls_007">.</span></div>
<div style="position:absolute;left:123.00px;top:422.05px" class="cls_030"><span class="cls_030">$ </span><span class="cls_040">jruby -J-XX:+PrintCompilation jit.rb | grep org.jruby.RubyArray</span></div>
<div style="position:absolute;left:141.00px;top:444.55px" class="cls_007"><span class="cls_007">The result is no output. None of the lines in the </span><span class="cls_030">PrintCompilation</span><span class="cls_007"> output</span></div>
<div style="position:absolute;left:123.00px;top:456.55px" class="cls_007"><span class="cls_007">match the name </span><span class="cls_030">org.jruby.RubyArray</span><span class="cls_007">, which means the JIT compiler is not</span></div>
<div style="position:absolute;left:123.00px;top:468.55px" class="cls_007"><span class="cls_007">converting the </span><span class="cls_030">Array#sample</span><span class="cls_007"> method into machine language. It doesn’t do</span></div>
<div style="position:absolute;left:123.00px;top:480.55px" class="cls_007"><span class="cls_007">this conversion because the JVM only runs the JIT compiler to compile Java</span></div>
<div style="position:absolute;left:123.00px;top:492.55px" class="cls_007"><span class="cls_007">bytecode instructions that your program executes numerous times—areas</span></div>
<div style="position:absolute;left:123.00px;top:504.55px" class="cls_007"><span class="cls_007">of bytecode instructions known as </span><span class="cls_008">hot spots</span><span class="cls_007">. The JVM spends extra time</span></div>
<div style="position:absolute;left:123.00px;top:516.55px" class="cls_007"><span class="cls_007">compiling hot spots because they are called so many times. To prove this,</span></div>
<div style="position:absolute;left:123.00px;top:528.55px" class="cls_007"><span class="cls_007">we can increase the number of iterations to 100,000 and repeat our test, as</span></div>
<div style="position:absolute;left:123.00px;top:540.55px" class="cls_007"><span class="cls_007">shown in Listing 10-7.</span></div>
<div style="position:absolute;left:123.00px;top:564.55px" class="cls_030"><span class="cls_030">array = (1..100).to_a</span></div>
<div style="position:absolute;left:123.00px;top:575.04px" class="cls_030"><span class="cls_030">100000.times do</span></div>
<div style="position:absolute;left:368.50px;top:636.00px" class="cls_021"><span class="cls_021">JRuby: Ruby on the JVM</span></div>
<div style="position:absolute;left:443.05px;top:633.00px" class="cls_020"><span class="cls_020">261</span></div>
</div>
<div style="position:absolute;left:50%;margin-left:-252px;top:189956px;width:504px;height:666px;border-style:outset;overflow:hidden">
<div style="position:absolute;left:0px;top:0px">
<img src="e698b76e-46bd-11eb-8b25-0cc47a792c0a_id_e698b76e-46bd-11eb-8b25-0cc47a792c0a_files/background286.jpg" width=504 height=666></div>
<div style="position:absolute;left:128.50px;top:42.82px" class="cls_030"><span class="cls_030">sample = array.sample</span></div>
<div style="position:absolute;left:120.00px;top:53.31px" class="cls_030"><span class="cls_030">end</span></div>
<div style="position:absolute;left:120.00px;top:75.81px" class="cls_038"><span class="cls_038">Listing 10-7: Increasing the number of iterations should trigger the JIT compiler to convert</span></div>
<div style="position:absolute;left:120.00px;top:86.32px" class="cls_014"><span class="cls_014">Array#sample</span><span class="cls_038"> to machine language.</span></div>
<div style="position:absolute;left:138.00px;top:108.82px" class="cls_007"><span class="cls_007">When we repeat the same </span><span class="cls_030">jruby</span><span class="cls_007"> command again with </span><span class="cls_030">grep</span><span class="cls_007">, we see the</span></div>
<div style="position:absolute;left:120.00px;top:120.82px" class="cls_007"><span class="cls_007">output shown in Listing 10-8.</span></div>
<div style="position:absolute;left:108.15px;top:144.82px" class="cls_046"><span class="cls_046">u</span><span class="cls_030"> $ </span><span class="cls_040">jruby -J-XX:+PrintCompilation jit.rb | grep org.jruby.RubyArray</span></div>
<div style="position:absolute;left:132.75px;top:155.31px" class="cls_030"><span class="cls_030">1809 165</span></div>
<div style="position:absolute;left:196.50px;top:155.31px" class="cls_030"><span class="cls_030">org.jruby.RubyArray::safeArrayRef (11 bytes)</span></div>
<div style="position:absolute;left:132.75px;top:165.81px" class="cls_030"><span class="cls_030">1810 166</span></div>
<div style="position:absolute;left:175.25px;top:165.81px" class="cls_030"><span class="cls_030">!</span></div>
<div style="position:absolute;left:196.50px;top:165.81px" class="cls_030"><span class="cls_030">org.jruby.RubyArray::safeArrayRef (12 bytes)</span></div>
<div style="position:absolute;left:132.75px;top:176.31px" class="cls_030"><span class="cls_030">1811 167</span></div>
<div style="position:absolute;left:196.50px;top:176.31px" class="cls_030"><span class="cls_030">org.jruby.RubyArray::eltOk (16 bytes)</span></div>
<div style="position:absolute;left:132.75px;top:186.81px" class="cls_030"><span class="cls_030">1927 203</span></div>
<div style="position:absolute;left:196.50px;top:186.81px" class="cls_030"><span class="cls_030">org.jruby.RubyArray$INVOKER$i$0$2</span></div>
<div style="position:absolute;left:336.75px;top:186.81px" class="cls_030"><span class="cls_030">$sample::call (36 bytes)</span></div>
<div style="position:absolute;left:108.15px;top:197.30px" class="cls_046"><span class="cls_046">v</span></div>
<div style="position:absolute;left:132.73px;top:197.30px" class="cls_030"><span class="cls_030">1928 204</span></div>
<div style="position:absolute;left:175.23px;top:197.30px" class="cls_030"><span class="cls_030">!</span></div>
<div style="position:absolute;left:196.48px;top:197.30px" class="cls_030"><span class="cls_030">org.jruby.RubyArray::sample (834 bytes)</span></div>
<div style="position:absolute;left:132.75px;top:207.80px" class="cls_030"><span class="cls_030">1930 205</span></div>
<div style="position:absolute;left:196.50px;top:207.80px" class="cls_030"><span class="cls_030">org.jruby.RubyArray::randomReal (10 bytes)</span></div>
<div style="position:absolute;left:120.00px;top:230.30px" class="cls_038"><span class="cls_038">Listing 10-8: The output after running Listing 10-7 with </span><span class="cls_014">-J-XX:+PrintCompilation</span><span class="cls_038"> piped</span></div>
<div style="position:absolute;left:120.00px;top:240.81px" class="cls_038"><span class="cls_038">to </span><span class="cls_014">grep</span></div>
<div style="position:absolute;left:138.00px;top:263.32px" class="cls_007"><span class="cls_007">Because we used </span><span class="cls_030">grep org.jruby.RubyArray</span><span class="cls_007"> at </span><span class="cls_050">u</span><span class="cls_007">, we see only Java class</span></div>
<div style="position:absolute;left:120.01px;top:275.32px" class="cls_007"><span class="cls_007">names that match the text </span><span class="cls_030">org.jruby.RubyArray</span><span class="cls_007">. At </span><span class="cls_050">v</span><span class="cls_007"> we can see that the</span></div>
<div style="position:absolute;left:120.00px;top:287.32px" class="cls_007"><span class="cls_007">JIT compiler compiled the </span><span class="cls_030">Array#sample</span><span class="cls_007"> method because we see the text</span></div>
<div style="position:absolute;left:120.00px;top:299.32px" class="cls_030"><span class="cls_030">org.jruby.RubyArray::sample</span><span class="cls_007">.</span></div>
<div style="position:absolute;left:120.00px;top:324.32px" class="cls_055"><span class="cls_055">Does JIT Speed Up Your JRuby Program?</span></div>
<div style="position:absolute;left:120.00px;top:342.32px" class="cls_007"><span class="cls_007">Now to see if the JIT sped things up. Based on a command-line parameter—</span></div>
<div style="position:absolute;left:120.00px;top:354.32px" class="cls_030"><span class="cls_030">ARGV[0]</span><span class="cls_007">—which I save in </span><span class="cls_030">iterations</span><span class="cls_007"> at </span><span class="cls_050">u</span><span class="cls_007">, Listing 10-9 measures the amount</span></div>
<div style="position:absolute;left:120.00px;top:366.32px" class="cls_007"><span class="cls_007">of time it takes to call </span><span class="cls_030">Array#sample</span><span class="cls_007"> a given number of times.</span></div>
<div style="position:absolute;left:120.00px;top:390.32px" class="cls_030"><span class="cls_030">require 'benchmark'</span></div>
<div style="position:absolute;left:108.15px;top:411.32px" class="cls_046"><span class="cls_046">u</span><span class="cls_030"> iterations = ARGV[0].to_i</span></div>
<div style="position:absolute;left:120.00px;top:432.32px" class="cls_030"><span class="cls_030">Benchmark.bm do |bench|</span></div>
<div style="position:absolute;left:128.50px;top:442.82px" class="cls_030"><span class="cls_030">array = (1..100).to_a</span></div>
<div style="position:absolute;left:128.50px;top:453.32px" class="cls_030"><span class="cls_030">bench.report("#{iterations} iterations") do</span></div>
<div style="position:absolute;left:137.00px;top:463.82px" class="cls_030"><span class="cls_030">iterations.times do</span></div>
<div style="position:absolute;left:145.50px;top:474.31px" class="cls_030"><span class="cls_030">sample = array.sample</span></div>
<div style="position:absolute;left:137.00px;top:484.81px" class="cls_030"><span class="cls_030">end</span></div>
<div style="position:absolute;left:128.50px;top:495.31px" class="cls_030"><span class="cls_030">end</span></div>
<div style="position:absolute;left:120.00px;top:505.80px" class="cls_030"><span class="cls_030">end</span></div>
<div style="position:absolute;left:120.00px;top:528.30px" class="cls_038"><span class="cls_038">Listing 10-9: Sample code for benchmarking JIT performance</span></div>
<div style="position:absolute;left:138.00px;top:550.82px" class="cls_007"><span class="cls_007">By running this listing as shown below, we can measure how long it</span></div>
<div style="position:absolute;left:120.00px;top:562.82px" class="cls_007"><span class="cls_007">takes to execute the loop 100 times, for example.</span></div>
<div style="position:absolute;left:120.00px;top:586.82px" class="cls_030"><span class="cls_030">$ </span><span class="cls_040">jruby jit.rb 100</span></div>
<div style="position:absolute;left:48.00px;top:633.00px" class="cls_020"><span class="cls_020">262</span></div>
<div style="position:absolute;left:74.20px;top:636.00px" class="cls_021"><span class="cls_021">Chapter 10</span></div>
</div>
<div style="position:absolute;left:50%;margin-left:-252px;top:190632px;width:504px;height:666px;border-style:outset;overflow:hidden">
<div style="position:absolute;left:0px;top:0px">
<img src="e698b76e-46bd-11eb-8b25-0cc47a792c0a_id_e698b76e-46bd-11eb-8b25-0cc47a792c0a_files/background287.jpg" width=504 height=666></div>
<div style="position:absolute;left:141.00px;top:42.28px" class="cls_007"><span class="cls_007">Figure 10-11 shows the results for 100 to 100 million iterations using</span></div>
<div style="position:absolute;left:123.00px;top:54.28px" class="cls_007"><span class="cls_007">both JRuby and MRI.</span></div>
<div style="position:absolute;left:140.27px;top:75.96px" class="cls_202"><span class="cls_202">100</span></div>
<div style="position:absolute;left:143.86px;top:109.27px" class="cls_202"><span class="cls_202">10</span></div>
<div style="position:absolute;left:148.04px;top:143.23px" class="cls_203"><span class="cls_203">1</span></div>
<div style="position:absolute;left:142.06px;top:175.25px" class="cls_202"><span class="cls_202">0.1</span></div>
<div style="position:absolute;left:219.78px;top:189.68px" class="cls_135"><span class="cls_135">JRuby</span></div>
<div style="position:absolute;left:138.48px;top:208.25px" class="cls_202"><span class="cls_202">0.01</span></div>
<div style="position:absolute;left:134.89px;top:241.55px" class="cls_202"><span class="cls_202">0.001</span></div>
<div style="position:absolute;left:238.01px;top:265.40px" class="cls_135"><span class="cls_135">MRI</span></div>
<div style="position:absolute;left:131.30px;top:274.55px" class="cls_202"><span class="cls_202">0.0001</span></div>
<div style="position:absolute;left:186.26px;top:312.59px" class="cls_202"><span class="cls_202">100</span></div>
<div style="position:absolute;left:221.67px;top:312.59px" class="cls_202"><span class="cls_202">1,000</span></div>
<div style="position:absolute;left:256.98px;top:312.59px" class="cls_202"><span class="cls_202">10,000</span></div>
<div style="position:absolute;left:292.93px;top:312.59px" class="cls_202"><span class="cls_202">100,000</span></div>
<div style="position:absolute;left:331.99px;top:312.59px" class="cls_202"><span class="cls_202">1 million</span></div>
<div style="position:absolute;left:366.99px;top:312.59px" class="cls_202"><span class="cls_202">10 million</span></div>
<div style="position:absolute;left:403.26px;top:312.59px" class="cls_202"><span class="cls_202">100 million</span></div>
<div style="position:absolute;left:281.61px;top:327.85px" class="cls_135"><span class="cls_135">Iterations</span></div>
<div style="position:absolute;left:123.00px;top:344.63px" class="cls_038"><span class="cls_038">Figure 10-11: JRuby vs. MRI performance. Time is shown in seconds vs. number of</span></div>
<div style="position:absolute;left:123.00px;top:355.13px" class="cls_038"><span class="cls_038">iterations (using JRuby 1.7.5 and Java 1.6; MRI Ruby 2.0).</span></div>
<div style="position:absolute;left:141.00px;top:377.63px" class="cls_007"><span class="cls_007">The graph for MRI is more or less a straight line moving up to the</span></div>
<div style="position:absolute;left:123.00px;top:389.63px" class="cls_007"><span class="cls_007">right. This means it always takes Ruby 2.0 about the same amount of time</span></div>
<div style="position:absolute;left:123.00px;top:401.63px" class="cls_007"><span class="cls_007">to execute the </span><span class="cls_030">Array#sample</span><span class="cls_007"> method. The results for JRuby, however, are not</span></div>
<div style="position:absolute;left:123.00px;top:413.63px" class="cls_007"><span class="cls_007">so simple. At left you can see that for fewer than 100,000 iterations, JRuby</span></div>
<div style="position:absolute;left:123.00px;top:425.63px" class="cls_007"><span class="cls_007">takes longer to execute Listing 10-9. (The chart uses a logarithmic scale, so</span></div>
<div style="position:absolute;left:123.00px;top:437.63px" class="cls_007"><span class="cls_007">the absolute time differences on the left side are small.) However, once we</span></div>
<div style="position:absolute;left:123.00px;top:449.63px" class="cls_007"><span class="cls_007">reach about 1 million iterations, JRuby speeds up dramatically and starts to</span></div>
<div style="position:absolute;left:123.00px;top:461.63px" class="cls_007"><span class="cls_007">take less time to execute </span><span class="cls_030">Array#sample</span><span class="cls_007">.</span></div>
<div style="position:absolute;left:141.00px;top:473.63px" class="cls_007"><span class="cls_007">Ultimately for many, many iterations, JRuby is faster than MRI. But</span></div>
<div style="position:absolute;left:123.00px;top:485.63px" class="cls_007"><span class="cls_007">what’s important here is not simply that JRuby might be faster but that its</span></div>
<div style="position:absolute;left:123.00px;top:497.63px" class="cls_007"><span class="cls_007">performance characteristics vary. The longer your code runs, the longer the</span></div>
<div style="position:absolute;left:123.00px;top:509.63px" class="cls_007"><span class="cls_007">JVM has to optimize it, and the faster things will be.</span></div>
<div style="position:absolute;left:69.00px;top:543.63px" class="cls_031"><span class="cls_031">Strings in JRuby and MRI</span></div>
<div style="position:absolute;left:123.00px;top:563.63px" class="cls_007"><span class="cls_007">We’ve learned how JRuby executes bytecode instructions, passing control</span></div>
<div style="position:absolute;left:123.00px;top:575.63px" class="cls_007"><span class="cls_007">between your code and a library of Ruby objects implemented with Java.</span></div>
<div style="position:absolute;left:123.00px;top:587.63px" class="cls_007"><span class="cls_007">Now we’ll take a closer look at this library, specifically at how JRuby imple-</span></div>
<div style="position:absolute;left:123.00px;top:599.63px" class="cls_007"><span class="cls_007">ments the </span><span class="cls_030">String</span><span class="cls_007"> class. How do JRuby and MRI implement strings? Where</span></div>
<div style="position:absolute;left:367.88px;top:636.00px" class="cls_021"><span class="cls_021">JRuby: Ruby on the JVM</span></div>
<div style="position:absolute;left:442.43px;top:633.00px" class="cls_020"><span class="cls_020">263</span></div>
</div>
<div style="position:absolute;left:50%;margin-left:-252px;top:191308px;width:504px;height:666px;border-style:outset;overflow:hidden">
<div style="position:absolute;left:0px;top:0px">
<img src="e698b76e-46bd-11eb-8b25-0cc47a792c0a_id_e698b76e-46bd-11eb-8b25-0cc47a792c0a_files/background288.jpg" width=504 height=666></div>
<div style="position:absolute;left:120.00px;top:42.28px" class="cls_007"><span class="cls_007">do they save the string data you use in your Ruby code, and how do their</span></div>
<div style="position:absolute;left:120.00px;top:54.28px" class="cls_007"><span class="cls_007">implementations compare? Let’s begin to answer these questions by looking</span></div>
<div style="position:absolute;left:120.00px;top:66.28px" class="cls_007"><span class="cls_007">at how MRI implements strings.</span></div>
<div style="position:absolute;left:120.00px;top:91.28px" class="cls_055"><span class="cls_055">How JRuby and MRI Save String Data</span></div>
<div style="position:absolute;left:120.00px;top:109.28px" class="cls_007"><span class="cls_007">This code saves a famous quote from Pythagoras in a local variable. But</span></div>
<div style="position:absolute;left:120.00px;top:121.28px" class="cls_007"><span class="cls_007">where does this string go?</span></div>
<div style="position:absolute;left:120.00px;top:145.28px" class="cls_030"><span class="cls_030">str = "Geometry is knowledge of the eternally existent."</span></div>
<div style="position:absolute;left:138.00px;top:167.78px" class="cls_007"><span class="cls_007">Recall from Chapter 5 that MRI uses different C structures to imple-</span></div>
<div style="position:absolute;left:120.00px;top:179.78px" class="cls_007"><span class="cls_007">ment built-in classes, such as </span><span class="cls_030">RRegexp</span><span class="cls_007">, </span><span class="cls_030">RArray</span><span class="cls_007">, and </span><span class="cls_030">RHash</span><span class="cls_007">, as well as </span><span class="cls_030">RString</span><span class="cls_007">,</span></div>
<div style="position:absolute;left:120.00px;top:191.78px" class="cls_007"><span class="cls_007">which saves your strings. Figure 10-12 shows how MRI represents the</span></div>
<div style="position:absolute;left:120.00px;top:203.78px" class="cls_030"><span class="cls_030">Geometry...</span><span class="cls_007"> string internally.</span></div>
<div style="position:absolute;left:126.14px;top:231.33px" class="cls_020"><span class="cls_020">RString</span></div>
<div style="position:absolute;left:134.52px;top:252.40px" class="cls_020"><span class="cls_020">RBasic</span></div>
<div style="position:absolute;left:156.64px;top:270.94px" class="cls_014"><span class="cls_014">flags</span></div>
<div style="position:absolute;left:156.64px;top:295.59px" class="cls_014"><span class="cls_014">klass</span></div>
<div style="position:absolute;left:150.64px;top:331.93px" class="cls_014"><span class="cls_014">len = 48</span></div>
<div style="position:absolute;left:160.64px;top:357.59px" class="cls_014"><span class="cls_014">ptr</span></div>
<div style="position:absolute;left:240.71px;top:357.07px" class="cls_033"><span class="cls_033">G</span></div>
<div style="position:absolute;left:260.13px;top:357.07px" class="cls_033"><span class="cls_033">e</span></div>
<div style="position:absolute;left:279.55px;top:357.07px" class="cls_033"><span class="cls_033">o</span></div>
<div style="position:absolute;left:299.20px;top:357.07px" class="cls_033"><span class="cls_033">m</span></div>
<div style="position:absolute;left:318.62px;top:357.07px" class="cls_033"><span class="cls_033">e</span></div>
<div style="position:absolute;left:338.04px;top:357.07px" class="cls_033"><span class="cls_033">t</span></div>
<div style="position:absolute;left:357.45px;top:357.07px" class="cls_033"><span class="cls_033">r</span></div>
<div style="position:absolute;left:363.72px;top:376.87px" class="cls_054"><span class="cls_054">etc...</span></div>
<div style="position:absolute;left:148.64px;top:383.70px" class="cls_014"><span class="cls_014">capa = 48</span></div>
<div style="position:absolute;left:120.00px;top:412.90px" class="cls_038"><span class="cls_038">Figure 10-12: Part of the </span><span class="cls_014">RString</span><span class="cls_038"> C structure</span></div>
<div style="position:absolute;left:138.00px;top:435.40px" class="cls_007"><span class="cls_007">Notice that MRI saves the actual string data in a separate buffer, or sec-</span></div>
<div style="position:absolute;left:120.00px;top:447.40px" class="cls_007"><span class="cls_007">tion of memory, shown on the right. The </span><span class="cls_030">RString</span><span class="cls_007"> structure itself contains a</span></div>
<div style="position:absolute;left:120.00px;top:459.40px" class="cls_007"><span class="cls_007">pointer to this buffer, </span><span class="cls_030">ptr</span><span class="cls_007">. Also notice that </span><span class="cls_030">RString</span><span class="cls_007"> contains two other integer</span></div>
<div style="position:absolute;left:120.00px;top:471.40px" class="cls_007"><span class="cls_007">values: </span><span class="cls_030">len</span><span class="cls_007">, or the length of the string (48 in this example), and </span><span class="cls_030">capa</span><span class="cls_007">, or the</span></div>
<div style="position:absolute;left:120.00px;top:483.40px" class="cls_007"><span class="cls_007">capacity of the data buffer (also 48). The size of the data buffer can be lon-</span></div>
<div style="position:absolute;left:120.00px;top:495.40px" class="cls_007"><span class="cls_007">ger than the string, in which case </span><span class="cls_030">capa</span><span class="cls_007"> would be larger than </span><span class="cls_030">len</span><span class="cls_007">. (This would</span></div>
<div style="position:absolute;left:120.00px;top:507.40px" class="cls_007"><span class="cls_007">be the case if you executed code that reduced the length of the string.)</span></div>
<div style="position:absolute;left:138.00px;top:519.40px" class="cls_007"><span class="cls_007">Now let’s consider JRuby. Figure 10-13 shows how JRuby represents this</span></div>
<div style="position:absolute;left:120.00px;top:531.40px" class="cls_007"><span class="cls_007">string internally. JRuby uses the Java class </span><span class="cls_030">RubyString</span><span class="cls_007"> to represent strings in</span></div>
<div style="position:absolute;left:120.00px;top:543.40px" class="cls_007"><span class="cls_007">your Ruby code, following the naming pattern we saw above with </span><span class="cls_030">RubyObject</span></div>
<div style="position:absolute;left:120.00px;top:555.40px" class="cls_007"><span class="cls_007">and </span><span class="cls_030">RubyClass</span><span class="cls_007">. </span><span class="cls_030">RubyString</span><span class="cls_007"> uses another class to track the actual string data:</span></div>
<div style="position:absolute;left:120.00px;top:567.40px" class="cls_030"><span class="cls_030">ByteList</span><span class="cls_007">. This lower-level code tracks a separate data buffer (called </span><span class="cls_030">bytes</span><span class="cls_007">)</span></div>
<div style="position:absolute;left:120.00px;top:579.40px" class="cls_007"><span class="cls_007">similar to the way that the </span><span class="cls_030">RString</span><span class="cls_007"> structure does so in MRI. </span><span class="cls_030">ByteList</span><span class="cls_007"> also</span></div>
<div style="position:absolute;left:120.00px;top:591.40px" class="cls_007"><span class="cls_007">stores the length of the string in the </span><span class="cls_030">realSize</span><span class="cls_007"> instance variable.</span></div>
<div style="position:absolute;left:48.00px;top:633.00px" class="cls_020"><span class="cls_020">264</span></div>
<div style="position:absolute;left:74.59px;top:636.00px" class="cls_021"><span class="cls_021">Chapter 10</span></div>
</div>
<div style="position:absolute;left:50%;margin-left:-252px;top:191984px;width:504px;height:666px;border-style:outset;overflow:hidden">
<div style="position:absolute;left:0px;top:0px">
<img src="e698b76e-46bd-11eb-8b25-0cc47a792c0a_id_e698b76e-46bd-11eb-8b25-0cc47a792c0a_files/background289.jpg" width=504 height=666></div>
<div style="position:absolute;left:128.14px;top:49.15px" class="cls_020"><span class="cls_020">RubyString</span></div>
<div style="position:absolute;left:159.13px;top:68.20px" class="cls_014"><span class="cls_014">value</span></div>
<div style="position:absolute;left:128.14px;top:121.72px" class="cls_020"><span class="cls_020">ByteList</span></div>
<div style="position:absolute;left:159.13px;top:141.38px" class="cls_014"><span class="cls_014">bytes</span></div>
<div style="position:absolute;left:248.29px;top:141.11px" class="cls_033"><span class="cls_033">G</span></div>
<div style="position:absolute;left:267.71px;top:141.11px" class="cls_033"><span class="cls_033">e</span></div>
<div style="position:absolute;left:287.13px;top:141.11px" class="cls_033"><span class="cls_033">o</span></div>
<div style="position:absolute;left:306.79px;top:141.11px" class="cls_033"><span class="cls_033">m</span></div>
<div style="position:absolute;left:326.20px;top:141.11px" class="cls_033"><span class="cls_033">e</span></div>
<div style="position:absolute;left:345.62px;top:141.11px" class="cls_033"><span class="cls_033">t</span></div>
<div style="position:absolute;left:365.04px;top:141.11px" class="cls_033"><span class="cls_033">r</span></div>
<div style="position:absolute;left:371.30px;top:160.90px" class="cls_054"><span class="cls_054">etc...</span></div>
<div style="position:absolute;left:143.13px;top:173.05px" class="cls_014"><span class="cls_014">realSize = 48</span></div>
<div style="position:absolute;left:123.00px;top:205.21px" class="cls_038"><span class="cls_038">Figure 10-13: JRuby uses two Java objects and a data buffer for each string.</span></div>
<div style="position:absolute;left:123.00px;top:240.71px" class="cls_055"><span class="cls_055">Copy-on-Write</span></div>
<div style="position:absolute;left:123.00px;top:258.71px" class="cls_007"><span class="cls_007">Internally, both JRuby and MRI use an optimization called </span><span class="cls_008">copy-on-write</span><span class="cls_007"> for</span></div>
<div style="position:absolute;left:123.00px;top:270.71px" class="cls_007"><span class="cls_007">strings and other data. This trick allows two identical string values to share</span></div>
<div style="position:absolute;left:123.00px;top:282.71px" class="cls_007"><span class="cls_007">the same data buffer, which saves both memory and time because Ruby</span></div>
<div style="position:absolute;left:123.00px;top:294.71px" class="cls_007"><span class="cls_007">avoids making separate copies of the same string data unnecessarily.</span></div>
<div style="position:absolute;left:141.00px;top:306.71px" class="cls_007"><span class="cls_007">For example, suppose we use the </span><span class="cls_030">dup</span><span class="cls_007"> method to copy a string.</span></div>
<div style="position:absolute;left:123.00px;top:330.71px" class="cls_030"><span class="cls_030">str = "Geometry is knowledge of the eternally existent."</span></div>
<div style="position:absolute;left:123.00px;top:341.21px" class="cls_030"><span class="cls_030">str2 = str.dup</span></div>
<div style="position:absolute;left:141.00px;top:363.71px" class="cls_007"><span class="cls_007">Does JRuby have to copy the </span><span class="cls_030">Geometry is...</span><span class="cls_007"> text from one string object</span></div>
<div style="position:absolute;left:123.00px;top:375.71px" class="cls_007"><span class="cls_007">to another? No. Figure 10-14 shows how JRuby shares the string data across</span></div>
<div style="position:absolute;left:123.00px;top:387.71px" class="cls_007"><span class="cls_007">two different string objects.</span></div>
<div style="position:absolute;left:128.14px;top:414.26px" class="cls_020"><span class="cls_020">RubyString</span></div>
<div style="position:absolute;left:159.13px;top:433.31px" class="cls_014"><span class="cls_014">value</span></div>
<div style="position:absolute;left:258.70px;top:433.07px" class="cls_020"><span class="cls_020">ByteList</span></div>
<div style="position:absolute;left:307.88px;top:487.65px" class="cls_033"><span class="cls_033">G</span></div>
<div style="position:absolute;left:327.30px;top:487.65px" class="cls_033"><span class="cls_033">e</span></div>
<div style="position:absolute;left:346.71px;top:487.65px" class="cls_033"><span class="cls_033">o</span></div>
<div style="position:absolute;left:366.37px;top:487.65px" class="cls_033"><span class="cls_033">m</span></div>
<div style="position:absolute;left:385.79px;top:487.65px" class="cls_033"><span class="cls_033">e</span></div>
<div style="position:absolute;left:405.21px;top:487.65px" class="cls_033"><span class="cls_033">t</span></div>
<div style="position:absolute;left:424.62px;top:487.65px" class="cls_033"><span class="cls_033">r</span></div>
<div style="position:absolute;left:430.89px;top:507.44px" class="cls_054"><span class="cls_054">etc...</span></div>
<div style="position:absolute;left:128.14px;top:527.97px" class="cls_020"><span class="cls_020">RubyString</span></div>
<div style="position:absolute;left:159.13px;top:547.02px" class="cls_014"><span class="cls_014">value</span></div>
<div style="position:absolute;left:258.70px;top:546.78px" class="cls_020"><span class="cls_020">ByteList</span></div>
<div style="position:absolute;left:123.00px;top:579.05px" class="cls_038"><span class="cls_038">Figure 10-14: Two JRuby string objects can share the same data buffer.</span></div>
<div style="position:absolute;left:368.07px;top:636.00px" class="cls_021"><span class="cls_021">JRuby: Ruby on the JVM</span></div>
<div style="position:absolute;left:442.62px;top:633.00px" class="cls_020"><span class="cls_020">265</span></div>
</div>
<div style="position:absolute;left:50%;margin-left:-252px;top:192660px;width:504px;height:666px;border-style:outset;overflow:hidden">
<div style="position:absolute;left:0px;top:0px">
<img src="e698b76e-46bd-11eb-8b25-0cc47a792c0a_id_e698b76e-46bd-11eb-8b25-0cc47a792c0a_files/background290.jpg" width=504 height=666></div>
<div style="position:absolute;left:138.00px;top:42.28px" class="cls_007"><span class="cls_007">When we call </span><span class="cls_030">dup</span><span class="cls_007">, JRuby creates new </span><span class="cls_030">RubyString</span><span class="cls_007"> and </span><span class="cls_030">ByteList</span><span class="cls_007"> Java objects,</span></div>
<div style="position:absolute;left:120.00px;top:54.28px" class="cls_007"><span class="cls_007">but it doesn’t copy the actual string data. Instead, it sets the second </span><span class="cls_030">ByteList</span></div>
<div style="position:absolute;left:120.00px;top:66.28px" class="cls_007"><span class="cls_007">object to point to the same data buffer used by the original string. Now we</span></div>
<div style="position:absolute;left:120.00px;top:78.28px" class="cls_007"><span class="cls_007">have two sets of Java objects but only one underlying string value, as shown</span></div>
<div style="position:absolute;left:120.00px;top:90.28px" class="cls_007"><span class="cls_007">on the right of the figure. Because strings can contain thousands of bytes or</span></div>
<div style="position:absolute;left:120.00px;top:102.28px" class="cls_007"><span class="cls_007">more, this optimization can often save a tremendous amount of memory.</span></div>
<div style="position:absolute;left:138.00px;top:114.28px" class="cls_007"><span class="cls_007">MRI uses the same trick, although in a slightly more complex way.</span></div>
<div style="position:absolute;left:120.00px;top:126.28px" class="cls_007"><span class="cls_007">Figure 10-15 shows how standard Ruby shares strings.</span></div>
<div style="position:absolute;left:209.58px;top:153.89px" class="cls_020"><span class="cls_020">RString</span></div>
<div style="position:absolute;left:238.78px;top:174.01px" class="cls_067"><span class="cls_067">shared</span></div>
<div style="position:absolute;left:244.78px;top:201.61px" class="cls_067"><span class="cls_067">ptr</span></div>
<div style="position:absolute;left:126.16px;top:254.39px" class="cls_020"><span class="cls_020">RString</span></div>
<div style="position:absolute;left:161.36px;top:267.12px" class="cls_067"><span class="cls_067">ptr</span></div>
<div style="position:absolute;left:248.14px;top:266.12px" class="cls_019"><span class="cls_019">G</span></div>
<div style="position:absolute;left:267.65px;top:266.12px" class="cls_019"><span class="cls_019">e</span></div>
<div style="position:absolute;left:287.17px;top:266.12px" class="cls_019"><span class="cls_019">o</span></div>
<div style="position:absolute;left:306.92px;top:266.12px" class="cls_019"><span class="cls_019">m</span></div>
<div style="position:absolute;left:326.44px;top:266.12px" class="cls_019"><span class="cls_019">e</span></div>
<div style="position:absolute;left:345.95px;top:266.12px" class="cls_019"><span class="cls_019">t</span></div>
<div style="position:absolute;left:365.46px;top:266.12px" class="cls_019"><span class="cls_019">r</span></div>
<div style="position:absolute;left:371.76px;top:286.01px" class="cls_054"><span class="cls_054">etc...</span></div>
<div style="position:absolute;left:209.58px;top:313.90px" class="cls_020"><span class="cls_020">RString</span></div>
<div style="position:absolute;left:244.78px;top:334.03px" class="cls_067"><span class="cls_067">ptr</span></div>
<div style="position:absolute;left:238.78px;top:361.62px" class="cls_067"><span class="cls_067">shared</span></div>
<div style="position:absolute;left:120.00px;top:393.36px" class="cls_038"><span class="cls_038">Figure 10-15: MRI shares strings by creating a third </span><span class="cls_014">RString</span><span class="cls_038"> structure.</span></div>
<div style="position:absolute;left:138.00px;top:415.86px" class="cls_007"><span class="cls_007">Like JRuby, MRI shares the underlying string data. However, when you</span></div>
<div style="position:absolute;left:120.00px;top:427.86px" class="cls_007"><span class="cls_007">copy a string in standard MRI Ruby, it creates a third </span><span class="cls_030">RString</span><span class="cls_007"> structure and</span></div>
<div style="position:absolute;left:120.00px;top:439.86px" class="cls_007"><span class="cls_007">then sets both the original </span><span class="cls_030">RString</span><span class="cls_007"> and new </span><span class="cls_030">RString</span><span class="cls_007"> to refer to it using the</span></div>
<div style="position:absolute;left:120.00px;top:451.86px" class="cls_030"><span class="cls_030">shared</span><span class="cls_007"> pointer.</span></div>
<div style="position:absolute;left:138.00px;top:463.86px" class="cls_007"><span class="cls_007">In either case, we have a problem. What if we change one of the string</span></div>
<div style="position:absolute;left:120.00px;top:475.86px" class="cls_007"><span class="cls_007">variables? For example, suppose we convert one of the strings to uppercase</span></div>
<div style="position:absolute;left:120.00px;top:487.86px" class="cls_007"><span class="cls_007">as follows:</span></div>
<div style="position:absolute;left:120.00px;top:511.86px" class="cls_030"><span class="cls_030">str = "Geometry is knowledge of the eternally existent."</span></div>
<div style="position:absolute;left:108.15px;top:522.36px" class="cls_046"><span class="cls_046">u</span><span class="cls_030"> str2 = str.dup</span></div>
<div style="position:absolute;left:108.15px;top:532.85px" class="cls_046"><span class="cls_046">v</span><span class="cls_030"> str2.upcase!</span></div>
<div style="position:absolute;left:138.00px;top:555.36px" class="cls_007"><span class="cls_007">At </span><span class="cls_050">u</span><span class="cls_007"> in both JRuby and MRI, we have two shared strings, but at </span><span class="cls_050">v</span><span class="cls_007"> I</span></div>
<div style="position:absolute;left:120.00px;top:567.36px" class="cls_007"><span class="cls_007">change the second string using the </span><span class="cls_030">upcase!</span><span class="cls_007"> method. Now the two strings dif-</span></div>
<div style="position:absolute;left:120.00px;top:579.36px" class="cls_007"><span class="cls_007">fer, which means that Ruby clearly can’t continue to share the underlying</span></div>
<div style="position:absolute;left:120.00px;top:591.36px" class="cls_007"><span class="cls_007">string buffer or </span><span class="cls_030">upcase!</span><span class="cls_007"> would change both strings. We can see the strings</span></div>
<div style="position:absolute;left:120.00px;top:603.36px" class="cls_007"><span class="cls_007">are now different by displaying the string values.</span></div>
<div style="position:absolute;left:48.00px;top:633.00px" class="cls_020"><span class="cls_020">266</span></div>
<div style="position:absolute;left:74.55px;top:636.00px" class="cls_021"><span class="cls_021">Chapter 10</span></div>
</div>
<div style="position:absolute;left:50%;margin-left:-252px;top:193336px;width:504px;height:666px;border-style:outset;overflow:hidden">
<div style="position:absolute;left:0px;top:0px">
<img src="e698b76e-46bd-11eb-8b25-0cc47a792c0a_id_e698b76e-46bd-11eb-8b25-0cc47a792c0a_files/background291.jpg" width=504 height=666></div>
<div style="position:absolute;left:123.00px;top:49.00px" class="cls_030"><span class="cls_030">p str</span></div>
<div style="position:absolute;left:127.25px;top:59.50px" class="cls_030"><span class="cls_030">=> "Geometry is knowledge of the eternally existent."</span></div>
<div style="position:absolute;left:123.00px;top:70.00px" class="cls_030"><span class="cls_030">p str2</span></div>
<div style="position:absolute;left:127.25px;top:80.49px" class="cls_030"><span class="cls_030">=> "GEOMETRY IS KNOWLEDGE OF THE ETERNALLY EXISTENT."</span></div>
<div style="position:absolute;left:141.00px;top:103.00px" class="cls_007"><span class="cls_007">At some point, Ruby must have separated these two strings, creating a</span></div>
<div style="position:absolute;left:123.00px;top:115.00px" class="cls_007"><span class="cls_007">new data buffer. This is what the phrase </span><span class="cls_008">copy-on-write</span><span class="cls_007"> means: Both MRI and</span></div>
<div style="position:absolute;left:123.00px;top:127.00px" class="cls_007"><span class="cls_007">JRuby create a new copy of the string data buffer when you write to one of</span></div>
<div style="position:absolute;left:123.00px;top:139.00px" class="cls_007"><span class="cls_007">the strings.</span></div>
<div style="position:absolute;left:123.00px;top:173.00px" class="cls_031"><span class="cls_031">Experiment 10-2: Measuring Copy-on-Write</span></div>
<div style="position:absolute;left:123.00px;top:188.00px" class="cls_031"><span class="cls_031">Performance</span></div>
<div style="position:absolute;left:123.00px;top:208.00px" class="cls_007"><span class="cls_007">In this experiment we’ll collect evidence that this extra copy operation</span></div>
<div style="position:absolute;left:123.00px;top:220.00px" class="cls_007"><span class="cls_007">really occurs when we write to a shared string. First, we’ll create a simple,</span></div>
<div style="position:absolute;left:123.00px;top:232.00px" class="cls_007"><span class="cls_007">nonshared string and write to it. Then we’ll create two shared strings and</span></div>
<div style="position:absolute;left:123.00px;top:244.00px" class="cls_007"><span class="cls_007">write to one of them. If copy-on-write really occurs, then writing to a shared</span></div>
<div style="position:absolute;left:123.00px;top:256.00px" class="cls_007"><span class="cls_007">string should take a bit longer because Ruby has to create a new copy of</span></div>
<div style="position:absolute;left:123.00px;top:268.00px" class="cls_007"><span class="cls_007">the string before writing.</span></div>
<div style="position:absolute;left:123.00px;top:293.00px" class="cls_055"><span class="cls_055">Creating a Unique, Nonshared String</span></div>
<div style="position:absolute;left:123.00px;top:311.00px" class="cls_007"><span class="cls_007">Let’s begin by creating our example string again, </span><span class="cls_030">str</span><span class="cls_007">. Initially Ruby can’t</span></div>
<div style="position:absolute;left:123.00px;top:323.00px" class="cls_007"><span class="cls_007">possibly share </span><span class="cls_030">str</span><span class="cls_007"> with anything else because there is only one string. We’ll</span></div>
<div style="position:absolute;left:123.00px;top:335.00px" class="cls_007"><span class="cls_007">use </span><span class="cls_030">str</span><span class="cls_007"> for our baseline performance measurement.</span></div>
<div style="position:absolute;left:123.00px;top:359.00px" class="cls_030"><span class="cls_030">str = "Geometry is knowledge of the eternally existent."</span></div>
<div style="position:absolute;left:141.00px;top:381.50px" class="cls_007"><span class="cls_007">But as it turns out, Ruby shares </span><span class="cls_030">str</span><span class="cls_007"> immediately! To see why, we’ll exam-</span></div>
<div style="position:absolute;left:123.00px;top:393.50px" class="cls_007"><span class="cls_007">ine the YARV instructions that MRI uses to execute this code, as shown in</span></div>
<div style="position:absolute;left:123.00px;top:405.50px" class="cls_007"><span class="cls_007">Listing 10-10.</span></div>
<div style="position:absolute;left:123.00px;top:429.50px" class="cls_030"><span class="cls_030">code = &lt;&lt;END</span></div>
<div style="position:absolute;left:123.00px;top:440.00px" class="cls_030"><span class="cls_030">str = "Geometry is knowledge of the eternally existent."</span></div>
<div style="position:absolute;left:123.00px;top:450.49px" class="cls_030"><span class="cls_030">END</span></div>
<div style="position:absolute;left:123.00px;top:471.50px" class="cls_030"><span class="cls_030">puts RubyVM::InstructionSequence.compile(code).disasm</span></div>
<div style="position:absolute;left:123.00px;top:482.00px" class="cls_030"><span class="cls_030">==</span></div>
<div style="position:absolute;left:135.75px;top:482.00px" class="cls_030"><span class="cls_030">disasm: &lt;RubyVM::InstructionSequence:&lt;compiled>@&lt;compiled>>==========</span></div>
<div style="position:absolute;left:123.00px;top:492.49px" class="cls_030"><span class="cls_030">local table (size: 2, argc: 0 [opts: 0, rest: -1, post: 0, block: -1] s1)</span></div>
<div style="position:absolute;left:111.15px;top:502.99px" class="cls_046"><span class="cls_046">u</span><span class="cls_030"> [ 2] str</span></div>
<div style="position:absolute;left:123.00px;top:513.49px" class="cls_030"><span class="cls_030">0000 trace</span></div>
<div style="position:absolute;left:216.50px;top:513.49px" class="cls_030"><span class="cls_030">1</span></div>
<div style="position:absolute;left:420.50px;top:513.49px" class="cls_030"><span class="cls_030">(</span></div>
<div style="position:absolute;left:437.50px;top:513.49px" class="cls_030"><span class="cls_030">1)</span></div>
<div style="position:absolute;left:111.15px;top:523.99px" class="cls_046"><span class="cls_046">v</span><span class="cls_030"> 0002 putstring</span></div>
<div style="position:absolute;left:216.48px;top:523.99px" class="cls_030"><span class="cls_030">"Geometry is knowledge of the eternally existent."</span></div>
<div style="position:absolute;left:111.15px;top:534.48px" class="cls_046"><span class="cls_046">w</span><span class="cls_030"> 0004 dup</span></div>
<div style="position:absolute;left:111.15px;top:544.98px" class="cls_046"><span class="cls_046">x</span><span class="cls_030"> 0005 setlocal_OP__WC__0 2</span></div>
<div style="position:absolute;left:123.00px;top:555.48px" class="cls_030"><span class="cls_030">0007 leave</span></div>
<div style="position:absolute;left:123.00px;top:577.98px" class="cls_038"><span class="cls_038">Listing 10-10: MRI Ruby uses a </span><span class="cls_014">dup</span><span class="cls_038"> YARV instruction internally when you use a literal</span></div>
<div style="position:absolute;left:123.00px;top:588.50px" class="cls_038"><span class="cls_038">string constant.</span></div>
<div style="position:absolute;left:368.16px;top:636.00px" class="cls_021"><span class="cls_021">JRuby: Ruby on the JVM</span></div>
<div style="position:absolute;left:442.71px;top:633.00px" class="cls_020"><span class="cls_020">267</span></div>
</div>
<div style="position:absolute;left:50%;margin-left:-252px;top:194012px;width:504px;height:666px;border-style:outset;overflow:hidden">
<div style="position:absolute;left:0px;top:0px">
<img src="e698b76e-46bd-11eb-8b25-0cc47a792c0a_id_e698b76e-46bd-11eb-8b25-0cc47a792c0a_files/background292.jpg" width=504 height=666></div>
<div style="position:absolute;left:138.00px;top:42.71px" class="cls_007"><span class="cls_007">Reading the YARV instructions above carefully, we see at </span><span class="cls_050">v</span><span class="cls_007"> that Ruby</span></div>
<div style="position:absolute;left:120.00px;top:54.71px" class="cls_007"><span class="cls_007">puts the string onto the stack using </span><span class="cls_030">putstring</span><span class="cls_007">. This YARV instruction</span></div>
<div style="position:absolute;left:120.00px;top:66.71px" class="cls_007"><span class="cls_007">internally copies the string argument to the stack, creating a shared copy</span></div>
<div style="position:absolute;left:120.00px;top:78.71px" class="cls_007"><span class="cls_007">already. At </span><span class="cls_050">w</span><span class="cls_007"> Ruby uses </span><span class="cls_030">dup</span><span class="cls_007"> to create yet another shared copy of the string</span></div>
<div style="position:absolute;left:120.00px;top:90.71px" class="cls_007"><span class="cls_007">to use as an argument for </span><span class="cls_030">setlocal</span><span class="cls_007">. Finally, at </span><span class="cls_050">x</span><span class="cls_007"> </span><span class="cls_030">setlocal_OP__WC__0 2</span><span class="cls_007"> saves</span></div>
<div style="position:absolute;left:120.00px;top:102.71px" class="cls_007"><span class="cls_007">this string into the </span><span class="cls_030">str</span><span class="cls_007"> variable, shown as </span><span class="cls_030">[2]</span><span class="cls_007"> in the local table </span><span class="cls_050">u</span><span class="cls_007">.</span></div>
<div style="position:absolute;left:138.00px;top:114.71px" class="cls_007"><span class="cls_007">Figure 10-16 summarizes this process.</span></div>
<div style="position:absolute;left:237.51px;top:142.29px" class="cls_020"><span class="cls_020">RString</span></div>
<div style="position:absolute;left:272.59px;top:154.98px" class="cls_014"><span class="cls_014">ptr</span></div>
<div style="position:absolute;left:123.65px;top:200.73px" class="cls_014"><span class="cls_014">putstring "Geometry is..."</span></div>
<div style="position:absolute;left:300.89px;top:202.37px" class="cls_033"><span class="cls_033">G</span></div>
<div style="position:absolute;left:320.35px;top:202.37px" class="cls_033"><span class="cls_033">e</span></div>
<div style="position:absolute;left:339.81px;top:202.37px" class="cls_033"><span class="cls_033">o</span></div>
<div style="position:absolute;left:123.65px;top:212.40px" class="cls_014"><span class="cls_014">dup</span></div>
<div style="position:absolute;left:347.91px;top:223.65px" class="cls_054"><span class="cls_054">etc...</span></div>
<div style="position:absolute;left:237.51px;top:249.43px" class="cls_020"><span class="cls_020">RString</span></div>
<div style="position:absolute;left:272.59px;top:262.13px" class="cls_014"><span class="cls_014">ptr</span></div>
<div style="position:absolute;left:123.65px;top:312.56px" class="cls_014"><span class="cls_014">setlocal 2, 0</span></div>
<div style="position:absolute;left:272.59px;top:312.83px" class="cls_014"><span class="cls_014">str</span></div>
<div style="position:absolute;left:120.00px;top:334.89px" class="cls_038"><span class="cls_038">Figure 10-16: Executing </span><span class="cls_014">putstring</span><span class="cls_038"> and </span><span class="cls_014">dup</span><span class="cls_038"> creates shared strings in MRI.</span></div>
<div style="position:absolute;left:138.00px;top:357.39px" class="cls_007"><span class="cls_007">On the left are the YARV instructions </span><span class="cls_030">putstring</span><span class="cls_007">, </span><span class="cls_030">dup</span><span class="cls_007">, and </span><span class="cls_030">setlocal</span><span class="cls_007">. On the</span></div>
<div style="position:absolute;left:120.00px;top:369.39px" class="cls_007"><span class="cls_007">right are the </span><span class="cls_030">RString</span><span class="cls_007"> structures that these instructions create, as well as the</span></div>
<div style="position:absolute;left:120.00px;top:381.39px" class="cls_007"><span class="cls_007">underlying shared string data. As I just mentioned, </span><span class="cls_030">putstring</span><span class="cls_007"> in fact copies</span></div>
<div style="position:absolute;left:120.00px;top:393.39px" class="cls_007"><span class="cls_007">the string constant from a third </span><span class="cls_030">RString</span><span class="cls_007"> left off the diagram, meaning the</span></div>
<div style="position:absolute;left:120.00px;top:405.39px" class="cls_007"><span class="cls_007">string is actually shared a third time.</span></div>
<div style="position:absolute;left:138.00px;top:417.39px" class="cls_007"><span class="cls_007">Because Ruby initially shares strings created from constant values, we</span></div>
<div style="position:absolute;left:120.00px;top:429.39px" class="cls_007"><span class="cls_007">need to create our string differently by concatenating two strings together</span></div>
<div style="position:absolute;left:120.00px;top:441.39px" class="cls_007"><span class="cls_007">as follows:</span></div>
<div style="position:absolute;left:120.00px;top:465.39px" class="cls_030"><span class="cls_030">str = "This string is not shared" + " and so can be modified faster."</span></div>
<div style="position:absolute;left:138.00px;top:487.89px" class="cls_007"><span class="cls_007">The result of this concatenation will be a new, unique string. Ruby will</span></div>
<div style="position:absolute;left:120.00px;top:499.89px" class="cls_007"><span class="cls_007">not share its string data with any other string objects.</span></div>
<div style="position:absolute;left:120.00px;top:524.89px" class="cls_055"><span class="cls_055">Experiment Code</span></div>
<div style="position:absolute;left:120.00px;top:542.89px" class="cls_007"><span class="cls_007">Let’s take some measurements. Listing 10-11 shows the code for this</span></div>
<div style="position:absolute;left:120.00px;top:554.89px" class="cls_007"><span class="cls_007">experiment.</span></div>
<div style="position:absolute;left:48.00px;top:633.00px" class="cls_020"><span class="cls_020">268</span></div>
<div style="position:absolute;left:74.58px;top:636.00px" class="cls_021"><span class="cls_021">Chapter 10</span></div>
</div>
<div style="position:absolute;left:50%;margin-left:-252px;top:194688px;width:504px;height:666px;border-style:outset;overflow:hidden">
<div style="position:absolute;left:0px;top:0px">
<img src="e698b76e-46bd-11eb-8b25-0cc47a792c0a_id_e698b76e-46bd-11eb-8b25-0cc47a792c0a_files/background293.jpg" width=504 height=666></div>
<div style="position:absolute;left:123.00px;top:49.00px" class="cls_030"><span class="cls_030">require 'benchmark'</span></div>
<div style="position:absolute;left:123.00px;top:70.00px" class="cls_030"><span class="cls_030">ITERATIONS = 1000000</span></div>
<div style="position:absolute;left:123.00px;top:91.01px" class="cls_030"><span class="cls_030">Benchmark.bm do |bench|</span></div>
<div style="position:absolute;left:131.50px;top:101.50px" class="cls_030"><span class="cls_030">bench.report("test") do</span></div>
<div style="position:absolute;left:140.00px;top:112.00px" class="cls_030"><span class="cls_030">ITERATIONS.times do</span></div>
<div style="position:absolute;left:111.15px;top:122.50px" class="cls_046"><span class="cls_046">u</span></div>
<div style="position:absolute;left:148.48px;top:122.50px" class="cls_030"><span class="cls_030">str = "This string is not shared" + " and so can be modified faster."</span></div>
<div style="position:absolute;left:110.76px;top:133.00px" class="cls_046"><span class="cls_046">v</span></div>
<div style="position:absolute;left:148.09px;top:133.00px" class="cls_030"><span class="cls_030">str2 = "But this string is shared" + " so Ruby will need to copy it</span></div>
<div style="position:absolute;left:182.50px;top:143.49px" class="cls_030"><span class="cls_030">before writing to it."</span></div>
<div style="position:absolute;left:111.15px;top:153.99px" class="cls_046"><span class="cls_046">w</span></div>
<div style="position:absolute;left:148.48px;top:153.99px" class="cls_030"><span class="cls_030">str3 = str2.dup</span></div>
<div style="position:absolute;left:111.15px;top:164.49px" class="cls_046"><span class="cls_046">x</span></div>
<div style="position:absolute;left:148.48px;top:164.49px" class="cls_030"><span class="cls_030">str3[3] = 'x'</span></div>
<div style="position:absolute;left:140.00px;top:174.99px" class="cls_030"><span class="cls_030">end</span></div>
<div style="position:absolute;left:131.50px;top:185.48px" class="cls_030"><span class="cls_030">end</span></div>
<div style="position:absolute;left:123.00px;top:195.98px" class="cls_030"><span class="cls_030">end</span></div>
<div style="position:absolute;left:123.00px;top:218.48px" class="cls_038"><span class="cls_038">Listing 10-11: Measuring a delay for copy-on-write</span></div>
<div style="position:absolute;left:141.00px;top:241.00px" class="cls_007"><span class="cls_007">Before we run this test, let’s walk through this code. At </span><span class="cls_050">u</span><span class="cls_007"> we create a</span></div>
<div style="position:absolute;left:123.00px;top:253.00px" class="cls_007"><span class="cls_007">unique, unshared string by concatenating two strings. This is </span><span class="cls_030">str</span><span class="cls_007">. Then at </span><span class="cls_050">v</span></div>
<div style="position:absolute;left:123.00px;top:265.00px" class="cls_007"><span class="cls_007">we create a second unshared string, </span><span class="cls_030">str2</span><span class="cls_007">. But at </span><span class="cls_050">w</span><span class="cls_007"> we use </span><span class="cls_030">dup</span><span class="cls_007"> to create a copy</span></div>
<div style="position:absolute;left:123.00px;top:277.00px" class="cls_007"><span class="cls_007">of this string, </span><span class="cls_030">str3</span><span class="cls_007">, and now </span><span class="cls_030">str2</span><span class="cls_007"> and </span><span class="cls_030">str3</span><span class="cls_007"> share the same value.</span></div>
<div style="position:absolute;left:123.00px;top:302.00px" class="cls_055"><span class="cls_055">Visualizing Copy-on-Write</span></div>
<div style="position:absolute;left:123.00px;top:320.00px" class="cls_007"><span class="cls_007">At </span><span class="cls_050">x</span><span class="cls_007"> in Listing 10-11 we change the fourth character in </span><span class="cls_030">str3</span><span class="cls_007"> using the code</span></div>
<div style="position:absolute;left:123.00px;top:332.00px" class="cls_030"><span class="cls_030">str3[3] = 'x'</span><span class="cls_007">. But here Ruby can’t change the character in </span><span class="cls_030">str3</span><span class="cls_007"> without</span></div>
<div style="position:absolute;left:123.00px;top:344.00px" class="cls_007"><span class="cls_007">changing </span><span class="cls_030">str2</span><span class="cls_007"> as well, as shown in Figure 10-17.</span></div>
<div style="position:absolute;left:243.44px;top:364.83px" class="cls_204"><span class="cls_204">str3[3] = 'x'</span></div>
<div style="position:absolute;left:132.23px;top:384.65px" class="cls_020"><span class="cls_020">RString: str3</span></div>
<div style="position:absolute;left:164.50px;top:397.67px" class="cls_205"><span class="cls_205">ptr</span></div>
<div style="position:absolute;left:272.43px;top:428.38px" class="cls_019"><span class="cls_019">?</span></div>
<div style="position:absolute;left:212.37px;top:447.50px" class="cls_019"><span class="cls_019">B</span></div>
<div style="position:absolute;left:232.24px;top:447.50px" class="cls_019"><span class="cls_019">u</span></div>
<div style="position:absolute;left:252.12px;top:447.50px" class="cls_019"><span class="cls_019">t</span></div>
<div style="position:absolute;left:292.12px;top:447.50px" class="cls_019"><span class="cls_019">t</span></div>
<div style="position:absolute;left:311.99px;top:447.50px" class="cls_019"><span class="cls_019">h</span></div>
<div style="position:absolute;left:331.87px;top:447.50px" class="cls_019"><span class="cls_019">i</span></div>
<div style="position:absolute;left:338.28px;top:467.74px" class="cls_054"><span class="cls_054">etc...</span></div>
<div style="position:absolute;left:132.23px;top:491.05px" class="cls_020"><span class="cls_020">RString:</span></div>
<div style="position:absolute;left:172.73px;top:491.05px" class="cls_020"><span class="cls_020">str2</span></div>
<div style="position:absolute;left:164.50px;top:504.08px" class="cls_205"><span class="cls_205">ptr</span></div>
<div style="position:absolute;left:123.00px;top:535.88px" class="cls_038"><span class="cls_038">Figure 10-17: Ruby can’t change </span><span class="cls_014">str3</span><span class="cls_038"> without also changing </span><span class="cls_014">str2</span><span class="cls_038">.</span></div>
<div style="position:absolute;left:368.00px;top:636.00px" class="cls_021"><span class="cls_021">JRuby: Ruby on the JVM</span></div>
<div style="position:absolute;left:442.55px;top:633.00px" class="cls_020"><span class="cls_020">269</span></div>
</div>
<div style="position:absolute;left:50%;margin-left:-252px;top:195364px;width:504px;height:666px;border-style:outset;overflow:hidden">
<div style="position:absolute;left:0px;top:0px">
<img src="e698b76e-46bd-11eb-8b25-0cc47a792c0a_id_e698b76e-46bd-11eb-8b25-0cc47a792c0a_files/background294.jpg" width=504 height=666></div>
<div style="position:absolute;left:138.00px;top:42.28px" class="cls_007"><span class="cls_007">Ruby has to make a separate copy of </span><span class="cls_030">str3</span><span class="cls_007"> first, as shown in Figure 10-18.</span></div>
<div style="position:absolute;left:277.80px;top:63.11px" class="cls_204"><span class="cls_204">str3[3] = 'x'</span></div>
<div style="position:absolute;left:126.17px;top:94.05px" class="cls_020"><span class="cls_020">RString: str3</span></div>
<div style="position:absolute;left:161.50px;top:106.82px" class="cls_067"><span class="cls_067">ptr</span></div>
<div style="position:absolute;left:247.67px;top:106.02px" class="cls_019"><span class="cls_019">B</span></div>
<div style="position:absolute;left:267.25px;top:106.02px" class="cls_019"><span class="cls_019">u</span></div>
<div style="position:absolute;left:286.82px;top:106.02px" class="cls_019"><span class="cls_019">t</span></div>
<div style="position:absolute;left:307.04px;top:106.02px" class="cls_019"><span class="cls_019">x</span></div>
<div style="position:absolute;left:326.21px;top:106.02px" class="cls_019"><span class="cls_019">t</span></div>
<div style="position:absolute;left:345.79px;top:106.02px" class="cls_019"><span class="cls_019">h</span></div>
<div style="position:absolute;left:365.36px;top:106.02px" class="cls_019"><span class="cls_019">i</span></div>
<div style="position:absolute;left:365.44px;top:123.05px" class="cls_054"><span class="cls_054">etc...</span></div>
<div style="position:absolute;left:328.54px;top:148.17px" class="cls_017"><span class="cls_017">copy</span></div>
<div style="position:absolute;left:126.17px;top:178.84px" class="cls_020"><span class="cls_020">RString: str2</span></div>
<div style="position:absolute;left:161.50px;top:191.62px" class="cls_067"><span class="cls_067">ptr</span></div>
<div style="position:absolute;left:247.67px;top:191.23px" class="cls_019"><span class="cls_019">B</span></div>
<div style="position:absolute;left:267.25px;top:191.23px" class="cls_019"><span class="cls_019">u</span></div>
<div style="position:absolute;left:286.82px;top:191.23px" class="cls_019"><span class="cls_019">t</span></div>
<div style="position:absolute;left:326.21px;top:191.23px" class="cls_019"><span class="cls_019">t</span></div>
<div style="position:absolute;left:345.79px;top:191.23px" class="cls_019"><span class="cls_019">h</span></div>
<div style="position:absolute;left:365.36px;top:191.23px" class="cls_019"><span class="cls_019">i</span></div>
<div style="position:absolute;left:371.68px;top:211.18px" class="cls_054"><span class="cls_054">etc...</span></div>
<div style="position:absolute;left:120.00px;top:229.52px" class="cls_038"><span class="cls_038">Figure 10-18: Ruby copies the string into a new buffer for </span><span class="cls_014">str3</span><span class="cls_038"> before writing to it.</span></div>
<div style="position:absolute;left:138.00px;top:252.02px" class="cls_007"><span class="cls_007">Now Ruby can write into the new buffer for </span><span class="cls_030">str3</span><span class="cls_007"> without affecting </span><span class="cls_030">str2</span><span class="cls_007">.</span></div>
<div style="position:absolute;left:120.00px;top:277.02px" class="cls_055"><span class="cls_055">Modifying a Shared String Is Slower</span></div>
<div style="position:absolute;left:120.00px;top:295.02px" class="cls_007"><span class="cls_007">When we execute Listing 10-11, the </span><span class="cls_030">benchmark</span><span class="cls_007"> library measures how long it</span></div>
<div style="position:absolute;left:120.00px;top:307.02px" class="cls_007"><span class="cls_007">takes to run the inner block 1 million times. This block creates </span><span class="cls_030">str</span><span class="cls_007">, </span><span class="cls_030">str2</span><span class="cls_007">,</span></div>
<div style="position:absolute;left:120.00px;top:319.02px" class="cls_007"><span class="cls_007">and </span><span class="cls_030">str3</span><span class="cls_007"> and then modifies </span><span class="cls_030">str3</span><span class="cls_007">. On my laptop, </span><span class="cls_030">benchmark</span><span class="cls_007"> yields a measure-</span></div>
<div style="position:absolute;left:120.01px;top:331.02px" class="cls_007"><span class="cls_007">ment of about 1.87 seconds.</span></div>
<div style="position:absolute;left:138.01px;top:343.02px" class="cls_007"><span class="cls_007">Next, let’s change </span><span class="cls_030">str3[3] = 'x'</span><span class="cls_007"> at </span><span class="cls_050">x</span><span class="cls_007"> to modify </span><span class="cls_030">str</span><span class="cls_007"> instead.</span></div>
<div style="position:absolute;left:120.00px;top:367.02px" class="cls_030"><span class="cls_030">#str3[3] = 'x'</span></div>
<div style="position:absolute;left:120.00px;top:377.52px" class="cls_030"><span class="cls_030">str[3] = 'x'</span></div>
<div style="position:absolute;left:138.00px;top:400.02px" class="cls_007"><span class="cls_007">Now we’re modifying the unshared, unique string instead of the shared</span></div>
<div style="position:absolute;left:120.00px;top:412.02px" class="cls_007"><span class="cls_007">string. Running the test again yields a result of about 1.69 seconds, or about</span></div>
<div style="position:absolute;left:120.00px;top:424.02px" class="cls_007"><span class="cls_007">9.5 percent less than the time </span><span class="cls_030">benchmark</span><span class="cls_007"> reported for the shared string. As</span></div>
<div style="position:absolute;left:120.00px;top:436.02px" class="cls_007"><span class="cls_007">expected, it takes slightly less time to modify a unique string than it does to</span></div>
<div style="position:absolute;left:120.00px;top:448.02px" class="cls_007"><span class="cls_007">modify a shared one.</span></div>
<div style="position:absolute;left:138.00px;top:460.02px" class="cls_007"><span class="cls_007">The graph in Figure 10-19 shows my cumulative results averaged over</span></div>
<div style="position:absolute;left:120.00px;top:472.02px" class="cls_007"><span class="cls_007">10 different observations for both MRI and JRuby. On the left side of the</span></div>
<div style="position:absolute;left:120.00px;top:484.02px" class="cls_007"><span class="cls_007">graph are my average measurements for MRI. The bar on the far left rep-</span></div>
<div style="position:absolute;left:120.00px;top:496.02px" class="cls_007"><span class="cls_007">resents the time required to modify the shared string, </span><span class="cls_030">str3</span><span class="cls_007">, and the right</span></div>
<div style="position:absolute;left:120.00px;top:508.02px" class="cls_007"><span class="cls_007">MRI bar shows how long it took to modify the unique string, </span><span class="cls_030">str</span><span class="cls_007">. The two</span></div>
<div style="position:absolute;left:120.00px;top:520.02px" class="cls_007"><span class="cls_007">bars on the right side exhibit the same pattern for JRuby, but the difference</span></div>
<div style="position:absolute;left:120.00px;top:532.02px" class="cls_007"><span class="cls_007">in the height of the bars is much less. Apparently, the JVM can make a new</span></div>
<div style="position:absolute;left:120.00px;top:544.02px" class="cls_007"><span class="cls_007">copy of the string faster than MRI.</span></div>
<div style="position:absolute;left:138.00px;top:556.02px" class="cls_007"><span class="cls_007">But there’s more: Notice that overall JRuby ran the experiment code</span></div>
<div style="position:absolute;left:120.00px;top:568.02px" class="cls_007"><span class="cls_007">in 60 percent less time. That is, it was 2.5 times faster than MRI! Just as in</span></div>
<div style="position:absolute;left:120.00px;top:580.02px" class="cls_007"><span class="cls_007">Experiment 10-1, we must be seeing the JVM optimizations, such as JIT</span></div>
<div style="position:absolute;left:120.00px;top:592.02px" class="cls_007"><span class="cls_007">compilation, speed up JRuby when compared to MRI.</span></div>
<div style="position:absolute;left:48.00px;top:633.00px" class="cls_020"><span class="cls_020">270</span></div>
<div style="position:absolute;left:74.37px;top:636.00px" class="cls_021"><span class="cls_021">Chapter 10</span></div>
</div>
<div style="position:absolute;left:50%;margin-left:-252px;top:196040px;width:504px;height:666px;border-style:outset;overflow:hidden">
<div style="position:absolute;left:0px;top:0px">
<img src="e698b76e-46bd-11eb-8b25-0cc47a792c0a_id_e698b76e-46bd-11eb-8b25-0cc47a792c0a_files/background295.jpg" width=504 height=666></div>
<div style="position:absolute;left:144.45px;top:44.85px" class="cls_206"><span class="cls_206">2</span></div>
<div style="position:absolute;left:221.15px;top:61.21px" class="cls_207"><span class="cls_207">MRI</span></div>
<div style="position:absolute;left:140.10px;top:67.98px" class="cls_206"><span class="cls_206">1.8</span></div>
<div style="position:absolute;left:140.10px;top:91.13px" class="cls_206"><span class="cls_206">1.6</span></div>
<div style="position:absolute;left:140.10px;top:114.27px" class="cls_206"><span class="cls_206">1.4</span></div>
<div style="position:absolute;left:216.41px;top:126.38px" class="cls_207"><span class="cls_207">shared</span></div>
<div style="position:absolute;left:269.62px;top:126.38px" class="cls_207"><span class="cls_207">unshared</span></div>
<div style="position:absolute;left:140.10px;top:137.41px" class="cls_206"><span class="cls_206">1.2</span></div>
<div style="position:absolute;left:144.45px;top:160.55px" class="cls_206"><span class="cls_206">1</span></div>
<div style="position:absolute;left:140.10px;top:183.70px" class="cls_206"><span class="cls_206">0.8</span></div>
<div style="position:absolute;left:314.43px;top:188.19px" class="cls_207"><span class="cls_207">JRuby</span></div>
<div style="position:absolute;left:140.10px;top:206.84px" class="cls_206"><span class="cls_206">0.6</span></div>
<div style="position:absolute;left:140.10px;top:229.98px" class="cls_206"><span class="cls_206">0.4</span></div>
<div style="position:absolute;left:312.34px;top:226.86px" class="cls_207"><span class="cls_207">shared</span></div>
<div style="position:absolute;left:368.75px;top:226.56px" class="cls_207"><span class="cls_207">unshared</span></div>
<div style="position:absolute;left:140.10px;top:253.13px" class="cls_206"><span class="cls_206">0.2</span></div>
<div style="position:absolute;left:123.00px;top:286.61px" class="cls_038"><span class="cls_038">Figure 10-19: Both MRI and JRuby show a delay for copy-on-write (seconds).</span></div>
<div style="position:absolute;left:69.00px;top:313.11px" class="cls_031"><span class="cls_031">Summary</span></div>
<div style="position:absolute;left:123.00px;top:333.11px" class="cls_007"><span class="cls_007">In this chapter we took a look at JRuby, a version of Ruby written in Java.</span></div>
<div style="position:absolute;left:123.00px;top:345.11px" class="cls_007"><span class="cls_007">We saw how the </span><span class="cls_030">jruby</span><span class="cls_007"> command launches the JVM, passing </span><span class="cls_008">jruby.jar</span><span class="cls_007"> as a</span></div>
<div style="position:absolute;left:123.00px;top:357.11px" class="cls_007"><span class="cls_007">parameter. We explored how JRuby parses and compiles our code, and</span></div>
<div style="position:absolute;left:123.00px;top:369.11px" class="cls_007"><span class="cls_007">learned in Experiment 10-1 how the JVM can compile hot spots, or fre-</span></div>
<div style="position:absolute;left:123.00px;top:381.11px" class="cls_007"><span class="cls_007">quently executed snippets of Java bytecode, into machine language. Our</span></div>
<div style="position:absolute;left:123.00px;top:393.11px" class="cls_007"><span class="cls_007">results from Experiment 10-1 showed that compiling hot spots dramati-</span></div>
<div style="position:absolute;left:123.00px;top:405.11px" class="cls_007"><span class="cls_007">cally improves performance, allowing JRuby to run even faster than MRI</span></div>
<div style="position:absolute;left:123.00px;top:417.11px" class="cls_007"><span class="cls_007">in some cases.</span></div>
<div style="position:absolute;left:141.00px;top:429.11px" class="cls_007"><span class="cls_007">In the second half of this chapter, we learned how MRI and JRuby</span></div>
<div style="position:absolute;left:123.00px;top:441.11px" class="cls_007"><span class="cls_007">represent our string data internally. We discovered that both versions of</span></div>
<div style="position:absolute;left:123.00px;top:453.11px" class="cls_007"><span class="cls_007">Ruby use copy-on-write optimization, sharing string data between differ-</span></div>
<div style="position:absolute;left:123.00px;top:465.11px" class="cls_007"><span class="cls_007">ent string objects when possible. Finally, in Experiment 10-2 we proved</span></div>
<div style="position:absolute;left:123.00px;top:477.11px" class="cls_007"><span class="cls_007">that copy-on-write actually occurred in both JRuby and MRI.</span></div>
<div style="position:absolute;left:141.00px;top:489.11px" class="cls_007"><span class="cls_007">JRuby is a very powerful and clever implementation of Ruby: By run-</span></div>
<div style="position:absolute;left:123.00px;top:501.11px" class="cls_007"><span class="cls_007">ning your Ruby code using the Java platform, you can benefit from the</span></div>
<div style="position:absolute;left:123.00px;top:513.11px" class="cls_007"><span class="cls_007">many years of research, development, tuning, and testing that have been</span></div>
<div style="position:absolute;left:123.00px;top:525.11px" class="cls_007"><span class="cls_007">invested in the JVM. The JVM is one of the most popular, mature, and pow-</span></div>
<div style="position:absolute;left:123.00px;top:537.11px" class="cls_007"><span class="cls_007">erful software platforms in use today. It’s being used not only by Java and</span></div>
<div style="position:absolute;left:123.00px;top:549.11px" class="cls_007"><span class="cls_007">JRuby but also by many other software languages, such as Clojure, Scala,</span></div>
<div style="position:absolute;left:123.00px;top:561.11px" class="cls_007"><span class="cls_007">and Jython, to name a few. By using this shared platform, JRuby can take</span></div>
<div style="position:absolute;left:123.00px;top:573.11px" class="cls_007"><span class="cls_007">advantage of the speed, robustness, and diversity of the Java platform—and</span></div>
<div style="position:absolute;left:123.00px;top:585.11px" class="cls_007"><span class="cls_007">it can do this for free!</span></div>
<div style="position:absolute;left:141.00px;top:597.11px" class="cls_007"><span class="cls_007">JRuby is a groundbreaking piece of technology with which every Ruby</span></div>
<div style="position:absolute;left:123.00px;top:609.11px" class="cls_007"><span class="cls_007">developer should be familiar.</span></div>
<div style="position:absolute;left:368.07px;top:636.00px" class="cls_021"><span class="cls_021">JRuby: Ruby on the JVM</span></div>
<div style="position:absolute;left:442.62px;top:633.00px" class="cls_020"><span class="cls_020">271</span></div>
</div>
<div style="position:absolute;left:50%;margin-left:-252px;top:196716px;width:504px;height:666px;border-style:outset;overflow:hidden">
<div style="position:absolute;left:0px;top:0px">
<img src="e698b76e-46bd-11eb-8b25-0cc47a792c0a_id_e698b76e-46bd-11eb-8b25-0cc47a792c0a_files/background296.jpg" width=504 height=666></div>
<div style="position:absolute;left:226.41px;top:297.71px" class="cls_024"><span class="cls_024">Rubinius uses Ruby to</span></div>
<div style="position:absolute;left:241.78px;top:315.72px" class="cls_024"><span class="cls_024">implement Ruby.</span></div>
</div>
<div style="position:absolute;left:50%;margin-left:-252px;top:197392px;width:504px;height:666px;border-style:outset;overflow:hidden">
<div style="position:absolute;left:0px;top:0px">
<img src="e698b76e-46bd-11eb-8b25-0cc47a792c0a_id_e698b76e-46bd-11eb-8b25-0cc47a792c0a_files/background297.jpg" width=504 height=666></div>
<div style="position:absolute;left:238.92px;top:96.48px" class="cls_035"><span class="cls_035">11</span></div>
<div style="position:absolute;left:237.71px;top:248.48px" class="cls_016"><span class="cls_016">Rubinius:</span></div>
<div style="position:absolute;left:131.89px;top:266.48px" class="cls_016"><span class="cls_016">Ruby Implemented with Ruby</span></div>
<div style="position:absolute;left:123.00px;top:382.48px" class="cls_023"><span class="cls_023">Like JRuby, Rubinius is an alternative implementa-</span></div>
<div style="position:absolute;left:123.00px;top:400.48px" class="cls_023"><span class="cls_023">tion of Ruby. Much of Rubinius’s internal source code</span></div>
<div style="position:absolute;left:123.00px;top:418.49px" class="cls_023"><span class="cls_023">is written in Ruby itself instead of in only C or Java.</span></div>
<div style="position:absolute;left:123.00px;top:436.48px" class="cls_023"><span class="cls_023">Rubinius implements built-in classes, such as </span><span class="cls_028">Array</span><span class="cls_023">,</span></div>
<div style="position:absolute;left:123.00px;top:454.48px" class="cls_028"><span class="cls_028">String</span><span class="cls_023">, and </span><span class="cls_028">Integer</span><span class="cls_023">, just as you would—with Ruby code!</span></div>
<div style="position:absolute;left:123.00px;top:473.48px" class="cls_007"><span class="cls_007">This design offers a unique opportunity for you to learn about Ruby inter-</span></div>
<div style="position:absolute;left:123.00px;top:485.48px" class="cls_007"><span class="cls_007">nals. If you aren’t sure how a particular Ruby feature or method works, you</span></div>
<div style="position:absolute;left:123.00px;top:497.48px" class="cls_007"><span class="cls_007">can read the Ruby code inside Rubinius to find out, without special knowl-</span></div>
<div style="position:absolute;left:123.00px;top:509.48px" class="cls_007"><span class="cls_007">edge of C or Java programming.</span></div>
</div>
<div style="position:absolute;left:50%;margin-left:-252px;top:198068px;width:504px;height:666px;border-style:outset;overflow:hidden">
<div style="position:absolute;left:0px;top:0px">
<img src="e698b76e-46bd-11eb-8b25-0cc47a792c0a_id_e698b76e-46bd-11eb-8b25-0cc47a792c0a_files/background298.jpg" width=504 height=666></div>
<div style="position:absolute;left:138.00px;top:42.28px" class="cls_007"><span class="cls_007">Rubinius also includes a sophisticated virtual machine written in C++.</span></div>
<div style="position:absolute;left:120.00px;top:54.28px" class="cls_007"><span class="cls_007">This machine executes your Ruby program and, like JRuby, supports JIT and</span></div>
<div style="position:absolute;left:120.00px;top:66.28px" class="cls_007"><span class="cls_007">true concurrency and uses a sophisticated garbage collection algorithm.</span></div>
<div style="position:absolute;left:138.00px;top:78.28px" class="cls_007"><span class="cls_007">This chapter starts with a high-level overview of Rubinius and an example</span></div>
<div style="position:absolute;left:120.00px;top:90.28px" class="cls_007"><span class="cls_007">of how to use backtrace output to dig through the Rubinius source code.</span></div>
<div style="position:absolute;left:120.00px;top:102.28px" class="cls_007"><span class="cls_007">Later in the chapter, we’ll learn how Rubinius and MRI implement the </span><span class="cls_030">Array</span></div>
<div style="position:absolute;left:120.00px;top:114.28px" class="cls_007"><span class="cls_007">class, including how Ruby saves data into an array and what happens when</span></div>
<div style="position:absolute;left:120.00px;top:126.28px" class="cls_007"><span class="cls_007">you remove an element from an array.</span></div>
<div style="position:absolute;left:259.97px;top:168.11px" class="cls_020"><span class="cls_020">Roadmap</span></div>
<div style="position:absolute;left:130.50px;top:185.11px" class="cls_017"><span class="cls_017">The Rubinius Kernel and Virtual Machine</span></div>
<div style="position:absolute;left:413.86px;top:185.11px" class="cls_017"><span class="cls_017">274</span></div>
<div style="position:absolute;left:148.50px;top:202.12px" class="cls_017"><span class="cls_017">Tokenization and Parsing</span></div>
<div style="position:absolute;left:413.86px;top:202.12px" class="cls_017"><span class="cls_017">276</span></div>
<div style="position:absolute;left:148.50px;top:219.12px" class="cls_017"><span class="cls_017">Using Ruby to Compile Ruby</span></div>
<div style="position:absolute;left:413.86px;top:219.12px" class="cls_017"><span class="cls_017">277</span></div>
<div style="position:absolute;left:148.50px;top:236.12px" class="cls_017"><span class="cls_017">Rubinius Bytecode Instructions</span></div>
<div style="position:absolute;left:413.86px;top:236.12px" class="cls_017"><span class="cls_017">278</span></div>
<div style="position:absolute;left:148.50px;top:253.12px" class="cls_017"><span class="cls_017">Ruby and C++ Working Together</span></div>
<div style="position:absolute;left:413.86px;top:253.12px" class="cls_017"><span class="cls_017">279</span></div>
<div style="position:absolute;left:148.50px;top:270.12px" class="cls_017"><span class="cls_017">Implementing Ruby Objects with C++ Objects</span></div>
<div style="position:absolute;left:413.86px;top:270.12px" class="cls_017"><span class="cls_017">280</span></div>
<div style="position:absolute;left:130.50px;top:287.12px" class="cls_019"><span class="cls_019">Experiment 11-1: Comparing Backtraces in MRI and Rubinius</span></div>
<div style="position:absolute;left:414.89px;top:287.12px" class="cls_019"><span class="cls_019">281</span></div>
<div style="position:absolute;left:148.50px;top:304.12px" class="cls_017"><span class="cls_017">Backtraces in Rubinius</span></div>
<div style="position:absolute;left:413.86px;top:304.12px" class="cls_017"><span class="cls_017">282</span></div>
<div style="position:absolute;left:130.50px;top:321.12px" class="cls_017"><span class="cls_017">Arrays in Rubinius and MRI</span></div>
<div style="position:absolute;left:413.86px;top:321.12px" class="cls_017"><span class="cls_017">284</span></div>
<div style="position:absolute;left:148.50px;top:338.12px" class="cls_017"><span class="cls_017">Arrays Inside of MRI</span></div>
<div style="position:absolute;left:413.86px;top:338.12px" class="cls_017"><span class="cls_017">285</span></div>
<div style="position:absolute;left:148.50px;top:355.11px" class="cls_017"><span class="cls_017">The </span><span class="cls_030">RArray</span><span class="cls_017"> C Structure Definition</span></div>
<div style="position:absolute;left:413.87px;top:355.11px" class="cls_017"><span class="cls_017">286</span></div>
<div style="position:absolute;left:148.50px;top:372.11px" class="cls_017"><span class="cls_017">Arrays Inside of Rubinius</span></div>
<div style="position:absolute;left:413.87px;top:372.11px" class="cls_017"><span class="cls_017">286</span></div>
<div style="position:absolute;left:130.50px;top:389.12px" class="cls_019"><span class="cls_019">Experiment 11-2: Exploring the Rubinius Implementation of</span></div>
<div style="position:absolute;left:148.50px;top:400.11px" class="cls_040"><span class="cls_040">Array#shift</span></div>
<div style="position:absolute;left:414.89px;top:400.11px" class="cls_019"><span class="cls_019">288</span></div>
<div style="position:absolute;left:148.50px;top:417.11px" class="cls_017"><span class="cls_017">Reading </span><span class="cls_030">Array#shift</span></div>
<div style="position:absolute;left:413.87px;top:417.11px" class="cls_017"><span class="cls_017">288</span></div>
<div style="position:absolute;left:148.50px;top:434.11px" class="cls_017"><span class="cls_017">Modifying </span><span class="cls_030">Array#shift</span></div>
<div style="position:absolute;left:413.86px;top:434.11px" class="cls_017"><span class="cls_017">289</span></div>
<div style="position:absolute;left:130.50px;top:451.11px" class="cls_017"><span class="cls_017">Summary</span></div>
<div style="position:absolute;left:413.86px;top:451.11px" class="cls_017"><span class="cls_017">292</span></div>
<div style="position:absolute;left:66.00px;top:505.28px" class="cls_031"><span class="cls_031">The Rubinius Kernel and Virtual Machine</span></div>
<div style="position:absolute;left:120.00px;top:525.28px" class="cls_007"><span class="cls_007">To run a Ruby program using Rubinius (see Figure 11-1), you typically use</span></div>
<div style="position:absolute;left:120.00px;top:537.28px" class="cls_007"><span class="cls_007">the </span><span class="cls_030">ruby</span><span class="cls_007"> command (as with MRI) or </span><span class="cls_030">rbx</span><span class="cls_007"> because the </span><span class="cls_030">ruby</span><span class="cls_007"> command is actu-</span></div>
<div style="position:absolute;left:120.00px;top:549.28px" class="cls_007"><span class="cls_007">ally a symbolic link to the executable </span><span class="cls_008">rbx</span><span class="cls_007"> in Rubinius.</span></div>
<div style="position:absolute;left:48.00px;top:633.00px" class="cls_020"><span class="cls_020">274</span></div>
<div style="position:absolute;left:74.02px;top:636.00px" class="cls_021"><span class="cls_021">Chapter 11</span></div>
</div>
<div style="position:absolute;left:50%;margin-left:-252px;top:198744px;width:504px;height:666px;border-style:outset;overflow:hidden">
<div style="position:absolute;left:0px;top:0px">
<img src="e698b76e-46bd-11eb-8b25-0cc47a792c0a_id_e698b76e-46bd-11eb-8b25-0cc47a792c0a_files/background299.jpg" width=504 height=666></div>
<div style="position:absolute;left:216.14px;top:43.46px" class="cls_063"><span class="cls_063">$ ruby block.rb</span></div>
<div style="position:absolute;left:216.14px;top:54.86px" class="cls_063"><span class="cls_063">$ rbx block.rb</span></div>
<div style="position:absolute;left:203.14px;top:95.11px" class="cls_063"><span class="cls_063">0101101110101</span></div>
<div style="position:absolute;left:306.63px;top:96.10px" class="cls_063"><span class="cls_063">10.times </span><span class="cls_197">do</span></div>
<div style="position:absolute;left:137.75px;top:106.11px" class="cls_017"><span class="cls_017">Rubinius</span></div>
<div style="position:absolute;left:203.14px;top:105.60px" class="cls_063"><span class="cls_063">0100110101001</span></div>
<div style="position:absolute;left:316.13px;top:108.10px" class="cls_063"><span class="cls_063">puts n</span></div>
<div style="position:absolute;left:123.00px;top:116.91px" class="cls_017"><span class="cls_017">Virtual Machine</span></div>
<div style="position:absolute;left:203.14px;top:116.10px" class="cls_063"><span class="cls_063">0101010101010</span></div>
<div style="position:absolute;left:306.63px;top:120.10px" class="cls_197"><span class="cls_197">end</span></div>
<div style="position:absolute;left:142.57px;top:127.71px" class="cls_017"><span class="cls_017">(C++)</span></div>
<div style="position:absolute;left:203.14px;top:126.60px" class="cls_063"><span class="cls_063">1100010100110</span></div>
<div style="position:absolute;left:203.14px;top:137.10px" class="cls_063"><span class="cls_063">0101010101011</span></div>
<div style="position:absolute;left:331.43px;top:161.10px" class="cls_017"><span class="cls_017">Ruby</span></div>
<div style="position:absolute;left:329.98px;top:171.61px" class="cls_017"><span class="cls_017">Script</span></div>
<div style="position:absolute;left:204.39px;top:201.23px" class="cls_063"><span class="cls_063">class String</span></div>
<div style="position:absolute;left:124.03px;top:219.73px" class="cls_017"><span class="cls_017">Rubinius Kernel</span></div>
<div style="position:absolute;left:204.39px;top:225.23px" class="cls_063"><span class="cls_063">end</span></div>
<div style="position:absolute;left:141.76px;top:230.53px" class="cls_017"><span class="cls_017">(Ruby)</span></div>
<div style="position:absolute;left:204.39px;top:249.22px" class="cls_063"><span class="cls_063">--</span><span class="cls_064">snip</span><span class="cls_063">--</span></div>
<div style="position:absolute;left:123.00px;top:273.16px" class="cls_038"><span class="cls_038">Figure 11-1: Rubinius consists of a C++ virtual machine and a Ruby kernel.</span></div>
<div style="position:absolute;left:141.00px;top:295.66px" class="cls_007"><span class="cls_007">As with MRI, you launch Rubinius using an executable that reads and</span></div>
<div style="position:absolute;left:123.00px;top:307.66px" class="cls_007"><span class="cls_007">executes the Ruby program specified on the command line. But the Rubinius</span></div>
<div style="position:absolute;left:123.00px;top:319.66px" class="cls_007"><span class="cls_007">executable is completely different from the standard Ruby executable. As the</span></div>
<div style="position:absolute;left:123.00px;top:331.66px" class="cls_007"><span class="cls_007">preceding figure shows, Rubinius consists of two major pieces:</span></div>
<div style="position:absolute;left:141.00px;top:349.66px" class="cls_034"><span class="cls_034">The Rubinius kernel</span><span class="cls_007">   This is the part of Rubinius written in Ruby.</span></div>
<div style="position:absolute;left:141.00px;top:361.66px" class="cls_007"><span class="cls_007">It implements a lot of the language, including the definitions of many</span></div>
<div style="position:absolute;left:141.00px;top:373.66px" class="cls_007"><span class="cls_007">built-in, core classes, such as </span><span class="cls_030">String</span><span class="cls_007"> and </span><span class="cls_030">Array</span><span class="cls_007">. The Rubinius kernel</span></div>
<div style="position:absolute;left:141.00px;top:385.66px" class="cls_007"><span class="cls_007">is compiled into bytecode instructions that are installed onto your</span></div>
<div style="position:absolute;left:141.00px;top:397.66px" class="cls_007"><span class="cls_007">computer.</span></div>
<div style="position:absolute;left:141.00px;top:412.66px" class="cls_034"><span class="cls_034">The Rubinius virtual machine</span><span class="cls_007">   The Rubinius virtual machine is writ-</span></div>
<div style="position:absolute;left:141.00px;top:424.66px" class="cls_007"><span class="cls_007">ten in C++. It executes the bytecode instructions from the Rubinius</span></div>
<div style="position:absolute;left:141.00px;top:436.66px" class="cls_007"><span class="cls_007">kernel and performs a range of other low-level tasks, such as garbage</span></div>
<div style="position:absolute;left:141.00px;top:448.66px" class="cls_007"><span class="cls_007">collection. The Rubinius executable contains a compiled, machine-</span></div>
<div style="position:absolute;left:141.00px;top:460.66px" class="cls_007"><span class="cls_007">language version of this virtual machine.</span></div>
<div style="position:absolute;left:141.00px;top:478.66px" class="cls_007"><span class="cls_007">Figure 11-2 takes a closer look at Rubinius’s virtual machine and kernel.</span></div>
<div style="position:absolute;left:123.00px;top:490.66px" class="cls_007"><span class="cls_007">The Rubinius kernel contains a set of Ruby classes, such as </span><span class="cls_030">String</span><span class="cls_007">, </span><span class="cls_030">Array</span><span class="cls_007">, and</span></div>
<div style="position:absolute;left:123.00px;top:502.66px" class="cls_030"><span class="cls_030">Object</span><span class="cls_007">, as well as other Ruby classes that perform various tasks, such as com-</span></div>
<div style="position:absolute;left:123.00px;top:514.66px" class="cls_007"><span class="cls_007">piling or loading code. The Rubinius virtual machine at the left of the figure</span></div>
<div style="position:absolute;left:123.00px;top:526.66px" class="cls_007"><span class="cls_007">is the </span><span class="cls_008">rbx</span><span class="cls_007"> executable that you launch from the command line. The C++ vir-</span></div>
<div style="position:absolute;left:123.01px;top:538.66px" class="cls_007"><span class="cls_007">tual machine contains code to perform garbage collection, just-in-time com-</span></div>
<div style="position:absolute;left:123.01px;top:550.66px" class="cls_007"><span class="cls_007">pilation (and many other tasks), as well as additional code for built-in classes,</span></div>
<div style="position:absolute;left:123.01px;top:562.66px" class="cls_007"><span class="cls_007">such as </span><span class="cls_030">String</span><span class="cls_007"> or </span><span class="cls_030">Array</span><span class="cls_007">. In fact, as indicated by the arrows, each Ruby class</span></div>
<div style="position:absolute;left:123.00px;top:574.66px" class="cls_007"><span class="cls_007">built into Rubinius consists of both C++ and Ruby code working together.</span></div>
<div style="position:absolute;left:123.00px;top:586.66px" class="cls_007"><span class="cls_007">Rubinius defines certain methods using Ruby and other methods using C++.</span></div>
<div style="position:absolute;left:326.97px;top:636.00px" class="cls_021"><span class="cls_021">Rubinius: Ruby Implemented with Ruby</span></div>
<div style="position:absolute;left:442.69px;top:633.00px" class="cls_020"><span class="cls_020">275</span></div>
</div>
<div style="position:absolute;left:50%;margin-left:-252px;top:199420px;width:504px;height:666px;border-style:outset;overflow:hidden">
<div style="position:absolute;left:0px;top:0px">
<img src="e698b76e-46bd-11eb-8b25-0cc47a792c0a_id_e698b76e-46bd-11eb-8b25-0cc47a792c0a_files/background300.jpg" width=504 height=666></div>
<div style="position:absolute;left:142.25px;top:56.83px" class="cls_017"><span class="cls_017">Other Code</span></div>
<div style="position:absolute;left:227.02px;top:56.83px" class="cls_017"><span class="cls_017">Built-In Classes</span></div>
<div style="position:absolute;left:359.63px;top:60.68px" class="cls_063"><span class="cls_063">class String</span></div>
<div style="position:absolute;left:359.63px;top:84.68px" class="cls_063"><span class="cls_063">end</span></div>
<div style="position:absolute;left:159.50px;top:92.51px" class="cls_014"><span class="cls_014">JIT</span></div>
<div style="position:absolute;left:243.50px;top:92.51px" class="cls_014"><span class="cls_014">String</span></div>
<div style="position:absolute;left:359.63px;top:117.68px" class="cls_063"><span class="cls_063">class Array</span></div>
<div style="position:absolute;left:161.50px;top:122.51px" class="cls_014"><span class="cls_014">GC</span></div>
<div style="position:absolute;left:245.50px;top:122.51px" class="cls_014"><span class="cls_014">Array</span></div>
<div style="position:absolute;left:153.50px;top:144.52px" class="cls_014"><span class="cls_014">etc...</span></div>
<div style="position:absolute;left:243.50px;top:144.52px" class="cls_014"><span class="cls_014">etc...</span></div>
<div style="position:absolute;left:359.63px;top:141.68px" class="cls_063"><span class="cls_063">end</span></div>
<div style="position:absolute;left:382.00px;top:167.74px" class="cls_014"><span class="cls_014">etc...</span></div>
<div style="position:absolute;left:194.32px;top:189.12px" class="cls_017"><span class="cls_017">Rubinius</span></div>
<div style="position:absolute;left:364.12px;top:194.52px" class="cls_017"><span class="cls_017">Rubinius Kernel</span></div>
<div style="position:absolute;left:179.58px;top:199.92px" class="cls_017"><span class="cls_017">Virtual Machine</span></div>
<div style="position:absolute;left:381.84px;top:205.32px" class="cls_017"><span class="cls_017">(Ruby)</span></div>
<div style="position:absolute;left:199.15px;top:210.72px" class="cls_017"><span class="cls_017">(C++)</span></div>
<div style="position:absolute;left:120.00px;top:234.00px" class="cls_038"><span class="cls_038">Figure 11-2: A closer view of Rubinius internals</span></div>
<div style="position:absolute;left:138.00px;top:256.50px" class="cls_007"><span class="cls_007">Why implement Ruby using two languages? Because C++ speeds up</span></div>
<div style="position:absolute;left:120.00px;top:268.50px" class="cls_007"><span class="cls_007">Rubinius programs and allows them to interact with the operating system</span></div>
<div style="position:absolute;left:120.00px;top:280.50px" class="cls_007"><span class="cls_007">directly at a low level. The use of C++ instead of C also allows Rubinius to</span></div>
<div style="position:absolute;left:120.00px;top:292.50px" class="cls_007"><span class="cls_007">use an elegant object-oriented design internally. And the use of Ruby to</span></div>
<div style="position:absolute;left:120.00px;top:304.50px" class="cls_007"><span class="cls_007">implement built-in classes and other features makes it easy for Ruby devel-</span></div>
<div style="position:absolute;left:120.00px;top:316.50px" class="cls_007"><span class="cls_007">opers to read and understand much of the Rubinius source code.</span></div>
<div style="position:absolute;left:120.00px;top:341.50px" class="cls_055"><span class="cls_055">Tokenization and Parsing</span></div>
<div style="position:absolute;left:120.00px;top:359.50px" class="cls_007"><span class="cls_007">Rubinius processes your Ruby program in much the same way that MRI</span></div>
<div style="position:absolute;left:120.00px;top:371.50px" class="cls_007"><span class="cls_007">does, as shown in Figure 11-3.</span></div>
<div style="position:absolute;left:246.52px;top:392.79px" class="cls_198"><span class="cls_198">Rubinius Build Time</span></div>
<div style="position:absolute;left:130.37px;top:420.88px" class="cls_051"><span class="cls_051">Grammar</span></div>
<div style="position:absolute;left:195.13px;top:419.87px" class="cls_053"><span class="cls_053">Generate</span></div>
<div style="position:absolute;left:259.44px;top:420.88px" class="cls_051"><span class="cls_051">Parser Code</span></div>
<div style="position:absolute;left:137.31px;top:429.28px" class="cls_051"><span class="cls_051">Rules</span></div>
<div style="position:absolute;left:199.13px;top:429.47px" class="cls_053"><span class="cls_053">Parser</span></div>
<div style="position:absolute;left:267.85px;top:429.28px" class="cls_051"><span class="cls_051">(</span><span class="cls_052">.c</span><span class="cls_051"> file)</span></div>
<div style="position:absolute;left:134.61px;top:437.68px" class="cls_051"><span class="cls_051">(</span><span class="cls_052">.y</span><span class="cls_051"> file)</span></div>
<div style="position:absolute;left:199.56px;top:439.07px" class="cls_054"><span class="cls_054">(Bison)</span></div>
<div style="position:absolute;left:410.85px;top:508.94px" class="cls_051"><span class="cls_051">Rubinius</span></div>
<div style="position:absolute;left:128.16px;top:513.14px" class="cls_051"><span class="cls_051">Ruby Code</span></div>
<div style="position:absolute;left:197.30px;top:518.74px" class="cls_053"><span class="cls_053">Tokenize</span></div>
<div style="position:absolute;left:274.40px;top:518.74px" class="cls_053"><span class="cls_053">Parse</span></div>
<div style="position:absolute;left:341.49px;top:518.74px" class="cls_053"><span class="cls_053">Compile</span></div>
<div style="position:absolute;left:406.91px;top:517.34px" class="cls_051"><span class="cls_051">Instructions</span></div>
<div style="position:absolute;left:131.76px;top:521.54px" class="cls_051"><span class="cls_051">(</span><span class="cls_052">.rb</span><span class="cls_051"> files)</span></div>
<div style="position:absolute;left:408.52px;top:525.74px" class="cls_051"><span class="cls_051">(.</span><span class="cls_052">rbc</span><span class="cls_051"> files)</span></div>
<div style="position:absolute;left:238.70px;top:537.53px" class="cls_051"><span class="cls_051">tokens</span></div>
<div style="position:absolute;left:312.97px;top:537.53px" class="cls_051"><span class="cls_051">AST</span></div>
<div style="position:absolute;left:309.96px;top:545.93px" class="cls_051"><span class="cls_051">nodes</span></div>
<div style="position:absolute;left:266.62px;top:561.08px" class="cls_198"><span class="cls_198">Run Time</span></div>
<div style="position:absolute;left:120.00px;top:580.71px" class="cls_038"><span class="cls_038">Figure 11-3: How Rubinius processes your code</span></div>
<div style="position:absolute;left:48.00px;top:633.00px" class="cls_020"><span class="cls_020">276</span></div>
<div style="position:absolute;left:74.10px;top:636.00px" class="cls_021"><span class="cls_021">Chapter 11</span></div>
</div>
<div style="position:absolute;left:50%;margin-left:-252px;top:200096px;width:504px;height:666px;border-style:outset;overflow:hidden">
<div style="position:absolute;left:0px;top:0px">
<img src="e698b76e-46bd-11eb-8b25-0cc47a792c0a_id_e698b76e-46bd-11eb-8b25-0cc47a792c0a_files/background301.jpg" width=504 height=666></div>
<div style="position:absolute;left:141.00px;top:41.60px" class="cls_007"><span class="cls_007">Rubinius generates an</span></div>
<div style="position:absolute;left:307.22px;top:43.83px" class="cls_208"><span class="cls_208">MRI</span></div>
<div style="position:absolute;left:382.46px;top:43.83px" class="cls_208"><span class="cls_208">Rubinius</span></div>
<div style="position:absolute;left:123.00px;top:53.60px" class="cls_007"><span class="cls_007">LALR parser using Bison dur-</span></div>
<div style="position:absolute;left:123.00px;top:65.60px" class="cls_007"><span class="cls_007">ing its build process, just as</span></div>
<div style="position:absolute;left:306.83px;top:70.16px" class="cls_149"><span class="cls_149">Ruby</span></div>
<div style="position:absolute;left:391.18px;top:70.06px" class="cls_149"><span class="cls_149">Ruby</span></div>
<div style="position:absolute;left:123.00px;top:77.60px" class="cls_007"><span class="cls_007">MRI does. When you run your</span></div>
<div style="position:absolute;left:123.00px;top:89.60px" class="cls_007"><span class="cls_007">program, the parser converts</span></div>
<div style="position:absolute;left:123.00px;top:101.60px" class="cls_007"><span class="cls_007">your code into a token stream,</span></div>
<div style="position:absolute;left:303.88px;top:101.83px" class="cls_149"><span class="cls_149">Tokens</span></div>
<div style="position:absolute;left:388.22px;top:101.73px" class="cls_149"><span class="cls_149">Tokens</span></div>
<div style="position:absolute;left:123.00px;top:113.60px" class="cls_007"><span class="cls_007">an abstract syntax tree (AST)</span></div>
<div style="position:absolute;left:123.00px;top:125.60px" class="cls_007"><span class="cls_007">structure, and then a series</span></div>
<div style="position:absolute;left:297.26px;top:132.75px" class="cls_149"><span class="cls_149">AST Nodes</span></div>
<div style="position:absolute;left:381.61px;top:132.65px" class="cls_149"><span class="cls_149">AST Nodes</span></div>
<div style="position:absolute;left:123.00px;top:137.60px" class="cls_007"><span class="cls_007">of high-level virtual machine</span></div>
<div style="position:absolute;left:123.00px;top:149.60px" class="cls_007"><span class="cls_007">instructions called </span><span class="cls_008">Rubinius</span></div>
<div style="position:absolute;left:123.00px;top:161.60px" class="cls_008"><span class="cls_008">instructions</span><span class="cls_007">. Figure 11-4 com-</span></div>
<div style="position:absolute;left:305.84px;top:161.76px" class="cls_149"><span class="cls_149">YARV</span></div>
<div style="position:absolute;left:385.66px;top:161.76px" class="cls_149"><span class="cls_149">Rubinius</span></div>
<div style="position:absolute;left:296.85px;top:170.88px" class="cls_149"><span class="cls_149">Instructions</span></div>
<div style="position:absolute;left:381.19px;top:170.88px" class="cls_149"><span class="cls_149">Instructions</span></div>
<div style="position:absolute;left:123.00px;top:173.60px" class="cls_007"><span class="cls_007">pares the forms that your</span></div>
<div style="position:absolute;left:123.00px;top:185.60px" class="cls_007"><span class="cls_007">code takes inside MRI and</span></div>
<div style="position:absolute;left:390.87px;top:194.06px" class="cls_149"><span class="cls_149">LLVM</span></div>
<div style="position:absolute;left:320.90px;top:197.08px" class="cls_148"><span class="cls_148">Interpret</span></div>
<div style="position:absolute;left:123.00px;top:197.60px" class="cls_007"><span class="cls_007">Rubinius.</span></div>
<div style="position:absolute;left:381.19px;top:203.18px" class="cls_149"><span class="cls_149">Instructions</span></div>
<div style="position:absolute;left:141.00px;top:209.60px" class="cls_007"><span class="cls_007">At first, Rubinius and MRI</span></div>
<div style="position:absolute;left:123.00px;top:221.60px" class="cls_007"><span class="cls_007">work similarly, but instead of</span></div>
<div style="position:absolute;left:385.64px;top:225.19px" class="cls_149"><span class="cls_149">Machine</span></div>
<div style="position:absolute;left:312.90px;top:230.26px" class="cls_149"><span class="cls_149">C</span></div>
<div style="position:absolute;left:123.00px;top:233.60px" class="cls_007"><span class="cls_007">interpreting your code as MRI</span></div>
<div style="position:absolute;left:383.45px;top:234.31px" class="cls_149"><span class="cls_149">Language</span></div>
<div style="position:absolute;left:123.00px;top:245.60px" class="cls_007"><span class="cls_007">does, Rubinius uses a com-</span></div>
<div style="position:absolute;left:123.00px;top:257.60px" class="cls_007"><span class="cls_007">piler framework called the</span></div>
<div style="position:absolute;left:301.29px;top:257.59px" class="cls_149"><span class="cls_149">Machine</span></div>
<div style="position:absolute;left:299.10px;top:266.71px" class="cls_149"><span class="cls_149">Language</span></div>
<div style="position:absolute;left:123.00px;top:269.60px" class="cls_007"><span class="cls_007">Low-Level Virtual Machine</span></div>
<div style="position:absolute;left:123.00px;top:281.60px" class="cls_007"><span class="cls_007">(LLVM) to compile your code</span></div>
<div style="position:absolute;left:123.00px;top:293.60px" class="cls_007"><span class="cls_007">again into lower-level instruc-</span></div>
<div style="position:absolute;left:279.45px;top:294.33px" class="cls_038"><span class="cls_038">Figure 11-4: How MRI and Rubinius transform</span></div>
<div style="position:absolute;left:123.00px;top:305.60px" class="cls_007"><span class="cls_007">tions. LLVM, in turn, may</span></div>
<div style="position:absolute;left:279.45px;top:304.83px" class="cls_038"><span class="cls_038">your code internally</span></div>
<div style="position:absolute;left:123.00px;top:317.60px" class="cls_007"><span class="cls_007">compile these instructions all</span></div>
<div style="position:absolute;left:123.00px;top:329.60px" class="cls_007"><span class="cls_007">the way to machine language,</span></div>
<div style="position:absolute;left:308.23px;top:334.83px" class="cls_208"><span class="cls_208">C++/C</span></div>
<div style="position:absolute;left:410.14px;top:334.83px" class="cls_208"><span class="cls_208">Ruby</span></div>
<div style="position:absolute;left:123.00px;top:341.60px" class="cls_007"><span class="cls_007">using a JIT compiler.</span></div>
<div style="position:absolute;left:315.24px;top:362.96px" class="cls_149"><span class="cls_149">Ruby</span></div>
<div style="position:absolute;left:123.00px;top:373.60px" class="cls_055"><span class="cls_055">Using Ruby to Compile Ruby</span></div>
<div style="position:absolute;left:123.00px;top:391.60px" class="cls_007"><span class="cls_007">One of the most fascinating</span></div>
<div style="position:absolute;left:312.29px;top:394.63px" class="cls_149"><span class="cls_149">Tokens</span></div>
<div style="position:absolute;left:123.00px;top:403.60px" class="cls_007"><span class="cls_007">aspects of Rubinius is how it</span></div>
<div style="position:absolute;left:123.00px;top:415.60px" class="cls_007"><span class="cls_007">implements a Ruby compiler</span></div>
<div style="position:absolute;left:284.13px;top:422.21px" class="cls_148"><span class="cls_148">Bison-generated C code</span></div>
<div style="position:absolute;left:402.35px;top:425.55px" class="cls_149"><span class="cls_149">AST Nodes</span></div>
<div style="position:absolute;left:123.00px;top:427.60px" class="cls_007"><span class="cls_007">with a combination of Ruby</span></div>
<div style="position:absolute;left:286.52px;top:431.33px" class="cls_148"><span class="cls_148">parses your code files.</span></div>
<div style="position:absolute;left:123.00px;top:439.60px" class="cls_007"><span class="cls_007">and C++. When you run a</span></div>
<div style="position:absolute;left:123.00px;top:451.60px" class="cls_007"><span class="cls_007">program using Rubinius, your</span></div>
<div style="position:absolute;left:406.40px;top:454.66px" class="cls_149"><span class="cls_149">Rubinius</span></div>
<div style="position:absolute;left:123.00px;top:463.60px" class="cls_007"><span class="cls_007">code is processed by both C++</span></div>
<div style="position:absolute;left:401.93px;top:463.78px" class="cls_149"><span class="cls_149">Instructions</span></div>
<div style="position:absolute;left:123.00px;top:475.60px" class="cls_007"><span class="cls_007">and Ruby code, as shown in</span></div>
<div style="position:absolute;left:314.94px;top:486.96px" class="cls_149"><span class="cls_149">LLVM</span></div>
<div style="position:absolute;left:386.15px;top:488.08px" class="cls_148"><span class="cls_148">Ruby code compiles</span></div>
<div style="position:absolute;left:123.00px;top:487.60px" class="cls_007"><span class="cls_007">Figure 11-5.</span></div>
<div style="position:absolute;left:305.25px;top:496.08px" class="cls_149"><span class="cls_149">Instructions</span></div>
<div style="position:absolute;left:389.43px;top:497.20px" class="cls_148"><span class="cls_148">the AST nodes into</span></div>
<div style="position:absolute;left:141.00px;top:499.60px" class="cls_007"><span class="cls_007">At the top left of the dia-</span></div>
<div style="position:absolute;left:386.25px;top:506.32px" class="cls_148"><span class="cls_148">Rubinius instructions.</span></div>
<div style="position:absolute;left:123.00px;top:511.60px" class="cls_007"><span class="cls_007">gram, Rubinius, like MRI, uses</span></div>
<div style="position:absolute;left:309.70px;top:518.09px" class="cls_149"><span class="cls_149">Machine</span></div>
<div style="position:absolute;left:123.00px;top:523.60px" class="cls_007"><span class="cls_007">C code to parse Ruby code with</span></div>
<div style="position:absolute;left:307.51px;top:527.21px" class="cls_149"><span class="cls_149">Language</span></div>
<div style="position:absolute;left:123.00px;top:535.60px" class="cls_007"><span class="cls_007">a series of grammar rules. At</span></div>
<div style="position:absolute;left:123.00px;top:547.60px" class="cls_007"><span class="cls_007">right, Rubinius starts to process</span></div>
<div style="position:absolute;left:283.82px;top:551.70px" class="cls_148"><span class="cls_148">The Rubinius instructions</span></div>
<div style="position:absolute;left:123.00px;top:559.60px" class="cls_007"><span class="cls_007">your Ruby program using Ruby</span></div>
<div style="position:absolute;left:293.52px;top:560.82px" class="cls_148"><span class="cls_148">are compiled into</span></div>
<div style="position:absolute;left:287.05px;top:569.94px" class="cls_148"><span class="cls_148">LLVM instructions and</span></div>
<div style="position:absolute;left:123.00px;top:571.60px" class="cls_007"><span class="cls_007">code, representing each node</span></div>
<div style="position:absolute;left:279.46px;top:579.06px" class="cls_148"><span class="cls_148">ultimately into native code.</span></div>
<div style="position:absolute;left:123.00px;top:583.60px" class="cls_007"><span class="cls_007">in the AST with an instance of</span></div>
<div style="position:absolute;left:123.00px;top:595.60px" class="cls_007"><span class="cls_007">a Ruby class. Each Ruby AST</span></div>
<div style="position:absolute;left:279.45px;top:599.00px" class="cls_038"><span class="cls_038">Figure 11-5: A high-level overview of how</span></div>
<div style="position:absolute;left:123.00px;top:607.60px" class="cls_007"><span class="cls_007">node knows how to generate</span></div>
<div style="position:absolute;left:279.45px;top:609.50px" class="cls_038"><span class="cls_038">Rubinius compiles your code</span></div>
<div style="position:absolute;left:326.74px;top:636.00px" class="cls_021"><span class="cls_021">Rubinius: Ruby Implemented with Ruby</span></div>
<div style="position:absolute;left:442.46px;top:633.00px" class="cls_020"><span class="cls_020">277</span></div>
</div>
<div style="position:absolute;left:50%;margin-left:-252px;top:200772px;width:504px;height:666px;border-style:outset;overflow:hidden">
<div style="position:absolute;left:0px;top:0px">
<img src="e698b76e-46bd-11eb-8b25-0cc47a792c0a_id_e698b76e-46bd-11eb-8b25-0cc47a792c0a_files/background302.jpg" width=504 height=666></div>
<div style="position:absolute;left:120.00px;top:42.28px" class="cls_007"><span class="cls_007">Rubinius instructions for its piece of your program during compilation.</span></div>
<div style="position:absolute;left:120.00px;top:54.28px" class="cls_007"><span class="cls_007">Finally, at bottom left, the LLVM framework further compiles the Rubinius</span></div>
<div style="position:absolute;left:120.00px;top:66.28px" class="cls_007"><span class="cls_007">instructions into LLVM instructions and ultimately into machine language.</span></div>
<div style="position:absolute;left:120.00px;top:91.28px" class="cls_055"><span class="cls_055">Rubinius Bytecode Instructions</span></div>
<div style="position:absolute;left:120.00px;top:109.28px" class="cls_007"><span class="cls_007">To get a sense of Rubinius instructions, let’s run a short program using</span></div>
<div style="position:absolute;left:120.00px;top:121.28px" class="cls_007"><span class="cls_007">Rubinius (see Listing 11-1).</span></div>
<div style="position:absolute;left:120.00px;top:145.28px" class="cls_030"><span class="cls_030">$ </span><span class="cls_040">cat simple.rb</span></div>
<div style="position:absolute;left:120.00px;top:155.78px" class="cls_030"><span class="cls_030">puts 2+2</span></div>
<div style="position:absolute;left:120.00px;top:166.27px" class="cls_030"><span class="cls_030">$ </span><span class="cls_040">rbx simple.rb</span></div>
<div style="position:absolute;left:120.00px;top:176.77px" class="cls_030"><span class="cls_030">4</span></div>
<div style="position:absolute;left:120.00px;top:199.27px" class="cls_038"><span class="cls_038">Listing 11-1: Using Rubinius to calculate 2 + 2 = 4 </span><span class="cls_039">(simple.rb)</span></div>
<div style="position:absolute;left:138.00px;top:221.78px" class="cls_007"><span class="cls_007">When we rerun </span><span class="cls_008">simple.rb</span><span class="cls_007"> using the </span><span class="cls_030">rbx compile</span><span class="cls_007"> command with the </span><span class="cls_030">-B</span><span class="cls_007"> option,</span></div>
<div style="position:absolute;left:120.00px;top:233.78px" class="cls_007"><span class="cls_007">Rubinius displays the bytecode instructions its compiler generates, as shown</span></div>
<div style="position:absolute;left:120.00px;top:245.78px" class="cls_007"><span class="cls_007">in Listing 11-2.</span></div>
<div style="position:absolute;left:120.00px;top:269.78px" class="cls_030"><span class="cls_030">$ </span><span class="cls_040">rbx compile simple.rb -B</span></div>
<div style="position:absolute;left:120.00px;top:280.28px" class="cls_030"><span class="cls_030">=============</span></div>
<div style="position:absolute;left:179.50px;top:280.28px" class="cls_030"><span class="cls_030">:__script__ ==============</span></div>
<div style="position:absolute;left:120.00px;top:290.77px" class="cls_030"><span class="cls_030">Arguments:</span></div>
<div style="position:absolute;left:175.25px;top:290.77px" class="cls_030"><span class="cls_030">0 required, 0 post, 0 total</span></div>
<div style="position:absolute;left:120.00px;top:301.27px" class="cls_030"><span class="cls_030">Arity:</span></div>
<div style="position:absolute;left:175.25px;top:301.27px" class="cls_030"><span class="cls_030">0</span></div>
<div style="position:absolute;left:120.00px;top:311.77px" class="cls_030"><span class="cls_030">Locals:</span></div>
<div style="position:absolute;left:175.25px;top:311.77px" class="cls_030"><span class="cls_030">0</span></div>
<div style="position:absolute;left:120.00px;top:322.27px" class="cls_030"><span class="cls_030">Stack size:</span></div>
<div style="position:absolute;left:175.25px;top:322.27px" class="cls_030"><span class="cls_030">3</span></div>
<div style="position:absolute;left:120.00px;top:332.77px" class="cls_030"><span class="cls_030">Literals:</span></div>
<div style="position:absolute;left:175.25px;top:332.77px" class="cls_030"><span class="cls_030">2: :+, :puts</span></div>
<div style="position:absolute;left:120.00px;top:343.26px" class="cls_030"><span class="cls_030">Lines to IP: 1: 0..12</span></div>
<div style="position:absolute;left:120.00px;top:364.27px" class="cls_030"><span class="cls_030">0000:  push_self</span></div>
<div style="position:absolute;left:120.00px;top:374.76px" class="cls_030"><span class="cls_030">0001:  meta_push_2</span></div>
<div style="position:absolute;left:120.00px;top:385.26px" class="cls_030"><span class="cls_030">0002:  meta_push_2</span></div>
<div style="position:absolute;left:108.15px;top:395.76px" class="cls_046"><span class="cls_046">u</span><span class="cls_030"> 0003:  send_stack</span></div>
<div style="position:absolute;left:264.48px;top:395.76px" class="cls_030"><span class="cls_030">:+, 1</span></div>
<div style="position:absolute;left:120.00px;top:406.26px" class="cls_030"><span class="cls_030">0006:  allow_private</span></div>
<div style="position:absolute;left:108.15px;top:416.75px" class="cls_046"><span class="cls_046">v</span><span class="cls_030"> 0007:  send_stack</span></div>
<div style="position:absolute;left:264.48px;top:416.75px" class="cls_030"><span class="cls_030">:puts, 1</span></div>
<div style="position:absolute;left:120.00px;top:427.25px" class="cls_030"><span class="cls_030">0010:  pop</span></div>
<div style="position:absolute;left:120.00px;top:437.75px" class="cls_030"><span class="cls_030">0011:  push_true</span></div>
<div style="position:absolute;left:120.00px;top:448.25px" class="cls_030"><span class="cls_030">0012:  ret</span></div>
<div style="position:absolute;left:120.00px;top:458.74px" class="cls_030"><span class="cls_030">----------------------------------------</span></div>
<div style="position:absolute;left:120.00px;top:481.24px" class="cls_038"><span class="cls_038">Listing 11-2: Displaying Rubinius bytecode instructions using the </span><span class="cls_014">rbx compile</span><span class="cls_038"> command</span></div>
<div style="position:absolute;left:120.00px;top:491.78px" class="cls_038"><span class="cls_038">with the </span><span class="cls_014">-B</span><span class="cls_038"> option</span></div>
<div style="position:absolute;left:138.00px;top:514.28px" class="cls_007"><span class="cls_007">The instructions vaguely resemble MRI’s YARV instructions. Each</span></div>
<div style="position:absolute;left:120.00px;top:526.28px" class="cls_007"><span class="cls_007">instruction typically pushes a value onto an internal stack, operates on</span></div>
<div style="position:absolute;left:120.00px;top:538.28px" class="cls_007"><span class="cls_007">stack values, or executes a method such as the </span><span class="cls_030">+</span><span class="cls_007"> at </span><span class="cls_050">u</span><span class="cls_007"> or </span><span class="cls_030">puts</span><span class="cls_007"> at </span><span class="cls_050">v</span><span class="cls_007">.</span></div>
<div style="position:absolute;left:138.00px;top:550.28px" class="cls_007"><span class="cls_007">Figure 11-6 shows both the Ruby code and corresponding Rubinius</span></div>
<div style="position:absolute;left:120.00px;top:562.28px" class="cls_007"><span class="cls_007">instructions for </span><span class="cls_008">simple.rb</span><span class="cls_007"> and part of the </span><span class="cls_030">Kernel</span><span class="cls_007"> module.</span></div>
<div style="position:absolute;left:48.00px;top:633.00px" class="cls_020"><span class="cls_020">278</span></div>
<div style="position:absolute;left:74.41px;top:636.00px" class="cls_021"><span class="cls_021">Chapter 11</span></div>
</div>
<div style="position:absolute;left:50%;margin-left:-252px;top:201448px;width:504px;height:666px;border-style:outset;overflow:hidden">
<div style="position:absolute;left:0px;top:0px">
<img src="e698b76e-46bd-11eb-8b25-0cc47a792c0a_id_e698b76e-46bd-11eb-8b25-0cc47a792c0a_files/background303.jpg" width=504 height=666></div>
<div style="position:absolute;left:162.58px;top:51.17px" class="cls_199"><span class="cls_199">Your Code</span></div>
<div style="position:absolute;left:316.12px;top:51.17px" class="cls_199"><span class="cls_199">Rubinius Code</span></div>
<div style="position:absolute;left:127.46px;top:79.15px" class="cls_063"><span class="cls_063">puts 2+2</span></div>
<div style="position:absolute;left:275.46px;top:79.15px" class="cls_063"><span class="cls_063">module Kernel</span></div>
<div style="position:absolute;left:275.46px;top:101.95px" class="cls_063"><span class="cls_063">def puts</span></div>
<div style="position:absolute;left:284.96px;top:113.35px" class="cls_063"><span class="cls_063">--</span><span class="cls_064">snip</span><span class="cls_063">--</span></div>
<div style="position:absolute;left:275.46px;top:124.75px" class="cls_063"><span class="cls_063">end</span></div>
<div style="position:absolute;left:127.46px;top:189.10px" class="cls_014"><span class="cls_014">push_self</span></div>
<div style="position:absolute;left:275.46px;top:189.10px" class="cls_014"><span class="cls_014">push_rubinius</span></div>
<div style="position:absolute;left:127.46px;top:198.10px" class="cls_014"><span class="cls_014">meta_push_2</span></div>
<div style="position:absolute;left:275.46px;top:198.10px" class="cls_014"><span class="cls_014">find_const</span></div>
<div style="position:absolute;left:375.46px;top:198.10px" class="cls_014"><span class="cls_014">0</span></div>
<div style="position:absolute;left:127.46px;top:207.10px" class="cls_014"><span class="cls_014">meta_push_2</span></div>
<div style="position:absolute;left:275.46px;top:207.10px" class="cls_014"><span class="cls_014">push_literal</span></div>
<div style="position:absolute;left:375.46px;top:207.10px" class="cls_014"><span class="cls_014">:$stdout</span></div>
<div style="position:absolute;left:127.46px;top:216.10px" class="cls_014"><span class="cls_014">meta_send_op_plus</span></div>
<div style="position:absolute;left:203.46px;top:216.10px" class="cls_014"><span class="cls_014">:+</span></div>
<div style="position:absolute;left:275.46px;top:216.10px" class="cls_014"><span class="cls_014">send_stack</span></div>
<div style="position:absolute;left:375.46px;top:216.10px" class="cls_014"><span class="cls_014">:[], 1</span></div>
<div style="position:absolute;left:127.46px;top:225.10px" class="cls_014"><span class="cls_014">allow_private</span></div>
<div style="position:absolute;left:275.46px;top:225.10px" class="cls_014"><span class="cls_014">push_local</span></div>
<div style="position:absolute;left:375.46px;top:225.10px" class="cls_014"><span class="cls_014">0 # a</span></div>
<div style="position:absolute;left:127.46px;top:234.10px" class="cls_014"><span class="cls_014">send_stack</span></div>
<div style="position:absolute;left:203.46px;top:234.10px" class="cls_014"><span class="cls_014">:puts, 1</span></div>
<div style="position:absolute;left:275.46px;top:234.10px" class="cls_014"><span class="cls_014">cast_array</span></div>
<div style="position:absolute;left:127.46px;top:243.10px" class="cls_014"><span class="cls_014">pop</span></div>
<div style="position:absolute;left:275.46px;top:243.10px" class="cls_014"><span class="cls_014">push_nil</span></div>
<div style="position:absolute;left:127.46px;top:252.10px" class="cls_014"><span class="cls_014">push_true</span></div>
<div style="position:absolute;left:275.46px;top:252.10px" class="cls_014"><span class="cls_014">send_stack_with_splat</span></div>
<div style="position:absolute;left:375.46px;top:252.10px" class="cls_014"><span class="cls_014">:puts, 0</span></div>
<div style="position:absolute;left:127.46px;top:261.10px" class="cls_014"><span class="cls_014">ret</span></div>
<div style="position:absolute;left:275.46px;top:261.10px" class="cls_014"><span class="cls_014">pop</span></div>
<div style="position:absolute;left:275.46px;top:270.10px" class="cls_014"><span class="cls_014">push_nil</span></div>
<div style="position:absolute;left:275.46px;top:279.10px" class="cls_014"><span class="cls_014">ret</span></div>
<div style="position:absolute;left:123.00px;top:301.21px" class="cls_038"><span class="cls_038">Figure 11-6: The </span><span class="cls_014">puts</span><span class="cls_038"> method in Rubinius is implemented with Ruby code.</span></div>
<div style="position:absolute;left:141.00px;top:323.71px" class="cls_007"><span class="cls_007">You can see Ruby code at the top of the figure: the </span><span class="cls_030">puts 2+2</span><span class="cls_007"> code at left</span></div>
<div style="position:absolute;left:123.00px;top:335.71px" class="cls_007"><span class="cls_007">and Rubinius’s definition of the </span><span class="cls_030">puts</span><span class="cls_007"> method at right. Rubinius implements</span></div>
<div style="position:absolute;left:123.00px;top:347.71px" class="cls_007"><span class="cls_007">built-in Ruby classes, such as the </span><span class="cls_030">Kernel</span><span class="cls_007"> module, in Ruby; therefore, when</span></div>
<div style="position:absolute;left:123.00px;top:359.71px" class="cls_007"><span class="cls_007">we call the </span><span class="cls_030">puts</span><span class="cls_007"> method, Rubinius simply passes control to the Ruby code</span></div>
<div style="position:absolute;left:123.00px;top:371.71px" class="cls_007"><span class="cls_007">for the </span><span class="cls_030">Kernel#puts</span><span class="cls_007"> method contained inside the Rubinius kernel.</span></div>
<div style="position:absolute;left:141.00px;top:383.71px" class="cls_007"><span class="cls_007">The lower portion of the figure shows the Rubinius instructions into</span></div>
<div style="position:absolute;left:123.00px;top:395.71px" class="cls_007"><span class="cls_007">which the Ruby code is compiled. At left are the instructions for </span><span class="cls_030">puts 2+2</span><span class="cls_007">,</span></div>
<div style="position:absolute;left:123.00px;top:407.71px" class="cls_007"><span class="cls_007">and at right is the compiled version of the </span><span class="cls_030">Kernel#puts</span><span class="cls_007"> method. Rubinius</span></div>
<div style="position:absolute;left:123.00px;top:419.71px" class="cls_007"><span class="cls_007">compiles its built-in Ruby code and your Ruby code in the same manner</span></div>
<div style="position:absolute;left:123.00px;top:431.71px" class="cls_007"><span class="cls_007">(except that Rubinius compiles the built-in Ruby code during the Rubinius</span></div>
<div style="position:absolute;left:123.00px;top:443.71px" class="cls_007"><span class="cls_007">build process).</span></div>
<div style="position:absolute;left:123.00px;top:468.71px" class="cls_055"><span class="cls_055">Ruby and C++ Working Together</span></div>
<div style="position:absolute;left:123.00px;top:486.71px" class="cls_007"><span class="cls_007">In order to handle certain low-level technical details and to speed things</span></div>
<div style="position:absolute;left:123.00px;top:498.71px" class="cls_007"><span class="cls_007">up, Rubinius uses C++ code in its virtual machine to help implement built-</span></div>
<div style="position:absolute;left:123.00px;top:510.71px" class="cls_007"><span class="cls_007">in classes and modules. That is, it uses both Ruby and C++ to implement</span></div>
<div style="position:absolute;left:123.00px;top:522.71px" class="cls_007"><span class="cls_007">the language’s core classes.</span></div>
<div style="position:absolute;left:141.00px;top:534.71px" class="cls_007"><span class="cls_007">To understand how this works, let’s execute this short Ruby script in</span></div>
<div style="position:absolute;left:123.00px;top:546.71px" class="cls_007"><span class="cls_007">Rubinius (see Listing 11-3).</span></div>
<div style="position:absolute;left:326.82px;top:636.00px" class="cls_021"><span class="cls_021">Rubinius: Ruby Implemented with Ruby</span></div>
<div style="position:absolute;left:442.54px;top:633.00px" class="cls_020"><span class="cls_020">279</span></div>
</div>
<div style="position:absolute;left:50%;margin-left:-252px;top:202124px;width:504px;height:666px;border-style:outset;overflow:hidden">
<div style="position:absolute;left:0px;top:0px">
<img src="e698b76e-46bd-11eb-8b25-0cc47a792c0a_id_e698b76e-46bd-11eb-8b25-0cc47a792c0a_files/background304.jpg" width=504 height=666></div>
<div style="position:absolute;left:120.00px;top:49.00px" class="cls_030"><span class="cls_030">str = "The quick brown fox..."</span></div>
<div style="position:absolute;left:120.00px;top:59.50px" class="cls_030"><span class="cls_030">puts str[4]</span></div>
<div style="position:absolute;left:124.25px;top:70.00px" class="cls_030"><span class="cls_030">=> q</span></div>
<div style="position:absolute;left:120.00px;top:92.49px" class="cls_038"><span class="cls_038">Listing 11-3: Calling the </span><span class="cls_014">String#[]</span><span class="cls_038"> method</span></div>
<div style="position:absolute;left:138.00px;top:115.00px" class="cls_007"><span class="cls_007">This simple program prints the fifth character (the letter </span><span class="cls_008">q</span><span class="cls_007"> at index 4)</span></div>
<div style="position:absolute;left:120.00px;top:127.00px" class="cls_007"><span class="cls_007">in the sample string. Because the </span><span class="cls_030">String#[]</span><span class="cls_007"> method is part of a built-in Ruby</span></div>
<div style="position:absolute;left:120.00px;top:139.00px" class="cls_007"><span class="cls_007">class, Rubinius implements it using Ruby code, as shown in Figure 11-7.</span></div>
<div style="position:absolute;left:101.23px;top:168.48px" class="cls_209"><span class="cls_209">Your Code</span></div>
<div style="position:absolute;left:290.24px;top:168.48px" class="cls_209"><span class="cls_209">Rubinius Code</span></div>
<div style="position:absolute;left:50.96px;top:195.12px" class="cls_210"><span class="cls_210">str = "The quick brown fox..."</span></div>
<div style="position:absolute;left:50.96px;top:204.00px" class="cls_210"><span class="cls_210">puts str[4]</span></div>
<div style="position:absolute;left:217.78px;top:217.83px" class="cls_210"><span class="cls_210">class String</span></div>
<div style="position:absolute;left:432.71px;top:233.72px" class="cls_209"><span class="cls_209">Ruby</span></div>
<div style="position:absolute;left:217.78px;top:240.34px" class="cls_210"><span class="cls_210">def</span></div>
<div style="position:absolute;left:244.05px;top:240.34px" class="cls_210"><span class="cls_210">(index, other = undefined)</span></div>
<div style="position:absolute;left:227.16px;top:251.60px" class="cls_210"><span class="cls_210">Rubinius.primitive :string_aref</span></div>
<div style="position:absolute;left:219.64px;top:288.79px" class="cls_210"><span class="cls_210">Object* String::aref(STATE, Fixnum* index)</span></div>
<div style="position:absolute;left:219.64px;top:300.05px" class="cls_210"><span class="cls_210">{</span></div>
<div style="position:absolute;left:433.51px;top:302.83px" class="cls_209"><span class="cls_209">C++</span></div>
<div style="position:absolute;left:219.64px;top:322.56px" class="cls_210"><span class="cls_210">}</span></div>
<div style="position:absolute;left:48.00px;top:347.00px" class="cls_038"><span class="cls_038">Figure 11-7: Rubinius implements built-in classes with a combination of Ruby and C++ code.</span></div>
<div style="position:absolute;left:138.00px;top:369.50px" class="cls_007"><span class="cls_007">On the left of the figure is the Ruby script that prints the letter </span><span class="cls_008">q</span><span class="cls_007">. On</span></div>
<div style="position:absolute;left:120.00px;top:381.50px" class="cls_007"><span class="cls_007">the right is the Ruby code that Rubinius uses to implement the </span><span class="cls_030">String#[]</span></div>
<div style="position:absolute;left:120.00px;top:393.50px" class="cls_007"><span class="cls_007">method, taken from a Rubinius source code file called </span><span class="cls_008">string.rb</span><span class="cls_007"> (named</span></div>
<div style="position:absolute;left:120.00px;top:405.50px" class="cls_007"><span class="cls_007">after the </span><span class="cls_030">String</span><span class="cls_007"> class). (We’ll learn how to find Rubinius source code files</span></div>
<div style="position:absolute;left:120.00px;top:417.50px" class="cls_007"><span class="cls_007">in Experiment 11-1.)</span></div>
<div style="position:absolute;left:138.00px;top:429.50px" class="cls_007"><span class="cls_007">Notice that the beginning of </span><span class="cls_030">String#[]</span><span class="cls_007"> starts with the method call</span></div>
<div style="position:absolute;left:120.00px;top:441.50px" class="cls_030"><span class="cls_030">Rubinius.primitive</span><span class="cls_007">. This indicates that Rubinius actually uses C++ code</span></div>
<div style="position:absolute;left:120.00px;top:453.50px" class="cls_007"><span class="cls_007">to implement this method; </span><span class="cls_030">Rubinius.primitive</span><span class="cls_007"> is a directive that tells the</span></div>
<div style="position:absolute;left:120.00px;top:465.50px" class="cls_007"><span class="cls_007">Rubinius compiler to generate a call to the corresponding C++ code.</span></div>
<div style="position:absolute;left:120.00px;top:477.50px" class="cls_007"><span class="cls_007">The code that actually implements </span><span class="cls_030">String#[]</span><span class="cls_007"> is a C++ method called</span></div>
<div style="position:absolute;left:120.00px;top:489.50px" class="cls_030"><span class="cls_030">String::aref</span><span class="cls_007">, shown at the bottom right of Figure 11-7.</span></div>
<div style="position:absolute;left:120.00px;top:514.50px" class="cls_055"><span class="cls_055">Implementing Ruby Objects with C++ Objects</span></div>
<div style="position:absolute;left:120.00px;top:532.50px" class="cls_007"><span class="cls_007">Ruby’s use of the object-oriented C++ allows its virtual machine to repre-</span></div>
<div style="position:absolute;left:120.00px;top:544.50px" class="cls_007"><span class="cls_007">sent each Ruby object internally using a corresponding C++ object (see</span></div>
<div style="position:absolute;left:120.00px;top:556.50px" class="cls_007"><span class="cls_007">Figure 11-8).</span></div>
<div style="position:absolute;left:138.00px;top:568.50px" class="cls_007"><span class="cls_007">Rubinius uses C++ objects the way that MRI uses the </span><span class="cls_030">RClass</span><span class="cls_007"> and </span><span class="cls_030">RObject</span></div>
<div style="position:absolute;left:120.00px;top:580.50px" class="cls_007"><span class="cls_007">C structures. When you define a class, Rubinius creates an instance of</span></div>
<div style="position:absolute;left:120.00px;top:592.50px" class="cls_007"><span class="cls_007">the </span><span class="cls_030">Class</span><span class="cls_007"> C++ class. When you create a Ruby object, Rubinius creates an</span></div>
<div style="position:absolute;left:48.00px;top:633.00px" class="cls_020"><span class="cls_020">280</span></div>
<div style="position:absolute;left:74.62px;top:636.00px" class="cls_021"><span class="cls_021">Chapter 11</span></div>
</div>
<div style="position:absolute;left:50%;margin-left:-252px;top:202800px;width:504px;height:666px;border-style:outset;overflow:hidden">
<div style="position:absolute;left:0px;top:0px">
<img src="e698b76e-46bd-11eb-8b25-0cc47a792c0a_id_e698b76e-46bd-11eb-8b25-0cc47a792c0a_files/background305.jpg" width=504 height=666></div>
<div style="position:absolute;left:123.00px;top:41.60px" class="cls_007"><span class="cls_007">instance of the </span><span class="cls_030">Object</span><span class="cls_007"> C++ class. A </span><span class="cls_030">klass_</span><span class="cls_007"> pointer in the </span><span class="cls_030">pythagoras</span><span class="cls_007"> object</span></div>
<div style="position:absolute;left:123.00px;top:53.60px" class="cls_007"><span class="cls_007">indicates it is an instance of </span><span class="cls_030">Mathematician</span><span class="cls_007">, just as the </span><span class="cls_030">klass</span><span class="cls_007"> pointer in the</span></div>
<div style="position:absolute;left:123.00px;top:65.60px" class="cls_030"><span class="cls_030">RObject</span><span class="cls_007"> C structure does in MRI.</span></div>
<div style="position:absolute;left:184.66px;top:86.89px" class="cls_017"><span class="cls_017">Ruby</span></div>
<div style="position:absolute;left:321.48px;top:86.89px" class="cls_017"><span class="cls_017">C++ Objects</span></div>
<div style="position:absolute;left:306.64px;top:115.39px" class="cls_160"><span class="cls_160">Class</span></div>
<div style="position:absolute;left:123.00px;top:115.40px" class="cls_063"><span class="cls_063">class </span><span class="cls_160">Mathematician</span></div>
<div style="position:absolute;left:132.50px;top:126.80px" class="cls_160"><span class="cls_160">attr_accessor </span><span class="cls_063">:first_name</span></div>
<div style="position:absolute;left:132.50px;top:138.20px" class="cls_160"><span class="cls_160">attr_accessor </span><span class="cls_063">:last_name</span></div>
<div style="position:absolute;left:316.14px;top:138.19px" class="cls_063"><span class="cls_063">Mathematician</span></div>
<div style="position:absolute;left:123.00px;top:149.60px" class="cls_063"><span class="cls_063">end</span></div>
<div style="position:absolute;left:357.64px;top:168.62px" class="cls_014"><span class="cls_014">klass_</span></div>
<div style="position:absolute;left:306.64px;top:190.89px" class="cls_160"><span class="cls_160">Object</span></div>
<div style="position:absolute;left:123.00px;top:203.30px" class="cls_063"><span class="cls_063">pythagoras = Mathematician.new</span></div>
<div style="position:absolute;left:322.89px;top:213.44px" class="cls_063"><span class="cls_063">pythagoras</span></div>
<div style="position:absolute;left:123.00px;top:241.94px" class="cls_038"><span class="cls_038">Figure 11-8: Rubinius represents classes and objects using C++ objects.</span></div>
<div style="position:absolute;left:123.00px;top:274.44px" class="cls_031"><span class="cls_031">Experiment 11-1: Comparing Backtraces in MRI</span></div>
<div style="position:absolute;left:123.00px;top:289.44px" class="cls_031"><span class="cls_031">and Rubinius</span></div>
<div style="position:absolute;left:123.00px;top:309.44px" class="cls_007"><span class="cls_007">Recall that Ruby displays a backtrace when an exception occurs in order to</span></div>
<div style="position:absolute;left:123.00px;top:321.44px" class="cls_007"><span class="cls_007">help you find the problem. Listing 11-4 shows a simple example.</span></div>
<div style="position:absolute;left:123.00px;top:345.44px" class="cls_030"><span class="cls_030">10.times do |n|</span></div>
<div style="position:absolute;left:131.50px;top:355.94px" class="cls_030"><span class="cls_030">puts n</span></div>
<div style="position:absolute;left:131.50px;top:366.44px" class="cls_030"><span class="cls_030">raise "Stop Here"</span></div>
<div style="position:absolute;left:123.00px;top:376.94px" class="cls_030"><span class="cls_030">end</span></div>
<div style="position:absolute;left:123.00px;top:399.44px" class="cls_038"><span class="cls_038">Listing 11-4: A Ruby script that raises an exception</span></div>
<div style="position:absolute;left:141.00px;top:421.94px" class="cls_007"><span class="cls_007">We call </span><span class="cls_030">raise</span><span class="cls_007"> to tell Ruby to stop the first time it executes the block after</span></div>
<div style="position:absolute;left:123.00px;top:433.94px" class="cls_007"><span class="cls_007">displaying the value of the parameter </span><span class="cls_030">n</span><span class="cls_007">. Listing 11-5 shows the output from</span></div>
<div style="position:absolute;left:123.00px;top:445.94px" class="cls_007"><span class="cls_007">running Listing 11-4 with MRI.</span></div>
<div style="position:absolute;left:123.00px;top:469.94px" class="cls_030"><span class="cls_030">$ </span><span class="cls_040">ruby iterate.rb</span></div>
<div style="position:absolute;left:123.00px;top:480.44px" class="cls_030"><span class="cls_030">0</span></div>
<div style="position:absolute;left:123.00px;top:490.94px" class="cls_030"><span class="cls_030">iterate.rb:3:in 'block in &lt;main>': Stop Here (RuntimeError)</span></div>
<div style="position:absolute;left:140.00px;top:501.44px" class="cls_030"><span class="cls_030">from iterate.rb:1:in 'times'</span></div>
<div style="position:absolute;left:140.00px;top:511.93px" class="cls_030"><span class="cls_030">from iterate.rb:1:in '&lt;main>'</span></div>
<div style="position:absolute;left:123.00px;top:534.43px" class="cls_038"><span class="cls_038">Listing 11-5: How MRI displays a backtrace for an exception</span></div>
<div style="position:absolute;left:141.00px;top:556.94px" class="cls_007"><span class="cls_007">You probably see output like this many times while developing a Ruby</span></div>
<div style="position:absolute;left:123.00px;top:568.94px" class="cls_007"><span class="cls_007">program. However, one subtle detail is worth a closer look. Figure 11-9</span></div>
<div style="position:absolute;left:123.00px;top:580.94px" class="cls_007"><span class="cls_007">shows a diagram of the MRI backtrace output.</span></div>
<div style="position:absolute;left:327.06px;top:636.00px" class="cls_021"><span class="cls_021">Rubinius: Ruby Implemented with Ruby</span></div>
<div style="position:absolute;left:442.78px;top:633.00px" class="cls_020"><span class="cls_020">281</span></div>
</div>
<div style="position:absolute;left:50%;margin-left:-252px;top:203476px;width:504px;height:666px;border-style:outset;overflow:hidden">
<div style="position:absolute;left:0px;top:0px">
<img src="e698b76e-46bd-11eb-8b25-0cc47a792c0a_id_e698b76e-46bd-11eb-8b25-0cc47a792c0a_files/background306.jpg" width=504 height=666></div>
<div style="position:absolute;left:186.93px;top:43.89px" class="cls_017"><span class="cls_017">Backtrace</span></div>
<div style="position:absolute;left:351.66px;top:43.89px" class="cls_200"><span class="cls_200">iterate.rb</span></div>
<div style="position:absolute;left:124.25px;top:66.64px" class="cls_063"><span class="cls_063">iterate.rb:3:in `block in &lt;main>'</span></div>
<div style="position:absolute;left:324.14px;top:70.30px" class="cls_063"><span class="cls_063">10.times do |n|</span></div>
<div style="position:absolute;left:333.64px;top:80.80px" class="cls_063"><span class="cls_063">puts n</span></div>
<div style="position:absolute;left:124.25px;top:87.65px" class="cls_063"><span class="cls_063">iterate.rb:1:in `times'</span></div>
<div style="position:absolute;left:277.13px;top:86.14px" class="cls_028"><span class="cls_028">?</span></div>
<div style="position:absolute;left:333.64px;top:91.29px" class="cls_063"><span class="cls_063">raise "Stop Here"</span></div>
<div style="position:absolute;left:324.14px;top:101.79px" class="cls_063"><span class="cls_063">end</span></div>
<div style="position:absolute;left:124.25px;top:108.65px" class="cls_063"><span class="cls_063">iterate.rb:1:in `&lt;main>'</span></div>
<div style="position:absolute;left:120.00px;top:133.39px" class="cls_038"><span class="cls_038">Figure 11-9: MRI displays where built-in CFUNC methods are called, not where</span></div>
<div style="position:absolute;left:120.00px;top:143.89px" class="cls_038"><span class="cls_038">they are defined.</span></div>
<div style="position:absolute;left:138.00px;top:166.39px" class="cls_007"><span class="cls_007">Notice that line 3 of </span><span class="cls_008">iterate.rb</span><span class="cls_007">, containing the call to </span><span class="cls_030">raise</span><span class="cls_007">, is at the top</span></div>
<div style="position:absolute;left:120.00px;top:178.39px" class="cls_007"><span class="cls_007">of the call stack. At the bottom of the call stack, MRI displays </span><span class="cls_030">iterate.rb:1</span><span class="cls_007">,</span></div>
<div style="position:absolute;left:120.00px;top:190.39px" class="cls_007"><span class="cls_007">where the short script began.</span></div>
<div style="position:absolute;left:138.00px;top:202.39px" class="cls_007"><span class="cls_007">Notice, too, that MRI’s backtrace contains a broken link: </span><span class="cls_008">iterate.rb</span></div>
<div style="position:absolute;left:120.00px;top:214.39px" class="cls_007"><span class="cls_007">doesn’t contain a definition for the method </span><span class="cls_030">times</span><span class="cls_007">. Instead, MRI refers to</span></div>
<div style="position:absolute;left:120.00px;top:226.39px" class="cls_007"><span class="cls_007">the line of code that </span><span class="cls_008">calls</span><span class="cls_007"> the </span><span class="cls_030">times</span><span class="cls_007"> method: </span><span class="cls_030">10.times do</span><span class="cls_007">. The actual </span><span class="cls_030">times</span></div>
<div style="position:absolute;left:120.00px;top:238.39px" class="cls_007"><span class="cls_007">method is implemented with C code inside MRI—a CFUNC method. MRI</span></div>
<div style="position:absolute;left:120.00px;top:250.39px" class="cls_007"><span class="cls_007">displays the location of calls to CFUNC methods in backtraces, not the loca-</span></div>
<div style="position:absolute;left:120.00px;top:262.39px" class="cls_007"><span class="cls_007">tion of the actual C implementation of these methods.</span></div>
<div style="position:absolute;left:120.00px;top:287.39px" class="cls_055"><span class="cls_055">Backtraces in Rubinius</span></div>
<div style="position:absolute;left:120.00px;top:305.39px" class="cls_007"><span class="cls_007">Unlike MRI, Rubinius implements built-in methods using Ruby, not C. This</span></div>
<div style="position:absolute;left:120.00px;top:317.39px" class="cls_007"><span class="cls_007">implementation allows Rubinius to include accurate source file and line</span></div>
<div style="position:absolute;left:120.00px;top:329.39px" class="cls_007"><span class="cls_007">number information about built-in methods in backtraces. To demonstrate,</span></div>
<div style="position:absolute;left:120.00px;top:341.39px" class="cls_007"><span class="cls_007">let’s run Listing 11-4 again using Rubinius. Listing 11-6 shows the result.</span></div>
<div style="position:absolute;left:120.00px;top:365.39px" class="cls_030"><span class="cls_030">$ </span><span class="cls_040">rbx iterate.rb</span></div>
<div style="position:absolute;left:120.00px;top:375.89px" class="cls_030"><span class="cls_030">0</span></div>
<div style="position:absolute;left:120.00px;top:386.39px" class="cls_030"><span class="cls_030">An exception occurred running iterate.rb</span></div>
<div style="position:absolute;left:137.00px;top:396.89px" class="cls_030"><span class="cls_030">Stop Here (RuntimeError)</span></div>
<div style="position:absolute;left:120.00px;top:417.89px" class="cls_030"><span class="cls_030">Backtrace:</span></div>
<div style="position:absolute;left:162.50px;top:428.39px" class="cls_030"><span class="cls_030">{ } in Object#__script__ at iterate.rb:3</span></div>
<div style="position:absolute;left:175.25px;top:438.88px" class="cls_030"><span class="cls_030">Integer(Fixnum)#times at kernel/common/integer.rb:83</span></div>
<div style="position:absolute;left:192.25px;top:449.38px" class="cls_030"><span class="cls_030">Object#__script__ at iterate.rb:1</span></div>
<div style="position:absolute;left:128.50px;top:459.88px" class="cls_030"><span class="cls_030">Rubinius::CodeLoader#load_script at kernel/delta/codeloader.rb:68</span></div>
<div style="position:absolute;left:128.50px;top:470.38px" class="cls_030"><span class="cls_030">Rubinius::CodeLoader.load_script at kernel/delta/codeloader.rb:119</span></div>
<div style="position:absolute;left:166.75px;top:480.87px" class="cls_030"><span class="cls_030">Rubinius::Loader#script at kernel/loader.rb:645</span></div>
<div style="position:absolute;left:175.25px;top:491.37px" class="cls_030"><span class="cls_030">Rubinius::Loader#main at kernel/loader.rb:844</span></div>
<div style="position:absolute;left:120.00px;top:513.87px" class="cls_038"><span class="cls_038">Listing 11-6: How Rubinius displays a backtrace for an exception</span></div>
<div style="position:absolute;left:138.00px;top:536.39px" class="cls_007"><span class="cls_007">Rubinius displays much more information! To understand this output a</span></div>
<div style="position:absolute;left:120.00px;top:548.39px" class="cls_007"><span class="cls_007">bit better, see Figures 11-10 and 11-11.</span></div>
<div style="position:absolute;left:138.00px;top:560.39px" class="cls_007"><span class="cls_007">At left in Figure 11-10 is a simplified version of the backtrace information</span></div>
<div style="position:absolute;left:120.00px;top:572.39px" class="cls_007"><span class="cls_007">Rubinius displayed while running </span><span class="cls_008">iterate.rb</span><span class="cls_007">. Rubinius displays the two lines</span></div>
<div style="position:absolute;left:120.00px;top:584.39px" class="cls_007"><span class="cls_007">in the backtrace corresponding to </span><span class="cls_008">iterate.rb</span><span class="cls_007"> just as MRI does. But Rubinius</span></div>
<div style="position:absolute;left:48.00px;top:633.00px" class="cls_020"><span class="cls_020">282</span></div>
<div style="position:absolute;left:74.46px;top:636.00px" class="cls_021"><span class="cls_021">Chapter 11</span></div>
</div>
<div style="position:absolute;left:50%;margin-left:-252px;top:204152px;width:504px;height:666px;border-style:outset;overflow:hidden">
<div style="position:absolute;left:0px;top:0px">
<img src="e698b76e-46bd-11eb-8b25-0cc47a792c0a_id_e698b76e-46bd-11eb-8b25-0cc47a792c0a_files/background307.jpg" width=504 height=666></div>
<div style="position:absolute;left:123.00px;top:41.60px" class="cls_007"><span class="cls_007">also includes new entries in the Ruby call stack that correspond to Ruby</span></div>
<div style="position:absolute;left:123.00px;top:53.60px" class="cls_007"><span class="cls_007">source code files inside the Rubinius kernel. We can guess that the </span><span class="cls_008">loader.rb</span></div>
<div style="position:absolute;left:123.00px;top:65.60px" class="cls_007"><span class="cls_007">and </span><span class="cls_008">codeloader.rb</span><span class="cls_007"> files contain code that load and execute our script.</span></div>
<div style="position:absolute;left:189.93px;top:86.89px" class="cls_017"><span class="cls_017">Backtrace</span></div>
<div style="position:absolute;left:354.66px;top:86.89px" class="cls_200"><span class="cls_200">iterate.rb</span></div>
<div style="position:absolute;left:127.25px;top:109.64px" class="cls_063"><span class="cls_063">iterate.rb:3</span></div>
<div style="position:absolute;left:327.14px;top:113.32px" class="cls_063"><span class="cls_063">10.times do |n|</span></div>
<div style="position:absolute;left:336.64px;top:123.81px" class="cls_063"><span class="cls_063">puts n</span></div>
<div style="position:absolute;left:127.25px;top:130.65px" class="cls_063"><span class="cls_063">kernel/common/integer.rb:83</span></div>
<div style="position:absolute;left:336.64px;top:134.31px" class="cls_063"><span class="cls_063">raise "Stop Here"</span></div>
<div style="position:absolute;left:327.14px;top:144.81px" class="cls_063"><span class="cls_063">end</span></div>
<div style="position:absolute;left:127.25px;top:151.65px" class="cls_063"><span class="cls_063">iterate.rb:1</span></div>
<div style="position:absolute;left:127.25px;top:172.64px" class="cls_063"><span class="cls_063">kernel/delta/codeloader.rb:68</span></div>
<div style="position:absolute;left:127.25px;top:193.65px" class="cls_063"><span class="cls_063">kernel/delta/codeloader.rb:119</span></div>
<div style="position:absolute;left:127.25px;top:214.65px" class="cls_063"><span class="cls_063">kernel/loader.rb:645</span></div>
<div style="position:absolute;left:127.25px;top:235.66px" class="cls_063"><span class="cls_063">kernel/loader.rb:844</span></div>
<div style="position:absolute;left:123.00px;top:261.05px" class="cls_038"><span class="cls_038">Figure 11-10: Like MRI, Rubinius includes information about your program in backtraces.</span></div>
<div style="position:absolute;left:141.00px;top:283.55px" class="cls_007"><span class="cls_007">But the most interesting entry in the call stack is </span><span class="cls_030">kernel/common/integer</span></div>
<div style="position:absolute;left:123.00px;top:295.55px" class="cls_030"><span class="cls_030">.rb:83</span><span class="cls_007">. This entry tells us where the </span><span class="cls_030">Integer#times</span><span class="cls_007"> method is implemented</span></div>
<div style="position:absolute;left:123.00px;top:307.55px" class="cls_007"><span class="cls_007">inside the Rubinius kernel, as shown in Figure 11-11.</span></div>
<div style="position:absolute;left:116.59px;top:328.87px" class="cls_174"><span class="cls_174">Backtrace</span></div>
<div style="position:absolute;left:248.35px;top:328.87px" class="cls_211"><span class="cls_211">kernel/common/integer.rb</span></div>
<div style="position:absolute;left:55.16px;top:351.16px" class="cls_175"><span class="cls_175">iterate.rb:3</span></div>
<div style="position:absolute;left:248.11px;top:351.18px" class="cls_175"><span class="cls_175">def times</span></div>
<div style="position:absolute;left:257.42px;top:361.47px" class="cls_175"><span class="cls_175">return to_enum(:times) unless block_given?</span></div>
<div style="position:absolute;left:55.16px;top:371.75px" class="cls_175"><span class="cls_175">kernel/common/integer.rb:83</span></div>
<div style="position:absolute;left:257.42px;top:382.05px" class="cls_175"><span class="cls_175">i = 0</span></div>
<div style="position:absolute;left:55.16px;top:392.33px" class="cls_175"><span class="cls_175">iterate.rb:1</span></div>
<div style="position:absolute;left:257.42px;top:392.34px" class="cls_175"><span class="cls_175">while i &lt; self</span></div>
<div style="position:absolute;left:266.73px;top:402.63px" class="cls_175"><span class="cls_175">yield i</span></div>
<div style="position:absolute;left:55.16px;top:412.90px" class="cls_175"><span class="cls_175">kernel/delta/codeloader.rb:68</span></div>
<div style="position:absolute;left:266.73px;top:412.91px" class="cls_175"><span class="cls_175">i += 1</span></div>
<div style="position:absolute;left:257.42px;top:423.20px" class="cls_175"><span class="cls_175">end</span></div>
<div style="position:absolute;left:55.16px;top:433.49px" class="cls_175"><span class="cls_175">kernel/delta/codeloader.rb:119</span></div>
<div style="position:absolute;left:257.42px;top:433.49px" class="cls_175"><span class="cls_175">self</span></div>
<div style="position:absolute;left:248.11px;top:443.78px" class="cls_175"><span class="cls_175">end</span></div>
<div style="position:absolute;left:55.16px;top:454.07px" class="cls_175"><span class="cls_175">kernel/loader.rb:645</span></div>
<div style="position:absolute;left:55.16px;top:474.66px" class="cls_175"><span class="cls_175">kernel/loader.rb:844</span></div>
<div style="position:absolute;left:51.00px;top:499.71px" class="cls_038"><span class="cls_038">Figure 11-11: Rubinius includes information about its kernel in backtraces.</span></div>
<div style="position:absolute;left:141.00px;top:522.21px" class="cls_007"><span class="cls_007">The backtrace information on the left of the figure is the same as that</span></div>
<div style="position:absolute;left:123.00px;top:534.21px" class="cls_007"><span class="cls_007">in Figure 11-10. The arrow points from the second level of the Ruby call</span></div>
<div style="position:absolute;left:123.00px;top:546.21px" class="cls_007"><span class="cls_007">stack to the code that calls the </span><span class="cls_030">puts n</span><span class="cls_007"> block—the </span><span class="cls_030">yield</span><span class="cls_007"> instruction in the</span></div>
<div style="position:absolute;left:123.00px;top:558.21px" class="cls_030"><span class="cls_030">Integer#times</span><span class="cls_007"> method.</span></div>
<div style="position:absolute;left:141.00px;top:570.21px" class="cls_007"><span class="cls_007">Using Rubinius, </span><span class="cls_008">iterate.rb</span><span class="cls_007"> becomes part of a larger Ruby program: the</span></div>
<div style="position:absolute;left:123.00px;top:582.21px" class="cls_007"><span class="cls_007">Rubinius kernel. When we call </span><span class="cls_030">10.times</span><span class="cls_007">, Rubinius calls the Ruby code shown</span></div>
<div style="position:absolute;left:123.00px;top:594.21px" class="cls_007"><span class="cls_007">at the right, which then executes our block using the </span><span class="cls_030">yield</span><span class="cls_007"> keyword on</span></div>
<div style="position:absolute;left:123.00px;top:606.21px" class="cls_007"><span class="cls_007">line 83.</span></div>
<div style="position:absolute;left:326.60px;top:636.00px" class="cls_021"><span class="cls_021">Rubinius: Ruby Implemented with Ruby</span></div>
<div style="position:absolute;left:442.32px;top:633.00px" class="cls_020"><span class="cls_020">283</span></div>
</div>
<div style="position:absolute;left:50%;margin-left:-252px;top:204828px;width:504px;height:666px;border-style:outset;overflow:hidden">
<div style="position:absolute;left:0px;top:0px">
<img src="e698b76e-46bd-11eb-8b25-0cc47a792c0a_id_e698b76e-46bd-11eb-8b25-0cc47a792c0a_files/background308.jpg" width=504 height=666></div>
<div style="position:absolute;left:78.00px;top:46.00px" class="cls_032"><span class="cls_032">Note</span></div>
<div style="position:absolute;left:120.00px;top:43.50px" class="cls_008"><span class="cls_008">The path </span><span class="cls_007">kernel/common/integer.rb</span><span class="cls_008"> refers to a location in the Rubinius source</span></div>
<div style="position:absolute;left:119.99px;top:55.50px" class="cls_008"><span class="cls_008">code tree. If you installed Rubinius using a binary installer, you’ll need to download</span></div>
<div style="position:absolute;left:119.99px;top:67.50px" class="cls_008"><span class="cls_008">the source code from </span><A HREF="http://rubini.us/">http://rubini.us/</A> </span><span class="cls_008"> or GitHub in order to read it.</span></div>
<div style="position:absolute;left:137.99px;top:91.50px" class="cls_007"><span class="cls_007">Rubinius implements </span><span class="cls_030">Integer#times</span><span class="cls_007"> by counting from 0 up to the speci-</span></div>
<div style="position:absolute;left:119.99px;top:103.50px" class="cls_007"><span class="cls_007">fied integer (minus one), calling the block each time through the loop.</span></div>
<div style="position:absolute;left:119.99px;top:115.50px" class="cls_007"><span class="cls_007">Let’s take a closer look at </span><span class="cls_030">Integer#times</span><span class="cls_007">, as shown in Listing 11-7.</span></div>
<div style="position:absolute;left:108.15px;top:139.50px" class="cls_046"><span class="cls_046">u</span><span class="cls_030"> def times</span></div>
<div style="position:absolute;left:108.15px;top:150.00px" class="cls_046"><span class="cls_046">v</span><span class="cls_030">   return to_enum(:times) unless block_given?</span></div>
<div style="position:absolute;left:108.15px;top:171.00px" class="cls_046"><span class="cls_046">w</span><span class="cls_030">   i = 0</span></div>
<div style="position:absolute;left:108.15px;top:181.50px" class="cls_046"><span class="cls_046">x</span><span class="cls_030">   while i &lt; self</span></div>
<div style="position:absolute;left:108.15px;top:192.00px" class="cls_046"><span class="cls_046">y</span><span class="cls_030">     yield i</span></div>
<div style="position:absolute;left:137.00px;top:202.49px" class="cls_030"><span class="cls_030">i += 1</span></div>
<div style="position:absolute;left:128.50px;top:212.99px" class="cls_030"><span class="cls_030">end</span></div>
<div style="position:absolute;left:108.15px;top:223.49px" class="cls_046"><span class="cls_046">z</span><span class="cls_030">   self</span></div>
<div style="position:absolute;left:120.00px;top:233.99px" class="cls_030"><span class="cls_030">end</span></div>
<div style="position:absolute;left:120.00px;top:256.49px" class="cls_038"><span class="cls_038">Listing 11-7: The Rubinius implementation of </span><span class="cls_014">Integer#times</span><span class="cls_038">, from </span><span class="cls_039">kernel/common/integer.rb</span></div>
<div style="position:absolute;left:138.00px;top:279.00px" class="cls_007"><span class="cls_007">The definition of the </span><span class="cls_030">times</span><span class="cls_007"> method starts at </span><span class="cls_050">u</span><span class="cls_007">. At </span><span class="cls_050">v</span><span class="cls_007"> Rubinius returns</span></div>
<div style="position:absolute;left:120.00px;top:291.00px" class="cls_007"><span class="cls_007">the result of </span><span class="cls_030">to_enum</span><span class="cls_007"> if a block is not provided, as shown below. (The </span><span class="cls_030">to_enum</span></div>
<div style="position:absolute;left:120.00px;top:303.00px" class="cls_007"><span class="cls_007">method returns a new enumerator object, which allows you to perform the</span></div>
<div style="position:absolute;left:120.00px;top:315.00px" class="cls_007"><span class="cls_007">enumeration later if you prefer.)</span></div>
<div style="position:absolute;left:120.00px;top:339.00px" class="cls_030"><span class="cls_030">p 10.times</span></div>
<div style="position:absolute;left:124.25px;top:349.50px" class="cls_030"><span class="cls_030">=> #&lt;Enumerable::Enumerator:0x120 @generator=nil @args=[] @lookahead=[]</span></div>
<div style="position:absolute;left:141.25px;top:359.99px" class="cls_030"><span class="cls_030">@object=10 @iter=:times></span></div>
<div style="position:absolute;left:138.00px;top:382.50px" class="cls_007"><span class="cls_007">Rubinius continues to execute the rest of the method if you provide a</span></div>
<div style="position:absolute;left:120.00px;top:394.50px" class="cls_007"><span class="cls_007">block. At </span><span class="cls_050">w</span><span class="cls_007"> Rubinius creates a counter </span><span class="cls_030">i</span><span class="cls_007"> and initializes it to 0. Next, it uses</span></div>
<div style="position:absolute;left:120.00px;top:406.50px" class="cls_007"><span class="cls_007">a while loop at </span><span class="cls_050">x</span><span class="cls_007"> to perform the iteration. Notice that the while loop condi-</span></div>
<div style="position:absolute;left:119.99px;top:418.50px" class="cls_007"><span class="cls_007">tion </span><span class="cls_030">i &lt; self</span><span class="cls_007"> refers to the value of </span><span class="cls_030">self</span><span class="cls_007">. Inside </span><span class="cls_030">Integer#times</span><span class="cls_007">, </span><span class="cls_030">self</span><span class="cls_007"> is set to the</span></div>
<div style="position:absolute;left:120.00px;top:430.50px" class="cls_007"><span class="cls_007">current integer object, or 10 in our script. At </span><span class="cls_050">y</span><span class="cls_007"> Rubinius yields to (calls)</span></div>
<div style="position:absolute;left:120.00px;top:442.50px" class="cls_007"><span class="cls_007">the given block, passing in the current value of </span><span class="cls_030">i</span><span class="cls_007">. This calls our </span><span class="cls_030">puts n</span><span class="cls_007"> block.</span></div>
<div style="position:absolute;left:120.00px;top:454.50px" class="cls_007"><span class="cls_007">Finally, at </span><span class="cls_050">z</span><span class="cls_007"> Rubinius returns </span><span class="cls_030">self</span><span class="cls_007">, which means the return value of </span><span class="cls_030">10.times</span></div>
<div style="position:absolute;left:120.00px;top:466.50px" class="cls_007"><span class="cls_007">will be 10.</span></div>
<div style="position:absolute;left:66.00px;top:500.50px" class="cls_031"><span class="cls_031">Arrays in Rubinius and MRI</span></div>
<div style="position:absolute;left:120.00px;top:520.50px" class="cls_007"><span class="cls_007">Arrays are so ubiquitous in Ruby that it’s easy to take them for granted. But</span></div>
<div style="position:absolute;left:120.00px;top:532.50px" class="cls_007"><span class="cls_007">how do they work inside Ruby? Where does Ruby save objects that you place</span></div>
<div style="position:absolute;left:120.00px;top:544.50px" class="cls_007"><span class="cls_007">into an array, and how does it represent array objects internally? In the fol-</span></div>
<div style="position:absolute;left:120.00px;top:556.50px" class="cls_007"><span class="cls_007">lowing sections, we’ll look at the internal data structures that Rubinius and</span></div>
<div style="position:absolute;left:120.00px;top:568.50px" class="cls_007"><span class="cls_007">MRI use to hold values in an array.</span></div>
<div style="position:absolute;left:48.00px;top:633.00px" class="cls_020"><span class="cls_020">284</span></div>
<div style="position:absolute;left:74.68px;top:636.00px" class="cls_021"><span class="cls_021">Chapter 11</span></div>
</div>
<div style="position:absolute;left:50%;margin-left:-252px;top:205504px;width:504px;height:666px;border-style:outset;overflow:hidden">
<div style="position:absolute;left:0px;top:0px">
<img src="e698b76e-46bd-11eb-8b25-0cc47a792c0a_id_e698b76e-46bd-11eb-8b25-0cc47a792c0a_files/background309.jpg" width=504 height=666></div>
<div style="position:absolute;left:123.00px;top:42.05px" class="cls_055"><span class="cls_055">Arrays Inside of MRI</span></div>
<div style="position:absolute;left:123.00px;top:60.05px" class="cls_007"><span class="cls_007">Suppose you put the first six numbers from the Fibonacci sequence into</span></div>
<div style="position:absolute;left:123.00px;top:72.05px" class="cls_007"><span class="cls_007">an array.</span></div>
<div style="position:absolute;left:123.00px;top:96.05px" class="cls_030"><span class="cls_030">fibonacci_sequence = [1, 1, 2, 3, 5, 8]</span></div>
<div style="position:absolute;left:141.00px;top:118.55px" class="cls_007"><span class="cls_007">As Figure 11-12 illustrates, MRI creates a C structure for the array but</span></div>
<div style="position:absolute;left:123.00px;top:130.55px" class="cls_007"><span class="cls_007">saves its elements elsewhere.</span></div>
<div style="position:absolute;left:131.44px;top:157.39px" class="cls_212"><span class="cls_212">RArray</span></div>
<div style="position:absolute;left:144.55px;top:180.72px" class="cls_212"><span class="cls_212">RBasic</span></div>
<div style="position:absolute;left:161.03px;top:194.26px" class="cls_125"><span class="cls_125">flags</span></div>
<div style="position:absolute;left:161.03px;top:215.68px" class="cls_125"><span class="cls_125">klass</span></div>
<div style="position:absolute;left:157.14px;top:242.64px" class="cls_125"><span class="cls_125">len = 6</span></div>
<div style="position:absolute;left:164.90px;top:273.08px" class="cls_125"><span class="cls_125">ptr</span></div>
<div style="position:absolute;left:263.38px;top:272.56px" class="cls_124"><span class="cls_124">1</span></div>
<div style="position:absolute;left:282.21px;top:272.56px" class="cls_124"><span class="cls_124">1</span></div>
<div style="position:absolute;left:301.05px;top:272.56px" class="cls_124"><span class="cls_124">2</span></div>
<div style="position:absolute;left:320.12px;top:272.56px" class="cls_124"><span class="cls_124">3</span></div>
<div style="position:absolute;left:338.95px;top:272.56px" class="cls_124"><span class="cls_124">5</span></div>
<div style="position:absolute;left:357.79px;top:272.56px" class="cls_124"><span class="cls_124">8</span></div>
<div style="position:absolute;left:155.20px;top:303.53px" class="cls_125"><span class="cls_125">capa = 6</span></div>
<div style="position:absolute;left:123.00px;top:336.47px" class="cls_038"><span class="cls_038">Figure 11-12: MRI uses the </span><span class="cls_014">RArray</span><span class="cls_038"> C structure to represent arrays.</span></div>
<div style="position:absolute;left:141.00px;top:358.97px" class="cls_007"><span class="cls_007">MRI uses one </span><span class="cls_030">RArray</span><span class="cls_007"> structure to represent each array you create. Like</span></div>
<div style="position:absolute;left:123.00px;top:370.97px" class="cls_030"><span class="cls_030">RString</span><span class="cls_007">, </span><span class="cls_030">RObject</span><span class="cls_007">, and other C structures, </span><span class="cls_030">RArray</span><span class="cls_007"> uses the inner </span><span class="cls_030">RBasic</span><span class="cls_007"> struc-</span></div>
<div style="position:absolute;left:123.00px;top:382.97px" class="cls_007"><span class="cls_007">ture to hold the </span><span class="cls_030">klass</span><span class="cls_007"> pointer and other technical information. (In this</span></div>
<div style="position:absolute;left:123.00px;top:394.97px" class="cls_007"><span class="cls_007">case, the </span><span class="cls_030">klass</span><span class="cls_007"> pointer points to the </span><span class="cls_030">RClass</span><span class="cls_007"> structure for the </span><span class="cls_030">Array</span><span class="cls_007"> class.)</span></div>
<div style="position:absolute;left:141.00px;top:406.97px" class="cls_007"><span class="cls_007">Below </span><span class="cls_030">RBasic</span><span class="cls_007"> are a few additional values specific to arrays—</span><span class="cls_030">ptr</span><span class="cls_007">, </span><span class="cls_030">len</span><span class="cls_007">,</span></div>
<div style="position:absolute;left:123.00px;top:418.97px" class="cls_007"><span class="cls_007">and </span><span class="cls_030">capa</span><span class="cls_007">:</span></div>
<div style="position:absolute;left:123.00px;top:439.97px" class="cls_050"><span class="cls_050">•</span><span class="cls_030">   ptr</span><span class="cls_007"> is a pointer to a memory segment Ruby allocates separately to store</span></div>
<div style="position:absolute;left:141.00px;top:451.97px" class="cls_007"><span class="cls_007">the array elements. The Fibonacci numbers appear in this memory seg-</span></div>
<div style="position:absolute;left:141.00px;top:463.97px" class="cls_007"><span class="cls_007">ment at the right side of Figure 11-12.</span></div>
<div style="position:absolute;left:123.00px;top:478.97px" class="cls_050"><span class="cls_050">•</span><span class="cls_030">   len</span><span class="cls_007"> is the length of the array—that is, the number of values saved in the</span></div>
<div style="position:absolute;left:141.00px;top:490.97px" class="cls_007"><span class="cls_007">separate memory segment.</span></div>
<div style="position:absolute;left:123.00px;top:505.97px" class="cls_050"><span class="cls_050">•</span><span class="cls_030">   capa</span><span class="cls_007"> tracks the capacity of the memory segment. This number is often</span></div>
<div style="position:absolute;left:141.00px;top:517.97px" class="cls_007"><span class="cls_007">larger than </span><span class="cls_030">len</span><span class="cls_007">. MRI avoids continually resizing the memory segment</span></div>
<div style="position:absolute;left:141.00px;top:529.97px" class="cls_007"><span class="cls_007">each time you change the size of the array; instead, as you add array ele-</span></div>
<div style="position:absolute;left:141.00px;top:541.97px" class="cls_007"><span class="cls_007">ments, it occasionally increases the size of the separate memory segment,</span></div>
<div style="position:absolute;left:141.00px;top:553.97px" class="cls_007"><span class="cls_007">each time allocating more memory than the new elements require.</span></div>
<div style="position:absolute;left:141.00px;top:574.97px" class="cls_007"><span class="cls_007">Each value in the separate memory segment is actually a </span><span class="cls_030">VALUE</span><span class="cls_007"> pointer</span></div>
<div style="position:absolute;left:123.00px;top:586.97px" class="cls_007"><span class="cls_007">to a Ruby object. In this case, the Fibonacci numbers would be saved directly</span></div>
<div style="position:absolute;left:123.00px;top:598.97px" class="cls_007"><span class="cls_007">inside the </span><span class="cls_030">VALUE</span><span class="cls_007"> pointers because they are simple integers.</span></div>
<div style="position:absolute;left:326.78px;top:636.00px" class="cls_021"><span class="cls_021">Rubinius: Ruby Implemented with Ruby</span></div>
<div style="position:absolute;left:442.50px;top:633.00px" class="cls_020"><span class="cls_020">285</span></div>
</div>
<div style="position:absolute;left:50%;margin-left:-252px;top:206180px;width:504px;height:666px;border-style:outset;overflow:hidden">
<div style="position:absolute;left:0px;top:0px">
<img src="e698b76e-46bd-11eb-8b25-0cc47a792c0a_id_e698b76e-46bd-11eb-8b25-0cc47a792c0a_files/background310.jpg" width=504 height=666></div>
<div style="position:absolute;left:181.29px;top:61.31px" class="cls_020"><span class="cls_020">The RArray C Structure Definition</span></div>
<div style="position:absolute;left:121.70px;top:79.81px" class="cls_039"><span class="cls_039">Listing 11-8 shows the definition of </span><span class="cls_009">RArray</span><span class="cls_039"> from the MRI C source code.</span></div>
<div style="position:absolute;left:121.70px;top:102.31px" class="cls_009"><span class="cls_009">#define RARRAY_EMBED_LEN_MAX 3</span></div>
<div style="position:absolute;left:121.70px;top:111.82px" class="cls_009"><span class="cls_009">struct RArray {</span></div>
<div style="position:absolute;left:129.20px;top:121.32px" class="cls_009"><span class="cls_009">struct RBasic basic;</span></div>
<div style="position:absolute;left:111.20px;top:130.82px" class="cls_045"><span class="cls_045">u</span><span class="cls_009">   union {</span></div>
<div style="position:absolute;left:136.70px;top:140.32px" class="cls_009"><span class="cls_009">struct {</span></div>
<div style="position:absolute;left:111.20px;top:149.83px" class="cls_045"><span class="cls_045">v</span></div>
<div style="position:absolute;left:144.14px;top:149.83px" class="cls_009"><span class="cls_009">long len;</span></div>
<div style="position:absolute;left:144.20px;top:159.33px" class="cls_009"><span class="cls_009">union {</span></div>
<div style="position:absolute;left:111.20px;top:168.83px" class="cls_045"><span class="cls_045">w</span></div>
<div style="position:absolute;left:151.64px;top:168.83px" class="cls_009"><span class="cls_009">long capa;</span></div>
<div style="position:absolute;left:111.20px;top:178.33px" class="cls_045"><span class="cls_045">x</span></div>
<div style="position:absolute;left:151.64px;top:178.33px" class="cls_009"><span class="cls_009">VALUE shared;</span></div>
<div style="position:absolute;left:144.20px;top:187.84px" class="cls_009"><span class="cls_009">} aux;</span></div>
<div style="position:absolute;left:111.20px;top:197.34px" class="cls_045"><span class="cls_045">y</span></div>
<div style="position:absolute;left:144.14px;top:197.34px" class="cls_009"><span class="cls_009">VALUE *ptr;</span></div>
<div style="position:absolute;left:136.70px;top:206.84px" class="cls_009"><span class="cls_009">} heap;</span></div>
<div style="position:absolute;left:111.20px;top:216.34px" class="cls_045"><span class="cls_045">z</span><span class="cls_009">     VALUE ary[RARRAY_EMBED_LEN_MAX];</span></div>
<div style="position:absolute;left:129.20px;top:225.85px" class="cls_009"><span class="cls_009">} as;</span></div>
<div style="position:absolute;left:121.70px;top:235.35px" class="cls_009"><span class="cls_009">};</span></div>
<div style="position:absolute;left:121.70px;top:257.81px" class="cls_043"><span class="cls_043">Listing 11-8: The definition of </span><span class="cls_015">RArray</span><span class="cls_043"> (from </span><span class="cls_065">include/ruby/ruby.h</span><span class="cls_043">)</span></div>
<div style="position:absolute;left:139.70px;top:280.81px" class="cls_039"><span class="cls_039">This definition shows a few values that are missing from Figure 11-12. First, at </span><span class="cls_046">u</span><span class="cls_039">,</span></div>
<div style="position:absolute;left:121.70px;top:292.81px" class="cls_039"><span class="cls_039">notice that MRI uses a C </span><span class="cls_009">union</span><span class="cls_039"> keyword to declare two alternative definitions for</span></div>
<div style="position:absolute;left:121.70px;top:304.81px" class="cls_009"><span class="cls_009">RArray</span><span class="cls_039">. The first, an inner </span><span class="cls_009">struct</span><span class="cls_039">, defines </span><span class="cls_009">len</span><span class="cls_039"> at </span><span class="cls_046">v</span><span class="cls_039">, </span><span class="cls_009">capa</span><span class="cls_039"> at </span><span class="cls_046">w</span><span class="cls_039">, </span><span class="cls_009">shared</span><span class="cls_039"> at </span><span class="cls_046">x</span><span class="cls_039">, and </span><span class="cls_009">ptr</span></div>
<div style="position:absolute;left:121.70px;top:316.82px" class="cls_039"><span class="cls_039">at </span><span class="cls_046">y</span><span class="cls_039">. As with strings, MRI uses copy-on-write optimization with arrays, allowing two</span></div>
<div style="position:absolute;left:121.70px;top:328.82px" class="cls_039"><span class="cls_039">or more arrays to share the same underlying data. For arrays that share data, the</span></div>
<div style="position:absolute;left:121.70px;top:340.81px" class="cls_009"><span class="cls_009">shared</span><span class="cls_039"> value at </span><span class="cls_046">x</span><span class="cls_039"> refers to another </span><span class="cls_009">RArray</span><span class="cls_039"> that contains the shared data.</span></div>
<div style="position:absolute;left:139.70px;top:352.81px" class="cls_039"><span class="cls_039">The second half of the union at </span><span class="cls_046">z</span><span class="cls_039"> defines </span><span class="cls_009">ary</span><span class="cls_039">, a C array of </span><span class="cls_009">VALUE</span><span class="cls_039"> pointers in</span></div>
<div style="position:absolute;left:121.70px;top:364.81px" class="cls_009"><span class="cls_009">RArray</span><span class="cls_039">. This is an optimization that allows MRI to save the array data for arrays with</span></div>
<div style="position:absolute;left:121.70px;top:376.81px" class="cls_039"><span class="cls_039">three or fewer elements inside the </span><span class="cls_009">RArray</span><span class="cls_039"> structure itself, avoiding the need to allo-</span></div>
<div style="position:absolute;left:121.71px;top:388.82px" class="cls_039"><span class="cls_039">cate the separate memory segment at all. MRI optimizes four other C structures in a</span></div>
<div style="position:absolute;left:121.71px;top:400.81px" class="cls_039"><span class="cls_039">similar way: </span><span class="cls_009">RString</span><span class="cls_039">, </span><span class="cls_009">RObject</span><span class="cls_039">, </span><span class="cls_009">RStruct</span><span class="cls_039"> (used by the </span><span class="cls_009">Struct</span><span class="cls_039"> class), and </span><span class="cls_009">RBignum</span><span class="cls_039"> (used</span></div>
<div style="position:absolute;left:121.70px;top:412.81px" class="cls_039"><span class="cls_039">by the </span><span class="cls_009">Bignum</span><span class="cls_039"> class).</span></div>
<div style="position:absolute;left:120.00px;top:479.35px" class="cls_055"><span class="cls_055">Arrays Inside of Rubinius</span></div>
<div style="position:absolute;left:120.00px;top:497.35px" class="cls_007"><span class="cls_007">Now let’s see how Rubinius saves the same Fibonacci array internally. We</span></div>
<div style="position:absolute;left:120.00px;top:509.35px" class="cls_007"><span class="cls_007">learned earlier that Rubinius represents each Ruby object with a correspond-</span></div>
<div style="position:absolute;left:120.00px;top:521.35px" class="cls_007"><span class="cls_007">ing C++ object. This representation is true of arrays as well. For example,</span></div>
<div style="position:absolute;left:120.00px;top:533.35px" class="cls_007"><span class="cls_007">Figure 11-13 shows the C++ object that Rubinius would use to represent</span></div>
<div style="position:absolute;left:120.00px;top:545.35px" class="cls_030"><span class="cls_030">fibonacci_sequence</span><span class="cls_007">.</span></div>
<div style="position:absolute;left:48.00px;top:633.00px" class="cls_020"><span class="cls_020">286</span></div>
<div style="position:absolute;left:74.64px;top:636.00px" class="cls_021"><span class="cls_021">Chapter 11</span></div>
</div>
<div style="position:absolute;left:50%;margin-left:-252px;top:206856px;width:504px;height:666px;border-style:outset;overflow:hidden">
<div style="position:absolute;left:0px;top:0px">
<img src="e698b76e-46bd-11eb-8b25-0cc47a792c0a_id_e698b76e-46bd-11eb-8b25-0cc47a792c0a_files/background311.jpg" width=504 height=666></div>
<div style="position:absolute;left:129.26px;top:49.80px" class="cls_020"><span class="cls_020">Array</span></div>
<div style="position:absolute;left:134.06px;top:67.35px" class="cls_014"><span class="cls_014">ObjectHeader</span></div>
<div style="position:absolute;left:206.32px;top:67.35px" class="cls_014"><span class="cls_014">total_ = 6</span></div>
<div style="position:absolute;left:272.64px;top:67.35px" class="cls_014"><span class="cls_014">tuple_</span></div>
<div style="position:absolute;left:323.80px;top:67.35px" class="cls_014"><span class="cls_014">start_ = 0</span></div>
<div style="position:absolute;left:123.00px;top:99.00px" class="cls_038"><span class="cls_038">Figure 11-13: Rubinius uses C++ objects to represent arrays.</span></div>
<div style="position:absolute;left:141.00px;top:121.50px" class="cls_007"><span class="cls_007">The combined four blocks represent an instance of the </span><span class="cls_030">Array</span><span class="cls_007"> C++ class.</span></div>
<div style="position:absolute;left:123.00px;top:133.50px" class="cls_007"><span class="cls_007">Rubinius creates a C++ array object each time you create an array. From left</span></div>
<div style="position:absolute;left:123.00px;top:145.50px" class="cls_007"><span class="cls_007">to right, the fields are as follows:</span></div>
<div style="position:absolute;left:123.00px;top:166.50px" class="cls_050"><span class="cls_050">•</span><span class="cls_030">   ObjectHeader</span><span class="cls_007"> contains technical information that Rubinius keeps track</span></div>
<div style="position:absolute;left:141.00px;top:178.50px" class="cls_007"><span class="cls_007">of inside each object, including a class pointer and an array of instance</span></div>
<div style="position:absolute;left:141.00px;top:190.50px" class="cls_007"><span class="cls_007">variables. </span><span class="cls_030">ObjectHeader</span><span class="cls_007"> corresponds to the </span><span class="cls_030">RBasic</span><span class="cls_007"> C structure in MRI and</span></div>
<div style="position:absolute;left:141.00px;top:202.50px" class="cls_007"><span class="cls_007">is one of the C++ superclasses of the </span><span class="cls_030">Array</span><span class="cls_007"> C++ class inside the Rubinius</span></div>
<div style="position:absolute;left:141.00px;top:214.50px" class="cls_007"><span class="cls_007">virtual machine.</span></div>
<div style="position:absolute;left:123.00px;top:229.50px" class="cls_050"><span class="cls_050">•</span><span class="cls_030">   total_</span><span class="cls_007"> is the length of the array, which is 6 for </span><span class="cls_030">fibonacci_sequence</span><span class="cls_007">.</span></div>
<div style="position:absolute;left:123.00px;top:244.50px" class="cls_050"><span class="cls_050">•</span><span class="cls_030">   tuple_</span><span class="cls_007"> is a pointer to an instance of another C++ class, called </span><span class="cls_030">Tuple</span><span class="cls_007">, that</span></div>
<div style="position:absolute;left:141.00px;top:256.50px" class="cls_007"><span class="cls_007">contains the array data.</span></div>
<div style="position:absolute;left:123.00px;top:271.50px" class="cls_050"><span class="cls_050">•</span><span class="cls_030">   start_</span><span class="cls_007"> indicates where the array data starts inside the tuple object. (The</span></div>
<div style="position:absolute;left:141.00px;top:283.50px" class="cls_007"><span class="cls_007">tuple may contain more data than your array needs.) Initially, Rubinius</span></div>
<div style="position:absolute;left:141.00px;top:295.50px" class="cls_007"><span class="cls_007">sets this to 0.</span></div>
<div style="position:absolute;left:141.00px;top:316.50px" class="cls_007"><span class="cls_007">Rubinius doesn’t save the array data in the C++ array object. It saves it</span></div>
<div style="position:absolute;left:123.00px;top:328.50px" class="cls_007"><span class="cls_007">in a tuple object, as shown in Figure 11-14.</span></div>
<div style="position:absolute;left:247.90px;top:349.60px" class="cls_014"><span class="cls_014">tuple_</span></div>
<div style="position:absolute;left:129.26px;top:386.71px" class="cls_042"><span class="cls_042">Tuple</span></div>
<div style="position:absolute;left:134.06px;top:404.27px" class="cls_014"><span class="cls_014">ObjectHeader</span></div>
<div style="position:absolute;left:204.13px;top:404.27px" class="cls_014"><span class="cls_014">full_size_ = 80</span></div>
<div style="position:absolute;left:281.40px;top:404.10px" class="cls_033"><span class="cls_033">1</span></div>
<div style="position:absolute;left:300.82px;top:404.10px" class="cls_033"><span class="cls_033">1</span></div>
<div style="position:absolute;left:320.23px;top:404.10px" class="cls_033"><span class="cls_033">2</span></div>
<div style="position:absolute;left:339.89px;top:404.10px" class="cls_033"><span class="cls_033">3</span></div>
<div style="position:absolute;left:359.31px;top:404.10px" class="cls_033"><span class="cls_033">5</span></div>
<div style="position:absolute;left:378.73px;top:404.10px" class="cls_033"><span class="cls_033">8</span></div>
<div style="position:absolute;left:320.69px;top:431.27px" class="cls_014"><span class="cls_014">fields</span></div>
<div style="position:absolute;left:123.00px;top:450.49px" class="cls_038"><span class="cls_038">Figure 11-14: Rubinius saves array data in tuple objects.</span></div>
<div style="position:absolute;left:141.00px;top:472.99px" class="cls_007"><span class="cls_007">Each tuple contains the same object header information as arrays.</span></div>
<div style="position:absolute;left:123.00px;top:484.99px" class="cls_007"><span class="cls_007">Rubinius saves this header information in every C++ object. Following the</span></div>
<div style="position:absolute;left:123.00px;top:496.99px" class="cls_007"><span class="cls_007">object header, tuple objects contain a value called </span><span class="cls_030">full_size_</span><span class="cls_007">, which keeps</span></div>
<div style="position:absolute;left:123.00px;top:508.99px" class="cls_007"><span class="cls_007">track of the size of this tuple object in bytes. Following this value, Rubinius</span></div>
<div style="position:absolute;left:123.00px;top:520.99px" class="cls_007"><span class="cls_007">saves the actual data values in a C++ array called </span><span class="cls_030">fields</span><span class="cls_007">. These data values</span></div>
<div style="position:absolute;left:123.00px;top:532.99px" class="cls_007"><span class="cls_007">are our six Fibonacci numbers, as shown at the right of Figure 11-14.</span></div>
<div style="position:absolute;left:81.00px;top:559.49px" class="cls_032"><span class="cls_032">Note</span></div>
<div style="position:absolute;left:123.00px;top:556.99px" class="cls_008"><span class="cls_008">Array data values are saved in the tuple C++ object. If we had created a larger</span></div>
<div style="position:absolute;left:123.00px;top:568.99px" class="cls_008"><span class="cls_008">array, Rubinius would have used a larger tuple object. If we change the size of</span></div>
<div style="position:absolute;left:123.00px;top:580.99px" class="cls_008"><span class="cls_008">an array, Rubinius allocates another tuple of the appropriate size or, as we’ll see</span></div>
<div style="position:absolute;left:123.00px;top:592.99px" class="cls_008"><span class="cls_008">in Experiment 11-2, it can optimize certain array methods in order to avoid allocat-</span></div>
<div style="position:absolute;left:123.00px;top:604.99px" class="cls_008"><span class="cls_008">ing new objects and speed up your program.</span></div>
<div style="position:absolute;left:326.86px;top:636.00px" class="cls_021"><span class="cls_021">Rubinius: Ruby Implemented with Ruby</span></div>
<div style="position:absolute;left:442.58px;top:633.00px" class="cls_020"><span class="cls_020">287</span></div>
</div>
<div style="position:absolute;left:50%;margin-left:-252px;top:207532px;width:504px;height:666px;border-style:outset;overflow:hidden">
<div style="position:absolute;left:0px;top:0px">
<img src="e698b76e-46bd-11eb-8b25-0cc47a792c0a_id_e698b76e-46bd-11eb-8b25-0cc47a792c0a_files/background312.jpg" width=504 height=666></div>
<div style="position:absolute;left:120.00px;top:42.63px" class="cls_031"><span class="cls_031">Experiment 11-2: Exploring the Rubinius</span></div>
<div style="position:absolute;left:120.00px;top:57.63px" class="cls_031"><span class="cls_031">Implementation of Array#shift</span></div>
<div style="position:absolute;left:120.00px;top:77.63px" class="cls_007"><span class="cls_007">We’ve seen that Rubinius uses C++ objects to represent arrays, but remem-</span></div>
<div style="position:absolute;left:120.00px;top:89.63px" class="cls_007"><span class="cls_007">ber that Rubinius uses a combination of Ruby and C++ code to implement</span></div>
<div style="position:absolute;left:120.00px;top:101.63px" class="cls_007"><span class="cls_007">methods in the </span><span class="cls_030">Array</span><span class="cls_007"> class. In this experiment, we’ll learn more about how</span></div>
<div style="position:absolute;left:120.00px;top:113.63px" class="cls_007"><span class="cls_007">arrays work by looking at how Rubinius implements the </span><span class="cls_030">Array#shift</span><span class="cls_007"> method.</span></div>
<div style="position:absolute;left:138.00px;top:125.63px" class="cls_007"><span class="cls_007">But first a quick review of what </span><span class="cls_030">Array#shift</span><span class="cls_007"> does. As you may know, call-</span></div>
<div style="position:absolute;left:120.01px;top:137.63px" class="cls_007"><span class="cls_007">ing </span><span class="cls_030">shift</span><span class="cls_007"> removes one element from the beginning of an array and </span><span class="cls_008">shifts</span><span class="cls_007"> the</span></div>
<div style="position:absolute;left:120.00px;top:149.63px" class="cls_007"><span class="cls_007">remaining elements to the left, as shown in Listing 11-9.</span></div>
<div style="position:absolute;left:120.00px;top:173.63px" class="cls_030"><span class="cls_030">fibonacci_sequence = [1, 1, 2, 3, 5, 8]</span></div>
<div style="position:absolute;left:120.00px;top:184.12px" class="cls_030"><span class="cls_030">p fibonacci_sequence.shift</span></div>
<div style="position:absolute;left:108.15px;top:194.62px" class="cls_046"><span class="cls_046">u</span><span class="cls_030">  => 1</span></div>
<div style="position:absolute;left:120.00px;top:205.12px" class="cls_030"><span class="cls_030">p fibonacci_sequence</span></div>
<div style="position:absolute;left:108.15px;top:215.62px" class="cls_046"><span class="cls_046">v</span><span class="cls_030">  => [1, 2, 3, 5, 8]</span></div>
<div style="position:absolute;left:120.00px;top:238.11px" class="cls_038"><span class="cls_038">Listing 11-9: </span><span class="cls_014">Array#shift</span><span class="cls_038"> removes the first element from an array, shifting the remaining</span></div>
<div style="position:absolute;left:120.00px;top:248.62px" class="cls_038"><span class="cls_038">elements over.</span></div>
<div style="position:absolute;left:138.00px;top:271.13px" class="cls_007"><span class="cls_007">At </span><span class="cls_050">u</span><span class="cls_007"> </span><span class="cls_030">Array#shift</span><span class="cls_007"> returns the first element of </span><span class="cls_030">fibonacci_sequence</span><span class="cls_007">. We can</span></div>
<div style="position:absolute;left:120.00px;top:283.13px" class="cls_007"><span class="cls_007">see from the output at </span><span class="cls_050">v</span><span class="cls_007"> that </span><span class="cls_030">Array#shift</span><span class="cls_007"> also removes the first element from</span></div>
<div style="position:absolute;left:120.00px;top:295.13px" class="cls_007"><span class="cls_007">the array, shifting the other five elements. But how does Ruby implement</span></div>
<div style="position:absolute;left:120.00px;top:307.13px" class="cls_030"><span class="cls_030">Array#shift</span><span class="cls_007"> internally? Does it actually copy the remaining array elements</span></div>
<div style="position:absolute;left:120.00px;top:319.13px" class="cls_007"><span class="cls_007">to the left, or does it copy them into a new array?</span></div>
<div style="position:absolute;left:120.00px;top:344.13px" class="cls_055"><span class="cls_055">Reading Array#shift</span></div>
<div style="position:absolute;left:120.00px;top:362.13px" class="cls_007"><span class="cls_007">First, let’s find out where the </span><span class="cls_030">Array#shift</span><span class="cls_007"> method is located inside Rubinius.</span></div>
<div style="position:absolute;left:120.00px;top:374.13px" class="cls_007"><span class="cls_007">Because we don’t have a backtrace to refer to as in Experiment 11-1, we can</span></div>
<div style="position:absolute;left:120.00px;top:386.13px" class="cls_007"><span class="cls_007">ask Rubinius where to find the method using </span><span class="cls_030">source_location</span><span class="cls_007">.</span></div>
<div style="position:absolute;left:120.00px;top:410.13px" class="cls_030"><span class="cls_030">p Array.instance_method(:shift).source_location</span></div>
<div style="position:absolute;left:124.25px;top:420.62px" class="cls_030"><span class="cls_030">=> ["kernel/common/array.rb", 848]</span></div>
<div style="position:absolute;left:138.00px;top:443.13px" class="cls_007"><span class="cls_007">This output tells us that Rubinius defines the </span><span class="cls_030">Array#shift</span><span class="cls_007"> method</span></div>
<div style="position:absolute;left:120.00px;top:455.13px" class="cls_007"><span class="cls_007">at line 848 in the file </span><span class="cls_008">kernel/common/array.rb</span><span class="cls_007"> in the Rubinius source tree.</span></div>
<div style="position:absolute;left:120.00px;top:467.13px" class="cls_007"><span class="cls_007">Listing 11-10 shows the Rubinius implementation of </span><span class="cls_030">Array#shift</span><span class="cls_007">.</span></div>
<div style="position:absolute;left:108.15px;top:491.13px" class="cls_046"><span class="cls_046">u</span><span class="cls_030"> def shift(n=undefined)</span></div>
<div style="position:absolute;left:128.50px;top:501.62px" class="cls_030"><span class="cls_030">Rubinius.check_frozen</span></div>
<div style="position:absolute;left:108.15px;top:522.63px" class="cls_046"><span class="cls_046">v</span><span class="cls_030">   if undefined.equal?(n)</span></div>
<div style="position:absolute;left:137.00px;top:533.12px" class="cls_030"><span class="cls_030">return nil if @total == 0</span></div>
<div style="position:absolute;left:108.15px;top:543.62px" class="cls_046"><span class="cls_046">w</span><span class="cls_030">     obj = @tuple.at @start</span></div>
<div style="position:absolute;left:137.00px;top:554.12px" class="cls_030"><span class="cls_030">@tuple.put @start, nil</span></div>
<div style="position:absolute;left:137.00px;top:564.62px" class="cls_030"><span class="cls_030">@start += 1</span></div>
<div style="position:absolute;left:137.00px;top:575.11px" class="cls_030"><span class="cls_030">@total -= 1</span></div>
<div style="position:absolute;left:137.00px;top:596.12px" class="cls_030"><span class="cls_030">obj</span></div>
<div style="position:absolute;left:48.00px;top:633.00px" class="cls_020"><span class="cls_020">288</span></div>
<div style="position:absolute;left:74.67px;top:636.00px" class="cls_021"><span class="cls_021">Chapter 11</span></div>
</div>
<div style="position:absolute;left:50%;margin-left:-252px;top:208208px;width:504px;height:666px;border-style:outset;overflow:hidden">
<div style="position:absolute;left:0px;top:0px">
<img src="e698b76e-46bd-11eb-8b25-0cc47a792c0a_id_e698b76e-46bd-11eb-8b25-0cc47a792c0a_files/background313.jpg" width=504 height=666></div>
<div style="position:absolute;left:111.15px;top:42.64px" class="cls_046"><span class="cls_046">x</span><span class="cls_030">   else</span></div>
<div style="position:absolute;left:140.00px;top:53.14px" class="cls_030"><span class="cls_030">n = Rubinius::Type.coerce_to(n, Fixnum, :to_int)</span></div>
<div style="position:absolute;left:140.00px;top:63.64px" class="cls_030"><span class="cls_030">raise ArgumentError, "negative array size" if n &lt; 0</span></div>
<div style="position:absolute;left:140.00px;top:84.64px" class="cls_030"><span class="cls_030">Array.new slice!(0, n)</span></div>
<div style="position:absolute;left:131.50px;top:95.14px" class="cls_030"><span class="cls_030">end</span></div>
<div style="position:absolute;left:123.00px;top:105.64px" class="cls_030"><span class="cls_030">end</span></div>
<div style="position:absolute;left:123.00px;top:128.14px" class="cls_038"><span class="cls_038">Listing 11-10: The implementation of </span><span class="cls_014">Array#shift</span><span class="cls_038"> inside the Rubinius kernel</span></div>
<div style="position:absolute;left:141.00px;top:150.64px" class="cls_007"><span class="cls_007">At </span><span class="cls_050">u</span><span class="cls_007"> </span><span class="cls_030">shift</span><span class="cls_007"> takes an optional parameter </span><span class="cls_030">n</span><span class="cls_007">. If </span><span class="cls_030">shift</span><span class="cls_007"> is called without a</span></div>
<div style="position:absolute;left:123.00px;top:162.64px" class="cls_007"><span class="cls_007">parameter </span><span class="cls_030">n</span><span class="cls_007">, as in Listing 11-9, it will remove the first element and shift the</span></div>
<div style="position:absolute;left:123.00px;top:174.64px" class="cls_007"><span class="cls_007">remaining elements by one position. If you provide a parameter </span><span class="cls_030">n</span><span class="cls_007"> to </span><span class="cls_030">shift</span><span class="cls_007">, it</span></div>
<div style="position:absolute;left:123.00px;top:186.64px" class="cls_007"><span class="cls_007">will remove </span><span class="cls_030">n</span><span class="cls_007"> elements and shift the remaining elements </span><span class="cls_030">n</span><span class="cls_007"> positions to the</span></div>
<div style="position:absolute;left:123.00px;top:198.64px" class="cls_007"><span class="cls_007">left. At </span><span class="cls_050">v</span><span class="cls_007"> Rubinius checks whether the parameter </span><span class="cls_030">n</span><span class="cls_007"> was supplied. If </span><span class="cls_030">n</span><span class="cls_007"> was</span></div>
<div style="position:absolute;left:123.00px;top:210.64px" class="cls_007"><span class="cls_007">specified, it jumps to </span><span class="cls_050">x</span><span class="cls_007"> and uses </span><span class="cls_030">Array#slice!</span><span class="cls_007"> to remove the first </span><span class="cls_030">n</span><span class="cls_007"> elements</span></div>
<div style="position:absolute;left:123.00px;top:222.64px" class="cls_007"><span class="cls_007">and return them.</span></div>
<div style="position:absolute;left:123.00px;top:247.64px" class="cls_055"><span class="cls_055">Modifying Array#shift</span></div>
<div style="position:absolute;left:123.00px;top:265.64px" class="cls_007"><span class="cls_007">Now let’s see what happens when you call </span><span class="cls_030">shift</span><span class="cls_007"> with no parameters. How</span></div>
<div style="position:absolute;left:123.00px;top:277.64px" class="cls_007"><span class="cls_007">does Rubinius shift the array by one element? Unfortunately, the </span><span class="cls_030">Tuple#at</span></div>
<div style="position:absolute;left:123.00px;top:289.64px" class="cls_007"><span class="cls_007">method called at </span><span class="cls_050">w</span><span class="cls_007"> is implemented by the C++ code inside the Rubinius vir-</span></div>
<div style="position:absolute;left:123.00px;top:301.64px" class="cls_007"><span class="cls_007">tual machine. (You won’t find a definition for </span><span class="cls_030">at</span><span class="cls_007"> in the Ruby </span><span class="cls_008">kernel/common/</span></div>
<div style="position:absolute;left:123.00px;top:313.64px" class="cls_008"><span class="cls_008">tuple.rb</span><span class="cls_007"> file.) This means we won’t be able to read the entire algorithm</span></div>
<div style="position:absolute;left:123.00px;top:325.64px" class="cls_007"><span class="cls_007">in Ruby.</span></div>
<div style="position:absolute;left:141.00px;top:337.64px" class="cls_007"><span class="cls_007">We can, however, add Ruby code to Rubinius to display information</span></div>
<div style="position:absolute;left:123.00px;top:349.64px" class="cls_007"><span class="cls_007">about the array data when we call </span><span class="cls_030">shift</span><span class="cls_007">. Because the Rubinius kernel is writ-</span></div>
<div style="position:absolute;left:123.00px;top:361.64px" class="cls_007"><span class="cls_007">ten with Ruby, we can change it like any other Ruby program! First, we’ll</span></div>
<div style="position:absolute;left:123.00px;top:373.64px" class="cls_007"><span class="cls_007">add a few lines of code to </span><span class="cls_030">Array#shift</span><span class="cls_007">, as shown in Listing 11-11.</span></div>
<div style="position:absolute;left:123.00px;top:397.64px" class="cls_030"><span class="cls_030">if undefined.equal?(n)</span></div>
<div style="position:absolute;left:131.50px;top:408.14px" class="cls_030"><span class="cls_030">return nil if @total == 0</span></div>
<div style="position:absolute;left:111.15px;top:429.14px" class="cls_046"><span class="cls_046">u</span><span class="cls_030">   fibonacci_array = (self == [1, 1, 2, 3, 5, 8])</span></div>
<div style="position:absolute;left:111.15px;top:439.64px" class="cls_046"><span class="cls_046">v</span><span class="cls_030">   puts "Start: #{@start} Total: #{@total} Tuple: #{@tuple.inspect}" if</span></div>
<div style="position:absolute;left:131.50px;top:450.14px" class="cls_030"><span class="cls_030">fibonacci_array</span></div>
<div style="position:absolute;left:131.50px;top:471.14px" class="cls_030"><span class="cls_030">obj = @tuple.at @start</span></div>
<div style="position:absolute;left:131.50px;top:481.64px" class="cls_030"><span class="cls_030">@tuple.put @start, nil</span></div>
<div style="position:absolute;left:131.50px;top:492.14px" class="cls_030"><span class="cls_030">@start += 1</span></div>
<div style="position:absolute;left:131.50px;top:502.63px" class="cls_030"><span class="cls_030">@total -= 1</span></div>
<div style="position:absolute;left:111.15px;top:523.64px" class="cls_046"><span class="cls_046">w</span><span class="cls_030">   puts "Start: #{@start} Total: #{@total} Tuple: #{@tuple.inspect}" if</span></div>
<div style="position:absolute;left:131.50px;top:534.14px" class="cls_030"><span class="cls_030">fibonacci_array</span></div>
<div style="position:absolute;left:131.50px;top:555.14px" class="cls_030"><span class="cls_030">obj</span></div>
<div style="position:absolute;left:123.00px;top:565.64px" class="cls_030"><span class="cls_030">end</span></div>
<div style="position:absolute;left:123.00px;top:588.14px" class="cls_038"><span class="cls_038">Listing 11-11: Adding debug code to the Rubinius kernel</span></div>
<div style="position:absolute;left:326.74px;top:636.00px" class="cls_021"><span class="cls_021">Rubinius: Ruby Implemented with Ruby</span></div>
<div style="position:absolute;left:442.46px;top:633.00px" class="cls_020"><span class="cls_020">289</span></div>
</div>
<div style="position:absolute;left:50%;margin-left:-252px;top:208884px;width:504px;height:666px;border-style:outset;overflow:hidden">
<div style="position:absolute;left:0px;top:0px">
<img src="e698b76e-46bd-11eb-8b25-0cc47a792c0a_id_e698b76e-46bd-11eb-8b25-0cc47a792c0a_files/background314.jpg" width=504 height=666></div>
<div style="position:absolute;left:138.00px;top:42.71px" class="cls_007"><span class="cls_007">At </span><span class="cls_050">u</span><span class="cls_007"> we check whether this array is our Fibonacci array. Rubinius uses</span></div>
<div style="position:absolute;left:120.00px;top:54.71px" class="cls_007"><span class="cls_007">this method for every array in the system, but we want to display only infor-</span></div>
<div style="position:absolute;left:120.00px;top:66.71px" class="cls_007"><span class="cls_007">mation about our array. Then, at </span><span class="cls_050">v</span><span class="cls_007"> we display the values of </span><span class="cls_030">@start</span><span class="cls_007">, </span><span class="cls_030">@total</span><span class="cls_007">,</span></div>
<div style="position:absolute;left:120.00px;top:78.71px" class="cls_007"><span class="cls_007">and </span><span class="cls_030">@tuple</span><span class="cls_007">. Under the hood, </span><span class="cls_030">@tuple</span><span class="cls_007"> is a C++ object, but in Rubinius it also</span></div>
<div style="position:absolute;left:120.00px;top:90.71px" class="cls_007"><span class="cls_007">functions as a Ruby object, allowing us to call its </span><span class="cls_030">inspect</span><span class="cls_007"> method. At </span><span class="cls_050">w</span><span class="cls_007"> we</span></div>
<div style="position:absolute;left:120.00px;top:102.71px" class="cls_007"><span class="cls_007">display the same values once they’ve been changed by the </span><span class="cls_030">Array#shift</span><span class="cls_007"> code.</span></div>
<div style="position:absolute;left:138.00px;top:114.71px" class="cls_007"><span class="cls_007">Now we need to rebuild Rubinius to include our code changes.</span></div>
<div style="position:absolute;left:120.00px;top:126.71px" class="cls_007"><span class="cls_007">Listing 11-12 shows the output produced by the </span><span class="cls_030">rake install</span><span class="cls_007"> command.</span></div>
<div style="position:absolute;left:120.00px;top:138.71px" class="cls_007"><span class="cls_007">(Run this at the root of the Rubinius source code tree.)</span></div>
<div style="position:absolute;left:120.00px;top:162.71px" class="cls_030"><span class="cls_030">$ </span><span class="cls_040">rake install</span></div>
<div style="position:absolute;left:120.00px;top:183.71px" class="cls_030"><span class="cls_030">--snip--</span></div>
<div style="position:absolute;left:120.00px;top:204.72px" class="cls_030"><span class="cls_030">RBC kernel/common/hash.rb</span></div>
<div style="position:absolute;left:120.00px;top:215.21px" class="cls_030"><span class="cls_030">RBC kernel/common/hash19.rb</span></div>
<div style="position:absolute;left:120.00px;top:225.71px" class="cls_030"><span class="cls_030">RBC kernel/common/hash_hamt.rb</span></div>
<div style="position:absolute;left:108.15px;top:236.21px" class="cls_046"><span class="cls_046">u</span><span class="cls_030"> RBC kernel/common/array.rb</span></div>
<div style="position:absolute;left:120.00px;top:246.71px" class="cls_030"><span class="cls_030">RBC kernel/common/array19.rb</span></div>
<div style="position:absolute;left:120.00px;top:257.20px" class="cls_030"><span class="cls_030">RBC kernel/common/kernel.rb</span></div>
<div style="position:absolute;left:120.00px;top:278.21px" class="cls_030"><span class="cls_030">--snip--</span></div>
<div style="position:absolute;left:120.00px;top:300.71px" class="cls_038"><span class="cls_038">Listing 11-12: Rebuilding Rubinius</span></div>
<div style="position:absolute;left:138.00px;top:323.21px" class="cls_007"><span class="cls_007">The Rubinius build process recompiled the </span><span class="cls_008">array.rb</span><span class="cls_007"> source code file at </span><span class="cls_050">u</span><span class="cls_007">,</span></div>
<div style="position:absolute;left:120.00px;top:335.21px" class="cls_007"><span class="cls_007">along with many other kernel files. (</span><span class="cls_030">RBC</span><span class="cls_007"> refers to the Rubinius compiler.)</span></div>
<div style="position:absolute;left:78.00px;top:367.71px" class="cls_032"><span class="cls_032">Note</span></div>
<div style="position:absolute;left:120.00px;top:365.21px" class="cls_008"><span class="cls_008">Don’t try to use this sort of code change in a production environment.</span></div>
<div style="position:absolute;left:138.00px;top:395.21px" class="cls_007"><span class="cls_007">Now to rerun Listing 11-9 using our modified version of Rubinius.</span></div>
<div style="position:absolute;left:120.00px;top:407.21px" class="cls_007"><span class="cls_007">Listing 11-13 shows the output interspersed with our original code.</span></div>
<div style="position:absolute;left:120.00px;top:431.21px" class="cls_030"><span class="cls_030">fibonacci_sequence = [1, 1, 2, 3, 5, 8]</span></div>
<div style="position:absolute;left:120.00px;top:441.71px" class="cls_030"><span class="cls_030">p fibonacci_sequence.shift</span></div>
<div style="position:absolute;left:108.15px;top:452.20px" class="cls_046"><span class="cls_046">u</span><span class="cls_030"> Start: 0 Total: 6 Tuple: #&lt;Rubinius::Tuple: 1, 1, 2, 3, 5, 8></span></div>
<div style="position:absolute;left:108.15px;top:462.70px" class="cls_046"><span class="cls_046">v</span><span class="cls_030"> Start: 1 Total: 5 Tuple: #&lt;Rubinius::Tuple: nil, 1, 2, 3, 5, 8></span></div>
<div style="position:absolute;left:124.25px;top:473.20px" class="cls_030"><span class="cls_030">=> 1</span></div>
<div style="position:absolute;left:120.00px;top:483.70px" class="cls_030"><span class="cls_030">p fibonacci_sequence</span></div>
<div style="position:absolute;left:124.25px;top:494.20px" class="cls_030"><span class="cls_030">=> [1, 2, 3, 5, 8]</span></div>
<div style="position:absolute;left:120.00px;top:516.69px" class="cls_038"><span class="cls_038">Listing 11-13: Using our modified version of </span><span class="cls_014">Array#shift</span></div>
<div style="position:absolute;left:138.00px;top:539.21px" class="cls_007"><span class="cls_007">At </span><span class="cls_050">u</span><span class="cls_007"> and </span><span class="cls_050">v</span><span class="cls_007"> our new Ruby code inside </span><span class="cls_030">Array#shift</span><span class="cls_007"> displays the inter-</span></div>
<div style="position:absolute;left:120.00px;top:551.21px" class="cls_007"><span class="cls_007">nal contents of </span><span class="cls_030">fibonacci_sequence</span><span class="cls_007">: the </span><span class="cls_030">@start</span><span class="cls_007">, </span><span class="cls_030">@total</span><span class="cls_007">, and </span><span class="cls_030">@tuple</span><span class="cls_007"> instance</span></div>
<div style="position:absolute;left:120.00px;top:563.21px" class="cls_007"><span class="cls_007">variables. Comparing </span><span class="cls_050">u</span><span class="cls_007"> with </span><span class="cls_050">v</span><span class="cls_007">, we can see how </span><span class="cls_030">Array#shift</span><span class="cls_007"> works internally.</span></div>
<div style="position:absolute;left:48.00px;top:633.00px" class="cls_020"><span class="cls_020">290</span></div>
<div style="position:absolute;left:74.65px;top:636.00px" class="cls_021"><span class="cls_021">Chapter 11</span></div>
</div>
<div style="position:absolute;left:50%;margin-left:-252px;top:209560px;width:504px;height:666px;border-style:outset;overflow:hidden">
<div style="position:absolute;left:0px;top:0px">
<img src="e698b76e-46bd-11eb-8b25-0cc47a792c0a_id_e698b76e-46bd-11eb-8b25-0cc47a792c0a_files/background315.jpg" width=504 height=666></div>
<div style="position:absolute;left:123.00px;top:41.60px" class="cls_007"><span class="cls_007">Rubinius hasn’t allocated a new array object; it’s reused the underlying</span></div>
<div style="position:absolute;left:123.00px;top:53.60px" class="cls_007"><span class="cls_007">tuple object. Rubinius has done the following:</span></div>
<div style="position:absolute;left:123.00px;top:74.60px" class="cls_050"><span class="cls_050">•</span><span class="cls_007">   Changed </span><span class="cls_030">@total</span><span class="cls_007"> from 6 to 5 because the length of the array has</span></div>
<div style="position:absolute;left:141.00px;top:86.60px" class="cls_007"><span class="cls_007">decreased by 1</span></div>
<div style="position:absolute;left:123.00px;top:101.60px" class="cls_050"><span class="cls_050">•</span><span class="cls_007">   Changed </span><span class="cls_030">@start</span><span class="cls_007"> from 0 to 1, which allowed it to continue to use the</span></div>
<div style="position:absolute;left:141.00px;top:113.60px" class="cls_007"><span class="cls_007">same value for </span><span class="cls_030">@tuple</span><span class="cls_007">; now the array contents start at the second value</span></div>
<div style="position:absolute;left:141.00px;top:125.60px" class="cls_007"><span class="cls_007">(index 1) in </span><span class="cls_030">@tuple</span><span class="cls_007">, not the first (index 0)</span></div>
<div style="position:absolute;left:123.00px;top:140.60px" class="cls_050"><span class="cls_050">•</span><span class="cls_007">   Changed the first value in </span><span class="cls_030">@tuple</span><span class="cls_007"> from 1 to </span><span class="cls_030">nil</span><span class="cls_007"> because the first value is</span></div>
<div style="position:absolute;left:141.00px;top:152.60px" class="cls_007"><span class="cls_007">no longer used by the array</span></div>
<div style="position:absolute;left:141.00px;top:173.60px" class="cls_007"><span class="cls_007">Creating new objects and allocating new memory can take a long time</span></div>
<div style="position:absolute;left:123.00px;top:185.60px" class="cls_007"><span class="cls_007">because Rubinius might have to ask for memory from the operating system.</span></div>
<div style="position:absolute;left:123.00px;top:197.60px" class="cls_007"><span class="cls_007">Its reuse of the underlying data in the tuple object, without copying or allo-</span></div>
<div style="position:absolute;left:123.00px;top:209.60px" class="cls_007"><span class="cls_007">cating memory for a new array, allows Rubinius to run faster.</span></div>
<div style="position:absolute;left:141.00px;top:221.60px" class="cls_007"><span class="cls_007">Figures 11-15 and 11-16 summarize how </span><span class="cls_030">Array#shift</span><span class="cls_007"> works. Figure 11-15</span></div>
<div style="position:absolute;left:123.00px;top:233.60px" class="cls_007"><span class="cls_007">shows the array before calling </span><span class="cls_030">Array#shift</span><span class="cls_007">: </span><span class="cls_030">@start</span><span class="cls_007"> pointed to the first value in</span></div>
<div style="position:absolute;left:123.00px;top:245.60px" class="cls_007"><span class="cls_007">the tuple, and </span><span class="cls_030">@length</span><span class="cls_007"> was 6.</span></div>
<div style="position:absolute;left:249.85px;top:266.89px" class="cls_017"><span class="cls_017">Before</span></div>
<div style="position:absolute;left:129.26px;top:290.33px" class="cls_042"><span class="cls_042">Tuple</span></div>
<div style="position:absolute;left:134.06px;top:307.88px" class="cls_014"><span class="cls_014">ObjectHeader</span></div>
<div style="position:absolute;left:204.13px;top:307.88px" class="cls_014"><span class="cls_014">full_size_ = 80</span></div>
<div style="position:absolute;left:281.65px;top:307.72px" class="cls_033"><span class="cls_033">1</span></div>
<div style="position:absolute;left:300.82px;top:307.72px" class="cls_033"><span class="cls_033">1</span></div>
<div style="position:absolute;left:320.23px;top:307.72px" class="cls_033"><span class="cls_033">2</span></div>
<div style="position:absolute;left:339.89px;top:307.72px" class="cls_033"><span class="cls_033">3</span></div>
<div style="position:absolute;left:359.31px;top:307.72px" class="cls_033"><span class="cls_033">5</span></div>
<div style="position:absolute;left:378.73px;top:307.72px" class="cls_033"><span class="cls_033">8</span></div>
<div style="position:absolute;left:263.91px;top:348.21px" class="cls_014"><span class="cls_014">@start = 0</span></div>
<div style="position:absolute;left:347.36px;top:348.21px" class="cls_014"><span class="cls_014">@length = 6</span></div>
<div style="position:absolute;left:123.00px;top:366.27px" class="cls_038"><span class="cls_038">Figure 11-15: The tuple holding our Fibonacci numbers before calling </span><span class="cls_014">Array#shift</span></div>
<div style="position:absolute;left:141.00px;top:388.77px" class="cls_007"><span class="cls_007">Figure 11-16 shows the tuple after calling </span><span class="cls_030">Array#shift</span><span class="cls_007">; Rubinius has</span></div>
<div style="position:absolute;left:123.00px;top:400.77px" class="cls_007"><span class="cls_007">simply changed the values of </span><span class="cls_030">@start</span><span class="cls_007"> and </span><span class="cls_030">@length</span><span class="cls_007"> and set the first value in</span></div>
<div style="position:absolute;left:123.00px;top:412.77px" class="cls_007"><span class="cls_007">the tuple to </span><span class="cls_030">nil</span><span class="cls_007">.</span></div>
<div style="position:absolute;left:253.05px;top:434.06px" class="cls_017"><span class="cls_017">After</span></div>
<div style="position:absolute;left:129.26px;top:457.50px" class="cls_042"><span class="cls_042">Tuple</span></div>
<div style="position:absolute;left:134.06px;top:475.05px" class="cls_014"><span class="cls_014">ObjectHeader</span></div>
<div style="position:absolute;left:204.13px;top:475.05px" class="cls_014"><span class="cls_014">full_size_ = 80</span></div>
<div style="position:absolute;left:277.90px;top:475.89px" class="cls_014"><span class="cls_014">nil</span></div>
<div style="position:absolute;left:300.82px;top:474.89px" class="cls_033"><span class="cls_033">1</span></div>
<div style="position:absolute;left:320.23px;top:474.89px" class="cls_033"><span class="cls_033">2</span></div>
<div style="position:absolute;left:339.89px;top:474.89px" class="cls_033"><span class="cls_033">3</span></div>
<div style="position:absolute;left:359.31px;top:474.89px" class="cls_033"><span class="cls_033">5</span></div>
<div style="position:absolute;left:378.73px;top:474.89px" class="cls_033"><span class="cls_033">8</span></div>
<div style="position:absolute;left:283.32px;top:515.38px" class="cls_014"><span class="cls_014">@start = 1</span></div>
<div style="position:absolute;left:347.36px;top:515.38px" class="cls_014"><span class="cls_014">@length = 5</span></div>
<div style="position:absolute;left:123.00px;top:533.44px" class="cls_038"><span class="cls_038">Figure 11-16: The same tuple after calling </span><span class="cls_014">Array#shift</span></div>
<div style="position:absolute;left:141.00px;top:555.94px" class="cls_007"><span class="cls_007">As you might guess, MRI uses a similar optimization for </span><span class="cls_030">Array#shift</span><span class="cls_007"> by</span></div>
<div style="position:absolute;left:123.00px;top:567.94px" class="cls_007"><span class="cls_007">keeping track of where the array data starts in the original array. However,</span></div>
<div style="position:absolute;left:123.00px;top:579.94px" class="cls_007"><span class="cls_007">the C code it uses is more complex and difficult to understand. The Rubinius</span></div>
<div style="position:absolute;left:123.00px;top:591.94px" class="cls_007"><span class="cls_007">kernel gives us a much clearer view of this algorithm.</span></div>
<div style="position:absolute;left:326.98px;top:636.00px" class="cls_021"><span class="cls_021">Rubinius: Ruby Implemented with Ruby</span></div>
<div style="position:absolute;left:442.70px;top:633.00px" class="cls_020"><span class="cls_020">291</span></div>
</div>
<div style="position:absolute;left:50%;margin-left:-252px;top:210236px;width:504px;height:666px;border-style:outset;overflow:hidden">
<div style="position:absolute;left:0px;top:0px">
<img src="e698b76e-46bd-11eb-8b25-0cc47a792c0a_id_e698b76e-46bd-11eb-8b25-0cc47a792c0a_files/background316.jpg" width=504 height=666></div>
<div style="position:absolute;left:66.00px;top:42.63px" class="cls_031"><span class="cls_031">Summary</span></div>
<div style="position:absolute;left:120.00px;top:62.63px" class="cls_007"><span class="cls_007">We’ve learned in this chapter that Rubinius uses a virtual machine imple-</span></div>
<div style="position:absolute;left:120.00px;top:74.63px" class="cls_007"><span class="cls_007">mented with C++ to run your Ruby code. Like YARV, the Rubinius virtual</span></div>
<div style="position:absolute;left:120.00px;top:86.63px" class="cls_007"><span class="cls_007">machine was custom designed to run Ruby programs, and it uses a compiler</span></div>
<div style="position:absolute;left:120.00px;top:98.63px" class="cls_007"><span class="cls_007">to convert your Ruby program into bytecode internally. We saw that these</span></div>
<div style="position:absolute;left:120.00px;top:110.63px" class="cls_007"><span class="cls_007">Rubinius instructions resemble YARV instructions; they operate on stack</span></div>
<div style="position:absolute;left:120.00px;top:122.63px" class="cls_007"><span class="cls_007">values in a similar way.</span></div>
<div style="position:absolute;left:138.00px;top:134.63px" class="cls_007"><span class="cls_007">But what sets Rubinius apart from other Ruby implementations is its</span></div>
<div style="position:absolute;left:120.00px;top:146.63px" class="cls_007"><span class="cls_007">Ruby language kernel. The Rubinius kernel implements many built-in Ruby</span></div>
<div style="position:absolute;left:120.00px;top:158.63px" class="cls_007"><span class="cls_007">classes, such as </span><span class="cls_030">Array</span><span class="cls_007">, using Ruby code. This innovative design provides a</span></div>
<div style="position:absolute;left:120.00px;top:170.63px" class="cls_007"><span class="cls_007">window into Ruby internals—you can use Rubinius to learn how Ruby works</span></div>
<div style="position:absolute;left:120.00px;top:182.63px" class="cls_007"><span class="cls_007">internally without having to know C or Java. You can learn how Ruby imple-</span></div>
<div style="position:absolute;left:120.00px;top:194.63px" class="cls_007"><span class="cls_007">ments strings, arrays, or other classes simply by reading the Ruby source</span></div>
<div style="position:absolute;left:120.00px;top:206.63px" class="cls_007"><span class="cls_007">code in the Rubinius kernel. Rubinius isn’t just a Ruby implementation;</span></div>
<div style="position:absolute;left:120.00px;top:218.63px" class="cls_007"><span class="cls_007">it’s a valuable learning resource for the Ruby community.</span></div>
<div style="position:absolute;left:48.00px;top:633.00px" class="cls_020"><span class="cls_020">292</span></div>
<div style="position:absolute;left:74.59px;top:636.00px" class="cls_021"><span class="cls_021">Chapter 11</span></div>
</div>
<div style="position:absolute;left:50%;margin-left:-252px;top:210912px;width:504px;height:666px;border-style:outset;overflow:hidden">
<div style="position:absolute;left:0px;top:0px">
<img src="e698b76e-46bd-11eb-8b25-0cc47a792c0a_id_e698b76e-46bd-11eb-8b25-0cc47a792c0a_files/background317.jpg" width=504 height=666></div>
</div>
<div style="position:absolute;left:50%;margin-left:-252px;top:210912px;width:504px;height:666px;border-style:outset;overflow:hidden">
<div style="position:absolute;left:0px;top:0px">
<img src="e698b76e-46bd-11eb-8b25-0cc47a792c0a_id_e698b76e-46bd-11eb-8b25-0cc47a792c0a_files/background318.jpg" width=504 height=666></div>
<div style="position:absolute;left:232.43px;top:297.71px" class="cls_024"><span class="cls_024">The garbage collector is</span></div>
<div style="position:absolute;left:220.64px;top:315.72px" class="cls_024"><span class="cls_024">where Ruby objects are born</span></div>
<div style="position:absolute;left:243.01px;top:333.72px" class="cls_024"><span class="cls_024">and where they die.</span></div>
</div>
<div style="position:absolute;left:50%;margin-left:-252px;top:211588px;width:504px;height:666px;border-style:outset;overflow:hidden">
<div style="position:absolute;left:0px;top:0px">
<img src="e698b76e-46bd-11eb-8b25-0cc47a792c0a_id_e698b76e-46bd-11eb-8b25-0cc47a792c0a_files/background319.jpg" width=504 height=666></div>
<div style="position:absolute;left:236.64px;top:96.48px" class="cls_035"><span class="cls_035">12</span></div>
<div style="position:absolute;left:138.65px;top:248.48px" class="cls_016"><span class="cls_016">Garbage Collection in MRI,</span></div>
<div style="position:absolute;left:181.37px;top:266.48px" class="cls_016"><span class="cls_016">JRuby, and Rubinius</span></div>
<div style="position:absolute;left:123.00px;top:375.48px" class="cls_024"><span class="cls_024">Garbage collection (GC)</span><span class="cls_023"> is the process high-level languages</span></div>
<div style="position:absolute;left:123.00px;top:393.48px" class="cls_023"><span class="cls_023">like Ruby use to manage memory for you. Where do</span></div>
<div style="position:absolute;left:123.00px;top:411.49px" class="cls_023"><span class="cls_023">your Ruby objects live while you’re using them? How</span></div>
<div style="position:absolute;left:123.00px;top:429.49px" class="cls_023"><span class="cls_023">does Ruby clean up objects your program no longer</span></div>
<div style="position:absolute;left:123.00px;top:447.50px" class="cls_023"><span class="cls_023">uses? Ruby’s GC system solves these problems.</span></div>
<div style="position:absolute;left:141.00px;top:466.48px" class="cls_007"><span class="cls_007">Garbage collection is not unique to Ruby. The first implementation</span></div>
<div style="position:absolute;left:123.00px;top:478.48px" class="cls_007"><span class="cls_007">of garbage collection was in the Lisp programming language, invented by</span></div>
<div style="position:absolute;left:123.00px;top:490.48px" class="cls_007"><span class="cls_007">John McCarthy around 1960. Like Ruby, Lisp manages memory for you</span></div>
<div style="position:absolute;left:123.00px;top:502.48px" class="cls_007"><span class="cls_007">automatically using garbage collection. Since its invention, garbage collec-</span></div>
<div style="position:absolute;left:123.00px;top:514.48px" class="cls_007"><span class="cls_007">tion has been the subject of decades of computer science research and has</span></div>
<div style="position:absolute;left:123.00px;top:526.48px" class="cls_007"><span class="cls_007">become an important feature of numerous computer languages, including</span></div>
<div style="position:absolute;left:123.00px;top:538.48px" class="cls_007"><span class="cls_007">Java, C#, and, of course, Ruby.</span></div>
<div style="position:absolute;left:141.00px;top:550.48px" class="cls_007"><span class="cls_007">Computer scientists have invented many different algorithms for</span></div>
<div style="position:absolute;left:123.00px;top:562.48px" class="cls_007"><span class="cls_007">performing garbage collection. As it turns out, MRI uses the same GC</span></div>
<div style="position:absolute;left:123.00px;top:574.48px" class="cls_007"><span class="cls_007">algorithm John McCarthy invented over 50 years ago: </span><span class="cls_008">mark-and-sweep garbage</span></div>
<div style="position:absolute;left:123.00px;top:586.48px" class="cls_008"><span class="cls_008">collection</span><span class="cls_007">. JRuby and Rubinius, on the other hand, use a different algorithm,</span></div>
<div style="position:absolute;left:123.00px;top:598.48px" class="cls_007"><span class="cls_007">invented just a few years later in 1963: </span><span class="cls_008">copying garbage collection</span><span class="cls_007">. They also</span></div>
<div style="position:absolute;left:123.00px;top:610.48px" class="cls_007"><span class="cls_007">employ another innovation called </span><span class="cls_008">generational garbage collection</span><span class="cls_007"> and can even</span></div>
</div>
<div style="position:absolute;left:50%;margin-left:-252px;top:212264px;width:504px;height:666px;border-style:outset;overflow:hidden">
<div style="position:absolute;left:0px;top:0px">
<img src="e698b76e-46bd-11eb-8b25-0cc47a792c0a_id_e698b76e-46bd-11eb-8b25-0cc47a792c0a_files/background320.jpg" width=504 height=666></div>
<div style="position:absolute;left:120.00px;top:42.28px" class="cls_007"><span class="cls_007">perform GC tasks in a separate thread while your application continues to</span></div>
<div style="position:absolute;left:120.00px;top:54.28px" class="cls_007"><span class="cls_007">run using </span><span class="cls_008">concurrent garbage collection</span><span class="cls_007">. In this chapter we’ll touch on the</span></div>
<div style="position:absolute;left:120.00px;top:66.28px" class="cls_007"><span class="cls_007">basic ideas behind these complex GC algorithms. The MRI, JRuby, and</span></div>
<div style="position:absolute;left:120.00px;top:78.28px" class="cls_007"><span class="cls_007">Rubinius garbage collectors use more complex versions of these algorithms,</span></div>
<div style="position:absolute;left:120.00px;top:90.28px" class="cls_007"><span class="cls_007">but the same fundamental principles apply.</span></div>
<div style="position:absolute;left:261.47px;top:124.91px" class="cls_020"><span class="cls_020">Roadma p</span></div>
<div style="position:absolute;left:132.00px;top:141.91px" class="cls_017"><span class="cls_017">Garbage Collectors Solve Three Problems</span></div>
<div style="position:absolute;left:415.36px;top:141.91px" class="cls_017"><span class="cls_017">297</span></div>
<div style="position:absolute;left:132.00px;top:158.92px" class="cls_017"><span class="cls_017">Garbage Collection in MRI: Mark and Sweep</span></div>
<div style="position:absolute;left:415.36px;top:158.92px" class="cls_017"><span class="cls_017">297</span></div>
<div style="position:absolute;left:150.00px;top:175.92px" class="cls_017"><span class="cls_017">The Free List</span></div>
<div style="position:absolute;left:415.36px;top:175.92px" class="cls_017"><span class="cls_017">297</span></div>
<div style="position:absolute;left:150.00px;top:192.92px" class="cls_017"><span class="cls_017">MRI’s Use of Multiple Free Lists</span></div>
<div style="position:absolute;left:415.36px;top:192.92px" class="cls_017"><span class="cls_017">298</span></div>
<div style="position:absolute;left:150.00px;top:209.92px" class="cls_017"><span class="cls_017">Marking</span></div>
<div style="position:absolute;left:415.36px;top:209.92px" class="cls_017"><span class="cls_017">299</span></div>
<div style="position:absolute;left:150.00px;top:226.92px" class="cls_017"><span class="cls_017">How Does MRI Mark Live Objects?</span></div>
<div style="position:absolute;left:415.36px;top:226.92px" class="cls_017"><span class="cls_017">299</span></div>
<div style="position:absolute;left:150.00px;top:243.92px" class="cls_017"><span class="cls_017">Sweeping</span></div>
<div style="position:absolute;left:415.36px;top:243.92px" class="cls_017"><span class="cls_017">300</span></div>
<div style="position:absolute;left:150.00px;top:260.92px" class="cls_017"><span class="cls_017">Lazy Sweeping</span></div>
<div style="position:absolute;left:415.36px;top:260.92px" class="cls_017"><span class="cls_017">300</span></div>
<div style="position:absolute;left:150.00px;top:277.91px" class="cls_017"><span class="cls_017">The </span><span class="cls_030">RVALUE</span><span class="cls_017"> Structure</span></div>
<div style="position:absolute;left:415.37px;top:277.91px" class="cls_017"><span class="cls_017">301</span></div>
<div style="position:absolute;left:150.00px;top:294.91px" class="cls_017"><span class="cls_017">Disadvantages of Mark and Sweep</span></div>
<div style="position:absolute;left:415.37px;top:294.91px" class="cls_017"><span class="cls_017">302</span></div>
<div style="position:absolute;left:132.00px;top:311.92px" class="cls_019"><span class="cls_019">Experiment 12-1: Seeing MRI Garbage Collection in Action</span></div>
<div style="position:absolute;left:416.39px;top:311.92px" class="cls_019"><span class="cls_019">302</span></div>
<div style="position:absolute;left:150.00px;top:328.92px" class="cls_017"><span class="cls_017">Seeing MRI Perform a Lazy Sweep</span></div>
<div style="position:absolute;left:415.37px;top:328.92px" class="cls_017"><span class="cls_017">303</span></div>
<div style="position:absolute;left:150.00px;top:345.92px" class="cls_017"><span class="cls_017">Seeing MRI Perform a Full Collection</span></div>
<div style="position:absolute;left:415.37px;top:345.92px" class="cls_017"><span class="cls_017">304</span></div>
<div style="position:absolute;left:150.00px;top:362.92px" class="cls_017"><span class="cls_017">Interpreting a GC Profile Report</span></div>
<div style="position:absolute;left:415.37px;top:362.92px" class="cls_017"><span class="cls_017">305</span></div>
<div style="position:absolute;left:132.00px;top:379.92px" class="cls_017"><span class="cls_017">Garbage Collection in JRuby and Rubinius</span></div>
<div style="position:absolute;left:415.37px;top:379.92px" class="cls_017"><span class="cls_017">309</span></div>
<div style="position:absolute;left:132.00px;top:396.92px" class="cls_017"><span class="cls_017">Copying Garbage Collection</span></div>
<div style="position:absolute;left:415.37px;top:396.92px" class="cls_017"><span class="cls_017">309</span></div>
<div style="position:absolute;left:150.00px;top:413.92px" class="cls_017"><span class="cls_017">Bump Allocation</span></div>
<div style="position:absolute;left:415.37px;top:413.92px" class="cls_017"><span class="cls_017">310</span></div>
<div style="position:absolute;left:150.00px;top:430.92px" class="cls_017"><span class="cls_017">The Semi-Space Algorithm</span></div>
<div style="position:absolute;left:415.37px;top:430.92px" class="cls_017"><span class="cls_017">311</span></div>
<div style="position:absolute;left:150.00px;top:447.92px" class="cls_017"><span class="cls_017">The Eden Heap</span></div>
<div style="position:absolute;left:415.37px;top:447.92px" class="cls_017"><span class="cls_017">312</span></div>
<div style="position:absolute;left:132.00px;top:464.92px" class="cls_017"><span class="cls_017">Generational Garbage Collection</span></div>
<div style="position:absolute;left:415.37px;top:464.92px" class="cls_017"><span class="cls_017">313</span></div>
<div style="position:absolute;left:150.00px;top:481.93px" class="cls_017"><span class="cls_017">The Weak Generational Hypothesis</span></div>
<div style="position:absolute;left:415.37px;top:481.93px" class="cls_017"><span class="cls_017">313</span></div>
<div style="position:absolute;left:150.00px;top:498.93px" class="cls_017"><span class="cls_017">Using the Semi-Space Algorithm for Young Objects</span></div>
<div style="position:absolute;left:415.37px;top:498.93px" class="cls_017"><span class="cls_017">314</span></div>
<div style="position:absolute;left:150.00px;top:515.93px" class="cls_017"><span class="cls_017">Promoting Objects</span></div>
<div style="position:absolute;left:415.37px;top:515.93px" class="cls_017"><span class="cls_017">314</span></div>
<div style="position:absolute;left:150.00px;top:532.93px" class="cls_017"><span class="cls_017">Garbage Collection for Mature Objects</span></div>
<div style="position:absolute;left:415.37px;top:532.93px" class="cls_017"><span class="cls_017">315</span></div>
<div style="position:absolute;left:150.00px;top:549.93px" class="cls_017"><span class="cls_017">References Between Generations</span></div>
<div style="position:absolute;left:415.37px;top:549.93px" class="cls_017"><span class="cls_017">316</span></div>
<div style="position:absolute;left:132.00px;top:566.93px" class="cls_017"><span class="cls_017">Concurrent Garbage Collection</span></div>
<div style="position:absolute;left:415.37px;top:566.93px" class="cls_017"><span class="cls_017">317</span></div>
<div style="position:absolute;left:150.00px;top:583.93px" class="cls_017"><span class="cls_017">Marking While the Object Graph Changes</span></div>
<div style="position:absolute;left:415.37px;top:583.93px" class="cls_017"><span class="cls_017">317</span></div>
<div style="position:absolute;left:48.00px;top:633.00px" class="cls_020"><span class="cls_020">296</span></div>
<div style="position:absolute;left:74.55px;top:636.00px" class="cls_021"><span class="cls_021">Chapter 12</span></div>
</div>
<div style="position:absolute;left:50%;margin-left:-252px;top:212940px;width:504px;height:666px;border-style:outset;overflow:hidden">
<div style="position:absolute;left:0px;top:0px">
<img src="e698b76e-46bd-11eb-8b25-0cc47a792c0a_id_e698b76e-46bd-11eb-8b25-0cc47a792c0a_files/background321.jpg" width=504 height=666></div>
<div style="position:absolute;left:153.00px;top:55.05px" class="cls_017"><span class="cls_017">Tricolor Marking</span></div>
<div style="position:absolute;left:418.36px;top:55.05px" class="cls_017"><span class="cls_017">319</span></div>
<div style="position:absolute;left:153.00px;top:72.05px" class="cls_017"><span class="cls_017">Three Garbage Collectors in the JVM</span></div>
<div style="position:absolute;left:418.36px;top:72.05px" class="cls_017"><span class="cls_017">320</span></div>
<div style="position:absolute;left:135.00px;top:89.05px" class="cls_019"><span class="cls_019">Experiment 12-2: Using Verbose GC Mode in JRuby</span></div>
<div style="position:absolute;left:419.40px;top:89.05px" class="cls_019"><span class="cls_019">321</span></div>
<div style="position:absolute;left:153.01px;top:106.05px" class="cls_017"><span class="cls_017">Triggering Major Collections</span></div>
<div style="position:absolute;left:418.37px;top:106.05px" class="cls_017"><span class="cls_017">323</span></div>
<div style="position:absolute;left:135.01px;top:123.05px" class="cls_017"><span class="cls_017">Further Reading</span></div>
<div style="position:absolute;left:418.37px;top:123.05px" class="cls_017"><span class="cls_017">324</span></div>
<div style="position:absolute;left:135.01px;top:140.05px" class="cls_017"><span class="cls_017">Summary</span></div>
<div style="position:absolute;left:418.37px;top:140.05px" class="cls_017"><span class="cls_017">325</span></div>
<div style="position:absolute;left:69.00px;top:175.71px" class="cls_031"><span class="cls_031">Garbage Collectors Solve Three Problems</span></div>
<div style="position:absolute;left:123.00px;top:195.71px" class="cls_007"><span class="cls_007">Despite its name, garbage collection is not only the process of cleaning up</span></div>
<div style="position:absolute;left:123.00px;top:207.71px" class="cls_007"><span class="cls_007">garbage objects. Garbage collectors, in fact, solve three problems:</span></div>
<div style="position:absolute;left:123.00px;top:228.71px" class="cls_050"><span class="cls_050">•</span><span class="cls_007">   They </span><span class="cls_008">allocate</span><span class="cls_007"> memory for use by new objects.</span></div>
<div style="position:absolute;left:123.00px;top:243.71px" class="cls_050"><span class="cls_050">•</span><span class="cls_007">   They </span><span class="cls_008">identify</span><span class="cls_007"> which objects your program is no longer using.</span></div>
<div style="position:absolute;left:123.00px;top:258.71px" class="cls_050"><span class="cls_050">•</span><span class="cls_007">   They </span><span class="cls_008">reclaim</span><span class="cls_007"> memory from unused objects.</span></div>
<div style="position:absolute;left:141.00px;top:277.71px" class="cls_007"><span class="cls_007">Ruby’s GC system is no different. When you create a new Ruby object,</span></div>
<div style="position:absolute;left:123.00px;top:289.71px" class="cls_007"><span class="cls_007">the garbage collector allocates memory for that object. Later, Ruby’s gar-</span></div>
<div style="position:absolute;left:123.00px;top:301.71px" class="cls_007"><span class="cls_007">bage collector determines when your program has stopped using the object</span></div>
<div style="position:absolute;left:123.00px;top:313.71px" class="cls_007"><span class="cls_007">so it can reuse that memory to create new Ruby objects. Allocating memory</span></div>
<div style="position:absolute;left:123.00px;top:325.71px" class="cls_007"><span class="cls_007">and reclaiming memory are two sides of the same coin; it makes sense for</span></div>
<div style="position:absolute;left:123.00px;top:337.71px" class="cls_007"><span class="cls_007">Ruby’s garbage collector to perform both tasks.</span></div>
<div style="position:absolute;left:69.00px;top:365.71px" class="cls_031"><span class="cls_031">Garbage Collection in MRI: Mark and Sweep</span></div>
<div style="position:absolute;left:123.00px;top:385.71px" class="cls_007"><span class="cls_007">A great place to start learning about garbage collection is MRI’s relatively</span></div>
<div style="position:absolute;left:123.00px;top:397.71px" class="cls_007"><span class="cls_007">simple GC algorithm, which is similar to the one used by John McCarthy in</span></div>
<div style="position:absolute;left:123.00px;top:409.71px" class="cls_007"><span class="cls_007">1960 with his groundbreaking work on Lisp. Once we understand how the</span></div>
<div style="position:absolute;left:123.00px;top:421.71px" class="cls_007"><span class="cls_007">algorithm works, we’ll look at the more complex garbage collection in JRuby</span></div>
<div style="position:absolute;left:123.00px;top:433.71px" class="cls_007"><span class="cls_007">and Rubinius and explore how MRI is adopting some of their techniques.</span></div>
<div style="position:absolute;left:141.00px;top:445.71px" class="cls_007"><span class="cls_007">MRI’s </span><span class="cls_008">mark-and-sweep</span><span class="cls_007"> algorithm hands your program memory for new</span></div>
<div style="position:absolute;left:123.00px;top:457.71px" class="cls_007"><span class="cls_007">objects until the available memory, or </span><span class="cls_008">heap</span><span class="cls_007">, is exhausted, at which point MRI</span></div>
<div style="position:absolute;left:123.00px;top:469.71px" class="cls_007"><span class="cls_007">stops your program and </span><span class="cls_008">marks</span><span class="cls_007"> the objects that variables or other objects</span></div>
<div style="position:absolute;left:123.00px;top:481.71px" class="cls_007"><span class="cls_007">in your code still hold a reference to as </span><span class="cls_008">live objects</span><span class="cls_007">. Ruby then </span><span class="cls_008">sweeps</span><span class="cls_007"> up the</span></div>
<div style="position:absolute;left:123.01px;top:493.71px" class="cls_007"><span class="cls_007">remaining objects, called </span><span class="cls_008">garbage objects</span><span class="cls_007">, allowing their memory to be reused.</span></div>
<div style="position:absolute;left:123.01px;top:505.71px" class="cls_007"><span class="cls_007">Once this process is complete, Ruby allows your program to continue again.</span></div>
<div style="position:absolute;left:123.00px;top:530.71px" class="cls_055"><span class="cls_055">The Free List</span></div>
<div style="position:absolute;left:123.00px;top:548.71px" class="cls_007"><span class="cls_007">Standard MRI Ruby uses McCarthy’s original allocation solution, which is</span></div>
<div style="position:absolute;left:123.00px;top:560.71px" class="cls_007"><span class="cls_007">called the </span><span class="cls_008">free list</span><span class="cls_007">. Figure 12-1 shows what a free list looks like conceptually.</span></div>
<div style="position:absolute;left:123.00px;top:612.35px" class="cls_038"><span class="cls_038">Figure 12-1: A conceptual view of the free list inside MRI</span></div>
<div style="position:absolute;left:301.60px;top:636.00px" class="cls_021"><span class="cls_021">Garbage Collection in MRI, JRuby, and Rubinius</span></div>
<div style="position:absolute;left:442.54px;top:633.00px" class="cls_020"><span class="cls_020">297</span></div>
</div>
<div style="position:absolute;left:50%;margin-left:-252px;top:213616px;width:504px;height:666px;border-style:outset;overflow:hidden">
<div style="position:absolute;left:0px;top:0px">
<img src="e698b76e-46bd-11eb-8b25-0cc47a792c0a_id_e698b76e-46bd-11eb-8b25-0cc47a792c0a_files/background322.jpg" width=504 height=666></div>
<div style="position:absolute;left:138.00px;top:42.28px" class="cls_007"><span class="cls_007">Each white square in the diagram represents a small piece of memory</span></div>
<div style="position:absolute;left:120.00px;top:54.28px" class="cls_007"><span class="cls_007">that is available for creating new objects. Think of this diagram as a linked</span></div>
<div style="position:absolute;left:120.00px;top:66.28px" class="cls_007"><span class="cls_007">list of unused Ruby objects. When you create a new Ruby object, MRI pulls</span></div>
<div style="position:absolute;left:120.00px;top:78.28px" class="cls_007"><span class="cls_007">a free memory block from the head of the list and uses it to create a new</span></div>
<div style="position:absolute;left:120.00px;top:90.28px" class="cls_007"><span class="cls_007">Ruby object, as shown in Figure 12-2.</span></div>
<div style="position:absolute;left:120.00px;top:141.91px" class="cls_038"><span class="cls_038">Figure 12-2: Ruby has taken the first memory block from the free list and used it to create</span></div>
<div style="position:absolute;left:120.00px;top:152.41px" class="cls_038"><span class="cls_038">a new Ruby object.</span></div>
<div style="position:absolute;left:138.00px;top:174.91px" class="cls_007"><span class="cls_007">The gray box in this figure is an allocated, live object. The remaining</span></div>
<div style="position:absolute;left:120.00px;top:186.91px" class="cls_007"><span class="cls_007">white boxes are still available. Internally all Ruby objects are represented</span></div>
<div style="position:absolute;left:120.00px;top:198.91px" class="cls_007"><span class="cls_007">by a C structure called </span><span class="cls_030">RVALUE</span><span class="cls_007">. MRI uses a C </span><span class="cls_008">union</span><span class="cls_007"> inside </span><span class="cls_030">RVALUE</span><span class="cls_007"> to encom-</span></div>
<div style="position:absolute;left:120.00px;top:210.91px" class="cls_007"><span class="cls_007">pass all of the C structures we’ve seen so far in MRI, such as </span><span class="cls_030">RArray</span><span class="cls_007">, </span><span class="cls_030">RString</span><span class="cls_007">,</span></div>
<div style="position:absolute;left:120.00px;top:222.91px" class="cls_030"><span class="cls_030">RRegexp</span><span class="cls_007">, and so on. In other words, each square could be any kind of Ruby</span></div>
<div style="position:absolute;left:120.00px;top:234.91px" class="cls_007"><span class="cls_007">object or an instance of a custom Ruby class (via </span><span class="cls_030">RObject</span><span class="cls_007">). The contents of</span></div>
<div style="position:absolute;left:120.00px;top:246.91px" class="cls_007"><span class="cls_007">each object, such as the characters in a string, are often stored in a separate</span></div>
<div style="position:absolute;left:120.00px;top:258.91px" class="cls_007"><span class="cls_007">memory location.</span></div>
<div style="position:absolute;left:138.00px;top:270.91px" class="cls_007"><span class="cls_007">As your program starts to allocate more new objects, MRI takes more</span></div>
<div style="position:absolute;left:120.00px;top:282.91px" class="cls_007"><span class="cls_007">new </span><span class="cls_030">RVALUE</span><span class="cls_007"> structures from the free list, and the list of unused values</span></div>
<div style="position:absolute;left:120.00px;top:294.91px" class="cls_007"><span class="cls_007">shrinks, as shown in Figure 12-3.</span></div>
<div style="position:absolute;left:120.00px;top:346.55px" class="cls_038"><span class="cls_038">Figure 12-3: As your program creates more objects, MRI starts to use up the free list.</span></div>
<div style="position:absolute;left:190.18px;top:408.66px" class="cls_020"><span class="cls_020">MRI’s Use of Multiple Free Lists</span></div>
<div style="position:absolute;left:120.50px;top:427.16px" class="cls_039"><span class="cls_039">When MRI starts to execute a Ruby script, it allocates memory for use in the free list.</span></div>
<div style="position:absolute;left:120.50px;top:439.16px" class="cls_039"><span class="cls_039">It sets the length of the initial free list to about 10,000 </span><span class="cls_009">RVALUE</span><span class="cls_039"> structures, which means</span></div>
<div style="position:absolute;left:120.50px;top:451.16px" class="cls_039"><span class="cls_039">that MRI can create 10,000 Ruby objects without allocating more memory. As more</span></div>
<div style="position:absolute;left:120.50px;top:463.16px" class="cls_039"><span class="cls_039">objects are needed, MRI allocates more memory, placing more empty </span><span class="cls_009">RVALUE</span><span class="cls_039">s onto</span></div>
<div style="position:absolute;left:120.50px;top:475.16px" class="cls_039"><span class="cls_039">the free list.</span></div>
<div style="position:absolute;left:138.50px;top:487.16px" class="cls_039"><span class="cls_039">Rather than create a single, long linked list with 10,000 elements, Ruby divides</span></div>
<div style="position:absolute;left:120.50px;top:499.16px" class="cls_039"><span class="cls_039">the allocated memory into subsections known as </span><span class="cls_044">heaps</span><span class="cls_039"> in the MRI source code, each</span></div>
<div style="position:absolute;left:120.50px;top:511.16px" class="cls_039"><span class="cls_039">about 16k in size. It then creates a free list for each of these heaps, initially creating</span></div>
<div style="position:absolute;left:120.50px;top:523.16px" class="cls_039"><span class="cls_039">24 lists of 407 objects each, using some of the remaining memory for other internal</span></div>
<div style="position:absolute;left:120.50px;top:535.16px" class="cls_039"><span class="cls_039">data structures.</span></div>
<div style="position:absolute;left:138.50px;top:547.16px" class="cls_039"><span class="cls_039">Because there are multiple free lists, MRI repeatedly returns </span><span class="cls_009">RVALUE</span><span class="cls_039"> structures</span></div>
<div style="position:absolute;left:120.50px;top:559.16px" class="cls_039"><span class="cls_039">from one free list until it’s empty and then steps to another free list, returning more</span></div>
<div style="position:absolute;left:120.50px;top:571.16px" class="cls_039"><span class="cls_039">structures from that second list. In this way, MRI iterates over the available free lists</span></div>
<div style="position:absolute;left:120.50px;top:583.16px" class="cls_039"><span class="cls_039">until they are all empty.</span></div>
<div style="position:absolute;left:48.00px;top:633.00px" class="cls_020"><span class="cls_020">298</span></div>
<div style="position:absolute;left:74.55px;top:636.00px" class="cls_021"><span class="cls_021">Chapter 12</span></div>
</div>
<div style="position:absolute;left:50%;margin-left:-252px;top:214292px;width:504px;height:666px;border-style:outset;overflow:hidden">
<div style="position:absolute;left:0px;top:0px">
<img src="e698b76e-46bd-11eb-8b25-0cc47a792c0a_id_e698b76e-46bd-11eb-8b25-0cc47a792c0a_files/background323.jpg" width=504 height=666></div>
<div style="position:absolute;left:123.00px;top:42.05px" class="cls_055"><span class="cls_055">Marking</span></div>
<div style="position:absolute;left:123.00px;top:60.05px" class="cls_007"><span class="cls_007">As your program runs, it creates new objects, and eventually MRI uses up</span></div>
<div style="position:absolute;left:123.00px;top:72.05px" class="cls_007"><span class="cls_007">all remaining objects on the free list. At that point, the GC system stops</span></div>
<div style="position:absolute;left:123.00px;top:84.05px" class="cls_007"><span class="cls_007">your program, identifies objects that your code is no longer using, and</span></div>
<div style="position:absolute;left:123.00px;top:96.05px" class="cls_007"><span class="cls_007">reclaims their memory for allocation to new objects. If no unused objects</span></div>
<div style="position:absolute;left:123.00px;top:108.05px" class="cls_007"><span class="cls_007">are found, Ruby asks the operating system for more memory; if there is</span></div>
<div style="position:absolute;left:123.00px;top:120.05px" class="cls_007"><span class="cls_007">none to be had, Ruby throws an out-of-memory exception and stops.</span></div>
<div style="position:absolute;left:141.00px;top:132.05px" class="cls_007"><span class="cls_007">Objects that your program allo-</span></div>
<div style="position:absolute;left:123.00px;top:144.05px" class="cls_007"><span class="cls_007">cated but that are no longer being used</span></div>
<div style="position:absolute;left:123.00px;top:156.05px" class="cls_007"><span class="cls_007">are known as </span><span class="cls_008">garbage objects</span><span class="cls_007">. To identify</span></div>
<div style="position:absolute;left:123.00px;top:168.05px" class="cls_007"><span class="cls_007">garbage objects, MRI traverses point-</span></div>
<div style="position:absolute;left:123.00px;top:180.05px" class="cls_007"><span class="cls_007">ers in your objects’ C structures, fol-</span></div>
<div style="position:absolute;left:123.00px;top:192.05px" class="cls_007"><span class="cls_007">lowing references from one to another</span></div>
<div style="position:absolute;left:123.00px;top:204.05px" class="cls_007"><span class="cls_007">in order to find all active objects (see</span></div>
<div style="position:absolute;left:123.00px;top:216.05px" class="cls_007"><span class="cls_007">Figure 12-4). MRI knows your code is</span></div>
<div style="position:absolute;left:123.00px;top:228.05px" class="cls_007"><span class="cls_007">no longer using an object if it finds no</span></div>
<div style="position:absolute;left:123.00px;top:240.05px" class="cls_007"><span class="cls_007">references to them.</span></div>
<div style="position:absolute;left:141.00px;top:252.05px" class="cls_007"><span class="cls_007">The gray box on the left is a </span><span class="cls_008">root</span></div>
<div style="position:absolute;left:123.00px;top:264.05px" class="cls_008"><span class="cls_008">object</span><span class="cls_007">, a global variable that you create</span></div>
<div style="position:absolute;left:123.00px;top:276.05px" class="cls_007"><span class="cls_007">or an internal object that Ruby knows</span></div>
<div style="position:absolute;left:317.30px;top:279.15px" class="cls_038"><span class="cls_038">Figure 12-4: Ruby follows pointers,</span></div>
<div style="position:absolute;left:123.00px;top:288.05px" class="cls_007"><span class="cls_007">your application must be using. There</span></div>
<div style="position:absolute;left:317.30px;top:289.65px" class="cls_038"><span class="cls_038">or references, from one object to</span></div>
<div style="position:absolute;left:123.00px;top:300.05px" class="cls_007"><span class="cls_007">are typically many root objects at any</span></div>
<div style="position:absolute;left:317.30px;top:300.15px" class="cls_038"><span class="cls_038">another, starting with a root object</span></div>
<div style="position:absolute;left:317.30px;top:310.65px" class="cls_038"><span class="cls_038">on the left.</span></div>
<div style="position:absolute;left:123.00px;top:312.05px" class="cls_007"><span class="cls_007">given time. The arrows represent refer-</span></div>
<div style="position:absolute;left:123.00px;top:324.05px" class="cls_007"><span class="cls_007">ences from this root object to other</span></div>
<div style="position:absolute;left:123.00px;top:336.05px" class="cls_007"><span class="cls_007">objects, which in turn may contain ref-</span></div>
<div style="position:absolute;left:123.00px;top:348.05px" class="cls_007"><span class="cls_007">erences to other objects. This network</span></div>
<div style="position:absolute;left:441.72px;top:359.83px" class="cls_054"><span class="cls_054">M</span></div>
<div style="position:absolute;left:123.00px;top:360.05px" class="cls_007"><span class="cls_007">of objects and references is known</span></div>
<div style="position:absolute;left:123.00px;top:372.05px" class="cls_007"><span class="cls_007">as the </span><span class="cls_008">object graph</span><span class="cls_007">. MRI marks each</span></div>
<div style="position:absolute;left:391.14px;top:380.49px" class="cls_054"><span class="cls_054">M</span></div>
<div style="position:absolute;left:123.00px;top:384.05px" class="cls_007"><span class="cls_007">Ruby object that it finds as it traverses</span></div>
<div style="position:absolute;left:123.00px;top:396.05px" class="cls_007"><span class="cls_007">the object graph, stopping your pro-</span></div>
<div style="position:absolute;left:122.99px;top:408.05px" class="cls_007"><span class="cls_007">gram during the marking process in</span></div>
<div style="position:absolute;left:122.99px;top:420.05px" class="cls_007"><span class="cls_007">order to insure that no new object ref-</span></div>
<div style="position:absolute;left:324.41px;top:422.73px" class="cls_054"><span class="cls_054">M</span></div>
<div style="position:absolute;left:122.99px;top:432.05px" class="cls_007"><span class="cls_007">erences are created.</span></div>
<div style="position:absolute;left:140.99px;top:444.05px" class="cls_007"><span class="cls_007">Once the marking process com-</span></div>
<div style="position:absolute;left:122.99px;top:456.05px" class="cls_007"><span class="cls_007">pletes, the heap contains a series of</span></div>
<div style="position:absolute;left:122.99px;top:468.05px" class="cls_007"><span class="cls_007">objects, both marked and unmarked,</span></div>
<div style="position:absolute;left:122.99px;top:480.05px" class="cls_007"><span class="cls_007">as shown in Figure 12-5. The marked</span></div>
<div style="position:absolute;left:365.85px;top:489.66px" class="cls_054"><span class="cls_054">M</span></div>
<div style="position:absolute;left:416.43px;top:489.66px" class="cls_054"><span class="cls_054">M</span></div>
<div style="position:absolute;left:122.99px;top:492.05px" class="cls_007"><span class="cls_007">objects are </span><span class="cls_008">live</span><span class="cls_007">, which means your code</span></div>
<div style="position:absolute;left:122.99px;top:504.05px" class="cls_007"><span class="cls_007">is actively using them. The unmarked</span></div>
<div style="position:absolute;left:122.99px;top:516.05px" class="cls_007"><span class="cls_007">objects are garbage, meaning Ruby can</span></div>
<div style="position:absolute;left:122.99px;top:528.05px" class="cls_007"><span class="cls_007">release or reclaim their memory. Your</span></div>
<div style="position:absolute;left:317.30px;top:532.31px" class="cls_038"><span class="cls_038">Figure 12-5: MRI has marked five</span></div>
<div style="position:absolute;left:122.99px;top:540.05px" class="cls_007"><span class="cls_007">code is still using the marked objects, so</span></div>
<div style="position:absolute;left:317.30px;top:542.81px" class="cls_038"><span class="cls_038">active objects (gray) with five garbage</span></div>
<div style="position:absolute;left:122.99px;top:552.05px" class="cls_007"><span class="cls_007">their memory must be preserved.</span></div>
<div style="position:absolute;left:317.30px;top:553.31px" class="cls_038"><span class="cls_038">objects remaining in the heap (white).</span></div>
<div style="position:absolute;left:123.00px;top:577.05px" class="cls_055"><span class="cls_055">How Does MRI Mark Live Objects?</span></div>
<div style="position:absolute;left:123.00px;top:595.05px" class="cls_007"><span class="cls_007">MRI saves the information about marked and unmarked objects using a</span></div>
<div style="position:absolute;left:123.00px;top:607.05px" class="cls_007"><span class="cls_007">technique known as </span><span class="cls_008">bitmap marking</span><span class="cls_007">. Bitmap marking refers to the technique</span></div>
<div style="position:absolute;left:301.39px;top:636.00px" class="cls_021"><span class="cls_021">Garbage Collection in MRI, JRuby, and Rubinius</span></div>
<div style="position:absolute;left:442.33px;top:633.00px" class="cls_020"><span class="cls_020">299</span></div>
</div>
<div style="position:absolute;left:50%;margin-left:-252px;top:214968px;width:504px;height:666px;border-style:outset;overflow:hidden">
<div style="position:absolute;left:0px;top:0px">
<img src="e698b76e-46bd-11eb-8b25-0cc47a792c0a_id_e698b76e-46bd-11eb-8b25-0cc47a792c0a_files/background324.jpg" width=504 height=666></div>
<div style="position:absolute;left:120.00px;top:42.28px" class="cls_007"><span class="cls_007">of saving the live object marks as a series of bits in a data structure known</span></div>
<div style="position:absolute;left:120.00px;top:54.28px" class="cls_007"><span class="cls_007">as the </span><span class="cls_008">free bitmap</span><span class="cls_007"> (see Figure 12-6). MRI uses a separate memory structure</span></div>
<div style="position:absolute;left:120.00px;top:66.28px" class="cls_007"><span class="cls_007">to hold the free bitmap and doesn’t save the marks near the objects.</span></div>
<div style="position:absolute;left:127.34px;top:91.17px" class="cls_213"><span class="cls_213">0</span></div>
<div style="position:absolute;left:144.14px;top:91.17px" class="cls_213"><span class="cls_213">1</span></div>
<div style="position:absolute;left:160.94px;top:91.17px" class="cls_213"><span class="cls_213">0</span></div>
<div style="position:absolute;left:177.74px;top:91.17px" class="cls_213"><span class="cls_213">1</span></div>
<div style="position:absolute;left:194.54px;top:91.17px" class="cls_213"><span class="cls_213">1</span></div>
<div style="position:absolute;left:211.34px;top:91.17px" class="cls_213"><span class="cls_213">0</span></div>
<div style="position:absolute;left:228.14px;top:91.17px" class="cls_213"><span class="cls_213">0</span></div>
<div style="position:absolute;left:244.94px;top:91.17px" class="cls_213"><span class="cls_213">1</span></div>
<div style="position:absolute;left:235.01px;top:113.09px" class="cls_054"><span class="cls_054">etc...</span></div>
<div style="position:absolute;left:120.00px;top:155.71px" class="cls_038"><span class="cls_038">Figure 12-6: MRI saves the GC mark flags in a separate data structure known as the</span></div>
<div style="position:absolute;left:120.00px;top:166.21px" class="cls_039"><span class="cls_039">free bitmap</span><span class="cls_038">.</span></div>
<div style="position:absolute;left:138.00px;top:188.71px" class="cls_007"><span class="cls_007">The reason to use a separate memory structure for the mark bits has</span></div>
<div style="position:absolute;left:120.00px;top:200.71px" class="cls_007"><span class="cls_007">to do with a Unix memory optimization technique called </span><span class="cls_008">copy-on-write</span><span class="cls_007"> (see</span></div>
<div style="position:absolute;left:120.00px;top:212.71px" class="cls_007"><span class="cls_007">page 265). Similar to how Ruby shares memory between different strings</span></div>
<div style="position:absolute;left:120.00px;top:224.71px" class="cls_007"><span class="cls_007">that contain the same letters, copy-on-write allows Unix processes to share</span></div>
<div style="position:absolute;left:120.00px;top:236.71px" class="cls_007"><span class="cls_007">memory that contains the same values. By saving the mark bits separately,</span></div>
<div style="position:absolute;left:120.00px;top:248.71px" class="cls_007"><span class="cls_007">MRI maximizes the amount of memory that will contain the same values</span></div>
<div style="position:absolute;left:120.00px;top:260.71px" class="cls_007"><span class="cls_007">across processes. (In Ruby 1.9 and earlier, the mark bits were saved inside</span></div>
<div style="position:absolute;left:120.00px;top:272.71px" class="cls_007"><span class="cls_007">each </span><span class="cls_030">RVALUE</span><span class="cls_007"> structure, causing the garbage collector to modify almost all of</span></div>
<div style="position:absolute;left:120.00px;top:284.71px" class="cls_007"><span class="cls_007">Ruby’s shared memory while marking live objects and rendering the copy-</span></div>
<div style="position:absolute;left:120.00px;top:296.71px" class="cls_007"><span class="cls_007">on-write optimization ineffective.)</span></div>
<div style="position:absolute;left:120.00px;top:321.71px" class="cls_055"><span class="cls_055">Sweeping</span></div>
<div style="position:absolute;left:120.00px;top:339.71px" class="cls_007"><span class="cls_007">Having identified garbage objects, it’s time to reclaim them. Ruby’s GC</span></div>
<div style="position:absolute;left:120.00px;top:351.71px" class="cls_007"><span class="cls_007">algorithm places the unmarked objects back on the free list, as shown in</span></div>
<div style="position:absolute;left:120.00px;top:363.71px" class="cls_007"><span class="cls_007">Figure 12-7.</span></div>
<div style="position:absolute;left:120.00px;top:462.50px" class="cls_038"><span class="cls_038">Figure 12-7: While sweeping, MRI places unused </span><span class="cls_014">RVALUE</span><span class="cls_038"> structures back on the free list.</span></div>
<div style="position:absolute;left:138.00px;top:485.00px" class="cls_007"><span class="cls_007">The process of moving unused objects back onto the free list is referred</span></div>
<div style="position:absolute;left:120.00px;top:497.00px" class="cls_007"><span class="cls_007">to as </span><span class="cls_008">sweeping</span><span class="cls_007"> the objects. Normally this process runs very quickly because</span></div>
<div style="position:absolute;left:120.00px;top:509.00px" class="cls_007"><span class="cls_007">MRI doesn’t actually copy objects; it simply adjusts the pointers in each</span></div>
<div style="position:absolute;left:120.00px;top:521.00px" class="cls_030"><span class="cls_030">RVALUE</span><span class="cls_007"> to create the free linked list (the solid arrows in Figure 12-7).</span></div>
<div style="position:absolute;left:120.00px;top:546.00px" class="cls_055"><span class="cls_055">Lazy Sweeping</span></div>
<div style="position:absolute;left:120.00px;top:564.00px" class="cls_007"><span class="cls_007">Beginning with version 1.9.3, MRI introduced an optimization known as</span></div>
<div style="position:absolute;left:120.00px;top:576.00px" class="cls_008"><span class="cls_008">lazy sweeping</span><span class="cls_007">. The lazy sweep algorithm reduces the amount of time a pro-</span></div>
<div style="position:absolute;left:120.00px;top:588.00px" class="cls_007"><span class="cls_007">gram is stopped by the garbage collector. (Remember, during the normal</span></div>
<div style="position:absolute;left:120.00px;top:600.00px" class="cls_007"><span class="cls_007">mark and sweep, MRI stops executing your code.)</span></div>
<div style="position:absolute;left:48.00px;top:633.00px" class="cls_020"><span class="cls_020">300</span></div>
<div style="position:absolute;left:74.71px;top:636.00px" class="cls_021"><span class="cls_021">Chapter 12</span></div>
</div>
<div style="position:absolute;left:50%;margin-left:-252px;top:215644px;width:504px;height:666px;border-style:outset;overflow:hidden">
<div style="position:absolute;left:0px;top:0px">
<img src="e698b76e-46bd-11eb-8b25-0cc47a792c0a_id_e698b76e-46bd-11eb-8b25-0cc47a792c0a_files/background325.jpg" width=504 height=666></div>
<div style="position:absolute;left:141.00px;top:41.60px" class="cls_007"><span class="cls_007">Lazy sweeping sweeps only enough garbage objects back to the free</span></div>
<div style="position:absolute;left:123.00px;top:53.60px" class="cls_007"><span class="cls_007">list to create a few new Ruby objects and to allow your program to con-</span></div>
<div style="position:absolute;left:123.00px;top:65.60px" class="cls_007"><span class="cls_007">tinue, thus reducing the amount of time required to sweep. Ruby sweeps</span></div>
<div style="position:absolute;left:123.00px;top:77.60px" class="cls_007"><span class="cls_007">all of the garbage </span><span class="cls_030">RVALUE</span><span class="cls_007"> objects found in only one of MRI’s internal heap</span></div>
<div style="position:absolute;left:123.00px;top:89.60px" class="cls_007"><span class="cls_007">structures back to that heap’s free list. If no garbage objects are found in</span></div>
<div style="position:absolute;left:123.00px;top:101.60px" class="cls_007"><span class="cls_007">the current heap, Ruby tries a lazy sweep on the next heap and works its</span></div>
<div style="position:absolute;left:123.00px;top:113.60px" class="cls_007"><span class="cls_007">way through the remaining heaps. (We’ll see this algorithm at work in</span></div>
<div style="position:absolute;left:123.00px;top:125.60px" class="cls_007"><span class="cls_007">Experiment 12-1.)</span></div>
<div style="position:absolute;left:141.00px;top:137.60px" class="cls_007"><span class="cls_007">Lazy sweeping can reduce the amount of time your program is paused</span></div>
<div style="position:absolute;left:123.00px;top:149.60px" class="cls_007"><span class="cls_007">waiting for garbage collection; however, it doesn’t reduce the overall amount</span></div>
<div style="position:absolute;left:123.00px;top:161.60px" class="cls_007"><span class="cls_007">of garbage collection work to do. Lazy sweeping amortizes the same total</span></div>
<div style="position:absolute;left:123.00px;top:173.60px" class="cls_007"><span class="cls_007">amount of sweeping work over multiple GC pauses.</span></div>
<div style="position:absolute;left:220.30px;top:232.31px" class="cls_020"><span class="cls_020">The RVALUE Structure</span></div>
<div style="position:absolute;left:123.50px;top:250.81px" class="cls_039"><span class="cls_039">You can find the definition of the </span><span class="cls_009">RVALUE</span><span class="cls_039"> C structure in the </span><span class="cls_044">gc.c</span><span class="cls_039"> MRI source code file,</span></div>
<div style="position:absolute;left:123.50px;top:262.82px" class="cls_039"><span class="cls_039">which contains the implementation of MRI’s garbage collector. Listing 12-1 shows</span></div>
<div style="position:absolute;left:123.50px;top:274.81px" class="cls_039"><span class="cls_039">part of the </span><span class="cls_009">RVALUE</span><span class="cls_039"> definition.</span></div>
<div style="position:absolute;left:123.50px;top:297.31px" class="cls_009"><span class="cls_009">typedef struct RVALUE {</span></div>
<div style="position:absolute;left:113.00px;top:306.82px" class="cls_045"><span class="cls_045">u</span><span class="cls_009">   union {</span></div>
<div style="position:absolute;left:113.00px;top:316.32px" class="cls_045"><span class="cls_045">v</span><span class="cls_009">     struct {</span></div>
<div style="position:absolute;left:146.00px;top:325.82px" class="cls_009"><span class="cls_009">VALUE flags;</span></div>
<div style="position:absolute;left:221.00px;top:325.82px" class="cls_009"><span class="cls_009">/* always 0 for freed obj */</span></div>
<div style="position:absolute;left:146.00px;top:335.32px" class="cls_009"><span class="cls_009">struct RVALUE *next;</span></div>
<div style="position:absolute;left:138.50px;top:344.83px" class="cls_009"><span class="cls_009">} free;</span></div>
<div style="position:absolute;left:113.00px;top:354.33px" class="cls_045"><span class="cls_045">w</span><span class="cls_009">     struct RBasic  basic;</span></div>
<div style="position:absolute;left:138.50px;top:363.83px" class="cls_009"><span class="cls_009">struct RObject object;</span></div>
<div style="position:absolute;left:138.50px;top:373.33px" class="cls_009"><span class="cls_009">struct RClass  klass;</span></div>
<div style="position:absolute;left:138.50px;top:382.84px" class="cls_009"><span class="cls_009">struct RFloat  flonum;</span></div>
<div style="position:absolute;left:138.50px;top:392.34px" class="cls_009"><span class="cls_009">struct RString string;</span></div>
<div style="position:absolute;left:138.50px;top:401.84px" class="cls_009"><span class="cls_009">struct RArray  array;</span></div>
<div style="position:absolute;left:138.50px;top:411.34px" class="cls_009"><span class="cls_009">struct RRegexp regexp;</span></div>
<div style="position:absolute;left:123.50px;top:430.34px" class="cls_009"><span class="cls_009">--snip--</span></div>
<div style="position:absolute;left:138.50px;top:449.34px" class="cls_009"><span class="cls_009">} as;</span></div>
<div style="position:absolute;left:123.50px;top:458.84px" class="cls_009"><span class="cls_009">#ifdef GC_DEBUG</span></div>
<div style="position:absolute;left:138.50px;top:468.34px" class="cls_009"><span class="cls_009">const char *file;</span></div>
<div style="position:absolute;left:138.50px;top:477.85px" class="cls_009"><span class="cls_009">int   line;</span></div>
<div style="position:absolute;left:123.50px;top:487.35px" class="cls_009"><span class="cls_009">#endif</span></div>
<div style="position:absolute;left:123.50px;top:496.85px" class="cls_009"><span class="cls_009">} RVALUE;</span></div>
<div style="position:absolute;left:123.50px;top:519.31px" class="cls_043"><span class="cls_043">Listing 12-1: Part of the </span><span class="cls_015">RVALUE</span><span class="cls_043"> definition from </span><span class="cls_065">gc.c</span></div>
<div style="position:absolute;left:141.50px;top:542.31px" class="cls_039"><span class="cls_039">Notice at </span><span class="cls_046">u</span><span class="cls_039"> that </span><span class="cls_009">RVALUE</span><span class="cls_039"> uses a union to hold one of many different types of</span></div>
<div style="position:absolute;left:123.50px;top:554.31px" class="cls_039"><span class="cls_039">values internally. The first possible value is the </span><span class="cls_009">free</span><span class="cls_039"> structure, defined at </span><span class="cls_046">v</span><span class="cls_039">, which</span></div>
<div style="position:absolute;left:123.50px;top:566.31px" class="cls_039"><span class="cls_039">represents </span><span class="cls_009">RVALUE</span><span class="cls_039">s still on the free list. MRI includes every other possible type of</span></div>
<div style="position:absolute;left:123.50px;top:578.31px" class="cls_039"><span class="cls_039">Ruby object in the union starting at </span><span class="cls_046">w</span><span class="cls_039">: </span><span class="cls_009">RObject</span><span class="cls_039">, </span><span class="cls_009">RString</span><span class="cls_039">, and so forth.</span></div>
<div style="position:absolute;left:301.81px;top:636.00px" class="cls_021"><span class="cls_021">Garbage Collection in MRI, JRuby, and Rubinius</span></div>
<div style="position:absolute;left:442.76px;top:633.00px" class="cls_020"><span class="cls_020">301</span></div>
</div>
<div style="position:absolute;left:50%;margin-left:-252px;top:216320px;width:504px;height:666px;border-style:outset;overflow:hidden">
<div style="position:absolute;left:0px;top:0px">
<img src="e698b76e-46bd-11eb-8b25-0cc47a792c0a_id_e698b76e-46bd-11eb-8b25-0cc47a792c0a_files/background326.jpg" width=504 height=666></div>
<div style="position:absolute;left:120.00px;top:42.55px" class="cls_055"><span class="cls_055">Disadvantages of Mark and Sweep</span></div>
<div style="position:absolute;left:120.00px;top:60.55px" class="cls_007"><span class="cls_007">The chief disadvantage of mark and sweep is that it requires your program</span></div>
<div style="position:absolute;left:120.00px;top:72.55px" class="cls_007"><span class="cls_007">to stop and wait while the marking and sweeping processes take place.</span></div>
<div style="position:absolute;left:120.00px;top:84.55px" class="cls_007"><span class="cls_007">Beginning with version 1.9.3, however, MRI’s lazy sweeping technique</span></div>
<div style="position:absolute;left:120.00px;top:96.55px" class="cls_007"><span class="cls_007">shortens the GC pauses somewhat.</span></div>
<div style="position:absolute;left:138.00px;top:108.55px" class="cls_007"><span class="cls_007">Another disadvantage is that the time required to perform a mark-</span></div>
<div style="position:absolute;left:120.00px;top:120.55px" class="cls_007"><span class="cls_007">and-sweep garbage collection is proportional to the total size of the heap.</span></div>
<div style="position:absolute;left:120.00px;top:132.55px" class="cls_007"><span class="cls_007">During the marking phase, Ruby needs to visit every active object in your</span></div>
<div style="position:absolute;left:120.00px;top:144.55px" class="cls_007"><span class="cls_007">program. During the sweeping phase, Ruby needs to iterate over all of the</span></div>
<div style="position:absolute;left:120.00px;top:156.55px" class="cls_007"><span class="cls_007">unused garbage objects left in the heap. As the number of objects created</span></div>
<div style="position:absolute;left:120.00px;top:168.55px" class="cls_007"><span class="cls_007">by your program and the total heap size grows, both tasks become more</span></div>
<div style="position:absolute;left:120.00px;top:180.55px" class="cls_007"><span class="cls_007">time intensive.</span></div>
<div style="position:absolute;left:138.00px;top:192.55px" class="cls_007"><span class="cls_007">The final issue with mark and sweep is that all of the free list elements—</span></div>
<div style="position:absolute;left:120.00px;top:204.55px" class="cls_007"><span class="cls_007">all of the unused objects available for your program to use—must be the</span></div>
<div style="position:absolute;left:120.00px;top:216.55px" class="cls_007"><span class="cls_007">same size. MRI doesn’t know ahead of time when you allocate a new object</span></div>
<div style="position:absolute;left:120.00px;top:228.55px" class="cls_007"><span class="cls_007">whether it will be a string, an array, or a simple number. This is why the</span></div>
<div style="position:absolute;left:120.00px;top:240.55px" class="cls_030"><span class="cls_030">RVALUE</span><span class="cls_007"> structure MRI uses in the free list must encompass any possible type</span></div>
<div style="position:absolute;left:120.00px;top:252.55px" class="cls_007"><span class="cls_007">of Ruby object.</span></div>
<div style="position:absolute;left:120.00px;top:286.55px" class="cls_031"><span class="cls_031">Experiment 12-1: Seeing MRI Garbage Collection</span></div>
<div style="position:absolute;left:120.00px;top:301.55px" class="cls_031"><span class="cls_031">in Action</span></div>
<div style="position:absolute;left:120.00px;top:321.55px" class="cls_007"><span class="cls_007">You’ve learned how the MRI GC algorithm works at a theoretical level.</span></div>
<div style="position:absolute;left:120.00px;top:333.55px" class="cls_007"><span class="cls_007">Let’s switch gears now to see how MRI performs actual garbage collection.</span></div>
<div style="position:absolute;left:120.00px;top:345.55px" class="cls_007"><span class="cls_007">The script in Listing 12-2 creates 10 Ruby objects.</span></div>
<div style="position:absolute;left:120.00px;top:369.55px" class="cls_030"><span class="cls_030">10.times do</span></div>
<div style="position:absolute;left:128.50px;top:380.04px" class="cls_030"><span class="cls_030">obj = Object.new</span></div>
<div style="position:absolute;left:120.00px;top:390.54px" class="cls_030"><span class="cls_030">end</span></div>
<div style="position:absolute;left:120.00px;top:413.04px" class="cls_038"><span class="cls_038">Listing 12-2: Creating 10 Ruby objects using </span><span class="cls_014">Object.new</span></div>
<div style="position:absolute;left:138.00px;top:435.55px" class="cls_007"><span class="cls_007">If it’s true that MRI assigns unused space from the free list to new objects,</span></div>
<div style="position:absolute;left:120.00px;top:447.55px" class="cls_007"><span class="cls_007">Ruby should remove 10 </span><span class="cls_030">RVALUE</span><span class="cls_007"> structures from the free list and assign them</span></div>
<div style="position:absolute;left:120.00px;top:459.55px" class="cls_007"><span class="cls_007">to these 10 new objects when we run Listing 12-2. To see this in action, we</span></div>
<div style="position:absolute;left:120.00px;top:471.55px" class="cls_007"><span class="cls_007">use the </span><span class="cls_030">ObjectSpace#count_objects</span><span class="cls_007"> method, as shown in Listing 12-3.</span></div>
<div style="position:absolute;left:120.00px;top:495.55px" class="cls_030"><span class="cls_030">def display_count</span></div>
<div style="position:absolute;left:108.15px;top:506.04px" class="cls_046"><span class="cls_046">u</span><span class="cls_030">   data = ObjectSpace.count_objects</span></div>
<div style="position:absolute;left:108.15px;top:516.54px" class="cls_046"><span class="cls_046">v</span><span class="cls_030">   puts "Total: #{data[:TOTAL]} Free: #{data[:FREE]} Object: #{data[:T_OBJECT]}"</span></div>
<div style="position:absolute;left:120.01px;top:527.04px" class="cls_030"><span class="cls_030">end</span></div>
<div style="position:absolute;left:120.01px;top:548.04px" class="cls_030"><span class="cls_030">10.times do</span></div>
<div style="position:absolute;left:128.51px;top:558.54px" class="cls_030"><span class="cls_030">obj = Object.new</span></div>
<div style="position:absolute;left:108.16px;top:569.04px" class="cls_046"><span class="cls_046">w</span><span class="cls_030">   display_count</span></div>
<div style="position:absolute;left:120.01px;top:579.53px" class="cls_030"><span class="cls_030">end</span></div>
<div style="position:absolute;left:120.01px;top:602.03px" class="cls_038"><span class="cls_038">Listing 12-3: Using </span><span class="cls_014">ObjectSpace#count_objects</span><span class="cls_038"> to display information about MRI’s heap</span></div>
<div style="position:absolute;left:48.00px;top:633.00px" class="cls_020"><span class="cls_020">302</span></div>
<div style="position:absolute;left:74.58px;top:636.00px" class="cls_021"><span class="cls_021">Chapter 12</span></div>
</div>
<div style="position:absolute;left:50%;margin-left:-252px;top:216996px;width:504px;height:666px;border-style:outset;overflow:hidden">
<div style="position:absolute;left:0px;top:0px">
<img src="e698b76e-46bd-11eb-8b25-0cc47a792c0a_id_e698b76e-46bd-11eb-8b25-0cc47a792c0a_files/background327.jpg" width=504 height=666></div>
<div style="position:absolute;left:141.00px;top:42.23px" class="cls_007"><span class="cls_007">Now we call </span><span class="cls_030">display_count</span><span class="cls_007"> at </span><span class="cls_050">w</span><span class="cls_007"> each time around the loop. </span><span class="cls_030">display_count</span></div>
<div style="position:absolute;left:123.00px;top:54.23px" class="cls_007"><span class="cls_007">uses </span><span class="cls_030">ObjectSpace#count_objects</span><span class="cls_007"> at </span><span class="cls_050">u</span><span class="cls_007"> to display information at </span><span class="cls_050">v</span><span class="cls_007"> about the</span></div>
<div style="position:absolute;left:123.00px;top:66.23px" class="cls_007"><span class="cls_007">total number of objects, the number of free objects, and the number of</span></div>
<div style="position:absolute;left:123.00px;top:78.23px" class="cls_030"><span class="cls_030">RObject</span><span class="cls_007"> structures active each time around the loop.</span></div>
<div style="position:absolute;left:141.00px;top:90.23px" class="cls_007"><span class="cls_007">Running Listing 12-3 gives the output shown in Listing 12-4.</span></div>
<div style="position:absolute;left:123.00px;top:114.23px" class="cls_030"><span class="cls_030">Total: 17491 Free: 171 Object: 85</span></div>
<div style="position:absolute;left:123.00px;top:124.72px" class="cls_030"><span class="cls_030">Total: 17491 Free: 139 Object: 86</span></div>
<div style="position:absolute;left:123.00px;top:135.22px" class="cls_030"><span class="cls_030">Total: 17491 Free: 132 Object: 87</span></div>
<div style="position:absolute;left:123.00px;top:145.72px" class="cls_030"><span class="cls_030">Total: 17491 Free: 125 Object: 88</span></div>
<div style="position:absolute;left:123.00px;top:156.22px" class="cls_030"><span class="cls_030">Total: 17491 Free: 118 Object: 89</span></div>
<div style="position:absolute;left:123.00px;top:166.71px" class="cls_030"><span class="cls_030">Total: 17491 Free: 111 Object: 90</span></div>
<div style="position:absolute;left:123.00px;top:177.21px" class="cls_030"><span class="cls_030">Total: 17491 Free: 104 Object: 91</span></div>
<div style="position:absolute;left:123.00px;top:187.71px" class="cls_030"><span class="cls_030">Total: 17491 Free: 97 Object: 92</span></div>
<div style="position:absolute;left:123.00px;top:198.21px" class="cls_030"><span class="cls_030">Total: 17491 Free: 90 Object: 93</span></div>
<div style="position:absolute;left:123.00px;top:208.70px" class="cls_030"><span class="cls_030">Total: 17491 Free: 83 Object: 94</span></div>
<div style="position:absolute;left:123.00px;top:231.20px" class="cls_038"><span class="cls_038">Listing 12-4: The output produced by Listing 12-3</span></div>
<div style="position:absolute;left:141.00px;top:253.73px" class="cls_007"><span class="cls_007">The </span><span class="cls_030">Total:</span><span class="cls_007"> field displays the value that MRI returns for </span><span class="cls_030">ObjectSpace</span></div>
<div style="position:absolute;left:123.00px;top:265.73px" class="cls_030"><span class="cls_030">.count_objects[:TOTAL]</span><span class="cls_007">. This value (17491) is the total number of objects</span></div>
<div style="position:absolute;left:123.00px;top:277.73px" class="cls_007"><span class="cls_007">currently active inside Ruby. It includes objects we create; objects Ruby</span></div>
<div style="position:absolute;left:123.00px;top:289.73px" class="cls_007"><span class="cls_007">creates internally while parsing, compiling, and executing our program;</span></div>
<div style="position:absolute;left:123.00px;top:301.73px" class="cls_007"><span class="cls_007">and objects on the free list. This number does not change when we create</span></div>
<div style="position:absolute;left:123.00px;top:313.73px" class="cls_007"><span class="cls_007">new objects because it already includes the entire free list.</span></div>
<div style="position:absolute;left:141.00px;top:325.73px" class="cls_007"><span class="cls_007">The </span><span class="cls_030">Free:</span><span class="cls_007"> field displays the value returned by </span><span class="cls_030">ObjectSpace.count_</span></div>
<div style="position:absolute;left:123.00px;top:337.73px" class="cls_030"><span class="cls_030">objects[:FREE]</span><span class="cls_007"> for the length of the free list. Notice that the value drops by</span></div>
<div style="position:absolute;left:123.00px;top:349.73px" class="cls_007"><span class="cls_007">about 7 each time around the loop. We create only one object per iteration,</span></div>
<div style="position:absolute;left:123.00px;top:361.73px" class="cls_007"><span class="cls_007">but Ruby creates 6 other objects each time around the loop while running</span></div>
<div style="position:absolute;left:123.00px;top:373.73px" class="cls_007"><span class="cls_007">the code in the </span><span class="cls_030">display_count</span><span class="cls_007"> method.</span></div>
<div style="position:absolute;left:141.00px;top:385.73px" class="cls_007"><span class="cls_007">The </span><span class="cls_030">Object:</span><span class="cls_007"> field displays the count of </span><span class="cls_030">RObject</span><span class="cls_007"> structures currently active</span></div>
<div style="position:absolute;left:123.00px;top:397.73px" class="cls_007"><span class="cls_007">in Ruby. Notice that this value increases by 1 each time around the loop,</span></div>
<div style="position:absolute;left:123.00px;top:409.73px" class="cls_007"><span class="cls_007">even though we don’t keep an active reference to the new objects. That is,</span></div>
<div style="position:absolute;left:123.00px;top:421.73px" class="cls_007"><span class="cls_007">we don’t save the value returned by </span><span class="cls_030">Object.new</span><span class="cls_007"> anywhere. The </span><span class="cls_030">RObject</span><span class="cls_007"> count</span></div>
<div style="position:absolute;left:123.00px;top:433.73px" class="cls_007"><span class="cls_007">includes active and garbage objects.</span></div>
<div style="position:absolute;left:123.00px;top:458.73px" class="cls_055"><span class="cls_055">Seeing MRI Perform a Lazy Sweep</span></div>
<div style="position:absolute;left:123.00px;top:476.73px" class="cls_007"><span class="cls_007">Now if we increase the number of iterations from 10 to 30 and rerun</span></div>
<div style="position:absolute;left:123.00px;top:488.73px" class="cls_007"><span class="cls_007">Listing 12-3, we see the following output in Listing 12-5.</span></div>
<div style="position:absolute;left:123.00px;top:512.73px" class="cls_030"><span class="cls_030">Total: 17493 Free: 166 Object: 85</span></div>
<div style="position:absolute;left:123.00px;top:523.22px" class="cls_030"><span class="cls_030">Total: 17493 Free: 134 Object: 86</span></div>
<div style="position:absolute;left:123.00px;top:533.72px" class="cls_030"><span class="cls_030">Total: 17493 Free: 127 Object: 87</span></div>
<div style="position:absolute;left:123.00px;top:544.22px" class="cls_030"><span class="cls_030">Total: 17493 Free: 120 Object: 88</span></div>
<div style="position:absolute;left:123.00px;top:565.22px" class="cls_030"><span class="cls_030">--snip--</span></div>
<div style="position:absolute;left:123.00px;top:586.23px" class="cls_030"><span class="cls_030">Total: 17493 Free: 29 Object: 101</span></div>
<div style="position:absolute;left:123.00px;top:596.72px" class="cls_030"><span class="cls_030">Total: 17493 Free: 22 Object: 102</span></div>
<div style="position:absolute;left:123.00px;top:607.22px" class="cls_030"><span class="cls_030">Total: 17493 Free: 15 Object: 103</span></div>
<div style="position:absolute;left:301.42px;top:636.00px" class="cls_021"><span class="cls_021">Garbage Collection in MRI, JRuby, and Rubinius</span></div>
<div style="position:absolute;left:442.36px;top:633.00px" class="cls_020"><span class="cls_020">303</span></div>
</div>
<div style="position:absolute;left:50%;margin-left:-252px;top:217672px;width:504px;height:666px;border-style:outset;overflow:hidden">
<div style="position:absolute;left:0px;top:0px">
<img src="e698b76e-46bd-11eb-8b25-0cc47a792c0a_id_e698b76e-46bd-11eb-8b25-0cc47a792c0a_files/background328.jpg" width=504 height=666></div>
<div style="position:absolute;left:108.15px;top:43.05px" class="cls_046"><span class="cls_046">u</span><span class="cls_030"> Total: 17493 Free: 8 Object: 104</span></div>
<div style="position:absolute;left:108.15px;top:53.55px" class="cls_046"><span class="cls_046">v</span><span class="cls_030"> Total: 17493 Free: 246 Object: 104</span></div>
<div style="position:absolute;left:120.00px;top:64.05px" class="cls_030"><span class="cls_030">Total: 17493 Free: 239 Object: 105</span></div>
<div style="position:absolute;left:120.00px;top:74.55px" class="cls_030"><span class="cls_030">Total: 17493 Free: 232 Object: 106</span></div>
<div style="position:absolute;left:120.00px;top:85.04px" class="cls_030"><span class="cls_030">Total: 17493 Free: 225 Object: 107</span></div>
<div style="position:absolute;left:120.00px;top:107.54px" class="cls_038"><span class="cls_038">Listing 12-5: Running Listing 12-3 with 30 iterations instead of 10</span></div>
<div style="position:absolute;left:138.00px;top:130.05px" class="cls_007"><span class="cls_007">This time the free list count drops to 8 at </span><span class="cls_050">u</span><span class="cls_007">. Then at </span><span class="cls_050">v</span><span class="cls_007"> the free count</span></div>
<div style="position:absolute;left:120.00px;top:142.05px" class="cls_007"><span class="cls_007">increases to 246, but the object count remains at 104. This must be a full</span></div>
<div style="position:absolute;left:120.00px;top:154.05px" class="cls_007"><span class="cls_007">garbage collection. But it’s not! If Ruby had collected all available garbage</span></div>
<div style="position:absolute;left:120.00px;top:166.05px" class="cls_007"><span class="cls_007">objects, it would have reduced the </span><span class="cls_030">RObject</span><span class="cls_007"> count when it increased the free</span></div>
<div style="position:absolute;left:120.00px;top:178.05px" class="cls_007"><span class="cls_007">count because all of our objects become garbage immediately. What’s going</span></div>
<div style="position:absolute;left:120.00px;top:190.05px" class="cls_007"><span class="cls_007">on here?</span></div>
<div style="position:absolute;left:138.00px;top:202.05px" class="cls_007"><span class="cls_007">This was a lazy sweep. Ruby first marked all active objects, indirectly</span></div>
<div style="position:absolute;left:120.00px;top:214.05px" class="cls_007"><span class="cls_007">identifying the garbage ones. Instead of moving all the garbage objects to</span></div>
<div style="position:absolute;left:120.00px;top:226.05px" class="cls_007"><span class="cls_007">the free list, however, it swept only a portion of them: the garbage objects</span></div>
<div style="position:absolute;left:120.00px;top:238.05px" class="cls_007"><span class="cls_007">it found in one of its internal heap structures. The free count increased,</span></div>
<div style="position:absolute;left:120.00px;top:250.05px" class="cls_007"><span class="cls_007">but the </span><span class="cls_030">RObject</span><span class="cls_007"> count remained the same because MRI reused an </span><span class="cls_030">RObject</span></div>
<div style="position:absolute;left:120.00px;top:262.05px" class="cls_007"><span class="cls_007">structure created by one of the previous iterations in order to create the</span></div>
<div style="position:absolute;left:120.00px;top:274.05px" class="cls_007"><span class="cls_007">new object.</span></div>
<div style="position:absolute;left:120.00px;top:299.05px" class="cls_055"><span class="cls_055">Seeing MRI Perform a Full Collection</span></div>
<div style="position:absolute;left:120.00px;top:317.05px" class="cls_007"><span class="cls_007">We can see the effect of a full garbage collection by triggering one manu-</span></div>
<div style="position:absolute;left:120.00px;top:329.05px" class="cls_007"><span class="cls_007">ally with the </span><span class="cls_030">GC.start</span><span class="cls_007"> method (see Listing 12-6).</span></div>
<div style="position:absolute;left:120.00px;top:353.05px" class="cls_030"><span class="cls_030">def display_count</span></div>
<div style="position:absolute;left:128.50px;top:363.55px" class="cls_030"><span class="cls_030">data = ObjectSpace.count_objects</span></div>
<div style="position:absolute;left:128.33px;top:374.05px" class="cls_030"><span class="cls_030">puts "Total: #{data[:TOTAL]} Free: #{data[:FREE]} Object: #{data[:T_OBJECT]}"</span></div>
<div style="position:absolute;left:120.00px;top:384.55px" class="cls_030"><span class="cls_030">end</span></div>
<div style="position:absolute;left:120.00px;top:405.55px" class="cls_030"><span class="cls_030">30.times do</span></div>
<div style="position:absolute;left:128.50px;top:416.05px" class="cls_030"><span class="cls_030">obj = Object.new</span></div>
<div style="position:absolute;left:128.50px;top:426.54px" class="cls_030"><span class="cls_030">display_count</span></div>
<div style="position:absolute;left:120.00px;top:437.04px" class="cls_030"><span class="cls_030">end</span></div>
<div style="position:absolute;left:108.15px;top:458.05px" class="cls_046"><span class="cls_046">u</span><span class="cls_030"> GC.start</span></div>
<div style="position:absolute;left:108.15px;top:468.54px" class="cls_046"><span class="cls_046">v</span><span class="cls_030"> display_count</span></div>
<div style="position:absolute;left:120.00px;top:491.04px" class="cls_038"><span class="cls_038">Listing 12-6: Triggering a full garbage collection</span></div>
<div style="position:absolute;left:138.00px;top:513.55px" class="cls_007"><span class="cls_007">Here, we again iterate 30 times, creating new objects and calling</span></div>
<div style="position:absolute;left:120.00px;top:525.55px" class="cls_030"><span class="cls_030">display_count</span><span class="cls_007">. Then, we call </span><span class="cls_030">GC.start</span><span class="cls_007"> at </span><span class="cls_050">u</span><span class="cls_007">, which triggers MRI to run a full</span></div>
<div style="position:absolute;left:120.00px;top:537.55px" class="cls_007"><span class="cls_007">garbage collection. Finally, at </span><span class="cls_050">v</span><span class="cls_007"> we call </span><span class="cls_030">display_count</span><span class="cls_007"> again to display the</span></div>
<div style="position:absolute;left:120.00px;top:549.55px" class="cls_007"><span class="cls_007">same technical information. Listing 12-7 shows the new output.</span></div>
<div style="position:absolute;left:48.00px;top:633.00px" class="cls_020"><span class="cls_020">304</span></div>
<div style="position:absolute;left:74.70px;top:636.00px" class="cls_021"><span class="cls_021">Chapter 12</span></div>
</div>
<div style="position:absolute;left:50%;margin-left:-252px;top:218348px;width:504px;height:666px;border-style:outset;overflow:hidden">
<div style="position:absolute;left:0px;top:0px">
<img src="e698b76e-46bd-11eb-8b25-0cc47a792c0a_id_e698b76e-46bd-11eb-8b25-0cc47a792c0a_files/background329.jpg" width=504 height=666></div>
<div style="position:absolute;left:123.00px;top:49.00px" class="cls_030"><span class="cls_030">--snip--</span></div>
<div style="position:absolute;left:123.00px;top:70.00px" class="cls_030"><span class="cls_030">Total: 17491 Free: 26 Object: 101</span></div>
<div style="position:absolute;left:123.00px;top:80.50px" class="cls_030"><span class="cls_030">Total: 17491 Free: 19 Object: 102</span></div>
<div style="position:absolute;left:123.00px;top:91.00px" class="cls_030"><span class="cls_030">Total: 17491 Free: 12 Object: 103</span></div>
<div style="position:absolute;left:111.15px;top:101.50px" class="cls_046"><span class="cls_046">u</span><span class="cls_030"> Total: 17491 Free: 251 Object: 103</span></div>
<div style="position:absolute;left:123.00px;top:111.99px" class="cls_030"><span class="cls_030">Total: 17491 Free: 244 Object: 104</span></div>
<div style="position:absolute;left:123.00px;top:122.49px" class="cls_030"><span class="cls_030">Total: 17491 Free: 237 Object: 105</span></div>
<div style="position:absolute;left:123.00px;top:132.99px" class="cls_030"><span class="cls_030">Total: 17491 Free: 230 Object: 106</span></div>
<div style="position:absolute;left:123.00px;top:143.49px" class="cls_030"><span class="cls_030">Total: 17491 Free: 223 Object: 107</span></div>
<div style="position:absolute;left:123.00px;top:153.98px" class="cls_030"><span class="cls_030">Total: 17491 Free: 216 Object: 108</span></div>
<div style="position:absolute;left:123.00px;top:164.48px" class="cls_030"><span class="cls_030">Total: 17491 Free: 209 Object: 109</span></div>
<div style="position:absolute;left:123.00px;top:174.98px" class="cls_030"><span class="cls_030">Total: 17491 Free: 202 Object: 110</span></div>
<div style="position:absolute;left:123.00px;top:185.48px" class="cls_030"><span class="cls_030">Total: 17491 Free: 195 Object: 111</span></div>
<div style="position:absolute;left:123.00px;top:195.97px" class="cls_030"><span class="cls_030">Total: 17491 Free: 188 Object: 112</span></div>
<div style="position:absolute;left:123.00px;top:206.47px" class="cls_030"><span class="cls_030">Total: 17491 Free: 181 Object: 113</span></div>
<div style="position:absolute;left:111.15px;top:216.97px" class="cls_046"><span class="cls_046">v</span><span class="cls_030"> Total: 17491 Free: 9527 Object: 43</span></div>
<div style="position:absolute;left:123.00px;top:239.47px" class="cls_038"><span class="cls_038">Listing 12-7: The output generated by Listing 12-6</span></div>
<div style="position:absolute;left:141.00px;top:262.00px" class="cls_007"><span class="cls_007">Most of Listing 12-7 shows output similar to Listing 12-5. The total</span></div>
<div style="position:absolute;left:123.00px;top:274.00px" class="cls_007"><span class="cls_007">remains the same, while the free count gradually decreases. At </span><span class="cls_050">u</span><span class="cls_007"> we see</span></div>
<div style="position:absolute;left:123.00px;top:286.00px" class="cls_007"><span class="cls_007">the lazy sweep occur again, increasing the free count to 251. But at </span><span class="cls_050">v</span><span class="cls_007"> we</span></div>
<div style="position:absolute;left:123.00px;top:298.00px" class="cls_007"><span class="cls_007">see a dramatic change. The total number of objects remains at 17491, but</span></div>
<div style="position:absolute;left:123.00px;top:310.00px" class="cls_007"><span class="cls_007">the free count jumps to 9527 and the number of objects reduces dramati-</span></div>
<div style="position:absolute;left:123.00px;top:322.00px" class="cls_007"><span class="cls_007">cally to 43!</span></div>
<div style="position:absolute;left:141.00px;top:334.00px" class="cls_007"><span class="cls_007">From this observation, we know the following:</span></div>
<div style="position:absolute;left:123.00px;top:355.00px" class="cls_050"><span class="cls_050">•</span><span class="cls_007">   The free count increased dramatically at </span><span class="cls_050">v</span><span class="cls_007"> because Ruby swept all</span></div>
<div style="position:absolute;left:141.00px;top:367.00px" class="cls_007"><span class="cls_007">of the garbage objects onto the free list in one large operation. This</span></div>
<div style="position:absolute;left:141.00px;top:379.00px" class="cls_007"><span class="cls_007">garbage included the objects our code created in previous iterations as</span></div>
<div style="position:absolute;left:141.00px;top:391.00px" class="cls_007"><span class="cls_007">well as objects that Ruby created internally during the parsing and com-</span></div>
<div style="position:absolute;left:141.00px;top:403.00px" class="cls_007"><span class="cls_007">pilation phases.</span></div>
<div style="position:absolute;left:123.00px;top:418.00px" class="cls_050"><span class="cls_050">•</span><span class="cls_007">   The </span><span class="cls_030">RObject</span><span class="cls_007"> count reduced to 43 because all of the objects created in</span></div>
<div style="position:absolute;left:141.00px;top:430.00px" class="cls_007"><span class="cls_007">previous iterations were garbage (because we didn’t save them any-</span></div>
<div style="position:absolute;left:141.00px;top:442.00px" class="cls_007"><span class="cls_007">where). The 43 count includes only objects Ruby created internally and</span></div>
<div style="position:absolute;left:141.00px;top:454.00px" class="cls_007"><span class="cls_007">none of the objects our code created. If we had saved our new objects</span></div>
<div style="position:absolute;left:141.00px;top:466.00px" class="cls_007"><span class="cls_007">somewhere, the </span><span class="cls_030">RObject</span><span class="cls_007"> count would have remained the same. (We’ll try</span></div>
<div style="position:absolute;left:141.00px;top:478.00px" class="cls_007"><span class="cls_007">this next.)</span></div>
<div style="position:absolute;left:123.00px;top:504.00px" class="cls_055"><span class="cls_055">Interpreting a GC Profile Report</span></div>
<div style="position:absolute;left:123.00px;top:522.00px" class="cls_007"><span class="cls_007">So far in this experiment we’ve allocated just a few objects from the free</span></div>
<div style="position:absolute;left:123.00px;top:534.00px" class="cls_007"><span class="cls_007">list. Of course, your Ruby programs will typically create many more than</span></div>
<div style="position:absolute;left:123.00px;top:546.00px" class="cls_007"><span class="cls_007">30 objects. How does MRI’s garbage collector behave when we create thou-</span></div>
<div style="position:absolute;left:123.00px;top:558.00px" class="cls_007"><span class="cls_007">sands or even millions of objects? How can you find out how much time is</span></div>
<div style="position:absolute;left:123.00px;top:570.00px" class="cls_007"><span class="cls_007">being taken by the garbage collector in a complex Ruby application?</span></div>
<div style="position:absolute;left:301.52px;top:636.00px" class="cls_021"><span class="cls_021">Garbage Collection in MRI, JRuby, and Rubinius</span></div>
<div style="position:absolute;left:442.46px;top:633.00px" class="cls_020"><span class="cls_020">305</span></div>
</div>
<div style="position:absolute;left:50%;margin-left:-252px;top:219024px;width:504px;height:666px;border-style:outset;overflow:hidden">
<div style="position:absolute;left:0px;top:0px">
<img src="e698b76e-46bd-11eb-8b25-0cc47a792c0a_id_e698b76e-46bd-11eb-8b25-0cc47a792c0a_files/background330.jpg" width=504 height=666></div>
<div style="position:absolute;left:138.00px;top:42.28px" class="cls_007"><span class="cls_007">The answer is to use the </span><span class="cls_030">GC::Profiler</span><span class="cls_007"> class. If you enable it, MRI’s inter-</span></div>
<div style="position:absolute;left:120.01px;top:54.28px" class="cls_007"><span class="cls_007">nal GC code will collect statistics about each GC run. Listing 12-8 shows</span></div>
<div style="position:absolute;left:120.01px;top:66.28px" class="cls_007"><span class="cls_007">how to use </span><span class="cls_030">GC::Profiler</span><span class="cls_007">.</span></div>
<div style="position:absolute;left:108.15px;top:90.28px" class="cls_046"><span class="cls_046">u</span><span class="cls_030"> GC::Profiler.enable</span></div>
<div style="position:absolute;left:120.00px;top:111.28px" class="cls_030"><span class="cls_030">10000000.times do</span></div>
<div style="position:absolute;left:128.50px;top:121.78px" class="cls_030"><span class="cls_030">obj = Object.new</span></div>
<div style="position:absolute;left:120.00px;top:132.28px" class="cls_030"><span class="cls_030">end</span></div>
<div style="position:absolute;left:108.15px;top:153.28px" class="cls_046"><span class="cls_046">v</span><span class="cls_030"> GC::Profiler.report</span></div>
<div style="position:absolute;left:120.00px;top:175.78px" class="cls_038"><span class="cls_038">Listing 12-8: Displaying a GC usage profile using </span><span class="cls_014">GC::Profiler</span><span class="cls_038"> </span><span class="cls_039">(gc-profile.rb)</span></div>
<div style="position:absolute;left:138.00px;top:198.28px" class="cls_007"><span class="cls_007">We first enable the profiler at </span><span class="cls_050">u</span><span class="cls_007"> by calling </span><span class="cls_030">GC::Profiler.enable</span><span class="cls_007">. The fol-</span></div>
<div style="position:absolute;left:119.99px;top:210.28px" class="cls_007"><span class="cls_007">lowing code creates 10 million Ruby objects. At </span><span class="cls_050">v</span><span class="cls_007"> we display the GC profile</span></div>
<div style="position:absolute;left:119.99px;top:222.28px" class="cls_007"><span class="cls_007">report by calling </span><span class="cls_030">GC::Profiler.report</span><span class="cls_007">. Listing 12-9 shows the report gener-</span></div>
<div style="position:absolute;left:120.00px;top:234.28px" class="cls_007"><span class="cls_007">ated in Listing 12-8.</span></div>
<div style="position:absolute;left:48.00px;top:258.28px" class="cls_030"><span class="cls_030">$ </span><span class="cls_040">ruby gc-profile.rb</span></div>
<div style="position:absolute;left:48.00px;top:268.78px" class="cls_030"><span class="cls_030">GC 1046 invokes.</span></div>
<div style="position:absolute;left:48.00px;top:279.27px" class="cls_030"><span class="cls_030">Invoke Time(sec)</span></div>
<div style="position:absolute;left:143.79px;top:279.27px" class="cls_030"><span class="cls_030">Use Size(byte)</span></div>
<div style="position:absolute;left:222.93px;top:279.27px" class="cls_030"><span class="cls_030">Total Size(byte)</span></div>
<div style="position:absolute;left:327.05px;top:279.27px" class="cls_030"><span class="cls_030">Total Object</span></div>
<div style="position:absolute;left:402.02px;top:279.27px" class="cls_030"><span class="cls_030">GC Time(ms)</span></div>
<div style="position:absolute;left:93.82px;top:289.77px" class="cls_030"><span class="cls_030">0.036</span></div>
<div style="position:absolute;left:177.12px;top:289.77px" class="cls_030"><span class="cls_030">690920</span></div>
<div style="position:absolute;left:264.58px;top:289.77px" class="cls_030"><span class="cls_030">700040</span></div>
<div style="position:absolute;left:356.21px;top:289.77px" class="cls_030"><span class="cls_030">17501</span></div>
<div style="position:absolute;left:414.52px;top:289.77px" class="cls_030"><span class="cls_030">0.694000</span></div>
<div style="position:absolute;left:93.82px;top:300.27px" class="cls_030"><span class="cls_030">0.039</span></div>
<div style="position:absolute;left:177.12px;top:300.27px" class="cls_030"><span class="cls_030">695200</span></div>
<div style="position:absolute;left:264.58px;top:300.27px" class="cls_030"><span class="cls_030">700040</span></div>
<div style="position:absolute;left:356.21px;top:300.27px" class="cls_030"><span class="cls_030">17501</span></div>
<div style="position:absolute;left:414.52px;top:300.27px" class="cls_030"><span class="cls_030">0.433999</span></div>
<div style="position:absolute;left:93.82px;top:310.77px" class="cls_030"><span class="cls_030">0.041</span></div>
<div style="position:absolute;left:177.12px;top:310.77px" class="cls_030"><span class="cls_030">695200</span></div>
<div style="position:absolute;left:264.58px;top:310.77px" class="cls_030"><span class="cls_030">700040</span></div>
<div style="position:absolute;left:356.21px;top:310.77px" class="cls_030"><span class="cls_030">17501</span></div>
<div style="position:absolute;left:414.52px;top:310.77px" class="cls_030"><span class="cls_030">0.585000</span></div>
<div style="position:absolute;left:93.82px;top:321.27px" class="cls_030"><span class="cls_030">0.046</span></div>
<div style="position:absolute;left:177.12px;top:321.27px" class="cls_030"><span class="cls_030">695200</span></div>
<div style="position:absolute;left:264.58px;top:321.27px" class="cls_030"><span class="cls_030">700040</span></div>
<div style="position:absolute;left:356.21px;top:321.27px" class="cls_030"><span class="cls_030">17501</span></div>
<div style="position:absolute;left:414.52px;top:321.27px" class="cls_030"><span class="cls_030">0.577000</span></div>
<div style="position:absolute;left:93.82px;top:331.76px" class="cls_030"><span class="cls_030">0.049</span></div>
<div style="position:absolute;left:177.12px;top:331.76px" class="cls_030"><span class="cls_030">695200</span></div>
<div style="position:absolute;left:264.58px;top:331.76px" class="cls_030"><span class="cls_030">700040</span></div>
<div style="position:absolute;left:356.21px;top:331.76px" class="cls_030"><span class="cls_030">17501</span></div>
<div style="position:absolute;left:414.52px;top:331.76px" class="cls_030"><span class="cls_030">0.466000</span></div>
<div style="position:absolute;left:93.82px;top:342.26px" class="cls_030"><span class="cls_030">0.051</span></div>
<div style="position:absolute;left:177.12px;top:342.26px" class="cls_030"><span class="cls_030">695200</span></div>
<div style="position:absolute;left:264.58px;top:342.26px" class="cls_030"><span class="cls_030">700040</span></div>
<div style="position:absolute;left:356.21px;top:342.26px" class="cls_030"><span class="cls_030">17501</span></div>
<div style="position:absolute;left:414.52px;top:342.26px" class="cls_030"><span class="cls_030">0.516999</span></div>
<div style="position:absolute;left:93.82px;top:352.76px" class="cls_030"><span class="cls_030">0.054</span></div>
<div style="position:absolute;left:177.12px;top:352.76px" class="cls_030"><span class="cls_030">695200</span></div>
<div style="position:absolute;left:264.58px;top:352.76px" class="cls_030"><span class="cls_030">700040</span></div>
<div style="position:absolute;left:356.21px;top:352.76px" class="cls_030"><span class="cls_030">17501</span></div>
<div style="position:absolute;left:414.52px;top:352.76px" class="cls_030"><span class="cls_030">0.419000</span></div>
<div style="position:absolute;left:93.82px;top:363.26px" class="cls_030"><span class="cls_030">0.056</span></div>
<div style="position:absolute;left:177.12px;top:363.26px" class="cls_030"><span class="cls_030">695200</span></div>
<div style="position:absolute;left:264.58px;top:363.26px" class="cls_030"><span class="cls_030">700040</span></div>
<div style="position:absolute;left:356.21px;top:363.26px" class="cls_030"><span class="cls_030">17501</span></div>
<div style="position:absolute;left:414.52px;top:363.26px" class="cls_030"><span class="cls_030">0.535000</span></div>
<div style="position:absolute;left:93.82px;top:373.75px" class="cls_030"><span class="cls_030">0.059</span></div>
<div style="position:absolute;left:177.12px;top:373.75px" class="cls_030"><span class="cls_030">695200</span></div>
<div style="position:absolute;left:264.58px;top:373.75px" class="cls_030"><span class="cls_030">700040</span></div>
<div style="position:absolute;left:356.21px;top:373.75px" class="cls_030"><span class="cls_030">17501</span></div>
<div style="position:absolute;left:414.52px;top:373.75px" class="cls_030"><span class="cls_030">0.410000</span></div>
<div style="position:absolute;left:93.82px;top:384.25px" class="cls_030"><span class="cls_030">0.062</span></div>
<div style="position:absolute;left:177.12px;top:384.25px" class="cls_030"><span class="cls_030">695200</span></div>
<div style="position:absolute;left:264.58px;top:384.25px" class="cls_030"><span class="cls_030">700040</span></div>
<div style="position:absolute;left:356.21px;top:384.25px" class="cls_030"><span class="cls_030">17501</span></div>
<div style="position:absolute;left:414.52px;top:384.25px" class="cls_030"><span class="cls_030">0.426999</span></div>
<div style="position:absolute;left:48.00px;top:394.75px" class="cls_030"><span class="cls_030">--snip--</span></div>
<div style="position:absolute;left:48.00px;top:417.25px" class="cls_038"><span class="cls_038">Listing 12-9: A portion of the GC profile report generated in Listing 12-8</span></div>
<div style="position:absolute;left:138.00px;top:439.78px" class="cls_007"><span class="cls_007">To save space, I’ve removed the first column from the report, a simple</span></div>
<div style="position:absolute;left:120.00px;top:451.78px" class="cls_007"><span class="cls_007">counter. Here’s what the other columns mean:</span></div>
<div style="position:absolute;left:120.00px;top:472.78px" class="cls_050"><span class="cls_050">•</span><span class="cls_008">   Invoke time</span><span class="cls_007"> shows when the garbage collection occurred, measured as</span></div>
<div style="position:absolute;left:138.00px;top:484.78px" class="cls_007"><span class="cls_007">seconds after the Ruby script started to run.</span></div>
<div style="position:absolute;left:120.00px;top:499.78px" class="cls_050"><span class="cls_050">•</span><span class="cls_008">   Use size</span><span class="cls_007"> shows how much heap memory is used by all live Ruby objects</span></div>
<div style="position:absolute;left:138.00px;top:511.78px" class="cls_007"><span class="cls_007">after each collection is finished.</span></div>
<div style="position:absolute;left:120.00px;top:526.78px" class="cls_050"><span class="cls_050">•</span><span class="cls_008">   Total size</span><span class="cls_007"> shows the total size of the heap after collection—in other</span></div>
<div style="position:absolute;left:138.00px;top:538.78px" class="cls_007"><span class="cls_007">words, the memory taken by live objects plus the size of the free list.</span></div>
<div style="position:absolute;left:120.00px;top:553.78px" class="cls_050"><span class="cls_050">•</span><span class="cls_008">   Total object</span><span class="cls_007"> shows the total number of Ruby objects, either live or on the</span></div>
<div style="position:absolute;left:138.00px;top:565.78px" class="cls_007"><span class="cls_007">free list.</span></div>
<div style="position:absolute;left:120.00px;top:580.78px" class="cls_050"><span class="cls_050">•</span><span class="cls_007">   Finally, </span><span class="cls_008">GC time</span><span class="cls_007"> shows the amount of time each collection took.</span></div>
<div style="position:absolute;left:48.00px;top:633.00px" class="cls_020"><span class="cls_020">306</span></div>
<div style="position:absolute;left:74.65px;top:636.00px" class="cls_021"><span class="cls_021">Chapter 12</span></div>
</div>
<div style="position:absolute;left:50%;margin-left:-252px;top:219700px;width:504px;height:666px;border-style:outset;overflow:hidden">
<div style="position:absolute;left:0px;top:0px">
<img src="e698b76e-46bd-11eb-8b25-0cc47a792c0a_id_e698b76e-46bd-11eb-8b25-0cc47a792c0a_files/background331.jpg" width=504 height=666></div>
<div style="position:absolute;left:141.00px;top:41.60px" class="cls_007"><span class="cls_007">Notice in this experiment that, aside from </span><span class="cls_008">invoke time</span><span class="cls_007">, none of the val-</span></div>
<div style="position:absolute;left:123.00px;top:53.60px" class="cls_007"><span class="cls_007">ues change. The amount of memory used by live Ruby objects, the total size</span></div>
<div style="position:absolute;left:123.00px;top:65.60px" class="cls_007"><span class="cls_007">of the heap, and the total number of objects all remain the same. This is</span></div>
<div style="position:absolute;left:123.00px;top:77.60px" class="cls_007"><span class="cls_007">because we don’t save the new Ruby objects anywhere. They all immediately</span></div>
<div style="position:absolute;left:123.00px;top:89.60px" class="cls_007"><span class="cls_007">become garbage. The </span><span class="cls_008">GC time</span><span class="cls_007"> value fluctuates somewhat but more or less</span></div>
<div style="position:absolute;left:123.00px;top:101.60px" class="cls_007"><span class="cls_007">remains the same. The amount of time required by the collector to sweep</span></div>
<div style="position:absolute;left:123.00px;top:113.60px" class="cls_007"><span class="cls_007">all of the new objects back to the free list remains about the same because</span></div>
<div style="position:absolute;left:123.00px;top:125.60px" class="cls_007"><span class="cls_007">the collector sweeps about the same number of objects each time.</span></div>
<div style="position:absolute;left:141.00px;top:137.60px" class="cls_007"><span class="cls_007">However, if we save all of the new objects in an array, they will remain</span></div>
<div style="position:absolute;left:123.00px;top:149.60px" class="cls_007"><span class="cls_007">live and not become garbage. Listing 12-10 shows code that saves each</span></div>
<div style="position:absolute;left:123.00px;top:161.60px" class="cls_007"><span class="cls_007">object into a single, large array.</span></div>
<div style="position:absolute;left:123.00px;top:185.60px" class="cls_030"><span class="cls_030">GC::Profiler.enable</span></div>
<div style="position:absolute;left:111.15px;top:206.60px" class="cls_046"><span class="cls_046">u</span><span class="cls_030"> arr = []</span></div>
<div style="position:absolute;left:123.00px;top:217.10px" class="cls_030"><span class="cls_030">10000000.times do</span></div>
<div style="position:absolute;left:111.15px;top:227.60px" class="cls_046"><span class="cls_046">v</span><span class="cls_030">   arr &lt;&lt; Object.new</span></div>
<div style="position:absolute;left:123.00px;top:238.10px" class="cls_030"><span class="cls_030">end</span></div>
<div style="position:absolute;left:123.00px;top:259.10px" class="cls_030"><span class="cls_030">GC.start</span></div>
<div style="position:absolute;left:123.00px;top:280.10px" class="cls_030"><span class="cls_030">GC::Profiler.report</span></div>
<div style="position:absolute;left:123.00px;top:302.60px" class="cls_038"><span class="cls_038">Listing 12-10: Saving 10 million Ruby objects in an array </span><span class="cls_039">(gc-profile-array.rb)</span></div>
<div style="position:absolute;left:141.00px;top:325.10px" class="cls_007"><span class="cls_007">Here, we create an empty array at </span><span class="cls_050">u</span><span class="cls_007"> and save each of the new objects</span></div>
<div style="position:absolute;left:123.00px;top:337.10px" class="cls_007"><span class="cls_007">in it at </span><span class="cls_050">v</span><span class="cls_007">. Because the array holds a reference to all of the new objects, they</span></div>
<div style="position:absolute;left:123.00px;top:349.10px" class="cls_007"><span class="cls_007">remain active. The garbage collector can’t reclaim memory from any of</span></div>
<div style="position:absolute;left:123.00px;top:361.10px" class="cls_007"><span class="cls_007">them. Listing 12-11 shows the GC profile report produced by Listing 12-10.</span></div>
<div style="position:absolute;left:51.00px;top:385.10px" class="cls_030"><span class="cls_030">$ </span><span class="cls_040">ruby gc-profile-array.rb</span></div>
<div style="position:absolute;left:40.00px;top:395.91px" class="cls_046"><span class="cls_046">u</span></div>
<div style="position:absolute;left:51.00px;top:395.60px" class="cls_030"><span class="cls_030">GC 17 invokes.</span></div>
<div style="position:absolute;left:51.00px;top:406.10px" class="cls_030"><span class="cls_030">Invoke Time(sec)</span></div>
<div style="position:absolute;left:146.79px;top:406.10px" class="cls_030"><span class="cls_030">Use Size(byte)</span></div>
<div style="position:absolute;left:225.93px;top:406.10px" class="cls_030"><span class="cls_030">Total Size(byte)</span></div>
<div style="position:absolute;left:330.05px;top:406.10px" class="cls_030"><span class="cls_030">Total Object</span></div>
<div style="position:absolute;left:405.02px;top:406.10px" class="cls_030"><span class="cls_030">GC Time(ms)</span></div>
<div style="position:absolute;left:96.82px;top:416.59px" class="cls_030"><span class="cls_030">0.031</span></div>
<div style="position:absolute;left:180.12px;top:416.59px" class="cls_030"><span class="cls_030">690920</span></div>
<div style="position:absolute;left:267.58px;top:416.59px" class="cls_030"><span class="cls_030">700040</span></div>
<div style="position:absolute;left:359.21px;top:416.59px" class="cls_030"><span class="cls_030">17501</span></div>
<div style="position:absolute;left:417.52px;top:416.59px" class="cls_030"><span class="cls_030">0.575000</span></div>
<div style="position:absolute;left:96.82px;top:427.09px" class="cls_030"><span class="cls_030">0.034</span></div>
<div style="position:absolute;left:180.12px;top:427.09px" class="cls_030"><span class="cls_030">708480</span></div>
<div style="position:absolute;left:267.58px;top:427.09px" class="cls_030"><span class="cls_030">716320</span></div>
<div style="position:absolute;left:359.21px;top:427.09px" class="cls_030"><span class="cls_030">17908</span></div>
<div style="position:absolute;left:417.52px;top:427.09px" class="cls_030"><span class="cls_030">0.689000</span></div>
<div style="position:absolute;left:96.82px;top:437.59px" class="cls_030"><span class="cls_030">0.037</span></div>
<div style="position:absolute;left:175.95px;top:437.59px" class="cls_030"><span class="cls_030">1261680</span></div>
<div style="position:absolute;left:263.42px;top:437.59px" class="cls_030"><span class="cls_030">1269840</span></div>
<div style="position:absolute;left:359.21px;top:437.59px" class="cls_030"><span class="cls_030">31746</span></div>
<div style="position:absolute;left:417.52px;top:437.59px" class="cls_030"><span class="cls_030">1.077000</span></div>
<div style="position:absolute;left:96.82px;top:448.08px" class="cls_030"><span class="cls_030">0.043</span></div>
<div style="position:absolute;left:175.95px;top:448.08px" class="cls_030"><span class="cls_030">2254280</span></div>
<div style="position:absolute;left:263.42px;top:448.08px" class="cls_030"><span class="cls_030">2262920</span></div>
<div style="position:absolute;left:359.21px;top:448.08px" class="cls_030"><span class="cls_030">56573</span></div>
<div style="position:absolute;left:417.52px;top:448.08px" class="cls_030"><span class="cls_030">1.994999</span></div>
<div style="position:absolute;left:96.82px;top:458.58px" class="cls_030"><span class="cls_030">0.054</span></div>
<div style="position:absolute;left:175.95px;top:458.58px" class="cls_030"><span class="cls_030">4044200</span></div>
<div style="position:absolute;left:263.42px;top:458.58px" class="cls_030"><span class="cls_030">4053720</span></div>
<div style="position:absolute;left:355.05px;top:458.58px" class="cls_030"><span class="cls_030">101343</span></div>
<div style="position:absolute;left:417.52px;top:458.58px" class="cls_030"><span class="cls_030">3.454999</span></div>
<div style="position:absolute;left:96.82px;top:469.08px" class="cls_030"><span class="cls_030">0.074</span></div>
<div style="position:absolute;left:175.95px;top:469.08px" class="cls_030"><span class="cls_030">7266080</span></div>
<div style="position:absolute;left:263.42px;top:469.08px" class="cls_030"><span class="cls_030">7277160</span></div>
<div style="position:absolute;left:355.05px;top:469.08px" class="cls_030"><span class="cls_030">181929</span></div>
<div style="position:absolute;left:417.52px;top:469.08px" class="cls_030"><span class="cls_030">5.288000</span></div>
<div style="position:absolute;left:96.82px;top:479.58px" class="cls_030"><span class="cls_030">0.108</span></div>
<div style="position:absolute;left:171.79px;top:479.58px" class="cls_030"><span class="cls_030">13058920</span></div>
<div style="position:absolute;left:259.25px;top:479.58px" class="cls_030"><span class="cls_030">13072840</span></div>
<div style="position:absolute;left:355.05px;top:479.58px" class="cls_030"><span class="cls_030">326821</span></div>
<div style="position:absolute;left:417.52px;top:479.58px" class="cls_030"><span class="cls_030">9.417000</span></div>
<div style="position:absolute;left:96.82px;top:490.08px" class="cls_030"><span class="cls_030">0.170</span></div>
<div style="position:absolute;left:171.79px;top:490.08px" class="cls_030"><span class="cls_030">23489240</span></div>
<div style="position:absolute;left:259.25px;top:490.08px" class="cls_030"><span class="cls_030">23508320</span></div>
<div style="position:absolute;left:355.05px;top:490.08px" class="cls_030"><span class="cls_030">587708</span></div>
<div style="position:absolute;left:413.36px;top:490.08px" class="cls_030"><span class="cls_030">14.465000</span></div>
<div style="position:absolute;left:96.82px;top:500.57px" class="cls_030"><span class="cls_030">0.279</span></div>
<div style="position:absolute;left:171.79px;top:500.57px" class="cls_030"><span class="cls_030">42267080</span></div>
<div style="position:absolute;left:259.25px;top:500.57px" class="cls_030"><span class="cls_030">42311720</span></div>
<div style="position:absolute;left:350.88px;top:500.57px" class="cls_030"><span class="cls_030">1057793</span></div>
<div style="position:absolute;left:413.36px;top:500.57px" class="cls_030"><span class="cls_030">26.015999</span></div>
<div style="position:absolute;left:96.82px;top:511.07px" class="cls_030"><span class="cls_030">0.478</span></div>
<div style="position:absolute;left:171.79px;top:511.07px" class="cls_030"><span class="cls_030">76096560</span></div>
<div style="position:absolute;left:259.25px;top:511.07px" class="cls_030"><span class="cls_030">76157840</span></div>
<div style="position:absolute;left:350.88px;top:511.07px" class="cls_030"><span class="cls_030">1903946</span></div>
<div style="position:absolute;left:413.36px;top:511.07px" class="cls_030"><span class="cls_030">45.910000</span></div>
<div style="position:absolute;left:51.00px;top:533.57px" class="cls_038"><span class="cls_038">Listing 12-11: Ruby has to increase the heap size to accommodate all the new, live objects.</span></div>
<div style="position:absolute;left:141.00px;top:556.10px" class="cls_007"><span class="cls_007">This time the profile report is very different! The garbage collector can’t</span></div>
<div style="position:absolute;left:123.00px;top:568.10px" class="cls_007"><span class="cls_007">free any of the new objects because they remain active in the array. This</span></div>
<div style="position:absolute;left:123.00px;top:580.10px" class="cls_007"><span class="cls_007">means Ruby has no choice but to repeatedly allocate more memory to hold</span></div>
<div style="position:absolute;left:123.00px;top:592.10px" class="cls_007"><span class="cls_007">them. When you read Listing 12-11, notice that all three important values—</span></div>
<div style="position:absolute;left:123.00px;top:604.10px" class="cls_008"><span class="cls_008">use size</span><span class="cls_007">, </span><span class="cls_008">total size</span><span class="cls_007">, and </span><span class="cls_008">total object</span><span class="cls_007">—increase exponentially. This increase is</span></div>
<div style="position:absolute;left:301.66px;top:636.00px" class="cls_021"><span class="cls_021">Garbage Collection in MRI, JRuby, and Rubinius</span></div>
<div style="position:absolute;left:442.60px;top:633.00px" class="cls_020"><span class="cls_020">307</span></div>
</div>
<div style="position:absolute;left:50%;margin-left:-252px;top:220376px;width:504px;height:666px;border-style:outset;overflow:hidden">
<div style="position:absolute;left:0px;top:0px">
<img src="e698b76e-46bd-11eb-8b25-0cc47a792c0a_id_e698b76e-46bd-11eb-8b25-0cc47a792c0a_files/background332.jpg" width=504 height=666></div>
<div style="position:absolute;left:120.00px;top:42.71px" class="cls_007"><span class="cls_007">why at </span><span class="cls_050">u</span><span class="cls_007"> we see the garbage collector was called only 17 times. (Ruby also</span></div>
<div style="position:absolute;left:120.00px;top:54.71px" class="cls_007"><span class="cls_007">ran a few collections before we called </span><span class="cls_030">GC::Profiler.enable</span><span class="cls_007"> as it parsed and</span></div>
<div style="position:absolute;left:120.00px;top:66.71px" class="cls_007"><span class="cls_007">compiled our script.) Each time the collector more or less doubled the size</span></div>
<div style="position:absolute;left:120.00px;top:78.71px" class="cls_007"><span class="cls_007">of the heap, allowing the script to continue to run for longer and longer</span></div>
<div style="position:absolute;left:120.00px;top:90.71px" class="cls_007"><span class="cls_007">periods of time. Instead of running many collections quickly, as we saw in</span></div>
<div style="position:absolute;left:120.00px;top:102.71px" class="cls_007"><span class="cls_007">Listing 12-9, Ruby ran just a few slow collections.</span></div>
<div style="position:absolute;left:138.00px;top:114.71px" class="cls_007"><span class="cls_007">If we draw a graph of the time required for each collection (</span><span class="cls_008">GC Time</span><span class="cls_007">)</span></div>
<div style="position:absolute;left:120.01px;top:126.71px" class="cls_007"><span class="cls_007">against the total size of the heap (</span><span class="cls_008">Total Heap Size</span><span class="cls_007">), as shown in Figure 12-8,</span></div>
<div style="position:absolute;left:120.01px;top:138.71px" class="cls_007"><span class="cls_007">we can draw another interesting conclusion.</span></div>
<div style="position:absolute;left:137.94px;top:160.50px" class="cls_214"><span class="cls_214">50</span></div>
<div style="position:absolute;left:137.94px;top:218.70px" class="cls_214"><span class="cls_214">10</span></div>
<div style="position:absolute;left:141.60px;top:301.92px" class="cls_214"><span class="cls_214">1</span></div>
<div style="position:absolute;left:136.11px;top:384.82px" class="cls_214"><span class="cls_214">0.1</span></div>
<div style="position:absolute;left:175.02px;top:389.37px" class="cls_214"><span class="cls_214">0.2</span></div>
<div style="position:absolute;left:192.90px;top:389.37px" class="cls_214"><span class="cls_214">0.3</span></div>
<div style="position:absolute;left:215.65px;top:389.37px" class="cls_214"><span class="cls_214">0.5</span></div>
<div style="position:absolute;left:248.80px;top:389.37px" class="cls_214"><span class="cls_214">1</span></div>
<div style="position:absolute;left:279.36px;top:389.37px" class="cls_214"><span class="cls_214">2</span></div>
<div style="position:absolute;left:296.58px;top:389.37px" class="cls_214"><span class="cls_214">3</span></div>
<div style="position:absolute;left:320.00px;top:389.37px" class="cls_214"><span class="cls_214">5</span></div>
<div style="position:absolute;left:348.93px;top:389.37px" class="cls_214"><span class="cls_214">10</span></div>
<div style="position:absolute;left:379.49px;top:389.37px" class="cls_214"><span class="cls_214">20</span></div>
<div style="position:absolute;left:397.37px;top:389.37px" class="cls_214"><span class="cls_214">30</span></div>
<div style="position:absolute;left:420.12px;top:389.37px" class="cls_214"><span class="cls_214">50</span></div>
<div style="position:absolute;left:262.69px;top:403.03px" class="cls_215"><span class="cls_215">Total Heap Size (MB)</span></div>
<div style="position:absolute;left:120.00px;top:419.99px" class="cls_038"><span class="cls_038">Figure 12-8: The time required to perform mark and sweep increases linearly with the</span></div>
<div style="position:absolute;left:120.00px;top:430.49px" class="cls_038"><span class="cls_038">heap size.</span></div>
<div style="position:absolute;left:138.00px;top:452.99px" class="cls_007"><span class="cls_007">Figure 12-8 uses a logarithmic scale for both the x-axis (</span><span class="cls_008">Total Heap</span></div>
<div style="position:absolute;left:120.00px;top:464.99px" class="cls_008"><span class="cls_008">Size</span><span class="cls_007">) and the y-axis (</span><span class="cls_008">GC Time</span><span class="cls_007">). Because Ruby doubled the heap size during</span></div>
<div style="position:absolute;left:120.00px;top:476.99px" class="cls_007"><span class="cls_007">each collection, the data points are more or less evenly spaced across the</span></div>
<div style="position:absolute;left:120.00px;top:488.99px" class="cls_007"><span class="cls_007">logarithmic x-axis scale. They are also evenly spaced along the logarithmic</span></div>
<div style="position:absolute;left:120.00px;top:500.99px" class="cls_007"><span class="cls_007">y-axis because the time increases exponentially.</span></div>
<div style="position:absolute;left:138.00px;top:512.99px" class="cls_007"><span class="cls_007">Most importantly, note the data points form a straight line: This straight</span></div>
<div style="position:absolute;left:120.00px;top:524.99px" class="cls_007"><span class="cls_007">line means the time required to perform a garbage collection increases lin-</span></div>
<div style="position:absolute;left:120.00px;top:536.99px" class="cls_007"><span class="cls_007">early as a function of the total heap size. As you create more Ruby objects, it</span></div>
<div style="position:absolute;left:120.00px;top:548.99px" class="cls_007"><span class="cls_007">takes longer to mark them. Sweeping also takes longer when there are more</span></div>
<div style="position:absolute;left:120.00px;top:560.99px" class="cls_007"><span class="cls_007">garbage objects; however, in this example, we don’t see any sweep time</span></div>
<div style="position:absolute;left:120.00px;top:572.99px" class="cls_007"><span class="cls_007">because all our objects remain live.</span></div>
<div style="position:absolute;left:48.00px;top:633.00px" class="cls_020"><span class="cls_020">308</span></div>
<div style="position:absolute;left:74.67px;top:636.00px" class="cls_021"><span class="cls_021">Chapter 12</span></div>
</div>
<div style="position:absolute;left:50%;margin-left:-252px;top:221052px;width:504px;height:666px;border-style:outset;overflow:hidden">
<div style="position:absolute;left:0px;top:0px">
<img src="e698b76e-46bd-11eb-8b25-0cc47a792c0a_id_e698b76e-46bd-11eb-8b25-0cc47a792c0a_files/background333.jpg" width=504 height=666></div>
<div style="position:absolute;left:69.00px;top:42.05px" class="cls_031"><span class="cls_031">Garbage Collection in JRuby and Rubinius</span></div>
<div style="position:absolute;left:123.00px;top:62.05px" class="cls_007"><span class="cls_007">Because JRuby uses the Java Virtual Machine (JVM) to implement Ruby, it’s</span></div>
<div style="position:absolute;left:123.00px;top:74.05px" class="cls_007"><span class="cls_007">able to use the JVM’s sophisticated GC system to manage memory for Ruby</span></div>
<div style="position:absolute;left:123.00px;top:86.05px" class="cls_007"><span class="cls_007">objects. In fact, garbage collection is one of the primary benefits of using the</span></div>
<div style="position:absolute;left:123.00px;top:98.05px" class="cls_007"><span class="cls_007">JVM platform: The JVM garbage collector has been refined over many years.</span></div>
<div style="position:absolute;left:141.00px;top:110.05px" class="cls_007"><span class="cls_007">The Rubinius C++ virtual machine also includes a sophisticated, effi-</span></div>
<div style="position:absolute;left:123.00px;top:122.05px" class="cls_007"><span class="cls_007">cient garbage collector that uses some of the same underlying algorithms as</span></div>
<div style="position:absolute;left:123.00px;top:134.05px" class="cls_007"><span class="cls_007">the JVM. One of the benefits of choosing Rubinius as your Ruby platform is</span></div>
<div style="position:absolute;left:123.00px;top:146.05px" class="cls_007"><span class="cls_007">its sophisticated GC system.</span></div>
<div style="position:absolute;left:141.00px;top:158.05px" class="cls_007"><span class="cls_007">The garbage collectors used by JRuby and Rubinius differ from MRI’s</span></div>
<div style="position:absolute;left:123.00px;top:170.05px" class="cls_007"><span class="cls_007">garbage collector in three ways:</span></div>
<div style="position:absolute;left:123.00px;top:191.05px" class="cls_050"><span class="cls_050">•</span><span class="cls_007">   Instead of using a free list, they allocate memory for new objects and</span></div>
<div style="position:absolute;left:141.00px;top:203.05px" class="cls_007"><span class="cls_007">reclaim memory from garbage objects using an algorithm called </span><span class="cls_008">copying</span></div>
<div style="position:absolute;left:141.00px;top:215.05px" class="cls_008"><span class="cls_008">garbage collection</span><span class="cls_007">.</span></div>
<div style="position:absolute;left:123.00px;top:230.05px" class="cls_050"><span class="cls_050">•</span><span class="cls_007">   They handle old and young Ruby objects differently using </span><span class="cls_008">generational</span></div>
<div style="position:absolute;left:141.00px;top:242.05px" class="cls_008"><span class="cls_008">garbage collection</span><span class="cls_007">.</span></div>
<div style="position:absolute;left:123.00px;top:257.05px" class="cls_050"><span class="cls_050">•</span><span class="cls_007">   They use </span><span class="cls_008">concurrent garbage collection</span><span class="cls_007"> to perform some GC tasks at the</span></div>
<div style="position:absolute;left:141.00px;top:269.05px" class="cls_007"><span class="cls_007">same time that your application code is running.</span></div>
<div style="position:absolute;left:81.00px;top:295.55px" class="cls_032"><span class="cls_032">Note</span></div>
<div style="position:absolute;left:123.00px;top:293.05px" class="cls_008"><span class="cls_008">Although the GC systems used by JRuby and Rubinius are dramatically different from</span></div>
<div style="position:absolute;left:123.00px;top:305.05px" class="cls_008"><span class="cls_008">MRI’s mark-and-sweep garbage collector, MRI has begun to incorporate some of these</span></div>
<div style="position:absolute;left:123.00px;top:317.05px" class="cls_008"><span class="cls_008">ideas as well. Specifically, the GC system in Ruby 2.1 has begun to use generational</span></div>
<div style="position:absolute;left:123.00px;top:329.05px" class="cls_008"><span class="cls_008">garbage collection.</span></div>
<div style="position:absolute;left:141.00px;top:353.05px" class="cls_007"><span class="cls_007">In the following sections, we’ll explore the basic algorithms underpin-</span></div>
<div style="position:absolute;left:123.00px;top:365.05px" class="cls_007"><span class="cls_007">ning copying, generational, and concurrent garbage collection, as we learn</span></div>
<div style="position:absolute;left:123.00px;top:377.05px" class="cls_007"><span class="cls_007">more about how garbage collection works in Rubinius and JRuby.</span></div>
<div style="position:absolute;left:69.00px;top:411.05px" class="cls_031"><span class="cls_031">Copying Garbage Collection</span></div>
<div style="position:absolute;left:123.00px;top:431.05px" class="cls_007"><span class="cls_007">In 1963, three years after John McCarthy built the first Lisp garbage collector,</span></div>
<div style="position:absolute;left:123.00px;top:443.05px" class="cls_007"><span class="cls_007">Marvin Minsky developed a different way of allocating and reclaiming mem-</span></div>
<div style="position:absolute;left:123.00px;top:455.05px" class="cls_007"><span class="cls_007">ory known as </span><span class="cls_008">copying garbage collection</span><span class="cls_007">. (Minsky’s research was also originally</span></div>
<div style="position:absolute;left:123.00px;top:467.05px" class="cls_007"><span class="cls_007">used for Lisp. The algorithm was later refined by Fenichel and Yochelson</span></div>
<div style="position:absolute;left:123.00px;top:479.05px" class="cls_007"><span class="cls_007">in 1969 and by Baker in 1978.) Instead of using a free list to track available</span></div>
<div style="position:absolute;left:123.00px;top:491.05px" class="cls_007"><span class="cls_007">objects, copying garbage collectors allocate memory for new objects from</span></div>
<div style="position:absolute;left:123.00px;top:503.05px" class="cls_007"><span class="cls_007">a single large heap or memory segment. When that memory segment is</span></div>
<div style="position:absolute;left:123.00px;top:515.05px" class="cls_007"><span class="cls_007">used up, these collectors </span><span class="cls_008">copy</span><span class="cls_007"> only the live objects over to a second memory</span></div>
<div style="position:absolute;left:123.00px;top:527.05px" class="cls_007"><span class="cls_007">segment, leaving the garbage objects behind. The two segments are then</span></div>
<div style="position:absolute;left:123.00px;top:539.05px" class="cls_007"><span class="cls_007">swapped, immediately reclaiming all of the memory from the garbage</span></div>
<div style="position:absolute;left:123.00px;top:551.05px" class="cls_007"><span class="cls_007">objects. (Rubinius and the JVM both use complex algorithms based on this</span></div>
<div style="position:absolute;left:123.00px;top:563.05px" class="cls_007"><span class="cls_007">original idea.)</span></div>
<div style="position:absolute;left:301.37px;top:636.00px" class="cls_021"><span class="cls_021">Garbage Collection in MRI, JRuby, and Rubinius</span></div>
<div style="position:absolute;left:442.32px;top:633.00px" class="cls_020"><span class="cls_020">309</span></div>
</div>
<div style="position:absolute;left:50%;margin-left:-252px;top:221728px;width:504px;height:666px;border-style:outset;overflow:hidden">
<div style="position:absolute;left:0px;top:0px">
<img src="e698b76e-46bd-11eb-8b25-0cc47a792c0a_id_e698b76e-46bd-11eb-8b25-0cc47a792c0a_files/background334.jpg" width=504 height=666></div>
<div style="position:absolute;left:120.00px;top:42.55px" class="cls_055"><span class="cls_055">Bump Allocation</span></div>
<div style="position:absolute;left:120.00px;top:60.55px" class="cls_007"><span class="cls_007">When you allocate memory for a new object using a copying garbage collec-</span></div>
<div style="position:absolute;left:120.00px;top:72.55px" class="cls_007"><span class="cls_007">tor, such as the collectors in the JVM and Rubinius, the garbage collector</span></div>
<div style="position:absolute;left:120.00px;top:84.55px" class="cls_007"><span class="cls_007">uses an algorithm called </span><span class="cls_008">bump allocation</span><span class="cls_007">. Bump allocation allocates adjacent</span></div>
<div style="position:absolute;left:120.00px;top:96.55px" class="cls_007"><span class="cls_007">memory segments from a large, continuous heap by </span><span class="cls_008">bumping</span><span class="cls_007">, or increment-</span></div>
<div style="position:absolute;left:119.99px;top:108.55px" class="cls_007"><span class="cls_007">ing, a pointer to keep track of where the next allocation will occur. Figure 12-9</span></div>
<div style="position:absolute;left:119.99px;top:120.55px" class="cls_007"><span class="cls_007">shows how this process works for three repeated allocations. (The large</span></div>
<div style="position:absolute;left:119.99px;top:132.55px" class="cls_007"><span class="cls_007">rectangle represents the Rubinius or JVM heap.)</span></div>
<div style="position:absolute;left:145.30px;top:153.96px" class="cls_054"><span class="cls_054">next</span></div>
<div style="position:absolute;left:135.48px;top:163.56px" class="cls_054"><span class="cls_054">allocation</span></div>
<div style="position:absolute;left:212.80px;top:227.88px" class="cls_054"><span class="cls_054">next</span></div>
<div style="position:absolute;left:202.98px;top:237.48px" class="cls_054"><span class="cls_054">allocation</span></div>
<div style="position:absolute;left:227.58px;top:301.79px" class="cls_054"><span class="cls_054">next</span></div>
<div style="position:absolute;left:217.76px;top:311.39px" class="cls_054"><span class="cls_054">allocation</span></div>
<div style="position:absolute;left:120.00px;top:373.86px" class="cls_038"><span class="cls_038">Figure 12-9: Allocating three objects using bump allocation</span></div>
<div style="position:absolute;left:138.00px;top:396.36px" class="cls_007"><span class="cls_007">A copying collector keeps a pointer that tracks where in the heap the</span></div>
<div style="position:absolute;left:120.00px;top:408.36px" class="cls_007"><span class="cls_007">next allocation will occur. Each time the collector allocates memory for a</span></div>
<div style="position:absolute;left:120.00px;top:420.36px" class="cls_007"><span class="cls_007">new object, it returns some memory from the heap and moves this pointer</span></div>
<div style="position:absolute;left:120.00px;top:432.36px" class="cls_007"><span class="cls_007">to the right. As more objects are created, the memory allocated from the</span></div>
<div style="position:absolute;left:120.00px;top:444.36px" class="cls_007"><span class="cls_007">heap also moves to the right. Notice, too, that the new objects are not all</span></div>
<div style="position:absolute;left:120.00px;top:456.36px" class="cls_007"><span class="cls_007">the same size; each object uses a different number of bytes. As a result, the</span></div>
<div style="position:absolute;left:120.00px;top:468.36px" class="cls_007"><span class="cls_007">objects are not spaced evenly across the heap.</span></div>
<div style="position:absolute;left:138.00px;top:480.36px" class="cls_007"><span class="cls_007">The advantages of this technique are that it’s very fast and simple to</span></div>
<div style="position:absolute;left:120.00px;top:492.36px" class="cls_007"><span class="cls_007">implement and it provides good </span><span class="cls_008">locality of reference</span><span class="cls_007">, meaning that related</span></div>
<div style="position:absolute;left:120.00px;top:504.36px" class="cls_007"><span class="cls_007">values in your program should be located near each other in memory.</span></div>
<div style="position:absolute;left:120.00px;top:516.36px" class="cls_007"><span class="cls_007">Locality is important because if your code repeatedly accesses the same</span></div>
<div style="position:absolute;left:120.00px;top:528.36px" class="cls_007"><span class="cls_007">area of memory, your CPU can cache that memory and access it much more</span></div>
<div style="position:absolute;left:120.00px;top:540.36px" class="cls_007"><span class="cls_007">quickly. If your program often accesses very different areas of memory, the</span></div>
<div style="position:absolute;left:120.00px;top:552.36px" class="cls_007"><span class="cls_007">CPU must continually reload the memory cache, slowing down your pro-</span></div>
<div style="position:absolute;left:120.00px;top:564.36px" class="cls_007"><span class="cls_007">gram’s performance.</span></div>
<div style="position:absolute;left:48.00px;top:633.00px" class="cls_020"><span class="cls_020">310</span></div>
<div style="position:absolute;left:73.84px;top:636.00px" class="cls_021"><span class="cls_021">Chapter 12</span></div>
</div>
<div style="position:absolute;left:50%;margin-left:-252px;top:222404px;width:504px;height:666px;border-style:outset;overflow:hidden">
<div style="position:absolute;left:0px;top:0px">
<img src="e698b76e-46bd-11eb-8b25-0cc47a792c0a_id_e698b76e-46bd-11eb-8b25-0cc47a792c0a_files/background335.jpg" width=504 height=666></div>
<div style="position:absolute;left:141.00px;top:41.60px" class="cls_007"><span class="cls_007">Another benefit of copying garbage collection is the ability to create</span></div>
<div style="position:absolute;left:123.00px;top:53.60px" class="cls_007"><span class="cls_007">objects of different sizes. Unlike the </span><span class="cls_030">RVALUE</span><span class="cls_007"> structure in MRI, JRuby and</span></div>
<div style="position:absolute;left:123.00px;top:65.60px" class="cls_007"><span class="cls_007">Rubinius can allocate new objects of any size.</span></div>
<div style="position:absolute;left:123.00px;top:90.60px" class="cls_055"><span class="cls_055">The Semi-Space Algorithm</span></div>
<div style="position:absolute;left:123.00px;top:108.60px" class="cls_007"><span class="cls_007">The real benefit and elegance of copying garbage collectors becomes</span></div>
<div style="position:absolute;left:123.00px;top:120.60px" class="cls_007"><span class="cls_007">evident when the initial heap is used up and a garbage collection occurs.</span></div>
<div style="position:absolute;left:123.00px;top:132.60px" class="cls_007"><span class="cls_007">Copying garbage collectors identify live and garbage objects the way that</span></div>
<div style="position:absolute;left:123.00px;top:144.60px" class="cls_007"><span class="cls_007">mark-and-sweep collectors do—by traversing the object graph following</span></div>
<div style="position:absolute;left:123.00px;top:156.60px" class="cls_007"><span class="cls_007">object references or pointers. Once the garbage objects have been identi-</span></div>
<div style="position:absolute;left:123.00px;top:168.60px" class="cls_007"><span class="cls_007">fied, however, copying garbage collectors work very differently.</span></div>
<div style="position:absolute;left:141.00px;top:180.60px" class="cls_007"><span class="cls_007">Copying garbage collectors actually use two heaps: one to create</span></div>
<div style="position:absolute;left:123.00px;top:192.60px" class="cls_007"><span class="cls_007">new objects with bump allocation and a second, empty one, as shown</span></div>
<div style="position:absolute;left:123.00px;top:204.60px" class="cls_007"><span class="cls_007">in Figure 12-10.</span></div>
<div style="position:absolute;left:184.74px;top:226.02px" class="cls_216"><span class="cls_216">M</span></div>
<div style="position:absolute;left:226.47px;top:226.02px" class="cls_216"><span class="cls_216">M</span></div>
<div style="position:absolute;left:325.15px;top:226.02px" class="cls_216"><span class="cls_216">M</span></div>
<div style="position:absolute;left:410.18px;top:226.02px" class="cls_216"><span class="cls_216">M     M</span></div>
<div style="position:absolute;left:123.00px;top:241.95px" class="cls_216"><span class="cls_216">From-Space</span></div>
<div style="position:absolute;left:132.15px;top:288.78px" class="cls_216"><span class="cls_216">To-Space</span></div>
<div style="position:absolute;left:123.00px;top:312.31px" class="cls_038"><span class="cls_038">Figure 12-10: The semi-space algorithm uses two heaps, one initially empty.</span></div>
<div style="position:absolute;left:141.00px;top:334.81px" class="cls_007"><span class="cls_007">The heap at the top contains the objects already created and is known as</span></div>
<div style="position:absolute;left:123.00px;top:346.81px" class="cls_007"><span class="cls_007">the </span><span class="cls_008">from-space</span><span class="cls_007">. Note that the objects in the from-space were already marked</span></div>
<div style="position:absolute;left:122.99px;top:358.81px" class="cls_007"><span class="cls_007">as live (gray with an </span><span class="cls_008">M</span><span class="cls_007">) or garbage (white). The lower heap is the </span><span class="cls_008">to-space</span><span class="cls_007">,</span></div>
<div style="position:absolute;left:122.99px;top:370.81px" class="cls_007"><span class="cls_007">and it’s initially empty. The algorithm I’m about to describe is known as the</span></div>
<div style="position:absolute;left:122.99px;top:382.81px" class="cls_008"><span class="cls_008">semi-space</span><span class="cls_007"> algorithm because the total available memory is divided between</span></div>
<div style="position:absolute;left:122.99px;top:394.81px" class="cls_007"><span class="cls_007">the from-space and the to-space.</span></div>
<div style="position:absolute;left:140.99px;top:406.81px" class="cls_007"><span class="cls_007">When the from-space becomes completely full, copying garbage collec-</span></div>
<div style="position:absolute;left:122.99px;top:418.81px" class="cls_007"><span class="cls_007">tors copy all of the live objects down into the to-space, leaving the garbage</span></div>
<div style="position:absolute;left:122.99px;top:430.81px" class="cls_007"><span class="cls_007">objects behind. Figure 12-11 shows the copying process.</span></div>
<div style="position:absolute;left:184.74px;top:452.22px" class="cls_216"><span class="cls_216">M</span></div>
<div style="position:absolute;left:226.47px;top:452.22px" class="cls_216"><span class="cls_216">M</span></div>
<div style="position:absolute;left:325.15px;top:452.22px" class="cls_216"><span class="cls_216">M</span></div>
<div style="position:absolute;left:410.18px;top:452.22px" class="cls_216"><span class="cls_216">M     M</span></div>
<div style="position:absolute;left:123.00px;top:467.15px" class="cls_216"><span class="cls_216">From-Space</span></div>
<div style="position:absolute;left:132.15px;top:515.96px" class="cls_216"><span class="cls_216">To-Space</span></div>
<div style="position:absolute;left:329.43px;top:550.47px" class="cls_216"><span class="cls_216">next</span></div>
<div style="position:absolute;left:319.61px;top:560.07px" class="cls_216"><span class="cls_216">allocation</span></div>
<div style="position:absolute;left:123.00px;top:578.41px" class="cls_038"><span class="cls_038">Figure 12-11: The semi-space algorithm copies only live objects to the second heap.</span></div>
<div style="position:absolute;left:302.64px;top:636.00px" class="cls_021"><span class="cls_021">Garbage Collection in MRI, JRuby, and Rubinius</span></div>
<div style="position:absolute;left:443.58px;top:633.00px" class="cls_020"><span class="cls_020">311</span></div>
</div>
<div style="position:absolute;left:50%;margin-left:-252px;top:223080px;width:504px;height:666px;border-style:outset;overflow:hidden">
<div style="position:absolute;left:0px;top:0px">
<img src="e698b76e-46bd-11eb-8b25-0cc47a792c0a_id_e698b76e-46bd-11eb-8b25-0cc47a792c0a_files/background336.jpg" width=504 height=666></div>
<div style="position:absolute;left:138.00px;top:42.28px" class="cls_007"><span class="cls_007">The from-space again appears at the top of the diagram and the to-</span></div>
<div style="position:absolute;left:120.00px;top:54.28px" class="cls_007"><span class="cls_007">space below. Notice how the live objects are copied down into the to-space.</span></div>
<div style="position:absolute;left:120.00px;top:66.28px" class="cls_007"><span class="cls_007">The arrows pointing down indicate this copying process. A pointer similar</span></div>
<div style="position:absolute;left:120.00px;top:78.28px" class="cls_007"><span class="cls_007">to the one used for bump allocation keeps track of where the next live</span></div>
<div style="position:absolute;left:120.00px;top:90.28px" class="cls_007"><span class="cls_007">object should be copied to.</span></div>
<div style="position:absolute;left:138.00px;top:102.28px" class="cls_007"><span class="cls_007">Once the copying process is finished, the semi-space algorithm swaps</span></div>
<div style="position:absolute;left:120.00px;top:114.28px" class="cls_007"><span class="cls_007">heaps, as shown in Figure 12-12.</span></div>
<div style="position:absolute;left:319.00px;top:135.71px" class="cls_217"><span class="cls_217">next</span></div>
<div style="position:absolute;left:309.33px;top:145.17px" class="cls_217"><span class="cls_217">allocation</span></div>
<div style="position:absolute;left:120.00px;top:180.86px" class="cls_217"><span class="cls_217">From-Space</span></div>
<div style="position:absolute;left:129.02px;top:228.95px" class="cls_217"><span class="cls_217">To-Space</span></div>
<div style="position:absolute;left:120.00px;top:251.99px" class="cls_038"><span class="cls_038">Figure 12-12: After copying the live objects, the semi-space algorithm switches heaps.</span></div>
<div style="position:absolute;left:138.00px;top:280.49px" class="cls_007"><span class="cls_007">In Figure 12-12, the to-space has become the new from-space and is</span></div>
<div style="position:absolute;left:120.00px;top:292.49px" class="cls_007"><span class="cls_007">now ready to allocate more memory for new objects using bump alloca-</span></div>
<div style="position:absolute;left:120.00px;top:304.49px" class="cls_007"><span class="cls_007">tion. You might expect the algorithm to be slow because so much copying</span></div>
<div style="position:absolute;left:120.00px;top:316.49px" class="cls_007"><span class="cls_007">is involved, but it’s not, because only active, live objects are copied. Garbage</span></div>
<div style="position:absolute;left:120.00px;top:328.49px" class="cls_007"><span class="cls_007">objects are left in place and then reclaimed.</span></div>
<div style="position:absolute;left:78.00px;top:354.99px" class="cls_032"><span class="cls_032">Note</span></div>
<div style="position:absolute;left:120.00px;top:352.49px" class="cls_008"><span class="cls_008">All of the live objects were copied to the left side of the heap; this allows the garbage</span></div>
<div style="position:absolute;left:120.00px;top:364.49px" class="cls_008"><span class="cls_008">collector to allocate the remaining unused memory most efficiently. This compaction</span></div>
<div style="position:absolute;left:120.00px;top:376.49px" class="cls_008"><span class="cls_008">of the heap is a natural result of the semi-space algorithm.</span></div>
<div style="position:absolute;left:138.00px;top:400.49px" class="cls_007"><span class="cls_007">While the semi-space algorithm is an elegant way to manage memory,</span></div>
<div style="position:absolute;left:120.00px;top:412.49px" class="cls_007"><span class="cls_007">it is somewhat memory inefficient. It requires the collector to allocate</span></div>
<div style="position:absolute;left:120.00px;top:424.49px" class="cls_007"><span class="cls_007">twice as much memory as it actually uses because all of your objects might</span></div>
<div style="position:absolute;left:120.00px;top:436.49px" class="cls_007"><span class="cls_007">remain active and could be copied into the second heap. The algorithm is</span></div>
<div style="position:absolute;left:120.00px;top:448.49px" class="cls_007"><span class="cls_007">also somewhat difficult to implement because when the collector moves live</span></div>
<div style="position:absolute;left:120.00px;top:460.49px" class="cls_007"><span class="cls_007">objects, it also has to update references and pointers to them internally.</span></div>
<div style="position:absolute;left:120.00px;top:485.49px" class="cls_055"><span class="cls_055">The Eden Heap</span></div>
<div style="position:absolute;left:120.00px;top:503.49px" class="cls_007"><span class="cls_007">As it turns out, both Rubinius and the JVM use a variation of the semi-</span></div>
<div style="position:absolute;left:120.00px;top:515.49px" class="cls_007"><span class="cls_007">space algorithm with a third heap structure for allocating new objects</span></div>
<div style="position:absolute;left:120.00px;top:527.49px" class="cls_007"><span class="cls_007">called the </span><span class="cls_008">Garden of Eden,</span><span class="cls_007"> or </span><span class="cls_008">Eden heap</span><span class="cls_007">. Figure 12-13 shows the three mem-</span></div>
<div style="position:absolute;left:119.99px;top:539.49px" class="cls_007"><span class="cls_007">ory structures.</span></div>
<div style="position:absolute;left:48.00px;top:633.00px" class="cls_020"><span class="cls_020">312</span></div>
<div style="position:absolute;left:73.69px;top:636.00px" class="cls_021"><span class="cls_021">Chapter 12</span></div>
</div>
<div style="position:absolute;left:50%;margin-left:-252px;top:223756px;width:504px;height:666px;border-style:outset;overflow:hidden">
<div style="position:absolute;left:0px;top:0px">
<img src="e698b76e-46bd-11eb-8b25-0cc47a792c0a_id_e698b76e-46bd-11eb-8b25-0cc47a792c0a_files/background337.jpg" width=504 height=666></div>
<div style="position:absolute;left:167.06px;top:44.02px" class="cls_216"><span class="cls_216">next</span></div>
<div style="position:absolute;left:157.25px;top:53.62px" class="cls_216"><span class="cls_216">allocation</span></div>
<div style="position:absolute;left:124.65px;top:90.65px" class="cls_216"><span class="cls_216">Eden Heap</span></div>
<div style="position:absolute;left:123.00px;top:137.57px" class="cls_216"><span class="cls_216">From-Space</span></div>
<div style="position:absolute;left:131.89px;top:184.50px" class="cls_216"><span class="cls_216">To-Space</span></div>
<div style="position:absolute;left:123.00px;top:206.92px" class="cls_038"><span class="cls_038">Figure 12-13: The Eden heap is for allocating memory for brand-new objects.</span></div>
<div style="position:absolute;left:141.00px;top:229.42px" class="cls_007"><span class="cls_007">The Eden heap is where the JVM and Rubinius allocate memory for</span></div>
<div style="position:absolute;left:123.00px;top:241.42px" class="cls_007"><span class="cls_007">new objects; the from-space contains all of the live objects copied in the</span></div>
<div style="position:absolute;left:123.00px;top:253.42px" class="cls_007"><span class="cls_007">previous garbage collection process; and the to-space remains empty until</span></div>
<div style="position:absolute;left:123.00px;top:265.42px" class="cls_007"><span class="cls_007">the next garbage collection runs. Each time the garbage collection process</span></div>
<div style="position:absolute;left:123.00px;top:277.42px" class="cls_007"><span class="cls_007">runs, the collector copies your objects from both the Eden heap and from-</span></div>
<div style="position:absolute;left:123.00px;top:289.42px" class="cls_007"><span class="cls_007">space into the to-space, thereby allowing more memory to be available for</span></div>
<div style="position:absolute;left:123.00px;top:301.42px" class="cls_007"><span class="cls_007">new objects because the Eden heap will always be empty after each semi-</span></div>
<div style="position:absolute;left:123.00px;top:313.42px" class="cls_007"><span class="cls_007">space copy operation.</span></div>
<div style="position:absolute;left:69.00px;top:347.42px" class="cls_031"><span class="cls_031">Generational Garbage Collection</span></div>
<div style="position:absolute;left:123.00px;top:367.42px" class="cls_007"><span class="cls_007">Many modern garbage collectors, including the collectors in the JVM and</span></div>
<div style="position:absolute;left:123.00px;top:379.42px" class="cls_007"><span class="cls_007">the Rubinius VM, use </span><span class="cls_008">generational GC</span><span class="cls_007"> algorithms, a technique that treats new</span></div>
<div style="position:absolute;left:123.00px;top:391.42px" class="cls_007"><span class="cls_007">objects differently than older ones. A new, or </span><span class="cls_008">young</span><span class="cls_007">, object is one that your</span></div>
<div style="position:absolute;left:123.00px;top:403.42px" class="cls_007"><span class="cls_007">program has just created, while an old, or </span><span class="cls_008">mature</span><span class="cls_007">, object is one that your pro-</span></div>
<div style="position:absolute;left:123.01px;top:415.42px" class="cls_007"><span class="cls_007">gram is continuing to use. The time that an object has to remain active for in</span></div>
<div style="position:absolute;left:123.01px;top:427.42px" class="cls_007"><span class="cls_007">order for it to be considered mature is usually measured by the number of</span></div>
<div style="position:absolute;left:123.01px;top:439.42px" class="cls_007"><span class="cls_007">times the garbage collection system has run.</span></div>
<div style="position:absolute;left:123.00px;top:464.42px" class="cls_055"><span class="cls_055">The Weak Generational Hypothesis</span></div>
<div style="position:absolute;left:123.00px;top:482.42px" class="cls_007"><span class="cls_007">The reason objects are categorized as either young or mature is based on</span></div>
<div style="position:absolute;left:123.00px;top:494.42px" class="cls_007"><span class="cls_007">the assumption that most young objects will have a short lifetime while</span></div>
<div style="position:absolute;left:123.00px;top:506.42px" class="cls_007"><span class="cls_007">mature objects are likely to continue to live for a long time. This assump-</span></div>
<div style="position:absolute;left:123.00px;top:518.42px" class="cls_007"><span class="cls_007">tion is known as the </span><span class="cls_008">weak generational hypothesis</span><span class="cls_007">. In simple terms, new objects</span></div>
<div style="position:absolute;left:123.00px;top:530.42px" class="cls_007"><span class="cls_007">are likely to die young. Because young and mature objects have different</span></div>
<div style="position:absolute;left:123.00px;top:542.42px" class="cls_007"><span class="cls_007">life expectancies, different GC algorithms are appropriate for each cat-</span></div>
<div style="position:absolute;left:123.00px;top:554.42px" class="cls_007"><span class="cls_007">egory, or </span><span class="cls_008">generation</span><span class="cls_007">.</span></div>
<div style="position:absolute;left:302.31px;top:636.00px" class="cls_021"><span class="cls_021">Garbage Collection in MRI, JRuby, and Rubinius</span></div>
<div style="position:absolute;left:443.25px;top:633.00px" class="cls_020"><span class="cls_020">313</span></div>
</div>
<div style="position:absolute;left:50%;margin-left:-252px;top:224432px;width:504px;height:666px;border-style:outset;overflow:hidden">
<div style="position:absolute;left:0px;top:0px">
<img src="e698b76e-46bd-11eb-8b25-0cc47a792c0a_id_e698b76e-46bd-11eb-8b25-0cc47a792c0a_files/background338.jpg" width=504 height=666></div>
<div style="position:absolute;left:138.00px;top:42.28px" class="cls_007"><span class="cls_007">For example, consider a Ruby on Rails website. To generate a web page</span></div>
<div style="position:absolute;left:120.00px;top:54.28px" class="cls_007"><span class="cls_007">for each client request, a Rails application creates many new Ruby objects.</span></div>
<div style="position:absolute;left:120.00px;top:66.28px" class="cls_007"><span class="cls_007">However, once a web page has been generated and returned to the client,</span></div>
<div style="position:absolute;left:120.00px;top:78.28px" class="cls_007"><span class="cls_007">all of those Ruby objects are no longer needed and the GC system can</span></div>
<div style="position:absolute;left:120.00px;top:90.28px" class="cls_007"><span class="cls_007">reclaim their memory. At the same time, the application might also create a</span></div>
<div style="position:absolute;left:120.00px;top:102.28px" class="cls_007"><span class="cls_007">few Ruby objects that live between requests, such as ones that represent a</span></div>
<div style="position:absolute;left:120.00px;top:114.28px" class="cls_007"><span class="cls_007">controller, some configuration data, or a user session. These few mature</span></div>
<div style="position:absolute;left:120.00px;top:126.28px" class="cls_007"><span class="cls_007">objects would have a longer lifetime.</span></div>
<div style="position:absolute;left:120.00px;top:151.28px" class="cls_055"><span class="cls_055">Using the Semi-Space Algorithm for Young Objects</span></div>
<div style="position:absolute;left:120.00px;top:169.28px" class="cls_007"><span class="cls_007">According to the weak generational hypothesis, young objects are created</span></div>
<div style="position:absolute;left:120.00px;top:181.28px" class="cls_007"><span class="cls_007">continually by your program but also become garbage quite frequently.</span></div>
<div style="position:absolute;left:120.00px;top:193.28px" class="cls_007"><span class="cls_007">Because of this, both the JVM and Rubinius run the GC process more fre-</span></div>
<div style="position:absolute;left:120.00px;top:205.28px" class="cls_007"><span class="cls_007">quently for young objects than for mature ones (you’ll see just how much</span></div>
<div style="position:absolute;left:120.00px;top:217.28px" class="cls_007"><span class="cls_007">more frequently in Experiment 12-2). The semi-space algorithm is ideal</span></div>
<div style="position:absolute;left:120.00px;top:229.28px" class="cls_007"><span class="cls_007">for young objects because it copies only live objects. When the Eden heap</span></div>
<div style="position:absolute;left:120.00px;top:241.28px" class="cls_007"><span class="cls_007">fills up with new objects, the garbage collector identifies most of them as</span></div>
<div style="position:absolute;left:120.00px;top:253.28px" class="cls_007"><span class="cls_007">garbage because new objects usually die young. Because there are fewer live</span></div>
<div style="position:absolute;left:120.00px;top:265.28px" class="cls_007"><span class="cls_007">objects, the collector has less copying to do. The JVM refers to these objects</span></div>
<div style="position:absolute;left:120.00px;top:277.28px" class="cls_007"><span class="cls_007">as </span><span class="cls_008">survivors</span><span class="cls_007"> and calls the from-space and the to-space </span><span class="cls_008">survivor spaces</span><span class="cls_007">.</span></div>
<div style="position:absolute;left:120.00px;top:302.28px" class="cls_055"><span class="cls_055">Promoting Objects</span></div>
<div style="position:absolute;left:120.00px;top:320.28px" class="cls_007"><span class="cls_007">When a new object becomes old (that is, when it has survived a certain number</span></div>
<div style="position:absolute;left:120.00px;top:332.28px" class="cls_007"><span class="cls_007">of runs of the GC system), it is </span><span class="cls_008">promoted</span><span class="cls_007">, or copied, into the mature genera-</span></div>
<div style="position:absolute;left:120.01px;top:344.28px" class="cls_007"><span class="cls_007">tion heap during the semi-space copy process, as shown in Figure 12-14.</span></div>
<div style="position:absolute;left:209.68px;top:365.70px" class="cls_054"><span class="cls_054">promoted</span></div>
<div style="position:absolute;left:407.04px;top:365.70px" class="cls_054"><span class="cls_054">promoted</span></div>
<div style="position:absolute;left:120.00px;top:401.24px" class="cls_054"><span class="cls_054">From-Space</span></div>
<div style="position:absolute;left:129.15px;top:450.04px" class="cls_054"><span class="cls_054">To-Space</span></div>
<div style="position:absolute;left:120.00px;top:472.06px" class="cls_038"><span class="cls_038">Figure 12-14: Generational garbage collectors promote old objects from the young heap</span></div>
<div style="position:absolute;left:120.00px;top:482.56px" class="cls_038"><span class="cls_038">to the mature one.</span></div>
<div style="position:absolute;left:138.00px;top:505.06px" class="cls_007"><span class="cls_007">Notice that the from-space contains five active objects, shown as</span></div>
<div style="position:absolute;left:120.00px;top:517.06px" class="cls_007"><span class="cls_007">gray rectangles. Two of these are copied down to the to-space by the</span></div>
<div style="position:absolute;left:120.00px;top:529.06px" class="cls_007"><span class="cls_007">semi-space algorithm, but the other three are promoted. Their age has</span></div>
<div style="position:absolute;left:120.00px;top:541.06px" class="cls_007"><span class="cls_007">exceeded the </span><span class="cls_008">new object lifetime</span><span class="cls_007"> because they have remained active for a</span></div>
<div style="position:absolute;left:120.00px;top:553.06px" class="cls_007"><span class="cls_007">certain number of GC runs.</span></div>
<div style="position:absolute;left:48.00px;top:633.00px" class="cls_020"><span class="cls_020">314</span></div>
<div style="position:absolute;left:73.75px;top:636.00px" class="cls_021"><span class="cls_021">Chapter 12</span></div>
</div>
<div style="position:absolute;left:50%;margin-left:-252px;top:225108px;width:504px;height:666px;border-style:outset;overflow:hidden">
<div style="position:absolute;left:0px;top:0px">
<img src="e698b76e-46bd-11eb-8b25-0cc47a792c0a_id_e698b76e-46bd-11eb-8b25-0cc47a792c0a_files/background339.jpg" width=504 height=666></div>
<div style="position:absolute;left:141.00px;top:41.60px" class="cls_007"><span class="cls_007">In Rubinius, the new object lifetime is set to 2 by default, meaning that</span></div>
<div style="position:absolute;left:123.00px;top:53.60px" class="cls_007"><span class="cls_007">a young object becomes mature once the GC system has run twice with your</span></div>
<div style="position:absolute;left:123.00px;top:65.60px" class="cls_007"><span class="cls_007">code still holding a reference to that object. (This means that Rubinius will</span></div>
<div style="position:absolute;left:123.00px;top:77.60px" class="cls_007"><span class="cls_007">copy a live object twice between the from- and to-space, using the semi-space</span></div>
<div style="position:absolute;left:123.00px;top:89.60px" class="cls_007"><span class="cls_007">algorithm.) Over time, Rubinius adjusts the object lifetime value, based on</span></div>
<div style="position:absolute;left:123.00px;top:101.60px" class="cls_007"><span class="cls_007">various statistics, to optimize garbage collection as much as possible.</span></div>
<div style="position:absolute;left:141.00px;top:113.60px" class="cls_007"><span class="cls_007">The JVM’s garbage collector internally calculates the new object life-</span></div>
<div style="position:absolute;left:123.00px;top:125.60px" class="cls_007"><span class="cls_007">time, attempting to keep the from- and to-space heaps about half full.</span></div>
<div style="position:absolute;left:123.00px;top:137.60px" class="cls_007"><span class="cls_007">If these heaps start to fill up, the new object lifetime will decrease, and</span></div>
<div style="position:absolute;left:123.00px;top:149.60px" class="cls_007"><span class="cls_007">objects will be promoted more quickly. If the spaces are mostly empty, the</span></div>
<div style="position:absolute;left:123.00px;top:161.60px" class="cls_007"><span class="cls_007">JVM will increase the new object lifetime, allowing new objects to remain</span></div>
<div style="position:absolute;left:123.00px;top:173.60px" class="cls_007"><span class="cls_007">there longer.</span></div>
<div style="position:absolute;left:123.00px;top:198.60px" class="cls_055"><span class="cls_055">Garbage Collection for Mature Objects</span></div>
<div style="position:absolute;left:123.00px;top:216.60px" class="cls_007"><span class="cls_007">Once your objects are promoted into the mature collection, they will likely</span></div>
<div style="position:absolute;left:123.00px;top:228.60px" class="cls_007"><span class="cls_007">live on for a long time due to the weak generational hypothesis. As a result,</span></div>
<div style="position:absolute;left:123.00px;top:240.60px" class="cls_007"><span class="cls_007">both the JVM and Rubinius need to run garbage collection on the mature</span></div>
<div style="position:absolute;left:123.00px;top:252.60px" class="cls_007"><span class="cls_007">generation much less frequently. Garbage collection on the mature genera-</span></div>
<div style="position:absolute;left:123.00px;top:264.60px" class="cls_007"><span class="cls_007">tion runs once the heap allocated for mature objects fills up. Because most</span></div>
<div style="position:absolute;left:123.00px;top:276.60px" class="cls_007"><span class="cls_007">new objects don’t live past the new object lifetime, the mature collection</span></div>
<div style="position:absolute;left:123.00px;top:288.60px" class="cls_007"><span class="cls_007">fills up slowly.</span></div>
<div style="position:absolute;left:141.00px;top:300.60px" class="cls_007"><span class="cls_007">The JVM offers many command-line options that allow you to configure</span></div>
<div style="position:absolute;left:123.00px;top:312.60px" class="cls_007"><span class="cls_007">the relative or absolute sizes of young and mature generation heaps (the</span></div>
<div style="position:absolute;left:123.00px;top:324.60px" class="cls_007"><span class="cls_007">JVM documentation refers to the mature generation as the </span><span class="cls_008">tenured genera-</span></div>
<div style="position:absolute;left:123.00px;top:336.60px" class="cls_008"><span class="cls_008">tion</span><span class="cls_007">). The JVM also maintains a third generation for internal objects created</span></div>
<div style="position:absolute;left:123.00px;top:348.60px" class="cls_007"><span class="cls_007">by the JVM itself: the </span><span class="cls_008">permanent generation</span><span class="cls_007">. Garbage collection on the young</span></div>
<div style="position:absolute;left:123.00px;top:360.60px" class="cls_007"><span class="cls_007">generation is called a </span><span class="cls_008">minor collection</span><span class="cls_007">, and on the tenured generation, it’s a</span></div>
<div style="position:absolute;left:123.00px;top:372.60px" class="cls_008"><span class="cls_008">major collection</span><span class="cls_007">.</span></div>
<div style="position:absolute;left:141.00px;top:384.60px" class="cls_007"><span class="cls_007">Rubinius uses a sophisticated GC algorithm called </span><span class="cls_008">Immix</span><span class="cls_007"> for the</span></div>
<div style="position:absolute;left:123.00px;top:396.60px" class="cls_007"><span class="cls_007">mature generation of objects. Immix attempts to reduce the amount of</span></div>
<div style="position:absolute;left:123.00px;top:408.60px" class="cls_007"><span class="cls_007">total memory used and the amount of heap fragmentation by collecting</span></div>
<div style="position:absolute;left:123.00px;top:420.60px" class="cls_007"><span class="cls_007">active objects into continuous regions. Rubinius also uses a third genera-</span></div>
<div style="position:absolute;left:123.00px;top:432.60px" class="cls_007"><span class="cls_007">tion for very large objects and collects them using a standard mark-and-</span></div>
<div style="position:absolute;left:123.00px;top:444.60px" class="cls_007"><span class="cls_007">sweep process.</span></div>
<div style="position:absolute;left:81.00px;top:471.10px" class="cls_032"><span class="cls_032">Note</span></div>
<div style="position:absolute;left:123.00px;top:468.60px" class="cls_008"><span class="cls_008">MRI Ruby version 2.1 implements a generational GC algorithm for standard Ruby</span></div>
<div style="position:absolute;left:123.00px;top:480.60px" class="cls_008"><span class="cls_008">like the one the JVM and Rubinius have used for years. Its primary challenge is</span></div>
<div style="position:absolute;left:123.00px;top:492.60px" class="cls_008"><span class="cls_008">also detecting which mature objects reference young ones (see “References Between</span></div>
<div style="position:absolute;left:123.00px;top:504.60px" class="cls_008"><span class="cls_008">Generations” on page 316). MRI uses a solution common to many implementa-</span></div>
<div style="position:absolute;left:123.00px;top:516.60px" class="cls_008"><span class="cls_008">tions of generational GC: it tracks each time a mature object references a young</span></div>
<div style="position:absolute;left:123.00px;top:528.60px" class="cls_008"><span class="cls_008">one using write barriers. However, implementing write barriers in MRI is complex</span></div>
<div style="position:absolute;left:123.00px;top:540.60px" class="cls_008"><span class="cls_008">because existing C extensions won’t contain them.</span></div>
<div style="position:absolute;left:302.36px;top:636.00px" class="cls_021"><span class="cls_021">Garbage Collection in MRI, JRuby, and Rubinius</span></div>
<div style="position:absolute;left:443.30px;top:633.00px" class="cls_020"><span class="cls_020">315</span></div>
</div>
<div style="position:absolute;left:50%;margin-left:-252px;top:225784px;width:504px;height:666px;border-style:outset;overflow:hidden">
<div style="position:absolute;left:0px;top:0px">
<img src="e698b76e-46bd-11eb-8b25-0cc47a792c0a_id_e698b76e-46bd-11eb-8b25-0cc47a792c0a_files/background340.jpg" width=504 height=666></div>
<div style="position:absolute;left:182.31px;top:61.31px" class="cls_020"><span class="cls_020">References Between Generations</span></div>
<div style="position:absolute;left:120.50px;top:79.81px" class="cls_039"><span class="cls_039">In addition to the new object lifetime, generational garbage collectors have to track</span></div>
<div style="position:absolute;left:120.50px;top:91.82px" class="cls_039"><span class="cls_039">another important detail: young objects that are active because of a reference from</span></div>
<div style="position:absolute;left:120.50px;top:103.82px" class="cls_039"><span class="cls_039">an old object. Because collections on the young generation will not mark mature</span></div>
<div style="position:absolute;left:120.50px;top:115.82px" class="cls_039"><span class="cls_039">objects, the collector might assume that certain young objects are garbage when</span></div>
<div style="position:absolute;left:120.50px;top:127.82px" class="cls_039"><span class="cls_039">they are not. Figure 12-15 shows an example of the problem.</span></div>
<div style="position:absolute;left:251.37px;top:218.71px" class="cls_005"><span class="cls_005">?</span></div>
<div style="position:absolute;left:243.45px;top:240.54px" class="cls_054"><span class="cls_054">live or</span></div>
<div style="position:absolute;left:237.23px;top:250.14px" class="cls_054"><span class="cls_054">garbage?</span></div>
<div style="position:absolute;left:173.14px;top:314.11px" class="cls_054"><span class="cls_054">Young Objects</span></div>
<div style="position:absolute;left:319.08px;top:314.11px" class="cls_054"><span class="cls_054">Mature Objects</span></div>
<div style="position:absolute;left:120.50px;top:337.14px" class="cls_043"><span class="cls_043">Figure 12-15: Generational garbage collectors need to find mature objects that</span></div>
<div style="position:absolute;left:120.50px;top:347.64px" class="cls_043"><span class="cls_043">reference young objects.</span></div>
<div style="position:absolute;left:138.50px;top:370.64px" class="cls_039"><span class="cls_039">The young collection contains several live objects (gray) and garbage objects</span></div>
<div style="position:absolute;left:120.50px;top:382.64px" class="cls_039"><span class="cls_039">(white). During the young object marking phase, the generational garbage collec-</span></div>
<div style="position:absolute;left:120.50px;top:394.64px" class="cls_039"><span class="cls_039">tor follows only references from young objects in order to speed up the process,</span></div>
<div style="position:absolute;left:120.50px;top:406.64px" class="cls_039"><span class="cls_039">which occurs frequently. Notice, however, the center object marked with a question</span></div>
<div style="position:absolute;left:120.50px;top:418.64px" class="cls_039"><span class="cls_039">mark: Is it live or garbage? There are no references to it from other young objects,</span></div>
<div style="position:absolute;left:120.50px;top:430.65px" class="cls_039"><span class="cls_039">but there is a reference to it from a mature object. If Rubinius or the JVM were to run</span></div>
<div style="position:absolute;left:120.50px;top:442.65px" class="cls_039"><span class="cls_039">the semi-space algorithm on the young objects at left after marking them, the center</span></div>
<div style="position:absolute;left:120.50px;top:454.65px" class="cls_039"><span class="cls_039">object would be incorrectly considered garbage and its contents overwritten!</span></div>
<div style="position:absolute;left:120.50px;top:480.14px" class="cls_018"><span class="cls_018">Write Barriers</span></div>
<div style="position:absolute;left:120.50px;top:497.64px" class="cls_039"><span class="cls_039">Generational garbage collectors can solve this problem using </span><span class="cls_044">write barriers</span><span class="cls_039">. These</span></div>
<div style="position:absolute;left:120.50px;top:509.64px" class="cls_039"><span class="cls_039">are bits of code that keep track of when your program adds a reference from a</span></div>
<div style="position:absolute;left:120.50px;top:521.64px" class="cls_039"><span class="cls_039">mature object to a young one. When the garbage collector encounters such a</span></div>
<div style="position:absolute;left:120.50px;top:533.64px" class="cls_039"><span class="cls_039">reference, it considers that one mature object to be another root for use in marking</span></div>
<div style="position:absolute;left:120.50px;top:545.64px" class="cls_039"><span class="cls_039">young objects, thereby allowing the object in question to be considered live and</span></div>
<div style="position:absolute;left:120.50px;top:557.65px" class="cls_039"><span class="cls_039">to be copied properly by the semi-space algorithm.</span></div>
<div style="position:absolute;left:48.00px;top:633.00px" class="cls_020"><span class="cls_020">316</span></div>
<div style="position:absolute;left:73.77px;top:636.00px" class="cls_021"><span class="cls_021">Chapter 12</span></div>
</div>
<div style="position:absolute;left:50%;margin-left:-252px;top:226460px;width:504px;height:666px;border-style:outset;overflow:hidden">
<div style="position:absolute;left:0px;top:0px">
<img src="e698b76e-46bd-11eb-8b25-0cc47a792c0a_id_e698b76e-46bd-11eb-8b25-0cc47a792c0a_files/background341.jpg" width=504 height=666></div>
<div style="position:absolute;left:69.00px;top:42.05px" class="cls_031"><span class="cls_031">Concurrent Garbage Collection</span></div>
<div style="position:absolute;left:123.00px;top:62.05px" class="cls_007"><span class="cls_007">Both Rubinius and the JVM use another sophisticated technique to reduce</span></div>
<div style="position:absolute;left:123.00px;top:74.05px" class="cls_007"><span class="cls_007">the amount of time your application spends waiting for garbage collection:</span></div>
<div style="position:absolute;left:123.00px;top:86.05px" class="cls_008"><span class="cls_008">concurrent garbage collection</span><span class="cls_007">. When using concurrent garbage collection,</span></div>
<div style="position:absolute;left:123.00px;top:98.05px" class="cls_007"><span class="cls_007">the garbage collector runs at the same time as your application code. This</span></div>
<div style="position:absolute;left:123.00px;top:110.05px" class="cls_007"><span class="cls_007">eliminates, or at least reduces, pauses in your program due to garbage col-</span></div>
<div style="position:absolute;left:123.00px;top:122.05px" class="cls_007"><span class="cls_007">lection because your application doesn’t have to stop and wait while the</span></div>
<div style="position:absolute;left:123.00px;top:134.05px" class="cls_007"><span class="cls_007">garbage collector runs.</span></div>
<div style="position:absolute;left:141.00px;top:146.05px" class="cls_007"><span class="cls_007">Concurrent garbage collectors run in a separate thread from the pri-</span></div>
<div style="position:absolute;left:123.00px;top:158.05px" class="cls_007"><span class="cls_007">mary application. Although in theory this could mean that your application</span></div>
<div style="position:absolute;left:123.00px;top:170.05px" class="cls_007"><span class="cls_007">will slow a bit because part of the CPU’s time has to be spent running the</span></div>
<div style="position:absolute;left:123.00px;top:182.05px" class="cls_007"><span class="cls_007">GC thread, most computers today contain microprocessors with multiple</span></div>
<div style="position:absolute;left:123.00px;top:194.05px" class="cls_007"><span class="cls_007">cores, which allow different threads to run in parallel. This means one of</span></div>
<div style="position:absolute;left:123.00px;top:206.05px" class="cls_007"><span class="cls_007">the cores can be dedicated to running the GC thread, leaving the other cores</span></div>
<div style="position:absolute;left:123.00px;top:218.05px" class="cls_007"><span class="cls_007">to run the primary application. (In practice, this still might slow down your</span></div>
<div style="position:absolute;left:123.00px;top:230.05px" class="cls_007"><span class="cls_007">application because fewer cores are available.)</span></div>
<div style="position:absolute;left:81.00px;top:256.55px" class="cls_032"><span class="cls_032">Note</span></div>
<div style="position:absolute;left:123.00px;top:254.05px" class="cls_008"><span class="cls_008">MRI Ruby 2.1 also supports a form of concurrent garbage collection by performing</span></div>
<div style="position:absolute;left:123.00px;top:266.05px" class="cls_008"><span class="cls_008">the sweep portion of the mark-and-sweep algorithm in parallel while your Ruby code</span></div>
<div style="position:absolute;left:123.00px;top:278.05px" class="cls_008"><span class="cls_008">continues to run. This helps to reduce the amount of time your application is paused</span></div>
<div style="position:absolute;left:123.00px;top:290.05px" class="cls_008"><span class="cls_008">while garbage collection runs.</span></div>
<div style="position:absolute;left:123.00px;top:327.05px" class="cls_055"><span class="cls_055">Marking While the Object Graph Changes</span></div>
<div style="position:absolute;left:123.00px;top:345.05px" class="cls_007"><span class="cls_007">Marking objects while your applica-</span></div>
<div style="position:absolute;left:366.54px;top:353.02px" class="cls_054"><span class="cls_054">M</span></div>
<div style="position:absolute;left:123.00px;top:357.05px" class="cls_007"><span class="cls_007">tion is running presents one large</span></div>
<div style="position:absolute;left:441.72px;top:366.81px" class="cls_054"><span class="cls_054">M</span></div>
<div style="position:absolute;left:123.00px;top:369.05px" class="cls_007"><span class="cls_007">obstacle for concurrent garbage</span></div>
<div style="position:absolute;left:123.00px;top:381.05px" class="cls_007"><span class="cls_007">collectors: What if your application</span></div>
<div style="position:absolute;left:123.00px;top:393.05px" class="cls_007"><span class="cls_007">changes the object graph while the</span></div>
<div style="position:absolute;left:324.23px;top:400.38px" class="cls_054"><span class="cls_054">M</span></div>
<div style="position:absolute;left:123.00px;top:405.05px" class="cls_007"><span class="cls_007">collector is marking it? To better</span></div>
<div style="position:absolute;left:123.00px;top:417.05px" class="cls_007"><span class="cls_007">understand this problem, see the</span></div>
<div style="position:absolute;left:123.00px;top:429.05px" class="cls_007"><span class="cls_007">example object graph in Figure 12-16.</span></div>
<div style="position:absolute;left:141.00px;top:441.05px" class="cls_007"><span class="cls_007">This figure shows a small set of</span></div>
<div style="position:absolute;left:123.00px;top:453.05px" class="cls_007"><span class="cls_007">objects being marked by a concur-</span></div>
<div style="position:absolute;left:123.00px;top:465.05px" class="cls_007"><span class="cls_007">rent garbage collector. On the left</span></div>
<div style="position:absolute;left:366.54px;top:467.85px" class="cls_054"><span class="cls_054">M</span></div>
<div style="position:absolute;left:123.00px;top:477.05px" class="cls_007"><span class="cls_007">is a root object, and to the right are</span></div>
<div style="position:absolute;left:123.00px;top:489.05px" class="cls_007"><span class="cls_007">various child objects referenced by</span></div>
<div style="position:absolute;left:123.00px;top:501.05px" class="cls_007"><span class="cls_007">the root object. All of the live objects</span></div>
<div style="position:absolute;left:123.00px;top:513.05px" class="cls_007"><span class="cls_007">are marked with </span><span class="cls_008">M</span><span class="cls_007"> and shown in</span></div>
<div style="position:absolute;left:123.00px;top:525.05px" class="cls_007"><span class="cls_007">gray. The garbage collector, indi-</span></div>
<div style="position:absolute;left:123.00px;top:537.05px" class="cls_007"><span class="cls_007">cated by the large arrow, has already</span></div>
<div style="position:absolute;left:307.89px;top:540.80px" class="cls_054"><span class="cls_054">Garbage</span></div>
<div style="position:absolute;left:123.00px;top:549.05px" class="cls_007"><span class="cls_007">marked the live objects and is now</span></div>
<div style="position:absolute;left:308.37px;top:550.40px" class="cls_054"><span class="cls_054">Collector</span></div>
<div style="position:absolute;left:123.00px;top:561.05px" class="cls_007"><span class="cls_007">processing the objects near the bot-</span></div>
<div style="position:absolute;left:307.95px;top:570.53px" class="cls_038"><span class="cls_038">Figure 12-16: A garbage collector</span></div>
<div style="position:absolute;left:123.00px;top:573.05px" class="cls_007"><span class="cls_007">tom. The collector is about to mark</span></div>
<div style="position:absolute;left:307.95px;top:581.03px" class="cls_038"><span class="cls_038">marking an object graph</span></div>
<div style="position:absolute;left:123.00px;top:585.05px" class="cls_007"><span class="cls_007">the two remaining white objects at the</span></div>
<div style="position:absolute;left:123.00px;top:597.05px" class="cls_007"><span class="cls_007">bottom right.</span></div>
<div style="position:absolute;left:302.34px;top:636.00px" class="cls_021"><span class="cls_021">Garbage Collection in MRI, JRuby, and Rubinius</span></div>
<div style="position:absolute;left:443.28px;top:633.00px" class="cls_020"><span class="cls_020">317</span></div>
</div>
<div style="position:absolute;left:50%;margin-left:-252px;top:227136px;width:504px;height:666px;border-style:outset;overflow:hidden">
<div style="position:absolute;left:0px;top:0px">
<img src="e698b76e-46bd-11eb-8b25-0cc47a792c0a_id_e698b76e-46bd-11eb-8b25-0cc47a792c0a_files/background342.jpg" width=504 height=666></div>
<div style="position:absolute;left:138.00px;top:42.28px" class="cls_007"><span class="cls_007">Now suppose your application, which is also running while the marking</span></div>
<div style="position:absolute;left:120.00px;top:54.28px" class="cls_007"><span class="cls_007">process is underway, creates a new object and adds it as a child of one of the</span></div>
<div style="position:absolute;left:120.00px;top:66.28px" class="cls_007"><span class="cls_007">previously marked objects. Figure 12-17 shows the new situation.</span></div>
<div style="position:absolute;left:178.76px;top:87.71px" class="cls_128"><span class="cls_128">M</span></div>
<div style="position:absolute;left:254.17px;top:101.37px" class="cls_128"><span class="cls_128">M</span></div>
<div style="position:absolute;left:137.85px;top:134.59px" class="cls_128"><span class="cls_128">M</span></div>
<div style="position:absolute;left:306.98px;top:147.64px" class="cls_128"><span class="cls_128">New Object</span></div>
<div style="position:absolute;left:178.76px;top:201.39px" class="cls_128"><span class="cls_128">M</span></div>
<div style="position:absolute;left:120.00px;top:271.51px" class="cls_128"><span class="cls_128">Garbage</span></div>
<div style="position:absolute;left:120.47px;top:281.02px" class="cls_128"><span class="cls_128">Collector</span></div>
<div style="position:absolute;left:120.00px;top:299.25px" class="cls_038"><span class="cls_038">Figure 12-17: Your application creates a new object while the</span></div>
<div style="position:absolute;left:120.00px;top:309.75px" class="cls_038"><span class="cls_038">marking process is underway.</span></div>
<div style="position:absolute;left:138.00px;top:332.25px" class="cls_007"><span class="cls_007">Notice that one of the live, marked objects points to a new object that</span></div>
<div style="position:absolute;left:120.00px;top:344.25px" class="cls_007"><span class="cls_007">hasn’t been marked yet.</span></div>
<div style="position:absolute;left:138.00px;top:356.25px" class="cls_007"><span class="cls_007">Now suppose the garbage collector finishes marking the object graph.</span></div>
<div style="position:absolute;left:120.00px;top:368.25px" class="cls_007"><span class="cls_007">It has marked all of the live objects, meaning that any remaining objects are</span></div>
<div style="position:absolute;left:120.00px;top:380.25px" class="cls_007"><span class="cls_007">assumed to be garbage. Figure 12-18 shows how the object graph appears at</span></div>
<div style="position:absolute;left:120.00px;top:392.25px" class="cls_007"><span class="cls_007">the end of the marking process.</span></div>
<div style="position:absolute;left:168.61px;top:413.69px" class="cls_096"><span class="cls_096">M</span></div>
<div style="position:absolute;left:241.96px;top:427.21px" class="cls_096"><span class="cls_096">M</span></div>
<div style="position:absolute;left:127.47px;top:460.10px" class="cls_096"><span class="cls_096">M</span></div>
<div style="position:absolute;left:292.48px;top:471.05px" class="cls_096"><span class="cls_096">Not garbage!</span></div>
<div style="position:absolute;left:220.14px;top:501.72px" class="cls_096"><span class="cls_096">M</span></div>
<div style="position:absolute;left:168.61px;top:526.22px" class="cls_096"><span class="cls_096">M</span></div>
<div style="position:absolute;left:213.74px;top:562.25px" class="cls_096"><span class="cls_096">M</span></div>
<div style="position:absolute;left:120.00px;top:601.49px" class="cls_038"><span class="cls_038">Figure 12-18: The collector incorrectly considers the new live</span></div>
<div style="position:absolute;left:120.00px;top:611.99px" class="cls_038"><span class="cls_038">object to be garbage.</span></div>
<div style="position:absolute;left:48.00px;top:633.00px" class="cls_020"><span class="cls_020">318</span></div>
<div style="position:absolute;left:73.81px;top:636.00px" class="cls_021"><span class="cls_021">Chapter 12</span></div>
</div>
<div style="position:absolute;left:50%;margin-left:-252px;top:227812px;width:504px;height:666px;border-style:outset;overflow:hidden">
<div style="position:absolute;left:0px;top:0px">
<img src="e698b76e-46bd-11eb-8b25-0cc47a792c0a_id_e698b76e-46bd-11eb-8b25-0cc47a792c0a_files/background343.jpg" width=504 height=666></div>
<div style="position:absolute;left:141.00px;top:41.60px" class="cls_007"><span class="cls_007">The garbage collector has finished marking all live objects, but it</span></div>
<div style="position:absolute;left:123.00px;top:53.60px" class="cls_007"><span class="cls_007">missed the new object. The collector will now reclaim its memory, but the</span></div>
<div style="position:absolute;left:123.00px;top:65.60px" class="cls_007"><span class="cls_007">application will have lost valid data or will have garbage data added to one</span></div>
<div style="position:absolute;left:123.00px;top:77.60px" class="cls_007"><span class="cls_007">of its objects!</span></div>
<div style="position:absolute;left:123.00px;top:102.60px" class="cls_055"><span class="cls_055">Tricolor Marking</span></div>
<div style="position:absolute;left:123.00px;top:120.60px" class="cls_007"><span class="cls_007">The solution to this problem is to maintain a </span><span class="cls_008">mark stack</span><span class="cls_007">, or a list of objects that</span></div>
<div style="position:absolute;left:123.00px;top:132.60px" class="cls_007"><span class="cls_007">still need to be examined by the marking process, as shown in Figure 12-19.</span></div>
<div style="position:absolute;left:214.99px;top:154.02px" class="cls_054"><span class="cls_054">Garbage</span></div>
<div style="position:absolute;left:215.47px;top:163.62px" class="cls_054"><span class="cls_054">Collector</span></div>
<div style="position:absolute;left:131.73px;top:208.09px" class="cls_054"><span class="cls_054">M      M</span></div>
<div style="position:absolute;left:123.00px;top:245.69px" class="cls_054"><span class="cls_054">Marked Objects</span></div>
<div style="position:absolute;left:241.44px;top:245.69px" class="cls_054"><span class="cls_054">Mark Stack</span></div>
<div style="position:absolute;left:354.16px;top:245.69px" class="cls_054"><span class="cls_054">Remaining Objects</span></div>
<div style="position:absolute;left:123.00px;top:264.04px" class="cls_038"><span class="cls_038">Figure 12-19: The marking process works through the objects in the mark stack.</span></div>
<div style="position:absolute;left:141.00px;top:286.54px" class="cls_007"><span class="cls_007">Initially all of the root objects are placed on the mark stack. As the</span></div>
<div style="position:absolute;left:123.00px;top:298.54px" class="cls_007"><span class="cls_007">garbage collector marks objects, it moves them from the mark stack to the</span></div>
<div style="position:absolute;left:123.00px;top:310.54px" class="cls_007"><span class="cls_007">list of marked objects on the left, and it adds any child objects it finds to</span></div>
<div style="position:absolute;left:123.00px;top:322.54px" class="cls_007"><span class="cls_007">the mark stack. When the mark stack is exhausted, the garbage collector is</span></div>
<div style="position:absolute;left:123.00px;top:334.54px" class="cls_007"><span class="cls_007">finished; it has identified all live objects and any remaining objects on the</span></div>
<div style="position:absolute;left:123.00px;top:346.54px" class="cls_007"><span class="cls_007">right are assumed to be garbage. But with this scheme, if the application</span></div>
<div style="position:absolute;left:123.00px;top:358.54px" class="cls_007"><span class="cls_007">modifies one of the objects during marking, the collector can move the</span></div>
<div style="position:absolute;left:123.00px;top:370.54px" class="cls_007"><span class="cls_007">modified object back to the mark stack, even if it was previously marked,</span></div>
<div style="position:absolute;left:123.00px;top:382.54px" class="cls_007"><span class="cls_007">as shown in Figure 12-20.</span></div>
<div style="position:absolute;left:210.64px;top:403.95px" class="cls_054"><span class="cls_054">Garbage</span></div>
<div style="position:absolute;left:211.12px;top:413.55px" class="cls_054"><span class="cls_054">Collector</span></div>
<div style="position:absolute;left:392.01px;top:420.89px" class="cls_054"><span class="cls_054">New Object</span></div>
<div style="position:absolute;left:131.72px;top:458.84px" class="cls_054"><span class="cls_054">M</span></div>
<div style="position:absolute;left:123.00px;top:523.63px" class="cls_054"><span class="cls_054">Marked Objects</span></div>
<div style="position:absolute;left:252.94px;top:523.63px" class="cls_054"><span class="cls_054">Mark Stack</span></div>
<div style="position:absolute;left:380.76px;top:523.63px" class="cls_054"><span class="cls_054">Remaining Objects</span></div>
<div style="position:absolute;left:123.00px;top:541.97px" class="cls_038"><span class="cls_038">Figure 12-20: The collector moves a marked object back to the mark stack because the</span></div>
<div style="position:absolute;left:123.00px;top:552.47px" class="cls_038"><span class="cls_038">application modified it.</span></div>
<div style="position:absolute;left:141.00px;top:574.97px" class="cls_007"><span class="cls_007">The application has added a new object to the system, as shown at</span></div>
<div style="position:absolute;left:123.00px;top:586.97px" class="cls_007"><span class="cls_007">right in the figure’s remaining objects list. This time, however, the collec-</span></div>
<div style="position:absolute;left:123.00px;top:598.97px" class="cls_007"><span class="cls_007">tor notices that an existing object was modified because it now contains a</span></div>
<div style="position:absolute;left:302.32px;top:636.00px" class="cls_021"><span class="cls_021">Garbage Collection in MRI, JRuby, and Rubinius</span></div>
<div style="position:absolute;left:443.27px;top:633.00px" class="cls_020"><span class="cls_020">319</span></div>
</div>
<div style="position:absolute;left:50%;margin-left:-252px;top:228488px;width:504px;height:666px;border-style:outset;overflow:hidden">
<div style="position:absolute;left:0px;top:0px">
<img src="e698b76e-46bd-11eb-8b25-0cc47a792c0a_id_e698b76e-46bd-11eb-8b25-0cc47a792c0a_files/background344.jpg" width=504 height=666></div>
<div style="position:absolute;left:120.00px;top:42.28px" class="cls_007"><span class="cls_007">reference to the new object and it moves the modified object to the mark</span></div>
<div style="position:absolute;left:120.00px;top:54.28px" class="cls_007"><span class="cls_007">stack in the center. As a result, the collector will eventually find and mark</span></div>
<div style="position:absolute;left:120.00px;top:66.28px" class="cls_007"><span class="cls_007">the new object as it works through the mark stack.</span></div>
<div style="position:absolute;left:138.00px;top:78.28px" class="cls_007"><span class="cls_007">This modified marking algorithm is known as </span><span class="cls_008">tricolor marking</span><span class="cls_007">: Objects</span></div>
<div style="position:absolute;left:120.00px;top:90.28px" class="cls_007"><span class="cls_007">already processed are considered “black”; objects on the mark stack, “gray”;</span></div>
<div style="position:absolute;left:120.00px;top:102.28px" class="cls_007"><span class="cls_007">and the remaining objects, “white,” as shown in Figures 12-19 and 12-20.</span></div>
<div style="position:absolute;left:78.00px;top:128.78px" class="cls_032"><span class="cls_032">Note</span></div>
<div style="position:absolute;left:120.00px;top:126.28px" class="cls_008"><span class="cls_008">Concurrent garbage collectors can use write barriers to detect when an application</span></div>
<div style="position:absolute;left:120.00px;top:138.28px" class="cls_008"><span class="cls_008">changes the object graph. Write barriers are used by both generational and concurrent</span></div>
<div style="position:absolute;left:120.00px;top:150.28px" class="cls_008"><span class="cls_008">garbage collectors.</span></div>
<div style="position:absolute;left:120.00px;top:175.28px" class="cls_055"><span class="cls_055">Three Garbage Collectors in the JVM</span></div>
<div style="position:absolute;left:120.00px;top:193.28px" class="cls_007"><span class="cls_007">In order to support different types of applications and server hardware, the</span></div>
<div style="position:absolute;left:120.00px;top:205.28px" class="cls_007"><span class="cls_007">JVM includes three separate garbage collectors that implement concurrent</span></div>
<div style="position:absolute;left:120.00px;top:217.28px" class="cls_007"><span class="cls_007">garbage collection differently. You can use command-line parameters to</span></div>
<div style="position:absolute;left:120.00px;top:229.28px" class="cls_007"><span class="cls_007">choose which collector to run in your JRuby program. The three collectors</span></div>
<div style="position:absolute;left:120.00px;top:241.28px" class="cls_007"><span class="cls_007">are as follows:</span></div>
<div style="position:absolute;left:138.00px;top:259.28px" class="cls_034"><span class="cls_034">Serial</span><span class="cls_007">   This collector stops your application and performs garbage</span></div>
<div style="position:absolute;left:138.00px;top:271.28px" class="cls_007"><span class="cls_007">collection while your application is waiting. It doesn’t use concurrent</span></div>
<div style="position:absolute;left:138.00px;top:283.28px" class="cls_007"><span class="cls_007">garbage collection at all.</span></div>
<div style="position:absolute;left:138.00px;top:298.28px" class="cls_034"><span class="cls_034">Parallel</span><span class="cls_007">   This collector performs many GC tasks, including minor col-</span></div>
<div style="position:absolute;left:138.00px;top:310.28px" class="cls_007"><span class="cls_007">lections, in a separate thread while your application is running.</span></div>
<div style="position:absolute;left:138.00px;top:325.28px" class="cls_034"><span class="cls_034">Concurrent</span><span class="cls_007">   This collector performs most GC tasks in parallel with</span></div>
<div style="position:absolute;left:138.00px;top:337.28px" class="cls_007"><span class="cls_007">your application. It’s optimized to reduce GC pauses as much as pos-</span></div>
<div style="position:absolute;left:138.00px;top:349.28px" class="cls_007"><span class="cls_007">sible, but its use may slow down your application’s overall throughput.</span></div>
<div style="position:absolute;left:78.00px;top:381.78px" class="cls_032"><span class="cls_032">Note</span></div>
<div style="position:absolute;left:120.00px;top:379.28px" class="cls_008"><span class="cls_008">In addition to these three, a variety of new, experimental garbage collectors are also</span></div>
<div style="position:absolute;left:120.00px;top:391.28px" class="cls_008"><span class="cls_008">available for the JVM. One of these is the garbage-first (G1) collector, and another is</span></div>
<div style="position:absolute;left:120.00px;top:403.28px" class="cls_008"><span class="cls_008">the continuously concurrent compacting (C4) collector.</span></div>
<div style="position:absolute;left:138.00px;top:427.28px" class="cls_007"><span class="cls_007">Unless you direct it to do otherwise, the JVM automatically selects</span></div>
<div style="position:absolute;left:120.00px;top:439.28px" class="cls_007"><span class="cls_007">one of these garbage collectors, depending on the type of hardware being</span></div>
<div style="position:absolute;left:120.00px;top:451.28px" class="cls_007"><span class="cls_007">used. For most computers, the JVM uses the parallel collector by default;</span></div>
<div style="position:absolute;left:120.00px;top:463.28px" class="cls_007"><span class="cls_007">for server-class machines, it uses the concurrent collector instead. You can</span></div>
<div style="position:absolute;left:120.00px;top:475.28px" class="cls_007"><span class="cls_007">change the JVM’s default garbage collection choice by using command-</span></div>
<div style="position:absolute;left:120.00px;top:487.28px" class="cls_007"><span class="cls_007">line options when you start your JRuby program. See the article “Java SE 6</span></div>
<div style="position:absolute;left:120.00px;top:499.28px" class="cls_007"><span class="cls_007">HotSpot Virtual Machine Garbage Collection Tuning” (</span><A HREF="http://www.oracle.com/technetwork/java/javase/gc-tuning-6-140523.html">http://www.oracle</A> </span></div>
<div style="position:absolute;left:120.00px;top:511.28px" class="cls_008"><span class="cls_008">.com/technetwork/java/javase/gc-tuning-6-140523.html</span><span class="cls_007">) for more details.</span></div>
<div style="position:absolute;left:138.00px;top:523.28px" class="cls_007"><span class="cls_007">The ability to choose from these different GC algorithms and to fur-</span></div>
<div style="position:absolute;left:120.00px;top:535.28px" class="cls_007"><span class="cls_007">ther tune the behavior of the collector using many other configuration</span></div>
<div style="position:absolute;left:120.00px;top:547.28px" class="cls_007"><span class="cls_007">options is one of the great benefits of using JRuby. The effectiveness and</span></div>
<div style="position:absolute;left:120.00px;top:559.28px" class="cls_007"><span class="cls_007">performance of a garbage collector depends on your application’s behavior</span></div>
<div style="position:absolute;left:120.00px;top:571.28px" class="cls_007"><span class="cls_007">as well as the underlying algorithms used.</span></div>
<div style="position:absolute;left:48.00px;top:633.00px" class="cls_020"><span class="cls_020">320</span></div>
<div style="position:absolute;left:74.47px;top:636.00px" class="cls_021"><span class="cls_021">Chapter 12</span></div>
</div>
<div style="position:absolute;left:50%;margin-left:-252px;top:229164px;width:504px;height:666px;border-style:outset;overflow:hidden">
<div style="position:absolute;left:0px;top:0px">
<img src="e698b76e-46bd-11eb-8b25-0cc47a792c0a_id_e698b76e-46bd-11eb-8b25-0cc47a792c0a_files/background345.jpg" width=504 height=666></div>
<div style="position:absolute;left:141.00px;top:41.60px" class="cls_007"><span class="cls_007">To help make sense of the myriad GC-related options provided by the</span></div>
<div style="position:absolute;left:123.00px;top:53.60px" class="cls_007"><span class="cls_007">JVM, Charles Nutter, one of the lead developers behind the JRuby project,</span></div>
<div style="position:absolute;left:123.00px;top:65.60px" class="cls_007"><span class="cls_007">suggests using the following rules of thumb:</span></div>
<div style="position:absolute;left:123.00px;top:86.60px" class="cls_050"><span class="cls_050">•</span><span class="cls_007">   When in doubt, stick with the JVM’s default settings. These settings</span></div>
<div style="position:absolute;left:141.00px;top:98.60px" class="cls_007"><span class="cls_007">work well in most cases.</span></div>
<div style="position:absolute;left:123.00px;top:113.60px" class="cls_050"><span class="cls_050">•</span><span class="cls_007">   If you have a lot of data that need to be collected frequently or periodi-</span></div>
<div style="position:absolute;left:141.00px;top:125.60px" class="cls_007"><span class="cls_007">cally, the concurrent or experimental G1 collectors may do a better job</span></div>
<div style="position:absolute;left:141.00px;top:137.60px" class="cls_007"><span class="cls_007">than the parallel collector.</span></div>
<div style="position:absolute;left:123.00px;top:152.60px" class="cls_050"><span class="cls_050">•</span><span class="cls_007">   Try to improve your code so it uses less memory before tuning garbage</span></div>
<div style="position:absolute;left:141.00px;top:164.60px" class="cls_007"><span class="cls_007">collection. Tuning the JVM’s garbage collector when you are allocating</span></div>
<div style="position:absolute;left:141.00px;top:176.60px" class="cls_007"><span class="cls_007">too much memory solves only half the problem.</span></div>
<div style="position:absolute;left:123.00px;top:219.60px" class="cls_031"><span class="cls_031">Experiment 12-2: Using Verbose GC Mode in JRuby</span></div>
<div style="position:absolute;left:123.00px;top:239.60px" class="cls_007"><span class="cls_007">Experiment 12-1 explored garbage collection in MRI. In this experiment,</span></div>
<div style="position:absolute;left:123.00px;top:251.60px" class="cls_007"><span class="cls_007">we’ll see how garbage collection works in JRuby by asking the JVM to display</span></div>
<div style="position:absolute;left:123.00px;top:263.60px" class="cls_007"><span class="cls_007">technical information about what the JVM’s garbage collector is doing.</span></div>
<div style="position:absolute;left:123.00px;top:275.60px" class="cls_007"><span class="cls_007">Listing 12-12 shows the code from Experiment 12-1 that creates 10 Ruby</span></div>
<div style="position:absolute;left:123.00px;top:287.60px" class="cls_007"><span class="cls_007">objects.</span></div>
<div style="position:absolute;left:123.00px;top:311.60px" class="cls_030"><span class="cls_030">10.times do</span></div>
<div style="position:absolute;left:131.50px;top:322.10px" class="cls_030"><span class="cls_030">obj = Object.new</span></div>
<div style="position:absolute;left:123.00px;top:332.60px" class="cls_030"><span class="cls_030">end</span></div>
<div style="position:absolute;left:123.00px;top:355.09px" class="cls_038"><span class="cls_038">Listing 12-12: Creating 10 Ruby objects using </span><span class="cls_014">Object.new</span><span class="cls_038"> </span><span class="cls_039">(jruby-gc.rb)</span></div>
<div style="position:absolute;left:141.00px;top:377.60px" class="cls_007"><span class="cls_007">When we run this simple program using the </span><span class="cls_030">-J-verbose:gc</span><span class="cls_007"> option, the</span></div>
<div style="position:absolute;left:123.00px;top:389.60px" class="cls_007"><span class="cls_007">JVM displays internal debugging information about garbage collection.</span></div>
<div style="position:absolute;left:123.00px;top:401.60px" class="cls_007"><span class="cls_007">Here’s the command to use:</span></div>
<div style="position:absolute;left:123.00px;top:425.60px" class="cls_030"><span class="cls_030">$ </span><span class="cls_040">jruby -J-verbose:gc jruby-gc.rb</span></div>
<div style="position:absolute;left:141.00px;top:448.10px" class="cls_007"><span class="cls_007">But this command doesn’t produce any output. Perhaps we aren’t creat-</span></div>
<div style="position:absolute;left:123.00px;top:460.10px" class="cls_007"><span class="cls_007">ing enough objects to trigger a garbage collection.</span></div>
<div style="position:absolute;left:141.00px;top:472.10px" class="cls_007"><span class="cls_007">Let’s increase the number of new objects to 10 million, as shown in</span></div>
<div style="position:absolute;left:123.00px;top:484.10px" class="cls_007"><span class="cls_007">Listing 12-13.</span></div>
<div style="position:absolute;left:123.00px;top:508.10px" class="cls_030"><span class="cls_030">10000000.times do</span></div>
<div style="position:absolute;left:131.50px;top:518.60px" class="cls_030"><span class="cls_030">obj = Object.new</span></div>
<div style="position:absolute;left:123.00px;top:529.09px" class="cls_030"><span class="cls_030">end</span></div>
<div style="position:absolute;left:123.00px;top:551.59px" class="cls_038"><span class="cls_038">Listing 12-13: Creating 10 million Ruby objects using </span><span class="cls_014">Object.new</span><span class="cls_038"> </span><span class="cls_039">(jruby-gc.rb)</span></div>
<div style="position:absolute;left:301.84px;top:636.00px" class="cls_021"><span class="cls_021">Garbage Collection in MRI, JRuby, and Rubinius</span></div>
<div style="position:absolute;left:442.79px;top:633.00px" class="cls_020"><span class="cls_020">321</span></div>
</div>
<div style="position:absolute;left:50%;margin-left:-252px;top:229840px;width:504px;height:666px;border-style:outset;overflow:hidden">
<div style="position:absolute;left:0px;top:0px">
<img src="e698b76e-46bd-11eb-8b25-0cc47a792c0a_id_e698b76e-46bd-11eb-8b25-0cc47a792c0a_files/background346.jpg" width=504 height=666></div>
<div style="position:absolute;left:138.00px;top:42.28px" class="cls_007"><span class="cls_007">The new output is shown in Listing 12-14.</span></div>
<div style="position:absolute;left:120.00px;top:66.28px" class="cls_030"><span class="cls_030">$ </span><span class="cls_040">jruby -J-verbose:gc jruby-gc.rb</span></div>
<div style="position:absolute;left:120.00px;top:76.78px" class="cls_030"><span class="cls_030">[GC 17024K->1292K(83008K), 0.0072491 secs]</span></div>
<div style="position:absolute;left:120.00px;top:87.28px" class="cls_030"><span class="cls_030">[GC 18316K->1538K(83008K), 0.0091344 secs]</span></div>
<div style="position:absolute;left:120.00px;top:97.77px" class="cls_030"><span class="cls_030">[GC 18562K->1349K(83008K), 0.0006953 secs]</span></div>
<div style="position:absolute;left:120.00px;top:108.27px" class="cls_030"><span class="cls_030">[GC 18373K->1301K(83008K), 0.0006876 secs]</span></div>
<div style="position:absolute;left:120.00px;top:118.77px" class="cls_030"><span class="cls_030">[GC 18325K->1289K(83008K), 0.0004180 secs]</span></div>
<div style="position:absolute;left:120.00px;top:129.26px" class="cls_030"><span class="cls_030">[GC 18313K->1285K(83008K), 0.0006950 secs]</span></div>
<div style="position:absolute;left:120.00px;top:139.76px" class="cls_030"><span class="cls_030">[GC 18309K->1285K(83008K), 0.0006597 secs]</span></div>
<div style="position:absolute;left:120.00px;top:150.26px" class="cls_030"><span class="cls_030">[GC 18309K->1285K(83008K), 0.0007186 secs]</span></div>
<div style="position:absolute;left:120.00px;top:160.76px" class="cls_030"><span class="cls_030">[GC 18309K->1285K(83008K), 0.0005617 secs]</span></div>
<div style="position:absolute;left:120.00px;top:171.26px" class="cls_030"><span class="cls_030">[GC 18309K->1285K(83008K), 0.0006873 secs]</span></div>
<div style="position:absolute;left:120.00px;top:181.75px" class="cls_030"><span class="cls_030">[GC 18309K->1285K(83008K), 0.0004944 secs]</span></div>
<div style="position:absolute;left:120.00px;top:192.25px" class="cls_030"><span class="cls_030">[GC 18309K->1285K(83008K), 0.0006644 secs]</span></div>
<div style="position:absolute;left:120.00px;top:202.75px" class="cls_030"><span class="cls_030">[GC 18309K->1285K(83008K), 0.0006448 secs]</span></div>
<div style="position:absolute;left:120.00px;top:213.24px" class="cls_030"><span class="cls_030">[GC 18309K->1285K(83008K), 0.0007203 secs]</span></div>
<div style="position:absolute;left:120.00px;top:235.74px" class="cls_038"><span class="cls_038">Listing 12-14: The output produced by running Listing 12-13 with </span><span class="cls_014">-J-verbose:gc</span></div>
<div style="position:absolute;left:138.00px;top:258.28px" class="cls_007"><span class="cls_007">The JVM displays a line of information each time garbage collection</span></div>
<div style="position:absolute;left:120.00px;top:270.28px" class="cls_007"><span class="cls_007">occurs while running our Ruby program. There are 14 GC events shown</span></div>
<div style="position:absolute;left:120.00px;top:282.28px" class="cls_007"><span class="cls_007">here. Each line contains the following information:</span></div>
<div style="position:absolute;left:138.00px;top:300.28px" class="cls_040"><span class="cls_040">[GC...</span><span class="cls_007">   The </span><span class="cls_008">GC</span><span class="cls_007"> prefix means this event was a minor collection. The</span></div>
<div style="position:absolute;left:138.00px;top:312.28px" class="cls_007"><span class="cls_007">JVM cleaned up only new objects in the Eden heap or young objects</span></div>
<div style="position:absolute;left:138.00px;top:324.28px" class="cls_007"><span class="cls_007">in the survivor spaces.</span></div>
<div style="position:absolute;left:138.00px;top:339.28px" class="cls_040"><span class="cls_040">17024K->1292K</span><span class="cls_007">   These values show the amount of data used by live objects</span></div>
<div style="position:absolute;left:138.00px;top:351.28px" class="cls_007"><span class="cls_007">before (left of the arrow) and after (right of the arrow) the garbage col-</span></div>
<div style="position:absolute;left:138.00px;top:363.28px" class="cls_007"><span class="cls_007">lection. In this example, the amount of space taken up by live objects</span></div>
<div style="position:absolute;left:138.00px;top:375.28px" class="cls_007"><span class="cls_007">in the young collection dropped from about 17MB or 18MB to about</span></div>
<div style="position:absolute;left:138.00px;top:387.28px" class="cls_007"><span class="cls_007">1.3MB each time.</span></div>
<div style="position:absolute;left:138.00px;top:402.28px" class="cls_040"><span class="cls_040">(83008K)</span><span class="cls_007">   The value in parentheses shows the total size of the JVM heap</span></div>
<div style="position:absolute;left:138.00px;top:414.28px" class="cls_007"><span class="cls_007">for this process. This value has not changed.</span></div>
<div style="position:absolute;left:138.00px;top:429.28px" class="cls_040"><span class="cls_040">0.0072491 secs</span><span class="cls_007">   This value shows the amount of time taken to perform</span></div>
<div style="position:absolute;left:138.00px;top:441.28px" class="cls_007"><span class="cls_007">each garbage collection.</span></div>
<div style="position:absolute;left:138.00px;top:459.28px" class="cls_007"><span class="cls_007">Listing 12-14 shows that the JVM’s young heap repeatedly fills up as we</span></div>
<div style="position:absolute;left:120.00px;top:471.28px" class="cls_007"><span class="cls_007">create more Ruby objects. Notice that each time the JVM garbage collector</span></div>
<div style="position:absolute;left:120.00px;top:483.28px" class="cls_007"><span class="cls_007">usually takes less than 1 millisecond to clean up the many thousands of gar-</span></div>
<div style="position:absolute;left:120.00px;top:495.28px" class="cls_007"><span class="cls_007">bage objects.</span></div>
<div style="position:absolute;left:138.00px;top:507.28px" class="cls_007"><span class="cls_007">Notice, too, that there were no major garbage collections. Why? Because</span></div>
<div style="position:absolute;left:120.00px;top:519.28px" class="cls_007"><span class="cls_007">we don’t save our Ruby objects. Listing 12-13 creates 10 million objects but</span></div>
<div style="position:absolute;left:120.00px;top:531.28px" class="cls_007"><span class="cls_007">doesn’t use them, so the JVM’s garbage collector determines that they are</span></div>
<div style="position:absolute;left:120.00px;top:543.28px" class="cls_007"><span class="cls_007">all garbage and reclaims their memory immediately before they are pro-</span></div>
<div style="position:absolute;left:120.00px;top:555.28px" class="cls_007"><span class="cls_007">moted to become mature objects.</span></div>
<div style="position:absolute;left:48.00px;top:633.00px" class="cls_020"><span class="cls_020">322</span></div>
<div style="position:absolute;left:74.45px;top:636.00px" class="cls_021"><span class="cls_021">Chapter 12</span></div>
</div>
<div style="position:absolute;left:50%;margin-left:-252px;top:230516px;width:504px;height:666px;border-style:outset;overflow:hidden">
<div style="position:absolute;left:0px;top:0px">
<img src="e698b76e-46bd-11eb-8b25-0cc47a792c0a_id_e698b76e-46bd-11eb-8b25-0cc47a792c0a_files/background347.jpg" width=504 height=666></div>
<div style="position:absolute;left:123.00px;top:42.05px" class="cls_055"><span class="cls_055">Triggering Major Collections</span></div>
<div style="position:absolute;left:123.00px;top:60.05px" class="cls_007"><span class="cls_007">In order to trigger major collections, we need to create some mature</span></div>
<div style="position:absolute;left:123.00px;top:72.05px" class="cls_007"><span class="cls_007">objects by creating Ruby objects that don’t die young but that live on for</span></div>
<div style="position:absolute;left:123.00px;top:84.05px" class="cls_007"><span class="cls_007">some time. We can achieve this by saving our new objects in an array, as we</span></div>
<div style="position:absolute;left:123.00px;top:96.05px" class="cls_007"><span class="cls_007">did in Experiment 12-1. Listing 12-15 repeats the same script again here for</span></div>
<div style="position:absolute;left:123.00px;top:108.05px" class="cls_007"><span class="cls_007">convenience.</span></div>
<div style="position:absolute;left:111.15px;top:132.05px" class="cls_046"><span class="cls_046">u</span><span class="cls_030"> arr = []</span></div>
<div style="position:absolute;left:123.00px;top:142.55px" class="cls_030"><span class="cls_030">10000000.times do</span></div>
<div style="position:absolute;left:111.15px;top:153.04px" class="cls_046"><span class="cls_046">v</span><span class="cls_030">   arr &lt;&lt; Object.new</span></div>
<div style="position:absolute;left:123.00px;top:163.54px" class="cls_030"><span class="cls_030">end</span></div>
<div style="position:absolute;left:123.00px;top:186.04px" class="cls_038"><span class="cls_038">Listing 12-15: Saving 10 million Ruby objects in an array</span></div>
<div style="position:absolute;left:141.00px;top:208.55px" class="cls_007"><span class="cls_007">Notice at </span><span class="cls_050">u</span><span class="cls_007"> that we create an empty array and then insert all 10 mil-</span></div>
<div style="position:absolute;left:123.00px;top:220.55px" class="cls_007"><span class="cls_007">lion new objects into it at </span><span class="cls_050">v</span><span class="cls_007">. Because the array contains a reference to all</span></div>
<div style="position:absolute;left:123.00px;top:232.55px" class="cls_007"><span class="cls_007">objects, the objects will all remain live.</span></div>
<div style="position:absolute;left:141.00px;top:244.55px" class="cls_007"><span class="cls_007">Now let’s rerun our experiment using the </span><span class="cls_030">-J-verbose:gc</span><span class="cls_007"> command.</span></div>
<div style="position:absolute;left:123.00px;top:256.55px" class="cls_007"><span class="cls_007">Listing 12-16 shows the result.</span></div>
<div style="position:absolute;left:123.00px;top:280.55px" class="cls_030"><span class="cls_030">$ </span><span class="cls_040">jruby -J-verbose:gc jruby-gc.rb</span></div>
<div style="position:absolute;left:111.15px;top:291.05px" class="cls_046"><span class="cls_046">u</span><span class="cls_030"> [GC 16196K->8571K(</span><span class="cls_040">83008K</span><span class="cls_030">), 0.0873137 secs]</span></div>
<div style="position:absolute;left:123.00px;top:301.54px" class="cls_030"><span class="cls_030">[GC 25595K->20319K(83008K), 0.0480336 secs]</span></div>
<div style="position:absolute;left:123.00px;top:312.04px" class="cls_030"><span class="cls_030">[GC 37343K->37342K(83008K), 0.0611792 secs]</span></div>
<div style="position:absolute;left:123.00px;top:322.54px" class="cls_030"><span class="cls_030">[GC 37586K(83008K), 0.0029985 secs]</span></div>
<div style="position:absolute;left:123.00px;top:333.04px" class="cls_030"><span class="cls_030">[GC 54366K->54365K(83008K), 0.0617091 secs]</span></div>
<div style="position:absolute;left:123.00px;top:343.53px" class="cls_030"><span class="cls_030">[GC 65553K->65360K(83008K), 0.0586615 secs]</span></div>
<div style="position:absolute;left:123.00px;top:354.03px" class="cls_030"><span class="cls_030">[GC 82384K->82384K(100040K), 0.0479422 secs]</span></div>
<div style="position:absolute;left:123.00px;top:364.53px" class="cls_030"><span class="cls_030">[GC 89491K(100040K), 0.0124503 secs]</span></div>
<div style="position:absolute;left:123.00px;top:375.03px" class="cls_030"><span class="cls_030">[GC 95890K->95888K(147060K), 0.0795343 secs]</span></div>
<div style="position:absolute;left:123.00px;top:385.52px" class="cls_030"><span class="cls_030">[GC 96144K(147060K), 0.0030345 secs]</span></div>
<div style="position:absolute;left:123.00px;top:396.02px" class="cls_030"><span class="cls_030">[GC 130683K->130682K(148020K), 0.0941640 secs]</span></div>
<div style="position:absolute;left:123.00px;top:406.52px" class="cls_030"><span class="cls_030">[GC 147706K->147704K(165108K), 0.0925857 secs]</span></div>
<div style="position:absolute;left:123.00px;top:417.02px" class="cls_030"><span class="cls_030">[GC 150767K->151226K(168564K), 0.0226121 secs]</span></div>
<div style="position:absolute;left:111.15px;top:427.51px" class="cls_046"><span class="cls_046">v</span><span class="cls_030"> [Full GC 151226K->125676K(168564K), 0.5317203 secs]</span></div>
<div style="position:absolute;left:123.00px;top:438.01px" class="cls_030"><span class="cls_030">[GC 176397K->176404K(</span><span class="cls_040">236472K</span><span class="cls_030">), 0.0999831 secs]</span></div>
<div style="position:absolute;left:123.00px;top:459.01px" class="cls_030"><span class="cls_030">--snip--</span></div>
<div style="position:absolute;left:123.00px;top:481.51px" class="cls_038"><span class="cls_038">Listing 12-16: The beginning of the output produced by running Listing 12-15 with</span></div>
<div style="position:absolute;left:123.00px;top:492.55px" class="cls_014"><span class="cls_014">-J-verbose:gc</span></div>
<div style="position:absolute;left:141.00px;top:514.55px" class="cls_007"><span class="cls_007">Notice at </span><span class="cls_050">v</span><span class="cls_007"> that the output </span><span class="cls_030">[Full GC...]</span><span class="cls_007"> first appears after 13 young</span></div>
<div style="position:absolute;left:123.00px;top:526.55px" class="cls_007"><span class="cls_007">collections. (The output continues past what is shown in Listing 12-16.)</span></div>
<div style="position:absolute;left:123.00px;top:538.55px" class="cls_007"><span class="cls_007">This tells us that many Ruby objects were promoted, filling up the mature</span></div>
<div style="position:absolute;left:123.00px;top:550.55px" class="cls_007"><span class="cls_007">generation and forcing a mature collection to run.</span></div>
<div style="position:absolute;left:301.58px;top:636.00px" class="cls_021"><span class="cls_021">Garbage Collection in MRI, JRuby, and Rubinius</span></div>
<div style="position:absolute;left:442.52px;top:633.00px" class="cls_020"><span class="cls_020">323</span></div>
</div>
<div style="position:absolute;left:50%;margin-left:-252px;top:231192px;width:504px;height:666px;border-style:outset;overflow:hidden">
<div style="position:absolute;left:0px;top:0px">
<img src="e698b76e-46bd-11eb-8b25-0cc47a792c0a_id_e698b76e-46bd-11eb-8b25-0cc47a792c0a_files/background348.jpg" width=504 height=666></div>
<div style="position:absolute;left:138.00px;top:42.28px" class="cls_007"><span class="cls_007">We can draw some other interesting conclusions from this output.</span></div>
<div style="position:absolute;left:120.00px;top:54.28px" class="cls_007"><span class="cls_007">First, the size of the young collection gradually grew from the first GC run</span></div>
<div style="position:absolute;left:120.00px;top:66.28px" class="cls_007"><span class="cls_007">at </span><span class="cls_050">u</span><span class="cls_007"> to the mature collection at </span><span class="cls_050">v</span><span class="cls_007">. This tells us that the JVM was automati-</span></div>
<div style="position:absolute;left:120.00px;top:78.28px" class="cls_007"><span class="cls_007">cally increasing the total heap size as more objects were created. Notice that</span></div>
<div style="position:absolute;left:120.00px;top:90.28px" class="cls_007"><span class="cls_007">the total heap size value in parentheses started at around 83MB and grew</span></div>
<div style="position:absolute;left:120.00px;top:102.28px" class="cls_007"><span class="cls_007">to over 200MB, as shown in bold. Also, each young collection was still rela-</span></div>
<div style="position:absolute;left:120.00px;top:114.28px" class="cls_007"><span class="cls_007">tively fast at under 0.1 seconds, though much slower than the ones we saw in</span></div>
<div style="position:absolute;left:120.00px;top:126.28px" class="cls_007"><span class="cls_007">Listing 12-14, which took less than 1 millisecond. Remember that the semi-</span></div>
<div style="position:absolute;left:120.00px;top:138.28px" class="cls_007"><span class="cls_007">space algorithm copies only live objects. This time all of our Ruby objects</span></div>
<div style="position:absolute;left:120.00px;top:150.28px" class="cls_007"><span class="cls_007">remained alive, and the JVM had to copy them repeatedly. Finally, notice</span></div>
<div style="position:absolute;left:120.00px;top:162.28px" class="cls_007"><span class="cls_007">that the mature, or full, collection at </span><span class="cls_050">v</span><span class="cls_007"> took about 0.53 seconds, which was</span></div>
<div style="position:absolute;left:120.00px;top:174.28px" class="cls_007"><span class="cls_007">much longer than any of the young collections.</span></div>
<div style="position:absolute;left:66.00px;top:208.28px" class="cls_031"><span class="cls_031">Further Reading</span></div>
<div style="position:absolute;left:120.00px;top:228.28px" class="cls_007"><span class="cls_007">There’s a vast amount of information available on the topic of garbage</span></div>
<div style="position:absolute;left:120.00px;top:240.28px" class="cls_007"><span class="cls_007">collection. To learn more about John McCarthy’s original free list imple-</span></div>
<div style="position:absolute;left:120.00px;top:252.28px" class="cls_007"><span class="cls_007">mentation, see his article on Lisp: “Recursive Functions of Symbolic</span></div>
<div style="position:absolute;left:120.00px;top:264.28px" class="cls_007"><span class="cls_007">Expressions and Their Computation by Machine, Part 1” (</span><span class="cls_008">Communications</span></div>
<div style="position:absolute;left:120.00px;top:276.28px" class="cls_008"><span class="cls_008">of the ACM</span><span class="cls_007">, 1960).</span></div>
<div style="position:absolute;left:138.00px;top:288.28px" class="cls_007"><span class="cls_007">For a taste of modern GC research, you can read about the Immix algo-</span></div>
<div style="position:absolute;left:120.00px;top:300.28px" class="cls_007"><span class="cls_007">rithm used by Rubinius in Stephen M. Blackburn and Kathryn S. McKinley’s</span></div>
<div style="position:absolute;left:120.00px;top:312.28px" class="cls_007"><span class="cls_007">“A Mark-Region Garbage Collector with Space Efficiency, Fast Collection, and</span></div>
<div style="position:absolute;left:120.00px;top:324.28px" class="cls_007"><span class="cls_007">Mutator Performance” (</span><span class="cls_008">ACM SIGPLAN Notices</span><span class="cls_007">, 2008). The following article</span></div>
<div style="position:absolute;left:120.00px;top:336.28px" class="cls_007"><span class="cls_007">from Oracle both explains the JVM’s overall GC algorithm and serves as a</span></div>
<div style="position:absolute;left:120.00px;top:348.28px" class="cls_007"><span class="cls_007">good reference for the many command-line options you can use to customize</span></div>
<div style="position:absolute;left:120.00px;top:360.28px" class="cls_007"><span class="cls_007">and tune the JVM’s garbage collector’s behavior: “Java SE 6 HotSpot Virtual</span></div>
<div style="position:absolute;left:120.00px;top:372.28px" class="cls_007"><span class="cls_007">Machine Garbage Collection Tuning” (</span><A HREF="http://www.oracle.com/technetwork/java/javase/gc-tuning-6-140523.html">http://www.oracle.com/technetwork/java/</A> </span></div>
<div style="position:absolute;left:120.00px;top:384.28px" class="cls_008"><span class="cls_008">javase/gc-tuning-6-140523.html</span><span class="cls_007">).</span></div>
<div style="position:absolute;left:138.00px;top:396.28px" class="cls_007"><span class="cls_007">Finally, two definitive sources on GC algorithms in general and how</span></div>
<div style="position:absolute;left:120.00px;top:408.28px" class="cls_007"><span class="cls_007">they have changed over the years are Jones and Lins’s </span><span class="cls_008">Garbage Collection:</span></div>
<div style="position:absolute;left:120.00px;top:420.28px" class="cls_008"><span class="cls_008">Algorithms for Automatic Dynamic Memory Management</span><span class="cls_007"> (Wiley, 1996) and</span></div>
<div style="position:absolute;left:120.00px;top:432.28px" class="cls_007"><span class="cls_007">Jones, Hosking, and Moss’s, </span><span class="cls_008">The Garbage Collection Handbook: The Art of</span></div>
<div style="position:absolute;left:120.00px;top:444.28px" class="cls_008"><span class="cls_008">Automatic Memory Management</span><span class="cls_007"> (CRC Press, 2012).</span></div>
<div style="position:absolute;left:48.00px;top:633.00px" class="cls_020"><span class="cls_020">324</span></div>
<div style="position:absolute;left:74.34px;top:636.00px" class="cls_021"><span class="cls_021">Chapter 12</span></div>
</div>
<div style="position:absolute;left:50%;margin-left:-252px;top:231868px;width:504px;height:666px;border-style:outset;overflow:hidden">
<div style="position:absolute;left:0px;top:0px">
<img src="e698b76e-46bd-11eb-8b25-0cc47a792c0a_id_e698b76e-46bd-11eb-8b25-0cc47a792c0a_files/background349.jpg" width=504 height=666></div>
<div style="position:absolute;left:69.00px;top:42.05px" class="cls_031"><span class="cls_031">Summary</span></div>
<div style="position:absolute;left:123.00px;top:62.05px" class="cls_007"><span class="cls_007">This chapter has covered one of the most important but least understood</span></div>
<div style="position:absolute;left:123.00px;top:74.05px" class="cls_007"><span class="cls_007">areas of Ruby internals: garbage collection. We learned that garbage collec-</span></div>
<div style="position:absolute;left:123.00px;top:86.05px" class="cls_007"><span class="cls_007">tors allocate memory for new objects and clean up unused garbage objects.</span></div>
<div style="position:absolute;left:123.00px;top:98.05px" class="cls_007"><span class="cls_007">We examined the basic algorithms used by MRI, Rubinius, and JRuby for</span></div>
<div style="position:absolute;left:123.00px;top:110.05px" class="cls_007"><span class="cls_007">garbage collection and discovered that MRI allocates and reclaims memory</span></div>
<div style="position:absolute;left:123.00px;top:122.05px" class="cls_007"><span class="cls_007">using a free list, while Rubinius and the JVM use the semi-space algorithm.</span></div>
<div style="position:absolute;left:123.00px;top:134.05px" class="cls_007"><span class="cls_007">We also saw how Rubinius and JRuby employ concurrent and generational</span></div>
<div style="position:absolute;left:123.00px;top:146.05px" class="cls_007"><span class="cls_007">GC techniques, which MRI starts to use in Ruby 2.1.</span></div>
<div style="position:absolute;left:141.00px;top:158.05px" class="cls_007"><span class="cls_007">But we’ve only scratched the surface of garbage collection. Since its</span></div>
<div style="position:absolute;left:123.00px;top:170.05px" class="cls_007"><span class="cls_007">invention in 1960, many complex GC algorithms have been developed;</span></div>
<div style="position:absolute;left:123.00px;top:182.05px" class="cls_007"><span class="cls_007">indeed, garbage collection is still an active area of computer science research.</span></div>
<div style="position:absolute;left:123.00px;top:194.05px" class="cls_007"><span class="cls_007">The GC implementations in MRI, Rubinius, and JRuby are likely to continue</span></div>
<div style="position:absolute;left:123.00px;top:206.05px" class="cls_007"><span class="cls_007">to evolve and improve over time.</span></div>
<div style="position:absolute;left:301.63px;top:636.00px" class="cls_021"><span class="cls_021">Garbage Collection in MRI, JRuby, and Rubinius</span></div>
<div style="position:absolute;left:442.57px;top:633.00px" class="cls_020"><span class="cls_020">325</span></div>
</div>
<div style="position:absolute;left:50%;margin-left:-252px;top:232544px;width:504px;height:666px;border-style:outset;overflow:hidden">
<div style="position:absolute;left:0px;top:0px">
<img src="e698b76e-46bd-11eb-8b25-0cc47a792c0a_id_e698b76e-46bd-11eb-8b25-0cc47a792c0a_files/background350.jpg" width=504 height=666></div>
<div style="position:absolute;left:256.79px;top:297.71px" class="cls_024"><span class="cls_024">The Ruby core</span></div>
<div style="position:absolute;left:239.38px;top:315.72px" class="cls_024"><span class="cls_024">community welcomes</span></div>
<div style="position:absolute;left:254.58px;top:333.72px" class="cls_024"><span class="cls_024">your challenge.</span></div>
</div>
<div style="position:absolute;left:50%;margin-left:-252px;top:233220px;width:504px;height:666px;border-style:outset;overflow:hidden">
<div style="position:absolute;left:0px;top:0px">
<img src="e698b76e-46bd-11eb-8b25-0cc47a792c0a_id_e698b76e-46bd-11eb-8b25-0cc47a792c0a_files/background351.jpg" width=504 height=666></div>
<div style="position:absolute;left:211.15px;top:253.45px" class="cls_016"><span class="cls_016">Yet More Ruby</span></div>
<div style="position:absolute;left:195.33px;top:271.45px" class="cls_016"><span class="cls_016">Virtual Machines</span></div>
<div style="position:absolute;left:203.30px;top:289.45px" class="cls_016"><span class="cls_016">by Koichi Sasada</span></div>
<div style="position:absolute;left:123.00px;top:405.45px" class="cls_023"><span class="cls_023">As a developer of YARV: Yet Another Ruby VM, I am</span></div>
<div style="position:absolute;left:123.00px;top:423.46px" class="cls_023"><span class="cls_023">thankful to have a chance to write about YARV in this</span></div>
<div style="position:absolute;left:123.00px;top:441.46px" class="cls_023"><span class="cls_023">appendix. Many pages of this book describe the inter-</span></div>
<div style="position:absolute;left:123.00px;top:459.46px" class="cls_023"><span class="cls_023">nals of YARV, and the book has been read by people</span></div>
<div style="position:absolute;left:123.00px;top:478.45px" class="cls_007"><span class="cls_007">all over the world. I am greatly honored by that as a software developer,</span></div>
<div style="position:absolute;left:123.00px;top:490.45px" class="cls_007"><span class="cls_007">although it humbles me to have found several inefficiencies in YARV’s</span></div>
<div style="position:absolute;left:123.00px;top:502.45px" class="cls_007"><span class="cls_007">implementation while reading the book. In this appendix, I will give some</span></div>
<div style="position:absolute;left:123.00px;top:514.45px" class="cls_007"><span class="cls_007">supplemental information and background on the design and implementa-</span></div>
<div style="position:absolute;left:123.00px;top:526.45px" class="cls_007"><span class="cls_007">tion of YARV.</span></div>
</div>
<div style="position:absolute;left:50%;margin-left:-252px;top:233896px;width:504px;height:666px;border-style:outset;overflow:hidden">
<div style="position:absolute;left:0px;top:0px">
<img src="e698b76e-46bd-11eb-8b25-0cc47a792c0a_id_e698b76e-46bd-11eb-8b25-0cc47a792c0a_files/background352.jpg" width=504 height=666></div>
<div style="position:absolute;left:66.00px;top:42.05px" class="cls_031"><span class="cls_031">YARV: Yet Another Ruby VM</span></div>
<div style="position:absolute;left:120.00px;top:62.05px" class="cls_007"><span class="cls_007">I started the development of YARV during the New Year’s holiday in 2004. I</span></div>
<div style="position:absolute;left:120.00px;top:74.05px" class="cls_007"><span class="cls_007">had already been interested in a virtual machine for Ruby at that time. I built</span></div>
<div style="position:absolute;left:120.00px;top:86.05px" class="cls_007"><span class="cls_007">a simple prototype in about a week. (I must have had plenty of time to kill</span></div>
<div style="position:absolute;left:120.00px;top:98.05px" class="cls_007"><span class="cls_007">back then.) According to the first announcement ([ruby-dev:22494]), it was</span></div>
<div style="position:absolute;left:120.00px;top:110.05px" class="cls_007"><span class="cls_007">capable of running a program to calculate Fibonacci numbers.</span></div>
<div style="position:absolute;left:138.00px;top:122.05px" class="cls_007"><span class="cls_007">In its early stages of development, I implemented YARV as an exten-</span></div>
<div style="position:absolute;left:120.00px;top:134.05px" class="cls_007"><span class="cls_007">sion library for Ruby 1.8. Instead of replacing the whole runtime engine,</span></div>
<div style="position:absolute;left:120.00px;top:146.05px" class="cls_007"><span class="cls_007">I designed it to be used by Ruby 1.8 as a VM to run specific programs. In</span></div>
<div style="position:absolute;left:120.00px;top:158.05px" class="cls_007"><span class="cls_007">other words, it was another Ruby implementation on top of the Ruby 1.8</span></div>
<div style="position:absolute;left:120.00px;top:170.05px" class="cls_007"><span class="cls_007">implementation. This architecture allowed us to test YARV with relative</span></div>
<div style="position:absolute;left:120.00px;top:182.05px" class="cls_007"><span class="cls_007">ease using Ruby 1.8, which was sufficiently stable. We could continue using</span></div>
<div style="position:absolute;left:120.00px;top:194.05px" class="cls_007"><span class="cls_007">the base mechanisms of Ruby 1.8, such as GC, C APIs, and so on. After fin-</span></div>
<div style="position:absolute;left:120.00px;top:206.05px" class="cls_007"><span class="cls_007">ishing a substantial part of the development, the Ruby 1.8 core was removed</span></div>
<div style="position:absolute;left:120.00px;top:218.05px" class="cls_007"><span class="cls_007">and replaced with YARV all at once, in order to support features such as</span></div>
<div style="position:absolute;left:120.00px;top:230.05px" class="cls_007"><span class="cls_007">threads. However, we kept using infrastructure code, such as GC, after that.</span></div>
<div style="position:absolute;left:120.00px;top:242.05px" class="cls_007"><span class="cls_007">The Ruby interpreter (MRI/CRuby) is known to have an affinity with the</span></div>
<div style="position:absolute;left:120.00px;top:254.05px" class="cls_007"><span class="cls_007">C programming language. YARV inherits that characteristic as well. Then</span></div>
<div style="position:absolute;left:120.00px;top:266.05px" class="cls_007"><span class="cls_007">a new version of Ruby containing YARV at its core was released as Ruby 1.9.</span></div>
<div style="position:absolute;left:120.00px;top:278.05px" class="cls_007"><span class="cls_007">As of this writing in 2014, YARV has been used as the Ruby VM since then.</span></div>
<div style="position:absolute;left:138.00px;top:290.05px" class="cls_007"><span class="cls_007">People often point out that YARV is not “Yet Another” anymore, because</span></div>
<div style="position:absolute;left:120.00px;top:302.05px" class="cls_007"><span class="cls_007">it is the official VM now. Though we still use the name because it is well</span></div>
<div style="position:absolute;left:120.00px;top:314.05px" class="cls_007"><span class="cls_007">known, we make it a rule not to use “YARV” in filenames or class names.</span></div>
<div style="position:absolute;left:120.00px;top:326.05px" class="cls_007"><span class="cls_007">When I started working on YARV, there had already been several proposals</span></div>
<div style="position:absolute;left:120.00px;top:338.05px" class="cls_007"><span class="cls_007">for the development of new virtual machines for Ruby. RiteVM by Matz, the</span></div>
<div style="position:absolute;left:120.00px;top:350.05px" class="cls_007"><span class="cls_007">creator of Ruby, and ByteCodeRuby were the most well-known projects then,</span></div>
<div style="position:absolute;left:120.00px;top:362.05px" class="cls_007"><span class="cls_007">as far as I can remember. That led me to prefix the name of our VM with</span></div>
<div style="position:absolute;left:120.00px;top:374.05px" class="cls_007"><span class="cls_007">“Yet Another.” Of course, I named it so hoping it would become popular.</span></div>
<div style="position:absolute;left:120.00px;top:386.05px" class="cls_007"><span class="cls_007">There are many examples of software programs that have “Yet Another”</span></div>
<div style="position:absolute;left:120.00px;top:398.05px" class="cls_007"><span class="cls_007">in their names and nevertheless became popular; for example, yacc. By</span></div>
<div style="position:absolute;left:120.00px;top:410.05px" class="cls_007"><span class="cls_007">the way, RiteVM is now the name of the mruby VM which Matz is actively</span></div>
<div style="position:absolute;left:120.00px;top:422.05px" class="cls_007"><span class="cls_007">developing.</span></div>
<div style="position:absolute;left:66.00px;top:456.05px" class="cls_031"><span class="cls_031">Design Principles of YARV</span></div>
<div style="position:absolute;left:120.00px;top:476.05px" class="cls_007"><span class="cls_007">We chose to implement YARV for the Ruby 1.9 specification, instead of 1.8.</span></div>
<div style="position:absolute;left:120.00px;top:488.05px" class="cls_007"><span class="cls_007">At the time, Ruby 1.9 was the next version, and we were discussing its speci-</span></div>
<div style="position:absolute;left:120.00px;top:500.05px" class="cls_007"><span class="cls_007">fication, so we targeted YARV at that specification. We also had the option</span></div>
<div style="position:absolute;left:120.00px;top:512.05px" class="cls_007"><span class="cls_007">of implementing it for Ruby 1.8, thereby supporting a large number of users</span></div>
<div style="position:absolute;left:120.00px;top:524.05px" class="cls_007"><span class="cls_007">instantly. But some of the Ruby 1.8 features seemed difficult to implement</span></div>
<div style="position:absolute;left:120.00px;top:536.05px" class="cls_007"><span class="cls_007">with the stack machine that YARV is based on. So I decided to implement my</span></div>
<div style="position:absolute;left:120.00px;top:548.05px" class="cls_007"><span class="cls_007">VM for the newer spec, while negotiating with Ruby developers to change the</span></div>
<div style="position:absolute;left:120.00px;top:560.05px" class="cls_007"><span class="cls_007">parts of the specification that were hard to implement. This strategy worked</span></div>
<div style="position:absolute;left:120.00px;top:572.05px" class="cls_007"><span class="cls_007">well, and YARV became one of the interpreters to run Ruby 1.9. I think that</span></div>
<div style="position:absolute;left:120.00px;top:584.05px" class="cls_007"><span class="cls_007">was one of the reasons that it was finally merged in as an official VM.</span></div>
<div style="position:absolute;left:48.00px;top:633.00px" class="cls_020"><span class="cls_020">328</span></div>
<div style="position:absolute;left:74.46px;top:636.00px" class="cls_021"><span class="cls_021">Appendix</span></div>
</div>
<div style="position:absolute;left:50%;margin-left:-252px;top:234572px;width:504px;height:666px;border-style:outset;overflow:hidden">
<div style="position:absolute;left:0px;top:0px">
<img src="e698b76e-46bd-11eb-8b25-0cc47a792c0a_id_e698b76e-46bd-11eb-8b25-0cc47a792c0a_files/background353.jpg" width=504 height=666></div>
<div style="position:absolute;left:141.00px;top:42.28px" class="cls_007"><span class="cls_007">This book correctly explains YARV’s design details. I would like to add,</span></div>
<div style="position:absolute;left:123.00px;top:54.28px" class="cls_007"><span class="cls_007">however, that it was not very straightforward to get to the current design.</span></div>
<div style="position:absolute;left:123.00px;top:66.28px" class="cls_007"><span class="cls_007">One of the things I remember being an issue was the stack structure of the</span></div>
<div style="position:absolute;left:123.00px;top:78.28px" class="cls_007"><span class="cls_007">virtual machine. The book describes YARV as a “double stack machine,” but</span></div>
<div style="position:absolute;left:123.00px;top:90.28px" class="cls_007"><span class="cls_007">it used only one stack at first. Actual microprocessors allocate a calculation</span></div>
<div style="position:absolute;left:123.00px;top:102.28px" class="cls_007"><span class="cls_007">area and a function call frame one after another on a single stack. YARV</span></div>
<div style="position:absolute;left:123.00px;top:114.28px" class="cls_007"><span class="cls_007">used a similar architecture at first, but it became too complicated. Later I</span></div>
<div style="position:absolute;left:123.00px;top:126.28px" class="cls_007"><span class="cls_007">concluded that it should have two stacks, even if I had to give up some effi-</span></div>
<div style="position:absolute;left:123.00px;top:138.28px" class="cls_007"><span class="cls_007">ciency. YARV’s operation became too complex, especially when implement-</span></div>
<div style="position:absolute;left:123.00px;top:150.28px" class="cls_007"><span class="cls_007">ing the extraction of a block as a closure. Because this book cleverly avoids</span></div>
<div style="position:absolute;left:123.00px;top:162.28px" class="cls_007"><span class="cls_007">such hairy details, readers fortunately do not have to confront this sort</span></div>
<div style="position:absolute;left:123.00px;top:174.28px" class="cls_007"><span class="cls_007">of complexity. But I am glad I have chance to explain that, because it was</span></div>
<div style="position:absolute;left:123.00px;top:186.28px" class="cls_007"><span class="cls_007">one of the most difficult parts to implement. By the way, having two stacks</span></div>
<div style="position:absolute;left:123.00px;top:198.28px" class="cls_007"><span class="cls_007">means that the cost of checking for stack overflows also doubles. So I imple-</span></div>
<div style="position:absolute;left:123.00px;top:210.28px" class="cls_007"><span class="cls_007">mented them both in the same memory block: one going from bottom to</span></div>
<div style="position:absolute;left:123.00px;top:222.28px" class="cls_007"><span class="cls_007">top and the other going from top to bottom. This trick somewhat reduced</span></div>
<div style="position:absolute;left:123.00px;top:234.28px" class="cls_007"><span class="cls_007">the cost of checking for stack overflows, because we only have to check the</span></div>
<div style="position:absolute;left:123.00px;top:246.28px" class="cls_007"><span class="cls_007">positions of two stack pointers once.</span></div>
<div style="position:absolute;left:69.00px;top:280.28px" class="cls_031"><span class="cls_031">YARV Development Prehistory</span></div>
<div style="position:absolute;left:123.00px;top:300.28px" class="cls_007"><span class="cls_007">I’d like to describe the history of how I came to develop YARV. Because</span></div>
<div style="position:absolute;left:123.00px;top:312.28px" class="cls_007"><span class="cls_007">earlier I had been interested in programming language processors, I had</span></div>
<div style="position:absolute;left:123.00px;top:324.28px" class="cls_007"><span class="cls_007">the experience of implementing two Java virtual machines. That gave me</span></div>
<div style="position:absolute;left:123.00px;top:336.28px" class="cls_007"><span class="cls_007">some knowledge of what was required to implement virtual machines</span></div>
<div style="position:absolute;left:123.00px;top:348.28px" class="cls_007"><span class="cls_007">intended for object-oriented programming languages. At the time,</span></div>
<div style="position:absolute;left:123.00px;top:360.28px" class="cls_007"><span class="cls_007">Mr. Nobuo Yamashita was periodically holding meetups to read the book</span></div>
<div style="position:absolute;left:123.00px;top:372.28px" class="cls_008"><span class="cls_008">The Structure and Interpretation of Computer Programs</span><span class="cls_007"> (SICP). By attending</span></div>
<div style="position:absolute;left:123.00px;top:384.28px" class="cls_007"><span class="cls_007">those meetings, I acquired knowledge and insight about implementations</span></div>
<div style="position:absolute;left:123.00px;top:396.28px" class="cls_007"><span class="cls_007">of Scheme. This insight was important because Ruby’s block design was</span></div>
<div style="position:absolute;left:123.00px;top:408.28px" class="cls_007"><span class="cls_007">based on Lisp functions, as Chapter 8 of this book points out.</span></div>
<div style="position:absolute;left:141.00px;top:420.28px" class="cls_007"><span class="cls_007">December 2002 saw the publication of </span><span class="cls_008">Ruby Source Code Kanzen Kaisetsu</span></div>
<div style="position:absolute;left:123.00px;top:432.28px" class="cls_007"><span class="cls_007">(commonly known as the </span><span class="cls_008">Ruby Hacking Guide</span><span class="cls_007">, or RHG) by Mr. Minero</span></div>
<div style="position:absolute;left:123.00px;top:444.28px" class="cls_007"><span class="cls_007">Aoki, which is a unique book that explains the entire Ruby source code.</span></div>
<div style="position:absolute;left:123.00px;top:456.28px" class="cls_007"><span class="cls_007">Mr. Masayoshi Takahashi held meetings to read RHG about once a month.</span></div>
<div style="position:absolute;left:123.00px;top:468.28px" class="cls_007"><span class="cls_007">We took turns in a reading group, but because the author Aoki-san himself</span></div>
<div style="position:absolute;left:123.00px;top:480.28px" class="cls_007"><span class="cls_007">was one of the members, the other members could talk with him in per-</span></div>
<div style="position:absolute;left:123.00px;top:492.28px" class="cls_007"><span class="cls_007">son when they had questions. In this way, we learned the implementation</span></div>
<div style="position:absolute;left:123.00px;top:504.28px" class="cls_007"><span class="cls_007">details of Ruby very well. Let me add that both of these meetups were held</span></div>
<div style="position:absolute;left:123.00px;top:516.28px" class="cls_007"><span class="cls_007">in the meeting rooms at Time Intermedia, Ltd., where Mr. Yamashita was</span></div>
<div style="position:absolute;left:123.00px;top:528.28px" class="cls_007"><span class="cls_007">working then. I attended the meetups several times a month, and I wish to</span></div>
<div style="position:absolute;left:123.00px;top:540.28px" class="cls_007"><span class="cls_007">express my deep gratitude to the people who provided such an environ-</span></div>
<div style="position:absolute;left:123.00px;top:552.28px" class="cls_007"><span class="cls_007">ment for learning.</span></div>
<div style="position:absolute;left:141.00px;top:564.28px" class="cls_007"><span class="cls_007">After reading RHG and learning more about the structure of Ruby’s</span></div>
<div style="position:absolute;left:123.00px;top:576.28px" class="cls_007"><span class="cls_007">implementation, it became clear to me that the evaluation module Ruby</span></div>
<div style="position:absolute;left:123.00px;top:588.28px" class="cls_007"><span class="cls_007">used to run programs—the heart of the Ruby interpreter—was not effi-</span></div>
<div style="position:absolute;left:123.00px;top:600.28px" class="cls_007"><span class="cls_007">cient enough. I kept on studying and thinking about the ideal design of</span></div>
<div style="position:absolute;left:340.40px;top:636.00px" class="cls_021"><span class="cls_021">Yet More Ruby Virtual Machines</span></div>
<div style="position:absolute;left:442.48px;top:633.00px" class="cls_020"><span class="cls_020">329</span></div>
</div>
<div style="position:absolute;left:50%;margin-left:-252px;top:235248px;width:504px;height:666px;border-style:outset;overflow:hidden">
<div style="position:absolute;left:0px;top:0px">
<img src="e698b76e-46bd-11eb-8b25-0cc47a792c0a_id_e698b76e-46bd-11eb-8b25-0cc47a792c0a_files/background354.jpg" width=504 height=666></div>
<div style="position:absolute;left:120.00px;top:41.60px" class="cls_007"><span class="cls_007">a virtual machine to run Ruby programs precisely and efficiently, which</span></div>
<div style="position:absolute;left:120.00px;top:53.60px" class="cls_007"><span class="cls_007">I finally implemented all at once during that New Year’s holiday. I didn’t</span></div>
<div style="position:absolute;left:120.00px;top:65.60px" class="cls_007"><span class="cls_007">foresee that it would be released as a part of Ruby 1.9. My first motivation</span></div>
<div style="position:absolute;left:120.00px;top:77.60px" class="cls_007"><span class="cls_007">was performance improvement—my source code surely reflected that. In</span></div>
<div style="position:absolute;left:120.00px;top:89.60px" class="cls_007"><span class="cls_007">hindsight, it was far too early for performance optimization.</span></div>
<div style="position:absolute;left:66.00px;top:123.60px" class="cls_031"><span class="cls_031">Yet More Ruby Virtual Machines</span></div>
<div style="position:absolute;left:120.00px;top:143.60px" class="cls_007"><span class="cls_007">This book explains the current architecture of YARV, which you might con-</span></div>
<div style="position:absolute;left:120.00px;top:155.60px" class="cls_007"><span class="cls_007">clude is the correct way of implementing Ruby. But, as I have explained in</span></div>
<div style="position:absolute;left:120.00px;top:167.60px" class="cls_007"><span class="cls_007">this appendix so far, all of Ruby’s implementations, including YARV, are not</span></div>
<div style="position:absolute;left:120.00px;top:179.60px" class="cls_007"><span class="cls_007">much different from any other software application: they are all developed</span></div>
<div style="position:absolute;left:120.00px;top:191.60px" class="cls_007"><span class="cls_007">through trial and error by humans. While this book covers Ruby 2.0, we</span></div>
<div style="position:absolute;left:120.00px;top:203.60px" class="cls_007"><span class="cls_007">have already made various improvements for Ruby 2.1. And we are working</span></div>
<div style="position:absolute;left:120.00px;top:215.60px" class="cls_007"><span class="cls_007">on even more improvements that will make the forthcoming Ruby 2.2 even</span></div>
<div style="position:absolute;left:120.00px;top:227.60px" class="cls_007"><span class="cls_007">better.</span></div>
<div style="position:absolute;left:138.00px;top:239.60px" class="cls_007"><span class="cls_007">For example, keyword arguments will be more efficient. Chapter 4</span></div>
<div style="position:absolute;left:120.00px;top:251.60px" class="cls_007"><span class="cls_007">explains the implementation of keyword arguments. Quickly summarizing:</span></div>
<div style="position:absolute;left:120.00px;top:263.60px" class="cls_007"><span class="cls_007">Ruby first passes a hash object containing keyword name-value pairs as a</span></div>
<div style="position:absolute;left:120.00px;top:275.60px" class="cls_007"><span class="cls_007">normal argument. Then, at compile time, the receiver implicitly expands</span></div>
<div style="position:absolute;left:120.00px;top:287.60px" class="cls_007"><span class="cls_007">code that reads the values from the argument hash. Users don’t seem to be</span></div>
<div style="position:absolute;left:120.00px;top:299.60px" class="cls_007"><span class="cls_007">complaining about its performance for now. I assume keyword arguments</span></div>
<div style="position:absolute;left:120.00px;top:311.60px" class="cls_007"><span class="cls_007">are not widely used, because it is a new feature introduced in Ruby 2.0. But</span></div>
<div style="position:absolute;left:120.00px;top:323.60px" class="cls_007"><span class="cls_007">this implementation is not efficient. Hash objects are created every time,</span></div>
<div style="position:absolute;left:120.00px;top:335.60px" class="cls_007"><span class="cls_007">incurring object creation and GC costs. Also, reading from hash objects</span></div>
<div style="position:absolute;left:120.00px;top:347.60px" class="cls_007"><span class="cls_007">using the implicitly expanded code is slow, because it involves multiple</span></div>
<div style="position:absolute;left:120.00px;top:359.60px" class="cls_007"><span class="cls_007">method calls.</span></div>
<div style="position:absolute;left:138.00px;top:371.60px" class="cls_007"><span class="cls_007">In order to address this problem, we are reimplementing how Ruby 2.2</span></div>
<div style="position:absolute;left:120.00px;top:383.60px" class="cls_007"><span class="cls_007">handles keyword arguments to avoid creating hash objects as much as pos-</span></div>
<div style="position:absolute;left:120.00px;top:395.60px" class="cls_007"><span class="cls_007">sible. Meanwhile, we are implementing a new design that will collect the</span></div>
<div style="position:absolute;left:120.00px;top:407.60px" class="cls_007"><span class="cls_007">names of keyword arguments at compile time, so that the caller need only</span></div>
<div style="position:absolute;left:120.00px;top:419.60px" class="cls_007"><span class="cls_007">pass the values at runtime. The callee will then recombine the values with</span></div>
<div style="position:absolute;left:120.00px;top:431.60px" class="cls_007"><span class="cls_007">the names collected by the compiler. This design change will allow Ruby to</span></div>
<div style="position:absolute;left:120.00px;top:443.60px" class="cls_007"><span class="cls_007">process keyword arguments 10 times faster. I would like to keep on improv-</span></div>
<div style="position:absolute;left:120.00px;top:455.60px" class="cls_007"><span class="cls_007">ing the quality of Ruby’s implementation, including runtime efficiency.</span></div>
<div style="position:absolute;left:138.00px;top:467.60px" class="cls_007"><span class="cls_007">If you become interested in YARV and Ruby implementations after</span></div>
<div style="position:absolute;left:120.00px;top:479.60px" class="cls_007"><span class="cls_007">reading this book, and if you have ideas for improving them, I encourage</span></div>
<div style="position:absolute;left:120.00px;top:491.60px" class="cls_007"><span class="cls_007">you to develop your own “Yet Another Ruby Implementation.” The Ruby</span></div>
<div style="position:absolute;left:120.00px;top:503.60px" class="cls_007"><span class="cls_007">core community will welcome your challenge.</span></div>
<div style="position:absolute;left:120.00px;top:527.60px" class="cls_007"><span class="cls_007">Koichi Sasada</span></div>
<div style="position:absolute;left:120.00px;top:539.60px" class="cls_007"><span class="cls_007">Heroku, Inc.</span></div>
<div style="position:absolute;left:120.00px;top:551.60px" class="cls_007"><span class="cls_007">November 2014</span></div>
<div style="position:absolute;left:48.00px;top:633.00px" class="cls_020"><span class="cls_020">330</span></div>
<div style="position:absolute;left:74.68px;top:636.00px" class="cls_021"><span class="cls_021">Appendix</span></div>
</div>
<div style="position:absolute;left:50%;margin-left:-252px;top:235924px;width:504px;height:666px;border-style:outset;overflow:hidden">
<div style="position:absolute;left:0px;top:0px">
<img src="e698b76e-46bd-11eb-8b25-0cc47a792c0a_id_e698b76e-46bd-11eb-8b25-0cc47a792c0a_files/background355.jpg" width=504 height=666></div>
<div style="position:absolute;left:258.83px;top:63.00px" class="cls_016"><span class="cls_016">Index</span></div>
<div style="position:absolute;left:121.50px;top:182.00px" class="cls_218"><span class="cls_218">Symbols</span></div>
<div style="position:absolute;left:312.00px;top:182.50px" class="cls_009"><span class="cls_009">NODE_CALL</span><span class="cls_030">, 23, 26, 35-43</span></div>
<div style="position:absolute;left:312.00px;top:192.50px" class="cls_009"><span class="cls_009">NODE_DVAR</span><span class="cls_030">, 41</span></div>
<div style="position:absolute;left:121.50px;top:197.50px" class="cls_009"><span class="cls_009">&</span><span class="cls_030"> operator, 47</span></div>
<div style="position:absolute;left:312.00px;top:202.50px" class="cls_009"><span class="cls_009">NODE_FCALL</span><span class="cls_030">, 34-38, 41-43</span></div>
<div style="position:absolute;left:121.50px;top:207.50px" class="cls_009"><span class="cls_009">$&</span><span class="cls_030"> special variable, 76</span></div>
<div style="position:absolute;left:312.00px;top:212.50px" class="cls_009"><span class="cls_009">NODE_ITER</span><span class="cls_030">, 39-41</span></div>
<div style="position:absolute;left:121.50px;top:217.50px" class="cls_009"><span class="cls_009">*</span><span class="cls_030"> (splat) operator, 47</span></div>
<div style="position:absolute;left:312.00px;top:222.50px" class="cls_009"><span class="cls_009">NODE_SCOPE</span><span class="cls_030">, 34-44, 46</span></div>
<div style="position:absolute;left:297.00px;top:232.50px" class="cls_009"><span class="cls_009">attr_accessor</span><span class="cls_030"> method, 98-99, 116</span></div>
<div style="position:absolute;left:121.50px;top:239.00px" class="cls_218"><span class="cls_218">A</span></div>
<div style="position:absolute;left:297.00px;top:242.50px" class="cls_030"><span class="cls_030">attribute get and set methods, 94, 98-99</span></div>
<div style="position:absolute;left:297.00px;top:252.49px" class="cls_030"><span class="cls_030">attribute names, 116-119</span></div>
<div style="position:absolute;left:121.50px;top:254.50px" class="cls_030"><span class="cls_030">abstract syntax tree (AST), 23-29, 32-44.</span></div>
<div style="position:absolute;left:166.50px;top:264.50px" class="cls_066"><span class="cls_066">See also</span><span class="cls_030"> AST nodes</span></div>
<div style="position:absolute;left:297.00px;top:262.49px" class="cls_030"><span class="cls_030">attribute names table, 125, 127</span></div>
<div style="position:absolute;left:121.50px;top:274.49px" class="cls_030"><span class="cls_030">algorithm</span></div>
<div style="position:absolute;left:297.00px;top:272.50px" class="cls_009"><span class="cls_009">attr_reader</span><span class="cls_030"> method</span></div>
<div style="position:absolute;left:136.50px;top:284.49px" class="cls_030"><span class="cls_030">constant lookup, 162, 163-164</span></div>
<div style="position:absolute;left:312.00px;top:282.50px" class="cls_030"><span class="cls_030">calling, 97-98</span></div>
<div style="position:absolute;left:136.50px;top:294.48px" class="cls_030"><span class="cls_030">Immix, 315</span></div>
<div style="position:absolute;left:312.00px;top:292.49px" class="cls_030"><span class="cls_030">optimization by method dispatch,</span></div>
<div style="position:absolute;left:136.50px;top:304.48px" class="cls_030"><span class="cls_030">LALR parse, 13-19</span></div>
<div style="position:absolute;left:342.00px;top:302.49px" class="cls_030"><span class="cls_030">98-99</span></div>
<div style="position:absolute;left:136.50px;top:314.48px" class="cls_030"><span class="cls_030">method lookup, 138-151</span></div>
<div style="position:absolute;left:297.00px;top:312.48px" class="cls_030"><span class="cls_030">ATTRSET methods, 94, 98-99</span></div>
<div style="position:absolute;left:136.50px;top:324.47px" class="cls_030"><span class="cls_030">semi-space, 311-312</span></div>
<div style="position:absolute;left:297.00px;top:322.50px" class="cls_009"><span class="cls_009">attr_writer</span><span class="cls_030"> method</span></div>
<div style="position:absolute;left:312.00px;top:332.50px" class="cls_030"><span class="cls_030">calling, 97-98</span></div>
<div style="position:absolute;left:121.50px;top:334.50px" class="cls_009"><span class="cls_009">allocator</span><span class="cls_030"> pointer, 126</span></div>
<div style="position:absolute;left:312.00px;top:342.49px" class="cls_030"><span class="cls_030">optimization by method dispatch,</span></div>
<div style="position:absolute;left:121.50px;top:344.50px" class="cls_009"><span class="cls_009">ancestors</span><span class="cls_030"> method, 259</span></div>
<div style="position:absolute;left:121.50px;top:354.50px" class="cls_030"><span class="cls_030">Appleby, Austin, 183</span></div>
<div style="position:absolute;left:342.00px;top:352.49px" class="cls_030"><span class="cls_030">98-99</span></div>
<div style="position:absolute;left:121.50px;top:364.50px" class="cls_009"><span class="cls_009">args_add_block</span><span class="cls_030"> AST node, 25</span></div>
<div style="position:absolute;left:297.00px;top:362.50px" class="cls_009"><span class="cls_009">autoload</span><span class="cls_030"> keyword, 164</span></div>
<div style="position:absolute;left:121.50px;top:374.50px" class="cls_030"><span class="cls_030">arguments</span></div>
<div style="position:absolute;left:136.51px;top:384.49px" class="cls_030"><span class="cls_030">to a block, 96</span></div>
<div style="position:absolute;left:297.00px;top:384.00px" class="cls_218"><span class="cls_218">B</span></div>
<div style="position:absolute;left:136.51px;top:394.49px" class="cls_030"><span class="cls_030">default values for, 47</span></div>
<div style="position:absolute;left:297.00px;top:399.50px" class="cls_030"><span class="cls_030">backtraces, in Rubinius and MRI,</span></div>
<div style="position:absolute;left:136.51px;top:404.48px" class="cls_030"><span class="cls_030">keyword</span></div>
<div style="position:absolute;left:342.00px;top:409.50px" class="cls_030"><span class="cls_030">281-284</span></div>
<div style="position:absolute;left:151.51px;top:414.48px" class="cls_030"><span class="cls_030">compiling, 49</span></div>
<div style="position:absolute;left:297.00px;top:419.49px" class="cls_030"><span class="cls_030">Baker, Henry, 309</span></div>
<div style="position:absolute;left:151.51px;top:424.48px" class="cls_030"><span class="cls_030">exploring how Ruby implements,</span></div>
<div style="position:absolute;left:297.00px;top:429.50px" class="cls_009"><span class="cls_009">BasicObject</span><span class="cls_030"> class, 259</span></div>
<div style="position:absolute;left:166.51px;top:434.47px" class="cls_030"><span class="cls_030">99-103</span></div>
<div style="position:absolute;left:297.00px;top:439.50px" class="cls_030"><span class="cls_030">benchmarking Ruby versions, 65-67</span></div>
<div style="position:absolute;left:136.51px;top:444.47px" class="cls_030"><span class="cls_030">method, 70-71</span></div>
<div style="position:absolute;left:297.00px;top:449.50px" class="cls_009"><span class="cls_009">binary</span><span class="cls_030"> AST node, 27-28</span></div>
<div style="position:absolute;left:136.51px;top:454.46px" class="cls_030"><span class="cls_030">optional, 48, 96</span></div>
<div style="position:absolute;left:297.00px;top:459.50px" class="cls_030"><span class="cls_030">bin density (in a hash table), 175</span></div>
<div style="position:absolute;left:136.51px;top:464.46px" class="cls_030"><span class="cls_030">preparing, for normal Ruby</span></div>
<div style="position:absolute;left:297.00px;top:469.50px" class="cls_009"><span class="cls_009">Binding</span><span class="cls_030"> class, 208</span></div>
<div style="position:absolute;left:166.51px;top:474.46px" class="cls_030"><span class="cls_030">methods, 95</span></div>
<div style="position:absolute;left:297.00px;top:479.50px" class="cls_009"><span class="cls_009">binding</span><span class="cls_030"> keyword, 238</span></div>
<div style="position:absolute;left:136.51px;top:484.45px" class="cls_030"><span class="cls_030">unnamed, 47, 96</span></div>
<div style="position:absolute;left:297.00px;top:489.50px" class="cls_030"><span class="cls_030">bins (in a hash table), 169</span></div>
<div style="position:absolute;left:121.50px;top:494.50px" class="cls_009"><span class="cls_009">ARGV</span><span class="cls_030"> array, 65, 75, 79, 262</span></div>
<div style="position:absolute;left:297.00px;top:499.49px" class="cls_030"><span class="cls_030">Bison, 12, 22-23</span></div>
<div style="position:absolute;left:121.50px;top:504.50px" class="cls_009"><span class="cls_009">Array</span><span class="cls_030"> (C++ class), 287</span></div>
<div style="position:absolute;left:297.00px;top:509.49px" class="cls_030"><span class="cls_030">bitmap marking, 299-300</span></div>
<div style="position:absolute;left:121.50px;top:514.50px" class="cls_009"><span class="cls_009">Array</span><span class="cls_030"> class, 294-291</span></div>
<div style="position:absolute;left:297.00px;top:519.48px" class="cls_030"><span class="cls_030">Blackburn, Stephen M., 324</span></div>
<div style="position:absolute;left:121.50px;top:524.50px" class="cls_030"><span class="cls_030">arrays, in Rubinius and MRI, 284-287</span></div>
<div style="position:absolute;left:297.00px;top:529.48px" class="cls_030"><span class="cls_030">block arguments, 96</span></div>
<div style="position:absolute;left:121.50px;top:534.50px" class="cls_009"><span class="cls_009">Array#sample</span><span class="cls_030"> method, 260-263</span></div>
<div style="position:absolute;left:297.00px;top:539.48px" class="cls_030"><span class="cls_030">blocks</span></div>
<div style="position:absolute;left:121.50px;top:544.50px" class="cls_009"><span class="cls_009">Array#shift</span><span class="cls_030"> method, 288-291</span></div>
<div style="position:absolute;left:312.00px;top:549.47px" class="cls_030"><span class="cls_030">calling a method with, 71-72</span></div>
<div style="position:absolute;left:121.50px;top:554.50px" class="cls_030"><span class="cls_030">AST (abstract syntax tree), 23-29, 32-44.</span></div>
<div style="position:absolute;left:312.00px;top:559.47px" class="cls_030"><span class="cls_030">as closures, 192-198</span></div>
<div style="position:absolute;left:166.50px;top:564.49px" class="cls_066"><span class="cls_066">See also</span><span class="cls_030"> AST nodes</span></div>
<div style="position:absolute;left:312.00px;top:569.46px" class="cls_030"><span class="cls_030">calling, 61-62, 194-196</span></div>
<div style="position:absolute;left:121.50px;top:574.49px" class="cls_030"><span class="cls_030">AST nodes, 23-29, 32-44</span></div>
<div style="position:absolute;left:312.00px;top:579.46px" class="cls_030"><span class="cls_030">compiling calls to, 38-44</span></div>
<div style="position:absolute;left:136.50px;top:584.50px" class="cls_009"><span class="cls_009">args_add_block</span><span class="cls_030">, 25</span></div>
<div style="position:absolute;left:312.00px;top:589.46px" class="cls_030"><span class="cls_030">lexical scope for, representation by</span></div>
<div style="position:absolute;left:136.50px;top:594.50px" class="cls_009"><span class="cls_009">binary</span><span class="cls_030">, 27-28</span></div>
<div style="position:absolute;left:342.00px;top:599.45px" class="cls_030"><span class="cls_030">Ruby, 244-245</span></div>
<div style="position:absolute;left:136.50px;top:604.50px" class="cls_009"><span class="cls_009">NEW_CALL</span><span class="cls_030">, 22-23</span></div>
<div style="position:absolute;left:312.00px;top:609.45px" class="cls_030"><span class="cls_030">vs. </span><span class="cls_009">while</span><span class="cls_030"> loops, speed of, 200-203</span></div>
</div>
<div style="position:absolute;left:50%;margin-left:-252px;top:236600px;width:504px;height:666px;border-style:outset;overflow:hidden">
<div style="position:absolute;left:0px;top:0px">
<img src="e698b76e-46bd-11eb-8b25-0cc47a792c0a_id_e698b76e-46bd-11eb-8b25-0cc47a792c0a_files/background356.jpg" width=504 height=666></div>
<div style="position:absolute;left:121.50px;top:42.89px" class="cls_030"><span class="cls_030">BMETHOD methods, 94</span></div>
<div style="position:absolute;left:312.01px;top:42.88px" class="cls_030"><span class="cls_030">singleton, 130, 226-227</span></div>
<div style="position:absolute;left:121.50px;top:52.89px" class="cls_009"><span class="cls_009">brace_block</span><span class="cls_030"> grammar rule, 21</span></div>
<div style="position:absolute;left:312.00px;top:52.89px" class="cls_009"><span class="cls_009">String</span><span class="cls_030">, 263-271</span></div>
<div style="position:absolute;left:121.50px;top:62.89px" class="cls_009"><span class="cls_009">branchunless</span><span class="cls_030"> YARV instruction, 85</span></div>
<div style="position:absolute;left:297.00px;top:62.89px" class="cls_009"><span class="cls_009">class_eval</span><span class="cls_030"> method, 244</span></div>
<div style="position:absolute;left:121.50px;top:72.88px" class="cls_030"><span class="cls_030">built-in Ruby methods, calling, 97-99</span></div>
<div style="position:absolute;left:297.00px;top:72.88px" class="cls_030"><span class="cls_030">class instance variables, 120-122</span></div>
<div style="position:absolute;left:121.50px;top:82.88px" class="cls_030"><span class="cls_030">bump allocation, 310</span></div>
<div style="position:absolute;left:297.00px;top:82.89px" class="cls_009"><span class="cls_009">class</span><span class="cls_030"> keyword, 221</span></div>
<div style="position:absolute;left:121.50px;top:92.88px" class="cls_030"><span class="cls_030">bytecode, 33</span></div>
<div style="position:absolute;left:297.00px;top:92.89px" class="cls_009"><span class="cls_009">class</span><span class="cls_030"> method, 111</span></div>
<div style="position:absolute;left:121.50px;top:102.89px" class="cls_009"><span class="cls_009">--bytecode</span><span class="cls_030"> ( JRuby option), 256</span></div>
<div style="position:absolute;left:297.00px;top:102.88px" class="cls_030"><span class="cls_030">class methods, 127-130</span></div>
<div style="position:absolute;left:121.50px;top:112.88px" class="cls_030"><span class="cls_030">bytecode instructions</span></div>
<div style="position:absolute;left:312.00px;top:112.88px" class="cls_030"><span class="cls_030">defining</span></div>
<div style="position:absolute;left:136.50px;top:122.88px" class="cls_030"><span class="cls_030">Java, 254</span></div>
<div style="position:absolute;left:327.00px;top:122.88px" class="cls_030"><span class="cls_030">using a new lexical scope, 224</span></div>
<div style="position:absolute;left:136.50px;top:132.88px" class="cls_030"><span class="cls_030">Rubinius, 277, 278-279</span></div>
<div style="position:absolute;left:327.00px;top:132.87px" class="cls_030"><span class="cls_030">using an object prefix, 223</span></div>
<div style="position:absolute;left:121.50px;top:142.89px" class="cls_009"><span class="cls_009">ByteList</span><span class="cls_030"> ( Java object), 264</span></div>
<div style="position:absolute;left:312.00px;top:142.87px" class="cls_030"><span class="cls_030">scope of, 236</span></div>
<div style="position:absolute;left:297.00px;top:152.89px" class="cls_009"><span class="cls_009">Class.new</span><span class="cls_030"> method, 113</span></div>
<div style="position:absolute;left:297.00px;top:162.88px" class="cls_030"><span class="cls_030">class pointers, 106, 107, 109</span></div>
<div style="position:absolute;left:121.50px;top:164.39px" class="cls_218"><span class="cls_218">C</span></div>
<div style="position:absolute;left:297.00px;top:172.88px" class="cls_030"><span class="cls_030">class scope, 232-234</span></div>
<div style="position:absolute;left:121.50px;top:179.89px" class="cls_030"><span class="cls_030">C++, working together with Ruby,</span></div>
<div style="position:absolute;left:297.00px;top:182.88px" class="cls_030"><span class="cls_030">class variables, 120-124</span></div>
<div style="position:absolute;left:166.50px;top:189.88px" class="cls_030"><span class="cls_030">279-280</span></div>
<div style="position:absolute;left:297.00px;top:192.87px" class="cls_030"><span class="cls_030">clearing, Ruby’s method caches, 143-144</span></div>
<div style="position:absolute;left:121.50px;top:199.88px" class="cls_030"><span class="cls_030">C4 (continuously concurrent</span></div>
<div style="position:absolute;left:297.00px;top:202.87px" class="cls_030"><span class="cls_030">climbing, environment pointer ladder</span></div>
<div style="position:absolute;left:166.50px;top:209.88px" class="cls_030"><span class="cls_030">compacting) collector, 320</span></div>
<div style="position:absolute;left:342.00px;top:212.86px" class="cls_030"><span class="cls_030">in C, 74-75</span></div>
<div style="position:absolute;left:121.50px;top:219.87px" class="cls_030"><span class="cls_030">caches, clearing Ruby’s method, 143-144</span></div>
<div style="position:absolute;left:297.00px;top:222.86px" class="cls_030"><span class="cls_030">closures, 191, 197</span></div>
<div style="position:absolute;left:121.50px;top:229.87px" class="cls_030"><span class="cls_030">calling</span></div>
<div style="position:absolute;left:312.00px;top:232.86px" class="cls_030"><span class="cls_030">blocks as, 192-198</span></div>
<div style="position:absolute;left:136.50px;top:239.89px" class="cls_009"><span class="cls_009">attr_reader</span><span class="cls_030">, 97-98</span></div>
<div style="position:absolute;left:312.00px;top:242.85px" class="cls_030"><span class="cls_030">and current value of </span><span class="cls_009">self</span><span class="cls_030">, 241-242</span></div>
<div style="position:absolute;left:136.50px;top:249.89px" class="cls_009"><span class="cls_009">attr_writer</span><span class="cls_030">, 97-98</span></div>
<div style="position:absolute;left:312.00px;top:252.88px" class="cls_030"><span class="cls_030">defining methods with, 246-248</span></div>
<div style="position:absolute;left:136.50px;top:259.88px" class="cls_030"><span class="cls_030">blocks, 61-62, 194-196</span></div>
<div style="position:absolute;left:312.00px;top:262.88px" class="cls_030"><span class="cls_030">and metaprogramming, 236-244</span></div>
<div style="position:absolute;left:136.50px;top:269.88px" class="cls_030"><span class="cls_030">built-in Ruby methods, 97-99</span></div>
<div style="position:absolute;left:297.00px;top:272.88px" class="cls_030"><span class="cls_030">code</span></div>
<div style="position:absolute;left:136.50px;top:279.89px" class="cls_009"><span class="cls_009">eval</span><span class="cls_030"> with </span><span class="cls_009">binding</span><span class="cls_030">, 238-240</span></div>
<div style="position:absolute;left:312.00px;top:282.87px" class="cls_030"><span class="cls_030">how JRuby executes, 255-257</span></div>
<div style="position:absolute;left:136.50px;top:289.89px" class="cls_009"><span class="cls_009">lambda</span><span class="cls_030"> more than once in the same</span></div>
<div style="position:absolute;left:312.00px;top:292.87px" class="cls_030"><span class="cls_030">how JRuby parses and compiles,</span></div>
<div style="position:absolute;left:166.50px;top:299.88px" class="cls_030"><span class="cls_030">scope, 216-217</span></div>
<div style="position:absolute;left:342.00px;top:302.86px" class="cls_030"><span class="cls_030">254-255</span></div>
<div style="position:absolute;left:136.50px;top:309.88px" class="cls_030"><span class="cls_030">lambdas, 209-211</span></div>
<div style="position:absolute;left:312.00px;top:312.86px" class="cls_030"><span class="cls_030">that writes code, 236-238</span></div>
<div style="position:absolute;left:136.50px;top:319.88px" class="cls_030"><span class="cls_030">methods with blocks, 71-72</span></div>
<div style="position:absolute;left:297.00px;top:322.86px" class="cls_066"><span class="cls_066">codeloader.rb</span><span class="cls_030"> file, 283</span></div>
<div style="position:absolute;left:136.50px;top:329.87px" class="cls_030"><span class="cls_030">normal Ruby methods, 95-97</span></div>
<div style="position:absolute;left:297.00px;top:332.85px" class="cls_030"><span class="cls_030">compilation, 31</span></div>
<div style="position:absolute;left:121.50px;top:339.87px" class="cls_030"><span class="cls_030">call stack, 56</span></div>
<div style="position:absolute;left:297.00px;top:342.85px" class="cls_066"><span class="cls_066">compile.c</span><span class="cls_030"> file, 42</span></div>
<div style="position:absolute;left:121.50px;top:349.86px" class="cls_030"><span class="cls_030">catch tables, 88-90</span></div>
<div style="position:absolute;left:297.00px;top:352.84px" class="cls_030"><span class="cls_030">compiling</span></div>
<div style="position:absolute;left:121.50px;top:359.89px" class="cls_009"><span class="cls_009">CFP</span><span class="cls_030"> (control frame pointer), 57, 88, 95</span></div>
<div style="position:absolute;left:312.00px;top:362.84px" class="cls_030"><span class="cls_030">calls to blocks, 38-44</span></div>
<div style="position:absolute;left:121.50px;top:369.88px" class="cls_030"><span class="cls_030">CFUNC methods, 61, 94, 97</span></div>
<div style="position:absolute;left:312.00px;top:372.84px" class="cls_030"><span class="cls_030">keyword arguments, 49</span></div>
<div style="position:absolute;left:121.50px;top:379.88px" class="cls_030"><span class="cls_030">child grammar rule, 15</span></div>
<div style="position:absolute;left:312.00px;top:382.83px" class="cls_030"><span class="cls_030">optional arguments, 48</span></div>
<div style="position:absolute;left:121.50px;top:389.89px" class="cls_009"><span class="cls_009">Class</span><span class="cls_030"> (C++ class), 280</span></div>
<div style="position:absolute;left:312.00px;top:392.83px" class="cls_030"><span class="cls_030">simple scripts, 34-38</span></div>
<div style="position:absolute;left:121.50px;top:399.89px" class="cls_009"><span class="cls_009">Class</span><span class="cls_030"> (Ruby class), 117</span></div>
<div style="position:absolute;left:297.00px;top:402.82px" class="cls_030"><span class="cls_030">compilers</span></div>
<div style="position:absolute;left:121.50px;top:409.89px" class="cls_009"><span class="cls_009">class &lt;&lt;</span><span class="cls_030"> metaprogramming syntax, 225</span></div>
<div style="position:absolute;left:312.00px;top:412.82px" class="cls_030"><span class="cls_030">introduced in Ruby 1.9 and 2.0, 33-34</span></div>
<div style="position:absolute;left:121.50px;top:419.89px" class="cls_009"><span class="cls_009">class_alloc </span><span class="cls_030">C function, 155</span></div>
<div style="position:absolute;left:312.00px;top:422.82px" class="cls_030"><span class="cls_030">Rubinius, 277, 290</span></div>
<div style="position:absolute;left:121.50px;top:429.88px" class="cls_030"><span class="cls_030">classes</span></div>
<div style="position:absolute;left:297.00px;top:432.89px" class="cls_009"><span class="cls_009">compstmt</span><span class="cls_030"> grammar rule, 21</span></div>
<div style="position:absolute;left:136.50px;top:439.89px" class="cls_009"><span class="cls_009">Array</span><span class="cls_030">, 284-291</span></div>
<div style="position:absolute;left:297.00px;top:442.88px" class="cls_030"><span class="cls_030">concurrent collector (in the JVM), 320</span></div>
<div style="position:absolute;left:136.50px;top:449.89px" class="cls_009"><span class="cls_009">BasicObject</span><span class="cls_030">, 259</span></div>
<div style="position:absolute;left:297.00px;top:452.88px" class="cls_030"><span class="cls_030">concurrent garbage collection, 205, 317</span></div>
<div style="position:absolute;left:136.50px;top:459.89px" class="cls_009"><span class="cls_009">Binding</span><span class="cls_030">, 208</span></div>
<div style="position:absolute;left:312.01px;top:462.88px" class="cls_030"><span class="cls_030">in the JVM, 320-321</span></div>
<div style="position:absolute;left:136.50px;top:469.89px" class="cls_009"><span class="cls_009">Enumerator</span><span class="cls_030">, 284</span></div>
<div style="position:absolute;left:312.01px;top:472.87px" class="cls_030"><span class="cls_030">marking objects, 317-318</span></div>
<div style="position:absolute;left:136.50px;top:479.89px" class="cls_009"><span class="cls_009">Fixnum</span><span class="cls_030">, 110</span></div>
<div style="position:absolute;left:312.01px;top:482.87px" class="cls_030"><span class="cls_030">tricolor marking, 319-320</span></div>
<div style="position:absolute;left:136.50px;top:489.89px" class="cls_009"><span class="cls_009">Hash</span><span class="cls_030">, 169</span></div>
<div style="position:absolute;left:297.00px;top:492.86px" class="cls_030"><span class="cls_030">constants, 124-125</span></div>
<div style="position:absolute;left:136.50px;top:499.88px" class="cls_030"><span class="cls_030">included, 137, 152-154</span></div>
<div style="position:absolute;left:312.01px;top:502.86px" class="cls_030"><span class="cls_030">creating, for a new class or module,</span></div>
<div style="position:absolute;left:136.50px;top:509.89px" class="cls_009"><span class="cls_009">Integer</span><span class="cls_030">, 62, 72, 97, 142-143, 282-284</span></div>
<div style="position:absolute;left:342.00px;top:512.86px" class="cls_030"><span class="cls_030">159-160</span></div>
<div style="position:absolute;left:136.50px;top:519.89px" class="cls_009"><span class="cls_009">Object</span><span class="cls_030">, 133, 157-158, 231-232</span></div>
<div style="position:absolute;left:312.01px;top:522.85px" class="cls_030"><span class="cls_030">finding, 156-158, 160-161</span></div>
<div style="position:absolute;left:136.50px;top:529.88px" class="cls_030"><span class="cls_030">origin, 150</span></div>
<div style="position:absolute;left:312.01px;top:532.85px" class="cls_030"><span class="cls_030">lookup algorithm, 162, 163-164</span></div>
<div style="position:absolute;left:136.50px;top:539.89px" class="cls_009"><span class="cls_009">Proc</span><span class="cls_030">, 211-213</span></div>
<div style="position:absolute;left:312.01px;top:542.84px" class="cls_030"><span class="cls_030">table, 125</span></div>
<div style="position:absolute;left:136.50px;top:549.89px" class="cls_009"><span class="cls_009">Ripper</span><span class="cls_030">, 9-12, 22-29</span></div>
<div style="position:absolute;left:297.00px;top:552.89px" class="cls_009"><span class="cls_009">const_missing</span><span class="cls_030"> method, 164</span></div>
<div style="position:absolute;left:136.50px;top:559.88px" class="cls_030"><span class="cls_030">Ruby, implementing with Java classes,</span></div>
<div style="position:absolute;left:297.00px;top:562.89px" class="cls_009"><span class="cls_009">const_tbl</span><span class="cls_030"> pointer, 126</span></div>
<div style="position:absolute;left:166.50px;top:569.88px" class="cls_030"><span class="cls_030">257-259</span></div>
<div style="position:absolute;left:297.00px;top:572.88px" class="cls_030"><span class="cls_030">continuously concurrent compacting</span></div>
<div style="position:absolute;left:136.50px;top:579.89px" class="cls_009"><span class="cls_009">RubyVM::InstructionSequence</span><span class="cls_030">, 44-45,</span></div>
<div style="position:absolute;left:342.00px;top:582.88px" class="cls_030"><span class="cls_030">(C4) collector, 320</span></div>
<div style="position:absolute;left:166.50px;top:589.88px" class="cls_030"><span class="cls_030">51-53</span></div>
<div style="position:absolute;left:297.00px;top:592.88px" class="cls_030"><span class="cls_030">control frame pointer (</span><span class="cls_009">CFP</span><span class="cls_030">), 57, 88, 95</span></div>
<div style="position:absolute;left:136.51px;top:599.88px" class="cls_030"><span class="cls_030">seeing methods and submodules,</span></div>
<div style="position:absolute;left:297.00px;top:602.88px" class="cls_030"><span class="cls_030">copying, a stack frame to the heap,</span></div>
<div style="position:absolute;left:166.50px;top:609.88px" class="cls_030"><span class="cls_030">152-153</span></div>
<div style="position:absolute;left:342.00px;top:612.88px" class="cls_030"><span class="cls_030">208, 209</span></div>
<div style="position:absolute;left:49.50px;top:632.00px" class="cls_020"><span class="cls_020">332</span><span class="cls_009">   </span><span class="cls_021">Index</span></div>
</div>
<div style="position:absolute;left:50%;margin-left:-252px;top:237276px;width:504px;height:666px;border-style:outset;overflow:hidden">
<div style="position:absolute;left:0px;top:0px">
<img src="e698b76e-46bd-11eb-8b25-0cc47a792c0a_id_e698b76e-46bd-11eb-8b25-0cc47a792c0a_files/background357.jpg" width=504 height=666></div>
<div style="position:absolute;left:121.50px;top:42.31px" class="cls_030"><span class="cls_030">copying garbage collection, 205, 309</span></div>
<div style="position:absolute;left:297.00px;top:42.31px" class="cls_030"><span class="cls_030">executing</span></div>
<div style="position:absolute;left:136.50px;top:52.31px" class="cls_030"><span class="cls_030">bump allocation, 310-311</span></div>
<div style="position:absolute;left:312.00px;top:52.31px" class="cls_030"><span class="cls_030">calls to blocks, 61-62, 194-196</span></div>
<div style="position:absolute;left:136.50px;top:62.30px" class="cls_030"><span class="cls_030">Eden heap, 312-313</span></div>
<div style="position:absolute;left:312.00px;top:62.31px" class="cls_009"><span class="cls_009">if</span><span class="cls_030"> statements, 84-86</span></div>
<div style="position:absolute;left:136.50px;top:72.30px" class="cls_030"><span class="cls_030">and semi-space algorithm, 311-312</span></div>
<div style="position:absolute;left:312.00px;top:72.31px" class="cls_030"><span class="cls_030">simple scripts, 58-60</span></div>
<div style="position:absolute;left:121.50px;top:82.29px" class="cls_030"><span class="cls_030">copy-on-write</span></div>
<div style="position:absolute;left:297.00px;top:82.30px" class="cls_030"><span class="cls_030">expanding hash tables, 174-175</span></div>
<div style="position:absolute;left:136.50px;top:92.29px" class="cls_030"><span class="cls_030">for strings, 265-271</span></div>
<div style="position:absolute;left:297.00px;top:92.30px" class="cls_030"><span class="cls_030">experiments</span></div>
<div style="position:absolute;left:136.50px;top:102.29px" class="cls_030"><span class="cls_030">in Unix, 300</span></div>
<div style="position:absolute;left:312.00px;top:102.31px" class="cls_009"><span class="cls_009">Array#shift</span><span class="cls_030">, Rubinius implementa-</span></div>
<div style="position:absolute;left:121.50px;top:112.31px" class="cls_009"><span class="cls_009">core#define_method</span><span class="cls_030"> method, 53</span></div>
<div style="position:absolute;left:342.00px;top:112.31px" class="cls_030"><span class="cls_030">tion of, 288-291</span></div>
<div style="position:absolute;left:121.50px;top:122.31px" class="cls_009"><span class="cls_009">count_objects</span><span class="cls_030"> method, 129</span></div>
<div style="position:absolute;left:312.00px;top:122.30px" class="cls_030"><span class="cls_030">backtraces, comparing in MRI and</span></div>
<div style="position:absolute;left:121.50px;top:132.31px" class="cls_030"><span class="cls_030">creating</span></div>
<div style="position:absolute;left:342.00px;top:132.30px" class="cls_030"><span class="cls_030">Rubinius, 281-284</span></div>
<div style="position:absolute;left:136.51px;top:142.30px" class="cls_030"><span class="cls_030">constants, for a new class or module,</span></div>
<div style="position:absolute;left:312.00px;top:142.29px" class="cls_030"><span class="cls_030">class methods, where Ruby saves,</span></div>
<div style="position:absolute;left:166.50px;top:152.30px" class="cls_030"><span class="cls_030">159-160</span></div>
<div style="position:absolute;left:342.00px;top:152.29px" class="cls_030"><span class="cls_030">127-130</span></div>
<div style="position:absolute;left:136.51px;top:162.29px" class="cls_030"><span class="cls_030">lambdas, 207-209</span></div>
<div style="position:absolute;left:312.00px;top:162.29px" class="cls_030"><span class="cls_030">closures, defining methods with,</span></div>
<div style="position:absolute;left:136.51px;top:172.29px" class="cls_030"><span class="cls_030">refinements, 228</span></div>
<div style="position:absolute;left:342.00px;top:172.28px" class="cls_030"><span class="cls_030">246-248</span></div>
<div style="position:absolute;left:136.51px;top:182.29px" class="cls_030"><span class="cls_030">unique and nonshared strings, 267</span></div>
<div style="position:absolute;left:312.00px;top:182.28px" class="cls_030"><span class="cls_030">constant, which Ruby finds first,</span></div>
<div style="position:absolute;left:121.50px;top:192.31px" class="cls_009"><span class="cls_009">cref</span><span class="cls_030"> (C structure), 244, 245</span></div>
<div style="position:absolute;left:342.00px;top:192.27px" class="cls_030"><span class="cls_030">162-164</span></div>
<div style="position:absolute;left:121.50px;top:202.31px" class="cls_009"><span class="cls_009">cref</span><span class="cls_030"> pointer, 68, 78</span></div>
<div style="position:absolute;left:312.00px;top:202.27px" class="cls_030"><span class="cls_030">copy-on-write performance,</span></div>
<div style="position:absolute;left:342.00px;top:212.27px" class="cls_030"><span class="cls_030">measuring, 267-271</span></div>
<div style="position:absolute;left:121.50px;top:220.81px" class="cls_218"><span class="cls_218">D</span></div>
<div style="position:absolute;left:312.00px;top:222.31px" class="cls_009"><span class="cls_009">for</span><span class="cls_030"> loops, how Ruby implements,</span></div>
<div style="position:absolute;left:342.00px;top:232.31px" class="cls_030"><span class="cls_030">90-92</span></div>
<div style="position:absolute;left:121.50px;top:236.31px" class="cls_030"><span class="cls_030">default values, for arguments, 47</span></div>
<div style="position:absolute;left:312.00px;top:242.30px" class="cls_030"><span class="cls_030">garbage collection (MRI), seeing in</span></div>
<div style="position:absolute;left:121.50px;top:246.31px" class="cls_009"><span class="cls_009">define_method </span><span class="cls_030">method, 246</span></div>
<div style="position:absolute;left:342.00px;top:252.30px" class="cls_030"><span class="cls_030">action, 302-308</span></div>
<div style="position:absolute;left:121.50px;top:256.31px" class="cls_030"><span class="cls_030">defining</span></div>
<div style="position:absolute;left:312.00px;top:262.29px" class="cls_030"><span class="cls_030">hashes</span></div>
<div style="position:absolute;left:136.51px;top:266.30px" class="cls_030"><span class="cls_030">class methods</span></div>
<div style="position:absolute;left:327.01px;top:272.29px" class="cls_030"><span class="cls_030">inserting new element into,</span></div>
<div style="position:absolute;left:151.51px;top:276.30px" class="cls_030"><span class="cls_030">using a new lexical scope, 224</span></div>
<div style="position:absolute;left:342.01px;top:282.29px" class="cls_030"><span class="cls_030">177-179</span></div>
<div style="position:absolute;left:151.51px;top:286.29px" class="cls_030"><span class="cls_030">using an object prefix, 223</span></div>
<div style="position:absolute;left:327.01px;top:292.28px" class="cls_030"><span class="cls_030">retrieving values from, 172-173</span></div>
<div style="position:absolute;left:136.51px;top:296.29px" class="cls_030"><span class="cls_030">methods</span></div>
<div style="position:absolute;left:327.01px;top:302.28px" class="cls_030"><span class="cls_030">using with object keys, 183-189</span></div>
<div style="position:absolute;left:151.51px;top:306.29px" class="cls_030"><span class="cls_030">alternative ways of, 223-231</span></div>
<div style="position:absolute;left:312.00px;top:312.27px" class="cls_030"><span class="cls_030">instance variable, time required</span></div>
<div style="position:absolute;left:151.51px;top:316.28px" class="cls_030"><span class="cls_030">normal process of, 221-223</span></div>
<div style="position:absolute;left:342.00px;top:322.27px" class="cls_030"><span class="cls_030">to save, 113-115</span></div>
<div style="position:absolute;left:151.51px;top:326.28px" class="cls_030"><span class="cls_030">using singleton classes, 226-227</span></div>
<div style="position:absolute;left:312.00px;top:332.27px" class="cls_030"><span class="cls_030">JIT compiler, monitoring, 260-263</span></div>
<div style="position:absolute;left:151.51px;top:336.27px" class="cls_030"><span class="cls_030">using singleton classes in a lexical</span></div>
<div style="position:absolute;left:312.00px;top:342.26px" class="cls_030"><span class="cls_030">keyword arguments, how Ruby</span></div>
<div style="position:absolute;left:166.51px;top:346.27px" class="cls_030"><span class="cls_030">scope, 227-228</span></div>
<div style="position:absolute;left:342.00px;top:352.26px" class="cls_030"><span class="cls_030">implements, 99-103</span></div>
<div style="position:absolute;left:121.50px;top:356.31px" class="cls_009"><span class="cls_009">def</span><span class="cls_030"> keyword, 221-223</span></div>
<div style="position:absolute;left:312.00px;top:362.25px" class="cls_030"><span class="cls_030">local table, displaying, 51-53</span></div>
<div style="position:absolute;left:121.50px;top:366.31px" class="cls_066"><span class="cls_066">defs/keywords</span><span class="cls_030"> file, 8</span></div>
<div style="position:absolute;left:312.00px;top:372.25px" class="cls_030"><span class="cls_030">local variables, changing after calling</span></div>
<div style="position:absolute;left:121.50px;top:376.30px" class="cls_030"><span class="cls_030">density (in a hash table), 175</span></div>
<div style="position:absolute;left:342.00px;top:382.31px" class="cls_009"><span class="cls_009">lambda</span><span class="cls_030">, 214-217</span></div>
<div style="position:absolute;left:121.50px;top:386.30px" class="cls_030"><span class="cls_030">disadvantages of mark and sweep, 302</span></div>
<div style="position:absolute;left:312.00px;top:392.31px" class="cls_030"><span class="cls_030">modules, modifying after including,</span></div>
<div style="position:absolute;left:121.50px;top:396.29px" class="cls_030"><span class="cls_030">displaying the local table, 51-53</span></div>
<div style="position:absolute;left:342.00px;top:402.30px" class="cls_030"><span class="cls_030">151-154</span></div>
<div style="position:absolute;left:121.50px;top:406.31px" class="cls_009"><span class="cls_009">--dump parsetree</span><span class="cls_030"> (Ruby option), 29</span></div>
<div style="position:absolute;left:312.00px;top:412.30px" class="cls_030"><span class="cls_030">Ruby scripts</span></div>
<div style="position:absolute;left:121.50px;top:416.31px" class="cls_009"><span class="cls_009">dup</span><span class="cls_030"> method, 265-266</span></div>
<div style="position:absolute;left:327.01px;top:422.29px" class="cls_030"><span class="cls_030">parsing, 9-12</span></div>
<div style="position:absolute;left:121.50px;top:426.31px" class="cls_030"><span class="cls_030">dynamic variable access, 71-74</span></div>
<div style="position:absolute;left:327.01px;top:432.29px" class="cls_030"><span class="cls_030">tokenizing, 9-12</span></div>
<div style="position:absolute;left:312.00px;top:442.29px" class="cls_030"><span class="cls_030">Ruby versions, benchmarking, 65-67</span></div>
<div style="position:absolute;left:121.50px;top:444.81px" class="cls_218"><span class="cls_218">E</span></div>
<div style="position:absolute;left:312.00px;top:452.31px" class="cls_009"><span class="cls_009">self</span><span class="cls_030">, how it changes with lexical</span></div>
<div style="position:absolute;left:121.50px;top:460.31px" class="cls_009"><span class="cls_009">each</span><span class="cls_030"> method, 91</span></div>
<div style="position:absolute;left:342.00px;top:462.31px" class="cls_030"><span class="cls_030">scope, 231-236</span></div>
<div style="position:absolute;left:121.50px;top:470.31px" class="cls_030"><span class="cls_030">Eden heap, 312-313</span></div>
<div style="position:absolute;left:312.01px;top:472.30px" class="cls_030"><span class="cls_030">special variables, exploring, 75-78</span></div>
<div style="position:absolute;left:121.50px;top:480.31px" class="cls_009"><span class="cls_009">ensure</span><span class="cls_030"> keyword, 90</span></div>
<div style="position:absolute;left:312.01px;top:482.30px" class="cls_030"><span class="cls_030">verbose GC mode in JRuby, using,</span></div>
<div style="position:absolute;left:121.50px;top:490.31px" class="cls_009"><span class="cls_009">Enumerator</span><span class="cls_030"> class, 284</span></div>
<div style="position:absolute;left:342.00px;top:492.29px" class="cls_030"><span class="cls_030">321-324</span></div>
<div style="position:absolute;left:121.50px;top:500.31px" class="cls_030"><span class="cls_030">environment, 197, 198</span></div>
<div style="position:absolute;left:312.00px;top:502.31px" class="cls_009"><span class="cls_009">while</span><span class="cls_030"> loops vs. passing blocks,</span></div>
<div style="position:absolute;left:121.50px;top:510.30px" class="cls_030"><span class="cls_030">environment pointer (</span><span class="cls_009">EP</span><span class="cls_030">), 68, 194, 197</span></div>
<div style="position:absolute;left:342.00px;top:512.31px" class="cls_030"><span class="cls_030">speed of, 200-203</span></div>
<div style="position:absolute;left:121.50px;top:520.31px" class="cls_030"><span class="cls_030">environment pointer ladder, 74-75</span></div>
<div style="position:absolute;left:312.01px;top:522.30px" class="cls_030"><span class="cls_030">YARV instructions, displaying, 44-45</span></div>
<div style="position:absolute;left:121.50px;top:530.31px" class="cls_009"><span class="cls_009">EP</span><span class="cls_030"> (environment pointer), 68, 194, 197</span></div>
<div style="position:absolute;left:297.00px;top:532.31px" class="cls_009"><span class="cls_009">extend</span><span class="cls_030"> method, 138</span></div>
<div style="position:absolute;left:121.50px;top:540.31px" class="cls_009"><span class="cls_009">eql?</span><span class="cls_030"> method, 175</span></div>
<div style="position:absolute;left:121.50px;top:550.31px" class="cls_009"><span class="cls_009">eval</span><span class="cls_030"> method, 78, 236-240</span></div>
<div style="position:absolute;left:297.00px;top:553.81px" class="cls_218"><span class="cls_218">F</span></div>
<div style="position:absolute;left:121.50px;top:560.31px" class="cls_030"><span class="cls_030">examples</span></div>
<div style="position:absolute;left:136.50px;top:570.30px" class="cls_030"><span class="cls_030">grammar rule, 14</span></div>
<div style="position:absolute;left:297.00px;top:569.31px" class="cls_009"><span class="cls_009">false</span><span class="cls_030"> value, 110</span></div>
<div style="position:absolute;left:136.50px;top:580.31px" class="cls_009"><span class="cls_009">instance_eval</span><span class="cls_030">, 240-241</span></div>
<div style="position:absolute;left:297.00px;top:579.31px" class="cls_030"><span class="cls_030">Fenichel, Robert R., 309</span></div>
<div style="position:absolute;left:136.50px;top:590.31px" class="cls_030"><span class="cls_030">method lookup, 139-140</span></div>
<div style="position:absolute;left:297.00px;top:589.30px" class="cls_030"><span class="cls_030">finding constants, 156-158, 160-161</span></div>
<div style="position:absolute;left:136.50px;top:600.31px" class="cls_009"><span class="cls_009">Module#prepend</span><span class="cls_030">, 146</span></div>
<div style="position:absolute;left:297.00px;top:599.30px" class="cls_030"><span class="cls_030">first-class citizen, treating a function as,</span></div>
<div style="position:absolute;left:342.00px;top:609.29px" class="cls_030"><span class="cls_030">203-213</span></div>
<div style="position:absolute;left:415.18px;top:635.00px" class="cls_021"><span class="cls_021">Index</span></div>
<div style="position:absolute;left:440.76px;top:632.00px" class="cls_020"><span class="cls_020">333</span></div>
</div>
<div style="position:absolute;left:50%;margin-left:-252px;top:237952px;width:504px;height:666px;border-style:outset;overflow:hidden">
<div style="position:absolute;left:0px;top:0px">
<img src="e698b76e-46bd-11eb-8b25-0cc47a792c0a_id_e698b76e-46bd-11eb-8b25-0cc47a792c0a_files/background358.jpg" width=504 height=666></div>
<div style="position:absolute;left:121.50px;top:42.89px" class="cls_009"><span class="cls_009">Fixnum</span><span class="cls_030"> class, 110</span></div>
<div style="position:absolute;left:297.00px;top:42.89px" class="cls_009"><span class="cls_009">generic_iv_tbl</span><span class="cls_030"> (C structure), 113</span></div>
<div style="position:absolute;left:121.50px;top:52.89px" class="cls_009"><span class="cls_009">FIXNUM_FLAG</span><span class="cls_030"> value, 110</span></div>
<div style="position:absolute;left:297.00px;top:52.88px" class="cls_030"><span class="cls_030">generic objects, 109-110, 111, 113</span></div>
<div style="position:absolute;left:121.50px;top:62.89px" class="cls_009"><span class="cls_009">for</span><span class="cls_030"> loops, 90-92</span></div>
<div style="position:absolute;left:297.00px;top:62.89px" class="cls_009"><span class="cls_009">GET_EP</span><span class="cls_030"> (C macro), 74</span></div>
<div style="position:absolute;left:121.50px;top:72.88px" class="cls_030"><span class="cls_030">free bitmap, 300</span></div>
<div style="position:absolute;left:297.00px;top:72.89px" class="cls_009"><span class="cls_009">getlocal</span><span class="cls_030"> YARV instruction,</span></div>
<div style="position:absolute;left:121.50px;top:82.88px" class="cls_030"><span class="cls_030">free lists, 297-298</span></div>
<div style="position:absolute;left:342.00px;top:82.88px" class="cls_030"><span class="cls_030">C implementation of, 74-75</span></div>
<div style="position:absolute;left:121.50px;top:92.88px" class="cls_030"><span class="cls_030">from-space, 311</span></div>
<div style="position:absolute;left:297.00px;top:92.89px" class="cls_009"><span class="cls_009">GET_PREV_EP</span><span class="cls_030"> (C macro), 75</span></div>
<div style="position:absolute;left:121.50px;top:102.87px" class="cls_030"><span class="cls_030">function, as a first-class citizen, 203-213</span></div>
<div style="position:absolute;left:297.00px;top:102.88px" class="cls_030"><span class="cls_030">getting class variables, 122</span></div>
<div style="position:absolute;left:121.50px;top:112.87px" class="cls_030"><span class="cls_030">function call, 36</span></div>
<div style="position:absolute;left:297.00px;top:112.88px" class="cls_030"><span class="cls_030">global method cache, 142</span></div>
<div style="position:absolute;left:121.50px;top:122.86px" class="cls_030"><span class="cls_030">further reading (on garbage</span></div>
<div style="position:absolute;left:297.00px;top:122.88px" class="cls_030"><span class="cls_030">global variable names, 7</span></div>
<div style="position:absolute;left:166.49px;top:132.86px" class="cls_030"><span class="cls_030">collection), 324</span></div>
<div style="position:absolute;left:297.00px;top:132.89px" class="cls_009"><span class="cls_009">goto</span><span class="cls_030"> statement, 43</span></div>
<div style="position:absolute;left:297.00px;top:142.88px" class="cls_030"><span class="cls_030">gperf, 8</span></div>
<div style="position:absolute;left:297.00px;top:152.88px" class="cls_030"><span class="cls_030">grammar rules, 14, 20, 22</span></div>
<div style="position:absolute;left:121.50px;top:154.39px" class="cls_218"><span class="cls_218">G</span></div>
<div style="position:absolute;left:312.00px;top:162.88px" class="cls_030"><span class="cls_030">Bison, 22</span></div>
<div style="position:absolute;left:121.50px;top:169.89px" class="cls_030"><span class="cls_030">G1 (garbage-first) collector, 320</span></div>
<div style="position:absolute;left:312.00px;top:172.89px" class="cls_009"><span class="cls_009">brace_block</span><span class="cls_030">, 21</span></div>
<div style="position:absolute;left:121.50px;top:179.88px" class="cls_030"><span class="cls_030">garbage collection (GC), 205, 207,</span></div>
<div style="position:absolute;left:312.00px;top:182.88px" class="cls_030"><span class="cls_030">child , 15</span></div>
<div style="position:absolute;left:166.50px;top:189.88px" class="cls_030"><span class="cls_030">295-296</span></div>
<div style="position:absolute;left:312.00px;top:192.89px" class="cls_009"><span class="cls_009">compstmt</span><span class="cls_030">, 21</span></div>
<div style="position:absolute;left:136.50px;top:199.88px" class="cls_030"><span class="cls_030">concurrent, 205, 317</span></div>
<div style="position:absolute;left:312.00px;top:202.88px" class="cls_030"><span class="cls_030">example, 14</span></div>
<div style="position:absolute;left:151.51px;top:209.87px" class="cls_030"><span class="cls_030">in the JVM, 320-321</span></div>
<div style="position:absolute;left:312.00px;top:212.89px" class="cls_009"><span class="cls_009">keyword_do</span><span class="cls_030">, 21</span></div>
<div style="position:absolute;left:151.51px;top:219.87px" class="cls_030"><span class="cls_030">marking objects, 317-318</span></div>
<div style="position:absolute;left:312.00px;top:222.89px" class="cls_009"><span class="cls_009">method_call</span><span class="cls_030">, 22</span></div>
<div style="position:absolute;left:151.51px;top:229.86px" class="cls_030"><span class="cls_030">tricolor marking, 319-320</span></div>
<div style="position:absolute;left:312.00px;top:232.89px" class="cls_009"><span class="cls_009">opt_block_param</span><span class="cls_030">, 21</span></div>
<div style="position:absolute;left:136.50px;top:239.86px" class="cls_030"><span class="cls_030">copying, 205, 309</span></div>
<div style="position:absolute;left:312.00px;top:242.88px" class="cls_030"><span class="cls_030">primary value, 21</span></div>
<div style="position:absolute;left:151.51px;top:249.86px" class="cls_030"><span class="cls_030">bump allocation, 310-311</span></div>
<div style="position:absolute;left:312.00px;top:252.89px" class="cls_009"><span class="cls_009">top_compstmt</span><span class="cls_030">, 20</span></div>
<div style="position:absolute;left:151.51px;top:259.85px" class="cls_030"><span class="cls_030">Eden heap, 312-313</span></div>
<div style="position:absolute;left:297.00px;top:262.88px" class="cls_030"><span class="cls_030">grammar rule file, 8</span></div>
<div style="position:absolute;left:151.51px;top:269.85px" class="cls_030"><span class="cls_030">and semi-space algorithm,</span></div>
<div style="position:absolute;left:297.00px;top:272.88px" class="cls_030"><span class="cls_030">grammar rule stack, 16</span></div>
<div style="position:absolute;left:166.51px;top:279.84px" class="cls_030"><span class="cls_030">311-312</span></div>
<div style="position:absolute;left:136.51px;top:289.84px" class="cls_030"><span class="cls_030">further reading, 324</span></div>
<div style="position:absolute;left:297.00px;top:291.39px" class="cls_218"><span class="cls_218">H</span></div>
<div style="position:absolute;left:136.51px;top:299.84px" class="cls_030"><span class="cls_030">garbage objects, 297</span></div>
<div style="position:absolute;left:297.00px;top:306.89px" class="cls_009"><span class="cls_009">Hash</span><span class="cls_030"> class, 169</span></div>
<div style="position:absolute;left:136.51px;top:309.83px" class="cls_030"><span class="cls_030">generational. </span><span class="cls_066">See</span><span class="cls_030"> generational</span></div>
<div style="position:absolute;left:297.00px;top:316.89px" class="cls_009"><span class="cls_009">Hash#key?</span><span class="cls_030">, 100</span></div>
<div style="position:absolute;left:166.51px;top:319.83px" class="cls_030"><span class="cls_030">garbage collection</span></div>
<div style="position:absolute;left:297.00px;top:326.89px" class="cls_009"><span class="cls_009">hash</span><span class="cls_030"> method, 182</span></div>
<div style="position:absolute;left:136.51px;top:329.82px" class="cls_030"><span class="cls_030">in JRuby, 309</span></div>
<div style="position:absolute;left:297.00px;top:336.88px" class="cls_030"><span class="cls_030">hash tables</span></div>
<div style="position:absolute;left:151.51px;top:339.82px" class="cls_030"><span class="cls_030">verbose mode, 321-324</span></div>
<div style="position:absolute;left:312.00px;top:346.88px" class="cls_030"><span class="cls_030">bin density, 175</span></div>
<div style="position:absolute;left:136.51px;top:349.82px" class="cls_030"><span class="cls_030">in the JVM, 320-321</span></div>
<div style="position:absolute;left:312.00px;top:356.88px" class="cls_030"><span class="cls_030">bins, 169</span></div>
<div style="position:absolute;left:136.51px;top:359.81px" class="cls_030"><span class="cls_030">live objects, 297</span></div>
<div style="position:absolute;left:312.00px;top:366.87px" class="cls_030"><span class="cls_030">collisions, 174</span></div>
<div style="position:absolute;left:136.51px;top:369.81px" class="cls_030"><span class="cls_030">mark-and-sweep. </span><span class="cls_066">See</span><span class="cls_030"> mark-and-sweep</span></div>
<div style="position:absolute;left:312.00px;top:376.87px" class="cls_030"><span class="cls_030">expanding, 174-175</span></div>
<div style="position:absolute;left:166.52px;top:379.80px" class="cls_030"><span class="cls_030">garbage collection</span></div>
<div style="position:absolute;left:312.00px;top:386.86px" class="cls_030"><span class="cls_030">functions, 170, 181-183</span></div>
<div style="position:absolute;left:136.52px;top:389.80px" class="cls_030"><span class="cls_030">in MRI, 297-302</span></div>
<div style="position:absolute;left:312.00px;top:396.86px" class="cls_030"><span class="cls_030">inserting new element into, 177-179</span></div>
<div style="position:absolute;left:151.52px;top:399.80px" class="cls_030"><span class="cls_030">full collection, 304-305</span></div>
<div style="position:absolute;left:312.00px;top:406.89px" class="cls_009"><span class="cls_009">key?</span><span class="cls_030"> method, 100</span></div>
<div style="position:absolute;left:151.52px;top:409.79px" class="cls_030"><span class="cls_030">interpreting GC profile report,</span></div>
<div style="position:absolute;left:312.00px;top:416.88px" class="cls_030"><span class="cls_030">optimization in Ruby 2.0, 187-189</span></div>
<div style="position:absolute;left:166.52px;top:419.79px" class="cls_030"><span class="cls_030">305-308</span></div>
<div style="position:absolute;left:312.00px;top:426.88px" class="cls_030"><span class="cls_030">packed, 188</span></div>
<div style="position:absolute;left:151.52px;top:429.78px" class="cls_030"><span class="cls_030">lazy sweeping, 303-304</span></div>
<div style="position:absolute;left:312.00px;top:436.88px" class="cls_030"><span class="cls_030">prime numbers for, 180-181</span></div>
<div style="position:absolute;left:151.50px;top:439.89px" class="cls_009"><span class="cls_009">RVALUE</span><span class="cls_030"> (C structure), 301</span></div>
<div style="position:absolute;left:312.00px;top:446.87px" class="cls_030"><span class="cls_030">rehashing entries, 175-176</span></div>
<div style="position:absolute;left:151.50px;top:449.88px" class="cls_030"><span class="cls_030">seeing in action, 302-303</span></div>
<div style="position:absolute;left:312.00px;top:456.87px" class="cls_030"><span class="cls_030">retrieving values from, 171, 172-173</span></div>
<div style="position:absolute;left:136.50px;top:459.88px" class="cls_030"><span class="cls_030">purpose of, 207</span></div>
<div style="position:absolute;left:312.00px;top:466.86px" class="cls_030"><span class="cls_030">saving values in, 169-172</span></div>
<div style="position:absolute;left:136.50px;top:469.88px" class="cls_030"><span class="cls_030">in Rubinius, 309</span></div>
<div style="position:absolute;left:312.00px;top:476.86px" class="cls_030"><span class="cls_030">using with object keys, 183-189</span></div>
<div style="position:absolute;left:136.50px;top:479.87px" class="cls_030"><span class="cls_030">in Ruby 2.1, 309, 315</span></div>
<div style="position:absolute;left:296.99px;top:486.86px" class="cls_030"><span class="cls_030">heap, 204, 297</span></div>
<div style="position:absolute;left:121.50px;top:489.87px" class="cls_030"><span class="cls_030">garbage-first (G1) collector, 320</span></div>
<div style="position:absolute;left:296.99px;top:496.85px" class="cls_030"><span class="cls_030">Hosking, Antony, 324</span></div>
<div style="position:absolute;left:121.50px;top:499.86px" class="cls_030"><span class="cls_030">garbage objects, 297, 299</span></div>
<div style="position:absolute;left:296.99px;top:506.85px" class="cls_030"><span class="cls_030">hot spots, 261</span></div>
<div style="position:absolute;left:121.50px;top:509.86px" class="cls_030"><span class="cls_030">Garden of Eden, 312-313</span></div>
<div style="position:absolute;left:121.50px;top:519.86px" class="cls_030"><span class="cls_030">GC. </span><span class="cls_066">See</span><span class="cls_030"> garbage collection</span></div>
<div style="position:absolute;left:121.50px;top:529.89px" class="cls_009"><span class="cls_009">GC.disable</span><span class="cls_030">, 113</span></div>
<div style="position:absolute;left:297.00px;top:525.39px" class="cls_218"><span class="cls_218">I</span></div>
<div style="position:absolute;left:121.50px;top:539.89px" class="cls_009"><span class="cls_009">GC::Profiler</span><span class="cls_030">, 306</span></div>
<div style="position:absolute;left:297.00px;top:540.89px" class="cls_030"><span class="cls_030">identifiers, 7</span></div>
<div style="position:absolute;left:121.50px;top:549.89px" class="cls_009"><span class="cls_009">GC.start</span><span class="cls_030">, 304</span></div>
<div style="position:absolute;left:297.00px;top:550.89px" class="cls_009"><span class="cls_009">if...else</span><span class="cls_030"> statements, 84-86</span></div>
<div style="position:absolute;left:121.50px;top:559.88px" class="cls_030"><span class="cls_030">generational garbage collection, 205, 313</span></div>
<div style="position:absolute;left:297.00px;top:560.88px" class="cls_030"><span class="cls_030">Immix algorithm, 315</span></div>
<div style="position:absolute;left:136.51px;top:569.88px" class="cls_030"><span class="cls_030">and mature objects, 315</span></div>
<div style="position:absolute;left:297.00px;top:570.88px" class="cls_030"><span class="cls_030">implementing</span></div>
<div style="position:absolute;left:136.51px;top:579.88px" class="cls_030"><span class="cls_030">promoting objects, 314-315</span></div>
<div style="position:absolute;left:312.00px;top:580.88px" class="cls_030"><span class="cls_030">hash functions, 181-183</span></div>
<div style="position:absolute;left:136.51px;top:589.87px" class="cls_030"><span class="cls_030">and references, 316</span></div>
<div style="position:absolute;left:312.00px;top:590.89px" class="cls_009"><span class="cls_009">Module#prepend</span><span class="cls_030">, 150-151</span></div>
<div style="position:absolute;left:136.51px;top:599.87px" class="cls_030"><span class="cls_030">and semi-space algorithm, 314</span></div>
<div style="position:absolute;left:312.00px;top:600.88px" class="cls_030"><span class="cls_030">modules, 135-138</span></div>
<div style="position:absolute;left:136.51px;top:609.86px" class="cls_030"><span class="cls_030">weak generational hypothesis, 313-314</span></div>
<div style="position:absolute;left:49.50px;top:632.00px" class="cls_020"><span class="cls_020">334</span><span class="cls_009">   </span><span class="cls_021">Index</span></div>
</div>
<div style="position:absolute;left:50%;margin-left:-252px;top:238628px;width:504px;height:666px;border-style:outset;overflow:hidden">
<div style="position:absolute;left:0px;top:0px">
<img src="e698b76e-46bd-11eb-8b25-0cc47a792c0a_id_e698b76e-46bd-11eb-8b25-0cc47a792c0a_files/background359.jpg" width=504 height=666></div>
<div style="position:absolute;left:136.50px;top:42.31px" class="cls_030"><span class="cls_030">Ruby classes with Java classes,</span></div>
<div style="position:absolute;left:297.00px;top:42.30px" class="cls_030"><span class="cls_030">JIT (just-in-time) compiler, 255, 260,</span></div>
<div style="position:absolute;left:166.50px;top:52.31px" class="cls_030"><span class="cls_030">257-259</span></div>
<div style="position:absolute;left:342.00px;top:52.30px" class="cls_030"><span class="cls_030">262-263</span></div>
<div style="position:absolute;left:136.50px;top:62.30px" class="cls_030"><span class="cls_030">Ruby objects with C++ objects,</span></div>
<div style="position:absolute;left:297.00px;top:62.29px" class="cls_030"><span class="cls_030">Jones, Richard, 324</span></div>
<div style="position:absolute;left:166.50px;top:72.30px" class="cls_030"><span class="cls_030">280-281</span></div>
<div style="position:absolute;left:297.00px;top:72.29px" class="cls_030"><span class="cls_030">JRuby, 251</span></div>
<div style="position:absolute;left:121.50px;top:82.29px" class="cls_030"><span class="cls_030">included classes, 137, 153-154</span></div>
<div style="position:absolute;left:312.00px;top:82.29px" class="cls_030"><span class="cls_030">code execution, 255-257</span></div>
<div style="position:absolute;left:121.50px;top:92.31px" class="cls_009"><span class="cls_009">include</span><span class="cls_030"> method, 136</span></div>
<div style="position:absolute;left:312.00px;top:92.28px" class="cls_030"><span class="cls_030">code parsing and compiling, 254-255</span></div>
<div style="position:absolute;left:121.50px;top:102.31px" class="cls_009"><span class="cls_009">include_modules_at</span><span class="cls_030"> (C function), 155</span></div>
<div style="position:absolute;left:312.00px;top:102.28px" class="cls_030"><span class="cls_030">garbage collection, 309, 321-324</span></div>
<div style="position:absolute;left:121.50px;top:112.31px" class="cls_030"><span class="cls_030">including</span></div>
<div style="position:absolute;left:312.00px;top:112.27px" class="cls_030"><span class="cls_030">and MRI, saving string data with,</span></div>
<div style="position:absolute;left:136.50px;top:122.30px" class="cls_030"><span class="cls_030">a module into a class, 136-138</span></div>
<div style="position:absolute;left:342.00px;top:122.27px" class="cls_030"><span class="cls_030">264-265</span></div>
<div style="position:absolute;left:136.50px;top:132.30px" class="cls_030"><span class="cls_030">one module into another, 145-146</span></div>
<div style="position:absolute;left:312.00px;top:132.27px" class="cls_030"><span class="cls_030">vs. MRI performance, 263</span></div>
<div style="position:absolute;left:136.50px;top:142.29px" class="cls_030"><span class="cls_030">two modules into one class, 144-145</span></div>
<div style="position:absolute;left:297.00px;top:142.26px" class="cls_066"><span class="cls_066">jruby.jar </span><span class="cls_030">file, 253</span></div>
<div style="position:absolute;left:121.50px;top:152.29px" class="cls_030"><span class="cls_030">inheritance, 118</span></div>
<div style="position:absolute;left:297.00px;top:152.26px" class="cls_030"><span class="cls_030">jumping from one scope to another, 86-90</span></div>
<div style="position:absolute;left:136.50px;top:162.29px" class="cls_030"><span class="cls_030">multiple, 141-142</span></div>
<div style="position:absolute;left:297.00px;top:162.31px" class="cls_009"><span class="cls_009">jump</span><span class="cls_030"> YARV instruction, 85</span></div>
<div style="position:absolute;left:121.50px;top:172.28px" class="cls_030"><span class="cls_030">inline method cache, 143</span></div>
<div style="position:absolute;left:297.00px;top:172.31px" class="cls_030"><span class="cls_030">just-in-time ( JIT) compiler, 255, 260,</span></div>
<div style="position:absolute;left:121.50px;top:182.28px" class="cls_066"><span class="cls_066">insns.def </span><span class="cls_030">file, 63</span></div>
<div style="position:absolute;left:342.00px;top:182.30px" class="cls_030"><span class="cls_030">262-263</span></div>
<div style="position:absolute;left:121.50px;top:192.27px" class="cls_030"><span class="cls_030">inspecting </span><span class="cls_009">klass</span><span class="cls_030"> and </span><span class="cls_009">ivptr</span><span class="cls_030">, 107-108</span></div>
<div style="position:absolute;left:297.00px;top:192.31px" class="cls_009"><span class="cls_009">-J-verbose:gc</span><span class="cls_030"> ( JRuby option), 321</span></div>
<div style="position:absolute;left:121.50px;top:202.31px" class="cls_009"><span class="cls_009">instance_eval</span><span class="cls_030"> method, 78, 240, 244, 245</span></div>
<div style="position:absolute;left:297.00px;top:202.31px" class="cls_030"><span class="cls_030">JVM (Java Virtual Machine), 253, 256</span></div>
<div style="position:absolute;left:136.50px;top:212.31px" class="cls_030"><span class="cls_030">creating a singleton class for a new</span></div>
<div style="position:absolute;left:312.01px;top:212.30px" class="cls_030"><span class="cls_030">garbage collection, 309, 320-321</span></div>
<div style="position:absolute;left:166.49px;top:222.30px" class="cls_030"><span class="cls_030">lexical scope, 243-244</span></div>
<div style="position:absolute;left:297.00px;top:222.31px" class="cls_009"><span class="cls_009">-J-XX:+PrintCompilation</span><span class="cls_030"> ( JRuby</span></div>
<div style="position:absolute;left:136.50px;top:232.30px" class="cls_030"><span class="cls_030">example, 240-241</span></div>
<div style="position:absolute;left:342.00px;top:232.31px" class="cls_030"><span class="cls_030">option), 261</span></div>
<div style="position:absolute;left:136.50px;top:242.29px" class="cls_030"><span class="cls_030">and lexical scope, 243-245</span></div>
<div style="position:absolute;left:136.50px;top:252.29px" class="cls_030"><span class="cls_030">and </span><span class="cls_009">self</span><span class="cls_030">, 242</span></div>
<div style="position:absolute;left:297.00px;top:250.81px" class="cls_218"><span class="cls_218">K</span></div>
<div style="position:absolute;left:121.50px;top:262.31px" class="cls_030"><span class="cls_030">instance-level attribute names, 118</span></div>
<div style="position:absolute;left:297.00px;top:266.31px" class="cls_009"><span class="cls_009">key?</span><span class="cls_030"> method, 100</span></div>
<div style="position:absolute;left:121.50px;top:272.30px" class="cls_030"><span class="cls_030">instance variable arrays, 107, 108</span></div>
<div style="position:absolute;left:297.00px;top:276.31px" class="cls_030"><span class="cls_030">keyword arguments</span></div>
<div style="position:absolute;left:121.50px;top:282.30px" class="cls_030"><span class="cls_030">instance variable counts, 107</span></div>
<div style="position:absolute;left:312.00px;top:286.30px" class="cls_030"><span class="cls_030">compiling, 49</span></div>
<div style="position:absolute;left:121.50px;top:292.29px" class="cls_030"><span class="cls_030">instance variable methods, 94</span></div>
<div style="position:absolute;left:312.00px;top:296.30px" class="cls_030"><span class="cls_030">exploring how Ruby implements,</span></div>
<div style="position:absolute;left:121.50px;top:302.29px" class="cls_030"><span class="cls_030">instance variable names, 7</span></div>
<div style="position:absolute;left:342.00px;top:306.29px" class="cls_030"><span class="cls_030">99-103</span></div>
<div style="position:absolute;left:121.50px;top:312.29px" class="cls_030"><span class="cls_030">instance variables</span></div>
<div style="position:absolute;left:297.00px;top:317.31px" class="cls_009"><span class="cls_009">keyword_do</span></div>
<div style="position:absolute;left:136.50px;top:322.28px" class="cls_030"><span class="cls_030">for generic objects, 111, 113</span></div>
<div style="position:absolute;left:312.00px;top:326.31px" class="cls_030"><span class="cls_030">grammar rule, 21</span></div>
<div style="position:absolute;left:136.50px;top:332.28px" class="cls_030"><span class="cls_030">time required to save, 113-115</span></div>
<div style="position:absolute;left:312.00px;top:336.31px" class="cls_030"><span class="cls_030">token, 7</span></div>
<div style="position:absolute;left:121.50px;top:342.31px" class="cls_009"><span class="cls_009">instance_variable_set</span><span class="cls_030"> method, 111</span></div>
<div style="position:absolute;left:297.00px;top:346.31px" class="cls_009"><span class="cls_009">keyword_end</span><span class="cls_030"> token, 21</span></div>
<div style="position:absolute;left:121.50px;top:352.31px" class="cls_009"><span class="cls_009">instance_variables</span><span class="cls_030"> method, 111</span></div>
<div style="position:absolute;left:297.00px;top:356.31px" class="cls_030"><span class="cls_030">keywords</span></div>
<div style="position:absolute;left:121.50px;top:362.31px" class="cls_030"><span class="cls_030">instructions, YARV. </span><span class="cls_066">See</span><span class="cls_030"> YARV instructions</span></div>
<div style="position:absolute;left:312.00px;top:366.31px" class="cls_009"><span class="cls_009">autoload</span><span class="cls_030">, 164</span></div>
<div style="position:absolute;left:121.50px;top:372.30px" class="cls_030"><span class="cls_030">instruction sequence (ISEQ) methods,</span></div>
<div style="position:absolute;left:312.00px;top:376.31px" class="cls_009"><span class="cls_009">binding</span><span class="cls_030">, 238</span></div>
<div style="position:absolute;left:166.50px;top:382.30px" class="cls_030"><span class="cls_030">93-94, 95</span></div>
<div style="position:absolute;left:312.00px;top:386.31px" class="cls_009"><span class="cls_009">class</span><span class="cls_030">, 221</span></div>
<div style="position:absolute;left:121.50px;top:392.31px" class="cls_009"><span class="cls_009">Integer</span><span class="cls_030"> class, 62, 72, 97, 142-143, 282-284</span></div>
<div style="position:absolute;left:312.00px;top:396.31px" class="cls_009"><span class="cls_009">def</span><span class="cls_030">, 221-223</span></div>
<div style="position:absolute;left:121.50px;top:402.31px" class="cls_066"><span class="cls_066">integer.rb</span><span class="cls_030"> file, 283</span></div>
<div style="position:absolute;left:312.00px;top:406.31px" class="cls_009"><span class="cls_009">ensure</span><span class="cls_030">, 90</span></div>
<div style="position:absolute;left:121.50px;top:412.31px" class="cls_009"><span class="cls_009">Integer#times</span><span class="cls_030"> method, 97, 283</span></div>
<div style="position:absolute;left:312.00px;top:417.31px" class="cls_009"><span class="cls_009">lamdbda</span></div>
<div style="position:absolute;left:121.50px;top:422.31px" class="cls_030"><span class="cls_030">internal heap structure, 298</span></div>
<div style="position:absolute;left:327.00px;top:426.31px" class="cls_030"><span class="cls_030">calling more than once in the</span></div>
<div style="position:absolute;left:121.50px;top:432.30px" class="cls_030"><span class="cls_030">interpreting a GC profile report,</span></div>
<div style="position:absolute;left:342.00px;top:436.31px" class="cls_030"><span class="cls_030">same scope, 216-217</span></div>
<div style="position:absolute;left:166.50px;top:442.30px" class="cls_030"><span class="cls_030">305-308</span></div>
<div style="position:absolute;left:327.00px;top:446.30px" class="cls_030"><span class="cls_030">changing local variables after</span></div>
<div style="position:absolute;left:121.50px;top:452.29px" class="cls_030"><span class="cls_030">ISEQ (instruction sequence) methods,</span></div>
<div style="position:absolute;left:342.00px;top:456.30px" class="cls_030"><span class="cls_030">calling, 214-217</span></div>
<div style="position:absolute;left:166.50px;top:462.29px" class="cls_030"><span class="cls_030">93-94, 95</span></div>
<div style="position:absolute;left:312.00px;top:466.31px" class="cls_009"><span class="cls_009">next</span><span class="cls_030">, 90</span></div>
<div style="position:absolute;left:121.50px;top:472.31px" class="cls_009"><span class="cls_009">iseq_compile_each</span><span class="cls_030"> (C function), 42</span></div>
<div style="position:absolute;left:312.00px;top:476.31px" class="cls_009"><span class="cls_009">redo</span><span class="cls_030">, 90</span></div>
<div style="position:absolute;left:121.50px;top:482.31px" class="cls_030"><span class="cls_030">iterating through the AST, 42-43</span></div>
<div style="position:absolute;left:312.00px;top:486.31px" class="cls_009"><span class="cls_009">rescue</span><span class="cls_030">, 90</span></div>
<div style="position:absolute;left:121.50px;top:492.30px" class="cls_030"><span class="cls_030">IVAR methods, 94, 98-99</span></div>
<div style="position:absolute;left:312.00px;top:496.31px" class="cls_009"><span class="cls_009">retry</span><span class="cls_030">, 90</span></div>
<div style="position:absolute;left:121.50px;top:502.31px" class="cls_009"><span class="cls_009">iv_index_tbl</span><span class="cls_030"> pointer, 125, 126</span></div>
<div style="position:absolute;left:312.00px;top:506.31px" class="cls_009"><span class="cls_009">return</span><span class="cls_030">, 90</span></div>
<div style="position:absolute;left:121.50px;top:512.31px" class="cls_009"><span class="cls_009">ivptr</span><span class="cls_030"> pointer, 107, 109, 114</span></div>
<div style="position:absolute;left:312.00px;top:516.31px" class="cls_009"><span class="cls_009">TOPLEVEL_BINDING</span><span class="cls_030">, 194</span></div>
<div style="position:absolute;left:121.50px;top:522.31px" class="cls_009"><span class="cls_009">iv_tbl</span><span class="cls_030"> pointer, 126</span></div>
<div style="position:absolute;left:312.00px;top:526.31px" class="cls_009"><span class="cls_009">unless</span><span class="cls_030">, 85</span></div>
<div style="position:absolute;left:297.00px;top:536.31px" class="cls_009"><span class="cls_009">klass</span><span class="cls_030"> pointer, 106, 107, 109, 199</span></div>
<div style="position:absolute;left:121.50px;top:543.81px" class="cls_218"><span class="cls_218">J</span></div>
<div style="position:absolute;left:121.50px;top:559.31px" class="cls_030"><span class="cls_030">Java bytecode instructions, 254</span></div>
<div style="position:absolute;left:297.00px;top:554.81px" class="cls_218"><span class="cls_218">L</span></div>
<div style="position:absolute;left:121.50px;top:569.31px" class="cls_009"><span class="cls_009">java</span><span class="cls_030"> command, to launch JRuby, 253</span></div>
<div style="position:absolute;left:297.00px;top:570.31px" class="cls_030"><span class="cls_030">ladder, environment pointer, 74-75</span></div>
<div style="position:absolute;left:121.50px;top:579.31px" class="cls_030"><span class="cls_030">Java Virtual Machine (JVM), 253, 256</span></div>
<div style="position:absolute;left:297.00px;top:580.31px" class="cls_030"><span class="cls_030">LALR (Look-Ahead Left Reversed</span></div>
<div style="position:absolute;left:136.50px;top:589.30px" class="cls_030"><span class="cls_030">garbage collection, 309, 320-321</span></div>
<div style="position:absolute;left:342.00px;top:590.30px" class="cls_030"><span class="cls_030">Rightmost Derivation)</span></div>
<div style="position:absolute;left:121.50px;top:599.30px" class="cls_030"><span class="cls_030">Jay parser, 254</span></div>
<div style="position:absolute;left:312.00px;top:600.30px" class="cls_030"><span class="cls_030">parse algorithm, 13-19</span></div>
<div style="position:absolute;left:312.00px;top:610.29px" class="cls_030"><span class="cls_030">state table, 18</span></div>
<div style="position:absolute;left:415.36px;top:635.00px" class="cls_021"><span class="cls_021">Index</span></div>
<div style="position:absolute;left:440.94px;top:632.00px" class="cls_020"><span class="cls_020">335</span></div>
</div>
<div style="position:absolute;left:50%;margin-left:-252px;top:239304px;width:504px;height:666px;border-style:outset;overflow:hidden">
<div style="position:absolute;left:0px;top:0px">
<img src="e698b76e-46bd-11eb-8b25-0cc47a792c0a_id_e698b76e-46bd-11eb-8b25-0cc47a792c0a_files/background360.jpg" width=504 height=666></div>
<div style="position:absolute;left:121.50px;top:42.89px" class="cls_009"><span class="cls_009">lambda</span><span class="cls_030"> keyword</span></div>
<div style="position:absolute;left:297.00px;top:42.81px" class="cls_030"><span class="cls_030">metaclass, 129, 226</span></div>
<div style="position:absolute;left:136.50px;top:52.88px" class="cls_030"><span class="cls_030">calling more than once in the same</span></div>
<div style="position:absolute;left:297.00px;top:52.80px" class="cls_030"><span class="cls_030">metaclass scope, 235</span></div>
<div style="position:absolute;left:166.50px;top:62.88px" class="cls_030"><span class="cls_030">scope, 216-217</span></div>
<div style="position:absolute;left:297.00px;top:62.80px" class="cls_030"><span class="cls_030">metaprogramming, and closures,</span></div>
<div style="position:absolute;left:136.50px;top:72.88px" class="cls_030"><span class="cls_030">changing local variables after calling,</span></div>
<div style="position:absolute;left:342.00px;top:72.79px" class="cls_030"><span class="cls_030">236-244</span></div>
<div style="position:absolute;left:166.50px;top:82.87px" class="cls_030"><span class="cls_030">214-217</span></div>
<div style="position:absolute;left:297.00px;top:82.79px" class="cls_030"><span class="cls_030">method arguments, 70-71</span></div>
<div style="position:absolute;left:121.50px;top:92.87px" class="cls_030"><span class="cls_030">lambdas, 197, 198, 203-213</span></div>
<div style="position:absolute;left:297.00px;top:92.79px" class="cls_030"><span class="cls_030">method caches</span></div>
<div style="position:absolute;left:136.50px;top:102.86px" class="cls_030"><span class="cls_030">calling, 209-211</span></div>
<div style="position:absolute;left:312.00px;top:102.78px" class="cls_030"><span class="cls_030">clearing Ruby’s, 143-144</span></div>
<div style="position:absolute;left:136.50px;top:112.86px" class="cls_030"><span class="cls_030">creating, 207-209</span></div>
<div style="position:absolute;left:312.00px;top:112.78px" class="cls_030"><span class="cls_030">global, 142</span></div>
<div style="position:absolute;left:121.50px;top:122.86px" class="cls_030"><span class="cls_030">Landin, Peter J., 191</span></div>
<div style="position:absolute;left:312.00px;top:122.77px" class="cls_030"><span class="cls_030">inline, 143</span></div>
<div style="position:absolute;left:121.50px;top:132.85px" class="cls_030"><span class="cls_030">lazy sweeping, 300-301, 303-304</span></div>
<div style="position:absolute;left:297.00px;top:132.89px" class="cls_009"><span class="cls_009">method_call</span><span class="cls_030"> grammar rule, 22</span></div>
<div style="position:absolute;left:121.50px;top:142.89px" class="cls_009"><span class="cls_009">leave</span><span class="cls_030"> YARV instruction, 45, 60</span></div>
<div style="position:absolute;left:297.00px;top:142.88px" class="cls_030"><span class="cls_030">method dispatch, 84, 92-93</span></div>
<div style="position:absolute;left:121.50px;top:152.88px" class="cls_030"><span class="cls_030">Lex, 8</span></div>
<div style="position:absolute;left:312.00px;top:152.88px" class="cls_030"><span class="cls_030">optimizing </span><span class="cls_009">attr_reader</span><span class="cls_030"> and</span></div>
<div style="position:absolute;left:121.50px;top:162.88px" class="cls_030"><span class="cls_030">lexical scope, 68, 78, 158</span></div>
<div style="position:absolute;left:342.00px;top:162.89px" class="cls_009"><span class="cls_009">attr_writer</span><span class="cls_030">, 98-99</span></div>
<div style="position:absolute;left:136.50px;top:172.88px" class="cls_030"><span class="cls_030">for blocks, 244-245</span></div>
<div style="position:absolute;left:297.00px;top:172.88px" class="cls_030"><span class="cls_030">method lookup, 92-93, 138</span></div>
<div style="position:absolute;left:136.50px;top:182.87px" class="cls_030"><span class="cls_030">and </span><span class="cls_009">instance_eval</span><span class="cls_030">, 243-245</span></div>
<div style="position:absolute;left:312.00px;top:182.88px" class="cls_030"><span class="cls_030">algorithm, 138-151</span></div>
<div style="position:absolute;left:136.50px;top:192.88px" class="cls_030"><span class="cls_030">and </span><span class="cls_009">self</span><span class="cls_030">, 231-236</span></div>
<div style="position:absolute;left:312.00px;top:192.88px" class="cls_030"><span class="cls_030">example, 139-140</span></div>
<div style="position:absolute;left:121.50px;top:202.88px" class="cls_030"><span class="cls_030">Lins, Rafael D., 324</span></div>
<div style="position:absolute;left:297.00px;top:202.87px" class="cls_030"><span class="cls_030">methods</span></div>
<div style="position:absolute;left:121.50px;top:212.88px" class="cls_030"><span class="cls_030">Lisp, 191-192, 197-198, 295, 297, 324</span></div>
<div style="position:absolute;left:312.00px;top:212.87px" class="cls_030"><span class="cls_030">acting as closures, 247-248</span></div>
<div style="position:absolute;left:121.50px;top:222.88px" class="cls_030"><span class="cls_030">live objects, 297, 299</span></div>
<div style="position:absolute;left:312.00px;top:222.89px" class="cls_009"><span class="cls_009">ancestors</span><span class="cls_030">, 259</span></div>
<div style="position:absolute;left:121.50px;top:232.87px" class="cls_030"><span class="cls_030">LLVM (Low-Level Virtual Machine), 277</span></div>
<div style="position:absolute;left:312.00px;top:232.89px" class="cls_009"><span class="cls_009">Array#sample</span><span class="cls_030">, 260-263</span></div>
<div style="position:absolute;left:121.50px;top:242.87px" class="cls_066"><span class="cls_066">loader.rb </span><span class="cls_030">file, 283</span></div>
<div style="position:absolute;left:312.00px;top:242.89px" class="cls_009"><span class="cls_009">Array#shift</span><span class="cls_030">, 288-291</span></div>
<div style="position:absolute;left:121.50px;top:252.86px" class="cls_030"><span class="cls_030">locality of reference, 310</span></div>
<div style="position:absolute;left:312.00px;top:252.89px" class="cls_009"><span class="cls_009">attr_accessor</span><span class="cls_030">, 98-99, 116</span></div>
<div style="position:absolute;left:121.50px;top:262.86px" class="cls_030"><span class="cls_030">local table, 46-53</span></div>
<div style="position:absolute;left:312.00px;top:262.88px" class="cls_030"><span class="cls_030">attribute get and set, 94, 98-99</span></div>
<div style="position:absolute;left:121.50px;top:272.86px" class="cls_030"><span class="cls_030">local variable access, 67-70</span></div>
<div style="position:absolute;left:312.00px;top:273.89px" class="cls_009"><span class="cls_009">attr_reader</span></div>
<div style="position:absolute;left:121.50px;top:282.85px" class="cls_030"><span class="cls_030">local variables, changing after calling</span></div>
<div style="position:absolute;left:327.00px;top:282.89px" class="cls_030"><span class="cls_030">calling, 97-98</span></div>
<div style="position:absolute;left:166.50px;top:292.89px" class="cls_009"><span class="cls_009">lambda</span><span class="cls_030">, 214-217</span></div>
<div style="position:absolute;left:327.00px;top:292.88px" class="cls_030"><span class="cls_030">optimization by method dispatch,</span></div>
<div style="position:absolute;left:121.50px;top:302.88px" class="cls_030"><span class="cls_030">look ahead, 18</span></div>
<div style="position:absolute;left:342.00px;top:302.88px" class="cls_030"><span class="cls_030">98-99</span></div>
<div style="position:absolute;left:121.50px;top:312.88px" class="cls_030"><span class="cls_030">Look-Ahead Left Reversed Rightmost</span></div>
<div style="position:absolute;left:312.00px;top:313.89px" class="cls_009"><span class="cls_009">attr_writer</span></div>
<div style="position:absolute;left:166.50px;top:322.88px" class="cls_030"><span class="cls_030">Derivation (LALR)</span></div>
<div style="position:absolute;left:327.00px;top:322.89px" class="cls_030"><span class="cls_030">calling, 97-98</span></div>
<div style="position:absolute;left:136.50px;top:332.87px" class="cls_030"><span class="cls_030">parse algorithm, 13-19</span></div>
<div style="position:absolute;left:327.00px;top:332.88px" class="cls_030"><span class="cls_030">optimization by method dispatch,</span></div>
<div style="position:absolute;left:136.50px;top:342.87px" class="cls_030"><span class="cls_030">state table, 18</span></div>
<div style="position:absolute;left:342.00px;top:342.88px" class="cls_030"><span class="cls_030">98-99</span></div>
<div style="position:absolute;left:121.50px;top:352.86px" class="cls_030"><span class="cls_030">lookup algorithm, for constants, 162,</span></div>
<div style="position:absolute;left:312.01px;top:352.88px" class="cls_030"><span class="cls_030">calling</span></div>
<div style="position:absolute;left:166.50px;top:362.86px" class="cls_030"><span class="cls_030">163-164</span></div>
<div style="position:absolute;left:327.01px;top:362.87px" class="cls_030"><span class="cls_030">with blocks, 71-72</span></div>
<div style="position:absolute;left:121.50px;top:372.86px" class="cls_030"><span class="cls_030">Low-Level Virtual Machine (LLVM), 277</span></div>
<div style="position:absolute;left:327.01px;top:372.87px" class="cls_030"><span class="cls_030">built-in, 97-99</span></div>
<div style="position:absolute;left:327.01px;top:382.86px" class="cls_030"><span class="cls_030">normal, 95-97</span></div>
<div style="position:absolute;left:312.00px;top:392.89px" class="cls_009"><span class="cls_009">class</span><span class="cls_030">, 111</span></div>
<div style="position:absolute;left:121.50px;top:394.39px" class="cls_218"><span class="cls_218">M</span></div>
<div style="position:absolute;left:349.50px;top:402.89px" class="cls_030"><span class="cls_030">, 244</span></div>
<div style="position:absolute;left:312.00px;top:403.89px" class="cls_009"><span class="cls_009">class_eval</span></div>
<div style="position:absolute;left:121.50px;top:409.89px" class="cls_009"><span class="cls_009">m_tbl</span><span class="cls_030"> pointer, 125, 126</span></div>
<div style="position:absolute;left:312.00px;top:412.88px" class="cls_030"><span class="cls_030">class methods, 127-130</span></div>
<div style="position:absolute;left:121.50px;top:419.88px" class="cls_030"><span class="cls_030">major collections, 315, 323-324</span></div>
<div style="position:absolute;left:327.00px;top:422.88px" class="cls_030"><span class="cls_030">scope of, 236</span></div>
<div style="position:absolute;left:121.50px;top:429.88px" class="cls_030"><span class="cls_030">mark-and-sweep garbage collection, 205,</span></div>
<div style="position:absolute;left:312.00px;top:432.89px" class="cls_009"><span class="cls_009">Class.new</span><span class="cls_030">, 113</span></div>
<div style="position:absolute;left:166.50px;top:439.88px" class="cls_030"><span class="cls_030">297-302</span></div>
<div style="position:absolute;left:312.00px;top:442.89px" class="cls_009"><span class="cls_009">const_missing</span><span class="cls_030">, 164</span></div>
<div style="position:absolute;left:136.50px;top:449.87px" class="cls_030"><span class="cls_030">disadvantages of, 302</span></div>
<div style="position:absolute;left:312.00px;top:452.89px" class="cls_009"><span class="cls_009">core#define_method</span><span class="cls_030">, 53</span></div>
<div style="position:absolute;left:136.50px;top:459.87px" class="cls_030"><span class="cls_030">free list, 297-298</span></div>
<div style="position:absolute;left:312.00px;top:462.89px" class="cls_009"><span class="cls_009">count_objects</span><span class="cls_030">, 129</span></div>
<div style="position:absolute;left:136.50px;top:469.86px" class="cls_030"><span class="cls_030">and JRuby, 309</span></div>
<div style="position:absolute;left:312.00px;top:472.89px" class="cls_009"><span class="cls_009">def</span><span class="cls_030">, 221-223</span></div>
<div style="position:absolute;left:136.50px;top:479.86px" class="cls_030"><span class="cls_030">lazy sweeping, 300-301</span></div>
<div style="position:absolute;left:312.00px;top:482.89px" class="cls_009"><span class="cls_009">define_method</span><span class="cls_030">, 246</span></div>
<div style="position:absolute;left:136.50px;top:489.86px" class="cls_030"><span class="cls_030">marking objects, 299-300</span></div>
<div style="position:absolute;left:312.00px;top:492.88px" class="cls_030"><span class="cls_030">definition process</span></div>
<div style="position:absolute;left:136.50px;top:499.85px" class="cls_030"><span class="cls_030">and Rubinius, 309</span></div>
<div style="position:absolute;left:327.01px;top:502.88px" class="cls_030"><span class="cls_030">alternative, 221-231</span></div>
<div style="position:absolute;left:136.50px;top:509.85px" class="cls_030"><span class="cls_030">seeing in action, 302-308</span></div>
<div style="position:absolute;left:327.01px;top:512.88px" class="cls_030"><span class="cls_030">normal, 221-223</span></div>
<div style="position:absolute;left:136.50px;top:519.84px" class="cls_030"><span class="cls_030">sweeping, 300</span></div>
<div style="position:absolute;left:312.00px;top:522.89px" class="cls_009"><span class="cls_009">dup</span><span class="cls_030">, 265-266</span></div>
<div style="position:absolute;left:121.50px;top:529.84px" class="cls_030"><span class="cls_030">marking objects, 299-300</span></div>
<div style="position:absolute;left:312.00px;top:532.89px" class="cls_009"><span class="cls_009">each</span><span class="cls_030">, 91</span></div>
<div style="position:absolute;left:136.50px;top:539.84px" class="cls_030"><span class="cls_030">tricolor, 319-320</span></div>
<div style="position:absolute;left:312.00px;top:542.89px" class="cls_009"><span class="cls_009">eql?</span><span class="cls_030">, 175</span></div>
<div style="position:absolute;left:136.50px;top:549.83px" class="cls_030"><span class="cls_030">while the object graph changes,</span></div>
<div style="position:absolute;left:312.00px;top:552.89px" class="cls_009"><span class="cls_009">eval</span><span class="cls_030">, 78, 236-240</span></div>
<div style="position:absolute;left:166.50px;top:559.83px" class="cls_030"><span class="cls_030">317-319</span></div>
<div style="position:absolute;left:312.00px;top:562.89px" class="cls_009"><span class="cls_009">extend</span><span class="cls_030">, 138</span></div>
<div style="position:absolute;left:121.50px;top:569.82px" class="cls_030"><span class="cls_030">mark stack, 319</span></div>
<div style="position:absolute;left:312.00px;top:572.89px" class="cls_009"><span class="cls_009">hash</span><span class="cls_030">, 182</span></div>
<div style="position:absolute;left:121.50px;top:579.82px" class="cls_030"><span class="cls_030">Matsumoto, Yukihiro “Matz”, 4, 251</span></div>
<div style="position:absolute;left:312.00px;top:582.89px" class="cls_009"><span class="cls_009">include</span><span class="cls_030">, 136</span></div>
<div style="position:absolute;left:121.50px;top:589.82px" class="cls_030"><span class="cls_030">Matz’s Ruby Interpreter. </span><span class="cls_066">See</span><span class="cls_030"> MRI</span></div>
<div style="position:absolute;left:312.00px;top:592.89px" class="cls_009"><span class="cls_009">instance_eval</span><span class="cls_030">. </span><span class="cls_066">See</span><span class="cls_030"> </span><span class="cls_009">instance_eval</span></div>
<div style="position:absolute;left:121.50px;top:599.81px" class="cls_030"><span class="cls_030">McCarthy, John, 191, 295, 324</span></div>
<div style="position:absolute;left:342.00px;top:602.88px" class="cls_030"><span class="cls_030">method</span></div>
<div style="position:absolute;left:121.50px;top:609.81px" class="cls_030"><span class="cls_030">McKinley, Kathryn S., 324</span></div>
<div style="position:absolute;left:49.50px;top:632.00px" class="cls_020"><span class="cls_020">336</span><span class="cls_009">   </span><span class="cls_021">Index</span></div>
</div>
<div style="position:absolute;left:50%;margin-left:-252px;top:239980px;width:504px;height:666px;border-style:outset;overflow:hidden">
<div style="position:absolute;left:0px;top:0px">
<img src="e698b76e-46bd-11eb-8b25-0cc47a792c0a_id_e698b76e-46bd-11eb-8b25-0cc47a792c0a_files/background361.jpg" width=504 height=666></div>
<div style="position:absolute;left:136.50px;top:42.31px" class="cls_009"><span class="cls_009">instance_variables</span><span class="cls_030">, 111</span></div>
<div style="position:absolute;left:312.01px;top:42.24px" class="cls_030"><span class="cls_030">running programs, with JRuby,</span></div>
<div style="position:absolute;left:136.50px;top:52.31px" class="cls_009"><span class="cls_009">instance_variable_set</span><span class="cls_030">, 111</span></div>
<div style="position:absolute;left:342.00px;top:52.24px" class="cls_030"><span class="cls_030">252-259</span></div>
<div style="position:absolute;left:136.50px;top:62.31px" class="cls_009"><span class="cls_009">Integer#times</span><span class="cls_030">, 97, 283</span></div>
<div style="position:absolute;left:312.01px;top:62.24px" class="cls_030"><span class="cls_030">strings, in JRuby and, 263-267</span></div>
<div style="position:absolute;left:136.50px;top:72.31px" class="cls_009"><span class="cls_009">key?</span><span class="cls_030">, 100</span></div>
<div style="position:absolute;left:297.00px;top:72.23px" class="cls_030"><span class="cls_030">multiple inheritance, 141-142</span></div>
<div style="position:absolute;left:136.50px;top:82.31px" class="cls_009"><span class="cls_009">module_eval</span><span class="cls_030">, 244</span></div>
<div style="position:absolute;left:297.00px;top:82.23px" class="cls_030"><span class="cls_030">MurmurHash, 183</span></div>
<div style="position:absolute;left:136.50px;top:92.31px" class="cls_009"><span class="cls_009">Module.nesting</span><span class="cls_030">, 231</span></div>
<div style="position:absolute;left:136.50px;top:102.31px" class="cls_009"><span class="cls_009">Module#prepend</span><span class="cls_030">, 146</span></div>
<div style="position:absolute;left:297.00px;top:100.81px" class="cls_218"><span class="cls_218">N</span></div>
<div style="position:absolute;left:136.50px;top:112.31px" class="cls_009"><span class="cls_009">ObjectSpace#count_objects</span><span class="cls_030">, 129, 302</span></div>
<div style="position:absolute;left:297.00px;top:116.31px" class="cls_009"><span class="cls_009">nd_clss</span><span class="cls_030"> pointer, 159, 221</span></div>
<div style="position:absolute;left:136.50px;top:122.31px" class="cls_009"><span class="cls_009">Ripper.lex</span><span class="cls_030">, 9</span></div>
<div style="position:absolute;left:297.00px;top:126.31px" class="cls_009"><span class="cls_009">nd_next</span><span class="cls_030"> pointer, 159</span></div>
<div style="position:absolute;left:136.50px;top:132.31px" class="cls_009"><span class="cls_009">Ripper.sexp</span><span class="cls_030">, 23</span></div>
<div style="position:absolute;left:297.00px;top:136.31px" class="cls_009"><span class="cls_009">nd_refinements</span><span class="cls_030"> pointer, 230</span></div>
<div style="position:absolute;left:136.50px;top:142.31px" class="cls_009"><span class="cls_009">Rubinius.primitive</span><span class="cls_030">, 280</span></div>
<div style="position:absolute;left:297.00px;top:146.31px" class="cls_030"><span class="cls_030">new object lifetime, 314</span></div>
<div style="position:absolute;left:136.50px;top:152.31px" class="cls_009"><span class="cls_009">set_trace_func</span><span class="cls_030">, 45, 58</span></div>
<div style="position:absolute;left:297.00px;top:156.31px" class="cls_009"><span class="cls_009">NEW_CALL</span><span class="cls_030"> AST node, 22-23</span></div>
<div style="position:absolute;left:136.50px;top:162.31px" class="cls_009"><span class="cls_009">source_location</span><span class="cls_030">, 288</span></div>
<div style="position:absolute;left:297.00px;top:166.31px" class="cls_009"><span class="cls_009">next</span><span class="cls_030"> keyword, 90</span></div>
<div style="position:absolute;left:136.50px;top:172.31px" class="cls_009"><span class="cls_009">String#[]</span><span class="cls_030">, 280</span></div>
<div style="position:absolute;left:297.00px;top:176.31px" class="cls_009"><span class="cls_009">nil</span><span class="cls_030"> value, 110</span></div>
<div style="position:absolute;left:136.50px;top:182.31px" class="cls_009"><span class="cls_009">String#upcase</span><span class="cls_030">, 97</span></div>
<div style="position:absolute;left:297.00px;top:186.31px" class="cls_009"><span class="cls_009">NODE_CALL</span><span class="cls_030"> AST node, 23, 26, 35-43</span></div>
<div style="position:absolute;left:136.50px;top:192.31px" class="cls_009"><span class="cls_009">Struct#each</span><span class="cls_030">, 97</span></div>
<div style="position:absolute;left:297.00px;top:196.31px" class="cls_009"><span class="cls_009">NODE_DVAR</span><span class="cls_030"> AST node, 41</span></div>
<div style="position:absolute;left:136.50px;top:202.31px" class="cls_009"><span class="cls_009">using</span><span class="cls_030">, 229</span></div>
<div style="position:absolute;left:297.00px;top:206.31px" class="cls_009"><span class="cls_009">NODE_FCALL</span><span class="cls_030"> AST node, 34-38, 41-43</span></div>
<div style="position:absolute;left:121.50px;top:212.31px" class="cls_030"><span class="cls_030">method tables, 116, 117, 125, 126, 153</span></div>
<div style="position:absolute;left:297.00px;top:216.31px" class="cls_009"><span class="cls_009">NODE_ITER</span><span class="cls_030"> AST node, 39-41</span></div>
<div style="position:absolute;left:121.50px;top:222.30px" class="cls_030"><span class="cls_030">method types, 93-95</span></div>
<div style="position:absolute;left:297.00px;top:226.31px" class="cls_009"><span class="cls_009">NODE_SCOPE</span><span class="cls_030"> AST node, 34-44, 46</span></div>
<div style="position:absolute;left:136.50px;top:232.30px" class="cls_030"><span class="cls_030">ATTRSET, 94, 98-99</span></div>
<div style="position:absolute;left:297.00px;top:236.31px" class="cls_030"><span class="cls_030">Noria, Xavier, 151</span></div>
<div style="position:absolute;left:136.50px;top:242.29px" class="cls_030"><span class="cls_030">BMETHOD, 94</span></div>
<div style="position:absolute;left:297.00px;top:246.30px" class="cls_030"><span class="cls_030">normal methods, calling, 95-97</span></div>
<div style="position:absolute;left:136.50px;top:252.29px" class="cls_030"><span class="cls_030">CFUNC, 61, 94, 97</span></div>
<div style="position:absolute;left:297.00px;top:256.30px" class="cls_030"><span class="cls_030">NOTIMPLEMENTED methods, 94</span></div>
<div style="position:absolute;left:136.50px;top:262.29px" class="cls_030"><span class="cls_030">ISEQ, 93-94, 95</span></div>
<div style="position:absolute;left:297.00px;top:266.29px" class="cls_030"><span class="cls_030">nth back reference, special variables, 80</span></div>
<div style="position:absolute;left:136.50px;top:272.28px" class="cls_030"><span class="cls_030">IVAR, 94, 98-99</span></div>
<div style="position:absolute;left:297.00px;top:276.31px" class="cls_009"><span class="cls_009">numiv</span><span class="cls_030"> (C structure value), 107, 109</span></div>
<div style="position:absolute;left:136.50px;top:282.28px" class="cls_030"><span class="cls_030">MISSING, 95</span></div>
<div style="position:absolute;left:297.00px;top:286.31px" class="cls_030"><span class="cls_030">Nutter, Charles, 321</span></div>
<div style="position:absolute;left:136.50px;top:292.27px" class="cls_030"><span class="cls_030">normal, 95-97</span></div>
<div style="position:absolute;left:136.50px;top:302.27px" class="cls_030"><span class="cls_030">NOTIMPLEMENTED, 94</span></div>
<div style="position:absolute;left:136.50px;top:312.27px" class="cls_030"><span class="cls_030">OPTIMIZED, 94</span></div>
<div style="position:absolute;left:297.00px;top:307.81px" class="cls_218"><span class="cls_218">O</span></div>
<div style="position:absolute;left:136.50px;top:322.26px" class="cls_030"><span class="cls_030">REFINED, 95</span></div>
<div style="position:absolute;left:297.00px;top:323.31px" class="cls_009"><span class="cls_009">Object</span><span class="cls_030"> (C++ class), 281</span></div>
<div style="position:absolute;left:136.50px;top:332.26px" class="cls_030"><span class="cls_030">UNDEF, 94</span></div>
<div style="position:absolute;left:297.00px;top:333.31px" class="cls_009"><span class="cls_009">Object</span><span class="cls_030"> class, 133, 157-158, 231-232</span></div>
<div style="position:absolute;left:136.50px;top:342.25px" class="cls_030"><span class="cls_030">ZSUPER, 94</span></div>
<div style="position:absolute;left:297.00px;top:343.31px" class="cls_030"><span class="cls_030">object graph, 299</span></div>
<div style="position:absolute;left:121.50px;top:352.25px" class="cls_030"><span class="cls_030">Miniruby, 63</span></div>
<div style="position:absolute;left:297.00px;top:353.30px" class="cls_030"><span class="cls_030">object prefix, metaprogramming</span></div>
<div style="position:absolute;left:121.50px;top:362.25px" class="cls_030"><span class="cls_030">minor collections, 315, 322</span></div>
<div style="position:absolute;left:342.00px;top:363.30px" class="cls_030"><span class="cls_030">syntax, 223</span></div>
<div style="position:absolute;left:121.50px;top:372.24px" class="cls_030"><span class="cls_030">Minsky, Marvin, 309</span></div>
<div style="position:absolute;left:297.00px;top:373.29px" class="cls_030"><span class="cls_030">objects, 106-113</span></div>
<div style="position:absolute;left:121.50px;top:382.24px" class="cls_030"><span class="cls_030">MISSING methods, 95</span></div>
<div style="position:absolute;left:312.00px;top:383.29px" class="cls_030"><span class="cls_030">generic, 109-110, 111, 113</span></div>
<div style="position:absolute;left:121.50px;top:392.23px" class="cls_030"><span class="cls_030">modifying</span></div>
<div style="position:absolute;left:312.00px;top:393.29px" class="cls_030"><span class="cls_030">as hash keys, 183</span></div>
<div style="position:absolute;left:136.50px;top:402.31px" class="cls_009"><span class="cls_009">Array#shift</span><span class="cls_030">, 289-291</span></div>
<div style="position:absolute;left:312.00px;top:403.28px" class="cls_030"><span class="cls_030">Ruby, implementing with C++</span></div>
<div style="position:absolute;left:136.50px;top:412.31px" class="cls_030"><span class="cls_030">modules, after including, 151-154</span></div>
<div style="position:absolute;left:342.00px;top:413.28px" class="cls_030"><span class="cls_030">objects, 280-281</span></div>
<div style="position:absolute;left:136.50px;top:422.30px" class="cls_030"><span class="cls_030">shared strings, 270-271</span></div>
<div style="position:absolute;left:297.00px;top:423.31px" class="cls_009"><span class="cls_009">ObjectSpace#count_objects</span><span class="cls_030"> method,</span></div>
<div style="position:absolute;left:121.50px;top:432.31px" class="cls_009"><span class="cls_009">module_eval</span><span class="cls_030"> method, 244</span></div>
<div style="position:absolute;left:342.00px;top:433.31px" class="cls_030"><span class="cls_030">129, 302</span></div>
<div style="position:absolute;left:121.50px;top:442.31px" class="cls_009"><span class="cls_009">Module.nesting</span><span class="cls_030"> method, 231</span></div>
<div style="position:absolute;left:297.00px;top:443.31px" class="cls_009"><span class="cls_009">:on_ident</span><span class="cls_030"> (Ripper output value), 10</span></div>
<div style="position:absolute;left:121.50px;top:452.31px" class="cls_009"><span class="cls_009">Module#prepend</span><span class="cls_030"> method, 146, 150-151</span></div>
<div style="position:absolute;left:297.00px;top:453.31px" class="cls_009"><span class="cls_009">:on_int</span><span class="cls_030"> (Ripper output value), 10</span></div>
<div style="position:absolute;left:121.50px;top:462.31px" class="cls_030"><span class="cls_030">modules</span></div>
<div style="position:absolute;left:297.00px;top:463.31px" class="cls_030"><span class="cls_030">operand optimization, 69</span></div>
<div style="position:absolute;left:136.51px;top:472.30px" class="cls_030"><span class="cls_030">constants, creating for, 159-160</span></div>
<div style="position:absolute;left:297.00px;top:473.31px" class="cls_009"><span class="cls_009">opt_block_param</span><span class="cls_030"> grammar rule, 21</span></div>
<div style="position:absolute;left:136.51px;top:482.30px" class="cls_030"><span class="cls_030">how Ruby copies, 154-155</span></div>
<div style="position:absolute;left:297.00px;top:483.31px" class="cls_030"><span class="cls_030">OPTIMIZED methods, 94</span></div>
<div style="position:absolute;left:136.51px;top:492.29px" class="cls_030"><span class="cls_030">implementing as classes, 135-138</span></div>
<div style="position:absolute;left:297.00px;top:493.30px" class="cls_030"><span class="cls_030">optional arguments, 48, 96</span></div>
<div style="position:absolute;left:136.51px;top:502.29px" class="cls_030"><span class="cls_030">including</span></div>
<div style="position:absolute;left:297.00px;top:503.31px" class="cls_009"><span class="cls_009">opt_lt</span><span class="cls_030"> YARV instruction, 85</span></div>
<div style="position:absolute;left:151.51px;top:512.29px" class="cls_030"><span class="cls_030">into a class, 136-138</span></div>
<div style="position:absolute;left:297.00px;top:513.31px" class="cls_009"><span class="cls_009">opt_plus</span><span class="cls_030"> YARV instruction, 38, 60</span></div>
<div style="position:absolute;left:151.51px;top:522.28px" class="cls_030"><span class="cls_030">one into another, 145-146</span></div>
<div style="position:absolute;left:297.00px;top:523.31px" class="cls_009"><span class="cls_009">opt_send_simple</span><span class="cls_030"> YARV instruction, 38, 60</span></div>
<div style="position:absolute;left:151.51px;top:532.28px" class="cls_030"><span class="cls_030">two into one class, 144-145</span></div>
<div style="position:absolute;left:297.00px;top:533.31px" class="cls_030"><span class="cls_030">origin class, 150</span></div>
<div style="position:absolute;left:136.51px;top:542.27px" class="cls_030"><span class="cls_030">modifying after including, 151-154</span></div>
<div style="position:absolute;left:297.00px;top:543.31px" class="cls_009"><span class="cls_009">origin</span><span class="cls_030"> pointer, 126</span></div>
<div style="position:absolute;left:121.50px;top:552.27px" class="cls_030"><span class="cls_030">Moore, Peter, 172</span></div>
<div style="position:absolute;left:121.50px;top:562.27px" class="cls_030"><span class="cls_030">Moss, Eliot, 324</span></div>
<div style="position:absolute;left:297.00px;top:564.81px" class="cls_218"><span class="cls_218">P</span></div>
<div style="position:absolute;left:121.50px;top:572.26px" class="cls_030"><span class="cls_030">MRI (Matz’s Ruby Interpreter), 4, 251</span></div>
<div style="position:absolute;left:136.51px;top:582.26px" class="cls_030"><span class="cls_030">arrays in Rubinius and, 284-287</span></div>
<div style="position:absolute;left:297.00px;top:580.31px" class="cls_030"><span class="cls_030">packed hashes, 188</span></div>
<div style="position:absolute;left:136.51px;top:592.25px" class="cls_030"><span class="cls_030">backtraces, 281-282</span></div>
<div style="position:absolute;left:297.00px;top:590.31px" class="cls_030"><span class="cls_030">parallel collector (in the JVM), 320</span></div>
<div style="position:absolute;left:136.51px;top:602.25px" class="cls_030"><span class="cls_030">free lists, use of multiple, 298</span></div>
<div style="position:absolute;left:297.00px;top:600.30px" class="cls_030"><span class="cls_030">parent namespace, finding a constant in,</span></div>
<div style="position:absolute;left:136.51px;top:612.25px" class="cls_030"><span class="cls_030">garbage collection, 297-308</span></div>
<div style="position:absolute;left:342.00px;top:610.30px" class="cls_030"><span class="cls_030">157-158</span></div>
<div style="position:absolute;left:415.43px;top:635.00px" class="cls_021"><span class="cls_021">Index</span></div>
<div style="position:absolute;left:441.01px;top:632.00px" class="cls_020"><span class="cls_020">337</span></div>
</div>
<div style="position:absolute;left:50%;margin-left:-252px;top:240656px;width:504px;height:666px;border-style:outset;overflow:hidden">
<div style="position:absolute;left:0px;top:0px">
<img src="e698b76e-46bd-11eb-8b25-0cc47a792c0a_id_e698b76e-46bd-11eb-8b25-0cc47a792c0a_files/background362.jpg" width=504 height=666></div>
<div style="position:absolute;left:121.50px;top:42.89px" class="cls_066"><span class="cls_066">parse.c</span><span class="cls_030"> file, 13</span></div>
<div style="position:absolute;left:297.00px;top:42.27px" class="cls_009"><span class="cls_009">rb_classext_struct</span><span class="cls_030"> (C structure), 125, 126</span></div>
<div style="position:absolute;left:121.50px;top:52.88px" class="cls_066"><span class="cls_066">parse.y</span><span class="cls_030"> file, 8, 12, 19, 20, 22, 79</span></div>
<div style="position:absolute;left:297.00px;top:52.27px" class="cls_009"><span class="cls_009">rb_control_frame_t</span><span class="cls_030"> (C structure), 57, 194,</span></div>
<div style="position:absolute;left:121.50px;top:62.88px" class="cls_030"><span class="cls_030">parser generator, 12</span></div>
<div style="position:absolute;left:342.00px;top:62.27px" class="cls_030"><span class="cls_030">198-199</span></div>
<div style="position:absolute;left:121.50px;top:72.89px" class="cls_009"><span class="cls_009">parser_yylex</span><span class="cls_030"> (C function), 8, 79</span></div>
<div style="position:absolute;left:297.00px;top:72.27px" class="cls_009"><span class="cls_009">rb_env_t</span><span class="cls_030"> (C structure), 208, 209, 239</span></div>
<div style="position:absolute;left:121.50px;top:82.89px" class="cls_009"><span class="cls_009">parsetree</span><span class="cls_030"> (Ruby option), 29</span></div>
<div style="position:absolute;left:297.00px;top:82.27px" class="cls_009"><span class="cls_009">rb_include_class_new</span><span class="cls_030"> (C function), 154</span></div>
<div style="position:absolute;left:121.50px;top:92.88px" class="cls_030"><span class="cls_030">parsing, 3, 4, 9-12</span></div>
<div style="position:absolute;left:297.00px;top:92.27px" class="cls_009"><span class="cls_009">rb_proc_t</span><span class="cls_030"> (C structure), 208, 209, 212</span></div>
<div style="position:absolute;left:121.50px;top:102.88px" class="cls_030"><span class="cls_030">passing a block to </span><span class="cls_009">each</span><span class="cls_030">, 200</span></div>
<div style="position:absolute;left:297.00px;top:102.27px" class="cls_009"><span class="cls_009">rb_reserved_word</span><span class="cls_030"> (C function), 8</span></div>
<div style="position:absolute;left:121.50px;top:112.89px" class="cls_009"><span class="cls_009">PC</span><span class="cls_030"> (program counter), 57</span></div>
<div style="position:absolute;left:297.00px;top:112.27px" class="cls_009"><span class="cls_009">rbx</span><span class="cls_030"> command, 274, 278</span></div>
<div style="position:absolute;left:121.50px;top:122.88px" class="cls_030"><span class="cls_030">permanent generation, 315</span></div>
<div style="position:absolute;left:297.00px;top:122.27px" class="cls_009"><span class="cls_009">RClass</span><span class="cls_030"> (C structure), 108, 115,</span></div>
<div style="position:absolute;left:121.50px;top:132.88px" class="cls_030"><span class="cls_030">pointers</span></div>
<div style="position:absolute;left:342.00px;top:132.27px" class="cls_030"><span class="cls_030">125-126, 127</span></div>
<div style="position:absolute;left:136.51px;top:142.88px" class="cls_030"><span class="cls_030">class, 106, 107, 109</span></div>
<div style="position:absolute;left:297.00px;top:142.27px" class="cls_009"><span class="cls_009">RCLASS_CONST_TBL</span><span class="cls_030"> (C macro), 155</span></div>
<div style="position:absolute;left:136.50px;top:152.89px" class="cls_009"><span class="cls_009">CFP</span><span class="cls_030">, 57, 88, 95</span></div>
<div style="position:absolute;left:297.00px;top:152.27px" class="cls_009"><span class="cls_009">RCLASS_IV_TBL</span><span class="cls_030"> (C macro), 155</span></div>
<div style="position:absolute;left:136.50px;top:162.88px" class="cls_030"><span class="cls_030">climbing the environment pointer</span></div>
<div style="position:absolute;left:297.00px;top:162.27px" class="cls_009"><span class="cls_009">RCLASS_M_TBL</span><span class="cls_030"> (C macro), 155</span></div>
<div style="position:absolute;left:166.49px;top:172.88px" class="cls_030"><span class="cls_030">ladder in C, 74-75</span></div>
<div style="position:absolute;left:297.00px;top:172.27px" class="cls_009"><span class="cls_009">RCLASS_ORIGIN</span><span class="cls_030"> (C macro), 155</span></div>
<div style="position:absolute;left:136.50px;top:182.89px" class="cls_009"><span class="cls_009">const_tbl</span><span class="cls_030">, 126</span></div>
<div style="position:absolute;left:297.00px;top:182.27px" class="cls_030"><span class="cls_030">reading</span></div>
<div style="position:absolute;left:136.50px;top:192.89px" class="cls_009"><span class="cls_009">cref</span><span class="cls_030">, 68, 78</span></div>
<div style="position:absolute;left:312.00px;top:192.27px" class="cls_009"><span class="cls_009">Array#shift</span><span class="cls_030">, 288</span></div>
<div style="position:absolute;left:136.50px;top:202.89px" class="cls_009"><span class="cls_009">EP</span><span class="cls_030">, 68, 194, 197</span></div>
<div style="position:absolute;left:312.00px;top:202.27px" class="cls_030"><span class="cls_030">a Bison grammar rule, 22</span></div>
<div style="position:absolute;left:136.50px;top:212.89px" class="cls_009"><span class="cls_009">iv_index_tbl</span><span class="cls_030">, 125, 126</span></div>
<div style="position:absolute;left:312.00px;top:212.26px" class="cls_030"><span class="cls_030">the </span><span class="cls_009">RBasic</span><span class="cls_030"> and </span><span class="cls_009">RObject</span><span class="cls_030"> definitions, 112</span></div>
<div style="position:absolute;left:136.50px;top:222.89px" class="cls_009"><span class="cls_009">ivptr</span><span class="cls_030">, 107, 109, 114</span></div>
<div style="position:absolute;left:312.00px;top:222.27px" class="cls_030"><span class="cls_030">the </span><span class="cls_009">RClass</span><span class="cls_030"> definition, 127</span></div>
<div style="position:absolute;left:136.50px;top:232.89px" class="cls_009"><span class="cls_009">iv_tbl</span><span class="cls_030">, 126</span></div>
<div style="position:absolute;left:297.00px;top:232.27px" class="cls_030"><span class="cls_030">receiver-arguments-message pattern, 36,</span></div>
<div style="position:absolute;left:136.50px;top:242.89px" class="cls_009"><span class="cls_009">klass</span><span class="cls_030">, 106, 107, 109, 199</span></div>
<div style="position:absolute;left:342.00px;top:242.26px" class="cls_030"><span class="cls_030">37, 42, 59</span></div>
<div style="position:absolute;left:136.50px;top:252.89px" class="cls_009"><span class="cls_009">m_tbl</span><span class="cls_030">, 125, 126</span></div>
<div style="position:absolute;left:297.00px;top:252.27px" class="cls_009"><span class="cls_009">redo</span><span class="cls_030"> keyword, 90</span></div>
<div style="position:absolute;left:136.50px;top:262.89px" class="cls_009"><span class="cls_009">nd_clss</span><span class="cls_030">, 159, 221</span></div>
<div style="position:absolute;left:297.00px;top:262.27px" class="cls_030"><span class="cls_030">reduce (parsing operation), 17</span></div>
<div style="position:absolute;left:136.50px;top:272.89px" class="cls_009"><span class="cls_009">nd_next</span><span class="cls_030">, 159</span></div>
<div style="position:absolute;left:297.00px;top:272.26px" class="cls_030"><span class="cls_030">references between generations, 316</span></div>
<div style="position:absolute;left:136.50px;top:282.89px" class="cls_009"><span class="cls_009">nd_refinements</span><span class="cls_030">, 230</span></div>
<div style="position:absolute;left:297.00px;top:282.26px" class="cls_030"><span class="cls_030">referencing environment, 197, 198</span></div>
<div style="position:absolute;left:136.50px;top:292.89px" class="cls_009"><span class="cls_009">origin</span><span class="cls_030">, 126</span></div>
<div style="position:absolute;left:297.00px;top:292.27px" class="cls_009"><span class="cls_009">refined_class</span><span class="cls_030"> pointer, 126</span></div>
<div style="position:absolute;left:136.50px;top:302.89px" class="cls_009"><span class="cls_009">PC</span><span class="cls_030">, 57</span></div>
<div style="position:absolute;left:297.00px;top:302.27px" class="cls_030"><span class="cls_030">REFINED methods, 95</span></div>
<div style="position:absolute;left:136.50px;top:312.89px" class="cls_009"><span class="cls_009">refined_class</span><span class="cls_030">, 126</span></div>
<div style="position:absolute;left:297.00px;top:312.26px" class="cls_030"><span class="cls_030">refinements, 228-231</span></div>
<div style="position:absolute;left:136.50px;top:322.89px" class="cls_009"><span class="cls_009">self</span><span class="cls_030">, 36, 57, 199, 231</span></div>
<div style="position:absolute;left:297.00px;top:322.26px" class="cls_030"><span class="cls_030">regular expressions, for special</span></div>
<div style="position:absolute;left:136.50px;top:332.89px" class="cls_009"><span class="cls_009">SP</span><span class="cls_030">, 57</span></div>
<div style="position:absolute;left:342.00px;top:332.26px" class="cls_030"><span class="cls_030">variables, 80</span></div>
<div style="position:absolute;left:136.50px;top:342.89px" class="cls_009"><span class="cls_009">super</span><span class="cls_030">, 119, 125, 126</span></div>
<div style="position:absolute;left:297.00px;top:342.27px" class="cls_009"><span class="cls_009">rehash</span><span class="cls_030"> (C function), 176</span></div>
<div style="position:absolute;left:136.50px;top:352.89px" class="cls_009"><span class="cls_009">svar</span><span class="cls_030">, 75</span></div>
<div style="position:absolute;left:297.00px;top:352.27px" class="cls_030"><span class="cls_030">rehashing hash table entries, 175-176</span></div>
<div style="position:absolute;left:136.50px;top:362.89px" class="cls_009"><span class="cls_009">svar/cref</span><span class="cls_030">, 68</span></div>
<div style="position:absolute;left:297.00px;top:362.27px" class="cls_009"><span class="cls_009">rescue</span><span class="cls_030"> keyword, 90</span></div>
<div style="position:absolute;left:136.50px;top:372.89px" class="cls_009"><span class="cls_009">VALUE</span><span class="cls_030">, 106, 107, 110, 204</span></div>
<div style="position:absolute;left:297.00px;top:372.27px" class="cls_030"><span class="cls_030">reserved word, 7</span></div>
<div style="position:absolute;left:121.50px;top:382.88px" class="cls_030"><span class="cls_030">preparing arguments for normal Ruby</span></div>
<div style="position:absolute;left:297.00px;top:382.26px" class="cls_030"><span class="cls_030">retrieving a value, from a hash table, 171</span></div>
<div style="position:absolute;left:166.50px;top:392.88px" class="cls_030"><span class="cls_030">methods, 95</span></div>
<div style="position:absolute;left:297.00px;top:392.27px" class="cls_009"><span class="cls_009">retry</span><span class="cls_030"> keyword, 90</span></div>
<div style="position:absolute;left:121.50px;top:402.88px" class="cls_030"><span class="cls_030">primary value grammar rule, 21</span></div>
<div style="position:absolute;left:297.00px;top:402.27px" class="cls_009"><span class="cls_009">return</span><span class="cls_030"> keyword, 90</span></div>
<div style="position:absolute;left:121.50px;top:412.87px" class="cls_030"><span class="cls_030">prime numbers, for hash tables, 180-181</span></div>
<div style="position:absolute;left:297.00px;top:412.27px" class="cls_009"><span class="cls_009">RHash</span><span class="cls_030"> (C structure), 169</span></div>
<div style="position:absolute;left:121.50px;top:422.87px" class="cls_030"><span class="cls_030">problems, solved by garbage collectors,</span></div>
<div style="position:absolute;left:297.00px;top:422.27px" class="cls_030"><span class="cls_030">Ripper, 9-12, 22-29</span></div>
<div style="position:absolute;left:166.50px;top:432.86px" class="cls_030"><span class="cls_030">297</span></div>
<div style="position:absolute;left:297.00px;top:432.27px" class="cls_009"><span class="cls_009">Ripper</span><span class="cls_030"> class, 9-12, 22-29</span></div>
<div style="position:absolute;left:121.50px;top:442.89px" class="cls_009"><span class="cls_009">Proc</span><span class="cls_030"> class, 211-213</span></div>
<div style="position:absolute;left:297.00px;top:442.27px" class="cls_009"><span class="cls_009">Ripper.lex</span><span class="cls_030"> method, 9</span></div>
<div style="position:absolute;left:121.50px;top:452.88px" class="cls_030"><span class="cls_030">procs, 203, 208, 211-213</span></div>
<div style="position:absolute;left:297.00px;top:452.27px" class="cls_009"><span class="cls_009">Ripper.sexp</span><span class="cls_030"> method, 23</span></div>
<div style="position:absolute;left:121.50px;top:462.88px" class="cls_030"><span class="cls_030">program counter (</span><span class="cls_009">PC</span><span class="cls_030">), 57</span></div>
<div style="position:absolute;left:297.00px;top:462.27px" class="cls_009"><span class="cls_009">RObject</span><span class="cls_030"> (C structure), 106, 107, 109, 112</span></div>
<div style="position:absolute;left:121.50px;top:472.88px" class="cls_030"><span class="cls_030">program grammar rule, 20</span></div>
<div style="position:absolute;left:297.00px;top:472.27px" class="cls_030"><span class="cls_030">root object, 299</span></div>
<div style="position:absolute;left:121.50px;top:482.88px" class="cls_030"><span class="cls_030">programs, running with MRI and JRuby,</span></div>
<div style="position:absolute;left:297.00px;top:482.27px" class="cls_009"><span class="cls_009">RRegexp</span><span class="cls_030"> (C structure), 109, 110</span></div>
<div style="position:absolute;left:166.50px;top:492.88px" class="cls_030"><span class="cls_030">252-259</span></div>
<div style="position:absolute;left:297.00px;top:492.27px" class="cls_009"><span class="cls_009">RString</span><span class="cls_030"> (C structure), 109, 110, 205,</span></div>
<div style="position:absolute;left:121.50px;top:502.87px" class="cls_030"><span class="cls_030">promoting objects, 314</span></div>
<div style="position:absolute;left:342.00px;top:502.27px" class="cls_030"><span class="cls_030">206, 264</span></div>
<div style="position:absolute;left:121.50px;top:512.89px" class="cls_009"><span class="cls_009">putobject</span><span class="cls_030"> YARV instruction, 59</span></div>
<div style="position:absolute;left:297.00px;top:512.27px" class="cls_009"><span class="cls_009">RTypedData</span><span class="cls_030"> (C structure), 212</span></div>
<div style="position:absolute;left:121.50px;top:522.89px" class="cls_009"><span class="cls_009">putself</span><span class="cls_030"> YARV instruction, 36, 58, 63</span></div>
<div style="position:absolute;left:297.00px;top:522.27px" class="cls_030"><span class="cls_030">Rubinius, 273</span></div>
<div style="position:absolute;left:312.00px;top:532.26px" class="cls_030"><span class="cls_030">backtraces, 282-284</span></div>
<div style="position:absolute;left:312.00px;top:542.26px" class="cls_030"><span class="cls_030">bytecode instructions, 277, 278-279</span></div>
<div style="position:absolute;left:121.50px;top:544.39px" class="cls_218"><span class="cls_218">R</span></div>
<div style="position:absolute;left:312.00px;top:552.26px" class="cls_030"><span class="cls_030">compiler, 277, 290</span></div>
<div style="position:absolute;left:121.50px;top:559.89px" class="cls_009"><span class="cls_009">RArray</span><span class="cls_030"> (C structure), 109, 110, 285, 286</span></div>
<div style="position:absolute;left:312.00px;top:562.25px" class="cls_030"><span class="cls_030">garbage collection, 309</span></div>
<div style="position:absolute;left:121.50px;top:569.89px" class="cls_009"><span class="cls_009">RBasic</span><span class="cls_030"> (C structure), 106, 107, 109,</span></div>
<div style="position:absolute;left:312.00px;top:572.25px" class="cls_030"><span class="cls_030">kernel and virtual machine, 274-281</span></div>
<div style="position:absolute;left:166.50px;top:579.88px" class="cls_030"><span class="cls_030">110, 112</span></div>
<div style="position:absolute;left:297.00px;top:582.27px" class="cls_009"><span class="cls_009">Rubinius.primitive</span><span class="cls_030"> method, 280</span></div>
<div style="position:absolute;left:121.50px;top:589.89px" class="cls_009"><span class="cls_009">rb_binding_t</span><span class="cls_030"> (C structure), 239</span></div>
<div style="position:absolute;left:297.00px;top:592.27px" class="cls_030"><span class="cls_030">Ruby, working together with C++,</span></div>
<div style="position:absolute;left:121.50px;top:599.89px" class="cls_009"><span class="cls_009">rb_block_t</span><span class="cls_030"> (C structure), 72, 192, 196,</span></div>
<div style="position:absolute;left:342.00px;top:602.26px" class="cls_030"><span class="cls_030">279-280</span></div>
<div style="position:absolute;left:166.50px;top:609.88px" class="cls_030"><span class="cls_030">197, 198-199</span></div>
<div style="position:absolute;left:297.00px;top:612.26px" class="cls_030"><span class="cls_030">Ruby 2.1, garbage collection, 309, 315</span></div>
<div style="position:absolute;left:49.50px;top:632.00px" class="cls_020"><span class="cls_020">338</span><span class="cls_009">   </span><span class="cls_021">Index</span></div>
</div>
<div style="position:absolute;left:50%;margin-left:-252px;top:241332px;width:504px;height:666px;border-style:outset;overflow:hidden">
<div style="position:absolute;left:0px;top:0px">
<img src="e698b76e-46bd-11eb-8b25-0cc47a792c0a_id_e698b76e-46bd-11eb-8b25-0cc47a792c0a_files/background363.jpg" width=504 height=666></div>
<div style="position:absolute;left:121.50px;top:42.31px" class="cls_009"><span class="cls_009">RubyBasicObject</span><span class="cls_030"> ( Java class), 259</span></div>
<div style="position:absolute;left:297.00px;top:42.31px" class="cls_009"><span class="cls_009">special</span><span class="cls_030"> value, 71</span></div>
<div style="position:absolute;left:121.50px;top:52.31px" class="cls_009"><span class="cls_009">RubyClass</span><span class="cls_030"> ( Java class), 258</span></div>
<div style="position:absolute;left:297.00px;top:52.31px" class="cls_030"><span class="cls_030">special variables, 68, 75-80</span></div>
<div style="position:absolute;left:121.50px;top:62.31px" class="cls_009"><span class="cls_009">ruby --dump parsetree</span><span class="cls_030"> option, 29</span></div>
<div style="position:absolute;left:312.00px;top:62.31px" class="cls_009"><span class="cls_009">$&</span><span class="cls_030">, 76</span></div>
<div style="position:absolute;left:121.50px;top:72.31px" class="cls_009"><span class="cls_009">RubyFixnum</span><span class="cls_030"> ( Java class), 257</span></div>
<div style="position:absolute;left:312.00px;top:72.31px" class="cls_030"><span class="cls_030">definitive list of Ruby’s, 79</span></div>
<div style="position:absolute;left:121.50px;top:82.31px" class="cls_030"><span class="cls_030">Ruby hash (</span><span class="cls_009">RHash</span><span class="cls_030">), C structure, 169</span></div>
<div style="position:absolute;left:312.00px;top:82.30px" class="cls_030"><span class="cls_030">nth back reference, 80</span></div>
<div style="position:absolute;left:121.50px;top:92.31px" class="cls_009"><span class="cls_009">RubyIO</span><span class="cls_030"> ( Java class), 257</span></div>
<div style="position:absolute;left:312.00px;top:92.30px" class="cls_030"><span class="cls_030">for regular expressions, 80</span></div>
<div style="position:absolute;left:121.50px;top:102.31px" class="cls_009"><span class="cls_009">RubyModule</span><span class="cls_030"> ( Java class), 259</span></div>
<div style="position:absolute;left:297.00px;top:102.29px" class="cls_030"><span class="cls_030">speed</span></div>
<div style="position:absolute;left:121.50px;top:112.31px" class="cls_009"><span class="cls_009">RubyObject</span><span class="cls_030"> ( Java class), 258</span></div>
<div style="position:absolute;left:312.00px;top:112.29px" class="cls_030"><span class="cls_030">of JRuby programs with JIT, 262-263</span></div>
<div style="position:absolute;left:121.50px;top:122.31px" class="cls_009"><span class="cls_009">ruby_sourceline</span><span class="cls_030"> variable, 23</span></div>
<div style="position:absolute;left:312.00px;top:122.29px" class="cls_030"><span class="cls_030">of Ruby versions, 65-67</span></div>
<div style="position:absolute;left:121.50px;top:132.31px" class="cls_009"><span class="cls_009">RubyString</span><span class="cls_030"> ( Java class), 264</span></div>
<div style="position:absolute;left:312.00px;top:132.28px" class="cls_030"><span class="cls_030">of </span><span class="cls_009">while</span><span class="cls_030"> loops vs. passing blocks,</span></div>
<div style="position:absolute;left:121.50px;top:142.31px" class="cls_030"><span class="cls_030">Ruby versions, benchmarking, 65-67</span></div>
<div style="position:absolute;left:342.00px;top:142.31px" class="cls_030"><span class="cls_030">200-203</span></div>
<div style="position:absolute;left:121.50px;top:152.31px" class="cls_009"><span class="cls_009">RubyVM::InstructionSequence</span><span class="cls_030"> class, 44-45,</span></div>
<div style="position:absolute;left:297.00px;top:152.30px" class="cls_030"><span class="cls_030">splat (</span><span class="cls_009">*</span><span class="cls_030">) operator, 47</span></div>
<div style="position:absolute;left:166.50px;top:162.31px" class="cls_030"><span class="cls_030">51-53</span></div>
<div style="position:absolute;left:297.00px;top:162.31px" class="cls_030"><span class="cls_030">splat argument array, 96</span></div>
<div style="position:absolute;left:121.50px;top:172.31px" class="cls_009"><span class="cls_009">ruby -y</span><span class="cls_030"> option, 19</span></div>
<div style="position:absolute;left:297.00px;top:172.31px" class="cls_009"><span class="cls_009">st_table</span><span class="cls_030"> (C structure), 169</span></div>
<div style="position:absolute;left:121.50px;top:182.31px" class="cls_030"><span class="cls_030">running programs, with MRI and JRuby,</span></div>
<div style="position:absolute;left:297.00px;top:182.31px" class="cls_009"><span class="cls_009">st_table_entry</span><span class="cls_030"> (C structure), 169</span></div>
<div style="position:absolute;left:166.50px;top:192.30px" class="cls_030"><span class="cls_030">252-259</span></div>
<div style="position:absolute;left:297.00px;top:192.31px" class="cls_030"><span class="cls_030">stack, 204</span></div>
<div style="position:absolute;left:121.50px;top:202.31px" class="cls_009"><span class="cls_009">RVALUE</span><span class="cls_030"> (C structure), 298, 301</span></div>
<div style="position:absolute;left:297.00px;top:202.30px" class="cls_030"><span class="cls_030">stack frame, copying to the heap,</span></div>
<div style="position:absolute;left:342.00px;top:212.30px" class="cls_030"><span class="cls_030">205, 209</span></div>
<div style="position:absolute;left:297.00px;top:222.29px" class="cls_030"><span class="cls_030">stack-oriented virtual machines, 35</span></div>
<div style="position:absolute;left:121.50px;top:223.81px" class="cls_218"><span class="cls_218">S</span></div>
<div style="position:absolute;left:297.00px;top:232.29px" class="cls_030"><span class="cls_030">stack pointer (</span><span class="cls_009">SP</span><span class="cls_030">), 57</span></div>
<div style="position:absolute;left:121.50px;top:239.31px" class="cls_030"><span class="cls_030">Sasada, Koichi, 33, 55, 327-330</span></div>
<div style="position:absolute;left:297.00px;top:242.31px" class="cls_030"><span class="cls_030">state table, 18</span></div>
<div style="position:absolute;left:121.50px;top:249.31px" class="cls_030"><span class="cls_030">saving</span></div>
<div style="position:absolute;left:297.00px;top:252.30px" class="cls_030"><span class="cls_030">Steele, Guy, 192, 197</span></div>
<div style="position:absolute;left:136.50px;top:259.30px" class="cls_030"><span class="cls_030">array data, with Rubinius and MRI,</span></div>
<div style="position:absolute;left:297.00px;top:262.31px" class="cls_009"><span class="cls_009">String#[]</span><span class="cls_030"> method, 280</span></div>
<div style="position:absolute;left:166.50px;top:269.30px" class="cls_030"><span class="cls_030">285-291</span></div>
<div style="position:absolute;left:297.00px;top:272.31px" class="cls_009"><span class="cls_009">String</span><span class="cls_030"> class, 263-271</span></div>
<div style="position:absolute;left:136.50px;top:279.29px" class="cls_030"><span class="cls_030">instance variables for generic</span></div>
<div style="position:absolute;left:297.00px;top:282.31px" class="cls_066"><span class="cls_066">string.rb </span><span class="cls_030">file, 280</span></div>
<div style="position:absolute;left:166.50px;top:289.29px" class="cls_030"><span class="cls_030">objects, 113</span></div>
<div style="position:absolute;left:297.00px;top:292.30px" class="cls_030"><span class="cls_030">strings</span></div>
<div style="position:absolute;left:136.49px;top:299.29px" class="cls_030"><span class="cls_030">string data, with JRuby and MRI,</span></div>
<div style="position:absolute;left:312.00px;top:302.30px" class="cls_030"><span class="cls_030">creating unique and nonshared, 267</span></div>
<div style="position:absolute;left:166.49px;top:309.28px" class="cls_030"><span class="cls_030">264-265</span></div>
<div style="position:absolute;left:312.00px;top:312.29px" class="cls_030"><span class="cls_030">in JRuby and MRI, 263-267</span></div>
<div style="position:absolute;left:136.49px;top:319.28px" class="cls_030"><span class="cls_030">string values, 204-207</span></div>
<div style="position:absolute;left:297.00px;top:322.31px" class="cls_009"><span class="cls_009">String#upcase</span><span class="cls_030"> method, 97</span></div>
<div style="position:absolute;left:136.49px;top:329.27px" class="cls_030"><span class="cls_030">values in a hash table, 169-171</span></div>
<div style="position:absolute;left:297.00px;top:332.31px" class="cls_030"><span class="cls_030">string values, how Ruby saves, 204-207</span></div>
<div style="position:absolute;left:121.49px;top:339.27px" class="cls_030"><span class="cls_030">Scheme, 192, 197</span></div>
<div style="position:absolute;left:297.00px;top:342.31px" class="cls_009"><span class="cls_009">Struct#each</span><span class="cls_030"> method, 97</span></div>
<div style="position:absolute;left:121.49px;top:349.27px" class="cls_030"><span class="cls_030">scope, 35. </span><span class="cls_066">See also</span><span class="cls_030"> lexical scope</span></div>
<div style="position:absolute;left:297.00px;top:352.31px" class="cls_030"><span class="cls_030">submodules, 152</span></div>
<div style="position:absolute;left:136.49px;top:359.26px" class="cls_030"><span class="cls_030">jumping from one to another,</span></div>
<div style="position:absolute;left:297.00px;top:362.31px" class="cls_009"><span class="cls_009">super</span><span class="cls_030"> pointer, 119, 125, 126</span></div>
<div style="position:absolute;left:166.48px;top:369.26px" class="cls_030"><span class="cls_030">86-90</span></div>
<div style="position:absolute;left:297.00px;top:372.31px" class="cls_009"><span class="cls_009">SUPPORT_JOKE</span><span class="cls_030"> (C source code value), 43</span></div>
<div style="position:absolute;left:121.48px;top:379.25px" class="cls_030"><span class="cls_030">scripts</span></div>
<div style="position:absolute;left:297.00px;top:382.31px" class="cls_030"><span class="cls_030">survivor spaces, 314</span></div>
<div style="position:absolute;left:136.49px;top:389.25px" class="cls_030"><span class="cls_030">compiling simple, 34-38</span></div>
<div style="position:absolute;left:297.00px;top:392.30px" class="cls_030"><span class="cls_030">Sussman, Gerald, 192, 197</span></div>
<div style="position:absolute;left:136.49px;top:399.25px" class="cls_030"><span class="cls_030">executing, 58-60</span></div>
<div style="position:absolute;left:297.00px;top:402.31px" class="cls_009"><span class="cls_009">svar</span><span class="cls_030"> pointer, 75</span></div>
<div style="position:absolute;left:136.49px;top:409.24px" class="cls_030"><span class="cls_030">parsing, 9-12</span></div>
<div style="position:absolute;left:297.00px;top:412.31px" class="cls_009"><span class="cls_009">svar/cref</span><span class="cls_030"> pointers, 68</span></div>
<div style="position:absolute;left:121.50px;top:419.31px" class="cls_009"><span class="cls_009">self</span><span class="cls_030"> object</span></div>
<div style="position:absolute;left:297.00px;top:422.31px" class="cls_030"><span class="cls_030">sweeping, 300-301</span></div>
<div style="position:absolute;left:136.50px;top:429.31px" class="cls_030"><span class="cls_030">in a class method, 234</span></div>
<div style="position:absolute;left:136.50px;top:439.30px" class="cls_030"><span class="cls_030">in a class scope, 232</span></div>
<div style="position:absolute;left:297.00px;top:443.81px" class="cls_218"><span class="cls_218">T</span></div>
<div style="position:absolute;left:136.50px;top:449.30px" class="cls_030"><span class="cls_030">and closures, 241-242</span></div>
<div style="position:absolute;left:136.50px;top:459.29px" class="cls_030"><span class="cls_030">and lexical scope, 231-236</span></div>
<div style="position:absolute;left:297.00px;top:459.31px" class="cls_030"><span class="cls_030">tenured generation, 315</span></div>
<div style="position:absolute;left:136.50px;top:469.29px" class="cls_030"><span class="cls_030">in a metaclass scope, 233</span></div>
<div style="position:absolute;left:297.00px;top:469.31px" class="cls_009"><span class="cls_009">throw</span><span class="cls_030"> YARV instruction, 87</span></div>
<div style="position:absolute;left:136.50px;top:479.29px" class="cls_030"><span class="cls_030">in the top scope, 231</span></div>
<div style="position:absolute;left:297.00px;top:479.31px" class="cls_009"><span class="cls_009">tIDENTIFIER</span><span class="cls_030"> token, 7</span></div>
<div style="position:absolute;left:121.50px;top:489.31px" class="cls_009"><span class="cls_009">self</span><span class="cls_030"> pointer, 36, 57, 199, 231</span></div>
<div style="position:absolute;left:297.00px;top:489.31px" class="cls_009"><span class="cls_009">time</span><span class="cls_030"> (Unix command), 65</span></div>
<div style="position:absolute;left:121.50px;top:499.31px" class="cls_030"><span class="cls_030">semi-space algorithm, 311-312</span></div>
<div style="position:absolute;left:297.00px;top:499.31px" class="cls_009"><span class="cls_009">tINTEGER</span><span class="cls_030"> token, 6</span></div>
<div style="position:absolute;left:121.50px;top:509.31px" class="cls_009"><span class="cls_009">send</span><span class="cls_030"> YARV instruction, 92-95, 247</span></div>
<div style="position:absolute;left:297.00px;top:509.31px" class="cls_030"><span class="cls_030">tokenization, 3, 9-12</span></div>
<div style="position:absolute;left:121.50px;top:519.31px" class="cls_030"><span class="cls_030">serial collector (in the JVM), 320</span></div>
<div style="position:absolute;left:297.00px;top:519.30px" class="cls_030"><span class="cls_030">tokens, 4-9</span></div>
<div style="position:absolute;left:121.50px;top:529.30px" class="cls_030"><span class="cls_030">setting class variables, 122</span></div>
<div style="position:absolute;left:297.00px;top:529.30px" class="cls_030"><span class="cls_030">top scope, 233</span></div>
<div style="position:absolute;left:121.50px;top:539.31px" class="cls_009"><span class="cls_009">set_trace_func</span><span class="cls_030"> method, 45, 58</span></div>
<div style="position:absolute;left:297.00px;top:539.31px" class="cls_009"><span class="cls_009">top self</span><span class="cls_030"> object, 36, 59, 232</span></div>
<div style="position:absolute;left:121.50px;top:549.31px" class="cls_009"><span class="cls_009">setlocal</span><span class="cls_030"> YARV instruction, 69</span></div>
<div style="position:absolute;left:297.00px;top:549.31px" class="cls_009"><span class="cls_009">top_compstmt</span><span class="cls_030"> grammar rule, 20</span></div>
<div style="position:absolute;left:121.50px;top:559.31px" class="cls_030"><span class="cls_030">shift (parsing operation), 16</span></div>
<div style="position:absolute;left:297.00px;top:559.31px" class="cls_009"><span class="cls_009">TOPLEVEL_BINDING</span><span class="cls_030"> keyword, 194</span></div>
<div style="position:absolute;left:121.50px;top:569.30px" class="cls_030"><span class="cls_030">simple values, 37, 110-111</span></div>
<div style="position:absolute;left:297.00px;top:569.31px" class="cls_030"><span class="cls_030">to-space, 311</span></div>
<div style="position:absolute;left:121.50px;top:579.30px" class="cls_030"><span class="cls_030">singleton classes, 130, 226-227</span></div>
<div style="position:absolute;left:297.00px;top:579.31px" class="cls_009"><span class="cls_009">trace</span><span class="cls_030"> YARV instruction, 45</span></div>
<div style="position:absolute;left:121.50px;top:589.31px" class="cls_009"><span class="cls_009">source_location</span><span class="cls_030"> method, 288</span></div>
<div style="position:absolute;left:297.00px;top:589.31px" class="cls_030"><span class="cls_030">tricolor marking, 319-320</span></div>
<div style="position:absolute;left:121.50px;top:599.31px" class="cls_009"><span class="cls_009">SP</span><span class="cls_030"> (stack pointer), 57</span></div>
<div style="position:absolute;left:297.00px;top:599.30px" class="cls_030"><span class="cls_030">triggering major collections, 323-324</span></div>
<div style="position:absolute;left:121.50px;top:609.31px" class="cls_030"><span class="cls_030">specialized instructions, 38</span></div>
<div style="position:absolute;left:297.00px;top:609.31px" class="cls_009"><span class="cls_009">true</span><span class="cls_030"> value, 110</span></div>
<div style="position:absolute;left:415.30px;top:635.00px" class="cls_021"><span class="cls_021">Index</span></div>
<div style="position:absolute;left:440.88px;top:632.00px" class="cls_020"><span class="cls_020">339</span></div>
</div>
<div style="position:absolute;left:50%;margin-left:-252px;top:242008px;width:504px;height:666px;border-style:outset;overflow:hidden">
<div style="position:absolute;left:0px;top:0px">
<img src="e698b76e-46bd-11eb-8b25-0cc47a792c0a_id_e698b76e-46bd-11eb-8b25-0cc47a792c0a_files/background364.jpg" width=504 height=666></div>
<div style="position:absolute;left:121.50px;top:42.89px" class="cls_009"><span class="cls_009">Tuple</span><span class="cls_030"> (C++ class), 287</span></div>
<div style="position:absolute;left:297.00px;top:42.95px" class="cls_218"><span class="cls_218">W</span></div>
<div style="position:absolute;left:121.50px;top:52.88px" class="cls_030"><span class="cls_030">types of Ruby methods, 93-95</span></div>
<div style="position:absolute;left:297.00px;top:58.45px" class="cls_030"><span class="cls_030">weak generational hypothesis, 313-314</span></div>
<div style="position:absolute;left:297.00px;top:68.45px" class="cls_009"><span class="cls_009">while...end</span><span class="cls_030"> loop, 85, 200-203</span></div>
<div style="position:absolute;left:121.50px;top:74.39px" class="cls_218"><span class="cls_218">U</span></div>
<div style="position:absolute;left:297.00px;top:78.45px" class="cls_030"><span class="cls_030">write barriers, 316</span></div>
<div style="position:absolute;left:121.50px;top:89.89px" class="cls_030"><span class="cls_030">UNDEF methods, 94</span></div>
<div style="position:absolute;left:121.50px;top:99.89px" class="cls_009"><span class="cls_009">unless</span><span class="cls_030"> keyword, 85</span></div>
<div style="position:absolute;left:297.00px;top:99.95px" class="cls_218"><span class="cls_218">X</span></div>
<div style="position:absolute;left:121.50px;top:109.88px" class="cls_030"><span class="cls_030">unnamed arguments, 47, 96</span></div>
<div style="position:absolute;left:297.00px;top:115.45px" class="cls_009"><span class="cls_009">-Xbootclasspath</span><span class="cls_030"> ( Java option), 253</span></div>
<div style="position:absolute;left:121.50px;top:119.89px" class="cls_009"><span class="cls_009">until...end</span><span class="cls_030"> loop, 85</span></div>
<div style="position:absolute;left:121.50px;top:129.89px" class="cls_009"><span class="cls_009">using</span><span class="cls_030"> method, 229</span></div>
<div style="position:absolute;left:297.00px;top:136.95px" class="cls_218"><span class="cls_218">Y</span></div>
<div style="position:absolute;left:121.50px;top:151.39px" class="cls_218"><span class="cls_218">V</span></div>
<div style="position:absolute;left:297.00px;top:152.45px" class="cls_030"><span class="cls_030">Yacc (Yet Another Compiler</span></div>
<div style="position:absolute;left:342.00px;top:162.45px" class="cls_030"><span class="cls_030">Compiler), 12</span></div>
<div style="position:absolute;left:121.50px;top:166.89px" class="cls_009"><span class="cls_009">VALUE</span><span class="cls_030"> pointer, 106, 107, 110, 204</span></div>
<div style="position:absolute;left:297.00px;top:172.44px" class="cls_030"><span class="cls_030">YARV (Yet Another Ruby Virtual</span></div>
<div style="position:absolute;left:121.50px;top:176.88px" class="cls_030"><span class="cls_030">values</span></div>
<div style="position:absolute;left:342.00px;top:182.44px" class="cls_030"><span class="cls_030">Machine), 33, 56-62,</span></div>
<div style="position:absolute;left:136.50px;top:186.88px" class="cls_030"><span class="cls_030">array, how Ruby saves, 285-291</span></div>
<div style="position:absolute;left:342.00px;top:192.43px" class="cls_030"><span class="cls_030">327-330</span></div>
<div style="position:absolute;left:136.50px;top:196.88px" class="cls_030"><span class="cls_030">default, for arguments, 47</span></div>
<div style="position:absolute;left:297.00px;top:202.43px" class="cls_030"><span class="cls_030">YARV instructions, 34, 63-64</span></div>
<div style="position:absolute;left:136.50px;top:206.87px" class="cls_030"><span class="cls_030">expanding hash tables to</span></div>
<div style="position:absolute;left:312.00px;top:212.45px" class="cls_009"><span class="cls_009">branchunless</span><span class="cls_030">, 85</span></div>
<div style="position:absolute;left:166.50px;top:216.87px" class="cls_030"><span class="cls_030">accommodate more, 174-175</span></div>
<div style="position:absolute;left:312.00px;top:222.45px" class="cls_030"><span class="cls_030">displaying, 44-45</span></div>
<div style="position:absolute;left:136.50px;top:226.89px" class="cls_009"><span class="cls_009">false</span><span class="cls_030">, 110</span></div>
<div style="position:absolute;left:312.00px;top:232.45px" class="cls_009"><span class="cls_009">getlocal</span><span class="cls_030">, 74-75</span></div>
<div style="position:absolute;left:136.50px;top:236.89px" class="cls_009"><span class="cls_009">FIXNUM_FLAG</span><span class="cls_030">, 110</span></div>
<div style="position:absolute;left:312.00px;top:242.45px" class="cls_009"><span class="cls_009">jump</span><span class="cls_030">, 85</span></div>
<div style="position:absolute;left:136.50px;top:246.89px" class="cls_009"><span class="cls_009">nil</span><span class="cls_030">, 110</span></div>
<div style="position:absolute;left:312.00px;top:252.45px" class="cls_009"><span class="cls_009">leave</span><span class="cls_030">, 45, 60</span></div>
<div style="position:absolute;left:136.50px;top:256.88px" class="cls_030"><span class="cls_030">simple, 110-111</span></div>
<div style="position:absolute;left:312.00px;top:262.45px" class="cls_009"><span class="cls_009">opt_lt</span><span class="cls_030">, 85</span></div>
<div style="position:absolute;left:136.50px;top:266.89px" class="cls_009"><span class="cls_009">special</span><span class="cls_030">, 71</span></div>
<div style="position:absolute;left:312.00px;top:272.45px" class="cls_009"><span class="cls_009">opt_plus</span><span class="cls_030">, 38, 60</span></div>
<div style="position:absolute;left:136.50px;top:276.88px" class="cls_030"><span class="cls_030">string, how Ruby saves, 204-207,</span></div>
<div style="position:absolute;left:312.00px;top:282.45px" class="cls_009"><span class="cls_009">opt_send_simple</span><span class="cls_030">, 38, 60</span></div>
<div style="position:absolute;left:166.50px;top:286.88px" class="cls_030"><span class="cls_030">263-271</span></div>
<div style="position:absolute;left:312.00px;top:292.45px" class="cls_009"><span class="cls_009">putobject</span><span class="cls_030">, 59</span></div>
<div style="position:absolute;left:136.50px;top:296.89px" class="cls_009"><span class="cls_009">true</span><span class="cls_030">, 110</span></div>
<div style="position:absolute;left:312.00px;top:302.45px" class="cls_009"><span class="cls_009">putself</span><span class="cls_030">, 36, 58, 63</span></div>
<div style="position:absolute;left:121.50px;top:306.88px" class="cls_030"><span class="cls_030">variable access</span></div>
<div style="position:absolute;left:312.00px;top:312.45px" class="cls_009"><span class="cls_009">send</span><span class="cls_030">, 92-95, 247</span></div>
<div style="position:absolute;left:136.51px;top:316.88px" class="cls_030"><span class="cls_030">dynamic, 71-74</span></div>
<div style="position:absolute;left:312.00px;top:322.45px" class="cls_009"><span class="cls_009">setlocal</span><span class="cls_030">, 69</span></div>
<div style="position:absolute;left:136.51px;top:326.88px" class="cls_030"><span class="cls_030">local, 67-70</span></div>
<div style="position:absolute;left:312.00px;top:332.45px" class="cls_030"><span class="cls_030">taking a close look at, 63-64</span></div>
<div style="position:absolute;left:121.50px;top:336.87px" class="cls_030"><span class="cls_030">variables, 67-74</span></div>
<div style="position:absolute;left:312.00px;top:342.45px" class="cls_009"><span class="cls_009">throw</span><span class="cls_030">, 87</span></div>
<div style="position:absolute;left:136.51px;top:346.87px" class="cls_030"><span class="cls_030">class, 120-124</span></div>
<div style="position:absolute;left:312.00px;top:352.45px" class="cls_009"><span class="cls_009">trace</span><span class="cls_030">, 45</span></div>
<div style="position:absolute;left:136.51px;top:356.86px" class="cls_030"><span class="cls_030">class instance, 120-122</span></div>
<div style="position:absolute;left:297.00px;top:362.45px" class="cls_030"><span class="cls_030">Yet Another Compiler Compiler</span></div>
<div style="position:absolute;left:136.51px;top:366.86px" class="cls_030"><span class="cls_030">instance</span></div>
<div style="position:absolute;left:342.00px;top:372.44px" class="cls_030"><span class="cls_030">(Yacc), 12</span></div>
<div style="position:absolute;left:151.51px;top:376.86px" class="cls_030"><span class="cls_030">for generic objects, 111, 113</span></div>
<div style="position:absolute;left:297.00px;top:382.44px" class="cls_030"><span class="cls_030">Yet Another Ruby Virtual Machine</span></div>
<div style="position:absolute;left:151.51px;top:386.85px" class="cls_030"><span class="cls_030">time required to save, 113-115</span></div>
<div style="position:absolute;left:342.00px;top:392.43px" class="cls_030"><span class="cls_030">(YARV), 33, 56-62, 327-330</span></div>
<div style="position:absolute;left:136.51px;top:396.85px" class="cls_030"><span class="cls_030">local, changing after calling </span><span class="cls_009">lambda</span><span class="cls_030">,</span></div>
<div style="position:absolute;left:297.00px;top:402.43px" class="cls_030"><span class="cls_030">Yochelson, Jerome C., 309</span></div>
<div style="position:absolute;left:166.50px;top:406.88px" class="cls_030"><span class="cls_030">214-217</span></div>
<div style="position:absolute;left:297.00px;top:412.45px" class="cls_009"><span class="cls_009">-y</span><span class="cls_030"> (Ruby option), 19</span></div>
<div style="position:absolute;left:136.50px;top:416.88px" class="cls_030"><span class="cls_030">special. </span><span class="cls_066">See</span><span class="cls_030"> special variables</span></div>
<div style="position:absolute;left:121.50px;top:426.88px" class="cls_030"><span class="cls_030">visualizing copy-on-write, 269-270</span></div>
<div style="position:absolute;left:121.50px;top:436.87px" class="cls_030"><span class="cls_030">visualizing two instances of one class, 108</span></div>
<div style="position:absolute;left:297.00px;top:433.95px" class="cls_218"><span class="cls_218">Z</span></div>
<div style="position:absolute;left:121.50px;top:446.87px" class="cls_066"><span class="cls_066">vm_core.h </span><span class="cls_030">file, 198</span></div>
<div style="position:absolute;left:297.00px;top:449.45px" class="cls_030"><span class="cls_030">ZSUPER methods, 94</span></div>
<div style="position:absolute;left:121.50px;top:456.86px" class="cls_066"><span class="cls_066">vm_exec.c </span><span class="cls_030">file, 64</span></div>
<div style="position:absolute;left:121.50px;top:466.89px" class="cls_009"><span class="cls_009">vm_getivar</span><span class="cls_030"> (C function), 99</span></div>
<div style="position:absolute;left:121.50px;top:476.88px" class="cls_066"><span class="cls_066">vm.inc </span><span class="cls_030">file, 63</span></div>
<div style="position:absolute;left:121.50px;top:486.88px" class="cls_066"><span class="cls_066">vm_insnhelper.h </span><span class="cls_030">file, 74</span></div>
<div style="position:absolute;left:121.50px;top:496.89px" class="cls_009"><span class="cls_009">VM_METHOD_TYPE_ISEQ</span><span class="cls_030"> (C source code</span></div>
<div style="position:absolute;left:166.50px;top:506.88px" class="cls_030"><span class="cls_030">value), 95</span></div>
<div style="position:absolute;left:121.50px;top:516.89px" class="cls_009"><span class="cls_009">VM_METHOD_TYPE_CFUNC</span><span class="cls_030"> (C source code</span></div>
<div style="position:absolute;left:166.50px;top:526.88px" class="cls_030"><span class="cls_030">value), 97</span></div>
<div style="position:absolute;left:121.50px;top:536.89px" class="cls_009"><span class="cls_009">VM_METHOD_TYPE_REFINED</span><span class="cls_030"> (C source code</span></div>
<div style="position:absolute;left:166.50px;top:546.88px" class="cls_030"><span class="cls_030">value), 229</span></div>
<div style="position:absolute;left:121.50px;top:556.89px" class="cls_009"><span class="cls_009">vm_setivar</span><span class="cls_066"> (</span><span class="cls_030">C function), 98</span></div>
<div style="position:absolute;left:49.50px;top:632.00px" class="cls_020"><span class="cls_020">340</span><span class="cls_009">   </span><span class="cls_021">Index</span></div>
</div>
<div style="position:absolute;left:50%;margin-left:-252px;top:242684px;width:504px;height:666px;border-style:outset;overflow:hidden">
<div style="position:absolute;left:0px;top:0px">
<img src="e698b76e-46bd-11eb-8b25-0cc47a792c0a_id_e698b76e-46bd-11eb-8b25-0cc47a792c0a_files/background365.jpg" width=504 height=666></div>
</div>
<div style="position:absolute;left:50%;margin-left:-252px;top:243360px;width:504px;height:666px;border-style:outset;overflow:hidden">
<div style="position:absolute;left:0px;top:0px">
<img src="e698b76e-46bd-11eb-8b25-0cc47a792c0a_id_e698b76e-46bd-11eb-8b25-0cc47a792c0a_files/background366.jpg" width=504 height=666></div>
<div style="position:absolute;left:48.75px;top:45.75px" class="cls_016"><span class="cls_016">Updates</span></div>
<div style="position:absolute;left:48.75px;top:76.15px" class="cls_221"><span class="cls_221">Visit </span><A HREF="http://nostarch.com/rum/">http://nostarch.com/rum/</A> </span><span class="cls_221"> for updates, errata, and other information.</span></div>
<div style="position:absolute;left:48.00px;top:129.00px" class="cls_219"><span class="cls_219">More no-nonsense books from</span></div>
<div style="position:absolute;left:216.80px;top:131.00px" class="cls_220"><span class="cls_220">no starch press</span></div>
<div style="position:absolute;left:48.00px;top:284.02px" class="cls_018"><span class="cls_018">Perl One-Liners</span></div>
<div style="position:absolute;left:186.50px;top:284.13px" class="cls_018"><span class="cls_018">Ruby Wizardry</span></div>
<div style="position:absolute;left:325.00px;top:284.02px" class="cls_018"><span class="cls_018">Python for Kids</span></div>
<div style="position:absolute;left:48.00px;top:297.02px" class="cls_020"><span class="cls_020">130 Programs That Get Things Done</span></div>
<div style="position:absolute;left:186.50px;top:297.13px" class="cls_020"><span class="cls_020">An Introduction to</span></div>
<div style="position:absolute;left:325.00px;top:297.02px" class="cls_020"><span class="cls_020">A Playful Introduction to</span></div>
<div style="position:absolute;left:48.00px;top:309.02px" class="cls_026"><span class="cls_026">by </span><span class="cls_222">peteris</span><span class="cls_014"> </span><span class="cls_222">krumins</span></div>
<div style="position:absolute;left:186.50px;top:308.13px" class="cls_020"><span class="cls_020">Programming for Kids</span></div>
<div style="position:absolute;left:325.00px;top:308.02px" class="cls_020"><span class="cls_020">Programming</span></div>
<div style="position:absolute;left:48.00px;top:318.02px" class="cls_222"><span class="cls_222">november</span><span class="cls_014"> 2013, 152 </span><span class="cls_222">pp</span><span class="cls_014">., $19.95</span></div>
<div style="position:absolute;left:186.50px;top:320.13px" class="cls_026"><span class="cls_026">by </span><span class="cls_222">eric</span><span class="cls_014"> </span><span class="cls_222">weinstein</span></div>
<div style="position:absolute;left:325.00px;top:320.02px" class="cls_026"><span class="cls_026">by </span><span class="cls_222">jason</span><span class="cls_014"> </span><span class="cls_222">r</span><span class="cls_014">. </span><span class="cls_222">briggs</span></div>
<div style="position:absolute;left:48.00px;top:327.02px" class="cls_222"><span class="cls_222">isbn</span><span class="cls_014"> 978-1-59327-520-4</span></div>
<div style="position:absolute;left:186.50px;top:329.13px" class="cls_222"><span class="cls_222">december</span><span class="cls_014"> 2014, 352 </span><span class="cls_222">pp</span><span class="cls_014">., $29.95</span></div>
<div style="position:absolute;left:325.00px;top:329.02px" class="cls_222"><span class="cls_222">december</span><span class="cls_014"> 2012, 344 </span><span class="cls_222">pp</span><span class="cls_014">., $34.95</span></div>
<div style="position:absolute;left:186.50px;top:338.13px" class="cls_222"><span class="cls_222">isbn</span><span class="cls_014"> 978-1-59327-566-2</span></div>
<div style="position:absolute;left:325.00px;top:338.02px" class="cls_222"><span class="cls_222">isbn</span><span class="cls_014"> 978-1-59327-407-8</span></div>
<div style="position:absolute;left:186.50px;top:347.13px" class="cls_026"><span class="cls_026">two color</span></div>
<div style="position:absolute;left:325.00px;top:347.02px" class="cls_026"><span class="cls_026">full color</span></div>
<div style="position:absolute;left:48.00px;top:501.02px" class="cls_018"><span class="cls_018">Eloquent JavaScript,</span></div>
<div style="position:absolute;left:186.50px;top:500.94px" class="cls_018"><span class="cls_018">Hacking,</span></div>
<div style="position:absolute;left:325.00px;top:500.94px" class="cls_018"><span class="cls_018">The IDA Pro Book,</span></div>
<div style="position:absolute;left:48.00px;top:513.02px" class="cls_018"><span class="cls_018">2nd edition</span></div>
<div style="position:absolute;left:186.50px;top:512.94px" class="cls_018"><span class="cls_018">2nd Edition</span></div>
<div style="position:absolute;left:325.00px;top:512.94px" class="cls_018"><span class="cls_018">2nd Edition</span></div>
<div style="position:absolute;left:48.00px;top:526.02px" class="cls_020"><span class="cls_020">A Modern Introduction to</span></div>
<div style="position:absolute;left:186.50px;top:525.94px" class="cls_020"><span class="cls_020">The Art of Exploitation</span></div>
<div style="position:absolute;left:325.00px;top:525.94px" class="cls_020"><span class="cls_020">The Unofficial Guide to the World’s</span></div>
<div style="position:absolute;left:48.00px;top:537.02px" class="cls_020"><span class="cls_020">Programming</span></div>
<div style="position:absolute;left:186.50px;top:537.94px" class="cls_026"><span class="cls_026">by </span><span class="cls_222">jon</span><span class="cls_014"> </span><span class="cls_222">erickson</span></div>
<div style="position:absolute;left:325.00px;top:536.94px" class="cls_020"><span class="cls_020">Most Popular Disassembler</span></div>
<div style="position:absolute;left:48.00px;top:549.02px" class="cls_026"><span class="cls_026">by </span><span class="cls_222">marijn</span><span class="cls_014"> </span><span class="cls_222">haverbeke</span></div>
<div style="position:absolute;left:186.50px;top:546.94px" class="cls_222"><span class="cls_222">february</span><span class="cls_014"> 2008, 488 </span><span class="cls_222">pp</span><span class="cls_014">., $49.95</span></div>
<div style="position:absolute;left:325.00px;top:548.94px" class="cls_026"><span class="cls_026">by </span><span class="cls_222">chris</span><span class="cls_014"> </span><span class="cls_222">eagle</span></div>
<div style="position:absolute;left:48.01px;top:558.02px" class="cls_222"><span class="cls_222">december</span><span class="cls_014"> 2014, 472 </span><span class="cls_222">pp</span><span class="cls_014">., $39.95</span></div>
<div style="position:absolute;left:186.50px;top:555.94px" class="cls_222"><span class="cls_222">isbn</span><span class="cls_014"> 978-1-59327-144-2</span></div>
<div style="position:absolute;left:325.00px;top:557.94px" class="cls_222"><span class="cls_222">july</span><span class="cls_014"> 2011, 672 </span><span class="cls_222">pp</span><span class="cls_014">., $69.95</span></div>
<div style="position:absolute;left:48.00px;top:567.02px" class="cls_222"><span class="cls_222">isbn</span><span class="cls_014"> 978-1-59327-584-6</span></div>
<div style="position:absolute;left:186.50px;top:564.94px" class="cls_026"><span class="cls_026">includes CD</span></div>
<div style="position:absolute;left:325.00px;top:566.94px" class="cls_222"><span class="cls_222">isbn</span><span class="cls_014"> 978-1-59327-289-0</span></div>
<div style="position:absolute;left:78.00px;top:604.00px" class="cls_007"><span class="cls_007">800.420.7240 </span><span class="cls_009">or</span><span class="cls_007"> 415.863.9900 | </span><span class="cls_009">sales</span><span class="cls_007">@</span><span class="cls_009">nostarch</span><span class="cls_007">.</span><span class="cls_009">com</span><span class="cls_007"> | </span><span class="cls_009">www</span><span class="cls_007">.</span><span class="cls_009">nostarch</span><span class="cls_007">.</span><span class="cls_009">com</span></div>
</div>

</body>
</html>
